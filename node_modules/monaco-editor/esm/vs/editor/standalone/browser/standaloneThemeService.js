import*as dom from"../../../base/browser/dom.js";import{addMatchMediaChangeListener}from"../../../base/browser/browser.js";import{Color}from"../../../base/common/color.js";import{Emitter}from"../../../base/common/event.js";import{TokenizationRegistry}from"../../common/languages.js";import{TokenMetadata}from"../../common/encodedTokenAttributes.js";import{TokenTheme,generateTokensCSSForColorMap}from"../../common/languages/supports/tokenization.js";import{hc_black,hc_light,vs,vs_dark}from"../common/themes.js";import{Registry}from"../../../platform/registry/common/platform.js";import{asCssVariableName,Extensions}from"../../../platform/theme/common/colorRegistry.js";import{Extensions as ThemingExtensions}from"../../../platform/theme/common/themeService.js";import{Disposable}from"../../../base/common/lifecycle.js";import{ColorScheme,isDark,isHighContrast}from"../../../platform/theme/common/theme.js";import{getIconsStyleSheet,UnthemedProductIconTheme}from"../../../platform/theme/browser/iconsStyleSheet.js";export const VS_LIGHT_THEME_NAME="vs";export const VS_DARK_THEME_NAME="vs-dark";export const HC_BLACK_THEME_NAME="hc-black";export const HC_LIGHT_THEME_NAME="hc-light";const colorRegistry=Registry.as(Extensions.ColorContribution),themingRegistry=Registry.as(ThemingExtensions.ThemingContribution);class StandaloneTheme{constructor(e,t){this.semanticHighlighting=!1,this.themeData=t;const o=t.base;e.length>0?(isBuiltinTheme(e)?this.id=e:this.id=o+" "+e,this.themeName=e):(this.id=o,this.themeName=o),this.colors=null,this.defaultColors=Object.create(null),this._tokenTheme=null}get base(){return this.themeData.base}notifyBaseUpdated(){this.themeData.inherit&&(this.colors=null,this._tokenTheme=null)}getColors(){if(!this.colors){const e=new Map;for(const t in this.themeData.colors)e.set(t,Color.fromHex(this.themeData.colors[t]));if(this.themeData.inherit){const t=getBuiltinRules(this.themeData.base);for(const o in t.colors)e.has(o)||e.set(o,Color.fromHex(t.colors[o]))}this.colors=e}return this.colors}getColor(e,t){return this.getColors().get(e)||(!1!==t?this.getDefault(e):void 0)}getDefault(e){let t=this.defaultColors[e];return t||(t=colorRegistry.resolveDefaultColor(e,this),this.defaultColors[e]=t,t)}defines(e){return this.getColors().has(e)}get type(){switch(this.base){case"vs":return ColorScheme.LIGHT;case"hc-black":return ColorScheme.HIGH_CONTRAST_DARK;case"hc-light":return ColorScheme.HIGH_CONTRAST_LIGHT;default:return ColorScheme.DARK}}get tokenTheme(){if(!this._tokenTheme){let e=[],t=[];if(this.themeData.inherit){const o=getBuiltinRules(this.themeData.base);e=o.rules,o.encodedTokensColors&&(t=o.encodedTokensColors)}const o=this.themeData.colors["editor.foreground"],s=this.themeData.colors["editor.background"];if(o||s){const t={token:""};o&&(t.foreground=o),s&&(t.background=s),e.push(t)}e=e.concat(this.themeData.rules),this.themeData.encodedTokensColors&&(t=this.themeData.encodedTokensColors),this._tokenTheme=TokenTheme.createFromRawTokenTheme(e,t)}return this._tokenTheme}getTokenStyleMetadata(e,t,o){const s=this.tokenTheme._match([e].concat(t).join(".")).metadata,n=TokenMetadata.getForeground(s),h=TokenMetadata.getFontStyle(s);return{foreground:n,italic:Boolean(1&h),bold:Boolean(2&h),underline:Boolean(4&h),strikethrough:Boolean(8&h)}}}function isBuiltinTheme(e){return"vs"===e||"vs-dark"===e||"hc-black"===e||"hc-light"===e}function getBuiltinRules(e){switch(e){case"vs":return vs;case"vs-dark":return vs_dark;case"hc-black":return hc_black;case"hc-light":return hc_light}}function newBuiltInTheme(e){const t=getBuiltinRules(e);return new StandaloneTheme(e,t)}export class StandaloneThemeService extends Disposable{constructor(){super(),this._onColorThemeChange=this._register(new Emitter),this.onDidColorThemeChange=this._onColorThemeChange.event,this._onProductIconThemeChange=this._register(new Emitter),this.onDidProductIconThemeChange=this._onProductIconThemeChange.event,this._environment=Object.create(null),this._builtInProductIconTheme=new UnthemedProductIconTheme,this._autoDetectHighContrast=!0,this._knownThemes=new Map,this._knownThemes.set("vs",newBuiltInTheme("vs")),this._knownThemes.set("vs-dark",newBuiltInTheme("vs-dark")),this._knownThemes.set("hc-black",newBuiltInTheme("hc-black")),this._knownThemes.set("hc-light",newBuiltInTheme("hc-light"));const e=getIconsStyleSheet(this);this._codiconCSS=e.getCSS(),this._themeCSS="",this._allCSS=`${this._codiconCSS}\n${this._themeCSS}`,this._globalStyleElement=null,this._styleElements=[],this._colorMapOverride=null,this.setTheme("vs"),this._onOSSchemeChanged(),e.onDidChange((()=>{this._codiconCSS=e.getCSS(),this._updateCSS()})),addMatchMediaChangeListener("(forced-colors: active)",(()=>{this._onOSSchemeChanged()}))}registerEditorContainer(e){return dom.isInShadowDOM(e)?this._registerShadowDomContainer(e):this._registerRegularEditorContainer()}_registerRegularEditorContainer(){return this._globalStyleElement||(this._globalStyleElement=dom.createStyleSheet(),this._globalStyleElement.className="monaco-colors",this._globalStyleElement.textContent=this._allCSS,this._styleElements.push(this._globalStyleElement)),Disposable.None}_registerShadowDomContainer(e){const t=dom.createStyleSheet(e);return t.className="monaco-colors",t.textContent=this._allCSS,this._styleElements.push(t),{dispose:()=>{for(let e=0;e<this._styleElements.length;e++)if(this._styleElements[e]===t)return void this._styleElements.splice(e,1)}}}defineTheme(e,t){if(!/^[a-z0-9\-]+$/i.test(e))throw new Error("Illegal theme name!");if(!isBuiltinTheme(t.base)&&!isBuiltinTheme(e))throw new Error("Illegal theme base!");this._knownThemes.set(e,new StandaloneTheme(e,t)),isBuiltinTheme(e)&&this._knownThemes.forEach((t=>{t.base===e&&t.notifyBaseUpdated()})),this._theme.themeName===e&&this.setTheme(e)}getColorTheme(){return this._theme}setColorMapOverride(e){this._colorMapOverride=e,this._updateThemeOrColorMap()}setTheme(e){let t;t=this._knownThemes.has(e)?this._knownThemes.get(e):this._knownThemes.get("vs"),this._updateActualTheme(t)}_updateActualTheme(e){e&&this._theme!==e&&(this._theme=e,this._updateThemeOrColorMap())}_onOSSchemeChanged(){if(this._autoDetectHighContrast){const e=window.matchMedia("(forced-colors: active)").matches;if(e!==isHighContrast(this._theme.type)){let t;t=isDark(this._theme.type)?e?"hc-black":"vs-dark":e?"hc-light":"vs",this._updateActualTheme(this._knownThemes.get(t))}}}setAutoDetectHighContrast(e){this._autoDetectHighContrast=e,this._onOSSchemeChanged()}_updateThemeOrColorMap(){const e=[],t={},o={addRule:o=>{t[o]||(e.push(o),t[o]=!0)}};themingRegistry.getThemingParticipants().forEach((e=>e(this._theme,o,this._environment)));const s=[];for(const e of colorRegistry.getColors()){const t=this._theme.getColor(e.id,!0);t&&s.push(`${asCssVariableName(e.id)}: ${t.toString()};`)}o.addRule(`.monaco-editor { ${s.join("\n")} }`);const n=this._colorMapOverride||this._theme.tokenTheme.getColorMap();o.addRule(generateTokensCSSForColorMap(n)),this._themeCSS=e.join("\n"),this._updateCSS(),TokenizationRegistry.setColorMap(n),this._onColorThemeChange.fire(this._theme)}_updateCSS(){this._allCSS=`${this._codiconCSS}\n${this._themeCSS}`,this._styleElements.forEach((e=>e.textContent=this._allCSS))}getFileIconTheme(){return{hasFileIcons:!1,hasFolderIcons:!1,hidesExplorerArrows:!1}}getProductIconTheme(){return this._builtInProductIconTheme}}