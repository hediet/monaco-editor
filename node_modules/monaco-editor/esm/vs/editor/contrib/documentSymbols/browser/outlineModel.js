var __decorate=this&&this.__decorate||function(e,t,o,n){var r,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(i<3?r(s):i>3?r(t,o,s):r(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))};import{equals}from"../../../../base/common/arrays.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Iterable}from"../../../../base/common/iterator.js";import{LRUCache}from"../../../../base/common/map.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{createDecorator}from"../../../../platform/instantiation/common/instantiation.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{IModelService}from"../../../common/services/model.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";export class TreeElement{remove(){var e;null===(e=this.parent)||void 0===e||e.children.delete(this.id)}static findId(e,t){let o;"string"==typeof e?o=`${t.id}/${e}`:(o=`${t.id}/${e.name}`,void 0!==t.children.get(o)&&(o=`${t.id}/${e.name}_${e.range.startLineNumber}_${e.range.startColumn}`));let n=o;for(let e=0;void 0!==t.children.get(n);e++)n=`${o}_${e}`;return n}static empty(e){return 0===e.children.size}}export class OutlineElement extends TreeElement{constructor(e,t,o){super(),this.id=e,this.parent=t,this.symbol=o,this.children=new Map}}export class OutlineGroup extends TreeElement{constructor(e,t,o,n){super(),this.id=e,this.parent=t,this.label=o,this.order=n,this.children=new Map}}export class OutlineModel extends TreeElement{static create(e,t,o){const n=new CancellationTokenSource(o),r=new OutlineModel(t.uri),i=e.ordered(t),s=i.map(((e,o)=>{var i;const s=TreeElement.findId(`provider_${o}`,r),a=new OutlineGroup(s,r,null!==(i=e.displayName)&&void 0!==i?i:"Unknown Outline Provider",o);return Promise.resolve(e.provideDocumentSymbols(t,n.token)).then((e=>{for(const t of e||[])OutlineModel._makeOutlineElement(t,a);return a}),(e=>(onUnexpectedExternalError(e),a))).then((e=>{TreeElement.empty(e)?e.remove():r._groups.set(s,e)}))})),a=e.onDidChange((()=>{const o=e.ordered(t);equals(o,i)||n.cancel()}));return Promise.all(s).then((()=>n.token.isCancellationRequested&&!o.isCancellationRequested?OutlineModel.create(e,t,o):r._compact())).finally((()=>{a.dispose()}))}static _makeOutlineElement(e,t){const o=TreeElement.findId(e,t),n=new OutlineElement(o,t,e);if(e.children)for(const t of e.children)OutlineModel._makeOutlineElement(t,n);t.children.set(n.id,n)}constructor(e){super(),this.uri=e,this.id="root",this.parent=void 0,this._groups=new Map,this.children=new Map,this.id="root",this.parent=void 0}_compact(){let e=0;for(const[t,o]of this._groups)0===o.children.size?this._groups.delete(t):e+=1;if(1!==e)this.children=this._groups;else{const e=Iterable.first(this._groups.values());for(const[,t]of e.children)t.parent=this,this.children.set(t.id,t)}return this}getTopLevelSymbols(){const e=[];for(const t of this.children.values())t instanceof OutlineElement?e.push(t.symbol):e.push(...Iterable.map(t.children.values(),(e=>e.symbol)));return e.sort(((e,t)=>Range.compareRangesUsingStarts(e.range,t.range)))}asListOfDocumentSymbols(){const e=this.getTopLevelSymbols(),t=[];return OutlineModel._flattenDocumentSymbols(t,e,""),t.sort(((e,t)=>Position.compare(Range.getStartPosition(e.range),Range.getStartPosition(t.range))||Position.compare(Range.getEndPosition(t.range),Range.getEndPosition(e.range))))}static _flattenDocumentSymbols(e,t,o){for(const n of t)e.push({kind:n.kind,tags:n.tags,name:n.name,detail:n.detail,containerName:n.containerName||o,range:n.range,selectionRange:n.selectionRange,children:void 0}),n.children&&OutlineModel._flattenDocumentSymbols(e,n.children,n.name)}}export const IOutlineModelService=createDecorator("IOutlineModelService");let OutlineModelService=class{constructor(e,t,o){this._languageFeaturesService=e,this._disposables=new DisposableStore,this._cache=new LRUCache(10,.7),this._debounceInformation=t.for(e.documentSymbolProvider,"DocumentSymbols",{min:350}),this._disposables.add(o.onModelRemoved((e=>{this._cache.delete(e.id)})))}dispose(){this._disposables.dispose()}getOrCreate(e,t){return __awaiter(this,void 0,void 0,(function*(){const o=this._languageFeaturesService.documentSymbolProvider,n=o.ordered(e);let r=this._cache.get(e.id);if(!r||r.versionId!==e.getVersionId()||!equals(r.provider,n)){const t=new CancellationTokenSource;r={versionId:e.getVersionId(),provider:n,promiseCnt:0,source:t,promise:OutlineModel.create(o,e,t.token),model:void 0},this._cache.set(e.id,r);const i=Date.now();r.promise.then((t=>{r.model=t,this._debounceInformation.update(e,Date.now()-i)})).catch((t=>{this._cache.delete(e.id)}))}if(r.model)return r.model;r.promiseCnt+=1;const i=t.onCancellationRequested((()=>{0==--r.promiseCnt&&(r.source.cancel(),this._cache.delete(e.id))}));try{return yield r.promise}finally{i.dispose()}}))}};OutlineModelService=__decorate([__param(0,ILanguageFeaturesService),__param(1,ILanguageFeatureDebounceService),__param(2,IModelService)],OutlineModelService);export{OutlineModelService};registerSingleton(IOutlineModelService,OutlineModelService,1);