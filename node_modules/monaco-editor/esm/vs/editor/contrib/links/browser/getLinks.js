var __awaiter=this&&this.__awaiter||function(e,n,o,r){return new(o||(o=Promise))((function(s,t){function i(e){try{l(r.next(e))}catch(e){t(e)}}function a(e){try{l(r.throw(e))}catch(e){t(e)}}function l(e){var n;e.done?s(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(i,a)}l((r=r.apply(e,n||[])).next())}))};import{coalesce}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{DisposableStore,isDisposable}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{Range}from"../../../common/core/range.js";import{IModelService}from"../../../common/services/model.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";export class Link{constructor(e,n){this._link=e,this._provider=n}toJSON(){return{range:this.range,url:this.url,tooltip:this.tooltip}}get range(){return this._link.range}get url(){return this._link.url}get tooltip(){return this._link.tooltip}resolve(e){return __awaiter(this,void 0,void 0,(function*(){return this._link.url?this._link.url:"function"==typeof this._provider.resolveLink?Promise.resolve(this._provider.resolveLink(this._link,e)).then((n=>(this._link=n||this._link,this._link.url?this.resolve(e):Promise.reject(new Error("missing"))))):Promise.reject(new Error("missing"))}))}}export class LinksList{constructor(e){this._disposables=new DisposableStore;let n=[];for(const[o,r]of e){const e=o.links.map((e=>new Link(e,r)));n=LinksList._union(n,e),isDisposable(o)&&this._disposables.add(o)}this.links=n}dispose(){this._disposables.dispose(),this.links.length=0}static _union(e,n){const o=[];let r,s,t,i;for(r=0,t=0,s=e.length,i=n.length;r<s&&t<i;){const s=e[r],i=n[t];Range.areIntersectingOrTouching(s.range,i.range)?r++:Range.compareRangesUsingStarts(s.range,i.range)<0?(o.push(s),r++):(o.push(i),t++)}for(;r<s;r++)o.push(e[r]);for(;t<i;t++)o.push(n[t]);return o}}export function getLinks(e,n,o){const r=[],s=e.ordered(n).reverse().map(((e,s)=>Promise.resolve(e.provideLinks(n,o)).then((n=>{n&&(r[s]=[n,e])}),onUnexpectedExternalError)));return Promise.all(s).then((()=>{const e=new LinksList(coalesce(r));return o.isCancellationRequested?(e.dispose(),new LinksList([])):e}))}CommandsRegistry.registerCommand("_executeLinkProvider",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){let[o,r]=n;assertType(o instanceof URI),"number"!=typeof r&&(r=0);const{linkProvider:s}=e.get(ILanguageFeaturesService),t=e.get(IModelService).getModel(o);if(!t)return[];const i=yield getLinks(s,t,CancellationToken.None);if(!i)return[];for(let e=0;e<Math.min(r,i.links.length);e++)yield i.links[e].resolve(CancellationToken.None);const a=i.links.slice(0);return i.dispose(),a}))));