var __decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{a(o.next(e))}catch(e){r(e)}}function c(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,c)}a((o=o.apply(e,t||[])).next())}))};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{Schemas}from"../../../../base/common/network.js";import*as platform from"../../../../base/common/platform.js";import*as resources from"../../../../base/common/resources.js";import{StopWatch}from"../../../../base/common/stopwatch.js";import{URI}from"../../../../base/common/uri.js";import"./links.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{getLinks}from"./getLinks.js";import*as nls from"../../../../nls.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";let LinkDetector=class e extends Disposable{static get(t){return t.getContribution(e.ID)}constructor(e,t,i,o,n){super(),this.editor=e,this.openerService=t,this.notificationService=i,this.languageFeaturesService=o,this.providers=this.languageFeaturesService.linkProvider,this.debounceInformation=n.for(this.providers,"Links",{min:1e3,max:4e3}),this.computeLinks=this._register(new RunOnceScheduler((()=>this.computeLinksNow()),1e3)),this.computePromise=null,this.activeLinksList=null,this.currentOccurrences={},this.activeLinkDecorationId=null;const r=this._register(new ClickLinkGesture(e));this._register(r.onMouseMoveOrRelevantKeyDown((([e,t])=>{this._onEditorMouseMove(e,t)}))),this._register(r.onExecute((e=>{this.onEditorMouseUp(e)}))),this._register(r.onCancel((e=>{this.cleanUpActiveLinkDecoration()}))),this._register(e.onDidChangeConfiguration((e=>{e.hasChanged(67)&&(this.updateDecorations([]),this.stop(),this.computeLinks.schedule(0))}))),this._register(e.onDidChangeModelContent((e=>{this.editor.hasModel()&&this.computeLinks.schedule(this.debounceInformation.get(this.editor.getModel()))}))),this._register(e.onDidChangeModel((e=>{this.currentOccurrences={},this.activeLinkDecorationId=null,this.stop(),this.computeLinks.schedule(0)}))),this._register(e.onDidChangeModelLanguage((e=>{this.stop(),this.computeLinks.schedule(0)}))),this._register(this.providers.onDidChange((e=>{this.stop(),this.computeLinks.schedule(0)}))),this.computeLinks.schedule(0)}computeLinksNow(){return __awaiter(this,void 0,void 0,(function*(){if(!this.editor.hasModel()||!this.editor.getOption(67))return;const e=this.editor.getModel();if(this.providers.has(e)){this.activeLinksList&&(this.activeLinksList.dispose(),this.activeLinksList=null),this.computePromise=createCancelablePromise((t=>getLinks(this.providers,e,t)));try{const t=new StopWatch(!1);if(this.activeLinksList=yield this.computePromise,this.debounceInformation.update(e,t.elapsed()),e.isDisposed())return;this.updateDecorations(this.activeLinksList.links)}catch(e){onUnexpectedError(e)}finally{this.computePromise=null}}}))}updateDecorations(e){const t="altKey"===this.editor.getOption(74),i=[],o=Object.keys(this.currentOccurrences);for(const e of o){const t=this.currentOccurrences[e];i.push(t.decorationId)}const n=[];if(e)for(const i of e)n.push(LinkOccurrence.decoration(i,t));this.editor.changeDecorations((t=>{const o=t.deltaDecorations(i,n);this.currentOccurrences={},this.activeLinkDecorationId=null;for(let t=0,i=o.length;t<i;t++){const i=new LinkOccurrence(e[t],o[t]);this.currentOccurrences[i.decorationId]=i}}))}_onEditorMouseMove(e,t){const i="altKey"===this.editor.getOption(74);if(this.isEnabled(e,t)){this.cleanUpActiveLinkDecoration();const t=this.getLinkOccurrence(e.target.position);t&&this.editor.changeDecorations((e=>{t.activate(e,i),this.activeLinkDecorationId=t.decorationId}))}else this.cleanUpActiveLinkDecoration()}cleanUpActiveLinkDecoration(){const e="altKey"===this.editor.getOption(74);if(this.activeLinkDecorationId){const t=this.currentOccurrences[this.activeLinkDecorationId];t&&this.editor.changeDecorations((i=>{t.deactivate(i,e)})),this.activeLinkDecorationId=null}}onEditorMouseUp(e){if(!this.isEnabled(e))return;const t=this.getLinkOccurrence(e.target.position);t&&this.openLinkOccurrence(t,e.hasSideBySideModifier,!0)}openLinkOccurrence(e,t,i=!1){if(!this.openerService)return;const{link:o}=e;o.resolve(CancellationToken.None).then((e=>{if("string"==typeof e&&this.editor.hasModel()){const t=this.editor.getModel().uri;if(t.scheme===Schemas.file&&e.startsWith(`${Schemas.file}:`)){const i=URI.parse(e);if(i.scheme===Schemas.file){const o=resources.originalFSPath(i);let n=null;o.startsWith("/./")?n=`.${o.substr(1)}`:o.startsWith("//./")&&(n=`.${o.substr(2)}`),n&&(e=resources.joinPath(t,n))}}}return this.openerService.open(e,{openToSide:t,fromUserGesture:i,allowContributedOpeners:!0,allowCommands:!0,fromWorkspace:!0})}),(e=>{const t=e instanceof Error?e.message:e;"invalid"===t?this.notificationService.warn(nls.localize("invalid.url","Failed to open this link because it is not well-formed: {0}",o.url.toString())):"missing"===t?this.notificationService.warn(nls.localize("missing.url","Failed to open this link because its target is missing.")):onUnexpectedError(e)}))}getLinkOccurrence(e){if(!this.editor.hasModel()||!e)return null;const t=this.editor.getModel().getDecorationsInRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},0,!0);for(const e of t){const t=this.currentOccurrences[e.id];if(t)return t}return null}isEnabled(e,t){return Boolean(6===e.target.type&&(e.hasTriggerModifier||t&&t.keyCodeIsTriggerKey))}stop(){var e;this.computeLinks.cancel(),this.activeLinksList&&(null===(e=this.activeLinksList)||void 0===e||e.dispose(),this.activeLinksList=null),this.computePromise&&(this.computePromise.cancel(),this.computePromise=null)}dispose(){super.dispose(),this.stop()}};LinkDetector.ID="editor.linkDetector",LinkDetector=__decorate([__param(1,IOpenerService),__param(2,INotificationService),__param(3,ILanguageFeaturesService),__param(4,ILanguageFeatureDebounceService)],LinkDetector);export{LinkDetector};const decoration={general:ModelDecorationOptions.register({description:"detected-link",stickiness:1,collapseOnReplaceEdit:!0,inlineClassName:"detected-link"}),active:ModelDecorationOptions.register({description:"detected-link-active",stickiness:1,collapseOnReplaceEdit:!0,inlineClassName:"detected-link-active"})};class LinkOccurrence{static decoration(e,t){return{range:e.range,options:LinkOccurrence._getOptions(e,t,!1)}}static _getOptions(e,t,i){const o=Object.assign({},i?decoration.active:decoration.general);return o.hoverMessage=getHoverMessage(e,t),o}constructor(e,t){this.link=e,this.decorationId=t}activate(e,t){e.changeDecorationOptions(this.decorationId,LinkOccurrence._getOptions(this.link,t,!0))}deactivate(e,t){e.changeDecorationOptions(this.decorationId,LinkOccurrence._getOptions(this.link,t,!1))}}function getHoverMessage(e,t){const i=e.url&&/^command:/i.test(e.url.toString()),o=e.tooltip?e.tooltip:i?nls.localize("links.navigate.executeCmd","Execute command"):nls.localize("links.navigate.follow","Follow link"),n=t?platform.isMacintosh?nls.localize("links.navigate.kb.meta.mac","cmd + click"):nls.localize("links.navigate.kb.meta","ctrl + click"):platform.isMacintosh?nls.localize("links.navigate.kb.alt.mac","option + click"):nls.localize("links.navigate.kb.alt","alt + click");if(e.url){let t="";if(/^command:/i.test(e.url.toString())){const i=e.url.toString().match(/^command:([^?#]+)/);if(i){const e=i[1];t=nls.localize("tooltip.explanation","Execute command {0}",e)}}return new MarkdownString("",!0).appendLink(e.url.toString(!0).replace(/ /g,"%20"),o,t).appendMarkdown(` (${n})`)}return(new MarkdownString).appendText(`${o} (${n})`)}class OpenLinkAction extends EditorAction{constructor(){super({id:"editor.action.openLink",label:nls.localize("label","Open Link"),alias:"Open Link",precondition:void 0})}run(e,t){const i=LinkDetector.get(t);if(!i)return;if(!t.hasModel())return;const o=t.getSelections();for(const e of o){const t=i.getLinkOccurrence(e.getEndPosition());t&&i.openLinkOccurrence(t,!1)}}}registerEditorContribution(LinkDetector.ID,LinkDetector,1),registerEditorAction(OpenLinkAction);