var _CodeActionUi_disposed,__decorate=this&&this.__decorate||function(i,t,e,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,e):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(i,t,e,o);else for(var a=i.length-1;a>=0;a--)(s=i[a])&&(r=(n<3?s(r):n>3?s(t,e,r):s(t,e))||r);return n>3&&r&&Object.defineProperty(t,e,r),r},__param=this&&this.__param||function(i,t){return function(e,o){t(e,o,i)}},__awaiter=this&&this.__awaiter||function(i,t,e,o){return new(e||(e=Promise))((function(s,n){function r(i){try{l(o.next(i))}catch(i){n(i)}}function a(i){try{l(o.throw(i))}catch(i){n(i)}}function l(i){var t;i.done?s(i.value):(t=i.value,t instanceof e?t:new e((function(i){i(t)}))).then(r,a)}l((o=o.apply(i,t||[])).next())}))},__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(i,t,e,o,s){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?i!==t||!s:!t.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?s.call(i,e):s?s.value=e:t.set(i,e),e},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(i,t,e,o){if("a"===e&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?i!==t||!o:!t.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===e?o:"a"===e?o.call(i):o?o.value:t.get(i)};import{getDomNodePagePosition}from"../../../../base/browser/dom.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{CodeActionKeybindingResolver}from"./codeActionKeybindingResolver.js";import{toMenuItems}from"./codeActionMenu.js";import{MessageController}from"../../message/browser/messageController.js";import{localize}from"../../../../nls.js";import{IActionWidgetService}from"../../../../platform/actionWidget/browser/actionWidget.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{LightBulbWidget}from"./lightBulbWidget.js";let CodeActionUi=class extends Disposable{constructor(i,t,e,o,s,n,r,a){super(),this._editor=i,this.delegate=o,this._configurationService=n,this._actionWidgetService=r,this._commandService=a,this._activeCodeActions=this._register(new MutableDisposable),_CodeActionUi_disposed.set(this,!1),this._showDisabled=!1,this._lightBulbWidget=new Lazy((()=>{const i=this._register(s.createInstance(LightBulbWidget,this._editor,t,e));return this._register(i.onClick((i=>this.showCodeActionList(i.actions,i,{includeDisabledActions:!1,fromLightbulb:!0})))),i})),this._resolver=s.createInstance(CodeActionKeybindingResolver),this._register(this._editor.onDidLayoutChange((()=>this._actionWidgetService.hide())))}dispose(){__classPrivateFieldSet(this,_CodeActionUi_disposed,!0,"f"),super.dispose()}update(i){var t,e,o,s,n;return __awaiter(this,void 0,void 0,(function*(){if(1!==i.type)return void(null===(t=this._lightBulbWidget.rawValue)||void 0===t||t.hide());let r;try{r=yield i.actions}catch(i){return void onUnexpectedError(i)}if(!__classPrivateFieldGet(this,_CodeActionUi_disposed,"f"))if(this._lightBulbWidget.value.update(r,i.trigger,i.position),1===i.trigger.type){if(null===(e=i.trigger.filter)||void 0===e?void 0:e.include){const t=this.tryGetValidActionToApply(i.trigger,r);if(t){try{this._lightBulbWidget.value.hide(),yield this.delegate.applyCodeAction(t,!1,!1)}finally{r.dispose()}return}if(i.trigger.context){const t=this.getInvalidActionThatWouldHaveBeenApplied(i.trigger,r);if(t&&t.action.disabled)return null===(o=MessageController.get(this._editor))||void 0===o||o.showMessage(t.action.disabled,i.trigger.context.position),void r.dispose()}}const t=!!(null===(s=i.trigger.filter)||void 0===s?void 0:s.include);if(i.trigger.context&&(!r.allActions.length||!t&&!r.validActions.length))return null===(n=MessageController.get(this._editor))||void 0===n||n.showMessage(i.trigger.context.notAvailableMessage,i.trigger.context.position),this._activeCodeActions.value=r,void r.dispose();this._activeCodeActions.value=r,this.showCodeActionList(r,this.toCoords(i.position),{includeDisabledActions:t,fromLightbulb:!1})}else this._actionWidgetService.isVisible?r.dispose():this._activeCodeActions.value=r}))}getInvalidActionThatWouldHaveBeenApplied(i,t){if(t.allActions.length)return"first"===i.autoApply&&0===t.validActions.length||"ifSingle"===i.autoApply&&1===t.allActions.length?t.allActions.find((({action:i})=>i.disabled)):void 0}tryGetValidActionToApply(i,t){if(t.validActions.length)return"first"===i.autoApply&&t.validActions.length>0||"ifSingle"===i.autoApply&&1===t.validActions.length?t.validActions[0]:void 0}showCodeActionList(i,t,e){return __awaiter(this,void 0,void 0,(function*(){const o=this._editor.getDomNode();if(!o)return;const s=e.includeDisabledActions&&(this._showDisabled||0===i.validActions.length)?i.allActions:i.validActions;if(!s.length)return;const n=Position.isIPosition(t)?this.toCoords(t):t,r={onSelect:(i,t)=>__awaiter(this,void 0,void 0,(function*(){this.delegate.applyCodeAction(i,!0,t||!1),this._actionWidgetService.hide()})),onHide:()=>{var i;null===(i=this._editor)||void 0===i||i.focus()}};this._actionWidgetService.show("codeActionWidget",!0,toMenuItems(s,this._shouldShowHeaders(),this._resolver.getResolver()),r,n,o,this._getActionBarActions(i,t,e))}))}toCoords(i){if(!this._editor.hasModel())return{x:0,y:0};this._editor.revealPosition(i,1),this._editor.render();const t=this._editor.getScrolledVisiblePosition(i),e=getDomNodePagePosition(this._editor.getDomNode());return{x:e.left+t.left,y:e.top+t.top+t.height}}_shouldShowHeaders(){var i;const t=null===(i=this._editor)||void 0===i?void 0:i.getModel();return this._configurationService.getValue("editor.codeActionWidget.showHeaders",{resource:null==t?void 0:t.uri})}_getActionBarActions(i,t,e){if(e.fromLightbulb)return[];const o=i.documentation.map((i=>{var t;return{id:i.id,label:i.title,tooltip:null!==(t=i.tooltip)&&void 0!==t?t:"",class:void 0,enabled:!0,run:()=>{var t;return this._commandService.executeCommand(i.id,...null!==(t=i.commandArguments)&&void 0!==t?t:[])}}}));return e.includeDisabledActions&&i.validActions.length>0&&i.allActions.length!==i.validActions.length&&o.push(this._showDisabled?{id:"hideMoreActions",label:localize("hideMoreActions","Hide Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>(this._showDisabled=!1,this.showCodeActionList(i,t,e))}:{id:"showMoreActions",label:localize("showMoreActions","Show Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>(this._showDisabled=!0,this.showCodeActionList(i,t,e))}),o}};_CodeActionUi_disposed=new WeakMap,CodeActionUi=__decorate([__param(4,IInstantiationService),__param(5,IConfigurationService),__param(6,IActionWidgetService),__param(7,ICommandService)],CodeActionUi);export{CodeActionUi};