var __decorate=this&&this.__decorate||function(e,r,t,o){var i,n=arguments.length,s=n<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(n<3?i(s):n>3?i(r,t,s):i(r,t))||s);return n>3&&s&&Object.defineProperty(r,t,s),s},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,n){function s(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,a)}c((o=o.apply(e,r||[])).next())}))};import{raceCancellation}from"../../../../base/common/async.js";import{UriList,VSDataTransfer}from"../../../../base/common/dataTransfer.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{Mimes}from"../../../../base/common/mime.js";import{relativePath}from"../../../../base/common/resources.js";import{URI}from"../../../../base/common/uri.js";import{addExternalEditorsDropData,toVSDataTransfer}from"../../../browser/dnd.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{IBulkEditService,ResourceTextEdit}from"../../../browser/services/bulkEditService.js";import{Range}from"../../../common/core/range.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{SnippetParser}from"../../snippet/browser/snippetParser.js";import{localize}from"../../../../nls.js";import{IProgressService}from"../../../../platform/progress/common/progress.js";import{IWorkspaceContextService}from"../../../../platform/workspace/common/workspace.js";let DropIntoEditorController=class extends Disposable{constructor(e,r,t,o,i){super(),this._bulkEditService=r,this._languageFeaturesService=t,this._progressService=o,this._register(e.onDropIntoEditor((r=>this.onDropIntoEditor(e,r.position,r.event)))),this._languageFeaturesService.documentOnDropEditProvider.register("*",new DefaultOnDropProvider(i))}onDropIntoEditor(e,r,t){var o,i;return __awaiter(this,void 0,void 0,(function*(){if(!t.dataTransfer||!e.hasModel())return;const n=e.getModel(),s=n.getVersionId(),a=yield this.extractDataTransferData(t);if(0===a.size)return;if(e.getModel().getVersionId()!==s)return;const c=new EditorStateCancellationTokenSource(e,1);try{const t=this._languageFeaturesService.documentOnDropEditProvider.ordered(n),l=yield this._progressService.withProgress({location:15,delay:750,title:localize("dropProgressTitle","Running drop handlers..."),cancellable:!0},(()=>raceCancellation((()=>__awaiter(this,void 0,void 0,(function*(){for(const e of t){const t=yield e.provideDocumentOnDropEdits(n,r,a,c.token);if(c.token.isCancellationRequested)return;if(t)return t}})))(),c.token)),(()=>{c.cancel()}));if(c.token.isCancellationRequested||e.getModel().getVersionId()!==s)return;if(l){const t="string"==typeof l.insertText?SnippetParser.escape(l.insertText):l.insertText.snippet,s={edits:[new ResourceTextEdit(n.uri,{range:new Range(r.lineNumber,r.column,r.lineNumber,r.column),text:t,insertAsSnippet:!0}),...null!==(i=null===(o=l.additionalEdit)||void 0===o?void 0:o.edits)&&void 0!==i?i:[]]};return void(yield this._bulkEditService.apply(s,{editor:e}))}}finally{c.dispose()}}))}extractDataTransferData(e){return __awaiter(this,void 0,void 0,(function*(){if(!e.dataTransfer)return new VSDataTransfer;const r=toVSDataTransfer(e.dataTransfer);return addExternalEditorsDropData(r,e),r}))}};DropIntoEditorController.ID="editor.contrib.dropIntoEditorController",DropIntoEditorController=__decorate([__param(1,IBulkEditService),__param(2,ILanguageFeaturesService),__param(3,IProgressService),__param(4,IWorkspaceContextService)],DropIntoEditorController);export{DropIntoEditorController};let DefaultOnDropProvider=class{constructor(e){this._workspaceContextService=e}provideDocumentOnDropEdits(e,r,t,o){var i;return __awaiter(this,void 0,void 0,(function*(){const e=t.get(Mimes.uriList);if(e){const r=yield e.asString(),t=this.getUriListInsertText(r);if(t)return{insertText:t}}const r=null!==(i=t.get("text"))&&void 0!==i?i:t.get(Mimes.text);if(r)return{insertText:yield r.asString()}}))}getUriListInsertText(e){const r=[];for(const t of UriList.parse(e))try{r.push(URI.parse(t))}catch(e){}if(r.length)return r.map((e=>{const r=this._workspaceContextService.getWorkspaceFolder(e);if(r){const t=relativePath(r.uri,e);if(t)return t}return e.fsPath})).join(" ")}};DefaultOnDropProvider=__decorate([__param(0,IWorkspaceContextService)],DefaultOnDropProvider),registerEditorContribution(DropIntoEditorController.ID,DropIntoEditorController,2);