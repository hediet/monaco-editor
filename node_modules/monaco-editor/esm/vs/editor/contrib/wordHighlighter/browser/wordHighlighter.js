var __decorate=this&&this.__decorate||function(t,e,i,o){var r,s=arguments.length,n=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,o);else for(var h=t.length-1;h>=0;h--)(r=t[h])&&(n=(s<3?r(n):s>3?r(e,i,n):r(e,i))||n);return s>3&&n&&Object.defineProperty(e,i,n),n},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}};import{alert}from"../../../../base/browser/ui/aria/aria.js";import*as arrays from"../../../../base/common/arrays.js";import{createCancelablePromise,first,timeout}from"../../../../base/common/async.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution,registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{DocumentHighlightKind}from"../../../common/languages.js";import*as nls from"../../../../nls.js";import{IContextKeyService,RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{getHighlightDecorationOptions}from"./highlightDecorations.js";const ctxHasWordHighlights=new RawContextKey("hasWordHighlights",!1);export function getOccurrencesAtPosition(t,e,i,o){const r=t.ordered(e);return first(r.map((t=>()=>Promise.resolve(t.provideDocumentHighlights(e,i,o)).then(void 0,onUnexpectedExternalError))),arrays.isNonEmptyArray)}class OccurenceAtPositionRequest{constructor(t,e,i){this._model=t,this._selection=e,this._wordSeparators=i,this._wordRange=this._getCurrentWordRange(t,e),this._result=null}get result(){return this._result||(this._result=createCancelablePromise((t=>this._compute(this._model,this._selection,this._wordSeparators,t)))),this._result}_getCurrentWordRange(t,e){const i=t.getWordAtPosition(e.getPosition());return i?new Range(e.startLineNumber,i.startColumn,e.startLineNumber,i.endColumn):null}isValid(t,e,i){const o=e.startLineNumber,r=e.startColumn,s=e.endColumn,n=this._getCurrentWordRange(t,e);let h=Boolean(this._wordRange&&this._wordRange.equalsRange(n));for(let t=0,e=i.length;!h&&t<e;t++){const e=i.getRange(t);e&&e.startLineNumber===o&&e.startColumn<=r&&e.endColumn>=s&&(h=!0)}return h}cancel(){this.result.cancel()}}class SemanticOccurenceAtPositionRequest extends OccurenceAtPositionRequest{constructor(t,e,i,o){super(t,e,i),this._providers=o}_compute(t,e,i,o){return getOccurrencesAtPosition(this._providers,t,e.getPosition(),o).then((t=>t||[]))}}class TextualOccurenceAtPositionRequest extends OccurenceAtPositionRequest{constructor(t,e,i){super(t,e,i),this._selectionIsEmpty=e.isEmpty()}_compute(t,e,i,o){return timeout(250,o).then((()=>{if(!e.isEmpty())return[];const o=t.getWordAtPosition(e.getPosition());return!o||o.word.length>1e3?[]:t.findMatches(o.word,!0,!1,!0,i,!1).map((t=>({range:t.range,kind:DocumentHighlightKind.Text})))}))}isValid(t,e,i){const o=e.isEmpty();return this._selectionIsEmpty===o&&super.isValid(t,e,i)}}function computeOccurencesAtPosition(t,e,i,o){return t.has(e)?new SemanticOccurenceAtPositionRequest(e,i,o,t):new TextualOccurenceAtPositionRequest(e,i,o)}registerModelAndPositionCommand("_executeDocumentHighlights",((t,e,i)=>getOccurrencesAtPosition(t.get(ILanguageFeaturesService).documentHighlightProvider,e,i,CancellationToken.None)));class WordHighlighter{constructor(t,e,i){this.toUnhook=new DisposableStore,this.workerRequestTokenId=0,this.workerRequestCompleted=!1,this.workerRequestValue=[],this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1,this.editor=t,this.providers=e,this._hasWordHighlights=ctxHasWordHighlights.bindTo(i),this._ignorePositionChangeEvent=!1,this.occurrencesHighlight=this.editor.getOption(77),this.model=this.editor.getModel(),this.toUnhook.add(t.onDidChangeCursorPosition((t=>{this._ignorePositionChangeEvent||this.occurrencesHighlight&&this._onPositionChanged(t)}))),this.toUnhook.add(t.onDidChangeModelContent((t=>{this._stopAll()}))),this.toUnhook.add(t.onDidChangeConfiguration((t=>{const e=this.editor.getOption(77);this.occurrencesHighlight!==e&&(this.occurrencesHighlight=e,this._stopAll())}))),this.decorations=this.editor.createDecorationsCollection(),this.workerRequestTokenId=0,this.workerRequest=null,this.workerRequestCompleted=!1,this.lastCursorPositionChangeTime=0,this.renderDecorationsTimer=-1}hasDecorations(){return this.decorations.length>0}restore(){this.occurrencesHighlight&&this._run()}_getSortedHighlights(){return this.decorations.getRanges().sort(Range.compareRangesUsingStarts)}moveNext(){const t=this._getSortedHighlights(),e=(t.findIndex((t=>t.containsPosition(this.editor.getPosition())))+1)%t.length,i=t[e];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(i.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(i);const o=this._getWord();if(o){const r=this.editor.getModel().getLineContent(i.startLineNumber);alert(`${r}, ${e+1} of ${t.length} for '${o.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}moveBack(){const t=this._getSortedHighlights(),e=(t.findIndex((t=>t.containsPosition(this.editor.getPosition())))-1+t.length)%t.length,i=t[e];try{this._ignorePositionChangeEvent=!0,this.editor.setPosition(i.getStartPosition()),this.editor.revealRangeInCenterIfOutsideViewport(i);const o=this._getWord();if(o){const r=this.editor.getModel().getLineContent(i.startLineNumber);alert(`${r}, ${e+1} of ${t.length} for '${o.word}'`)}}finally{this._ignorePositionChangeEvent=!1}}_removeDecorations(){this.decorations.length>0&&(this.decorations.clear(),this._hasWordHighlights.set(!1))}_stopAll(){this._removeDecorations(),-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1),null!==this.workerRequest&&(this.workerRequest.cancel(),this.workerRequest=null),this.workerRequestCompleted||(this.workerRequestTokenId++,this.workerRequestCompleted=!0)}_onPositionChanged(t){this.occurrencesHighlight&&3===t.reason?this._run():this._stopAll()}_getWord(){const t=this.editor.getSelection(),e=t.startLineNumber,i=t.startColumn;return this.model.getWordAtPosition({lineNumber:e,column:i})}_run(){const t=this.editor.getSelection();if(t.startLineNumber!==t.endLineNumber)return void this._stopAll();const e=t.startColumn,i=t.endColumn,o=this._getWord();if(!o||o.startColumn>e||o.endColumn<i)return void this._stopAll();const r=this.workerRequest&&this.workerRequest.isValid(this.model,t,this.decorations);if(this.lastCursorPositionChangeTime=(new Date).getTime(),r)this.workerRequestCompleted&&-1!==this.renderDecorationsTimer&&(clearTimeout(this.renderDecorationsTimer),this.renderDecorationsTimer=-1,this._beginRenderDecorations());else{this._stopAll();const t=++this.workerRequestTokenId;this.workerRequestCompleted=!1,this.workerRequest=computeOccurencesAtPosition(this.providers,this.model,this.editor.getSelection(),this.editor.getOption(124)),this.workerRequest.result.then((e=>{t===this.workerRequestTokenId&&(this.workerRequestCompleted=!0,this.workerRequestValue=e||[],this._beginRenderDecorations())}),onUnexpectedError)}}_beginRenderDecorations(){const t=(new Date).getTime(),e=this.lastCursorPositionChangeTime+250;t>=e?(this.renderDecorationsTimer=-1,this.renderDecorations()):this.renderDecorationsTimer=setTimeout((()=>{this.renderDecorations()}),e-t)}renderDecorations(){this.renderDecorationsTimer=-1;const t=[];for(const e of this.workerRequestValue)e.range&&t.push({range:e.range,options:getHighlightDecorationOptions(e.kind)});this.decorations.set(t),this._hasWordHighlights.set(this.hasDecorations())}dispose(){this._stopAll(),this.toUnhook.dispose()}}let WordHighlighterContribution=class t extends Disposable{static get(e){return e.getContribution(t.ID)}constructor(t,e,i){super(),this.wordHighlighter=null;const o=()=>{t.hasModel()&&(this.wordHighlighter=new WordHighlighter(t,i.documentHighlightProvider,e))};this._register(t.onDidChangeModel((t=>{this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),o()}))),o()}saveViewState(){return!(!this.wordHighlighter||!this.wordHighlighter.hasDecorations())}moveNext(){var t;null===(t=this.wordHighlighter)||void 0===t||t.moveNext()}moveBack(){var t;null===(t=this.wordHighlighter)||void 0===t||t.moveBack()}restoreViewState(t){this.wordHighlighter&&t&&this.wordHighlighter.restore()}dispose(){this.wordHighlighter&&(this.wordHighlighter.dispose(),this.wordHighlighter=null),super.dispose()}};WordHighlighterContribution.ID="editor.contrib.wordHighlighter",WordHighlighterContribution=__decorate([__param(1,IContextKeyService),__param(2,ILanguageFeaturesService)],WordHighlighterContribution);class WordHighlightNavigationAction extends EditorAction{constructor(t,e){super(e),this._isNext=t}run(t,e){const i=WordHighlighterContribution.get(e);i&&(this._isNext?i.moveNext():i.moveBack())}}class NextWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!0,{id:"editor.action.wordHighlight.next",label:nls.localize("wordHighlight.next.label","Go to Next Symbol Highlight"),alias:"Go to Next Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:65,weight:100}})}}class PrevWordHighlightAction extends WordHighlightNavigationAction{constructor(){super(!1,{id:"editor.action.wordHighlight.prev",label:nls.localize("wordHighlight.previous.label","Go to Previous Symbol Highlight"),alias:"Go to Previous Symbol Highlight",precondition:ctxHasWordHighlights,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1089,weight:100}})}}class TriggerWordHighlightAction extends EditorAction{constructor(){super({id:"editor.action.wordHighlight.trigger",label:nls.localize("wordHighlight.trigger.label","Trigger Symbol Highlight"),alias:"Trigger Symbol Highlight",precondition:ctxHasWordHighlights.toNegated(),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:0,weight:100}})}run(t,e,i){const o=WordHighlighterContribution.get(e);o&&o.restoreViewState(!0)}}registerEditorContribution(WordHighlighterContribution.ID,WordHighlighterContribution,0),registerEditorAction(NextWordHighlightAction),registerEditorAction(PrevWordHighlightAction),registerEditorAction(TriggerWordHighlightAction);