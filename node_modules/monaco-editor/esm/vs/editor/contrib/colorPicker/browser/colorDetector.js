var __decorate=this&&this.__decorate||function(e,o,t,r){var i,s=arguments.length,n=s<3?o:null===r?r=Object.getOwnPropertyDescriptor(o,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,o,t,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(s<3?i(n):s>3?i(o,t,n):i(o,t))||n);return s>3&&n&&Object.defineProperty(o,t,n),n},__param=this&&this.__param||function(e,o){return function(t,r){o(t,r,e)}},__awaiter=this&&this.__awaiter||function(e,o,t,r){return new(t||(t=Promise))((function(i,s){function n(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var o;e.done?i(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(n,a)}c((r=r.apply(e,o||[])).next())}))};import{createCancelablePromise,TimeoutTimer}from"../../../../base/common/async.js";import{RGBA}from"../../../../base/common/color.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{StopWatch}from"../../../../base/common/stopwatch.js";import{noBreakWhitespace}from"../../../../base/common/strings.js";import{DynamicCssRules}from"../../../browser/editorDom.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{Range}from"../../../common/core/range.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{getColors}from"./color.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";export const ColorDecorationInjectedTextMarker=Object.create({});let ColorDetector=class e extends Disposable{constructor(o,t,r,i){super(),this._editor=o,this._configurationService=t,this._languageFeaturesService=r,this._localToDispose=this._register(new DisposableStore),this._decorationsIds=[],this._colorDatas=new Map,this._colorDecoratorIds=this._editor.createDecorationsCollection(),this._ruleFactory=new DynamicCssRules(this._editor),this._colorDecorationClassRefs=this._register(new DisposableStore),this._debounceInformation=i.for(r.colorProvider,"Document Colors",{min:e.RECOMPUTE_TIME}),this._register(o.onDidChangeModel((()=>{this._isEnabled=this.isEnabled(),this.onModelChanged()}))),this._register(o.onDidChangeModelLanguage((()=>this.onModelChanged()))),this._register(r.colorProvider.onDidChange((()=>this.onModelChanged()))),this._register(o.onDidChangeConfiguration((e=>{const o=this._isEnabled;this._isEnabled=this.isEnabled(),(o!==this._isEnabled||e.hasChanged(18))&&(this._isEnabled?this.onModelChanged():this.removeAllDecorations())}))),this._timeoutTimer=null,this._computePromise=null,this._isEnabled=this.isEnabled(),this.onModelChanged()}isEnabled(){const e=this._editor.getModel();if(!e)return!1;const o=e.getLanguageId(),t=this._configurationService.getValue(o);if(t&&"object"==typeof t){const e=t.colorDecorators;if(e&&void 0!==e.enable&&!e.enable)return e.enable}return this._editor.getOption(17)}getDecoratorLimit(){return this._editor.getOption(18)}static get(e){return e.getContribution(this.ID)}dispose(){this.stop(),this.removeAllDecorations(),super.dispose()}onModelChanged(){if(this.stop(),!this._isEnabled)return;const e=this._editor.getModel();e&&this._languageFeaturesService.colorProvider.has(e)&&(this._localToDispose.add(this._editor.onDidChangeModelContent((()=>{this._timeoutTimer||(this._timeoutTimer=new TimeoutTimer,this._timeoutTimer.cancelAndSet((()=>{this._timeoutTimer=null,this.beginCompute()}),this._debounceInformation.get(e)))}))),this.beginCompute())}beginCompute(){this._computePromise=createCancelablePromise((e=>__awaiter(this,void 0,void 0,(function*(){const o=this._editor.getModel();if(!o)return Promise.resolve([]);const t=new StopWatch(!1),r=yield getColors(this._languageFeaturesService.colorProvider,o,e);return this._debounceInformation.update(o,t.elapsed()),r})))),this._computePromise.then((e=>{this.updateDecorations(e),this.updateColorDecorators(e),this._computePromise=null}),onUnexpectedError)}stop(){this._timeoutTimer&&(this._timeoutTimer.cancel(),this._timeoutTimer=null),this._computePromise&&(this._computePromise.cancel(),this._computePromise=null),this._localToDispose.clear()}updateDecorations(e){const o=e.map((e=>({range:{startLineNumber:e.colorInfo.range.startLineNumber,startColumn:e.colorInfo.range.startColumn,endLineNumber:e.colorInfo.range.endLineNumber,endColumn:e.colorInfo.range.endColumn},options:ModelDecorationOptions.EMPTY})));this._editor.changeDecorations((t=>{this._decorationsIds=t.deltaDecorations(this._decorationsIds,o),this._colorDatas=new Map,this._decorationsIds.forEach(((o,t)=>this._colorDatas.set(o,e[t])))}))}updateColorDecorators(e){this._colorDecorationClassRefs.clear();const o=[];for(let t=0;t<e.length&&o.length<this.getDecoratorLimit();t++){const{red:r,green:i,blue:s,alpha:n}=e[t].colorInfo.color,a=new RGBA(Math.round(255*r),Math.round(255*i),Math.round(255*s),n),c=`rgba(${a.r}, ${a.g}, ${a.b}, ${a.a})`,l=this._colorDecorationClassRefs.add(this._ruleFactory.createClassNameRef({backgroundColor:c}));o.push({range:{startLineNumber:e[t].colorInfo.range.startLineNumber,startColumn:e[t].colorInfo.range.startColumn,endLineNumber:e[t].colorInfo.range.endLineNumber,endColumn:e[t].colorInfo.range.endColumn},options:{description:"colorDetector",before:{content:noBreakWhitespace,inlineClassName:`${l.className} colorpicker-color-decoration`,inlineClassNameAffectsLetterSpacing:!0,attachedData:ColorDecorationInjectedTextMarker}}})}this._colorDecoratorIds.set(o)}removeAllDecorations(){this._editor.removeDecorations(this._decorationsIds),this._decorationsIds=[],this._colorDecoratorIds.clear(),this._colorDecorationClassRefs.clear()}getColorData(e){const o=this._editor.getModel();if(!o)return null;const t=o.getDecorationsInRange(Range.fromPositions(e,e)).filter((e=>this._colorDatas.has(e.id)));return 0===t.length?null:this._colorDatas.get(t[0].id)}isColorDecoration(e){return this._colorDecoratorIds.has(e)}};ColorDetector.ID="editor.contrib.colorDetector",ColorDetector.RECOMPUTE_TIME=1e3,ColorDetector=__decorate([__param(1,IConfigurationService),__param(2,ILanguageFeaturesService),__param(3,ILanguageFeatureDebounceService)],ColorDetector);export{ColorDetector};registerEditorContribution(ColorDetector.ID,ColorDetector,1);