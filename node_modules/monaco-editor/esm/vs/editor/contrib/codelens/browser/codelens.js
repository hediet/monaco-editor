var __awaiter=this&&this.__awaiter||function(e,o,s,r){return new(s||(s=Promise))((function(n,t){function i(e){try{l(r.next(e))}catch(e){t(e)}}function a(e){try{l(r.throw(e))}catch(e){t(e)}}function l(e){var o;e.done?n(e.value):(o=e.value,o instanceof s?o:new s((function(e){e(o)}))).then(i,a)}l((r=r.apply(e,o||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{illegalArgument,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{IModelService}from"../../../common/services/model.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";export class CodeLensModel{constructor(){this.lenses=[],this._disposables=new DisposableStore}dispose(){this._disposables.dispose()}get isDisposed(){return this._disposables.isDisposed}add(e,o){this._disposables.add(e);for(const s of e.lenses)this.lenses.push({symbol:s,provider:o})}}export function getCodeLensModel(e,o,s){return __awaiter(this,void 0,void 0,(function*(){const r=e.ordered(o),n=new Map,t=new CodeLensModel,i=r.map(((e,r)=>__awaiter(this,void 0,void 0,(function*(){n.set(e,r);try{const r=yield Promise.resolve(e.provideCodeLenses(o,s));r&&t.add(r,e)}catch(e){onUnexpectedExternalError(e)}}))));return yield Promise.all(i),t.lenses=t.lenses.sort(((e,o)=>e.symbol.range.startLineNumber<o.symbol.range.startLineNumber?-1:e.symbol.range.startLineNumber>o.symbol.range.startLineNumber?1:n.get(e.provider)<n.get(o.provider)?-1:n.get(e.provider)>n.get(o.provider)?1:e.symbol.range.startColumn<o.symbol.range.startColumn?-1:e.symbol.range.startColumn>o.symbol.range.startColumn?1:0)),t}))}CommandsRegistry.registerCommand("_executeCodeLensProvider",(function(e,...o){let[s,r]=o;assertType(URI.isUri(s)),assertType("number"==typeof r||!r);const{codeLensProvider:n}=e.get(ILanguageFeaturesService),t=e.get(IModelService).getModel(s);if(!t)throw illegalArgument();const i=[],a=new DisposableStore;return getCodeLensModel(n,t,CancellationToken.None).then((e=>{a.add(e);const o=[];for(const s of e.lenses)null==r||Boolean(s.symbol.command)?i.push(s.symbol):r-- >0&&s.provider.resolveCodeLens&&o.push(Promise.resolve(s.provider.resolveCodeLens(t,s.symbol,CancellationToken.None)).then((e=>i.push(e||s.symbol))));return Promise.all(o)})).then((()=>i)).finally((()=>{setTimeout((()=>a.dispose()),100)}))}));