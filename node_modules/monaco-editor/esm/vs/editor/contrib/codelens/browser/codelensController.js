var __decorate=this&&this.__decorate||function(e,o,s,t){var i,n=arguments.length,r=n<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,s):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,o,s,t);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(r=(n<3?i(r):n>3?i(o,s,r):i(o,s))||r);return n>3&&r&&Object.defineProperty(o,s,r),r},__param=this&&this.__param||function(e,o){return function(s,t){o(s,t,e)}},__awaiter=this&&this.__awaiter||function(e,o,s,t){return new(s||(s=Promise))((function(i,n){function r(e){try{l(t.next(e))}catch(e){n(e)}}function d(e){try{l(t.throw(e))}catch(e){n(e)}}function l(e){var o;e.done?i(e.value):(o=e.value,o instanceof s?o:new s((function(e){e(o)}))).then(r,d)}l((t=t.apply(e,o||[])).next())}))};import{createCancelablePromise,disposableTimeout,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{StableEditorScrollState}from"../../../browser/stableEditorScroll.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{getCodeLensModel}from"./codelens.js";import{ICodeLensCache}from"./codeLensCache.js";import{CodeLensHelper,CodeLensWidget}from"./codelensWidget.js";import{localize}from"../../../../nls.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IQuickInputService}from"../../../../platform/quickinput/common/quickInput.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";let CodeLensContribution=class{constructor(e,o,s,t,i,n){this._editor=e,this._languageFeaturesService=o,this._commandService=t,this._notificationService=i,this._codeLensCache=n,this._disposables=new DisposableStore,this._localToDispose=new DisposableStore,this._lenses=[],this._oldCodeLensModels=new DisposableStore,this._provideCodeLensDebounce=s.for(o.codeLensProvider,"CodeLensProvide",{min:250}),this._resolveCodeLensesDebounce=s.for(o.codeLensProvider,"CodeLensResolve",{min:250,salt:"resolve"}),this._resolveCodeLensesScheduler=new RunOnceScheduler((()=>this._resolveCodeLensesInViewport()),this._resolveCodeLensesDebounce.default()),this._disposables.add(this._editor.onDidChangeModel((()=>this._onModelChange()))),this._disposables.add(this._editor.onDidChangeModelLanguage((()=>this._onModelChange()))),this._disposables.add(this._editor.onDidChangeConfiguration((e=>{(e.hasChanged(47)||e.hasChanged(16)||e.hasChanged(15))&&this._updateLensStyle(),e.hasChanged(14)&&this._onModelChange()}))),this._disposables.add(o.codeLensProvider.onDidChange(this._onModelChange,this)),this._onModelChange(),this._updateLensStyle()}dispose(){var e;this._localDispose(),this._disposables.dispose(),this._oldCodeLensModels.dispose(),null===(e=this._currentCodeLensModel)||void 0===e||e.dispose()}_getLayoutInfo(){const e=Math.max(1.3,this._editor.getOption(63)/this._editor.getOption(49));let o=this._editor.getOption(16);return(!o||o<5)&&(o=.9*this._editor.getOption(49)|0),{fontSize:o,codeLensHeight:o*e|0}}_updateLensStyle(){const{codeLensHeight:e,fontSize:o}=this._getLayoutInfo(),s=this._editor.getOption(15),t=this._editor.getOption(47),{style:i}=this._editor.getContainerDomNode();i.setProperty("--vscode-editorCodeLens-lineHeight",`${e}px`),i.setProperty("--vscode-editorCodeLens-fontSize",`${o}px`),i.setProperty("--vscode-editorCodeLens-fontFeatureSettings",t.fontFeatureSettings),s&&(i.setProperty("--vscode-editorCodeLens-fontFamily",s),i.setProperty("--vscode-editorCodeLens-fontFamilyDefault",EDITOR_FONT_DEFAULTS.fontFamily)),this._editor.changeViewZones((o=>{for(const s of this._lenses)s.updateHeight(e,o)}))}_localDispose(){var e,o,s;null===(e=this._getCodeLensModelPromise)||void 0===e||e.cancel(),this._getCodeLensModelPromise=void 0,null===(o=this._resolveCodeLensesPromise)||void 0===o||o.cancel(),this._resolveCodeLensesPromise=void 0,this._localToDispose.clear(),this._oldCodeLensModels.clear(),null===(s=this._currentCodeLensModel)||void 0===s||s.dispose()}_onModelChange(){this._localDispose();const e=this._editor.getModel();if(!e)return;if(!this._editor.getOption(14))return;const o=this._codeLensCache.get(e);if(o&&this._renderCodeLensSymbols(o),!this._languageFeaturesService.codeLensProvider.has(e))return void(o&&this._localToDispose.add(disposableTimeout((()=>{const s=this._codeLensCache.get(e);o===s&&(this._codeLensCache.delete(e),this._onModelChange())}),3e4)));for(const o of this._languageFeaturesService.codeLensProvider.all(e))if("function"==typeof o.onDidChange){const e=o.onDidChange((()=>s.schedule()));this._localToDispose.add(e)}const s=new RunOnceScheduler((()=>{var o;const t=Date.now();null===(o=this._getCodeLensModelPromise)||void 0===o||o.cancel(),this._getCodeLensModelPromise=createCancelablePromise((o=>getCodeLensModel(this._languageFeaturesService.codeLensProvider,e,o))),this._getCodeLensModelPromise.then((o=>{this._currentCodeLensModel&&this._oldCodeLensModels.add(this._currentCodeLensModel),this._currentCodeLensModel=o,this._codeLensCache.put(e,o);const i=this._provideCodeLensDebounce.update(e,Date.now()-t);s.delay=i,this._renderCodeLensSymbols(o),this._resolveCodeLensesInViewportSoon()}),onUnexpectedError)}),this._provideCodeLensDebounce.get(e));this._localToDispose.add(s),this._localToDispose.add(toDisposable((()=>this._resolveCodeLensesScheduler.cancel()))),this._localToDispose.add(this._editor.onDidChangeModelContent((()=>{this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{const s=[];let t=-1;this._lenses.forEach((e=>{e.isValid()&&t!==e.getLineNumber()?(e.update(o),t=e.getLineNumber()):s.push(e)}));const i=new CodeLensHelper;s.forEach((e=>{e.dispose(i,o),this._lenses.splice(this._lenses.indexOf(e),1)})),i.commit(e)}))})),s.schedule()}))),this._localToDispose.add(this._editor.onDidFocusEditorWidget((()=>{s.schedule()}))),this._localToDispose.add(this._editor.onDidScrollChange((e=>{e.scrollTopChanged&&this._lenses.length>0&&this._resolveCodeLensesInViewportSoon()}))),this._localToDispose.add(this._editor.onDidLayoutChange((()=>{this._resolveCodeLensesInViewportSoon()}))),this._localToDispose.add(toDisposable((()=>{if(this._editor.getModel()){const e=StableEditorScrollState.capture(this._editor);this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{this._disposeAllLenses(e,o)}))})),e.restore(this._editor)}else this._disposeAllLenses(void 0,void 0)}))),this._localToDispose.add(this._editor.onMouseDown((e=>{if(9!==e.target.type)return;let o=e.target.element;if("SPAN"===(null==o?void 0:o.tagName)&&(o=o.parentElement),"A"===(null==o?void 0:o.tagName))for(const e of this._lenses){const s=e.getCommand(o);if(s){this._commandService.executeCommand(s.id,...s.arguments||[]).catch((e=>this._notificationService.error(e)));break}}}))),s.schedule()}_disposeAllLenses(e,o){const s=new CodeLensHelper;for(const e of this._lenses)e.dispose(s,o);e&&s.commit(e),this._lenses.length=0}_renderCodeLensSymbols(e){if(!this._editor.hasModel())return;const o=this._editor.getModel().getLineCount(),s=[];let t;for(const i of e.lenses){const e=i.symbol.range.startLineNumber;e<1||e>o||(t&&t[t.length-1].symbol.range.startLineNumber===e?t.push(i):(t=[i],s.push(t)))}if(!s.length&&!this._lenses.length)return;const i=StableEditorScrollState.capture(this._editor),n=this._getLayoutInfo();this._editor.changeDecorations((e=>{this._editor.changeViewZones((o=>{const t=new CodeLensHelper;let i=0,r=0;for(;r<s.length&&i<this._lenses.length;){const e=s[r][0].symbol.range.startLineNumber,d=this._lenses[i].getLineNumber();d<e?(this._lenses[i].dispose(t,o),this._lenses.splice(i,1)):d===e?(this._lenses[i].updateCodeLensSymbols(s[r],t),r++,i++):(this._lenses.splice(i,0,new CodeLensWidget(s[r],this._editor,t,o,n.codeLensHeight,(()=>this._resolveCodeLensesInViewportSoon()))),i++,r++)}for(;i<this._lenses.length;)this._lenses[i].dispose(t,o),this._lenses.splice(i,1);for(;r<s.length;)this._lenses.push(new CodeLensWidget(s[r],this._editor,t,o,n.codeLensHeight,(()=>this._resolveCodeLensesInViewportSoon()))),r++;t.commit(e)}))})),i.restore(this._editor)}_resolveCodeLensesInViewportSoon(){this._editor.getModel()&&this._resolveCodeLensesScheduler.schedule()}_resolveCodeLensesInViewport(){var e;null===(e=this._resolveCodeLensesPromise)||void 0===e||e.cancel(),this._resolveCodeLensesPromise=void 0;const o=this._editor.getModel();if(!o)return;const s=[],t=[];if(this._lenses.forEach((e=>{const i=e.computeIfNecessary(o);i&&(s.push(i),t.push(e))})),0===s.length)return;const i=Date.now(),n=createCancelablePromise((e=>{const i=s.map(((s,i)=>{const n=new Array(s.length),r=s.map(((s,t)=>s.symbol.command||"function"!=typeof s.provider.resolveCodeLens?(n[t]=s.symbol,Promise.resolve(void 0)):Promise.resolve(s.provider.resolveCodeLens(o,s.symbol,e)).then((e=>{n[t]=e}),onUnexpectedExternalError)));return Promise.all(r).then((()=>{e.isCancellationRequested||t[i].isDisposed()||t[i].updateCommands(n)}))}));return Promise.all(i)}));this._resolveCodeLensesPromise=n,this._resolveCodeLensesPromise.then((()=>{const e=this._resolveCodeLensesDebounce.update(o,Date.now()-i);this._resolveCodeLensesScheduler.delay=e,this._currentCodeLensModel&&this._codeLensCache.put(o,this._currentCodeLensModel),this._oldCodeLensModels.clear(),n===this._resolveCodeLensesPromise&&(this._resolveCodeLensesPromise=void 0)}),(e=>{onUnexpectedError(e),n===this._resolveCodeLensesPromise&&(this._resolveCodeLensesPromise=void 0)}))}getModel(){return this._currentCodeLensModel}};CodeLensContribution.ID="css.editor.codeLens",CodeLensContribution=__decorate([__param(1,ILanguageFeaturesService),__param(2,ILanguageFeatureDebounceService),__param(3,ICommandService),__param(4,INotificationService),__param(5,ICodeLensCache)],CodeLensContribution);export{CodeLensContribution};registerEditorContribution(CodeLensContribution.ID,CodeLensContribution,1),registerEditorAction(class extends EditorAction{constructor(){super({id:"codelens.showLensesInCurrentLine",precondition:EditorContextKeys.hasCodeLensProvider,label:localize("showLensOnLine","Show CodeLens Commands For Current Line"),alias:"Show CodeLens Commands For Current Line"})}run(e,o){return __awaiter(this,void 0,void 0,(function*(){if(!o.hasModel())return;const s=e.get(IQuickInputService),t=e.get(ICommandService),i=e.get(INotificationService),n=o.getSelection().positionLineNumber,r=o.getContribution(CodeLensContribution.ID);if(!r)return;const d=r.getModel();if(!d)return;const l=[];for(const e of d.lenses)e.symbol.command&&e.symbol.range.startLineNumber===n&&l.push({label:e.symbol.command.title,command:e.symbol.command});if(0===l.length)return;const a=yield s.pick(l,{canPickMany:!1});if(a){if(d.isDisposed)return yield t.executeCommand(this.id);try{yield t.executeCommand(a.command.id,...a.command.arguments||[])}catch(e){i.error(e)}}}))}});