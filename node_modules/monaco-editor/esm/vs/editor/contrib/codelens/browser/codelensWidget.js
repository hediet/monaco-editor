import*as dom from"../../../../base/browser/dom.js";import{renderLabelWithIcons}from"../../../../base/browser/ui/iconLabel/iconLabels.js";import"./codelensWidget.css";import{Range}from"../../../common/core/range.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";class CodeLensViewZone{constructor(t,e,o){this.afterColumn=1073741824,this.afterLineNumber=t,this.heightInPx=e,this._onHeight=o,this.suppressMouseDown=!0,this.domNode=document.createElement("div")}onComputedHeight(t){void 0===this._lastHeight?this._lastHeight=t:this._lastHeight!==t&&(this._lastHeight=t,this._onHeight())}isVisible(){return 0!==this._lastHeight&&this.domNode.hasAttribute("monaco-visible-view-zone")}}class CodeLensContentWidget{constructor(t,e){this.allowEditorOverflow=!1,this.suppressMouseDown=!0,this._commands=new Map,this._isEmpty=!0,this._editor=t,this._id="codelens.widget-"+CodeLensContentWidget._idPool++,this.updatePosition(e),this._domNode=document.createElement("span"),this._domNode.className="codelens-decoration"}withCommands(t,e){this._commands.clear();const o=[];let i=!1;for(let e=0;e<t.length;e++){const s=t[e];if(s&&(i=!0,s.command)){const i=renderLabelWithIcons(s.command.title.trim());s.command.id?(o.push(dom.$("a",{id:String(e),title:s.command.tooltip,role:"button"},...i)),this._commands.set(String(e),s.command)):o.push(dom.$("span",{title:s.command.tooltip},...i)),e+1<t.length&&o.push(dom.$("span",void 0," | "))}}i?(dom.reset(this._domNode,...o),this._isEmpty&&e&&this._domNode.classList.add("fadein"),this._isEmpty=!1):dom.reset(this._domNode,dom.$("span",void 0,"no commands"))}getCommand(t){return t.parentElement===this._domNode?this._commands.get(t.id):void 0}getId(){return this._id}getDomNode(){return this._domNode}updatePosition(t){const e=this._editor.getModel().getLineFirstNonWhitespaceColumn(t);this._widgetPosition={position:{lineNumber:t,column:e},preference:[1]}}getPosition(){return this._widgetPosition||null}}CodeLensContentWidget._idPool=0;export class CodeLensHelper{constructor(){this._removeDecorations=[],this._addDecorations=[],this._addDecorationsCallbacks=[]}addDecoration(t,e){this._addDecorations.push(t),this._addDecorationsCallbacks.push(e)}removeDecoration(t){this._removeDecorations.push(t)}commit(t){const e=t.deltaDecorations(this._removeDecorations,this._addDecorations);for(let t=0,o=e.length;t<o;t++)this._addDecorationsCallbacks[t](e[t])}}const codeLensDecorationOptions=ModelDecorationOptions.register({collapseOnReplaceEdit:!0,description:"codelens"});export class CodeLensWidget{constructor(t,e,o,i,s,n){let d;this._isDisposed=!1,this._editor=e,this._data=t,this._decorationIds=[];const a=[];this._data.forEach(((t,e)=>{t.symbol.command&&a.push(t.symbol),o.addDecoration({range:t.symbol.range,options:codeLensDecorationOptions},(t=>this._decorationIds[e]=t)),d=d?Range.plusRange(d,t.symbol.range):Range.lift(t.symbol.range)})),this._viewZone=new CodeLensViewZone(d.startLineNumber-1,s,n),this._viewZoneId=i.addZone(this._viewZone),a.length>0&&(this._createContentWidgetIfNecessary(),this._contentWidget.withCommands(a,!1))}_createContentWidgetIfNecessary(){this._contentWidget?this._editor.layoutContentWidget(this._contentWidget):(this._contentWidget=new CodeLensContentWidget(this._editor,this._viewZone.afterLineNumber+1),this._editor.addContentWidget(this._contentWidget))}dispose(t,e){this._decorationIds.forEach(t.removeDecoration,t),this._decorationIds=[],null==e||e.removeZone(this._viewZoneId),this._contentWidget&&(this._editor.removeContentWidget(this._contentWidget),this._contentWidget=void 0),this._isDisposed=!0}isDisposed(){return this._isDisposed}isValid(){return this._decorationIds.some(((t,e)=>{const o=this._editor.getModel().getDecorationRange(t),i=this._data[e].symbol;return!(!o||Range.isEmpty(i.range)!==o.isEmpty())}))}updateCodeLensSymbols(t,e){this._decorationIds.forEach(e.removeDecoration,e),this._decorationIds=[],this._data=t,this._data.forEach(((t,o)=>{e.addDecoration({range:t.symbol.range,options:codeLensDecorationOptions},(t=>this._decorationIds[o]=t))}))}updateHeight(t,e){this._viewZone.heightInPx=t,e.layoutZone(this._viewZoneId),this._contentWidget&&this._editor.layoutContentWidget(this._contentWidget)}computeIfNecessary(t){if(!this._viewZone.isVisible())return null;for(let e=0;e<this._decorationIds.length;e++){const o=t.getDecorationRange(this._decorationIds[e]);o&&(this._data[e].symbol.range=o)}return this._data}updateCommands(t){this._createContentWidgetIfNecessary(),this._contentWidget.withCommands(t,!0);for(let e=0;e<this._data.length;e++){const o=t[e];if(o){const{symbol:t}=this._data[e];t.command=o.command||t.command}}}getCommand(t){var e;return null===(e=this._contentWidget)||void 0===e?void 0:e.getCommand(t)}getLineNumber(){const t=this._editor.getModel().getDecorationRange(this._decorationIds[0]);return t?t.startLineNumber:-1}update(t){if(this.isValid()){const e=this._editor.getModel().getDecorationRange(this._decorationIds[0]);e&&(this._viewZone.afterLineNumber=e.startLineNumber-1,t.layoutZone(this._viewZoneId),this._contentWidget&&(this._contentWidget.updatePosition(e.startLineNumber),this._editor.layoutContentWidget(this._contentWidget)))}}}