var __decorate=this&&this.__decorate||function(e,t,o,s){var i,n=arguments.length,r=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(r=(n<3?i(r):n>3?i(t,o,r):i(t,o))||r);return n>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,s){t(o,s,e)}};import*as dom from"../../../../base/browser/dom.js";import*as aria from"../../../../base/browser/ui/aria/aria.js";import{DomScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{Codicon}from"../../../../base/common/codicons.js";import{Event}from"../../../../base/common/event.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{escapeRegExpCharacters}from"../../../../base/common/strings.js";import{assertIsDefined}from"../../../../base/common/types.js";import"./parameterHints.css";import{ILanguageService}from"../../../common/languages/language.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{Context}from"./provideSignatureHelp.js";import*as nls from"../../../../nls.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{listHighlightForeground,registerColor}from"../../../../platform/theme/common/colorRegistry.js";import{registerIcon}from"../../../../platform/theme/common/iconRegistry.js";import{ThemeIcon}from"../../../../base/common/themables.js";const $=dom.$,parameterHintsNextIcon=registerIcon("parameter-hints-next",Codicon.chevronDown,nls.localize("parameterHintsNextIcon","Icon for show next parameter hint.")),parameterHintsPreviousIcon=registerIcon("parameter-hints-previous",Codicon.chevronUp,nls.localize("parameterHintsPreviousIcon","Icon for show previous parameter hint."));let ParameterHintsWidget=class e extends Disposable{constructor(e,t,o,s,i){super(),this.editor=e,this.model=t,this.renderDisposeables=this._register(new DisposableStore),this.visible=!1,this.announcedLabel=null,this.allowEditorOverflow=!0,this.markdownRenderer=this._register(new MarkdownRenderer({editor:e},i,s)),this.keyVisible=Context.Visible.bindTo(o),this.keyMultipleSignatures=Context.MultipleSignatures.bindTo(o)}createParameterHintDOMNodes(){const e=$(".editor-widget.parameter-hints-widget"),t=dom.append(e,$(".phwrapper"));t.tabIndex=-1;const o=dom.append(t,$(".controls")),s=dom.append(o,$(".button"+ThemeIcon.asCSSSelector(parameterHintsPreviousIcon))),i=dom.append(o,$(".overloads")),n=dom.append(o,$(".button"+ThemeIcon.asCSSSelector(parameterHintsNextIcon)));this._register(dom.addDisposableListener(s,"click",(e=>{dom.EventHelper.stop(e),this.previous()}))),this._register(dom.addDisposableListener(n,"click",(e=>{dom.EventHelper.stop(e),this.next()})));const r=$(".body"),a=new DomScrollableElement(r,{alwaysConsumeMouseWheel:!0});this._register(a),t.appendChild(a.getDomNode());const d=dom.append(r,$(".signature")),l=dom.append(r,$(".docs"));e.style.userSelect="text",this.domNodes={element:e,signature:d,overloads:i,docs:l,scrollbar:a},this.editor.addContentWidget(this),this.hide(),this._register(this.editor.onDidChangeCursorSelection((e=>{this.visible&&this.editor.layoutContentWidget(this)})));const m=()=>{if(!this.domNodes)return;const e=this.editor.getOption(47);this.domNodes.element.style.fontSize=`${e.fontSize}px`,this.domNodes.element.style.lineHeight=""+e.lineHeight/e.fontSize};m(),this._register(Event.chain(this.editor.onDidChangeConfiguration.bind(this.editor)).filter((e=>e.hasChanged(47))).on(m,null)),this._register(this.editor.onDidLayoutChange((e=>this.updateMaxHeight()))),this.updateMaxHeight()}show(){this.visible||(this.domNodes||this.createParameterHintDOMNodes(),this.keyVisible.set(!0),this.visible=!0,setTimeout((()=>{var e;null===(e=this.domNodes)||void 0===e||e.element.classList.add("visible")}),100),this.editor.layoutContentWidget(this))}hide(){var e;this.renderDisposeables.clear(),this.visible&&(this.keyVisible.reset(),this.visible=!1,this.announcedLabel=null,null===(e=this.domNodes)||void 0===e||e.element.classList.remove("visible"),this.editor.layoutContentWidget(this))}getPosition(){return this.visible?{position:this.editor.getPosition(),preference:[1,2]}:null}render(e){var t;if(this.renderDisposeables.clear(),!this.domNodes)return;const o=e.signatures.length>1;this.domNodes.element.classList.toggle("multiple",o),this.keyMultipleSignatures.set(o),this.domNodes.signature.innerText="",this.domNodes.docs.innerText="";const s=e.signatures[e.activeSignature];if(!s)return;const i=dom.append(this.domNodes.signature,$(".code")),n=this.editor.getOption(47);i.style.fontSize=`${n.fontSize}px`,i.style.fontFamily=n.fontFamily;const r=s.parameters.length>0,a=null!==(t=s.activeParameter)&&void 0!==t?t:e.activeParameter;r?this.renderParameters(i,s,a):dom.append(i,$("span")).textContent=s.label;const d=s.parameters[a];if(null==d?void 0:d.documentation){const e=$("span.documentation");if("string"==typeof d.documentation)e.textContent=d.documentation;else{const t=this.renderMarkdownDocs(d.documentation);e.appendChild(t.element)}dom.append(this.domNodes.docs,$("p",{},e))}if(void 0===s.documentation);else if("string"==typeof s.documentation)dom.append(this.domNodes.docs,$("p",{},s.documentation));else{const e=this.renderMarkdownDocs(s.documentation);dom.append(this.domNodes.docs,e.element)}const l=this.hasDocs(s,d);if(this.domNodes.signature.classList.toggle("has-docs",l),this.domNodes.docs.classList.toggle("empty",!l),this.domNodes.overloads.textContent=String(e.activeSignature+1).padStart(e.signatures.length.toString().length,"0")+"/"+e.signatures.length,d){let e="";const t=s.parameters[a];e=Array.isArray(t.label)?s.label.substring(t.label[0],t.label[1]):t.label,t.documentation&&(e+="string"==typeof t.documentation?`, ${t.documentation}`:`, ${t.documentation.value}`),s.documentation&&(e+="string"==typeof s.documentation?`, ${s.documentation}`:`, ${s.documentation.value}`),this.announcedLabel!==e&&(aria.alert(nls.localize("hint","{0}, hint",e)),this.announcedLabel=e)}this.editor.layoutContentWidget(this),this.domNodes.scrollbar.scanDomNode()}renderMarkdownDocs(e){const t=this.renderDisposeables.add(this.markdownRenderer.render(e,{asyncRenderCallback:()=>{var e;null===(e=this.domNodes)||void 0===e||e.scrollbar.scanDomNode()}}));return t.element.classList.add("markdown-docs"),t}hasDocs(e,t){return!!(t&&"string"==typeof t.documentation&&assertIsDefined(t.documentation).length>0||t&&"object"==typeof t.documentation&&assertIsDefined(t.documentation).value.length>0||e.documentation&&"string"==typeof e.documentation&&assertIsDefined(e.documentation).length>0||e.documentation&&"object"==typeof e.documentation&&assertIsDefined(e.documentation.value).length>0)}renderParameters(e,t,o){const[s,i]=this.getParameterLabelOffsets(t,o),n=document.createElement("span");n.textContent=t.label.substring(0,s);const r=document.createElement("span");r.textContent=t.label.substring(s,i),r.className="parameter active";const a=document.createElement("span");a.textContent=t.label.substring(i),dom.append(e,n,r,a)}getParameterLabelOffsets(e,t){const o=e.parameters[t];if(o){if(Array.isArray(o.label))return o.label;if(o.label.length){const t=new RegExp(`(\\W|^)${escapeRegExpCharacters(o.label)}(?=\\W|$)`,"g");t.test(e.label);const s=t.lastIndex-o.label.length;return s>=0?[s,t.lastIndex]:[0,0]}return[0,0]}return[0,0]}next(){this.editor.focus(),this.model.next()}previous(){this.editor.focus(),this.model.previous()}getDomNode(){return this.domNodes||this.createParameterHintDOMNodes(),this.domNodes.element}getId(){return e.ID}updateMaxHeight(){if(!this.domNodes)return;const e=`${Math.max(this.editor.getLayoutInfo().height/4,250)}px`;this.domNodes.element.style.maxHeight=e;const t=this.domNodes.element.getElementsByClassName("phwrapper");t.length&&(t[0].style.maxHeight=e)}};ParameterHintsWidget.ID="editor.widget.parameterHintsWidget",ParameterHintsWidget=__decorate([__param(2,IContextKeyService),__param(3,IOpenerService),__param(4,ILanguageService)],ParameterHintsWidget);export{ParameterHintsWidget};registerColor("editorHoverWidget.highlightForeground",{dark:listHighlightForeground,light:listHighlightForeground,hcDark:listHighlightForeground,hcLight:listHighlightForeground},nls.localize("editorHoverWidgetHighlightForeground","Foreground color of the active item in the parameter hint."));