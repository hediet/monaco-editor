var __decorate=this&&this.__decorate||function(e,t,o,i){var r,n=arguments.length,s=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n<3?r(s):n>3?r(t,o,s):r(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function s(e){try{d(i.next(e))}catch(e){n(e)}}function a(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}d((i=i.apply(e,t||[])).next())}))};import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{KeyChord}from"../../../../base/common/keyCodes.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{CharacterSet}from"../../../common/core/characterClassifier.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{alertFormattingEdits,formatDocumentRangesWithSelectedProvider,formatDocumentWithSelectedProvider,getOnTypeFormattingEdits}from"./format.js";import{FormattingEdit}from"./formattingEdit.js";import*as nls from"../../../../nls.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IEditorProgressService,Progress}from"../../../../platform/progress/common/progress.js";let FormatOnType=class{constructor(e,t,o){this._editor=e,this._languageFeaturesService=t,this._workerService=o,this._disposables=new DisposableStore,this._sessionDisposables=new DisposableStore,this._disposables.add(t.onTypeFormattingEditProvider.onDidChange(this._update,this)),this._disposables.add(e.onDidChangeModel((()=>this._update()))),this._disposables.add(e.onDidChangeModelLanguage((()=>this._update()))),this._disposables.add(e.onDidChangeConfiguration((e=>{e.hasChanged(53)&&this._update()})))}dispose(){this._disposables.dispose(),this._sessionDisposables.dispose()}_update(){if(this._sessionDisposables.clear(),!this._editor.getOption(53))return;if(!this._editor.hasModel())return;const e=this._editor.getModel(),[t]=this._languageFeaturesService.onTypeFormattingEditProvider.ordered(e);if(!t||!t.autoFormatTriggerCharacters)return;const o=new CharacterSet;for(const e of t.autoFormatTriggerCharacters)o.add(e.charCodeAt(0));this._sessionDisposables.add(this._editor.onDidType((e=>{const t=e.charCodeAt(e.length-1);o.has(t)&&this._trigger(String.fromCharCode(t))})))}_trigger(e){if(!this._editor.hasModel())return;if(this._editor.getSelections().length>1||!this._editor.getSelection().isEmpty())return;const t=this._editor.getModel(),o=this._editor.getPosition(),i=new CancellationTokenSource,r=this._editor.onDidChangeModelContent((e=>{if(e.isFlush)return i.cancel(),void r.dispose();for(let t=0,n=e.changes.length;t<n;t++)if(e.changes[t].range.endLineNumber<=o.lineNumber)return i.cancel(),void r.dispose()}));getOnTypeFormattingEdits(this._workerService,this._languageFeaturesService,t,o,e,t.getFormattingOptions(),i.token).then((e=>{i.token.isCancellationRequested||isNonEmptyArray(e)&&(FormattingEdit.execute(this._editor,e,!0),alertFormattingEdits(e))})).finally((()=>{r.dispose()}))}};FormatOnType.ID="editor.contrib.autoFormat",FormatOnType=__decorate([__param(1,ILanguageFeaturesService),__param(2,IEditorWorkerService)],FormatOnType);let FormatOnPaste=class{constructor(e,t,o){this.editor=e,this._languageFeaturesService=t,this._instantiationService=o,this._callOnDispose=new DisposableStore,this._callOnModel=new DisposableStore,this._callOnDispose.add(e.onDidChangeConfiguration((()=>this._update()))),this._callOnDispose.add(e.onDidChangeModel((()=>this._update()))),this._callOnDispose.add(e.onDidChangeModelLanguage((()=>this._update()))),this._callOnDispose.add(t.documentRangeFormattingEditProvider.onDidChange(this._update,this))}dispose(){this._callOnDispose.dispose(),this._callOnModel.dispose()}_update(){this._callOnModel.clear(),this.editor.getOption(52)&&this.editor.hasModel()&&this._languageFeaturesService.documentRangeFormattingEditProvider.has(this.editor.getModel())&&this._callOnModel.add(this.editor.onDidPaste((({range:e})=>this._trigger(e))))}_trigger(e){this.editor.hasModel()&&(this.editor.getSelections().length>1||this._instantiationService.invokeFunction(formatDocumentRangesWithSelectedProvider,this.editor,e,2,Progress.None,CancellationToken.None).catch(onUnexpectedError))}};FormatOnPaste.ID="editor.contrib.formatOnPaste",FormatOnPaste=__decorate([__param(1,ILanguageFeaturesService),__param(2,IInstantiationService)],FormatOnPaste);class FormatDocumentAction extends EditorAction{constructor(){super({id:"editor.action.formatDocument",label:nls.localize("formatDocument.label","Format Document"),alias:"Format Document",precondition:ContextKeyExpr.and(EditorContextKeys.notInCompositeEditor,EditorContextKeys.writable,EditorContextKeys.hasDocumentFormattingProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1572,linux:{primary:3111},weight:100},contextMenuOpts:{group:"1_modification",order:1.3}})}run(e,t){return __awaiter(this,void 0,void 0,(function*(){if(t.hasModel()){const o=e.get(IInstantiationService),i=e.get(IEditorProgressService);yield i.showWhile(o.invokeFunction(formatDocumentWithSelectedProvider,t,1,Progress.None,CancellationToken.None),250)}}))}}class FormatSelectionAction extends EditorAction{constructor(){super({id:"editor.action.formatSelection",label:nls.localize("formatSelection.label","Format Selection"),alias:"Format Selection",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasDocumentSelectionFormattingProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:KeyChord(2089,2084),weight:100},contextMenuOpts:{when:EditorContextKeys.hasNonEmptySelection,group:"1_modification",order:1.31}})}run(e,t){return __awaiter(this,void 0,void 0,(function*(){if(!t.hasModel())return;const o=e.get(IInstantiationService),i=t.getModel(),r=t.getSelections().map((e=>e.isEmpty()?new Range(e.startLineNumber,1,e.startLineNumber,i.getLineMaxColumn(e.startLineNumber)):e)),n=e.get(IEditorProgressService);yield n.showWhile(o.invokeFunction(formatDocumentRangesWithSelectedProvider,t,r,1,Progress.None,CancellationToken.None),250)}))}}registerEditorContribution(FormatOnType.ID,FormatOnType,2),registerEditorContribution(FormatOnPaste.ID,FormatOnPaste,2),registerEditorAction(FormatDocumentAction),registerEditorAction(FormatSelectionAction),CommandsRegistry.registerCommand("editor.action.format",(e=>__awaiter(void 0,void 0,void 0,(function*(){const t=e.get(ICodeEditorService).getFocusedCodeEditor();if(!t||!t.hasModel())return;const o=e.get(ICommandService);t.getSelection().isEmpty()?yield o.executeCommand("editor.action.formatDocument"):yield o.executeCommand("editor.action.formatSelection")}))));