var __awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function a(e){try{d(n.next(e))}catch(e){i(e)}}function s(e){try{d(n.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}d((n=n.apply(e,t||[])).next())}))};import{alert}from"../../../../base/browser/ui/aria/aria.js";import{asArray,isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Iterable}from"../../../../base/common/iterator.js";import{LinkedList}from"../../../../base/common/linkedList.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource,TextModelCancellationTokenSource}from"../../editorState/browser/editorState.js";import{isCodeEditor}from"../../../browser/editorBrowser.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{FormattingEdit}from"./formattingEdit.js";import*as nls from"../../../../nls.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ExtensionIdentifier}from"../../../../platform/extensions/common/extensions.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ILogService}from"../../../../platform/log/common/log.js";export function alertFormattingEdits(e){if(!(e=e.filter((e=>e.range))).length)return;let{range:t}=e[0];for(let o=1;o<e.length;o++)t=Range.plusRange(t,e[o].range);const{startLineNumber:o,endLineNumber:n}=t;o===n?1===e.length?alert(nls.localize("hint11","Made 1 formatting edit on line {0}",o)):alert(nls.localize("hintn1","Made {0} formatting edits on line {1}",e.length,o)):1===e.length?alert(nls.localize("hint1n","Made 1 formatting edit between lines {0} and {1}",o,n)):alert(nls.localize("hintnn","Made {0} formatting edits between lines {1} and {2}",e.length,o,n))}export function getRealAndSyntheticDocumentFormattersOrdered(e,t,o){const n=[],r=new Set,i=e.ordered(o);for(const e of i)n.push(e),e.extensionId&&r.add(ExtensionIdentifier.toKey(e.extensionId));const a=t.ordered(o);for(const e of a){if(e.extensionId){if(r.has(ExtensionIdentifier.toKey(e.extensionId)))continue;r.add(ExtensionIdentifier.toKey(e.extensionId))}n.push({displayName:e.displayName,extensionId:e.extensionId,provideDocumentFormattingEdits:(t,o,n)=>e.provideDocumentRangeFormattingEdits(t,t.getFullModelRange(),o,n)})}return n}class FormattingConflicts{static setFormatterSelector(e){return{dispose:FormattingConflicts._selectors.unshift(e)}}static select(e,t,o){return __awaiter(this,void 0,void 0,(function*(){if(0===e.length)return;const n=Iterable.first(FormattingConflicts._selectors);return n?yield n(e,t,o):void 0}))}}FormattingConflicts._selectors=new LinkedList;export{FormattingConflicts};export function formatDocumentRangesWithSelectedProvider(e,t,o,n,r,i){return __awaiter(this,void 0,void 0,(function*(){const a=e.get(IInstantiationService),{documentRangeFormattingEditProvider:s}=e.get(ILanguageFeaturesService),d=isCodeEditor(t)?t.getModel():t,c=s.ordered(d),m=yield FormattingConflicts.select(c,d,n);m&&(r.report(m),yield a.invokeFunction(formatDocumentRangesWithProvider,m,t,o,i))}))}export function formatDocumentRangesWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService),a=e.get(ILogService);let s,d;isCodeEditor(o)?(s=o.getModel(),d=new EditorStateCancellationTokenSource(o,5,void 0,r)):(s=o,d=new TextModelCancellationTokenSource(o,r));const c=[];let m=0;for(const e of asArray(n).sort(Range.compareRangesUsingStarts))m>0&&Range.areIntersectingOrTouching(c[m-1],e)?c[m-1]=Range.fromPositions(c[m-1].getStartPosition(),e.getEndPosition()):m=c.push(e);const l=e=>__awaiter(this,void 0,void 0,(function*(){var o,n;a.trace("[format][provideDocumentRangeFormattingEdits] (request)",null===(o=t.extensionId)||void 0===o?void 0:o.value,e);const r=(yield t.provideDocumentRangeFormattingEdits(s,e,s.getFormattingOptions(),d.token))||[];return a.trace("[format][provideDocumentRangeFormattingEdits] (response)",null===(n=t.extensionId)||void 0===n?void 0:n.value,r),r})),u=(e,t)=>{if(!e.length||!t.length)return!1;const o=e.reduce(((e,t)=>Range.plusRange(e,t.range)),e[0].range);if(!t.some((e=>Range.intersectRanges(o,e.range))))return!1;for(const o of e)for(const e of t)if(Range.intersectRanges(o.range,e.range))return!0;return!1},g=[],f=[];try{for(const e of c){if(d.token.isCancellationRequested)return!0;f.push(yield l(e))}for(let e=0;e<c.length;++e)for(let t=e+1;t<c.length;++t){if(d.token.isCancellationRequested)return!0;if(u(f[e],f[t])){const o=Range.plusRange(c[e],c[t]),n=yield l(o);c.splice(t,1),c.splice(e,1),c.push(o),f.splice(t,1),f.splice(e,1),f.push(n),e=0,t=0}}for(const e of f){if(d.token.isCancellationRequested)return!0;const t=yield i.computeMoreMinimalEdits(s.uri,e);t&&g.push(...t)}}finally{d.dispose()}if(0===g.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,g,!0),alertFormattingEdits(g),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1);else{const[{range:e}]=g,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);s.pushEditOperations([t],g.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function formatDocumentWithSelectedProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IInstantiationService),a=e.get(ILanguageFeaturesService),s=isCodeEditor(t)?t.getModel():t,d=getRealAndSyntheticDocumentFormattersOrdered(a.documentFormattingEditProvider,a.documentRangeFormattingEditProvider,s),c=yield FormattingConflicts.select(d,s,o);c&&(n.report(c),yield i.invokeFunction(formatDocumentWithProvider,c,t,o,r))}))}export function formatDocumentWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService);let a,s,d;isCodeEditor(o)?(a=o.getModel(),s=new EditorStateCancellationTokenSource(o,5,void 0,r)):(a=o,s=new TextModelCancellationTokenSource(o,r));try{const e=yield t.provideDocumentFormattingEdits(a,a.getFormattingOptions(),s.token);if(d=yield i.computeMoreMinimalEdits(a.uri,e),s.token.isCancellationRequested)return!0}finally{s.dispose()}if(!d||0===d.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,d,2!==n),2!==n&&(alertFormattingEdits(d),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1));else{const[{range:e}]=d,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);a.pushEditOperations([t],d.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function getDocumentRangeFormattingEditsUntilResult(e,t,o,n,r,i){return __awaiter(this,void 0,void 0,(function*(){const a=t.documentRangeFormattingEditProvider.ordered(o);for(const t of a){const a=yield Promise.resolve(t.provideDocumentRangeFormattingEdits(o,n,r,i)).catch(onUnexpectedExternalError);if(isNonEmptyArray(a))return yield e.computeMoreMinimalEdits(o.uri,a)}}))}export function getDocumentFormattingEditsUntilResult(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=getRealAndSyntheticDocumentFormattersOrdered(t.documentFormattingEditProvider,t.documentRangeFormattingEditProvider,o);for(const t of i){const i=yield Promise.resolve(t.provideDocumentFormattingEdits(o,n,r)).catch(onUnexpectedExternalError);if(isNonEmptyArray(i))return yield e.computeMoreMinimalEdits(o.uri,i)}}))}export function getOnTypeFormattingEdits(e,t,o,n,r,i,a){const s=t.onTypeFormattingEditProvider.ordered(o);return 0===s.length||s[0].autoFormatTriggerCharacters.indexOf(r)<0?Promise.resolve(void 0):Promise.resolve(s[0].provideOnTypeFormattingEdits(o,n,r,i,a)).catch(onUnexpectedExternalError).then((t=>e.computeMoreMinimalEdits(o.uri,t)))}CommandsRegistry.registerCommand("_executeFormatRangeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r]=t;assertType(URI.isUri(o)),assertType(Range.isIRange(n));const i=e.get(ITextModelService),a=e.get(IEditorWorkerService),s=e.get(ILanguageFeaturesService),d=yield i.createModelReference(o);try{return getDocumentRangeFormattingEditsUntilResult(a,s,d.object.textEditorModel,Range.lift(n),r,CancellationToken.None)}finally{d.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatDocumentProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n]=t;assertType(URI.isUri(o));const r=e.get(ITextModelService),i=e.get(IEditorWorkerService),a=e.get(ILanguageFeaturesService),s=yield r.createModelReference(o);try{return getDocumentFormattingEditsUntilResult(i,a,s.object.textEditorModel,n,CancellationToken.None)}finally{s.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatOnTypeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r,i]=t;assertType(URI.isUri(o)),assertType(Position.isIPosition(n)),assertType("string"==typeof r);const a=e.get(ITextModelService),s=e.get(IEditorWorkerService),d=e.get(ILanguageFeaturesService),c=yield a.createModelReference(o);try{return getOnTypeFormattingEdits(s,d,c.object.textEditorModel,Position.lift(n),r,i,CancellationToken.None)}finally{c.dispose()}}))}));