class Scanner{constructor(){this.value="",this.pos=0}static isDigitCharacter(e){return e>=48&&e<=57}static isVariableCharacter(e){return 95===e||e>=97&&e<=122||e>=65&&e<=90}text(e){this.value=e,this.pos=0}tokenText(e){return this.value.substr(e.pos,e.len)}next(){if(this.pos>=this.value.length)return{type:14,pos:this.pos,len:0};const e=this.pos;let t,r=0,n=this.value.charCodeAt(e);if(t=Scanner._table[n],"number"==typeof t)return this.pos+=1,{type:t,pos:e,len:1};if(Scanner.isDigitCharacter(n)){t=8;do{r+=1,n=this.value.charCodeAt(e+r)}while(Scanner.isDigitCharacter(n));return this.pos+=r,{type:t,pos:e,len:r}}if(Scanner.isVariableCharacter(n)){t=9;do{n=this.value.charCodeAt(e+ ++r)}while(Scanner.isVariableCharacter(n)||Scanner.isDigitCharacter(n));return this.pos+=r,{type:t,pos:e,len:r}}t=10;do{r+=1,n=this.value.charCodeAt(e+r)}while(!isNaN(n)&&void 0===Scanner._table[n]&&!Scanner.isDigitCharacter(n)&&!Scanner.isVariableCharacter(n));return this.pos+=r,{type:t,pos:e,len:r}}}Scanner._table={36:0,58:1,44:2,123:3,125:4,92:5,47:6,124:7,43:11,45:12,63:13};export{Scanner};export class Marker{constructor(){this._children=[]}appendChild(e){return e instanceof Text&&this._children[this._children.length-1]instanceof Text?this._children[this._children.length-1].value+=e.value:(e.parent=this,this._children.push(e)),this}replace(e,t){const{parent:r}=e,n=r.children.indexOf(e),s=r.children.slice(0);s.splice(n,1,...t),r._children=s,function e(t,r){for(const n of t)n.parent=r,e(n.children,n)}(t,r)}get children(){return this._children}get rightMostDescendant(){return this._children.length>0?this._children[this._children.length-1].rightMostDescendant:this}get snippet(){let e=this;for(;;){if(!e)return;if(e instanceof TextmateSnippet)return e;e=e.parent}}toString(){return this.children.reduce(((e,t)=>e+t.toString()),"")}len(){return 0}}export class Text extends Marker{constructor(e){super(),this.value=e}toString(){return this.value}len(){return this.value.length}clone(){return new Text(this.value)}}export class TransformableMarker extends Marker{}export class Placeholder extends TransformableMarker{static compareByIndex(e,t){return e.index===t.index?0:e.isFinalTabstop?1:t.isFinalTabstop||e.index<t.index?-1:e.index>t.index?1:0}constructor(e){super(),this.index=e}get isFinalTabstop(){return 0===this.index}get choice(){return 1===this._children.length&&this._children[0]instanceof Choice?this._children[0]:void 0}clone(){const e=new Placeholder(this.index);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map((e=>e.clone())),e}}export class Choice extends Marker{constructor(){super(...arguments),this.options=[]}appendChild(e){return e instanceof Text&&(e.parent=this,this.options.push(e)),this}toString(){return this.options[0].value}len(){return this.options[0].len()}clone(){const e=new Choice;return this.options.forEach(e.appendChild,e),e}}export class Transform extends Marker{constructor(){super(...arguments),this.regexp=new RegExp("")}resolve(e){const t=this;let r=!1,n=e.replace(this.regexp,(function(){return r=!0,t._replace(Array.prototype.slice.call(arguments,0,-2))}));return!r&&this._children.some((e=>e instanceof FormatString&&Boolean(e.elseValue)))&&(n=this._replace([])),n}_replace(e){let t="";for(const r of this._children)if(r instanceof FormatString){let n=e[r.index]||"";n=r.resolve(n),t+=n}else t+=r.toString();return t}toString(){return""}clone(){const e=new Transform;return e.regexp=new RegExp(this.regexp.source,(this.regexp.ignoreCase?"i":"")+(this.regexp.global?"g":"")),e._children=this.children.map((e=>e.clone())),e}}export class FormatString extends Marker{constructor(e,t,r,n){super(),this.index=e,this.shorthandName=t,this.ifValue=r,this.elseValue=n}resolve(e){return"upcase"===this.shorthandName?e?e.toLocaleUpperCase():"":"downcase"===this.shorthandName?e?e.toLocaleLowerCase():"":"capitalize"===this.shorthandName?e?e[0].toLocaleUpperCase()+e.substr(1):"":"pascalcase"===this.shorthandName?e?this._toPascalCase(e):"":"camelcase"===this.shorthandName?e?this._toCamelCase(e):"":Boolean(e)&&"string"==typeof this.ifValue?this.ifValue:Boolean(e)||"string"!=typeof this.elseValue?e||"":this.elseValue}_toPascalCase(e){const t=e.match(/[a-z0-9]+/gi);return t?t.map((e=>e.charAt(0).toUpperCase()+e.substr(1))).join(""):e}_toCamelCase(e){const t=e.match(/[a-z0-9]+/gi);return t?t.map(((e,t)=>0===t?e.charAt(0).toLowerCase()+e.substr(1):e.charAt(0).toUpperCase()+e.substr(1))).join(""):e}clone(){return new FormatString(this.index,this.shorthandName,this.ifValue,this.elseValue)}}export class Variable extends TransformableMarker{constructor(e){super(),this.name=e}resolve(e){let t=e.resolve(this);return this.transform&&(t=this.transform.resolve(t||"")),void 0!==t&&(this._children=[new Text(t)],!0)}clone(){const e=new Variable(this.name);return this.transform&&(e.transform=this.transform.clone()),e._children=this.children.map((e=>e.clone())),e}}function walk(e,t){const r=[...e];for(;r.length>0;){const e=r.shift();if(!t(e))break;r.unshift(...e.children)}}export class TextmateSnippet extends Marker{get placeholderInfo(){if(!this._placeholders){const e=[];let t;this.walk((function(r){return r instanceof Placeholder&&(e.push(r),t=!t||t.index<r.index?r:t),!0})),this._placeholders={all:e,last:t}}return this._placeholders}get placeholders(){const{all:e}=this.placeholderInfo;return e}offset(e){let t=0,r=!1;return this.walk((n=>n===e?(r=!0,!1):(t+=n.len(),!0))),r?t:-1}fullLen(e){let t=0;return walk([e],(e=>(t+=e.len(),!0))),t}enclosingPlaceholders(e){const t=[];let{parent:r}=e;for(;r;)r instanceof Placeholder&&t.push(r),r=r.parent;return t}resolveVariables(e){return this.walk((t=>(t instanceof Variable&&t.resolve(e)&&(this._placeholders=void 0),!0))),this}appendChild(e){return this._placeholders=void 0,super.appendChild(e)}replace(e,t){return this._placeholders=void 0,super.replace(e,t)}clone(){const e=new TextmateSnippet;return this._children=this.children.map((e=>e.clone())),e}walk(e){walk(this.children,e)}}export class SnippetParser{constructor(){this._scanner=new Scanner,this._token={type:14,pos:0,len:0}}static escape(e){return e.replace(/\$|}|\\/g,"\\$&")}static guessNeedsClipboard(e){return/\${?CLIPBOARD/.test(e)}parse(e,t,r){const n=new TextmateSnippet;return this.parseFragment(e,n),this.ensureFinalTabstop(n,null!=r&&r,null!=t&&t),n}parseFragment(e,t){const r=t.children.length;for(this._scanner.text(e),this._token=this._scanner.next();this._parse(t););const n=new Map,s=[];t.walk((e=>(e instanceof Placeholder&&(e.isFinalTabstop?n.set(0,void 0):!n.has(e.index)&&e.children.length>0?n.set(e.index,e.children):s.push(e)),!0)));const i=(e,r)=>{const s=n.get(e.index);if(!s)return;const a=new Placeholder(e.index);a.transform=e.transform;for(const e of s){const t=e.clone();a.appendChild(t),t instanceof Placeholder&&n.has(t.index)&&!r.has(t.index)&&(r.add(t.index),i(t,r),r.delete(t.index))}t.replace(e,[a])},a=new Set;for(const e of s)i(e,a);return t.children.slice(r)}ensureFinalTabstop(e,t,r){(t||r&&e.placeholders.length>0)&&(e.placeholders.find((e=>0===e.index))||e.appendChild(new Placeholder(0)))}_accept(e,t){if(void 0===e||this._token.type===e){const e=!t||this._scanner.tokenText(this._token);return this._token=this._scanner.next(),e}return!1}_backTo(e){return this._scanner.pos=e.pos+e.len,this._token=e,!1}_until(e){const t=this._token;for(;this._token.type!==e;){if(14===this._token.type)return!1;if(5===this._token.type){const e=this._scanner.next();if(0!==e.type&&4!==e.type&&5!==e.type)return!1}this._token=this._scanner.next()}const r=this._scanner.value.substring(t.pos,this._token.pos).replace(/\\(\$|}|\\)/g,"$1");return this._token=this._scanner.next(),r}_parse(e){return this._parseEscaped(e)||this._parseTabstopOrVariableName(e)||this._parseComplexPlaceholder(e)||this._parseComplexVariable(e)||this._parseAnything(e)}_parseEscaped(e){let t;return!!(t=this._accept(5,!0))&&(t=this._accept(0,!0)||this._accept(4,!0)||this._accept(5,!0)||t,e.appendChild(new Text(t)),!0)}_parseTabstopOrVariableName(e){let t;const r=this._token;return this._accept(0)&&(t=this._accept(9,!0)||this._accept(8,!0))?(e.appendChild(/^\d+$/.test(t)?new Placeholder(Number(t)):new Variable(t)),!0):this._backTo(r)}_parseComplexPlaceholder(e){let t;const r=this._token;if(!(this._accept(0)&&this._accept(3)&&(t=this._accept(8,!0))))return this._backTo(r);const n=new Placeholder(Number(t));if(this._accept(1))for(;;){if(this._accept(4))return e.appendChild(n),!0;if(!this._parse(n))return e.appendChild(new Text("${"+t+":")),n.children.forEach(e.appendChild,e),!0}else{if(!(n.index>0&&this._accept(7)))return this._accept(6)?this._parseTransform(n)?(e.appendChild(n),!0):(this._backTo(r),!1):this._accept(4)?(e.appendChild(n),!0):this._backTo(r);{const t=new Choice;for(;;){if(this._parseChoiceElement(t)){if(this._accept(2))continue;if(this._accept(7)&&(n.appendChild(t),this._accept(4)))return e.appendChild(n),!0}return this._backTo(r),!1}}}}_parseChoiceElement(e){const t=this._token,r=[];for(;2!==this._token.type&&7!==this._token.type;){let e;if(e=(e=this._accept(5,!0))?this._accept(2,!0)||this._accept(7,!0)||this._accept(5,!0)||e:this._accept(void 0,!0),!e)return this._backTo(t),!1;r.push(e)}return 0===r.length?(this._backTo(t),!1):(e.appendChild(new Text(r.join(""))),!0)}_parseComplexVariable(e){let t;const r=this._token;if(!(this._accept(0)&&this._accept(3)&&(t=this._accept(9,!0))))return this._backTo(r);const n=new Variable(t);if(!this._accept(1))return this._accept(6)?this._parseTransform(n)?(e.appendChild(n),!0):(this._backTo(r),!1):this._accept(4)?(e.appendChild(n),!0):this._backTo(r);for(;;){if(this._accept(4))return e.appendChild(n),!0;if(!this._parse(n))return e.appendChild(new Text("${"+t+":")),n.children.forEach(e.appendChild,e),!0}}_parseTransform(e){const t=new Transform;let r="",n="";for(;!this._accept(6);){let e;if(e=this._accept(5,!0))e=this._accept(6,!0)||e,r+=e;else{if(14===this._token.type)return!1;r+=this._accept(void 0,!0)}}for(;!this._accept(6);){let e;if(e=this._accept(5,!0))e=this._accept(5,!0)||this._accept(6,!0)||e,t.appendChild(new Text(e));else if(!this._parseFormatString(t)&&!this._parseAnything(t))return!1}for(;!this._accept(4);){if(14===this._token.type)return!1;n+=this._accept(void 0,!0)}try{t.regexp=new RegExp(r,n)}catch(e){return!1}return e.transform=t,!0}_parseFormatString(e){const t=this._token;if(!this._accept(0))return!1;let r=!1;this._accept(3)&&(r=!0);const n=this._accept(8,!0);if(!n)return this._backTo(t),!1;if(!r)return e.appendChild(new FormatString(Number(n))),!0;if(this._accept(4))return e.appendChild(new FormatString(Number(n))),!0;if(!this._accept(1))return this._backTo(t),!1;if(this._accept(6)){const r=this._accept(9,!0);return r&&this._accept(4)?(e.appendChild(new FormatString(Number(n),r)),!0):(this._backTo(t),!1)}if(this._accept(11)){const t=this._until(4);if(t)return e.appendChild(new FormatString(Number(n),void 0,t,void 0)),!0}else if(this._accept(12)){const t=this._until(4);if(t)return e.appendChild(new FormatString(Number(n),void 0,void 0,t)),!0}else if(this._accept(13)){const t=this._until(1);if(t){const r=this._until(4);if(r)return e.appendChild(new FormatString(Number(n),void 0,t,r)),!0}}else{const t=this._until(4);if(t)return e.appendChild(new FormatString(Number(n),void 0,void 0,t)),!0}return this._backTo(t),!1}_parseAnything(e){return 14!==this._token.type&&(e.appendChild(new Text(this._scanner.tokenText(this._token))),this._accept(void 0),!0)}}