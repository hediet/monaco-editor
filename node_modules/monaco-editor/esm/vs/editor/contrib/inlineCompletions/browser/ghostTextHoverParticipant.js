var __decorate=this&&this.__decorate||function(e,o,n,t){var i,r=arguments.length,l=r<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,n):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,o,n,t);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(l=(r<3?i(l):r>3?i(o,n,l):i(o,n))||l);return r>3&&l&&Object.defineProperty(o,n,l),l},__param=this&&this.__param||function(e,o){return function(n,t){o(n,t,e)}};import*as dom from"../../../../base/browser/dom.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{Range}from"../../../common/core/range.js";import{ILanguageService}from"../../../common/languages/language.js";import{HoverForeignElementAnchor}from"../../hover/browser/hoverTypes.js";import{GhostTextController}from"./ghostTextController.js";import{InlineSuggestionHintsContentWidget}from"./inlineSuggestionHintsWidget.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import*as nls from"../../../../nls.js";import{IAccessibilityService}from"../../../../platform/accessibility/common/accessibility.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";export class InlineCompletionsHover{constructor(e,o,n){this.owner=e,this.range=o,this.controller=n}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}requestExplicitContext(){var e,o,n;null===(n=null===(o=null===(e=this.controller.activeModel)||void 0===e?void 0:e.activeInlineCompletionsModel)||void 0===o?void 0:o.completionSession.value)||void 0===n||n.ensureUpdateWithExplicitContext()}getInlineCompletionsCount(){var e,o;const n=null===(o=null===(e=this.controller.activeModel)||void 0===e?void 0:e.activeInlineCompletionsModel)||void 0===o?void 0:o.completionSession.value;if(null==n?void 0:n.hasBeenTriggeredExplicitly)return null==n?void 0:n.getInlineCompletionsCountSync()}getInlineCompletionIndex(){var e,o,n;return null===(n=null===(o=null===(e=this.controller.activeModel)||void 0===e?void 0:e.activeInlineCompletionsModel)||void 0===o?void 0:o.completionSession.value)||void 0===n?void 0:n.currentlySelectedIndex}onDidChange(e){var o,n;return(null===(n=null===(o=this.controller.activeModel)||void 0===o?void 0:o.activeInlineCompletionsModel)||void 0===n?void 0:n.onDidChange(e))||Disposable.None}get commands(){var e,o,n;return(null===(n=null===(o=null===(e=this.controller.activeModel)||void 0===e?void 0:e.activeInlineCompletionsModel)||void 0===o?void 0:o.completionSession.value)||void 0===n?void 0:n.commands)||[]}}let InlineCompletionsHoverParticipant=class{constructor(e,o,n,t,i,r){this._editor=e,this._languageService=o,this._openerService=n,this.accessibilityService=t,this._instantiationService=i,this._telemetryService=r,this.hoverOrdinal=3}suggestHoverAnchor(e){const o=GhostTextController.get(this._editor);if(!o)return null;const n=e.target;if(8===n.type){const t=n.detail;if(o.shouldShowHoverAtViewZone(t.viewZoneId))return new HoverForeignElementAnchor(1e3,this,Range.fromPositions(this._editor.getModel().validatePosition(t.positionBefore||t.position)),e.event.posx,e.event.posy,!1)}return 7===n.type&&o.shouldShowHoverAt(n.range)||6===n.type&&n.detail.mightBeForeignElement&&o.shouldShowHoverAt(n.range)?new HoverForeignElementAnchor(1e3,this,n.range,e.event.posx,e.event.posy,!1):null}computeSync(e,o){if("always"===this._editor.getOption(59).showToolbar)return[];const n=GhostTextController.get(this._editor);return n&&n.shouldShowHoverAt(e.range)?[new InlineCompletionsHover(this,e.range,n)]:[]}renderHoverParts(e,o){const n=new DisposableStore,t=o[0];this._telemetryService.publicLog2("inlineCompletionHover.shown"),this.accessibilityService.isScreenReaderOptimized()&&this.renderScreenReaderText(e,t,n);const i=this._instantiationService.createInstance(InlineSuggestionHintsContentWidget,this._editor,!1);return e.fragment.appendChild(i.getDomNode()),i.update(null,t.getInlineCompletionIndex()||0,t.getInlineCompletionsCount(),t.commands),t.requestExplicitContext(),n.add(t.onDidChange((()=>{i.update(null,t.getInlineCompletionIndex()||0,t.getInlineCompletionsCount(),t.commands)}))),n}renderScreenReaderText(e,o,n){var t,i;const r=dom.$,l=r("div.hover-row.markdown-hover"),s=dom.append(l,r("div.hover-contents")),a=n.add(new MarkdownRenderer({editor:this._editor},this._languageService,this._openerService)),d=null===(i=null===(t=o.controller.activeModel)||void 0===t?void 0:t.inlineCompletionsModel)||void 0===i?void 0:i.ghostText;if(d){const o=this._editor.getModel().getLineContent(d.lineNumber);(o=>{n.add(a.onDidRenderAsync((()=>{s.className="hover-contents code-hover-contents",e.onContentsChanged()})));const t=nls.localize("inlineSuggestionFollows","Suggestion:"),i=n.add(a.render((new MarkdownString).appendText(t).appendCodeblock("text",o)));s.replaceChildren(i.element)})(d.renderForScreenReader(o))}e.fragment.appendChild(l)}};InlineCompletionsHoverParticipant=__decorate([__param(1,ILanguageService),__param(2,IOpenerService),__param(3,IAccessibilityService),__param(4,IInstantiationService),__param(5,ITelemetryService)],InlineCompletionsHoverParticipant);export{InlineCompletionsHoverParticipant};