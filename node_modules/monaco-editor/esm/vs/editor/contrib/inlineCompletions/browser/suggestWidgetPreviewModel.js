var __decorate=this&&this.__decorate||function(e,t,i,n){var o,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var l=e.length-1;l>=0;l--)(o=e[l])&&(s=(r<3?o(s):r>3?o(t,i,s):o(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{a(n.next(e))}catch(e){r(e)}}function l(e){try{a(n.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}a((n=n.apply(e,t||[])).next())}))};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{MutableDisposable,toDisposable}from"../../../../base/common/lifecycle.js";import{InlineCompletionTriggerKind}from"../../../common/languages.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{BaseGhostTextWidgetModel,GhostText}from"./ghostText.js";import{provideInlineCompletions,UpdateOperation}from"./inlineCompletionsModel.js";import{inlineCompletionToGhostText,minimizeInlineCompletion}from"./inlineCompletionToGhostText.js";import{SuggestWidgetInlineCompletionProvider}from"./suggestWidgetInlineCompletionProvider.js";let SuggestWidgetPreviewModel=class extends BaseGhostTextWidgetModel{get isActive(){return void 0!==this.suggestionInlineCompletionSource.state}constructor(e,t,i){super(e),this.cache=t,this.languageFeaturesService=i,this.suggestionInlineCompletionSource=this._register(new SuggestWidgetInlineCompletionProvider(this.editor,(()=>{var e,t,i;return null===(e=this.cache.value)||void 0===e||e.updateRanges(),null===(i=null===(t=this.cache.value)||void 0===t?void 0:t.completions[0])||void 0===i?void 0:i.toLiveInlineCompletion()}))),this.updateOperation=this._register(new MutableDisposable),this.updateCacheSoon=this._register(new RunOnceScheduler((()=>this.updateCache()),50)),this.minReservedLineCount=0,this._register(this.suggestionInlineCompletionSource.onDidChange((()=>{if(!this.editor.hasModel())return;this.updateCacheSoon.schedule(),this.suggestionInlineCompletionSource.state||(this.minReservedLineCount=0);const e=this.ghostText;e&&(this.minReservedLineCount=Math.max(this.minReservedLineCount,sum(e.parts.map((e=>e.lines.length-1))))),this.minReservedLineCount>=1?this.suggestionInlineCompletionSource.forceRenderingAbove():this.suggestionInlineCompletionSource.stopForceRenderingAbove(),this.onDidChangeEmitter.fire()}))),this._register(this.cache.onDidChange((()=>{this.onDidChangeEmitter.fire()}))),this._register(this.editor.onDidChangeCursorPosition((e=>{this.minReservedLineCount=0,this.updateCacheSoon.schedule(),this.onDidChangeEmitter.fire()}))),this._register(toDisposable((()=>this.suggestionInlineCompletionSource.stopForceRenderingAbove())))}isSuggestionPreviewEnabled(){return this.editor.getOption(112).preview}updateCache(){return __awaiter(this,void 0,void 0,(function*(){const e=this.suggestionInlineCompletionSource.state;if(!e||!e.selectedItem)return;const t={text:e.selectedItem.normalizedInlineCompletion.insertText,range:e.selectedItem.normalizedInlineCompletion.range,isSnippetText:e.selectedItem.isSnippetText,completionKind:e.selectedItem.completionItemKind},i=this.editor.getPosition();if(e.selectedItem.isSnippetText||27===e.selectedItem.completionItemKind||20===e.selectedItem.completionItemKind||23===e.selectedItem.completionItemKind)return void this.cache.clear();const n=createCancelablePromise((e=>__awaiter(this,void 0,void 0,(function*(){let n;try{n=yield provideInlineCompletions(this.languageFeaturesService.inlineCompletionsProvider,i,this.editor.getModel(),{triggerKind:InlineCompletionTriggerKind.Automatic,selectedSuggestionInfo:t},e)}catch(e){return void onUnexpectedError(e)}e.isCancellationRequested?n.dispose():(this.cache.setValue(this.editor,n,InlineCompletionTriggerKind.Automatic),this.onDidChangeEmitter.fire())})))),o=new UpdateOperation(n,InlineCompletionTriggerKind.Automatic);this.updateOperation.value=o,yield n,this.updateOperation.value===o&&this.updateOperation.clear()}))}get ghostText(){var e,t,i;const n=this.isSuggestionPreviewEnabled(),o=this.editor.getModel(),r=minimizeInlineCompletion(o,null===(t=null===(e=this.cache.value)||void 0===e?void 0:e.completions[0])||void 0===t?void 0:t.toLiveInlineCompletion()),s=this.suggestionInlineCompletionSource.state,l=minimizeInlineCompletion(o,null===(i=null==s?void 0:s.selectedItem)||void 0===i?void 0:i.normalizedInlineCompletion),a=r&&l&&r.insertText.startsWith(l.insertText)&&rangeExtends(r.range,l.range);if(!n&&!a)return;const d=a?r:l||r,u=a?d.insertText.length-l.insertText.length:0;return this.toGhostText(d,u)}toGhostText(e,t){const i=this.editor.getOptions().get(112).previewMode;return e?inlineCompletionToGhostText(e,this.editor.getModel(),i,this.editor.getPosition(),t)||new GhostText(e.range.endLineNumber,[],this.minReservedLineCount):void 0}};SuggestWidgetPreviewModel=__decorate([__param(2,ILanguageFeaturesService)],SuggestWidgetPreviewModel);export{SuggestWidgetPreviewModel};function sum(e){return e.reduce(((e,t)=>e+t),0)}function rangeExtends(e,t){return e.startLineNumber===t.startLineNumber&&e.startColumn===t.startColumn&&(e.endLineNumber===t.endLineNumber&&e.endColumn>=t.endColumn||e.endLineNumber>t.endLineNumber)}