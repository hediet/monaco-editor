var _a,__decorate=this&&this.__decorate||function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);return s>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import*as dom from"../../../../base/browser/dom.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import*as strings from"../../../../base/common/strings.js";import"./ghostText.css";import{applyFontInfo}from"../../../browser/config/domFontInfo.js";import{EditorFontLigatures}from"../../../common/config/editorOptions.js";import{LineTokens}from"../../../common/tokens/lineTokens.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{StringBuilder}from"../../../common/core/stringBuilder.js";import{InjectedTextCursorStops}from"../../../common/model.js";import{ILanguageService}from"../../../common/languages/language.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{GhostTextReplacement}from"./ghostText.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("editorGhostText",{createHTML:e=>e});let GhostTextWidget=class extends Disposable{constructor(e,t,i,o){super(),this.editor=e,this.model=t,this.instantiationService=i,this.languageService=o,this.disposed=!1,this.partsWidget=this._register(this.instantiationService.createInstance(DecorationsWidget,this.editor)),this.additionalLinesWidget=this._register(new AdditionalLinesWidget(this.editor,this.languageService.languageIdCodec)),this.viewMoreContentWidget=void 0,this.replacementDecoration=this._register(new DisposableDecorations(this.editor)),this._register(this.editor.onDidChangeConfiguration((e=>{(e.hasChanged(30)||e.hasChanged(111)||e.hasChanged(93)||e.hasChanged(88)||e.hasChanged(48)||e.hasChanged(47)||e.hasChanged(63))&&this.update()}))),this._register(toDisposable((()=>{var e;this.disposed=!0,this.update(),null===(e=this.viewMoreContentWidget)||void 0===e||e.dispose(),this.viewMoreContentWidget=void 0}))),this._register(t.onDidChange((()=>{this.update()}))),this.update()}shouldShowHoverAtViewZone(e){return this.additionalLinesWidget.viewZoneId===e}update(){var e;const t=this.model.ghostText;if(!this.editor.hasModel()||!t||this.disposed)return this.partsWidget.clear(),this.additionalLinesWidget.clear(),void this.replacementDecoration.clear();const i=new Array,o=new Array;function n(e,t){if(o.length>0){const i=o[o.length-1];t&&i.decorations.push(new LineDecoration(i.content.length+1,i.content.length+1+e[0].length,t,0)),i.content+=e[0],e=e.slice(1)}for(const i of e)o.push({content:i,decorations:t?[new LineDecoration(1,i.length+1,t,0)]:[]})}t instanceof GhostTextReplacement?this.replacementDecoration.setDecorations([{range:new Range(t.lineNumber,t.columnStart,t.lineNumber,t.columnStart+t.length),options:{inlineClassName:"inline-completion-text-to-replace",description:"GhostTextReplacement"}}]):this.replacementDecoration.setDecorations([]);const s=this.editor.getModel().getLineContent(t.lineNumber);let r,a=0;for(const e of t.parts){let t=e.lines;void 0===r?(i.push({column:e.column,text:t[0],preview:e.preview}),t=t.slice(1)):n([s.substring(a,e.column-1)],void 0),t.length>0&&(n(t,"ghost-text"),void 0===r&&e.column<=s.length&&(r=e.column)),a=e.column-1}void 0!==r&&n([s.substring(a)],void 0),this.partsWidget.setParts(t.lineNumber,i,void 0!==r?{column:r,length:s.length+1-r}:void 0),this.additionalLinesWidget.updateLines(t.lineNumber,o,t.additionalReservedLineCount),null===(e=this.viewMoreContentWidget)||void 0===e||e.dispose(),this.viewMoreContentWidget=void 0}renderViewMoreLines(e,t,i){const o=this.editor.getOption(47),n=document.createElement("div");n.className="suggest-preview-additional-widget",applyFontInfo(n,o);const s=document.createElement("span");s.className="content-spacer",s.append(t),n.append(s);const r=document.createElement("span");r.className="content-newline suggest-preview-text",r.append("⏎  "),n.append(r);const a=new DisposableStore,d=document.createElement("div");return d.className="button suggest-preview-text",d.append(`+${i} lines…`),a.add(dom.addStandardDisposableListener(d,"mousedown",(e=>{var t;null===(t=this.model)||void 0===t||t.setExpanded(!0),e.preventDefault(),this.editor.focus()}))),n.append(d),new ViewMoreLinesContentWidget(this.editor,e,n,a)}};GhostTextWidget=__decorate([__param(2,IInstantiationService),__param(3,ILanguageService)],GhostTextWidget);export{GhostTextWidget};class DisposableDecorations{constructor(e){this.editor=e,this.decorationIds=[]}setDecorations(e){this.editor.changeDecorations((t=>{this.decorationIds=t.deltaDecorations(this.decorationIds,e)}))}clear(){this.setDecorations([])}dispose(){this.clear()}}class DecorationsWidget{constructor(e){this.editor=e,this.decorationIds=[]}dispose(){this.clear()}clear(){this.editor.changeDecorations((e=>{this.decorationIds=e.deltaDecorations(this.decorationIds,[])}))}setParts(e,t,i){if(!this.editor.getModel())return;const o=new Array;i&&o.push({range:Range.fromPositions(new Position(e,i.column),new Position(e,i.column+i.length)),options:{inlineClassName:"ghost-text-hidden",description:"ghost-text-hidden"}}),this.editor.changeDecorations((i=>{this.decorationIds=i.deltaDecorations(this.decorationIds,t.map((t=>({range:Range.fromPositions(new Position(e,t.column)),options:{description:"ghost-text",after:{content:t.text,inlineClassName:t.preview?"ghost-text-decoration-preview":"ghost-text-decoration",cursorStops:InjectedTextCursorStops.Left},showIfCollapsed:!0}}))).concat(o))}))}}class AdditionalLinesWidget{get viewZoneId(){return this._viewZoneId}constructor(e,t){this.editor=e,this.languageIdCodec=t,this._viewZoneId=void 0}dispose(){this.clear()}clear(){this.editor.changeViewZones((e=>{this._viewZoneId&&(e.removeZone(this._viewZoneId),this._viewZoneId=void 0)}))}updateLines(e,t,i){const o=this.editor.getModel();if(!o)return;const{tabSize:n}=o.getOptions();this.editor.changeViewZones((o=>{this._viewZoneId&&(o.removeZone(this._viewZoneId),this._viewZoneId=void 0);const s=Math.max(t.length,i);if(s>0){const i=document.createElement("div");renderLines(i,n,t,this.editor.getOptions(),this.languageIdCodec),this._viewZoneId=o.addZone({afterLineNumber:e,heightInLines:s,domNode:i,afterColumnAffinity:1})}}))}}function renderLines(e,t,i,o,n){const s=o.get(30),r=o.get(111),a=o.get(88),d=o.get(48),c=o.get(47),h=o.get(63),l=new StringBuilder(1e4);l.appendString('<div class="suggest-preview-text">');for(let e=0,o=i.length;e<o;e++){const o=i[e],g=o.content;l.appendString('<div class="view-line'),l.appendString('" style="top:'),l.appendString(String(e*h)),l.appendString('px;width:1000000px;">');const p=strings.isBasicASCII(g),m=strings.containsRTL(g),u=LineTokens.createEmpty(g,n);renderViewLine(new RenderLineInput(c.isMonospace&&!s,c.canUseHalfwidthRightwardsArrow,g,!1,p,m,0,u,o.decorations,t,0,c.spaceWidth,c.middotWidth,c.wsmiddotWidth,r,"none",a,d!==EditorFontLigatures.OFF,null),l),l.appendString("</div>")}l.appendString("</div>"),applyFontInfo(e,c);const g=l.build(),p=ttPolicy?ttPolicy.createHTML(g):g;e.innerHTML=p}class ViewMoreLinesContentWidget extends Disposable{constructor(e,t,i,o){super(),this.editor=e,this.position=t,this.domNode=i,this.allowEditorOverflow=!1,this.suppressMouseDown=!1,this._register(o),this._register(toDisposable((()=>{this.editor.removeContentWidget(this)}))),this.editor.addContentWidget(this)}getId(){return"editor.widget.viewMoreLinesWidget"}getDomNode(){return this.domNode}getPosition(){return{position:this.position,preference:[0]}}}