var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import*as dom from"../../../../base/browser/dom.js";import{ActionViewItem}from"../../../../base/browser/ui/actionbar/actionViewItems.js";import{Separator,SubmenuAction}from"../../../../base/common/actions.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{isIOS}from"../../../../base/common/platform.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import*as nls from"../../../../nls.js";import{IMenuService,MenuId,SubmenuItemAction}from"../../../../platform/actions/common/actions.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IContextMenuService,IContextViewService}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";let ContextMenuController=class e{static get(t){return t.getContribution(e.ID)}constructor(e,t,o,i,n,r,s){this._contextMenuService=t,this._contextViewService=o,this._contextKeyService=i,this._keybindingService=n,this._menuService=r,this._configurationService=s,this._toDispose=new DisposableStore,this._contextMenuIsBeingShownCount=0,this._editor=e,this._toDispose.add(this._editor.onContextMenu((e=>this._onContextMenu(e)))),this._toDispose.add(this._editor.onMouseWheel((e=>{if(this._contextMenuIsBeingShownCount>0){const t=this._contextViewService.getContextViewElement(),o=e.srcElement;o.shadowRoot&&dom.getShadowRoot(t)===o.shadowRoot||this._contextViewService.hideContextView()}}))),this._toDispose.add(this._editor.onKeyDown((e=>{this._editor.getOption(21)&&58===e.keyCode&&(e.preventDefault(),e.stopPropagation(),this.showContextMenu())})))}_onContextMenu(e){if(!this._editor.hasModel())return;if(!this._editor.getOption(21))return this._editor.focus(),void(e.target.position&&!this._editor.getSelection().containsPosition(e.target.position)&&this._editor.setPosition(e.target.position));if(12===e.target.type)return;if(6===e.target.type&&e.target.detail.injectedText)return;if(e.event.preventDefault(),e.event.stopPropagation(),11===e.target.type)return this._showScrollbarContextMenu({x:e.event.posx-1,width:2,y:e.event.posy-1,height:2});if(6!==e.target.type&&7!==e.target.type&&1!==e.target.type)return;if(this._editor.focus(),e.target.position){let t=!1;for(const o of this._editor.getSelections())if(o.containsPosition(e.target.position)){t=!0;break}t||this._editor.setPosition(e.target.position)}let t=null;1!==e.target.type&&(t={x:e.event.posx-1,width:2,y:e.event.posy-1,height:2}),this.showContextMenu(t)}showContextMenu(e){if(!this._editor.getOption(21))return;if(!this._editor.hasModel())return;const t=this._getMenuActions(this._editor.getModel(),this._editor.isSimpleWidget?MenuId.SimpleEditorContext:MenuId.EditorContext);t.length>0&&this._doShowContextMenu(t,e)}_getMenuActions(e,t){const o=[],i=this._menuService.createMenu(t,this._contextKeyService),n=i.getActions({arg:e.uri});i.dispose();for(const t of n){const[,i]=t;let n=0;for(const t of i)if(t instanceof SubmenuItemAction){const i=this._getMenuActions(e,t.item.submenu);i.length>0&&(o.push(new SubmenuAction(t.id,t.label,i)),n++)}else o.push(t),n++;n&&o.push(new Separator)}return o.length&&o.pop(),o}_doShowContextMenu(e,t=null){if(!this._editor.hasModel())return;const o=this._editor.getOption(57);if(this._editor.updateOptions({hover:{enabled:!1}}),!t){this._editor.revealPosition(this._editor.getPosition(),1),this._editor.render();const e=this._editor.getScrolledVisiblePosition(this._editor.getPosition()),o=dom.getDomNodePagePosition(this._editor.getDomNode()),i=o.left+e.left,n=o.top+e.top+e.height;t={x:i,y:n}}const i=this._editor.getOption(121)&&!isIOS;this._contextMenuIsBeingShownCount++,this._contextMenuService.showContextMenu({domForShadowRoot:i?this._editor.getDomNode():void 0,getAnchor:()=>t,getActions:()=>e,getActionViewItem:e=>{const t=this._keybindingFor(e);if(t)return new ActionViewItem(e,e,{label:!0,keybinding:t.getLabel(),isMenu:!0});const o=e;return"function"==typeof o.getActionViewItem?o.getActionViewItem():new ActionViewItem(e,e,{icon:!0,label:!0,isMenu:!0})},getKeyBinding:e=>this._keybindingFor(e),onHide:e=>{this._contextMenuIsBeingShownCount--,this._editor.updateOptions({hover:o})}})}_showScrollbarContextMenu(e){if(!this._editor.hasModel())return;const t=this._editor.getOption(69);let o=0;const i=e=>({id:"menu-action-"+ ++o,label:e.label,tooltip:"",class:void 0,enabled:void 0===e.enabled||e.enabled,checked:e.checked,run:e.run}),n=(e,t,n,r,s)=>{if(!t)return i({label:e,enabled:t,run:()=>{}});const a=e=>()=>{this._configurationService.updateValue(n,e)},c=[];for(const e of s)c.push(i({label:e.label,checked:r===e.value,run:a(e.value)}));return((e,t)=>new SubmenuAction("menu-action-"+ ++o,e,t,void 0))(e,c)},r=[];r.push(i({label:nls.localize("context.minimap.minimap","Minimap"),checked:t.enabled,run:()=>{this._configurationService.updateValue("editor.minimap.enabled",!t.enabled)}})),r.push(new Separator),r.push(i({label:nls.localize("context.minimap.renderCharacters","Render Characters"),enabled:t.enabled,checked:t.renderCharacters,run:()=>{this._configurationService.updateValue("editor.minimap.renderCharacters",!t.renderCharacters)}})),r.push(n(nls.localize("context.minimap.size","Vertical size"),t.enabled,"editor.minimap.size",t.size,[{label:nls.localize("context.minimap.size.proportional","Proportional"),value:"proportional"},{label:nls.localize("context.minimap.size.fill","Fill"),value:"fill"},{label:nls.localize("context.minimap.size.fit","Fit"),value:"fit"}])),r.push(n(nls.localize("context.minimap.slider","Slider"),t.enabled,"editor.minimap.showSlider",t.showSlider,[{label:nls.localize("context.minimap.slider.mouseover","Mouse Over"),value:"mouseover"},{label:nls.localize("context.minimap.slider.always","Always"),value:"always"}]));const s=this._editor.getOption(121)&&!isIOS;this._contextMenuIsBeingShownCount++,this._contextMenuService.showContextMenu({domForShadowRoot:s?this._editor.getDomNode():void 0,getAnchor:()=>e,getActions:()=>r,onHide:e=>{this._contextMenuIsBeingShownCount--,this._editor.focus()}})}_keybindingFor(e){return this._keybindingService.lookupKeybinding(e.id)}dispose(){this._contextMenuIsBeingShownCount>0&&this._contextViewService.hideContextView(),this._toDispose.dispose()}};ContextMenuController.ID="editor.contrib.contextmenu",ContextMenuController=__decorate([__param(1,IContextMenuService),__param(2,IContextViewService),__param(3,IContextKeyService),__param(4,IKeybindingService),__param(5,IMenuService),__param(6,IConfigurationService)],ContextMenuController);export{ContextMenuController};class ShowContextMenu extends EditorAction{constructor(){super({id:"editor.action.showContextMenu",label:nls.localize("action.showContextMenu.label","Show Editor Context Menu"),alias:"Show Editor Context Menu",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.textInputFocus,primary:1092,weight:100}})}run(e,t){var o;null===(o=ContextMenuController.get(t))||void 0===o||o.showContextMenu()}}registerEditorContribution(ContextMenuController.ID,ContextMenuController,2),registerEditorAction(ShowContextMenu);