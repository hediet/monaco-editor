var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function a(e){try{c(i.next(e))}catch(e){r(e)}}function s(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((i=i.apply(e,t||[])).next())}))};import{LinkedList}from"../../../../base/common/linkedList.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";class BracketSelectionRangeProvider{provideSelectionRanges(e,t){return __awaiter(this,void 0,void 0,(function*(){const n=[];for(const i of t){const t=[];n.push(t);const o=new Map;yield new Promise((t=>BracketSelectionRangeProvider._bracketsRightYield(t,0,e,i,o))),yield new Promise((n=>BracketSelectionRangeProvider._bracketsLeftYield(n,0,e,i,o,t)))}return n}))}static _bracketsRightYield(e,t,n,i,o){const r=new Map,a=Date.now();for(;;){if(t>=BracketSelectionRangeProvider._maxRounds){e();break}if(!i){e();break}const s=n.bracketPairs.findNextBracket(i);if(!s){e();break}if(Date.now()-a>BracketSelectionRangeProvider._maxDuration){setTimeout((()=>BracketSelectionRangeProvider._bracketsRightYield(e,t+1,n,i,o)));break}if(s.bracketInfo.isOpeningBracket){const e=s.bracketInfo.bracketText,t=r.has(e)?r.get(e):0;r.set(e,t+1)}else{const e=s.bracketInfo.getClosedBrackets()[0].bracketText;let t=r.has(e)?r.get(e):0;if(t-=1,r.set(e,Math.max(0,t)),t<0){let t=o.get(e);t||(t=new LinkedList,o.set(e,t)),t.push(s.range)}}i=s.range.getEndPosition()}}static _bracketsLeftYield(e,t,n,i,o,r){const a=new Map,s=Date.now();for(;;){if(t>=BracketSelectionRangeProvider._maxRounds&&0===o.size){e();break}if(!i){e();break}const c=n.bracketPairs.findPrevBracket(i);if(!c){e();break}if(Date.now()-s>BracketSelectionRangeProvider._maxDuration){setTimeout((()=>BracketSelectionRangeProvider._bracketsLeftYield(e,t+1,n,i,o,r)));break}if(c.bracketInfo.isOpeningBracket){const e=c.bracketInfo.bracketText;let t=a.has(e)?a.get(e):0;if(t-=1,a.set(e,Math.max(0,t)),t<0){const t=o.get(e);if(t){const i=t.shift();0===t.size&&o.delete(e);const a=Range.fromPositions(c.range.getEndPosition(),i.getStartPosition()),s=Range.fromPositions(c.range.getStartPosition(),i.getEndPosition());r.push({range:a}),r.push({range:s}),BracketSelectionRangeProvider._addBracketLeading(n,s,r)}}}else{const e=c.bracketInfo.getClosedBrackets()[0].bracketText,t=a.has(e)?a.get(e):0;a.set(e,t+1)}i=c.range.getStartPosition()}}static _addBracketLeading(e,t,n){if(t.startLineNumber===t.endLineNumber)return;const i=t.startLineNumber,o=e.getLineFirstNonWhitespaceColumn(i);0!==o&&o!==t.startColumn&&(n.push({range:Range.fromPositions(new Position(i,o),t.getEndPosition())}),n.push({range:Range.fromPositions(new Position(i,1),t.getEndPosition())}));const r=i-1;if(r>0){const i=e.getLineFirstNonWhitespaceColumn(r);i===t.startColumn&&i!==e.getLineLastNonWhitespaceColumn(r)&&(n.push({range:Range.fromPositions(new Position(r,i),t.getEndPosition())}),n.push({range:Range.fromPositions(new Position(r,1),t.getEndPosition())}))}}}BracketSelectionRangeProvider._maxDuration=30,BracketSelectionRangeProvider._maxRounds=2;export{BracketSelectionRangeProvider};