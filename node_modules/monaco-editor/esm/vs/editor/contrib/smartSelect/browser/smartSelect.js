var __decorate=this&&this.__decorate||function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,o){t(n,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};import*as arrays from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{BracketSelectionRangeProvider}from"./bracketSelections.js";import{WordSelectionRangeProvider}from"./wordSelections.js";import*as nls from"../../../../nls.js";import{MenuId}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";class SelectionRanges{constructor(e,t){this.index=e,this.ranges=t}mov(e){const t=this.index+(e?1:-1);if(t<0||t>=this.ranges.length)return this;const n=new SelectionRanges(t,this.ranges);return n.ranges[t].equalsRange(this.ranges[this.index])?n.mov(e):n}}let SmartSelectController=class e{static get(t){return t.getContribution(e.ID)}constructor(e,t){this._editor=e,this._languageFeaturesService=t,this._ignoreSelection=!1}dispose(){var e;null===(e=this._selectionListener)||void 0===e||e.dispose()}run(e){return __awaiter(this,void 0,void 0,(function*(){if(!this._editor.hasModel())return;const t=this._editor.getSelections(),n=this._editor.getModel();if(this._state||(yield provideSelectionRanges(this._languageFeaturesService.selectionRangeProvider,n,t.map((e=>e.getPosition())),this._editor.getOption(107),CancellationToken.None).then((e=>{var n;if(arrays.isNonEmptyArray(e)&&e.length===t.length&&this._editor.hasModel()&&arrays.equals(this._editor.getSelections(),t,((e,t)=>e.equalsSelection(t)))){for(let n=0;n<e.length;n++)e[n]=e[n].filter((e=>e.containsPosition(t[n].getStartPosition())&&e.containsPosition(t[n].getEndPosition()))),e[n].unshift(t[n]);this._state=e.map((e=>new SelectionRanges(0,e))),null===(n=this._selectionListener)||void 0===n||n.dispose(),this._selectionListener=this._editor.onDidChangeCursorPosition((()=>{var e;this._ignoreSelection||(null===(e=this._selectionListener)||void 0===e||e.dispose(),this._state=void 0)}))}}))),!this._state)return;this._state=this._state.map((t=>t.mov(e)));const o=this._state.map((e=>Selection.fromPositions(e.ranges[e.index].getStartPosition(),e.ranges[e.index].getEndPosition())));this._ignoreSelection=!0;try{this._editor.setSelections(o)}finally{this._ignoreSelection=!1}}))}};SmartSelectController.ID="editor.contrib.smartSelectController",SmartSelectController=__decorate([__param(1,ILanguageFeaturesService)],SmartSelectController);class AbstractSmartSelect extends EditorAction{constructor(e,t){super(t),this._forward=e}run(e,t){return __awaiter(this,void 0,void 0,(function*(){const e=SmartSelectController.get(t);e&&(yield e.run(this._forward))}))}}class GrowSelectionAction extends AbstractSmartSelect{constructor(){super(!0,{id:"editor.action.smartSelect.expand",label:nls.localize("smartSelect.expand","Expand Selection"),alias:"Expand Selection",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1553,mac:{primary:3345,secondary:[1297]},weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"1_basic",title:nls.localize({key:"miSmartSelectGrow",comment:["&& denotes a mnemonic"]},"&&Expand Selection"),order:2}})}}CommandsRegistry.registerCommandAlias("editor.action.smartSelect.grow","editor.action.smartSelect.expand");class ShrinkSelectionAction extends AbstractSmartSelect{constructor(){super(!1,{id:"editor.action.smartSelect.shrink",label:nls.localize("smartSelect.shrink","Shrink Selection"),alias:"Shrink Selection",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:1551,mac:{primary:3343,secondary:[1295]},weight:100},menuOpts:{menuId:MenuId.MenubarSelectionMenu,group:"1_basic",title:nls.localize({key:"miSmartSelectShrink",comment:["&& denotes a mnemonic"]},"&&Shrink Selection"),order:3}})}}registerEditorContribution(SmartSelectController.ID,SmartSelectController,4),registerEditorAction(GrowSelectionAction),registerEditorAction(ShrinkSelectionAction);export function provideSelectionRanges(e,t,n,o,i){return __awaiter(this,void 0,void 0,(function*(){const r=e.all(t).concat(new WordSelectionRangeProvider);1===r.length&&r.unshift(new BracketSelectionRangeProvider);const s=[],a=[];for(const e of r)s.push(Promise.resolve(e.provideSelectionRanges(t,n,i)).then((e=>{if(arrays.isNonEmptyArray(e)&&e.length===n.length)for(let t=0;t<n.length;t++){a[t]||(a[t]=[]);for(const o of e[t])Range.isIRange(o.range)&&Range.containsPosition(o.range,n[t])&&a[t].push(Range.lift(o.range))}}),onUnexpectedExternalError));return yield Promise.all(s),a.map((e=>{if(0===e.length)return[];e.sort(((e,t)=>Position.isBefore(e.getStartPosition(),t.getStartPosition())?1:Position.isBefore(t.getStartPosition(),e.getStartPosition())||Position.isBefore(e.getEndPosition(),t.getEndPosition())?-1:Position.isBefore(t.getEndPosition(),e.getEndPosition())?1:0));const n=[];let i;for(const t of e)(!i||Range.containsRange(t,i)&&!Range.equalsRange(t,i))&&(n.push(t),i=t);if(!o.selectLeadingAndTrailingWhitespace)return n;const r=[n[0]];for(let e=1;e<n.length;e++){const o=n[e-1],i=n[e];if(i.startLineNumber!==o.startLineNumber||i.endLineNumber!==o.endLineNumber){const e=new Range(o.startLineNumber,t.getLineFirstNonWhitespaceColumn(o.startLineNumber),o.endLineNumber,t.getLineLastNonWhitespaceColumn(o.endLineNumber));e.containsRange(o)&&!e.equalsRange(o)&&i.containsRange(e)&&!i.equalsRange(e)&&r.push(e);const n=new Range(o.startLineNumber,1,o.endLineNumber,t.getLineMaxColumn(o.endLineNumber));n.containsRange(o)&&!n.equalsRange(e)&&i.containsRange(n)&&!i.equalsRange(n)&&r.push(n)}r.push(i)}return r}))}))}CommandsRegistry.registerCommand("_executeSelectionRangeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[n,o]=t;assertType(URI.isUri(n));const i=e.get(ILanguageFeaturesService).selectionRangeProvider,r=yield e.get(ITextModelService).createModelReference(n);try{return provideSelectionRanges(i,r.object.textEditorModel,o,{selectLeadingAndTrailingWhitespace:!0},CancellationToken.None)}finally{r.dispose()}}))}));