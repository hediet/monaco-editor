import{findFirstInSorted}from"../../../../base/common/arrays.js";import{RunOnceScheduler,TimeoutTimer}from"../../../../base/common/async.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{ReplaceCommand,ReplaceCommandThatPreservesSelection}from"../../../common/commands/replaceCommand.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{SearchParams}from"../../../common/model/textModelSearch.js";import{FindDecorations}from"./findDecorations.js";import{ReplaceAllCommand}from"./replaceAllCommand.js";import{parseReplaceString,ReplacePattern}from"./replacePattern.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";export const CONTEXT_FIND_WIDGET_VISIBLE=new RawContextKey("findWidgetVisible",!1);export const CONTEXT_FIND_WIDGET_NOT_VISIBLE=CONTEXT_FIND_WIDGET_VISIBLE.toNegated();export const CONTEXT_FIND_INPUT_FOCUSED=new RawContextKey("findInputFocussed",!1);export const CONTEXT_REPLACE_INPUT_FOCUSED=new RawContextKey("replaceInputFocussed",!1);export const ToggleCaseSensitiveKeybinding={primary:545,mac:{primary:2593}};export const ToggleWholeWordKeybinding={primary:565,mac:{primary:2613}};export const ToggleRegexKeybinding={primary:560,mac:{primary:2608}};export const ToggleSearchScopeKeybinding={primary:554,mac:{primary:2602}};export const TogglePreserveCaseKeybinding={primary:558,mac:{primary:2606}};export const FIND_IDS={StartFindAction:"actions.find",StartFindWithSelection:"actions.findWithSelection",StartFindWithArgs:"editor.actions.findWithArgs",NextMatchFindAction:"editor.action.nextMatchFindAction",PreviousMatchFindAction:"editor.action.previousMatchFindAction",GoToMatchFindAction:"editor.action.goToMatchFindAction",NextSelectionMatchFindAction:"editor.action.nextSelectionMatchFindAction",PreviousSelectionMatchFindAction:"editor.action.previousSelectionMatchFindAction",StartFindReplaceAction:"editor.action.startFindReplaceAction",CloseFindWidgetCommand:"closeFindWidget",ToggleCaseSensitiveCommand:"toggleFindCaseSensitive",ToggleWholeWordCommand:"toggleFindWholeWord",ToggleRegexCommand:"toggleFindRegex",ToggleSearchScopeCommand:"toggleFindInSelection",TogglePreserveCaseCommand:"togglePreserveCase",ReplaceOneAction:"editor.action.replaceOne",ReplaceAllAction:"editor.action.replaceAll",SelectAllMatchesAction:"editor.action.selectAllMatches"};export const MATCHES_LIMIT=19999;const RESEARCH_DELAY=240;export class FindModelBoundToEditorModel{constructor(t,e){this._toDispose=new DisposableStore,this._editor=t,this._state=e,this._isDisposed=!1,this._startSearchingTimer=new TimeoutTimer,this._decorations=new FindDecorations(t),this._toDispose.add(this._decorations),this._updateDecorationsScheduler=new RunOnceScheduler((()=>this.research(!1)),100),this._toDispose.add(this._updateDecorationsScheduler),this._toDispose.add(this._editor.onDidChangeCursorPosition((t=>{3!==t.reason&&5!==t.reason&&6!==t.reason||this._decorations.setStartPosition(this._editor.getPosition())}))),this._ignoreModelContentChanged=!1,this._toDispose.add(this._editor.onDidChangeModelContent((t=>{this._ignoreModelContentChanged||(t.isFlush&&this._decorations.reset(),this._decorations.setStartPosition(this._editor.getPosition()),this._updateDecorationsScheduler.schedule())}))),this._toDispose.add(this._state.onFindReplaceStateChange((t=>this._onStateChanged(t)))),this.research(!1,this._state.searchScope)}dispose(){this._isDisposed=!0,dispose(this._startSearchingTimer),this._toDispose.dispose()}_onStateChanged(t){!this._isDisposed&&this._editor.hasModel()&&(t.searchString||t.isReplaceRevealed||t.isRegex||t.wholeWord||t.matchCase||t.searchScope)&&(this._editor.getModel().isTooLargeForSyncing()?(this._startSearchingTimer.cancel(),this._startSearchingTimer.setIfNotSet((()=>{t.searchScope?this.research(t.moveCursor,this._state.searchScope):this.research(t.moveCursor)}),240)):t.searchScope?this.research(t.moveCursor,this._state.searchScope):this.research(t.moveCursor))}static _getSearchRange(t,e){return e||t.getFullModelRange()}research(t,e){let i=null;void 0!==e?null!==e&&(i=Array.isArray(e)?e:[e]):i=this._decorations.getFindScopes(),null!==i&&(i=i.map((t=>{if(t.startLineNumber!==t.endLineNumber){let e=t.endLineNumber;return 1===t.endColumn&&(e-=1),new Range(t.startLineNumber,1,e,this._editor.getModel().getLineMaxColumn(e))}return t})));const o=this._findMatches(i,!1,19999);this._decorations.set(o,i);const s=this._editor.getSelection();let n=this._decorations.getCurrentMatchesPosition(s);if(0===n&&o.length>0){const t=findFirstInSorted(o.map((t=>t.range)),(t=>Range.compareRangesUsingStarts(t,s)>=0));n=t>0?t-1+1:n}this._state.changeMatchInfo(n,this._decorations.getCount(),void 0),t&&this._editor.getOption(38).cursorMoveOnType&&this._moveToNextMatch(this._decorations.getStartPosition())}_hasMatches(){return this._state.matchesCount>0}_cannotFind(){if(!this._hasMatches()){const t=this._decorations.getFindScope();return t&&this._editor.revealRangeInCenterIfOutsideViewport(t,0),!0}return!1}_setCurrentFindMatch(t){const e=this._decorations.setCurrentFindMatch(t);this._state.changeMatchInfo(e,this._decorations.getCount(),t),this._editor.setSelection(t),this._editor.revealRangeInCenterIfOutsideViewport(t,0)}_prevSearchPosition(t){const e=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);let{lineNumber:i,column:o}=t;const s=this._editor.getModel();return e||1===o?(1===i?i=s.getLineCount():i--,o=s.getLineMaxColumn(i)):o--,new Position(i,o)}_moveToPrevMatch(t,e=!1){if(!this._state.canNavigateBack()){const e=this._decorations.matchAfterPosition(t);return void(e&&this._setCurrentFindMatch(e))}if(this._decorations.getCount()<19999){let e=this._decorations.matchBeforePosition(t);return e&&e.isEmpty()&&e.getStartPosition().equals(t)&&(t=this._prevSearchPosition(t),e=this._decorations.matchBeforePosition(t)),void(e&&this._setCurrentFindMatch(e))}if(this._cannotFind())return;const i=this._decorations.getFindScope(),o=FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),i);o.getEndPosition().isBefore(t)&&(t=o.getEndPosition()),t.isBefore(o.getStartPosition())&&(t=o.getEndPosition());const{lineNumber:s,column:n}=t,r=this._editor.getModel();let a=new Position(s,n),c=r.findPreviousMatch(this._state.searchString,a,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null,!1);return c&&c.range.isEmpty()&&c.range.getStartPosition().equals(a)&&(a=this._prevSearchPosition(a),c=r.findPreviousMatch(this._state.searchString,a,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null,!1)),c?e||o.containsRange(c.range)?void this._setCurrentFindMatch(c.range):this._moveToPrevMatch(c.range.getStartPosition(),!0):void 0}moveToPrevMatch(){this._moveToPrevMatch(this._editor.getSelection().getStartPosition())}_nextSearchPosition(t){const e=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);let{lineNumber:i,column:o}=t;const s=this._editor.getModel();return e||o===s.getLineMaxColumn(i)?(i===s.getLineCount()?i=1:i++,o=1):o++,new Position(i,o)}_moveToNextMatch(t){if(!this._state.canNavigateForward()){const e=this._decorations.matchBeforePosition(t);return void(e&&this._setCurrentFindMatch(e))}if(this._decorations.getCount()<19999){let e=this._decorations.matchAfterPosition(t);return e&&e.isEmpty()&&e.getStartPosition().equals(t)&&(t=this._nextSearchPosition(t),e=this._decorations.matchAfterPosition(t)),void(e&&this._setCurrentFindMatch(e))}const e=this._getNextMatch(t,!1,!0);e&&this._setCurrentFindMatch(e.range)}_getNextMatch(t,e,i,o=!1){if(this._cannotFind())return null;const s=this._decorations.getFindScope(),n=FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),s);n.getEndPosition().isBefore(t)&&(t=n.getStartPosition()),t.isBefore(n.getStartPosition())&&(t=n.getStartPosition());const{lineNumber:r,column:a}=t,c=this._editor.getModel();let h=new Position(r,a),d=c.findNextMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null,e);return i&&d&&d.range.isEmpty()&&d.range.getStartPosition().equals(h)&&(h=this._nextSearchPosition(h),d=c.findNextMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null,e)),d?o||n.containsRange(d.range)?d:this._getNextMatch(d.range.getEndPosition(),e,i,!0):null}moveToNextMatch(){this._moveToNextMatch(this._editor.getSelection().getEndPosition())}_moveToMatch(t){const e=this._decorations.getDecorationRangeAt(t);e&&this._setCurrentFindMatch(e)}moveToMatch(t){this._moveToMatch(t)}_getReplacePattern(){return this._state.isRegex?parseReplaceString(this._state.replaceString):ReplacePattern.fromStaticValue(this._state.replaceString)}replace(){if(!this._hasMatches())return;const t=this._getReplacePattern(),e=this._editor.getSelection(),i=this._getNextMatch(e.getStartPosition(),!0,!1);if(i)if(e.equalsRange(i.range)){const o=t.buildReplaceString(i.matches,this._state.preserveCase),s=new ReplaceCommand(e,o);this._executeEditorCommand("replace",s),this._decorations.setStartPosition(new Position(e.startLineNumber,e.startColumn+o.length)),this.research(!0)}else this._decorations.setStartPosition(this._editor.getPosition()),this._setCurrentFindMatch(i.range)}_findMatches(t,e,i){const o=(t||[null]).map((t=>FindModelBoundToEditorModel._getSearchRange(this._editor.getModel(),t)));return this._editor.getModel().findMatches(this._state.searchString,o,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null,e,i)}replaceAll(){if(!this._hasMatches())return;const t=this._decorations.getFindScopes();null===t&&this._state.matchesCount>=19999?this._largeReplaceAll():this._regularReplaceAll(t),this.research(!1)}_largeReplaceAll(){const t=new SearchParams(this._state.searchString,this._state.isRegex,this._state.matchCase,this._state.wholeWord?this._editor.getOption(124):null).parseSearchRequest();if(!t)return;let e=t.regex;if(!e.multiline){let t="mu";e.ignoreCase&&(t+="i"),e.global&&(t+="g"),e=new RegExp(e.source,t)}const i=this._editor.getModel(),o=i.getValue(1),s=i.getFullModelRange(),n=this._getReplacePattern();let r;const a=this._state.preserveCase;r=n.hasReplacementPatterns||a?o.replace(e,(function(){return n.buildReplaceString(arguments,a)})):o.replace(e,n.buildReplaceString(null,a));const c=new ReplaceCommandThatPreservesSelection(s,r,this._editor.getSelection());this._executeEditorCommand("replaceAll",c)}_regularReplaceAll(t){const e=this._getReplacePattern(),i=this._findMatches(t,e.hasReplacementPatterns||this._state.preserveCase,1073741824),o=[];for(let t=0,s=i.length;t<s;t++)o[t]=e.buildReplaceString(i[t].matches,this._state.preserveCase);const s=new ReplaceAllCommand(this._editor.getSelection(),i.map((t=>t.range)),o);this._executeEditorCommand("replaceAll",s)}selectAllMatches(){if(!this._hasMatches())return;const t=this._decorations.getFindScopes();let e=this._findMatches(t,!1,1073741824).map((t=>new Selection(t.range.startLineNumber,t.range.startColumn,t.range.endLineNumber,t.range.endColumn)));const i=this._editor.getSelection();for(let t=0,o=e.length;t<o;t++)if(e[t].equalsRange(i)){e=[i].concat(e.slice(0,t)).concat(e.slice(t+1));break}this._editor.setSelections(e)}_executeEditorCommand(t,e){try{this._ignoreModelContentChanged=!0,this._editor.pushUndoStop(),this._editor.executeCommand(t,e),this._editor.pushUndoStop()}finally{this._ignoreModelContentChanged=!1}}}