import{buildReplaceStringWithCasePreserved}from"../../../../base/common/search.js";class StaticValueReplacePattern{constructor(e){this.staticValue=e,this.kind=0}}class DynamicPiecesReplacePattern{constructor(e){this.pieces=e,this.kind=1}}export class ReplacePattern{static fromStaticValue(e){return new ReplacePattern([ReplacePiece.staticValue(e)])}get hasReplacementPatterns(){return 1===this._state.kind}constructor(e){e&&0!==e.length?1===e.length&&null!==e[0].staticValue?this._state=new StaticValueReplacePattern(e[0].staticValue):this._state=new DynamicPiecesReplacePattern(e):this._state=new StaticValueReplacePattern("")}buildReplaceString(e,t){if(0===this._state.kind)return t?buildReplaceStringWithCasePreserved(e,this._state.staticValue):this._state.staticValue;let i="";for(let t=0,a=this._state.pieces.length;t<a;t++){const a=this._state.pieces[t];if(null!==a.staticValue){i+=a.staticValue;continue}let s=ReplacePattern._substitute(a.matchIndex,e);if(null!==a.caseOps&&a.caseOps.length>0){const e=[],t=a.caseOps.length;let i=0;for(let c=0,n=s.length;c<n;c++){if(i>=t){e.push(s.slice(c));break}switch(a.caseOps[i]){case"U":e.push(s[c].toUpperCase());break;case"u":e.push(s[c].toUpperCase()),i++;break;case"L":e.push(s[c].toLowerCase());break;case"l":e.push(s[c].toLowerCase()),i++;break;default:e.push(s[c])}}s=e.join("")}i+=s}return i}static _substitute(e,t){if(null===t)return"";if(0===e)return t[0];let i="";for(;e>0;){if(e<t.length)return(t[e]||"")+i;i=String(e%10)+i,e=Math.floor(e/10)}return"$"+i}}export class ReplacePiece{static staticValue(e){return new ReplacePiece(e,-1,null)}static caseOps(e,t){return new ReplacePiece(null,e,t)}constructor(e,t,i){this.staticValue=e,this.matchIndex=t,i&&0!==i.length?this.caseOps=i.slice(0):this.caseOps=null}}class ReplacePieceBuilder{constructor(e){this._source=e,this._lastCharIndex=0,this._result=[],this._resultLen=0,this._currentStaticPiece=""}emitUnchanged(e){this._emitStatic(this._source.substring(this._lastCharIndex,e)),this._lastCharIndex=e}emitStatic(e,t){this._emitStatic(e),this._lastCharIndex=t}_emitStatic(e){0!==e.length&&(this._currentStaticPiece+=e)}emitMatchIndex(e,t,i){0!==this._currentStaticPiece.length&&(this._result[this._resultLen++]=ReplacePiece.staticValue(this._currentStaticPiece),this._currentStaticPiece=""),this._result[this._resultLen++]=ReplacePiece.caseOps(e,i),this._lastCharIndex=t}finalize(){return this.emitUnchanged(this._source.length),0!==this._currentStaticPiece.length&&(this._result[this._resultLen++]=ReplacePiece.staticValue(this._currentStaticPiece),this._currentStaticPiece=""),new ReplacePattern(this._result)}}export function parseReplaceString(e){if(!e||0===e.length)return new ReplacePattern(null);const t=[],i=new ReplacePieceBuilder(e);for(let a=0,s=e.length;a<s;a++){const c=e.charCodeAt(a);if(92!==c){if(36===c){if(a++,a>=s)break;const c=e.charCodeAt(a);if(36===c){i.emitUnchanged(a-1),i.emitStatic("$",a+1);continue}if(48===c||38===c){i.emitUnchanged(a-1),i.emitMatchIndex(0,a+1,t),t.length=0;continue}if(49<=c&&c<=57){let n=c-48;if(a+1<s){const s=e.charCodeAt(a+1);if(48<=s&&s<=57){a++,n=10*n+(s-48),i.emitUnchanged(a-2),i.emitMatchIndex(n,a+1,t),t.length=0;continue}}i.emitUnchanged(a-1),i.emitMatchIndex(n,a+1,t),t.length=0;continue}}}else{if(a++,a>=s)break;const c=e.charCodeAt(a);switch(c){case 92:i.emitUnchanged(a-1),i.emitStatic("\\",a+1);break;case 110:i.emitUnchanged(a-1),i.emitStatic("\n",a+1);break;case 116:i.emitUnchanged(a-1),i.emitStatic("\t",a+1);break;case 117:case 85:case 108:case 76:i.emitUnchanged(a-1),i.emitStatic("",a+1),t.push(String.fromCharCode(c))}}}return i.finalize()}