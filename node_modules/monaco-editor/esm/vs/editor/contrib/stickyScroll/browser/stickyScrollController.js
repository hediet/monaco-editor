var __decorate=this&&this.__decorate||function(t,e,i,o){var r,n=arguments.length,s=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,o);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(n<3?r(s):n>3?r(e,i,s):r(e,i))||s);return n>3&&s&&Object.defineProperty(e,i,s),s},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}},__awaiter=this&&this.__awaiter||function(t,e,i,o){return new(i||(i=Promise))((function(r,n){function s(t){try{d(o.next(t))}catch(t){n(t)}}function c(t){try{d(o.throw(t))}catch(t){n(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,c)}d((o=o.apply(t,e||[])).next())}))};import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{StickyScrollWidget,StickyScrollWidgetState}from"./stickyScrollWidget.js";import{StickyLineCandidateProvider,StickyRange}from"./stickyScrollProvider.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import*as dom from"../../../../base/browser/dom.js";import{IContextMenuService}from"../../../../platform/contextview/browser/contextView.js";import{MenuId}from"../../../../platform/actions/common/actions.js";let StickyScrollController=class extends Disposable{constructor(t,e,i,o){super(),this._editor=t,this._contextMenuService=e,this._sessionStore=new DisposableStore,this._maxStickyLines=Number.MAX_SAFE_INTEGER,this._stickyScrollWidget=new StickyScrollWidget(this._editor,i,o),this._stickyLineCandidateProvider=new StickyLineCandidateProvider(this._editor,i),this._widgetState=new StickyScrollWidgetState([],0),this._register(this._stickyScrollWidget),this._register(this._stickyLineCandidateProvider),this._register(this._editor.onDidChangeConfiguration((t=>{t.hasChanged(109)&&this._readConfiguration()}))),this._readConfiguration(),this._register(dom.addDisposableListener(this._stickyScrollWidget.getDomNode(),dom.EventType.CONTEXT_MENU,(t=>__awaiter(this,void 0,void 0,(function*(){this._onContextMenu(t)})))))}_onContextMenu(t){this._contextMenuService.showContextMenu({menuId:MenuId.StickyScrollContext,getAnchor:()=>t})}_readConfiguration(){if(!1===this._editor.getOption(109).enabled)return this._editor.removeOverlayWidget(this._stickyScrollWidget),void this._sessionStore.clear();this._editor.addOverlayWidget(this._stickyScrollWidget),this._sessionStore.add(this._editor.onDidScrollChange((()=>this._renderStickyScroll()))),this._sessionStore.add(this._editor.onDidLayoutChange((()=>this._onDidResize()))),this._sessionStore.add(this._editor.onDidChangeModelTokens((t=>this._onTokensChange(t)))),this._sessionStore.add(this._stickyLineCandidateProvider.onDidChangeStickyScroll((()=>this._renderStickyScroll()))),2===this._editor.getOption(64).renderType&&this._sessionStore.add(this._editor.onDidChangeCursorPosition((()=>this._renderStickyScroll())))}_needsUpdate(t){const e=this._stickyScrollWidget.getCurrentLines();for(const i of e)for(const e of t.ranges)if(i>=e.fromLineNumber&&i<=e.toLineNumber)return!0;return!1}_onTokensChange(t){this._needsUpdate(t)&&this._renderStickyScroll()}_onDidResize(){const t=this._editor.getLayoutInfo(),e=t.width-t.minimap.minimapCanvasOuterWidth-t.verticalScrollbarWidth;this._stickyScrollWidget.getDomNode().style.width=`${e}px`;const i=t.height/this._editor.getOption(63);this._maxStickyLines=Math.round(.25*i)}_renderStickyScroll(){if(!this._editor.hasModel())return;const t=this._editor.getModel(),e=this._stickyLineCandidateProvider.getVersionId();void 0!==e&&e!==t.getVersionId()||(this._widgetState=this.getScrollWidgetState(),this._stickyScrollWidget.setState(this._widgetState))}getScrollWidgetState(){const t=this._editor.getOption(63),e=Math.min(this._maxStickyLines,this._editor.getOption(109).maxLineCount),i=this._editor.getScrollTop();let o=0;const r=[],n=this._editor.getVisibleRanges();if(0!==n.length){const s=new StickyRange(n[0].startLineNumber,n[n.length-1].endLineNumber),c=this._stickyLineCandidateProvider.getCandidateStickyLinesIntersecting(s);for(const n of c){const s=n.startLineNumber,c=n.endLineNumber,d=n.nestingDepth;if(c-s>0){const n=(d-1)*t,a=d*t,l=this._editor.getBottomForLineNumber(s)-i,h=this._editor.getTopForLineNumber(c)-i,_=this._editor.getBottomForLineNumber(c)-i;if(n>h&&n<=_){r.push(s),o=_-a;break}if(a>l&&a<=_&&r.push(s),r.length===e)break}}}return new StickyScrollWidgetState(r,o)}dispose(){super.dispose(),this._sessionStore.dispose()}};StickyScrollController.ID="store.contrib.stickyScrollController",StickyScrollController=__decorate([__param(1,IContextMenuService),__param(2,ILanguageFeaturesService),__param(3,IInstantiationService)],StickyScrollController);export{StickyScrollController};