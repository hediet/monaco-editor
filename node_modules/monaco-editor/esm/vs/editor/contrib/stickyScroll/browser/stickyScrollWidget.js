var _a,__decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((o=o.apply(e,t||[])).next())}))};import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import*as dom from"../../../../base/browser/dom.js";import{StringBuilder}from"../../../common/core/stringBuilder.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{Position}from"../../../common/core/position.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{getDefinitionsAtPosition}from"../../gotoSymbol/browser/goToSymbol.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{goToDefinitionWithLocation}from"../../inlayHints/browser/inlayHintsLocations.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{Range}from"../../../common/core/range.js";import{StandardMouseEvent}from"../../../../base/browser/mouseEvent.js";import"./stickyScroll.css";import{EmbeddedCodeEditorWidget}from"../../../browser/widget/embeddedCodeEditorWidget.js";export class StickyScrollWidgetState{constructor(e,t){this.lineNumbers=e,this.lastLineRelativePosition=t}}const _ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("stickyScrollViewLayer",{createHTML:e=>e});let StickyScrollWidget=class extends Disposable{constructor(e,t,i){super(),this._editor=e,this._languageFeatureService=t,this._instaService=i,this._rootDomNode=document.createElement("div"),this._disposableStore=this._register(new DisposableStore),this._lineNumbers=[],this._lastLineRelativePosition=0,this._hoverOnLine=-1,this._hoverOnColumn=-1,this._candidateDefinitionsLength=-1,this._layoutInfo=this._editor.getLayoutInfo(),this._rootDomNode=document.createElement("div"),this._rootDomNode.className="sticky-widget",this._rootDomNode.classList.toggle("peek",e instanceof EmbeddedCodeEditorWidget),this._rootDomNode.style.width=this._layoutInfo.width-this._layoutInfo.minimap.minimapCanvasOuterWidth-this._layoutInfo.verticalScrollbarWidth+"px",this._register(this._updateLinkGesture())}_updateLinkGesture(){const e=new DisposableStore,t=new DisposableStore;e.add(t);const i=new ClickLinkGesture(this._editor,!0);return e.add(i),e.add(i.onMouseMoveOrRelevantKeyDown((([e,i])=>{if(!this._editor.hasModel()||!e.hasTriggerModifier)return void t.clear();const o=e.target;if(o.detail===this.getId()&&o.element.innerText===o.element.innerHTML){const e=o.element.innerText;if(-1===this._hoverOnColumn)return;const i=this._hoverOnLine,n=this._hoverOnColumn,r=new Range(i,n,i,n+e.length);if(r.equalsRange(this._stickyRangeProjectedOnEditor)){if("underline"===o.element.style.textDecoration)return}else this._stickyRangeProjectedOnEditor=r,t.clear();const s=new CancellationTokenSource;let a;t.add(toDisposable((()=>s.dispose(!0)))),getDefinitionsAtPosition(this._languageFeatureService.definitionProvider,this._editor.getModel(),new Position(i,n+1),s.token).then((e=>{if(!s.token.isCancellationRequested)if(0!==e.length){this._candidateDefinitionsLength=e.length;const i=o.element;a!==i?(t.clear(),a=i,a.style.textDecoration="underline",t.add(toDisposable((()=>{a.style.textDecoration="none"})))):a||(a=i,a.style.textDecoration="underline",t.add(toDisposable((()=>{a.style.textDecoration="none"}))))}else t.clear()}))}else t.clear()}))),e.add(i.onCancel((()=>{t.clear()}))),e.add(i.onExecute((e=>__awaiter(this,void 0,void 0,(function*(){if(e.target.detail===this.getId())if(e.hasTriggerModifier)this._candidateDefinitionsLength>1&&this._editor.revealPosition({lineNumber:this._hoverOnLine,column:1}),this._instaService.invokeFunction(goToDefinitionWithLocation,e,this._editor,{uri:this._editor.getModel().uri,range:this._stickyRangeProjectedOnEditor});else if(!e.isRightClick){const e={lineNumber:this._hoverOnLine,column:this._hoverOnColumn};this._editor.revealPosition(e),this._editor.setSelection(Range.fromPositions(e)),this._editor.focus()}}))))),e}getCurrentLines(){return this._lineNumbers}setState(e){this._disposableStore.clear(),this._lineNumbers.length=0,dom.clearNode(this._rootDomNode),this._lastLineRelativePosition=e.lastLineRelativePosition,this._lineNumbers=e.lineNumbers,this._renderRootNode()}_renderChildNode(e,t){const i=document.createElement("div"),o=this._editor._getViewModel(),n=o.coordinatesConverter.convertModelPositionToViewPosition(new Position(t,1)).lineNumber,r=o.getViewLineRenderingData(n),s=this._editor.getLayoutInfo(),a=s.width-s.minimap.minimapCanvasOuterWidth-s.verticalScrollbarWidth,l=this._editor.getOption(69).side,d=this._editor.getOption(63),c=this._editor.getOption(64);let h;try{h=LineDecoration.filter(r.inlineDecorations,n,r.minColumn,r.maxColumn)}catch(e){h=[]}const m=new RenderLineInput(!0,!0,r.content,r.continuesWithWrappedLine,r.isBasicASCII,r.containsRTL,0,r.tokens,h,r.tabSize,r.startVisibleColumn,1,1,1,500,"none",!0,!0,null),u=new StringBuilder(2e3);let _;renderViewLine(m,u),_=_ttPolicy?_ttPolicy.createHTML(u.build()):u.build();const p=document.createElement("span");p.className="sticky-line",p.classList.add(`stickyLine${t}`),p.style.lineHeight=`${d}px`,p.innerHTML=_;const g=document.createElement("span");g.className="sticky-line",g.style.lineHeight=`${d}px`,"left"===l?g.style.width=s.contentLeft-s.minimap.minimapCanvasOuterWidth+"px":"right"===l&&(g.style.width=`${s.contentLeft}px`);const f=document.createElement("span");return 1===c.renderType||3===c.renderType&&t%10==0?f.innerText=t.toString():2===c.renderType&&(f.innerText=Math.abs(t-this._editor.getPosition().lineNumber).toString()),f.className="sticky-line-number",f.style.lineHeight=`${d}px`,f.style.width=`${s.lineNumbersWidth}px`,"left"===l?f.style.paddingLeft=s.lineNumbersLeft-s.minimap.minimapCanvasOuterWidth+"px":"right"===l&&(f.style.paddingLeft=`${s.lineNumbersLeft}px`),g.appendChild(f),this._editor.applyFontInfo(p),this._editor.applyFontInfo(f),i.appendChild(g),i.appendChild(p),i.className="sticky-line-root",i.style.lineHeight=`${d}px`,i.style.width=`${a}px`,i.style.height=`${d}px`,i.style.zIndex="0",e===this._lineNumbers.length-1&&(i.style.position="relative",i.style.zIndex="-1",i.style.top=this._lastLineRelativePosition+"px"),this._disposableStore.add(dom.addDisposableListener(i,"mouseover",(e=>{if(this._editor.hasModel()){const i=new StandardMouseEvent(e).target.innerText;this._hoverOnLine=t,this._hoverOnColumn=this._editor.getModel().getLineContent(t).indexOf(i)+1||-1}}))),i}_renderRootNode(){if(!this._editor._getViewModel())return;for(const[e,t]of this._lineNumbers.entries())this._rootDomNode.appendChild(this._renderChildNode(e,t));const e=this._editor.getOption(63),t=this._lineNumbers.length*e+this._lastLineRelativePosition;this._rootDomNode.style.height=t.toString()+"px","left"===this._editor.getOption(69).side&&(this._rootDomNode.style.marginLeft=this._editor.getLayoutInfo().minimap.minimapCanvasOuterWidth+"px")}getId(){return"editor.contrib.stickyScrollWidget"}getDomNode(){return this._rootDomNode}getPosition(){return{preference:null}}};StickyScrollWidget=__decorate([__param(1,ILanguageFeaturesService),__param(2,IInstantiationService)],StickyScrollWidget);export{StickyScrollWidget};