var __decorate=this&&this.__decorate||function(e,t,i,n){var r,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var l=e.length-1;l>=0;l--)(r=e[l])&&(s=(o<3?r(s):o>3?r(t,i,s):r(t,i))||s);return o>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,o){function s(e){try{a(n.next(e))}catch(e){o(e)}}function l(e){try{a(n.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}a((n=n.apply(e,t||[])).next())}))};import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{OutlineModel,OutlineElement,OutlineGroup}from"../../documentSymbols/browser/outlineModel.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{RunOnceScheduler}from"../../../../base/common/async.js";import{Emitter}from"../../../../base/common/event.js";import{binarySearch}from"../../../../base/common/arrays.js";import{Iterable}from"../../../../base/common/iterator.js";import{FoldingController}from"../../folding/browser/folding.js";import{isEqual}from"../../../../base/common/resources.js";export class StickyRange{constructor(e,t){this.startLineNumber=e,this.endLineNumber=t}}export class StickyLineCandidate{constructor(e,t,i){this.startLineNumber=e,this.endLineNumber=t,this.nestingDepth=i}}let StickyLineCandidateProvider=class extends Disposable{constructor(e,t){super(),this._onDidChangeStickyScroll=this._store.add(new Emitter),this.onDidChangeStickyScroll=this._onDidChangeStickyScroll.event,this._sessionStore=new DisposableStore,this._editor=e,this._languageFeaturesService=t,this._updateSoon=this._register(new RunOnceScheduler((()=>this.update()),50)),this._register(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(109)&&this.readConfiguration()}))),this.readConfiguration()}dispose(){super.dispose(),this._sessionStore.dispose()}readConfiguration(){!1!==this._editor.getOption(109).enabled?(this._sessionStore.add(this._editor.onDidChangeModel((()=>{this.update()}))),this._sessionStore.add(this._editor.onDidChangeHiddenAreas((()=>this.update()))),this._sessionStore.add(this._editor.onDidChangeModelContent((()=>this._updateSoon.schedule()))),this._sessionStore.add(this._languageFeaturesService.documentSymbolProvider.onDidChange((()=>{this.update()}))),this.update()):this._sessionStore.clear()}getVersionId(){var e;return null===(e=this._model)||void 0===e?void 0:e.version}update(){var e;return __awaiter(this,void 0,void 0,(function*(){null===(e=this._cts)||void 0===e||e.dispose(!0),this._cts=new CancellationTokenSource,yield this.updateOutlineModel(this._cts.token),this._onDidChangeStickyScroll.fire()}))}updateOutlineModel(e){var t;return __awaiter(this,void 0,void 0,(function*(){if(!this._editor.hasModel())return;const i=this._editor.getModel(),n=i.getVersionId(),r=this._model&&!isEqual(this._model.uri,i.uri)?setTimeout((()=>{e.isCancellationRequested||(this._model=new StickyOutlineModel(i.uri,i.getVersionId(),void 0,void 0),this._onDidChangeStickyScroll.fire())}),75):void 0,o=yield OutlineModel.create(this._languageFeaturesService.documentSymbolProvider,i,e);if(!e.isCancellationRequested){if(0!==o.children.size){const{stickyOutlineElement:e,providerID:r}=StickyOutlineElement.fromOutlineModel(o,null===(t=this._model)||void 0===t?void 0:t.outlineProviderId);this._model=new StickyOutlineModel(i.uri,n,e,r)}else{const t=FoldingController.get(this._editor),r=yield null==t?void 0:t.getFoldingModel();if(e.isCancellationRequested)return;if(r&&0!==r.regions.length){const e=StickyOutlineElement.fromFoldingModel(r);this._model=new StickyOutlineModel(i.uri,n,e,void 0)}else this._model=void 0}clearTimeout(r)}}))}updateIndex(e){return-1===e?e=0:e<0&&(e=-e-2),e}getCandidateStickyLinesIntersectingFromOutline(e,t,i,n,r){if(0===t.children.length)return;let o=r;const s=[];for(let e=0;e<t.children.length;e++){const i=t.children[e];i.range&&s.push(i.range.startLineNumber)}const l=this.updateIndex(binarySearch(s,e.startLineNumber,((e,t)=>e-t))),a=this.updateIndex(binarySearch(s,e.startLineNumber+n,((e,t)=>e-t)));for(let s=l;s<=a;s++){const l=t.children[s];if(!l)return;if(l.range){const t=l.range.startLineNumber,r=l.range.endLineNumber;e.startLineNumber<=r+1&&t-1<=e.endLineNumber&&t!==o&&(o=t,i.push(new StickyLineCandidate(t,r-1,n+1)),this.getCandidateStickyLinesIntersectingFromOutline(e,l,i,n+1,t))}else this.getCandidateStickyLinesIntersectingFromOutline(e,l,i,n,r)}}getCandidateStickyLinesIntersecting(e){var t,i;if(!(null===(t=this._model)||void 0===t?void 0:t.element))return[];let n=[];this.getCandidateStickyLinesIntersectingFromOutline(e,this._model.element,n,0,-1);const r=null===(i=this._editor._getViewModel())||void 0===i?void 0:i.getHiddenAreas();if(r)for(const e of r)n=n.filter((t=>!(t.startLineNumber>=e.startLineNumber&&t.endLineNumber<=e.endLineNumber+1)));return n}};StickyLineCandidateProvider=__decorate([__param(1,ILanguageFeaturesService)],StickyLineCandidateProvider);export{StickyLineCandidateProvider};class StickyOutlineElement{static comparator(e,t){return e.startLineNumber!==t.startLineNumber?e.startLineNumber-t.startLineNumber:t.endLineNumber-e.endLineNumber}static fromOutlineElement(e,t){const i=[];for(const n of e.children.values())if(n.symbol.selectionRange.startLineNumber!==n.symbol.range.endLineNumber)if(n.symbol.selectionRange.startLineNumber!==t)i.push(StickyOutlineElement.fromOutlineElement(n,n.symbol.selectionRange.startLineNumber));else for(const e of n.children.values())i.push(StickyOutlineElement.fromOutlineElement(e,n.symbol.selectionRange.startLineNumber));i.sort(((e,t)=>this.comparator(e.range,t.range)));const n=new StickyRange(e.symbol.selectionRange.startLineNumber,e.symbol.range.endLineNumber);return new StickyOutlineElement(n,i,void 0)}static fromOutlineModel(e,t){let i;if(Iterable.first(e.children.values())instanceof OutlineGroup){const n=Iterable.find(e.children.values(),(e=>e.id===t));if(n)i=n.children;else{let n,r="",o=-1;for(const[t,i]of e.children.entries()){const e=StickyOutlineElement.findSumOfRangesOfGroup(i);e>o&&(n=i,o=e,r=i.id)}t=r,i=n.children}}else i=e.children;const n=[],r=Array.from(i.values()).sort(((e,t)=>{const i=new StickyRange(e.symbol.range.startLineNumber,e.symbol.range.endLineNumber),n=new StickyRange(t.symbol.range.startLineNumber,t.symbol.range.endLineNumber);return this.comparator(i,n)}));for(const e of r)n.push(StickyOutlineElement.fromOutlineElement(e,e.symbol.selectionRange.startLineNumber));return{stickyOutlineElement:new StickyOutlineElement(void 0,n,void 0),providerID:t}}static findSumOfRangesOfGroup(e){let t=0;for(const i of e.children.values())t+=this.findSumOfRangesOfGroup(i);return e instanceof OutlineElement?t+e.symbol.range.endLineNumber-e.symbol.selectionRange.startLineNumber:t}static fromFoldingModel(e){const t=e.regions,i=t.length;let n;const r=[],o=new StickyOutlineElement(void 0,[],void 0);let s=o;for(let e=0;e<i;e++){for(n=new StickyRange(t.getStartLineNumber(e),t.getEndLineNumber(e)+1);0!==r.length&&(n.startLineNumber<r[r.length-1].startLineNumber||n.endLineNumber>r[r.length-1].endLineNumber);)r.pop(),void 0!==s.parent&&(s=s.parent);const i=new StickyOutlineElement(n,[],s);s.children.push(i),s=i,r.push(n)}return o}constructor(e,t,i){this.range=e,this.children=t,this.parent=i}}class StickyOutlineModel{constructor(e,t,i,n){this.uri=e,this.version=t,this.element=i,this.outlineProviderId=n}}