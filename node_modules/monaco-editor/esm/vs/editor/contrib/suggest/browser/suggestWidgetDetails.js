var __decorate=this&&this.__decorate||function(e,t,i,o){var s,d=arguments.length,n=d<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,o);else for(var h=e.length-1;h>=0;h--)(s=e[h])&&(n=(d<3?s(n):d>3?s(t,i,n):s(t,i))||n);return d>3&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import*as dom from"../../../../base/browser/dom.js";import{DomScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{Codicon}from"../../../../base/common/codicons.js";import{ThemeIcon}from"../../../../base/common/themables.js";import{Emitter}from"../../../../base/common/event.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{ResizableHTMLElement}from"../../../../base/browser/ui/resizable/resizable.js";import*as nls from"../../../../nls.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";export function canExpandCompletionItem(e){return!!e&&Boolean(e.completion.documentation||e.completion.detail&&e.completion.detail!==e.completion.label)}let SuggestDetailsWidget=class{constructor(e,t){this._editor=e,this._onDidClose=new Emitter,this.onDidClose=this._onDidClose.event,this._onDidChangeContents=new Emitter,this.onDidChangeContents=this._onDidChangeContents.event,this._disposables=new DisposableStore,this._renderDisposeable=new DisposableStore,this._borderWidth=1,this._size=new dom.Dimension(330,0),this.domNode=dom.$(".suggest-details"),this.domNode.classList.add("no-docs"),this._markdownRenderer=t.createInstance(MarkdownRenderer,{editor:e}),this._body=dom.$(".body"),this._scrollbar=new DomScrollableElement(this._body,{alwaysConsumeMouseWheel:!0}),dom.append(this.domNode,this._scrollbar.getDomNode()),this._disposables.add(this._scrollbar),this._header=dom.append(this._body,dom.$(".header")),this._close=dom.append(this._header,dom.$("span"+ThemeIcon.asCSSSelector(Codicon.close))),this._close.title=nls.localize("details.close","Close"),this._type=dom.append(this._header,dom.$("p.type")),this._docs=dom.append(this._body,dom.$("p.docs")),this._configureFont(),this._disposables.add(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(47)&&this._configureFont()})))}dispose(){this._disposables.dispose(),this._renderDisposeable.dispose()}_configureFont(){const e=this._editor.getOptions(),t=e.get(47),i=t.getMassagedFontFamily(),o=e.get(113)||t.fontSize,s=e.get(114)||t.lineHeight,d=t.fontWeight,n=`${o}px`,h=`${s}px`;this.domNode.style.fontSize=n,this.domNode.style.lineHeight=""+s/o,this.domNode.style.fontWeight=d,this.domNode.style.fontFeatureSettings=t.fontFeatureSettings,this._type.style.fontFamily=i,this._close.style.height=h,this._close.style.width=h}getLayoutInfo(){const e=this._editor.getOption(114)||this._editor.getOption(47).lineHeight,t=this._borderWidth;return{lineHeight:e,borderWidth:t,borderHeight:2*t,verticalPadding:22,horizontalPadding:14}}renderLoading(){this._type.textContent=nls.localize("loading","Loading..."),this._docs.textContent="",this.domNode.classList.remove("no-docs","no-type"),this.layout(this.size.width,2*this.getLayoutInfo().lineHeight),this._onDidChangeContents.fire(this)}renderItem(e,t){var i,o;this._renderDisposeable.clear();let{detail:s,documentation:d}=e.completion;if(t){let t="";t+=`score: ${e.score[0]}\n`,t+=`prefix: ${null!==(i=e.word)&&void 0!==i?i:"(no prefix)"}\n`,t+=`word: ${e.completion.filterText?e.completion.filterText+" (filterText)":e.textLabel}\n`,t+=`distance: ${e.distance} (localityBonus-setting)\n`,t+=`index: ${e.idx}, based on ${e.completion.sortText&&`sortText: "${e.completion.sortText}"`||"label"}\n`,t+=`commit_chars: ${null===(o=e.completion.commitCharacters)||void 0===o?void 0:o.join("")}\n`,d=(new MarkdownString).appendCodeblock("empty",t),s=`Provider: ${e.provider._debugDisplayName}`}if(t||canExpandCompletionItem(e)){if(this.domNode.classList.remove("no-docs","no-type"),s){const e=s.length>1e5?`${s.substr(0,1e5)}â€¦`:s;this._type.textContent=e,this._type.title=e,dom.show(this._type),this._type.classList.toggle("auto-wrap",!/\r?\n^\s+/gim.test(e))}else dom.clearNode(this._type),this._type.title="",dom.hide(this._type),this.domNode.classList.add("no-type");if(dom.clearNode(this._docs),"string"==typeof d)this._docs.classList.remove("markdown-docs"),this._docs.textContent=d;else if(d){this._docs.classList.add("markdown-docs"),dom.clearNode(this._docs);const e=this._markdownRenderer.render(d);this._docs.appendChild(e.element),this._renderDisposeable.add(e),this._renderDisposeable.add(this._markdownRenderer.onDidRenderAsync((()=>{this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)})))}this.domNode.style.userSelect="text",this.domNode.tabIndex=-1,this._close.onmousedown=e=>{e.preventDefault(),e.stopPropagation()},this._close.onclick=e=>{e.preventDefault(),e.stopPropagation(),this._onDidClose.fire()},this._body.scrollTop=0,this.layout(this._size.width,this._type.clientHeight+this._docs.clientHeight),this._onDidChangeContents.fire(this)}else this.clearContents()}clearContents(){this.domNode.classList.add("no-docs"),this._type.textContent="",this._docs.textContent=""}get size(){return this._size}layout(e,t){const i=new dom.Dimension(e,t);dom.Dimension.equals(i,this._size)||(this._size=i,dom.size(this.domNode,e,t)),this._scrollbar.scanDomNode()}scrollDown(e=8){this._body.scrollTop+=e}scrollUp(e=8){this._body.scrollTop-=e}scrollTop(){this._body.scrollTop=0}scrollBottom(){this._body.scrollTop=this._body.scrollHeight}pageDown(){this.scrollDown(80)}pageUp(){this.scrollUp(80)}set borderWidth(e){this._borderWidth=e}get borderWidth(){return this._borderWidth}};SuggestDetailsWidget=__decorate([__param(1,IInstantiationService)],SuggestDetailsWidget);export{SuggestDetailsWidget};export class SuggestDetailsOverlay{constructor(e,t){let i,o;this.widget=e,this._editor=t,this._disposables=new DisposableStore,this._added=!1,this._preferAlignAtTop=!0,this._resizable=new ResizableHTMLElement,this._resizable.domNode.classList.add("suggest-details-container"),this._resizable.domNode.appendChild(e.domNode),this._resizable.enableSashes(!1,!0,!0,!1);let s=0,d=0;this._disposables.add(this._resizable.onDidWillResize((()=>{i=this._topLeft,o=this._resizable.size}))),this._disposables.add(this._resizable.onDidResize((e=>{if(i&&o){this.widget.layout(e.dimension.width,e.dimension.height);let t=!1;e.west&&(d=o.width-e.dimension.width,t=!0),e.north&&(s=o.height-e.dimension.height,t=!0),t&&this._applyTopLeft({top:i.top+s,left:i.left+d})}e.done&&(i=void 0,o=void 0,s=0,d=0,this._userSize=e.dimension)}))),this._disposables.add(this.widget.onDidChangeContents((()=>{var e;this._anchorBox&&this._placeAtAnchor(this._anchorBox,null!==(e=this._userSize)&&void 0!==e?e:this.widget.size,this._preferAlignAtTop)})))}dispose(){this._resizable.dispose(),this._disposables.dispose(),this.hide()}getId(){return"suggest.details"}getDomNode(){return this._resizable.domNode}getPosition(){return null}show(){this._added||(this._editor.addOverlayWidget(this),this.getDomNode().style.position="fixed",this._added=!0)}hide(e=!1){this._resizable.clearSashHoverState(),this._added&&(this._editor.removeOverlayWidget(this),this._added=!1,this._anchorBox=void 0,this._topLeft=void 0),e&&(this._userSize=void 0,this.widget.clearContents())}placeAtAnchor(e,t){var i;const o=e.getBoundingClientRect();this._anchorBox=o,this._preferAlignAtTop=t,this._placeAtAnchor(this._anchorBox,null!==(i=this._userSize)&&void 0!==i?i:this.widget.size,t)}_placeAtAnchor(e,t,i){var o;const s=dom.getClientArea(document.body),d=this.widget.getLayoutInfo(),n=new dom.Dimension(220,2*d.lineHeight),h=e.top,r=function(){const i=s.width-(e.left+e.width+d.borderWidth+d.horizontalPadding),o=-d.borderWidth+e.left+e.width,r=new dom.Dimension(i,s.height-e.top-d.borderHeight-d.verticalPadding),a=r.with(void 0,e.top+e.height-d.borderHeight-d.verticalPadding);return{top:h,left:o,fit:i-t.width,maxSizeTop:r,maxSizeBottom:a,minSize:n.with(Math.min(i,n.width))}}(),a=[r,function(){const i=e.left-d.borderWidth-d.horizontalPadding,o=Math.max(d.horizontalPadding,e.left-t.width-d.borderWidth),r=new dom.Dimension(i,s.height-e.top-d.borderHeight-d.verticalPadding),a=r.with(void 0,e.top+e.height-d.borderHeight-d.verticalPadding);return{top:h,left:o,fit:i-t.width,maxSizeTop:r,maxSizeBottom:a,minSize:n.with(Math.min(i,n.width))}}(),function(){const i=e.left,o=-d.borderWidth+e.top+e.height,h=new dom.Dimension(e.width-d.borderHeight,s.height-e.top-e.height-d.verticalPadding);return{top:o,left:i,fit:h.height-t.height,maxSizeBottom:h,maxSizeTop:h,minSize:n.with(h.width)}}()],l=null!==(o=a.find((e=>e.fit>=0)))&&void 0!==o?o:a.sort(((e,t)=>t.fit-e.fit))[0],m=e.top+e.height-d.borderHeight;let c,p=t.height;const _=Math.max(l.maxSizeTop.height,l.maxSizeBottom.height);let g;p>_&&(p=_),i?p<=l.maxSizeTop.height?(c=!0,g=l.maxSizeTop):(c=!1,g=l.maxSizeBottom):p<=l.maxSizeBottom.height?(c=!1,g=l.maxSizeBottom):(c=!0,g=l.maxSizeTop),this._applyTopLeft({left:l.left,top:c?l.top:m-p}),this.getDomNode().style.position="fixed",this._resizable.enableSashes(!c,l===r,c,l!==r),this._resizable.minSize=l.minSize,this._resizable.maxSize=g,this._resizable.layout(p,Math.min(g.width,t.width)),this.widget.layout(this._resizable.size.width,this._resizable.size.height)}_applyTopLeft(e){this._topLeft=e,this.getDomNode().style.left=`${this._topLeft.left}px`,this.getDomNode().style.top=`${this._topLeft.top}px`}}