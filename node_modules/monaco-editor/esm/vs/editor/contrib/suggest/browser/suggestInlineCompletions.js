var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var l=e.length-1;l>=0;l--)(n=e[l])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function s(e){try{a(i.next(e))}catch(e){r(e)}}function l(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,l)}a((i=i.apply(e,t||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{FuzzyScore}from"../../../../base/common/filters.js";import{Iterable}from"../../../../base/common/iterator.js";import{RefCountedDisposable}from"../../../../base/common/lifecycle.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{Range}from"../../../common/core/range.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{CompletionItemInsertTextRule}from"../../../common/standalone/standaloneEnums.js";import{CompletionModel,LineContext}from"./completionModel.js";import{CompletionOptions,provideSuggestionItems,QuickSuggestionsOptions}from"./suggest.js";import{ISuggestMemoryService}from"./suggestMemory.js";import{WordDistance}from"./wordDistance.js";import{IClipboardService}from"../../../../platform/clipboard/common/clipboardService.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";class SuggestInlineCompletion{constructor(e,t,o,i,n,r){this.range=e,this.insertText=t,this.filterText=o,this.additionalTextEdits=i,this.command=n,this.completion=r}}let InlineCompletionResults=class extends RefCountedDisposable{constructor(e,t,o,i,n,r){super(n.disposable),this.model=e,this.line=t,this.word=o,this.completionModel=i,this._suggestMemoryService=r}canBeReused(e,t,o){return this.model===e&&this.line===t&&this.word.word.length>0&&this.word.startColumn===o.startColumn&&this.word.endColumn<o.endColumn&&0===this.completionModel.getIncompleteProvider().size}get items(){var e;const t=[],{items:o}=this.completionModel,i=this._suggestMemoryService.select(this.model,{lineNumber:this.line,column:this.word.endColumn+this.completionModel.lineContext.characterCountDelta},o),n=Iterable.slice(o,i),r=Iterable.slice(o,0,i);let s=5;for(const o of Iterable.concat(n,r)){if(o.score===FuzzyScore.Default)continue;const i=new Range(o.editStart.lineNumber,o.editStart.column,o.editInsertEnd.lineNumber,o.editInsertEnd.column+this.completionModel.lineContext.characterCountDelta),n=o.completion.insertTextRules&&o.completion.insertTextRules&CompletionItemInsertTextRule.InsertAsSnippet?{snippet:o.completion.insertText}:o.completion.insertText;t.push(new SuggestInlineCompletion(i,n,null!==(e=o.filterTextLow)&&void 0!==e?e:o.labelLow,o.completion.additionalTextEdits,o.completion.command,o)),s-- >=0&&o.resolve(CancellationToken.None)}return t}};InlineCompletionResults=__decorate([__param(5,ISuggestMemoryService)],InlineCompletionResults);let SuggestInlineCompletions=class{constructor(e,t,o,i){this._getEditorOption=e,this._languageFeatureService=t,this._clipboardService=o,this._suggestMemoryService=i}provideInlineCompletions(e,t,o,i){var n;return __awaiter(this,void 0,void 0,(function*(){if(o.selectedSuggestionInfo)return;const r=this._getEditorOption(84,e);if(QuickSuggestionsOptions.isAllOff(r))return;e.tokenization.tokenizeIfCheap(t.lineNumber);const s=e.tokenization.getLineTokens(t.lineNumber),l=s.getStandardTokenType(s.findTokenIndexAtOffset(Math.max(t.column-1-1,0)));if("inline"!==QuickSuggestionsOptions.valueFor(r,l))return;let a,c,m=e.getWordAtPosition(t);if((null==m?void 0:m.word)||(a=this._getTriggerCharacterInfo(e,t)),!(null==m?void 0:m.word)&&!a)return;if(m||(m=e.getWordUntilPosition(t)),m.endColumn!==t.column)return;const u=e.getValueInRange(new Range(t.lineNumber,1,t.lineNumber,t.column));if(!a&&(null===(n=this._lastResult)||void 0===n?void 0:n.canBeReused(e,t.lineNumber,m))){const e=new LineContext(u,t.column-this._lastResult.word.endColumn);this._lastResult.completionModel.lineContext=e,this._lastResult.acquire(),c=this._lastResult}else{const o=yield provideSuggestionItems(this._languageFeatureService.completionProvider,e,t,new CompletionOptions(void 0,void 0,null==a?void 0:a.providers),a&&{triggerKind:1,triggerCharacter:a.ch},i);let n;o.needsClipboard&&(n=yield this._clipboardService.readText());const r=new CompletionModel(o.items,t.column,new LineContext(u,0),WordDistance.None,this._getEditorOption(112,e),this._getEditorOption(106,e),{boostFullMatch:!1,firstMatchCanBeWeak:!1},n);c=new InlineCompletionResults(e,t.lineNumber,m,r,o,this._suggestMemoryService)}return this._lastResult=c,c}))}handleItemDidShow(e,t){t.completion.resolve(CancellationToken.None)}freeInlineCompletions(e){e.release()}_getTriggerCharacterInfo(e,t){var o;const i=e.getValueInRange(Range.fromPositions({lineNumber:t.lineNumber,column:t.column-1},t)),n=new Set;for(const t of this._languageFeatureService.completionProvider.all(e))(null===(o=t.triggerCharacters)||void 0===o?void 0:o.includes(i))&&n.add(t);if(0!==n.size)return{providers:n,ch:i}}};SuggestInlineCompletions=__decorate([__param(1,ILanguageFeaturesService),__param(2,IClipboardService),__param(3,ISuggestMemoryService)],SuggestInlineCompletions);export{SuggestInlineCompletions};let EditorContribution=class e{constructor(t,o,i,n){if(1==++e._counter){const r=n.createInstance(SuggestInlineCompletions,((e,o)=>{var n;return(null!==(n=i.listCodeEditors().find((e=>e.getModel()===o)))&&void 0!==n?n:t).getOption(e)}));e._disposable=o.inlineCompletionsProvider.register("*",r)}}dispose(){var t;0==--e._counter&&(null===(t=e._disposable)||void 0===t||t.dispose(),e._disposable=void 0)}};EditorContribution._counter=0,EditorContribution=__decorate([__param(1,ILanguageFeaturesService),__param(2,ICodeEditorService),__param(3,IInstantiationService)],EditorContribution),registerEditorContribution("suggest.inlineCompletionsProvider",EditorContribution,0);