var __awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(s,n){function r(e){try{l(i.next(e))}catch(e){n(e)}}function a(e){try{l(i.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(r,a)}l((i=i.apply(e,t||[])).next())}))};import{CancellationToken}from"../../../../base/common/cancellation.js";import{CancellationError,isCancellationError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{FuzzyScore}from"../../../../base/common/filters.js";import{DisposableStore,isDisposable}from"../../../../base/common/lifecycle.js";import{StopWatch}from"../../../../base/common/stopwatch.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{SnippetParser}from"../../snippet/browser/snippetParser.js";import{localize}from"../../../../nls.js";import{MenuId}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{historyNavigationVisible}from"../../../../platform/history/browser/contextScopedHistoryWidget.js";export const Context={Visible:historyNavigationVisible,HasFocusedSuggestion:new RawContextKey("suggestWidgetHasFocusedSuggestion",!1,localize("suggestWidgetHasSelection","Whether any suggestion is focused")),DetailsVisible:new RawContextKey("suggestWidgetDetailsVisible",!1,localize("suggestWidgetDetailsVisible","Whether suggestion details are visible")),MultipleSuggestions:new RawContextKey("suggestWidgetMultipleSuggestions",!1,localize("suggestWidgetMultipleSuggestions","Whether there are multiple suggestions to pick from")),MakesTextEdit:new RawContextKey("suggestionMakesTextEdit",!0,localize("suggestionMakesTextEdit","Whether inserting the current suggestion yields in a change or has everything already been typed")),AcceptSuggestionsOnEnter:new RawContextKey("acceptSuggestionOnEnter",!0,localize("acceptSuggestionOnEnter","Whether suggestions are inserted when pressing Enter")),HasInsertAndReplaceRange:new RawContextKey("suggestionHasInsertAndReplaceRange",!1,localize("suggestionHasInsertAndReplaceRange","Whether the current suggestion has insert and replace behaviour")),InsertMode:new RawContextKey("suggestionInsertMode",void 0,{type:"string",description:localize("suggestionInsertMode","Whether the default behaviour is to insert or replace")}),CanResolve:new RawContextKey("suggestionCanResolve",!1,localize("suggestionCanResolve","Whether the current suggestion supports to resolve further details"))};export const suggestWidgetStatusbarMenu=new MenuId("suggestWidgetStatusBar");export class CompletionItem{constructor(e,t,o,i){this.position=e,this.completion=t,this.container=o,this.provider=i,this.isInvalid=!1,this.score=FuzzyScore.Default,this.distance=0,this.textLabel="string"==typeof t.label?t.label:t.label.label,this.labelLow=this.textLabel.toLowerCase(),this.isInvalid=!this.textLabel,this.sortTextLow=t.sortText&&t.sortText.toLowerCase(),this.filterTextLow=t.filterText&&t.filterText.toLowerCase(),this.extensionId=t.extensionId,Range.isIRange(t.range)?(this.editStart=new Position(t.range.startLineNumber,t.range.startColumn),this.editInsertEnd=new Position(t.range.endLineNumber,t.range.endColumn),this.editReplaceEnd=new Position(t.range.endLineNumber,t.range.endColumn),this.isInvalid=this.isInvalid||Range.spansMultipleLines(t.range)||t.range.startLineNumber!==e.lineNumber):(this.editStart=new Position(t.range.insert.startLineNumber,t.range.insert.startColumn),this.editInsertEnd=new Position(t.range.insert.endLineNumber,t.range.insert.endColumn),this.editReplaceEnd=new Position(t.range.replace.endLineNumber,t.range.replace.endColumn),this.isInvalid=this.isInvalid||Range.spansMultipleLines(t.range.insert)||Range.spansMultipleLines(t.range.replace)||t.range.insert.startLineNumber!==e.lineNumber||t.range.replace.startLineNumber!==e.lineNumber||t.range.insert.startColumn!==t.range.replace.startColumn),"function"!=typeof i.resolveCompletionItem&&(this._resolveCache=Promise.resolve(),this._isResolved=!0)}get isResolved(){return!!this._isResolved}resolve(e){return __awaiter(this,void 0,void 0,(function*(){if(!this._resolveCache){const t=e.onCancellationRequested((()=>{this._resolveCache=void 0,this._isResolved=!1}));this._resolveCache=Promise.resolve(this.provider.resolveCompletionItem(this.completion,e)).then((e=>{Object.assign(this.completion,e),this._isResolved=!0,t.dispose()}),(e=>{isCancellationError(e)&&(this._resolveCache=void 0,this._isResolved=!1)}))}return this._resolveCache}))}}class CompletionOptions{constructor(e=2,t=new Set,o=new Set,i=new Map,s=!0){this.snippetSortOrder=e,this.kindFilter=t,this.providerFilter=o,this.providerItemsToReuse=i,this.showDeprecated=s}}CompletionOptions.default=new CompletionOptions;export{CompletionOptions};let _snippetSuggestSupport;export function getSnippetSuggestSupport(){return _snippetSuggestSupport}export class CompletionItemModel{constructor(e,t,o,i){this.items=e,this.needsClipboard=t,this.durations=o,this.disposable=i}}export function provideSuggestionItems(e,t,o,i=CompletionOptions.default,s={triggerKind:0},n=CancellationToken.None){return __awaiter(this,void 0,void 0,(function*(){const r=new StopWatch(!0);o=o.clone();const a=t.getWordAtPosition(o),l=a?new Range(o.lineNumber,a.startColumn,o.lineNumber,a.endColumn):Range.fromPositions(o),p={replace:l,insert:l.setEndPosition(o.lineNumber,o.column)},u=[],c=new DisposableStore,d=[];let g=!1;const m=(e,t,s)=>{var n,r,a;let l=!1;if(!t)return l;for(const s of t.suggestions)if(!i.kindFilter.has(s.kind)){if(!i.showDeprecated&&(null===(n=null==s?void 0:s.tags)||void 0===n?void 0:n.includes(1)))continue;s.range||(s.range=p),s.sortText||(s.sortText="string"==typeof s.label?s.label:s.label.label),!g&&s.insertTextRules&&4&s.insertTextRules&&(g=SnippetParser.guessNeedsClipboard(s.insertText)),u.push(new CompletionItem(o,s,t,e)),l=!0}return isDisposable(t)&&c.add(t),d.push({providerName:null!==(r=e._debugDisplayName)&&void 0!==r?r:"unknown_provider",elapsedProvider:null!==(a=t.duration)&&void 0!==a?a:-1,elapsedOverall:s.elapsed()}),l},h=(()=>__awaiter(this,void 0,void 0,(function*(){if(!_snippetSuggestSupport||i.kindFilter.has(27))return;if(i.providerFilter.size>0&&!i.providerFilter.has(_snippetSuggestSupport))return;const e=new StopWatch(!0),r=yield _snippetSuggestSupport.provideCompletionItems(t,o,s,n);m(_snippetSuggestSupport,r,e)})))();for(const r of e.orderedGroups(t)){let e=!1;if(yield Promise.all(r.map((r=>__awaiter(this,void 0,void 0,(function*(){if(i.providerItemsToReuse.has(r)){const t=i.providerItemsToReuse.get(r);return t.forEach((e=>u.push(e))),void(e=e||t.length>0)}if(!(i.providerFilter.size>0)||i.providerFilter.has(r))try{const i=new StopWatch(!0),a=yield r.provideCompletionItems(t,o,s,n);e=m(r,a,i)||e}catch(e){onUnexpectedExternalError(e)}}))))),e||n.isCancellationRequested)break}return yield h,n.isCancellationRequested?(c.dispose(),Promise.reject(new CancellationError)):new CompletionItemModel(u.sort(getSuggestionComparator(i.snippetSortOrder)),g,{entries:d,elapsed:r.elapsed()},c)}))}function defaultComparator(e,t){if(e.sortTextLow&&t.sortTextLow){if(e.sortTextLow<t.sortTextLow)return-1;if(e.sortTextLow>t.sortTextLow)return 1}return e.textLabel<t.textLabel?-1:e.textLabel>t.textLabel?1:e.completion.kind-t.completion.kind}function snippetUpComparator(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return-1;if(27===t.completion.kind)return 1}return defaultComparator(e,t)}function snippetDownComparator(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return 1;if(27===t.completion.kind)return-1}return defaultComparator(e,t)}const _snippetComparators=new Map;_snippetComparators.set(0,snippetUpComparator),_snippetComparators.set(2,snippetDownComparator),_snippetComparators.set(1,defaultComparator);export function getSuggestionComparator(e){return _snippetComparators.get(e)}CommandsRegistry.registerCommand("_executeCompletionItemProvider",((e,...t)=>__awaiter(void 0,void 0,void 0,(function*(){const[o,i,s,n]=t;assertType(URI.isUri(o)),assertType(Position.isIPosition(i)),assertType("string"==typeof s||!s),assertType("number"==typeof n||!n);const{completionProvider:r}=e.get(ILanguageFeaturesService),a=yield e.get(ITextModelService).createModelReference(o);try{const e={incomplete:!1,suggestions:[]},t=[],o=yield provideSuggestionItems(r,a.object.textEditorModel,Position.lift(i),void 0,{triggerCharacter:null!=s?s:void 0,triggerKind:s?1:0});for(const i of o.items)t.length<(null!=n?n:0)&&t.push(i.resolve(CancellationToken.None)),e.incomplete=e.incomplete||i.container.incomplete,e.suggestions.push(i.completion);try{return yield Promise.all(t),e}finally{setTimeout((()=>o.disposable.dispose()),100)}}finally{a.dispose()}}))));export function showSimpleSuggestions(e,t){var o;null===(o=e.getContribution("editor.contrib.suggestController"))||void 0===o||o.triggerSuggest((new Set).add(t),void 0,!0)}export class QuickSuggestionsOptions{static isAllOff(e){return"off"===e.other&&"off"===e.comments&&"off"===e.strings}static isAllOn(e){return"on"===e.other&&"on"===e.comments&&"on"===e.strings}static valueFor(e,t){switch(t){case 1:return e.comments;case 2:return e.strings;default:return e.other}}}