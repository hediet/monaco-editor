import{quickSelect}from"../../../../base/common/arrays.js";import{anyScore,fuzzyScore,FuzzyScore,fuzzyScoreGracefulAggressive,FuzzyScoreOptions}from"../../../../base/common/filters.js";import{compareIgnoreCase}from"../../../../base/common/strings.js";export class LineContext{constructor(e,t){this.leadingLineContent=e,this.characterCountDelta=t}}export class CompletionModel{constructor(e,t,i,o,n,s,r=FuzzyScoreOptions.default,c){this.clipboardText=c,this._snippetCompareFn=CompletionModel._compareCompletionItems,this._items=e,this._column=t,this._wordDistance=o,this._options=n,this._refilterKind=1,this._lineContext=i,this._fuzzyScoreOptions=r,"top"===s?this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsUp:"bottom"===s&&(this._snippetCompareFn=CompletionModel._compareCompletionItemsSnippetsDown)}get lineContext(){return this._lineContext}set lineContext(e){this._lineContext.leadingLineContent===e.leadingLineContent&&this._lineContext.characterCountDelta===e.characterCountDelta||(this._refilterKind=this._lineContext.characterCountDelta<e.characterCountDelta&&this._filteredItems?2:1,this._lineContext=e)}get items(){return this._ensureCachedState(),this._filteredItems}getItemsByProvider(){return this._ensureCachedState(),this._itemsByProvider}getIncompleteProvider(){this._ensureCachedState();const e=new Set;for(const[t,i]of this.getItemsByProvider())i.length>0&&i[0].container.incomplete&&e.add(t);return e}get stats(){return this._ensureCachedState(),this._stats}_ensureCachedState(){0!==this._refilterKind&&this._createCachedState()}_createCachedState(){this._itemsByProvider=new Map;const e=[],{leadingLineContent:t,characterCountDelta:i}=this._lineContext;let o="",n="";const s=1===this._refilterKind?this._items:this._filteredItems,r=[],c=!this._options.filterGraceful||s.length>2e3?fuzzyScore:fuzzyScoreGracefulAggressive;for(let l=0;l<s.length;l++){const a=s[l];if(a.isInvalid)continue;const p=this._itemsByProvider.get(a.provider);p?p.push(a):this._itemsByProvider.set(a.provider,[a]);const m=a.position.column-a.editStart.column,h=m+i-(a.position.column-this._column);if(o.length!==h&&(o=0===h?"":t.slice(-h),n=o.toLowerCase()),a.word=o,0===h)a.score=FuzzyScore.Default;else{let e=0;for(;e<m;){const t=o.charCodeAt(e);if(32!==t&&9!==t)break;e+=1}if(e>=h)a.score=FuzzyScore.Default;else if("string"==typeof a.completion.filterText){const t=c(o,n,e,a.completion.filterText,a.filterTextLow,0,this._fuzzyScoreOptions);if(!t)continue;0===compareIgnoreCase(a.completion.filterText,a.textLabel)?a.score=t:(a.score=anyScore(o,n,e,a.textLabel,a.labelLow,0),a.score[0]=t[0])}else{const t=c(o,n,e,a.textLabel,a.labelLow,0,this._fuzzyScoreOptions);if(!t)continue;a.score=t}}a.idx=l,a.distance=this._wordDistance.distance(a.position,a.completion),r.push(a),e.push(a.textLabel.length)}this._filteredItems=r.sort(this._snippetCompareFn),this._refilterKind=0,this._stats={pLabelLen:e.length?quickSelect(e.length-.85,e,((e,t)=>e-t)):0}}static _compareCompletionItems(e,t){return e.score[0]>t.score[0]?-1:e.score[0]<t.score[0]?1:e.distance<t.distance?-1:e.distance>t.distance?1:e.idx<t.idx?-1:e.idx>t.idx?1:0}static _compareCompletionItemsSnippetsDown(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return 1;if(27===t.completion.kind)return-1}return CompletionModel._compareCompletionItems(e,t)}static _compareCompletionItemsSnippetsUp(e,t){if(e.completion.kind!==t.completion.kind){if(27===e.completion.kind)return-1;if(27===t.completion.kind)return 1}return CompletionModel._compareCompletionItems(e,t)}}