var __decorate=this&&this.__decorate||function(e,t,i,o){var r,s=arguments.length,n=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s<3?r(n):s>3?r(t,i,n):r(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(r,s){function n(e){try{d(o.next(e))}catch(e){s(e)}}function a(e){try{d(o.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}d((o=o.apply(e,t||[])).next())}))};import{TimeoutTimer}from"../../../../base/common/async.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace,isHighSurrogate,isLowSurrogate}from"../../../../base/common/strings.js";import{Selection}from"../../../common/core/selection.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{WordDistance}from"./wordDistance.js";import{IClipboardService}from"../../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{ILogService}from"../../../../platform/log/common/log.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";import{CompletionModel}from"./completionModel.js";import{CompletionOptions,getSnippetSuggestSupport,provideSuggestionItems,QuickSuggestionsOptions}from"./suggest.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{FuzzyScoreOptions}from"../../../../base/common/filters.js";import{assertType}from"../../../../base/common/types.js";export class LineContext{static shouldAutoTrigger(e){if(!e.hasModel())return!1;const t=e.getModel(),i=e.getPosition();t.tokenization.tokenizeIfCheap(i.lineNumber);const o=t.getWordAtPosition(i);return!!o&&o.endColumn===i.column&&!!isNaN(Number(o.word))}constructor(e,t,i){this.leadingLineContent=e.getLineContent(t.lineNumber).substr(0,t.column-1),this.leadingWord=e.getWordUntilPosition(t),this.lineNumber=t.lineNumber,this.column=t.column,this.triggerOptions=i}}function isSuggestPreviewEnabled(e){return e.getOption(112).preview}function canShowQuickSuggest(e,t,i){var o,r;if(!Boolean(t.getContextKeyValue("inlineSuggestionVisible")))return!0;const s=i.getValue("editor.inlineSuggest.allowQuickSuggestions",{overrideIdentifier:null===(o=e.getModel())||void 0===o?void 0:o.getLanguageId(),resource:null===(r=e.getModel())||void 0===r?void 0:r.uri});return void 0!==s&&Boolean(s)}function canShowSuggestOnTriggerCharacters(e,t,i){var o,r;if(!Boolean(t.getContextKeyValue("inlineSuggestionVisible")))return!0;const s=i.getValue("editor.inlineSuggest.allowSuggestOnTriggerCharacters",{overrideIdentifier:null===(o=e.getModel())||void 0===o?void 0:o.getLanguageId(),resource:null===(r=e.getModel())||void 0===r?void 0:r.uri});return void 0!==s&&Boolean(s)}let SuggestModel=class e{constructor(e,t,i,o,r,s,n,a){this._editor=e,this._editorWorkerService=t,this._clipboardService=i,this._telemetryService=o,this._logService=r,this._contextKeyService=s,this._configurationService=n,this._languageFeaturesService=a,this._toDispose=new DisposableStore,this._triggerCharacterListener=new DisposableStore,this._triggerQuickSuggest=new TimeoutTimer,this._triggerState=void 0,this._completionDisposables=new DisposableStore,this._onDidCancel=new Emitter,this._onDidTrigger=new Emitter,this._onDidSuggest=new Emitter,this.onDidCancel=this._onDidCancel.event,this.onDidTrigger=this._onDidTrigger.event,this.onDidSuggest=this._onDidSuggest.event,this._telemetryGate=0,this._currentSelection=this._editor.getSelection()||new Selection(1,1,1,1),this._toDispose.add(this._editor.onDidChangeModel((()=>{this._updateTriggerCharacters(),this.cancel()}))),this._toDispose.add(this._editor.onDidChangeModelLanguage((()=>{this._updateTriggerCharacters(),this.cancel()}))),this._toDispose.add(this._editor.onDidChangeConfiguration((()=>{this._updateTriggerCharacters()}))),this._toDispose.add(this._languageFeaturesService.completionProvider.onDidChange((()=>{this._updateTriggerCharacters(),this._updateActiveSuggestSession()})));let d=!1;this._toDispose.add(this._editor.onDidCompositionStart((()=>{d=!0}))),this._toDispose.add(this._editor.onDidCompositionEnd((()=>{d=!1,this._onCompositionEnd()}))),this._toDispose.add(this._editor.onDidChangeCursorSelection((e=>{d||this._onCursorChange(e)}))),this._toDispose.add(this._editor.onDidChangeModelContent((()=>{d||void 0===this._triggerState||this._refilterCompletionItems()}))),this._updateTriggerCharacters()}dispose(){dispose(this._triggerCharacterListener),dispose([this._onDidCancel,this._onDidSuggest,this._onDidTrigger,this._triggerQuickSuggest]),this._toDispose.dispose(),this._completionDisposables.dispose(),this.cancel()}_updateTriggerCharacters(){if(this._triggerCharacterListener.clear(),this._editor.getOption(86)||!this._editor.hasModel()||!this._editor.getOption(115))return;const e=new Map;for(const t of this._languageFeaturesService.completionProvider.all(this._editor.getModel()))for(const i of t.triggerCharacters||[]){let o=e.get(i);o||(o=new Set,o.add(getSnippetSuggestSupport()),e.set(i,o)),o.add(t)}const t=t=>{var i;if(!canShowSuggestOnTriggerCharacters(this._editor,this._contextKeyService,this._configurationService))return;if(LineContext.shouldAutoTrigger(this._editor))return;if(!t){const e=this._editor.getPosition();t=this._editor.getModel().getLineContent(e.lineNumber).substr(0,e.column-1)}let o="";isLowSurrogate(t.charCodeAt(t.length-1))?isHighSurrogate(t.charCodeAt(t.length-2))&&(o=t.substr(t.length-2)):o=t.charAt(t.length-1);const r=e.get(o);if(r){const e=new Map;if(this._completionModel)for(const[t,i]of this._completionModel.getItemsByProvider())r.has(t)||e.set(t,i);this.trigger({auto:!0,triggerKind:1,triggerCharacter:o,retrigger:Boolean(this._completionModel),clipboardText:null===(i=this._completionModel)||void 0===i?void 0:i.clipboardText,completionOptions:{providerFilter:r,providerItemsToReuse:e}})}};this._triggerCharacterListener.add(this._editor.onDidType(t)),this._triggerCharacterListener.add(this._editor.onDidCompositionEnd((()=>t())))}get state(){return this._triggerState?this._triggerState.auto?2:1:0}cancel(e=!1){var t;void 0!==this._triggerState&&(this._triggerQuickSuggest.cancel(),null===(t=this._requestToken)||void 0===t||t.cancel(),this._requestToken=void 0,this._triggerState=void 0,this._completionModel=void 0,this._context=void 0,this._onDidCancel.fire({retrigger:e}))}clear(){this._completionDisposables.clear()}_updateActiveSuggestSession(){void 0!==this._triggerState&&(this._editor.hasModel()&&this._languageFeaturesService.completionProvider.has(this._editor.getModel())?this.trigger({auto:this._triggerState.auto,retrigger:!0}):this.cancel())}_onCursorChange(e){if(!this._editor.hasModel())return;const t=this._currentSelection;this._currentSelection=this._editor.getSelection(),!e.selection.isEmpty()||0!==e.reason&&3!==e.reason||"keyboard"!==e.source&&"deleteLeft"!==e.source?this.cancel():void 0===this._triggerState&&0===e.reason?(t.containsRange(this._currentSelection)||t.getEndPosition().isBeforeOrEqual(this._currentSelection.getPosition()))&&this._doTriggerQuickSuggest():void 0!==this._triggerState&&3===e.reason&&this._refilterCompletionItems()}_onCompositionEnd(){void 0===this._triggerState?this._doTriggerQuickSuggest():this._refilterCompletionItems()}_doTriggerQuickSuggest(){QuickSuggestionsOptions.isAllOff(this._editor.getOption(84))||(this.cancel(),this._triggerQuickSuggest.cancelAndSet((()=>{if(void 0!==this._triggerState)return;if(!LineContext.shouldAutoTrigger(this._editor))return;if(!this._editor.hasModel()||!this._editor.hasWidgetFocus())return;const e=this._editor.getModel(),t=this._editor.getPosition(),i=this._editor.getOption(84);if(!QuickSuggestionsOptions.isAllOff(i)){if(!QuickSuggestionsOptions.isAllOn(i)){e.tokenization.tokenizeIfCheap(t.lineNumber);const o=e.tokenization.getLineTokens(t.lineNumber),r=o.getStandardTokenType(o.findTokenIndexAtOffset(Math.max(t.column-1-1,0)));if("on"!==QuickSuggestionsOptions.valueFor(i,r))return}canShowQuickSuggest(this._editor,this._contextKeyService,this._configurationService)&&this._languageFeaturesService.completionProvider.has(e)&&this.trigger({auto:!0})}}),this._editor.getOption(85)))}_refilterCompletionItems(){assertType(this._editor.hasModel()),assertType(void 0!==this._triggerState);const e=this._editor.getModel(),t=this._editor.getPosition(),i=new LineContext(e,t,Object.assign(Object.assign({},this._triggerState),{refilter:!0}));this._onNewContext(i)}trigger(t){var i,o,r,s,n,a;if(!this._editor.hasModel())return;const d=this._editor.getModel(),g=new LineContext(d,this._editor.getPosition(),t);this.cancel(t.retrigger),this._triggerState=t,this._onDidTrigger.fire({auto:t.auto,shy:null!==(i=t.shy)&&void 0!==i&&i,position:this._editor.getPosition()}),this._context=g;let c={triggerKind:null!==(o=t.triggerKind)&&void 0!==o?o:0};t.triggerCharacter&&(c={triggerKind:1,triggerCharacter:t.triggerCharacter}),this._requestToken=new CancellationTokenSource;let l=1;switch(this._editor.getOption(106)){case"top":l=0;break;case"bottom":l=2}const{itemKind:h,showDeprecated:u}=e._createSuggestFilter(this._editor),_=new CompletionOptions(l,null!==(s=null===(r=t.completionOptions)||void 0===r?void 0:r.kindFilter)&&void 0!==s?s:h,null===(n=t.completionOptions)||void 0===n?void 0:n.providerFilter,null===(a=t.completionOptions)||void 0===a?void 0:a.providerItemsToReuse,u),p=WordDistance.create(this._editorWorkerService,this._editor),m=provideSuggestionItems(this._languageFeaturesService.completionProvider,d,this._editor.getPosition(),_,c,this._requestToken.token);Promise.all([m,p]).then((([e,i])=>__awaiter(this,void 0,void 0,(function*(){var o;if(null===(o=this._requestToken)||void 0===o||o.dispose(),!this._editor.hasModel())return;let r=null==t?void 0:t.clipboardText;if(!r&&e.needsClipboard&&(r=yield this._clipboardService.readText()),void 0===this._triggerState)return;const s=this._editor.getModel(),n=new LineContext(s,this._editor.getPosition(),t),a=Object.assign(Object.assign({},FuzzyScoreOptions.default),{firstMatchCanBeWeak:!this._editor.getOption(112).matchOnWordStartOnly});this._completionModel=new CompletionModel(e.items,this._context.column,{leadingLineContent:n.leadingLineContent,characterCountDelta:n.column-this._context.column},i,this._editor.getOption(112),this._editor.getOption(106),a,r),this._completionDisposables.add(e.disposable),this._onNewContext(n),this._reportDurationsTelemetry(e.durations)})))).catch(onUnexpectedError)}_reportDurationsTelemetry(e){this._telemetryGate++%230==0&&setTimeout((()=>{this._telemetryService.publicLog2("suggest.durations.json",{data:JSON.stringify(e)}),this._logService.debug("suggest.durations.json",e)}))}static _createSuggestFilter(e){const t=new Set;"none"===e.getOption(106)&&t.add(27);const i=e.getOption(112);return i.showMethods||t.add(0),i.showFunctions||t.add(1),i.showConstructors||t.add(2),i.showFields||t.add(3),i.showVariables||t.add(4),i.showClasses||t.add(5),i.showStructs||t.add(6),i.showInterfaces||t.add(7),i.showModules||t.add(8),i.showProperties||t.add(9),i.showEvents||t.add(10),i.showOperators||t.add(11),i.showUnits||t.add(12),i.showValues||t.add(13),i.showConstants||t.add(14),i.showEnums||t.add(15),i.showEnumMembers||t.add(16),i.showKeywords||t.add(17),i.showWords||t.add(18),i.showColors||t.add(19),i.showFiles||t.add(20),i.showReferences||t.add(21),i.showColors||t.add(22),i.showFolders||t.add(23),i.showTypeParameters||t.add(24),i.showSnippets||t.add(27),i.showUsers||t.add(25),i.showIssues||t.add(26),{itemKind:t,showDeprecated:i.showDeprecated}}_onNewContext(e){if(this._context)if(e.lineNumber===this._context.lineNumber)if(getLeadingWhitespace(e.leadingLineContent)===getLeadingWhitespace(this._context.leadingLineContent)){if(e.column<this._context.column)e.leadingWord.word?this.trigger({auto:this._context.triggerOptions.auto,retrigger:!0}):this.cancel();else if(this._completionModel)if(0!==e.leadingWord.word.length&&e.leadingWord.startColumn>this._context.leadingWord.startColumn){if(LineContext.shouldAutoTrigger(this._editor)&&this._context){const e=this._completionModel.getItemsByProvider();this.trigger({auto:this._context.triggerOptions.auto,retrigger:!0,clipboardText:this._completionModel.clipboardText,completionOptions:{providerItemsToReuse:e}})}}else if(e.column>this._context.column&&this._completionModel.getIncompleteProvider().size>0&&0!==e.leadingWord.word.length){const e=new Map,t=new Set;for(const[i,o]of this._completionModel.getItemsByProvider())o.length>0&&o[0].container.incomplete?t.add(i):e.set(i,o);this.trigger({auto:this._context.triggerOptions.auto,triggerKind:2,retrigger:!0,clipboardText:this._completionModel.clipboardText,completionOptions:{providerFilter:t,providerItemsToReuse:e}})}else{const t=this._completionModel.lineContext;let i=!1;if(this._completionModel.lineContext={leadingLineContent:e.leadingLineContent,characterCountDelta:e.column-this._context.column},0===this._completionModel.items.length){const o=LineContext.shouldAutoTrigger(this._editor);if(!this._context)return void this.cancel();if(o&&this._context.leadingWord.endColumn<e.leadingWord.startColumn)return void this.trigger({auto:this._context.triggerOptions.auto,retrigger:!0});if(this._context.triggerOptions.auto)return void this.cancel();if(this._completionModel.lineContext=t,i=this._completionModel.items.length>0,i&&0===e.leadingWord.word.length)return void this.cancel()}this._onDidSuggest.fire({completionModel:this._completionModel,triggerOptions:e.triggerOptions,isFrozen:i})}}else this.cancel();else this.cancel()}};SuggestModel=__decorate([__param(1,IEditorWorkerService),__param(2,IClipboardService),__param(3,ITelemetryService),__param(4,ILogService),__param(5,IContextKeyService),__param(6,IConfigurationService),__param(7,ILanguageFeaturesService)],SuggestModel);export{SuggestModel};