var __decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(n<3?i(s):n>3?i(t,o,s):i(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,n){function s(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};import{alert}from"../../../../base/browser/ui/aria/aria.js";import{raceCancellation}from"../../../../base/common/async.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{EditorAction,EditorCommand,registerEditorAction,registerEditorCommand,registerEditorContribution,registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{IBulkEditService}from"../../../browser/services/bulkEditService.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{ITextResourceConfigurationService}from"../../../common/services/textResourceConfiguration.js";import{MessageController}from"../../message/browser/messageController.js";import*as nls from"../../../../nls.js";import{Extensions}from"../../../../platform/configuration/common/configurationRegistry.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILogService}from"../../../../platform/log/common/log.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../../platform/progress/common/progress.js";import{Registry}from"../../../../platform/registry/common/platform.js";import{CONTEXT_RENAME_INPUT_VISIBLE,RenameInputField}from"./renameInputField.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";class RenameSkeleton{constructor(e,t,o){this.model=e,this.position=t,this._providerRenameIdx=0,this._providers=o.ordered(e)}hasProvider(){return this._providers.length>0}resolveRenameLocation(e){return __awaiter(this,void 0,void 0,(function*(){const t=[];for(this._providerRenameIdx=0;this._providerRenameIdx<this._providers.length;this._providerRenameIdx++){const o=this._providers[this._providerRenameIdx];if(!o.resolveRenameLocation)break;const r=yield o.resolveRenameLocation(this.model,this.position,e);if(r){if(!r.rejectReason)return r;t.push(r.rejectReason)}}const o=this.model.getWordAtPosition(this.position);return o?{range:new Range(this.position.lineNumber,o.startColumn,this.position.lineNumber,o.endColumn),text:o.word,rejectReason:t.length>0?t.join("\n"):void 0}:{range:Range.fromPositions(this.position),text:"",rejectReason:t.length>0?t.join("\n"):void 0}}))}provideRenameEdits(e,t){return __awaiter(this,void 0,void 0,(function*(){return this._provideRenameEdits(e,this._providerRenameIdx,[],t)}))}_provideRenameEdits(e,t,o,r){return __awaiter(this,void 0,void 0,(function*(){const i=this._providers[t];if(!i)return{edits:[],rejectReason:o.join("\n")};const n=yield i.provideRenameEdits(this.model,this.position,e,r);return n?n.rejectReason?this._provideRenameEdits(e,t+1,o.concat(n.rejectReason),r):n:this._provideRenameEdits(e,t+1,o.concat(nls.localize("no result","No result.")),r)}))}}export function rename(e,t,o,r){return __awaiter(this,void 0,void 0,(function*(){const i=new RenameSkeleton(t,o,e),n=yield i.resolveRenameLocation(CancellationToken.None);return(null==n?void 0:n.rejectReason)?{edits:[],rejectReason:n.rejectReason}:i.provideRenameEdits(r,CancellationToken.None)}))}let RenameController=class e{static get(t){return t.getContribution(e.ID)}constructor(e,t,o,r,i,n,s,a){this.editor=e,this._instaService=t,this._notificationService=o,this._bulkEditService=r,this._progressService=i,this._logService=n,this._configService=s,this._languageFeaturesService=a,this._disposableStore=new DisposableStore,this._cts=new CancellationTokenSource,this._renameInputField=this._disposableStore.add(this._instaService.createInstance(RenameInputField,this.editor,["acceptRenameInput","acceptRenameInputWithPreview"]))}dispose(){this._disposableStore.dispose(),this._cts.dispose(!0)}run(){var e,t;return __awaiter(this,void 0,void 0,(function*(){if(this._cts.dispose(!0),!this.editor.hasModel())return;const o=this.editor.getPosition(),r=new RenameSkeleton(this.editor.getModel(),o,this._languageFeaturesService.renameProvider);if(!r.hasProvider())return;let i;this._cts=new EditorStateCancellationTokenSource(this.editor,5);try{const e=r.resolveRenameLocation(this._cts.token);this._progressService.showWhile(e,250),i=yield e}catch(t){return void(null===(e=MessageController.get(this.editor))||void 0===e||e.showMessage(t||nls.localize("resolveRenameLocationFailed","An unknown error occurred while resolving rename location"),o))}if(!i)return;if(i.rejectReason)return void(null===(t=MessageController.get(this.editor))||void 0===t||t.showMessage(i.rejectReason,o));if(this._cts.token.isCancellationRequested)return;this._cts.dispose(),this._cts=new EditorStateCancellationTokenSource(this.editor,5,i.range);const n=this.editor.getSelection();let s=0,a=i.text.length;Range.isEmpty(n)||Range.spansMultipleLines(n)||!Range.containsRange(i.range,n)||(s=Math.max(0,n.startColumn-i.range.startColumn),a=Math.min(i.range.endColumn,n.endColumn)-i.range.startColumn);const c=this._bulkEditService.hasPreviewHandler()&&this._configService.getValue(this.editor.getModel().uri,"editor.rename.enablePreview"),m=yield this._renameInputField.getInput(i.range,i.text,s,a,c,this._cts.token);if("boolean"==typeof m)return void(m&&this.editor.focus());this.editor.focus();const l=raceCancellation(r.provideRenameEdits(m.newName,this._cts.token),this._cts.token).then((e=>__awaiter(this,void 0,void 0,(function*(){e&&this.editor.hasModel()&&(e.rejectReason?this._notificationService.info(e.rejectReason):(this.editor.setSelection(Range.fromPositions(this.editor.getSelection().getPosition())),this._bulkEditService.apply(e,{editor:this.editor,showPreview:m.wantsPreview,label:nls.localize("label","Renaming '{0}' to '{1}'",null==i?void 0:i.text,m.newName),code:"undoredo.rename",quotableLabel:nls.localize("quotableLabel","Renaming {0} to {1}",null==i?void 0:i.text,m.newName),respectAutoSaveConfig:!0}).then((e=>{e.ariaSummary&&alert(nls.localize("aria","Successfully renamed '{0}' to '{1}'. Summary: {2}",i.text,m.newName,e.ariaSummary))})).catch((e=>{this._notificationService.error(nls.localize("rename.failedApply","Rename failed to apply edits")),this._logService.error(e)}))))}))),(e=>{this._notificationService.error(nls.localize("rename.failed","Rename failed to compute edits")),this._logService.error(e)}));return this._progressService.showWhile(l,250),l}))}acceptRenameInput(e){this._renameInputField.acceptInput(e)}cancelRenameInput(){this._renameInputField.cancelInput(!0)}};RenameController.ID="editor.contrib.renameController",RenameController=__decorate([__param(1,IInstantiationService),__param(2,INotificationService),__param(3,IBulkEditService),__param(4,IEditorProgressService),__param(5,ILogService),__param(6,ITextResourceConfigurationService),__param(7,ILanguageFeaturesService)],RenameController);export class RenameAction extends EditorAction{constructor(){super({id:"editor.action.rename",label:nls.localize("rename.label","Rename Symbol"),alias:"Rename Symbol",precondition:ContextKeyExpr.and(EditorContextKeys.writable,EditorContextKeys.hasRenameProvider),kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:60,weight:100},contextMenuOpts:{group:"1_modification",order:1.1}})}runCommand(e,t){const o=e.get(ICodeEditorService),[r,i]=Array.isArray(t)&&t||[void 0,void 0];return URI.isUri(r)&&Position.isIPosition(i)?o.openCodeEditor({resource:r},o.getActiveCodeEditor()).then((e=>{e&&(e.setPosition(i),e.invokeWithinContext((t=>(this.reportTelemetry(t,e),this.run(t,e)))))}),onUnexpectedError):super.runCommand(e,t)}run(e,t){const o=RenameController.get(t);return o?o.run():Promise.resolve()}}registerEditorContribution(RenameController.ID,RenameController,4),registerEditorAction(RenameAction);const RenameCommand=EditorCommand.bindToContribution(RenameController.get);registerEditorCommand(new RenameCommand({id:"acceptRenameInput",precondition:CONTEXT_RENAME_INPUT_VISIBLE,handler:e=>e.acceptRenameInput(!1),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:3}})),registerEditorCommand(new RenameCommand({id:"acceptRenameInputWithPreview",precondition:ContextKeyExpr.and(CONTEXT_RENAME_INPUT_VISIBLE,ContextKeyExpr.has("config.editor.rename.enablePreview")),handler:e=>e.acceptRenameInput(!0),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:1027}})),registerEditorCommand(new RenameCommand({id:"cancelRenameInput",precondition:CONTEXT_RENAME_INPUT_VISIBLE,handler:e=>e.cancelRenameInput(),kbOpts:{weight:199,kbExpr:EditorContextKeys.focus,primary:9,secondary:[1033]}})),registerModelAndPositionCommand("_executeDocumentRenameProvider",(function(e,t,o,...r){const[i]=r;assertType("string"==typeof i);const{renameProvider:n}=e.get(ILanguageFeaturesService);return rename(n,t,o,i)})),registerModelAndPositionCommand("_executePrepareRename",(function(e,t,o){return __awaiter(this,void 0,void 0,(function*(){const{renameProvider:r}=e.get(ILanguageFeaturesService),i=new RenameSkeleton(t,o,r),n=yield i.resolveRenameLocation(CancellationToken.None);if(null==n?void 0:n.rejectReason)throw new Error(n.rejectReason);return n}))})),Registry.as(Extensions.Configuration).registerConfiguration({id:"editor",properties:{"editor.rename.enablePreview":{scope:5,description:nls.localize("enablePreview","Enable/disable the ability to preview changes before renaming"),default:!0,type:"boolean"}}});