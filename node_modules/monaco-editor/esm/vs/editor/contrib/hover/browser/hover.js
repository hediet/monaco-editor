var __decorate=this&&this.__decorate||function(o,e,t,i){var r,n=arguments.length,s=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(o,e,t,i);else for(var d=o.length-1;d>=0;d--)(r=o[d])&&(s=(n<3?r(s):n>3?r(e,t,s):r(e,t))||s);return n>3&&s&&Object.defineProperty(e,t,s),s},__param=this&&this.__param||function(o,e){return function(t,i){e(t,i,o)}};import{KeyChord}from"../../../../base/common/keyCodes.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{ILanguageService}from"../../../common/languages/language.js";import{GotoDefinitionAtPositionEditorContribution}from"../../gotoSymbol/browser/link/goToDefinitionAtPosition.js";import{ContentHoverWidget,ContentHoverController}from"./contentHover.js";import{MarginHoverWidget}from"./marginHover.js";import*as nls from"../../../../nls.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{editorHoverBorder}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{HoverParticipantRegistry}from"./hoverTypes.js";import{MarkdownHoverParticipant}from"./markdownHoverParticipant.js";import{MarkerHoverParticipant}from"./markerHoverParticipant.js";import"./hover.css";import{InlineSuggestionHintsContentWidget}from"../../inlineCompletions/browser/inlineSuggestionHintsWidget.js";let ModesHoverController=class o{static get(e){return e.getContribution(o.ID)}constructor(o,e,t,i,r){this._editor=o,this._instantiationService=e,this._openerService=t,this._languageService=i,this._toUnhook=new DisposableStore,this._isMouseDown=!1,this._hoverClicked=!1,this._contentWidget=null,this._glyphWidget=null,this._hookEvents(),this._didChangeConfigurationHandler=this._editor.onDidChangeConfiguration((o=>{o.hasChanged(57)&&(this._unhookEvents(),this._hookEvents())}))}_hookEvents(){const o=this._editor.getOption(57);this._isHoverEnabled=o.enabled,this._isHoverSticky=o.sticky,this._isHoverEnabled?(this._toUnhook.add(this._editor.onMouseDown((o=>this._onEditorMouseDown(o)))),this._toUnhook.add(this._editor.onMouseUp((o=>this._onEditorMouseUp(o)))),this._toUnhook.add(this._editor.onMouseMove((o=>this._onEditorMouseMove(o)))),this._toUnhook.add(this._editor.onKeyDown((o=>this._onKeyDown(o))))):(this._toUnhook.add(this._editor.onMouseMove((o=>this._onEditorMouseMove(o)))),this._toUnhook.add(this._editor.onKeyDown((o=>this._onKeyDown(o))))),this._toUnhook.add(this._editor.onMouseLeave((o=>this._onEditorMouseLeave(o)))),this._toUnhook.add(this._editor.onDidChangeModel((()=>this._hideWidgets()))),this._toUnhook.add(this._editor.onDidScrollChange((o=>this._onEditorScrollChanged(o))))}_unhookEvents(){this._toUnhook.clear()}_onEditorScrollChanged(o){(o.scrollTopChanged||o.scrollLeftChanged)&&this._hideWidgets()}_onEditorMouseDown(o){this._isMouseDown=!0;const e=o.target;9!==e.type||e.detail!==ContentHoverWidget.ID?12===e.type&&e.detail===MarginHoverWidget.ID||(12!==e.type&&(this._hoverClicked=!1),this._hideWidgets()):this._hoverClicked=!0}_onEditorMouseUp(o){this._isMouseDown=!1}_onEditorMouseLeave(o){var e;const t=o.event.browserEvent.relatedTarget;(null===(e=this._contentWidget)||void 0===e?void 0:e.containsNode(t))||this._hideWidgets()}_onEditorMouseMove(o){var e,t,i,r,n,s;const d=o.target;if((!this._isMouseDown||!this._hoverClicked)&&(!this._isHoverSticky||9!==d.type||d.detail!==ContentHoverWidget.ID)&&(!this._isHoverSticky||(null===(t=null===(e=o.event.browserEvent.view)||void 0===e?void 0:e.getSelection())||void 0===t?void 0:t.isCollapsed))&&(this._isHoverSticky||9!==d.type||d.detail!==ContentHoverWidget.ID||!(null===(i=this._contentWidget)||void 0===i?void 0:i.isColorPickerVisible()))&&!(this._isHoverSticky&&12===d.type&&d.detail===MarginHoverWidget.ID||this._isHoverSticky&&(null===(r=this._contentWidget)||void 0===r?void 0:r.isVisibleFromKeyboard()))){if(this._isHoverEnabled)return this._getOrCreateContentWidget().maybeShowAt(o)?void(null===(n=this._glyphWidget)||void 0===n||n.hide()):2===d.type&&d.position?(null===(s=this._contentWidget)||void 0===s||s.hide(),this._glyphWidget||(this._glyphWidget=new MarginHoverWidget(this._editor,this._languageService,this._openerService)),void this._glyphWidget.startShowingAt(d.position.lineNumber)):void this._hideWidgets();this._hideWidgets()}}_onKeyDown(o){5!==o.keyCode&&6!==o.keyCode&&57!==o.keyCode&&4!==o.keyCode&&this._hideWidgets()}_hideWidgets(){var o,e,t;this._isMouseDown&&this._hoverClicked&&(null===(o=this._contentWidget)||void 0===o?void 0:o.isColorPickerVisible())||InlineSuggestionHintsContentWidget.dropDownVisible||(this._hoverClicked=!1,null===(e=this._glyphWidget)||void 0===e||e.hide(),null===(t=this._contentWidget)||void 0===t||t.hide())}_getOrCreateContentWidget(){return this._contentWidget||(this._contentWidget=this._instantiationService.createInstance(ContentHoverController,this._editor)),this._contentWidget}isColorPickerVisible(){var o;return(null===(o=this._contentWidget)||void 0===o?void 0:o.isColorPickerVisible())||!1}showContentHover(o,e,t,i){this._getOrCreateContentWidget().startShowingAtRange(o,e,t,i)}dispose(){var o,e;this._unhookEvents(),this._toUnhook.dispose(),this._didChangeConfigurationHandler.dispose(),null===(o=this._glyphWidget)||void 0===o||o.dispose(),null===(e=this._contentWidget)||void 0===e||e.dispose()}};ModesHoverController.ID="editor.contrib.hover",ModesHoverController=__decorate([__param(1,IInstantiationService),__param(2,IOpenerService),__param(3,ILanguageService),__param(4,IContextKeyService)],ModesHoverController);export{ModesHoverController};class ShowHoverAction extends EditorAction{constructor(){super({id:"editor.action.showHover",label:nls.localize({key:"showHover",comment:["Label for action that will trigger the showing of a hover in the editor.","This allows for users to show the hover without using the mouse."]},"Show Hover"),alias:"Show Hover",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:KeyChord(2089,2087),weight:100}})}run(o,e){if(!e.hasModel())return;const t=ModesHoverController.get(e);if(!t)return;const i=e.getPosition(),r=new Range(i.lineNumber,i.column,i.lineNumber,i.column),n=2===e.getOption(2);t.showContentHover(r,1,1,n)}}class ShowDefinitionPreviewHoverAction extends EditorAction{constructor(){super({id:"editor.action.showDefinitionPreviewHover",label:nls.localize({key:"showDefinitionPreviewHover",comment:["Label for action that will trigger the showing of definition preview hover in the editor.","This allows for users to show the definition preview hover without using the mouse."]},"Show Definition Preview Hover"),alias:"Show Definition Preview Hover",precondition:void 0})}run(o,e){const t=ModesHoverController.get(e);if(!t)return;const i=e.getPosition();if(!i)return;const r=new Range(i.lineNumber,i.column,i.lineNumber,i.column),n=GotoDefinitionAtPositionEditorContribution.get(e);n&&n.startFindDefinitionFromCursor(i).then((()=>{t.showContentHover(r,1,1,!0)}))}}registerEditorContribution(ModesHoverController.ID,ModesHoverController,2),registerEditorAction(ShowHoverAction),registerEditorAction(ShowDefinitionPreviewHoverAction),HoverParticipantRegistry.register(MarkdownHoverParticipant),HoverParticipantRegistry.register(MarkerHoverParticipant),registerThemingParticipant(((o,e)=>{const t=o.getColor(editorHoverBorder);t&&(e.addRule(`.monaco-editor .monaco-hover .hover-row:not(:first-child):not(:empty) { border-top: 1px solid ${t.transparent(.5)}; }`),e.addRule(`.monaco-editor .monaco-hover hr { border-top: 1px solid ${t.transparent(.5)}; }`),e.addRule(`.monaco-editor .monaco-hover hr { border-bottom: 0px solid ${t.transparent(.5)}; }`))}));