var __awaiter=this&&this.__awaiter||function(t,e,s,i){return new(s||(s=Promise))((function(r,n){function a(t){try{o(i.next(t))}catch(t){n(t)}}function c(t){try{o(i.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,c)}o((i=i.apply(t,e||[])).next())}))},__asyncValues=this&&this.__asyncValues||function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,s=t[Symbol.asyncIterator];return s?s.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);function i(s){e[s]=t[s]&&function(e){return new Promise((function(i,r){!function(t,e,s,i){Promise.resolve(i).then((function(e){t({value:e,done:s})}),e)}(i,r,(e=t[s](e)).done,e.value)}))}}};import{createCancelableAsyncIterable,RunOnceScheduler}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable}from"../../../../base/common/lifecycle.js";export class HoverResult{constructor(t,e,s){this.value=t,this.isComplete=e,this.hasLoadingMessage=s}}export class HoverOperation extends Disposable{constructor(t,e){super(),this._editor=t,this._computer=e,this._onResult=this._register(new Emitter),this.onResult=this._onResult.event,this._firstWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerAsyncComputation()),0)),this._secondWaitScheduler=this._register(new RunOnceScheduler((()=>this._triggerSyncComputation()),0)),this._loadingMessageScheduler=this._register(new RunOnceScheduler((()=>this._triggerLoadingMessage()),0)),this._state=0,this._asyncIterable=null,this._asyncIterableDone=!1,this._result=[]}dispose(){this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),super.dispose()}get _hoverTime(){return this._editor.getOption(57).delay}get _firstWaitTime(){return this._hoverTime/2}get _secondWaitTime(){return this._hoverTime-this._firstWaitTime}get _loadingMessageTime(){return 3*this._hoverTime}_setState(t,e=!0){this._state=t,e&&this._fireResult()}_triggerAsyncComputation(){this._setState(2),this._secondWaitScheduler.schedule(this._secondWaitTime),this._computer.computeAsync?(this._asyncIterableDone=!1,this._asyncIterable=createCancelableAsyncIterable((t=>this._computer.computeAsync(t))),(()=>{__awaiter(this,void 0,void 0,(function*(){var t,e,s,i;try{try{for(var r,n=!0,a=__asyncValues(this._asyncIterable);!(t=(r=yield a.next()).done);){i=r.value,n=!1;try{const t=i;t&&(this._result.push(t),this._fireResult())}finally{n=!0}}}catch(t){e={error:t}}finally{try{n||t||!(s=a.return)||(yield s.call(a))}finally{if(e)throw e.error}}this._asyncIterableDone=!0,3!==this._state&&4!==this._state||this._setState(0)}catch(t){onUnexpectedError(t)}}))})()):this._asyncIterableDone=!0}_triggerSyncComputation(){this._computer.computeSync&&(this._result=this._result.concat(this._computer.computeSync())),this._setState(this._asyncIterableDone?0:3)}_triggerLoadingMessage(){3===this._state&&this._setState(4)}_fireResult(){if(1===this._state||2===this._state)return;const t=0===this._state,e=4===this._state;this._onResult.fire(new HoverResult(this._result.slice(0),t,e))}start(t){if(0===t)0===this._state&&(this._setState(1),this._firstWaitScheduler.schedule(this._firstWaitTime),this._loadingMessageScheduler.schedule(this._loadingMessageTime));else switch(this._state){case 0:this._triggerAsyncComputation(),this._secondWaitScheduler.cancel(),this._triggerSyncComputation();break;case 2:this._secondWaitScheduler.cancel(),this._triggerSyncComputation()}}cancel(){this._firstWaitScheduler.cancel(),this._secondWaitScheduler.cancel(),this._loadingMessageScheduler.cancel(),this._asyncIterable&&(this._asyncIterable.cancel(),this._asyncIterable=null),this._result=[],this._setState(0,!1)}}