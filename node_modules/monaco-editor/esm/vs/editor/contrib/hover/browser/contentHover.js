var __decorate=this&&this.__decorate||function(t,e,i,o){var s,n=arguments.length,r=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(r=(n<3?s(r):n>3?s(e,i,r):s(e,i))||r);return n>3&&r&&Object.defineProperty(e,i,r),r},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}};import*as dom from"../../../../base/browser/dom.js";import{HoverAction,HoverWidget}from"../../../../base/browser/ui/hover/hoverWidget.js";import{coalesce}from"../../../../base/common/arrays.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{TokenizationRegistry}from"../../../common/languages.js";import{HoverOperation}from"./hoverOperation.js";import{HoverParticipantRegistry,HoverRangeAnchor}from"./hoverTypes.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{Context as SuggestContext}from"../../suggest/browser/suggest.js";import{AsyncIterableObject}from"../../../../base/common/async.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";const $=dom.$;let ContentHoverController=class t extends Disposable{constructor(t,e,i){super(),this._editor=t,this._instantiationService=e,this._keybindingService=i,this._widget=this._register(this._instantiationService.createInstance(ContentHoverWidget,this._editor)),this._currentResult=null,this._participants=[];for(const t of HoverParticipantRegistry.getAll())this._participants.push(this._instantiationService.createInstance(t,this._editor));this._participants.sort(((t,e)=>t.hoverOrdinal-e.hoverOrdinal)),this._computer=new ContentHoverComputer(this._editor,this._participants),this._hoverOperation=this._register(new HoverOperation(this._editor,this._computer)),this._register(this._hoverOperation.onResult((t=>{if(!this._computer.anchor)return;const e=t.hasLoadingMessage?this._addLoadingMessage(t.value):t.value;this._withResult(new HoverResult(this._computer.anchor,e,t.isComplete))}))),this._register(dom.addStandardDisposableListener(this._widget.getDomNode(),"keydown",(t=>{t.equals(9)&&this.hide()}))),this._register(TokenizationRegistry.onDidChange((()=>{this._widget.position&&this._currentResult&&(this._widget.clear(),this._setCurrentResult(this._currentResult))})))}maybeShowAt(t){const e=[];for(const i of this._participants)if(i.suggestHoverAnchor){const o=i.suggestHoverAnchor(t);o&&e.push(o)}const i=t.target;if(6===i.type&&e.push(new HoverRangeAnchor(0,i.range,t.event.posx,t.event.posy)),7===i.type){const o=this._editor.getOption(47).typicalHalfwidthCharacterWidth/2;!i.detail.isAfterLines&&"number"==typeof i.detail.horizontalDistanceToText&&i.detail.horizontalDistanceToText<o&&e.push(new HoverRangeAnchor(0,i.range,t.event.posx,t.event.posy))}return 0===e.length?this._startShowingOrUpdateHover(null,0,0,!1,t):(e.sort(((t,e)=>e.priority-t.priority)),this._startShowingOrUpdateHover(e[0],0,0,!1,t))}startShowingAtRange(t,e,i,o){this._startShowingOrUpdateHover(new HoverRangeAnchor(0,t,void 0,void 0),e,i,o,null)}_startShowingOrUpdateHover(t,e,i,o,s){return this._widget.position&&this._currentResult?this._editor.getOption(57).sticky&&s&&this._widget.isMouseGettingCloser(s.event.posx,s.event.posy)?(t&&this._startHoverOperationIfNecessary(t,e,i,o,!0),!0):t?!(!t||!this._currentResult.anchor.equals(t))||(t.canAdoptVisibleHover(this._currentResult.anchor,this._widget.position)?(this._setCurrentResult(this._currentResult.filter(t)),this._startHoverOperationIfNecessary(t,e,i,o,!1),!0):(this._setCurrentResult(null),this._startHoverOperationIfNecessary(t,e,i,o,!1),!0)):(this._setCurrentResult(null),!1):!!t&&(this._startHoverOperationIfNecessary(t,e,i,o,!1),!0)}_startHoverOperationIfNecessary(t,e,i,o,s){this._computer.anchor&&this._computer.anchor.equals(t)||(this._hoverOperation.cancel(),this._computer.anchor=t,this._computer.shouldFocus=o,this._computer.source=i,this._computer.insistOnKeepingHoverVisible=s,this._hoverOperation.start(e))}_setCurrentResult(t){this._currentResult!==t&&(t&&0===t.messages.length&&(t=null),this._currentResult=t,this._currentResult?this._renderMessages(this._currentResult.anchor,this._currentResult.messages):this._widget.hide())}hide(){this._computer.anchor=null,this._hoverOperation.cancel(),this._setCurrentResult(null)}isColorPickerVisible(){return this._widget.isColorPickerVisible}isVisibleFromKeyboard(){return this._widget.isVisibleFromKeyboard}containsNode(t){return this._widget.getDomNode().contains(t)}_addLoadingMessage(t){if(this._computer.anchor)for(const e of this._participants)if(e.createLoadingMessage){const i=e.createLoadingMessage(this._computer.anchor);if(i)return t.slice(0).concat([i])}return t}_withResult(t){if(this._widget.position&&this._currentResult&&this._currentResult.isComplete){if(!t.isComplete)return;if(this._computer.insistOnKeepingHoverVisible&&0===t.messages.length)return}this._setCurrentResult(t)}_renderMessages(e,i){const{showAtPosition:o,showAtSecondaryPosition:s,highlightRange:n}=t.computeHoverRanges(this._editor,e.range,i),r=new DisposableStore,a=r.add(new EditorHoverStatusBar(this._keybindingService)),h=document.createDocumentFragment();let l=null;const c={fragment:h,statusBar:a,setColorPicker:t=>l=t,onContentsChanged:()=>this._widget.onContentsChanged(),hide:()=>this.hide()};for(const t of this._participants){const e=i.filter((e=>e.owner===t));e.length>0&&r.add(t.renderHoverParts(c,e))}const u=i.some((t=>t.isBeforeContent));if(a.hasContent&&h.appendChild(a.hoverElement),h.hasChildNodes()){if(n){const e=this._editor.createDecorationsCollection();e.set([{range:n,options:t._DECORATION_OPTIONS}]),r.add(toDisposable((()=>{e.clear()})))}this._widget.showAt(h,new ContentHoverVisibleData(l,o,s,this._editor.getOption(57).above,this._computer.shouldFocus,this._computer.source,u,e.initialMousePosX,e.initialMousePosY,r))}else r.dispose()}static computeHoverRanges(t,e,i){let o=1;if(t.hasModel()){const i=t._getViewModel(),s=i.coordinatesConverter,n=s.convertModelRangeToViewRange(e),r=new Position(n.startLineNumber,i.getLineMinColumn(n.startLineNumber));o=s.convertViewPositionToModelPosition(r).column}const s=e.startLineNumber;let n=e.startColumn,r=i[0].range,a=null;for(const t of i)r=Range.plusRange(r,t.range),t.range.startLineNumber===s&&t.range.endLineNumber===s&&(n=Math.max(Math.min(n,t.range.startColumn),o)),t.forceShowAtRange&&(a=t.range);return{showAtPosition:a?a.getStartPosition():new Position(s,e.startColumn),showAtSecondaryPosition:a?a.getStartPosition():new Position(s,n),highlightRange:r}}};ContentHoverController._DECORATION_OPTIONS=ModelDecorationOptions.register({description:"content-hover-highlight",className:"hoverHighlight"}),ContentHoverController=__decorate([__param(1,IInstantiationService),__param(2,IKeybindingService)],ContentHoverController);export{ContentHoverController};class HoverResult{constructor(t,e,i){this.anchor=t,this.messages=e,this.isComplete=i}filter(t){const e=this.messages.filter((e=>e.isValidForHoverAnchor(t)));return e.length===this.messages.length?this:new FilteredHoverResult(this,this.anchor,e,this.isComplete)}}class FilteredHoverResult extends HoverResult{constructor(t,e,i,o){super(e,i,o),this.original=t}filter(t){return this.original.filter(t)}}class ContentHoverVisibleData{constructor(t,e,i,o,s,n,r,a,h,l){this.colorPicker=t,this.showAtPosition=e,this.showAtSecondaryPosition=i,this.preferAbove=o,this.stoleFocus=s,this.source=n,this.isBeforeContent=r,this.initialMousePosX=a,this.initialMousePosY=h,this.disposables=l,this.closestMouseDistance=void 0}}let ContentHoverWidget=class t extends Disposable{get position(){var t,e;return null!==(e=null===(t=this._visibleData)||void 0===t?void 0:t.showAtPosition)&&void 0!==e?e:null}get isColorPickerVisible(){var t;return Boolean(null===(t=this._visibleData)||void 0===t?void 0:t.colorPicker)}get isVisibleFromKeyboard(){var t;return 1===(null===(t=this._visibleData)||void 0===t?void 0:t.source)}constructor(t,e){super(),this._editor=t,this._contextKeyService=e,this.allowEditorOverflow=!0,this._hoverVisibleKey=EditorContextKeys.hoverVisible.bindTo(this._contextKeyService),this._hover=this._register(new HoverWidget),this._visibleData=null,this._register(this._editor.onDidLayoutChange((()=>this._layout()))),this._register(this._editor.onDidChangeConfiguration((t=>{t.hasChanged(47)&&this._updateFont()}))),this._setVisibleData(null),this._layout(),this._editor.addContentWidget(this)}dispose(){this._editor.removeContentWidget(this),this._visibleData&&this._visibleData.disposables.dispose(),super.dispose()}getId(){return t.ID}getDomNode(){return this._hover.containerDomNode}getPosition(){if(!this._visibleData)return null;let t=this._visibleData.preferAbove;!t&&this._contextKeyService.getContextKeyValue(SuggestContext.Visible.key)&&(t=!0);const e=this._visibleData.isBeforeContent?3:void 0;return{position:this._visibleData.showAtPosition,secondaryPosition:this._visibleData.showAtSecondaryPosition,preference:t?[1,2]:[2,1],positionAffinity:e}}isMouseGettingCloser(t,e){if(!this._visibleData)return!1;if(void 0===this._visibleData.initialMousePosX||void 0===this._visibleData.initialMousePosY)return this._visibleData.initialMousePosX=t,this._visibleData.initialMousePosY=e,!1;const i=dom.getDomNodePagePosition(this.getDomNode());void 0===this._visibleData.closestMouseDistance&&(this._visibleData.closestMouseDistance=computeDistanceFromPointToRectangle(this._visibleData.initialMousePosX,this._visibleData.initialMousePosY,i.left,i.top,i.width,i.height));const o=computeDistanceFromPointToRectangle(t,e,i.left,i.top,i.width,i.height);return!(o>this._visibleData.closestMouseDistance+4||(this._visibleData.closestMouseDistance=Math.min(this._visibleData.closestMouseDistance,o),0))}_setVisibleData(t){this._visibleData&&this._visibleData.disposables.dispose(),this._visibleData=t,this._hoverVisibleKey.set(!!this._visibleData),this._hover.containerDomNode.classList.toggle("hidden",!this._visibleData)}_layout(){const t=Math.max(this._editor.getLayoutInfo().height/4,250),{fontSize:e,lineHeight:i}=this._editor.getOption(47);this._hover.contentsDomNode.style.fontSize=`${e}px`,this._hover.contentsDomNode.style.lineHeight=""+i/e,this._hover.contentsDomNode.style.maxHeight=`${t}px`,this._hover.contentsDomNode.style.maxWidth=`${Math.max(.66*this._editor.getLayoutInfo().width,500)}px`}_updateFont(){Array.prototype.slice.call(this._hover.contentsDomNode.getElementsByClassName("code")).forEach((t=>this._editor.applyFontInfo(t)))}showAt(t,e){var i;this._setVisibleData(e),this._hover.contentsDomNode.textContent="",this._hover.contentsDomNode.appendChild(t),this._hover.contentsDomNode.style.paddingBottom="",this._updateFont(),this.onContentsChanged(),this._editor.render(),this.onContentsChanged(),e.stoleFocus&&this._hover.containerDomNode.focus(),null===(i=e.colorPicker)||void 0===i||i.layout()}hide(){if(this._visibleData){const t=this._visibleData.stoleFocus;this._setVisibleData(null),this._editor.layoutContentWidget(this),t&&this._editor.focus()}}onContentsChanged(){this._editor.layoutContentWidget(this),this._hover.onContentsChanged();const t=this._hover.scrollbar.getScrollDimensions();if(t.scrollWidth>t.width){const t=`${this._hover.scrollbar.options.horizontalScrollbarSize}px`;this._hover.contentsDomNode.style.paddingBottom!==t&&(this._hover.contentsDomNode.style.paddingBottom=t,this._editor.layoutContentWidget(this),this._hover.onContentsChanged())}}clear(){this._hover.contentsDomNode.textContent=""}};ContentHoverWidget.ID="editor.contrib.contentHoverWidget",ContentHoverWidget=__decorate([__param(1,IContextKeyService)],ContentHoverWidget);export{ContentHoverWidget};let EditorHoverStatusBar=class extends Disposable{get hasContent(){return this._hasContent}constructor(t){super(),this._keybindingService=t,this._hasContent=!1,this.hoverElement=$("div.hover-row.status-bar"),this.actionsElement=dom.append(this.hoverElement,$("div.actions"))}addAction(t){const e=this._keybindingService.lookupKeybinding(t.commandId),i=e?e.getLabel():null;return this._hasContent=!0,this._register(HoverAction.render(this.actionsElement,t,i))}append(t){const e=dom.append(this.actionsElement,t);return this._hasContent=!0,e}};EditorHoverStatusBar=__decorate([__param(0,IKeybindingService)],EditorHoverStatusBar);class ContentHoverComputer{get anchor(){return this._anchor}set anchor(t){this._anchor=t}get shouldFocus(){return this._shouldFocus}set shouldFocus(t){this._shouldFocus=t}get source(){return this._source}set source(t){this._source=t}get insistOnKeepingHoverVisible(){return this._insistOnKeepingHoverVisible}set insistOnKeepingHoverVisible(t){this._insistOnKeepingHoverVisible=t}constructor(t,e){this._editor=t,this._participants=e,this._anchor=null,this._shouldFocus=!1,this._source=0,this._insistOnKeepingHoverVisible=!1}static _getLineDecorations(t,e){if(1!==e.type&&!e.supportsMarkerHover)return[];const i=t.getModel(),o=e.range.startLineNumber;if(o>i.getLineCount())return[];const s=i.getLineMaxColumn(o);return t.getLineDecorations(o).filter((t=>{if(t.options.isWholeLine)return!0;const i=t.range.startLineNumber===o?t.range.startColumn:1,n=t.range.endLineNumber===o?t.range.endColumn:s;if(t.options.showIfCollapsed){if(i>e.range.startColumn+1||e.range.endColumn-1>n)return!1}else if(i>e.range.startColumn||e.range.endColumn>n)return!1;return!0}))}computeAsync(t){const e=this._anchor;if(!this._editor.hasModel()||!e)return AsyncIterableObject.EMPTY;const i=ContentHoverComputer._getLineDecorations(this._editor,e);return AsyncIterableObject.merge(this._participants.map((o=>o.computeAsync?o.computeAsync(e,i,t):AsyncIterableObject.EMPTY)))}computeSync(){if(!this._editor.hasModel()||!this._anchor)return[];const t=ContentHoverComputer._getLineDecorations(this._editor,this._anchor);let e=[];for(const i of this._participants)e=e.concat(i.computeSync(this._anchor,t));return coalesce(e)}}function computeDistanceFromPointToRectangle(t,e,i,o,s,n){const r=i+s/2,a=o+n/2,h=Math.max(Math.abs(t-r)-s/2,0),l=Math.max(Math.abs(e-a)-n/2,0);return Math.sqrt(h*h+l*l)}