var __decorate=this&&this.__decorate||function(e,r,o,t){var n,i=arguments.length,a=i<3?r:null===t?t=Object.getOwnPropertyDescriptor(r,o):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,r,o,t);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(i<3?n(a):i>3?n(r,o,a):n(r,o))||a);return i>3&&a&&Object.defineProperty(r,o,a),a},__param=this&&this.__param||function(e,r){return function(o,t){r(o,t,e)}};import*as dom from"../../../../base/browser/dom.js";import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{createCancelablePromise,disposableTimeout}from"../../../../base/common/async.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{basename}from"../../../../base/common/resources.js";import{Range}from"../../../common/core/range.js";import{IMarkerDecorationsService}from"../../../common/services/markerDecorations.js";import{getCodeActions}from"../../codeAction/browser/codeAction.js";import{QuickFixAction,CodeActionController}from"../../codeAction/browser/codeActionCommands.js";import{CodeActionKind,CodeActionTriggerSource}from"../../codeAction/common/types.js";import{MarkerController,NextMarkerAction}from"../../gotoError/browser/gotoError.js";import*as nls from"../../../../nls.js";import{IMarkerData,MarkerSeverity}from"../../../../platform/markers/common/markers.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{Progress}from"../../../../platform/progress/common/progress.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";const $=dom.$;export class MarkerHover{constructor(e,r,o){this.owner=e,this.range=r,this.marker=o}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}const markerCodeActionTrigger={type:1,filter:{include:CodeActionKind.QuickFix},triggerAction:CodeActionTriggerSource.QuickFixHover};let MarkerHoverParticipant=class{constructor(e,r,o,t){this._editor=e,this._markerDecorationsService=r,this._openerService=o,this._languageFeaturesService=t,this.hoverOrdinal=5,this.recentMarkerCodeActionsInfo=void 0}computeSync(e,r){if(!this._editor.hasModel()||1!==e.type&&!e.supportsMarkerHover)return[];const o=this._editor.getModel(),t=e.range.startLineNumber,n=o.getLineMaxColumn(t),i=[];for(const a of r){const r=a.range.startLineNumber===t?a.range.startColumn:1,s=a.range.endLineNumber===t?a.range.endColumn:n,c=this._markerDecorationsService.getMarker(o.uri,a);if(!c)continue;const d=new Range(e.range.startLineNumber,r,e.range.startLineNumber,s);i.push(new MarkerHover(this,d,c))}return i}renderHoverParts(e,r){if(!r.length)return Disposable.None;const o=new DisposableStore;r.forEach((r=>e.fragment.appendChild(this.renderMarkerHover(r,o))));const t=1===r.length?r[0]:r.sort(((e,r)=>MarkerSeverity.compare(e.marker.severity,r.marker.severity)))[0];return this.renderMarkerStatusbar(e,t,o),o}renderMarkerHover(e,r){const o=$("div.hover-row"),t=dom.append(o,$("div.marker.hover-contents")),{source:n,message:i,code:a,relatedInformation:s}=e.marker;this._editor.applyFontInfo(t);const c=dom.append(t,$("span"));if(c.style.whiteSpace="pre-wrap",c.innerText=i,n||a)if(a&&"string"!=typeof a){const e=$("span");n&&(dom.append(e,$("span")).innerText=n);const o=dom.append(e,$("a.code-link"));o.setAttribute("href",a.target.toString()),r.add(dom.addDisposableListener(o,"click",(e=>{this._openerService.open(a.target,{allowCommands:!0}),e.preventDefault(),e.stopPropagation()}))),dom.append(o,$("span")).innerText=a.value;const i=dom.append(t,e);i.style.opacity="0.6",i.style.paddingLeft="6px"}else{const e=dom.append(t,$("span"));e.style.opacity="0.6",e.style.paddingLeft="6px",e.innerText=n&&a?`${n}(${a})`:n||`(${a})`}if(isNonEmptyArray(s))for(const{message:e,resource:o,startLineNumber:n,startColumn:i}of s){const a=dom.append(t,$("div"));a.style.marginTop="8px";const s=dom.append(a,$("a"));s.innerText=`${basename(o)}(${n}, ${i}): `,s.style.cursor="pointer",r.add(dom.addDisposableListener(s,"click",(e=>{e.stopPropagation(),e.preventDefault(),this._openerService&&this._openerService.open(o,{fromUserGesture:!0,editorOptions:{selection:{startLineNumber:n,startColumn:i}}}).catch(onUnexpectedError)})));const c=dom.append(a,$("span"));c.innerText=e,this._editor.applyFontInfo(c)}return o}renderMarkerStatusbar(e,r,o){if(r.marker.severity!==MarkerSeverity.Error&&r.marker.severity!==MarkerSeverity.Warning&&r.marker.severity!==MarkerSeverity.Info||e.statusBar.addAction({label:nls.localize("view problem","View Problem"),commandId:NextMarkerAction.ID,run:()=>{var o;e.hide(),null===(o=MarkerController.get(this._editor))||void 0===o||o.showAtMarker(r.marker),this._editor.focus()}}),!this._editor.getOption(86)){const t=e.statusBar.append($("div"));this.recentMarkerCodeActionsInfo&&(IMarkerData.makeKey(this.recentMarkerCodeActionsInfo.marker)===IMarkerData.makeKey(r.marker)?this.recentMarkerCodeActionsInfo.hasCodeActions||(t.textContent=nls.localize("noQuickFixes","No quick fixes available")):this.recentMarkerCodeActionsInfo=void 0);const n=this.recentMarkerCodeActionsInfo&&!this.recentMarkerCodeActionsInfo.hasCodeActions?Disposable.None:o.add(disposableTimeout((()=>t.textContent=nls.localize("checkingForQuickFixes","Checking for quick fixes...")),200));t.textContent||(t.textContent=String.fromCharCode(160));const i=this.getCodeActions(r.marker);o.add(toDisposable((()=>i.cancel()))),i.then((i=>{if(n.dispose(),this.recentMarkerCodeActionsInfo={marker:r.marker,hasCodeActions:i.validActions.length>0},!this.recentMarkerCodeActionsInfo.hasCodeActions)return i.dispose(),void(t.textContent=nls.localize("noQuickFixes","No quick fixes available"));t.style.display="none";let a=!1;o.add(toDisposable((()=>{a||i.dispose()}))),e.statusBar.addAction({label:nls.localize("quick fixes","Quick Fix..."),commandId:QuickFixAction.Id,run:r=>{a=!0;const o=CodeActionController.get(this._editor),t=dom.getDomNodePagePosition(r);e.hide(),null==o||o.showCodeActions(markerCodeActionTrigger,i,{x:t.left+6,y:t.top+t.height+6,width:t.width,height:t.height})}})}),onUnexpectedError)}}getCodeActions(e){return createCancelablePromise((r=>getCodeActions(this._languageFeaturesService.codeActionProvider,this._editor.getModel(),new Range(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn),markerCodeActionTrigger,Progress.None,r)))}};MarkerHoverParticipant=__decorate([__param(1,IMarkerDecorationsService),__param(2,IOpenerService),__param(3,ILanguageFeaturesService)],MarkerHoverParticipant);export{MarkerHoverParticipant};