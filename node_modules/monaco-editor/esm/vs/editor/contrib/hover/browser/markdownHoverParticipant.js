var __decorate=this&&this.__decorate||function(e,r,n,o){var t,a=arguments.length,i=a<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,r,n,o);else for(var s=e.length-1;s>=0;s--)(t=e[s])&&(i=(a<3?t(i):a>3?t(r,n,i):t(r,n))||i);return a>3&&i&&Object.defineProperty(r,n,i),i},__param=this&&this.__param||function(e,r){return function(n,o){r(n,o,e)}};import*as dom from"../../../../base/browser/dom.js";import{asArray}from"../../../../base/common/arrays.js";import{AsyncIterableObject}from"../../../../base/common/async.js";import{isEmptyMarkdownString,MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{ILanguageService}from"../../../common/languages/language.js";import{getHover}from"./getHover.js";import*as nls from"../../../../nls.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";const $=dom.$;export class MarkdownHover{constructor(e,r,n,o,t){this.owner=e,this.range=r,this.contents=n,this.isBeforeContent=o,this.ordinal=t}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}}let MarkdownHoverParticipant=class{constructor(e,r,n,o,t){this._editor=e,this._languageService=r,this._openerService=n,this._configurationService=o,this._languageFeaturesService=t,this.hoverOrdinal=2}createLoadingMessage(e){return new MarkdownHover(this,e.range,[(new MarkdownString).appendText(nls.localize("modesContentHover.loading","Loading..."))],!1,2e3)}computeSync(e,r){if(!this._editor.hasModel()||1!==e.type)return[];const n=this._editor.getModel(),o=e.range.startLineNumber,t=n.getLineMaxColumn(o),a=[];let i=1e3;const s=n.getLineLength(o),c=n.getLanguageIdAtPosition(e.range.startLineNumber,e.range.startColumn),d=this._editor.getOption(111),m=this._configurationService.getValue("editor.maxTokenizationLineLength",{overrideIdentifier:c});let g=!1;d>=0&&s>d&&e.range.startColumn>=d&&(g=!0,a.push(new MarkdownHover(this,e.range,[{value:nls.localize("stopped rendering","Rendering paused for long line for performance reasons. This can be configured via `editor.stopRenderingLineAfter`.")}],!1,i++))),!g&&"number"==typeof m&&s>=m&&a.push(new MarkdownHover(this,e.range,[{value:nls.localize("too many characters","Tokenization is skipped for long lines for performance reasons. This can be configured via `editor.maxTokenizationLineLength`.")}],!1,i++));let l=!1;for(const n of r){const r=n.range.startLineNumber===o?n.range.startColumn:1,s=n.range.endLineNumber===o?n.range.endColumn:t,c=n.options.hoverMessage;if(!c||isEmptyMarkdownString(c))continue;n.options.beforeContentClassName&&(l=!0);const d=new Range(e.range.startLineNumber,r,e.range.startLineNumber,s);a.push(new MarkdownHover(this,d,asArray(c),l,i++))}return a}computeAsync(e,r,n){if(!this._editor.hasModel()||1!==e.type)return AsyncIterableObject.EMPTY;const o=this._editor.getModel();if(!this._languageFeaturesService.hoverProvider.has(o))return AsyncIterableObject.EMPTY;const t=new Position(e.range.startLineNumber,e.range.startColumn);return getHover(this._languageFeaturesService.hoverProvider,o,t,n).filter((e=>!isEmptyMarkdownString(e.hover.contents))).map((r=>{const n=r.hover.range?Range.lift(r.hover.range):e.range;return new MarkdownHover(this,n,r.hover.contents,!1,r.ordinal)}))}renderHoverParts(e,r){return renderMarkdownHovers(e,r,this._editor,this._languageService,this._openerService)}};MarkdownHoverParticipant=__decorate([__param(1,ILanguageService),__param(2,IOpenerService),__param(3,IConfigurationService),__param(4,ILanguageFeaturesService)],MarkdownHoverParticipant);export{MarkdownHoverParticipant};export function renderMarkdownHovers(e,r,n,o,t){r.sort(((e,r)=>e.ordinal-r.ordinal));const a=new DisposableStore;for(const i of r)for(const r of i.contents){if(isEmptyMarkdownString(r))continue;const i=$("div.hover-row.markdown-hover"),s=dom.append(i,$("div.hover-contents")),c=a.add(new MarkdownRenderer({editor:n},o,t));a.add(c.onDidRenderAsync((()=>{s.className="hover-contents code-hover-contents",e.onContentsChanged()})));const d=a.add(c.render(r));s.appendChild(d.element),e.fragment.appendChild(i)}return a}