var __decorate=this&&this.__decorate||function(e,r,t,i){var o,a=arguments.length,n=a<3?r:null===i?i=Object.getOwnPropertyDescriptor(r,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,r,t,i);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(n=(a<3?o(n):a>3?o(r,t,n):o(r,t))||n);return a>3&&n&&Object.defineProperty(r,t,n),n},__param=this&&this.__param||function(e,r){return function(t,i){r(t,i,e)}};import*as dom from"../../../../base/browser/dom.js";import{ScrollableElement}from"../../../../base/browser/ui/scrollbar/scrollableElement.js";import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{Color}from"../../../../base/common/color.js";import{Emitter}from"../../../../base/common/event.js";import{DisposableStore,dispose}from"../../../../base/common/lifecycle.js";import{basename}from"../../../../base/common/resources.js";import{splitLines}from"../../../../base/common/strings.js";import"./media/gotoErrorWidget.css";import{Range}from"../../../common/core/range.js";import{peekViewTitleForeground,peekViewTitleInfoForeground,PeekViewWidget}from"../../peekView/browser/peekView.js";import*as nls from"../../../../nls.js";import{createAndFillInActionBarActions}from"../../../../platform/actions/browser/menuEntryActionViewItem.js";import{IMenuService,MenuId}from"../../../../platform/actions/common/actions.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILabelService}from"../../../../platform/label/common/label.js";import{MarkerSeverity}from"../../../../platform/markers/common/markers.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{SeverityIcon}from"../../../../platform/severityIcon/browser/severityIcon.js";import{contrastBorder,editorBackground,editorErrorBorder,editorErrorForeground,editorInfoBorder,editorInfoForeground,editorWarningBorder,editorWarningForeground,oneOf,registerColor,transparent}from"../../../../platform/theme/common/colorRegistry.js";import{IThemeService}from"../../../../platform/theme/common/themeService.js";class MessageWidget{constructor(e,r,t,i,o){this._openerService=i,this._labelService=o,this._lines=0,this._longestLineLength=0,this._relatedDiagnostics=new WeakMap,this._disposables=new DisposableStore,this._editor=r;const a=document.createElement("div");a.className="descriptioncontainer",this._messageBlock=document.createElement("div"),this._messageBlock.classList.add("message"),this._messageBlock.setAttribute("aria-live","assertive"),this._messageBlock.setAttribute("role","alert"),a.appendChild(this._messageBlock),this._relatedBlock=document.createElement("div"),a.appendChild(this._relatedBlock),this._disposables.add(dom.addStandardDisposableListener(this._relatedBlock,"click",(e=>{e.preventDefault();const r=this._relatedDiagnostics.get(e.target);r&&t(r)}))),this._scrollable=new ScrollableElement(a,{horizontal:1,vertical:1,useShadows:!1,horizontalScrollbarSize:6,verticalScrollbarSize:6}),e.appendChild(this._scrollable.getDomNode()),this._disposables.add(this._scrollable.onScroll((e=>{a.style.left=`-${e.scrollLeft}px`,a.style.top=`-${e.scrollTop}px`}))),this._disposables.add(this._scrollable)}dispose(){dispose(this._disposables)}update(e){const{source:r,message:t,relatedInformation:i,code:o}=e;let a=((null==r?void 0:r.length)||0)+"()".length;o&&(a+="string"==typeof o?o.length:o.value.length);const n=splitLines(t);this._lines=n.length,this._longestLineLength=0;for(const e of n)this._longestLineLength=Math.max(e.length+a,this._longestLineLength);dom.clearNode(this._messageBlock),this._messageBlock.setAttribute("aria-label",this.getAriaLabel(e)),this._editor.applyFontInfo(this._messageBlock);let s=this._messageBlock;for(const e of n)s=document.createElement("div"),s.innerText=e,""===e&&(s.style.height=this._messageBlock.style.lineHeight),this._messageBlock.appendChild(s);if(r||o){const e=document.createElement("span");if(e.classList.add("details"),s.appendChild(e),r){const t=document.createElement("span");t.innerText=r,t.classList.add("source"),e.appendChild(t)}if(o)if("string"==typeof o){const r=document.createElement("span");r.innerText=`(${o})`,r.classList.add("code"),e.appendChild(r)}else this._codeLink=dom.$("a.code-link"),this._codeLink.setAttribute("href",`${o.target.toString()}`),this._codeLink.onclick=e=>{this._openerService.open(o.target,{allowCommands:!0}),e.preventDefault(),e.stopPropagation()},dom.append(this._codeLink,dom.$("span")).innerText=o.value,e.appendChild(this._codeLink)}if(dom.clearNode(this._relatedBlock),this._editor.applyFontInfo(this._relatedBlock),isNonEmptyArray(i)){const e=this._relatedBlock.appendChild(document.createElement("div"));e.style.paddingTop=`${Math.floor(.66*this._editor.getOption(63))}px`,this._lines+=1;for(const r of i){const t=document.createElement("div"),i=document.createElement("a");i.classList.add("filename"),i.innerText=`${this._labelService.getUriBasenameLabel(r.resource)}(${r.startLineNumber}, ${r.startColumn}): `,i.title=this._labelService.getUriLabel(r.resource),this._relatedDiagnostics.set(i,r);const o=document.createElement("span");o.innerText=r.message,t.appendChild(i),t.appendChild(o),this._lines+=1,e.appendChild(t)}}const l=this._editor.getOption(47),d=Math.ceil(l.typicalFullwidthCharacterWidth*this._longestLineLength*.75),c=l.lineHeight*this._lines;this._scrollable.setScrollDimensions({scrollWidth:d,scrollHeight:c})}layout(e,r){this._scrollable.getDomNode().style.height=`${e}px`,this._scrollable.getDomNode().style.width=`${r}px`,this._scrollable.setScrollDimensions({width:r,height:e})}getHeightInLines(){return Math.min(17,this._lines)}getAriaLabel(e){let r="";switch(e.severity){case MarkerSeverity.Error:r=nls.localize("Error","Error");break;case MarkerSeverity.Warning:r=nls.localize("Warning","Warning");break;case MarkerSeverity.Info:r=nls.localize("Info","Info");break;case MarkerSeverity.Hint:r=nls.localize("Hint","Hint")}let t=nls.localize("marker aria","{0} at {1}. ",r,e.startLineNumber+":"+e.startColumn);const i=this._editor.getModel();return i&&e.startLineNumber<=i.getLineCount()&&e.startLineNumber>=1&&(t=`${i.getLineContent(e.startLineNumber)}, ${t}`),t}}let MarkerNavigationWidget=class e extends PeekViewWidget{constructor(e,r,t,i,o,a,n){super(e,{showArrow:!0,showFrame:!0,isAccessible:!0,frameWidth:1},o),this._themeService=r,this._openerService=t,this._menuService=i,this._contextKeyService=a,this._labelService=n,this._callOnDispose=new DisposableStore,this._onDidSelectRelatedInformation=new Emitter,this.onDidSelectRelatedInformation=this._onDidSelectRelatedInformation.event,this._severity=MarkerSeverity.Warning,this._backgroundColor=Color.white,this._applyTheme(r.getColorTheme()),this._callOnDispose.add(r.onDidColorThemeChange(this._applyTheme.bind(this))),this.create()}_applyTheme(e){this._backgroundColor=e.getColor(editorMarkerNavigationBackground);let r=editorMarkerNavigationError,t=editorMarkerNavigationErrorHeader;this._severity===MarkerSeverity.Warning?(r=editorMarkerNavigationWarning,t=editorMarkerNavigationWarningHeader):this._severity===MarkerSeverity.Info&&(r=editorMarkerNavigationInfo,t=editorMarkerNavigationInfoHeader);const i=e.getColor(r),o=e.getColor(t);this.style({arrowColor:i,frameColor:i,headerBackgroundColor:o,primaryHeadingColor:e.getColor(peekViewTitleForeground),secondaryHeadingColor:e.getColor(peekViewTitleInfoForeground)})}_applyStyles(){this._parentContainer&&(this._parentContainer.style.backgroundColor=this._backgroundColor?this._backgroundColor.toString():""),super._applyStyles()}dispose(){this._callOnDispose.dispose(),super.dispose()}_fillHead(r){super._fillHead(r),this._disposables.add(this._actionbarWidget.actionRunner.onWillRun((e=>this.editor.focus())));const t=[],i=this._menuService.createMenu(e.TitleMenu,this._contextKeyService);createAndFillInActionBarActions(i,void 0,t),this._actionbarWidget.push(t,{label:!1,icon:!0,index:0}),i.dispose()}_fillTitleIcon(e){this._icon=dom.append(e,dom.$(""))}_fillBody(e){this._parentContainer=e,e.classList.add("marker-widget"),this._parentContainer.tabIndex=0,this._parentContainer.setAttribute("role","tooltip"),this._container=document.createElement("div"),e.appendChild(this._container),this._message=new MessageWidget(this._container,this.editor,(e=>this._onDidSelectRelatedInformation.fire(e)),this._openerService,this._labelService),this._disposables.add(this._message)}show(){throw new Error("call showAtMarker")}showAtMarker(e,r,t){this._container.classList.remove("stale"),this._message.update(e),this._severity=e.severity,this._applyTheme(this._themeService.getColorTheme());const i=Range.lift(e),o=this.editor.getPosition(),a=o&&i.containsPosition(o)?o:i.getStartPosition();super.show(a,this.computeRequiredHeight());const n=this.editor.getModel();if(n){const e=t>1?nls.localize("problems","{0} of {1} problems",r,t):nls.localize("change","{0} of {1} problem",r,t);this.setTitle(basename(n.uri),e)}this._icon.className=`codicon ${SeverityIcon.className(MarkerSeverity.toSeverity(this._severity))}`,this.editor.revealPositionNearTop(a,0),this.editor.focus()}updateMarker(e){this._container.classList.remove("stale"),this._message.update(e)}showStale(){this._container.classList.add("stale"),this._relayout()}_doLayoutBody(e,r){super._doLayoutBody(e,r),this._heightInPixel=e,this._message.layout(e,r),this._container.style.height=`${e}px`}_onWidth(e){this._message.layout(this._heightInPixel,e)}_relayout(){super._relayout(this.computeRequiredHeight())}computeRequiredHeight(){return 3+this._message.getHeightInLines()}};MarkerNavigationWidget.TitleMenu=new MenuId("gotoErrorTitleMenu"),MarkerNavigationWidget=__decorate([__param(1,IThemeService),__param(2,IOpenerService),__param(3,IMenuService),__param(4,IInstantiationService),__param(5,IContextKeyService),__param(6,ILabelService)],MarkerNavigationWidget);export{MarkerNavigationWidget};const errorDefault=oneOf(editorErrorForeground,editorErrorBorder),warningDefault=oneOf(editorWarningForeground,editorWarningBorder),infoDefault=oneOf(editorInfoForeground,editorInfoBorder),editorMarkerNavigationError=registerColor("editorMarkerNavigationError.background",{dark:errorDefault,light:errorDefault,hcDark:contrastBorder,hcLight:contrastBorder},nls.localize("editorMarkerNavigationError","Editor marker navigation widget error color.")),editorMarkerNavigationErrorHeader=registerColor("editorMarkerNavigationError.headerBackground",{dark:transparent(editorMarkerNavigationError,.1),light:transparent(editorMarkerNavigationError,.1),hcDark:null,hcLight:null},nls.localize("editorMarkerNavigationErrorHeaderBackground","Editor marker navigation widget error heading background.")),editorMarkerNavigationWarning=registerColor("editorMarkerNavigationWarning.background",{dark:warningDefault,light:warningDefault,hcDark:contrastBorder,hcLight:contrastBorder},nls.localize("editorMarkerNavigationWarning","Editor marker navigation widget warning color.")),editorMarkerNavigationWarningHeader=registerColor("editorMarkerNavigationWarning.headerBackground",{dark:transparent(editorMarkerNavigationWarning,.1),light:transparent(editorMarkerNavigationWarning,.1),hcDark:"#0C141F",hcLight:transparent(editorMarkerNavigationWarning,.2)},nls.localize("editorMarkerNavigationWarningBackground","Editor marker navigation widget warning heading background.")),editorMarkerNavigationInfo=registerColor("editorMarkerNavigationInfo.background",{dark:infoDefault,light:infoDefault,hcDark:contrastBorder,hcLight:contrastBorder},nls.localize("editorMarkerNavigationInfo","Editor marker navigation widget info color.")),editorMarkerNavigationInfoHeader=registerColor("editorMarkerNavigationInfo.headerBackground",{dark:transparent(editorMarkerNavigationInfo,.1),light:transparent(editorMarkerNavigationInfo,.1),hcDark:null,hcLight:null},nls.localize("editorMarkerNavigationInfoHeaderBackground","Editor marker navigation widget info heading background.")),editorMarkerNavigationBackground=registerColor("editorMarkerNavigation.background",{dark:editorBackground,light:editorBackground,hcDark:editorBackground,hcLight:editorBackground},nls.localize("editorMarkerNavigationBackground","Editor marker navigation widget background."));