var __decorate=this&&this.__decorate||function(e,t,r,i){var o,a=arguments.length,s=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(s=(a<3?o(s):a>3?o(t,r,s):o(t,r))||s);return a>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,a){function s(e){try{c(i.next(e))}catch(e){a(e)}}function n(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}c((i=i.apply(e,t||[])).next())}))};import{DataTransfers}from"../../../../base/browser/dnd.js";import{addDisposableListener}from"../../../../base/browser/dom.js";import{createCancelablePromise,raceCancellation}from"../../../../base/common/async.js";import{createStringDataTransferItem,UriList}from"../../../../base/common/dataTransfer.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{Mimes}from"../../../../base/common/mime.js";import{Schemas}from"../../../../base/common/network.js";import{generateUuid}from"../../../../base/common/uuid.js";import{toVSDataTransfer}from"../../../browser/dnd.js";import{IBulkEditService,ResourceTextEdit}from"../../../browser/services/bulkEditService.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{SnippetParser}from"../../snippet/browser/snippetParser.js";import{localize}from"../../../../nls.js";import{IClipboardService}from"../../../../platform/clipboard/common/clipboardService.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IProgressService}from"../../../../platform/progress/common/progress.js";const vscodeClipboardMime="application/vnd.code.copyMetadata";let CopyPasteController=class extends Disposable{constructor(e,t,r,i,o,a){super(),this._bulkEditService=t,this._clipboardService=r,this._configurationService=i,this._languageFeaturesService=o,this._progressService=a,this._editor=e;const s=e.getContainerDomNode();this._register(addDisposableListener(s,"copy",(e=>this.handleCopy(e)))),this._register(addDisposableListener(s,"cut",(e=>this.handleCopy(e)))),this._register(addDisposableListener(s,"paste",(e=>this.handlePaste(e)),!0))}arePasteActionsEnabled(e){return!!this._configurationService.getValue("editor.experimental.pasteActions.enabled",{resource:e.uri})||e.uri.scheme===Schemas.vscodeNotebookCell}handleCopy(e){var t;if(!e.clipboardData||!this._editor.hasTextFocus())return;const r=this._editor.getModel(),i=this._editor.getSelections();if(!r||!(null==i?void 0:i.length))return;if(!this.arePasteActionsEnabled(r))return;const o=[...i],a=i[0],s=a.isEmpty();if(s){if(!this._editor.getOption(34))return;o[0]=new Range(a.startLineNumber,0,a.startLineNumber,r.getLineLength(a.startLineNumber))}const n=this._languageFeaturesService.documentPasteEditProvider.ordered(r).filter((e=>!!e.prepareDocumentPaste));if(!n.length)return void this.setCopyMetadata(e.clipboardData,{wasFromEmptySelection:s});const c=toVSDataTransfer(e.clipboardData),l=generateUuid();this.setCopyMetadata(e.clipboardData,{id:l,wasFromEmptySelection:s});const d=createCancelablePromise((e=>__awaiter(this,void 0,void 0,(function*(){const t=yield Promise.all(n.map((t=>t.prepareDocumentPaste(r,o,c,e))));for(const e of t)null==e||e.forEach(((e,t)=>{c.replace(t,e)}));return c}))));null===(t=this._currentClipboardItem)||void 0===t||t.dataTransferPromise.cancel(),this._currentClipboardItem={handle:l,dataTransferPromise:d}}setCopyMetadata(e,t){e.setData(vscodeClipboardMime,JSON.stringify(t))}handlePaste(e){var t,r,i,o;return __awaiter(this,void 0,void 0,(function*(){if(!e.clipboardData||!this._editor.hasTextFocus())return;const a=this._editor.getSelections();if(!(null==a?void 0:a.length)||!this._editor.hasModel())return;const s=this._editor.getModel();if(!this.arePasteActionsEnabled(s))return;let n;const c=null===(t=e.clipboardData)||void 0===t?void 0:t.getData(vscodeClipboardMime);c&&"string"==typeof c&&(n=JSON.parse(c));const l=this._languageFeaturesService.documentPasteEditProvider.ordered(s);if(!l.length)return;e.preventDefault(),e.stopImmediatePropagation();const d=new EditorStateCancellationTokenSource(this._editor,3);try{const t=toVSDataTransfer(e.clipboardData);if((null==n?void 0:n.id)&&(null===(r=this._currentClipboardItem)||void 0===r?void 0:r.handle)===n.id){const e=yield this._currentClipboardItem.dataTransferPromise;if(d.token.isCancellationRequested)return;e.forEach(((e,r)=>{t.replace(r,e)}))}if(!t.has(Mimes.uriList)){const e=yield this._clipboardService.readResources();if(d.token.isCancellationRequested)return;e.length&&t.append(Mimes.uriList,createStringDataTransferItem(UriList.create(e)))}t.delete(vscodeClipboardMime);const c=yield this._progressService.withProgress({location:15,delay:750,title:localize("pasteProgressTitle","Running paste handlers..."),cancellable:!0},(()=>this.getProviderPasteEdit(l,t,s,a,d.token)),(()=>d.cancel()));if(d.token.isCancellationRequested)return;if(c){const e="string"==typeof c.insertText?SnippetParser.escape(c.insertText):c.insertText.snippet,t={edits:[new ResourceTextEdit(s.uri,{range:Selection.liftSelection(this._editor.getSelection()),text:e,insertAsSnippet:!0}),...null!==(o=null===(i=c.additionalEdit)||void 0===i?void 0:i.edits)&&void 0!==o?o:[]]};return void(yield this._bulkEditService.apply(t,{editor:this._editor}))}yield this.applyDefaultPasteHandler(t,n,d.token)}finally{d.dispose()}}))}getProviderPasteEdit(e,t,r,i,o){return raceCancellation((()=>__awaiter(this,void 0,void 0,(function*(){for(const a of e){if(o.isCancellationRequested)return;if(!isSupportedProvider(a,t))continue;const e=yield a.provideDocumentPasteEdits(r,i,t,o);if(e)return e}})))(),o)}applyDefaultPasteHandler(e,t,r){var i;return __awaiter(this,void 0,void 0,(function*(){const o=null!==(i=e.get(Mimes.text))&&void 0!==i?i:e.get("text");if(!o)return;const a=yield o.asString();r.isCancellationRequested||this._editor.trigger("keyboard","paste",{text:a,pasteOnNewLine:null==t?void 0:t.wasFromEmptySelection,multicursorText:null})}))}};CopyPasteController.ID="editor.contrib.copyPasteActionController",CopyPasteController=__decorate([__param(1,IBulkEditService),__param(2,IClipboardService),__param(3,IConfigurationService),__param(4,ILanguageFeaturesService),__param(5,IProgressService)],CopyPasteController);export{CopyPasteController};function isSupportedProvider(e,t){return e.pasteMimeTypes.some((e=>e.toLowerCase()===DataTransfers.FILES.toLowerCase()?[...t.values()].some((e=>e.asFile())):t.has(e)))}