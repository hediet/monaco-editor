var __awaiter=this&&this.__awaiter||function(t,e,o,n){return new(o||(o=Promise))((function(i,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};import{CancellationError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Schemas}from"../../../../base/common/network.js";import{URI}from"../../../../base/common/uri.js";export class InlayHintAnchor{constructor(t,e){this.range=t,this.direction=e}}export class InlayHintItem{constructor(t,e,o){this.hint=t,this.anchor=e,this.provider=o,this._isResolved=!1}with(t){const e=new InlayHintItem(this.hint,t.anchor,this.provider);return e._isResolved=this._isResolved,e._currentResolve=this._currentResolve,e}resolve(t){return __awaiter(this,void 0,void 0,(function*(){if("function"==typeof this.provider.resolveInlayHint){if(this._currentResolve){if(yield this._currentResolve,t.isCancellationRequested)return;return this.resolve(t)}this._isResolved||(this._currentResolve=this._doResolve(t).finally((()=>this._currentResolve=void 0))),yield this._currentResolve}}))}_doResolve(t){var e,o;return __awaiter(this,void 0,void 0,(function*(){try{const n=yield Promise.resolve(this.provider.resolveInlayHint(this.hint,t));this.hint.tooltip=null!==(e=null==n?void 0:n.tooltip)&&void 0!==e?e:this.hint.tooltip,this.hint.label=null!==(o=null==n?void 0:n.label)&&void 0!==o?o:this.hint.label,this._isResolved=!0}catch(t){onUnexpectedExternalError(t),this._isResolved=!1}}))}}export class InlayHintsFragments{static create(t,e,o,n){return __awaiter(this,void 0,void 0,(function*(){const i=[],s=t.ordered(e).reverse().map((t=>o.map((o=>__awaiter(this,void 0,void 0,(function*(){try{const s=yield t.provideInlayHints(e,o,n);(null==s?void 0:s.hints.length)&&i.push([s,t])}catch(t){onUnexpectedExternalError(t)}}))))));if(yield Promise.all(s.flat()),n.isCancellationRequested||e.isDisposed())throw new CancellationError;return new InlayHintsFragments(o,i,e)}))}constructor(t,e,o){this._disposables=new DisposableStore,this.ranges=t,this.provider=new Set;const n=[];for(const[t,i]of e){this._disposables.add(t),this.provider.add(i);for(const e of t.hints){const t=o.validatePosition(e.position);let s="before";const r=InlayHintsFragments._getRangeAtPosition(o,t);let a;r.getStartPosition().isBefore(t)?(a=Range.fromPositions(r.getStartPosition(),t),s="after"):(a=Range.fromPositions(t,r.getEndPosition()),s="before"),n.push(new InlayHintItem(e,new InlayHintAnchor(a,s),i))}}this.items=n.sort(((t,e)=>Position.compare(t.hint.position,e.hint.position)))}dispose(){this._disposables.dispose()}static _getRangeAtPosition(t,e){const o=e.lineNumber,n=t.getWordAtPosition(e);if(n)return new Range(o,n.startColumn,o,n.endColumn);t.tokenization.tokenizeIfCheap(o);const i=t.tokenization.getLineTokens(o),s=e.column-1,r=i.findTokenIndexAtOffset(s);let a=i.getStartOffset(r),l=i.getEndOffset(r);return l-a==1&&(a===s&&r>1?(a=i.getStartOffset(r-1),l=i.getEndOffset(r-1)):l===s&&r<i.getCount()-1&&(a=i.getStartOffset(r+1),l=i.getEndOffset(r+1))),new Range(o,a+1,o,l+1)}}export function asCommandLink(t){return URI.from({scheme:Schemas.command,path:t.id,query:t.arguments&&encodeURIComponent(JSON.stringify(t.arguments))}).toString()}