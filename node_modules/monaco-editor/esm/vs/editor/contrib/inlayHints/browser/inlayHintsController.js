var __decorate=this&&this.__decorate||function(e,t,o,i){var n,s=arguments.length,a=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var r=e.length-1;r>=0;r--)(n=e[r])&&(a=(s<3?n(a):s>3?n(t,o,a):n(t,o))||a);return s>3&&a&&Object.defineProperty(t,o,a),a},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,r)}l((i=i.apply(e,t||[])).next())}))};import{ModifierKeyEmitter}from"../../../../base/browser/dom.js";import{isNonEmptyArray}from"../../../../base/common/arrays.js";import{RunOnceScheduler}from"../../../../base/common/async.js";import{CancellationToken,CancellationTokenSource}from"../../../../base/common/cancellation.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{LRUCache}from"../../../../base/common/map.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{DynamicCssRules}from"../../../browser/editorDom.js";import{StableEditorScrollState}from"../../../browser/stableEditorScroll.js";import{EDITOR_FONT_DEFAULTS}from"../../../common/config/editorOptions.js";import{EditOperation}from"../../../common/core/editOperation.js";import{Range}from"../../../common/core/range.js";import*as languages from"../../../common/languages.js";import{InjectedTextCursorStops}from"../../../common/model.js";import{ModelDecorationInjectedTextOptions}from"../../../common/model/textModel.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{InlayHintAnchor,InlayHintsFragments}from"./inlayHints.js";import{goToDefinitionWithLocation,showGoToContextMenu}from"./inlayHintsLocations.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{registerSingleton}from"../../../../platform/instantiation/common/extensions.js";import{createDecorator,IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService,Severity}from"../../../../platform/notification/common/notification.js";import*as colors from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";class InlayHintsCache{constructor(){this._entries=new LRUCache(50)}get(e){const t=InlayHintsCache._key(e);return this._entries.get(t)}set(e,t){const o=InlayHintsCache._key(e);this._entries.set(o,t)}static _key(e){return`${e.uri.toString()}/${e.getVersionId()}`}}const IInlayHintsCache=createDecorator("IInlayHintsCache");registerSingleton(IInlayHintsCache,InlayHintsCache,1);export class RenderedInlayHintLabelPart{constructor(e,t){this.item=e,this.index=t}get part(){const e=this.item.hint.label;return"string"==typeof e?{label:e}:e[this.index]}}class ActiveInlayHintInfo{constructor(e,t){this.part=e,this.hasTriggerModifier=t}}let InlayHintsController=class e{static get(t){var o;return null!==(o=t.getContribution(e.ID))&&void 0!==o?o:void 0}constructor(e,t,o,i,n,s,a){this._editor=e,this._languageFeaturesService=t,this._inlayHintsCache=i,this._commandService=n,this._notificationService=s,this._instaService=a,this._disposables=new DisposableStore,this._sessionDisposables=new DisposableStore,this._decorationsMetadata=new Map,this._ruleFactory=new DynamicCssRules(this._editor),this._activeRenderMode=0,this._debounceInfo=o.for(t.inlayHintsProvider,"InlayHint",{min:25}),this._disposables.add(t.inlayHintsProvider.onDidChange((()=>this._update()))),this._disposables.add(e.onDidChangeModel((()=>this._update()))),this._disposables.add(e.onDidChangeModelLanguage((()=>this._update()))),this._disposables.add(e.onDidChangeConfiguration((e=>{e.hasChanged(134)&&this._update()}))),this._update()}dispose(){this._sessionDisposables.dispose(),this._removeAllDecorations(),this._disposables.dispose()}_update(){this._sessionDisposables.clear(),this._removeAllDecorations();const e=this._editor.getOption(134);if("off"===e.enabled)return;const t=this._editor.getModel();if(!t||!this._languageFeaturesService.inlayHintsProvider.has(t))return;const o=this._inlayHintsCache.get(t);let i;o&&this._updateHintsDecorators([t.getFullModelRange()],o),this._sessionDisposables.add(toDisposable((()=>{t.isDisposed()||this._cacheHintsForFastRestore(t)})));const n=new Set,s=new RunOnceScheduler((()=>__awaiter(this,void 0,void 0,(function*(){const e=Date.now();null==i||i.dispose(!0),i=new CancellationTokenSource;const o=t.onWillDispose((()=>null==i?void 0:i.cancel()));try{const a=i.token,r=yield InlayHintsFragments.create(this._languageFeaturesService.inlayHintsProvider,t,this._getHintsRanges(),a);if(s.delay=this._debounceInfo.update(t,Date.now()-e),a.isCancellationRequested)return void r.dispose();for(const e of r.provider)"function"!=typeof e.onDidChangeInlayHints||n.has(e)||(n.add(e),this._sessionDisposables.add(e.onDidChangeInlayHints((()=>{s.isScheduled()||s.schedule()}))));this._sessionDisposables.add(r),this._updateHintsDecorators(r.ranges,r.items),this._cacheHintsForFastRestore(t)}catch(e){onUnexpectedError(e)}finally{i.dispose(),o.dispose()}}))),this._debounceInfo.get(t));if(this._sessionDisposables.add(s),this._sessionDisposables.add(toDisposable((()=>null==i?void 0:i.dispose(!0)))),s.schedule(0),this._sessionDisposables.add(this._editor.onDidScrollChange((e=>{!e.scrollTopChanged&&s.isScheduled()||s.schedule()}))),this._sessionDisposables.add(this._editor.onDidChangeModelContent((e=>{const t=Math.max(s.delay,1250);s.schedule(t)}))),"on"===e.enabled)this._activeRenderMode=0;else{let t,o;"onUnlessPressed"===e.enabled?(t=0,o=1):(t=1,o=0),this._activeRenderMode=t,this._sessionDisposables.add(ModifierKeyEmitter.getInstance().event((e=>{if(!this._editor.hasModel())return;const i=e.altKey&&e.ctrlKey&&!e.shiftKey&&!e.metaKey?o:t;if(i!==this._activeRenderMode){this._activeRenderMode=i;const e=this._editor.getModel(),t=this._copyInlayHintsWithCurrentAnchor(e);this._updateHintsDecorators([e.getFullModelRange()],t),s.schedule(0)}})))}this._sessionDisposables.add(this._installDblClickGesture((()=>s.schedule(0)))),this._sessionDisposables.add(this._installLinkGesture()),this._sessionDisposables.add(this._installContextMenu())}_installLinkGesture(){const e=new DisposableStore,t=e.add(new ClickLinkGesture(this._editor)),o=new DisposableStore;return e.add(o),e.add(t.onMouseMoveOrRelevantKeyDown((e=>{const[t]=e,i=this._getInlayHintLabelPart(t),n=this._editor.getModel();if(!i||!n)return void o.clear();const s=new CancellationTokenSource;o.add(toDisposable((()=>s.dispose(!0)))),i.item.resolve(s.token),this._activeInlayHintPart=i.part.command||i.part.location?new ActiveInlayHintInfo(i,t.hasTriggerModifier):void 0;const a=n.validatePosition(i.item.hint.position).lineNumber,r=new Range(a,1,a,n.getLineMaxColumn(a)),l=this._getInlineHintsForRange(r);this._updateHintsDecorators([r],l),o.add(toDisposable((()=>{this._activeInlayHintPart=void 0,this._updateHintsDecorators([r],l)})))}))),e.add(t.onCancel((()=>o.clear()))),e.add(t.onExecute((e=>__awaiter(this,void 0,void 0,(function*(){const t=this._getInlayHintLabelPart(e);if(t){const o=t.part;o.location?this._instaService.invokeFunction(goToDefinitionWithLocation,e,this._editor,o.location):languages.Command.is(o.command)&&(yield this._invokeCommand(o.command,t.item))}}))))),e}_getInlineHintsForRange(e){const t=new Set;for(const o of this._decorationsMetadata.values())e.containsRange(o.item.anchor.range)&&t.add(o.item);return Array.from(t)}_installDblClickGesture(e){return this._editor.onMouseUp((t=>__awaiter(this,void 0,void 0,(function*(){if(2!==t.event.detail)return;const o=this._getInlayHintLabelPart(t);if(o&&(t.event.preventDefault(),yield o.item.resolve(CancellationToken.None),isNonEmptyArray(o.item.hint.textEdits))){const t=o.item.hint.textEdits.map((e=>EditOperation.replace(Range.lift(e.range),e.text)));this._editor.executeEdits("inlayHint.default",t),e()}}))))}_installContextMenu(){return this._editor.onContextMenu((e=>__awaiter(this,void 0,void 0,(function*(){if(!(e.event.target instanceof HTMLElement))return;const t=this._getInlayHintLabelPart(e);t&&(yield this._instaService.invokeFunction(showGoToContextMenu,this._editor,e.event.target,t))}))))}_getInlayHintLabelPart(e){var t;if(6!==e.target.type)return;const o=null===(t=e.target.detail.injectedText)||void 0===t?void 0:t.options;return o instanceof ModelDecorationInjectedTextOptions&&(null==o?void 0:o.attachedData)instanceof RenderedInlayHintLabelPart?o.attachedData:void 0}_invokeCommand(e,t){var o;return __awaiter(this,void 0,void 0,(function*(){try{yield this._commandService.executeCommand(e.id,...null!==(o=e.arguments)&&void 0!==o?o:[])}catch(e){this._notificationService.notify({severity:Severity.Error,source:t.provider.displayName,message:e})}}))}_cacheHintsForFastRestore(e){const t=this._copyInlayHintsWithCurrentAnchor(e);this._inlayHintsCache.set(e,t)}_copyInlayHintsWithCurrentAnchor(e){const t=new Map;for(const[o,i]of this._decorationsMetadata){if(t.has(i.item))continue;const n=e.getDecorationRange(o);if(n){const e=new InlayHintAnchor(n,i.item.anchor.direction),o=i.item.with({anchor:e});t.set(i.item,o)}}return Array.from(t.values())}_getHintsRanges(){const e=this._editor.getModel(),t=this._editor.getVisibleRangesPlusViewportAboveBelow(),o=[];for(const i of t.sort(Range.compareRangesUsingStarts)){const t=e.validateRange(new Range(i.startLineNumber-30,i.startColumn,i.endLineNumber+30,i.endColumn));0!==o.length&&Range.areIntersectingOrTouching(o[o.length-1],t)?o[o.length-1]=Range.plusRange(o[o.length-1],t):o.push(t)}return o}_updateHintsDecorators(t,o){var i,n;const s=[],a=(e,t,o,i,n)=>{const a={content:o,inlineClassNameAffectsLetterSpacing:!0,inlineClassName:t.className,cursorStops:i,attachedData:n};s.push({item:e,classNameRef:t,decoration:{range:e.anchor.range,options:{description:"InlayHint",showIfCollapsed:e.anchor.range.isEmpty(),collapseOnReplaceEdit:!e.anchor.range.isEmpty(),stickiness:0,[e.anchor.direction]:0===this._activeRenderMode?a:void 0}}})},r=(e,t)=>{const o=this._ruleFactory.createClassNameRef({width:(l/3|0)+"px",display:"inline-block"});a(e,o," ",t?InjectedTextCursorStops.Right:InjectedTextCursorStops.None)},{fontSize:l,fontFamily:c,padding:d,isUniform:m}=this._getLayoutInfo(),h="--code-editorInlayHintsFontFamily";this._editor.getContainerDomNode().style.setProperty(h,c);for(const t of o){t.hint.paddingLeft&&r(t,!1);const o="string"==typeof t.hint.label?[{label:t.hint.label}]:t.hint.label;for(let e=0;e<o.length;e++){const n=o[e],s=0===e,r=e===o.length-1,c={fontSize:`${l}px`,fontFamily:`var(${h}), ${EDITOR_FONT_DEFAULTS.fontFamily}`,verticalAlign:m?"baseline":"middle"};isNonEmptyArray(t.hint.textEdits)&&(c.cursor="default"),this._fillInColors(c,t.hint),(n.command||n.location)&&(null===(i=this._activeInlayHintPart)||void 0===i?void 0:i.part.item)===t&&this._activeInlayHintPart.part.index===e&&(c.textDecoration="underline",this._activeInlayHintPart.hasTriggerModifier&&(c.color=themeColorFromId(colors.editorActiveLinkForeground),c.cursor="pointer")),d&&(s&&r?(c.padding=`1px ${0|Math.max(1,l/4)}px`,c.borderRadius=(l/4|0)+"px"):s?(c.padding=`1px 0 1px ${0|Math.max(1,l/4)}px`,c.borderRadius=`${l/4|0}px 0 0 ${l/4|0}px`):r?(c.padding=`1px ${0|Math.max(1,l/4)}px 1px 0`,c.borderRadius=`0 ${l/4|0}px ${l/4|0}px 0`):c.padding="1px 0 1px 0"),a(t,this._ruleFactory.createClassNameRef(c),fixSpace(n.label),r&&!t.hint.paddingRight?InjectedTextCursorStops.Right:InjectedTextCursorStops.None,new RenderedInlayHintLabelPart(t,e))}if(t.hint.paddingRight&&r(t,!0),s.length>e._MAX_DECORATORS)break}const p=[];for(const e of t)for(const{id:t}of null!==(n=this._editor.getDecorationsInRange(e))&&void 0!==n?n:[]){const e=this._decorationsMetadata.get(t);e&&(p.push(t),e.classNameRef.dispose(),this._decorationsMetadata.delete(t))}const u=StableEditorScrollState.capture(this._editor);this._editor.changeDecorations((e=>{const t=e.deltaDecorations(p,s.map((e=>e.decoration)));for(let e=0;e<t.length;e++){const o=s[e];this._decorationsMetadata.set(t[e],o)}})),u.restore(this._editor)}_fillInColors(e,t){t.kind===languages.InlayHintKind.Parameter?(e.backgroundColor=themeColorFromId(colors.editorInlayHintParameterBackground),e.color=themeColorFromId(colors.editorInlayHintParameterForeground)):t.kind===languages.InlayHintKind.Type?(e.backgroundColor=themeColorFromId(colors.editorInlayHintTypeBackground),e.color=themeColorFromId(colors.editorInlayHintTypeForeground)):(e.backgroundColor=themeColorFromId(colors.editorInlayHintBackground),e.color=themeColorFromId(colors.editorInlayHintForeground))}_getLayoutInfo(){const e=this._editor.getOption(134),t=e.padding,o=this._editor.getOption(49),i=this._editor.getOption(46);let n=e.fontSize;(!n||n<5||n>o)&&(n=o);const s=e.fontFamily||i;return{fontSize:n,fontFamily:s,padding:t,isUniform:!t&&s===i&&n===o}}_removeAllDecorations(){this._editor.removeDecorations(Array.from(this._decorationsMetadata.keys()));for(const e of this._decorationsMetadata.values())e.classNameRef.dispose();this._decorationsMetadata.clear()}};InlayHintsController.ID="editor.contrib.InlayHints",InlayHintsController._MAX_DECORATORS=1500,InlayHintsController=__decorate([__param(1,ILanguageFeaturesService),__param(2,ILanguageFeatureDebounceService),__param(3,IInlayHintsCache),__param(4,ICommandService),__param(5,INotificationService),__param(6,IInstantiationService)],InlayHintsController);export{InlayHintsController};function fixSpace(e){return e.replace(/[ \t]/g," ")}CommandsRegistry.registerCommand("_executeInlayHintProvider",((e,...t)=>__awaiter(void 0,void 0,void 0,(function*(){const[o,i]=t;assertType(URI.isUri(o)),assertType(Range.isIRange(i));const{inlayHintsProvider:n}=e.get(ILanguageFeaturesService),s=yield e.get(ITextModelService).createModelReference(o);try{const e=yield InlayHintsFragments.create(n,s.object.textEditorModel,[Range.lift(i)],CancellationToken.None),t=e.items.map((e=>e.hint));return setTimeout((()=>e.dispose()),0),t}finally{s.dispose()}}))));