var __decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import{createCancelablePromise,RunOnceScheduler}from"../../../../base/common/async.js";import{Disposable}from"../../../../base/common/lifecycle.js";import{registerEditorContribution}from"../../../browser/editorExtensions.js";import{getDocumentRangeSemanticTokens,hasDocumentRangeSemanticTokensProvider}from"../../../common/services/getSemanticTokens.js";import{IModelService}from"../../../common/services/model.js";import{isSemanticColoringEnabled,SEMANTIC_HIGHLIGHTING_SETTING_ID}from"../../../common/services/modelService.js";import{toMultilineTokens2}from"../../../common/services/semanticTokensProviderStyling.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IThemeService}from"../../../../platform/theme/common/themeService.js";import{ILanguageFeatureDebounceService}from"../../../common/services/languageFeatureDebounce.js";import{StopWatch}from"../../../../base/common/stopwatch.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";let ViewportSemanticTokensContribution=class extends Disposable{constructor(e,t,i,o,n,r){super(),this._modelService=t,this._themeService=i,this._configurationService=o,this._editor=e,this._provider=r.documentRangeSemanticTokensProvider,this._debounceInformation=n.for(this._provider,"DocumentRangeSemanticTokens",{min:100,max:500}),this._tokenizeViewport=this._register(new RunOnceScheduler((()=>this._tokenizeViewportNow()),100)),this._outstandingRequests=[];const s=()=>{this._editor.hasModel()&&this._tokenizeViewport.schedule(this._debounceInformation.get(this._editor.getModel()))};this._register(this._editor.onDidScrollChange((()=>{s()}))),this._register(this._editor.onDidChangeModel((()=>{this._cancelAll(),s()}))),this._register(this._editor.onDidChangeModelContent((e=>{this._cancelAll(),s()}))),this._register(this._provider.onDidChange((()=>{this._cancelAll(),s()}))),this._register(this._configurationService.onDidChangeConfiguration((e=>{e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)&&(this._cancelAll(),s())}))),this._register(this._themeService.onDidColorThemeChange((()=>{this._cancelAll(),s()}))),s()}_cancelAll(){for(const e of this._outstandingRequests)e.cancel();this._outstandingRequests=[]}_removeOutstandingRequest(e){for(let t=0,i=this._outstandingRequests.length;t<i;t++)if(this._outstandingRequests[t]===e)return void this._outstandingRequests.splice(t,1)}_tokenizeViewportNow(){if(!this._editor.hasModel())return;const e=this._editor.getModel();if(e.tokenization.hasCompleteSemanticTokens())return;if(!isSemanticColoringEnabled(e,this._themeService,this._configurationService))return void(e.tokenization.hasSomeSemanticTokens()&&e.tokenization.setSemanticTokens(null,!1));if(!hasDocumentRangeSemanticTokensProvider(this._provider,e))return void(e.tokenization.hasSomeSemanticTokens()&&e.tokenization.setSemanticTokens(null,!1));const t=this._editor.getVisibleRangesPlusViewportAboveBelow();this._outstandingRequests=this._outstandingRequests.concat(t.map((t=>this._requestRange(e,t))))}_requestRange(e,t){const i=e.getVersionId(),o=createCancelablePromise((i=>Promise.resolve(getDocumentRangeSemanticTokens(this._provider,e,t,i)))),n=new StopWatch(!1);return o.then((o=>{if(this._debounceInformation.update(e,n.elapsed()),!o||!o.tokens||e.isDisposed()||e.getVersionId()!==i)return;const{provider:r,tokens:s}=o,a=this._modelService.getSemanticTokensProviderStyling(r);e.tokenization.setPartialSemanticTokens(t,toMultilineTokens2(s,a,e.getLanguageId()))})).then((()=>this._removeOutstandingRequest(o)),(()=>this._removeOutstandingRequest(o))),o}};ViewportSemanticTokensContribution.ID="editor.contrib.viewportSemanticTokens",ViewportSemanticTokensContribution=__decorate([__param(1,IModelService),__param(2,IThemeService),__param(3,IConfigurationService),__param(4,ILanguageFeatureDebounceService),__param(5,ILanguageFeaturesService)],ViewportSemanticTokensContribution),registerEditorContribution(ViewportSemanticTokensContribution.ID,ViewportSemanticTokensContribution,1);