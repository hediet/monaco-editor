var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function s(e){try{d(i.next(e))}catch(e){r(e)}}function a(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}d((i=i.apply(e,t||[])).next())}))};import{createCancelablePromise}from"../../../../../base/common/async.js";import{onUnexpectedError}from"../../../../../base/common/errors.js";import{MarkdownString}from"../../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../../base/common/lifecycle.js";import{withNullAsUndefined}from"../../../../../base/common/types.js";import"./goToDefinitionAtPosition.css";import{EditorState}from"../../../editorState/browser/editorState.js";import{registerEditorContribution}from"../../../../browser/editorExtensions.js";import{Range}from"../../../../common/core/range.js";import{ILanguageService}from"../../../../common/languages/language.js";import{ITextModelService}from"../../../../common/services/resolverService.js";import{ClickLinkGesture}from"./clickLinkGesture.js";import{PeekContext}from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{IContextKeyService}from"../../../../../platform/contextkey/common/contextkey.js";import{DefinitionAction}from"../goToCommands.js";import{getDefinitionsAtPosition}from"../goToSymbol.js";import{ILanguageFeaturesService}from"../../../../common/services/languageFeatures.js";import{ModelDecorationInjectedTextOptions}from"../../../../common/model/textModel.js";let GotoDefinitionAtPositionEditorContribution=class e{constructor(e,t,o,i){this.textModelResolverService=t,this.languageService=o,this.languageFeaturesService=i,this.toUnhook=new DisposableStore,this.toUnhookForKeyboard=new DisposableStore,this.currentWordAtPosition=null,this.previousPromise=null,this.editor=e,this.linkDecorations=this.editor.createDecorationsCollection();const n=new ClickLinkGesture(e);this.toUnhook.add(n),this.toUnhook.add(n.onMouseMoveOrRelevantKeyDown((([e,t])=>{this.startFindDefinitionFromMouse(e,withNullAsUndefined(t))}))),this.toUnhook.add(n.onExecute((e=>{this.isEnabled(e)&&this.gotoDefinition(e.target.position,e.hasSideBySideModifier).catch((e=>{onUnexpectedError(e)})).finally((()=>{this.removeLinkDecorations()}))}))),this.toUnhook.add(n.onCancel((()=>{this.removeLinkDecorations(),this.currentWordAtPosition=null})))}static get(t){return t.getContribution(e.ID)}startFindDefinitionFromCursor(e){return __awaiter(this,void 0,void 0,(function*(){yield this.startFindDefinition(e),this.toUnhookForKeyboard.add(this.editor.onDidChangeCursorPosition((()=>{this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear()}))),this.toUnhookForKeyboard.add(this.editor.onKeyDown((e=>{e&&(this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear())})))}))}startFindDefinitionFromMouse(e,t){if(9===e.target.type&&this.linkDecorations.length>0)return;if(!this.editor.hasModel()||!this.isEnabled(e,t))return this.currentWordAtPosition=null,void this.removeLinkDecorations();const o=e.target.position;this.startFindDefinition(o)}startFindDefinition(e){var t;return __awaiter(this,void 0,void 0,(function*(){this.toUnhookForKeyboard.clear();const o=e?null===(t=this.editor.getModel())||void 0===t?void 0:t.getWordAtPosition(e):null;if(!o)return this.currentWordAtPosition=null,void this.removeLinkDecorations();if(this.currentWordAtPosition&&this.currentWordAtPosition.startColumn===o.startColumn&&this.currentWordAtPosition.endColumn===o.endColumn&&this.currentWordAtPosition.word===o.word)return;this.currentWordAtPosition=o;const i=new EditorState(this.editor,15);let n;this.previousPromise&&(this.previousPromise.cancel(),this.previousPromise=null),this.previousPromise=createCancelablePromise((t=>this.findDefinition(e,t)));try{n=yield this.previousPromise}catch(e){return void onUnexpectedError(e)}if(!n||!n.length||!i.validate(this.editor))return void this.removeLinkDecorations();const r=n[0].originSelectionRange?Range.lift(n[0].originSelectionRange):new Range(e.lineNumber,o.startColumn,e.lineNumber,o.endColumn);if(n.length>1){let e=r;for(const{originSelectionRange:t}of n)t&&(e=Range.plusRange(e,t));this.addDecoration(e,(new MarkdownString).appendText(nls.localize("multipleResults","Click to show {0} definitions.",n.length)))}else{const e=n[0];if(!e.uri)return;this.textModelResolverService.createModelReference(e.uri).then((t=>{if(!t.object||!t.object.textEditorModel)return void t.dispose();const{object:{textEditorModel:o}}=t,{startLineNumber:i}=e.range;if(i<1||i>o.getLineCount())return void t.dispose();const n=this.getPreviewValue(o,i,e),s=this.languageService.guessLanguageIdByFilepathOrFirstLine(o.uri);this.addDecoration(r,n?(new MarkdownString).appendCodeblock(s||"",n):void 0),t.dispose()}))}}))}getPreviewValue(t,o,i){let n=i.range;return n.endLineNumber-n.startLineNumber>=e.MAX_SOURCE_PREVIEW_LINES&&(n=this.getPreviewRangeBasedOnIndentation(t,o)),this.stripIndentationFromPreviewRange(t,o,n)}stripIndentationFromPreviewRange(e,t,o){let i=e.getLineFirstNonWhitespaceColumn(t);for(let n=t+1;n<o.endLineNumber;n++){const t=e.getLineFirstNonWhitespaceColumn(n);i=Math.min(i,t)}return e.getValueInRange(o).replace(new RegExp(`^\\s{${i-1}}`,"gm"),"").trim()}getPreviewRangeBasedOnIndentation(t,o){const i=t.getLineFirstNonWhitespaceColumn(o),n=Math.min(t.getLineCount(),o+e.MAX_SOURCE_PREVIEW_LINES);let r=o+1;for(;r<n&&i!==t.getLineFirstNonWhitespaceColumn(r);r++);return new Range(o,1,r+1,1)}addDecoration(e,t){const o={range:e,options:{description:"goto-definition-link",inlineClassName:"goto-definition-link",hoverMessage:t}};this.linkDecorations.set([o])}removeLinkDecorations(){this.linkDecorations.clear()}isEnabled(e,t){var o;return this.editor.hasModel()&&e.isLeftClick&&e.isNoneOrSingleMouseDown&&6===e.target.type&&!((null===(o=e.target.detail.injectedText)||void 0===o?void 0:o.options)instanceof ModelDecorationInjectedTextOptions)&&(e.hasTriggerModifier||!!t&&t.keyCodeIsTriggerKey)&&this.languageFeaturesService.definitionProvider.has(this.editor.getModel())}findDefinition(e,t){const o=this.editor.getModel();return o?getDefinitionsAtPosition(this.languageFeaturesService.definitionProvider,o,e,t):Promise.resolve(null)}gotoDefinition(e,t){return this.editor.setPosition(e),this.editor.invokeWithinContext((e=>{const o=!t&&this.editor.getOption(83)&&!this.isInPeekEditor(e);return new DefinitionAction({openToSide:t,openInPeek:o,muteMessage:!0},{title:{value:"",original:""},id:"",precondition:void 0}).run(e)}))}isInPeekEditor(e){const t=e.get(IContextKeyService);return PeekContext.inPeekEditor.getValue(t)}dispose(){this.toUnhook.dispose(),this.toUnhookForKeyboard.dispose()}};GotoDefinitionAtPositionEditorContribution.ID="editor.contrib.gotodefinitionatposition",GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES=8,GotoDefinitionAtPositionEditorContribution=__decorate([__param(1,ITextModelService),__param(2,ILanguageService),__param(3,ILanguageFeaturesService)],GotoDefinitionAtPositionEditorContribution);export{GotoDefinitionAtPositionEditorContribution};registerEditorContribution(GotoDefinitionAtPositionEditorContribution.ID,GotoDefinitionAtPositionEditorContribution,2);