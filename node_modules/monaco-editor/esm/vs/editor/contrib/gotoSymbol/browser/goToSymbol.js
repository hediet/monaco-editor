var __awaiter=this&&this.__awaiter||function(e,n,o,t){return new(o||(o=Promise))((function(i,r){function a(e){try{c(t.next(e))}catch(e){r(e)}}function s(e){try{c(t.throw(e))}catch(e){r(e)}}function c(e){var n;e.done?i(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(a,s)}c((t=t.apply(e,n||[])).next())}))};import{coalesce}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{registerModelAndPositionCommand}from"../../../browser/editorExtensions.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{ReferencesModel}from"./referencesModel.js";function getLocationLinks(e,n,o,t){return __awaiter(this,void 0,void 0,(function*(){const i=o.ordered(e).map((o=>Promise.resolve(t(o,e,n)).then(void 0,(e=>{onUnexpectedExternalError(e)})))),r=yield Promise.all(i);return coalesce(r.flat())}))}export function getDefinitionsAtPosition(e,n,o,t){return getLocationLinks(n,o,e,((e,n,o)=>e.provideDefinition(n,o,t)))}export function getDeclarationsAtPosition(e,n,o,t){return getLocationLinks(n,o,e,((e,n,o)=>e.provideDeclaration(n,o,t)))}export function getImplementationsAtPosition(e,n,o,t){return getLocationLinks(n,o,e,((e,n,o)=>e.provideImplementation(n,o,t)))}export function getTypeDefinitionsAtPosition(e,n,o,t){return getLocationLinks(n,o,e,((e,n,o)=>e.provideTypeDefinition(n,o,t)))}export function getReferencesAtPosition(e,n,o,t,i){return getLocationLinks(n,o,e,((e,n,o)=>__awaiter(this,void 0,void 0,(function*(){const r=yield e.provideReferences(n,o,{includeDeclaration:!0},i);if(!t||!r||2!==r.length)return r;const a=yield e.provideReferences(n,o,{includeDeclaration:!1},i);return a&&1===a.length?a:r}))))}function _sortedAndDeduped(e){return __awaiter(this,void 0,void 0,(function*(){const n=yield e(),o=new ReferencesModel(n,""),t=o.references.map((e=>e.link));return o.dispose(),t}))}registerModelAndPositionCommand("_executeDefinitionProvider",((e,n,o)=>{const t=getDefinitionsAtPosition(e.get(ILanguageFeaturesService).definitionProvider,n,o,CancellationToken.None);return _sortedAndDeduped((()=>t))})),registerModelAndPositionCommand("_executeTypeDefinitionProvider",((e,n,o)=>{const t=getTypeDefinitionsAtPosition(e.get(ILanguageFeaturesService).typeDefinitionProvider,n,o,CancellationToken.None);return _sortedAndDeduped((()=>t))})),registerModelAndPositionCommand("_executeDeclarationProvider",((e,n,o)=>{const t=getDeclarationsAtPosition(e.get(ILanguageFeaturesService).declarationProvider,n,o,CancellationToken.None);return _sortedAndDeduped((()=>t))})),registerModelAndPositionCommand("_executeReferenceProvider",((e,n,o)=>{const t=getReferencesAtPosition(e.get(ILanguageFeaturesService).referenceProvider,n,o,!1,CancellationToken.None);return _sortedAndDeduped((()=>t))})),registerModelAndPositionCommand("_executeImplementationProvider",((e,n,o)=>{const t=getImplementationsAtPosition(e.get(ILanguageFeaturesService).implementationProvider,n,o,CancellationToken.None);return _sortedAndDeduped((()=>t))}));