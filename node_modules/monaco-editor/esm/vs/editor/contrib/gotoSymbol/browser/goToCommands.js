var _a,_b,_c,_d,_e,_f,_g,_h,__awaiter=this&&this.__awaiter||function(e,o,t,i){return new(t||(t=Promise))((function(n,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(s,a)}l((i=i.apply(e,o||[])).next())}))};import{isStandalone}from"../../../../base/browser/browser.js";import{alert}from"../../../../base/browser/ui/aria/aria.js";import{createCancelablePromise,raceCancellation}from"../../../../base/common/async.js";import{KeyChord}from"../../../../base/common/keyCodes.js";import{isWeb}from"../../../../base/common/platform.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource}from"../../editorState/browser/editorState.js";import{isCodeEditor}from"../../../browser/editorBrowser.js";import{EditorAction2}from"../../../browser/editorExtensions.js";import{ICodeEditorService}from"../../../browser/services/codeEditorService.js";import{EmbeddedCodeEditorWidget}from"../../../browser/widget/embeddedCodeEditorWidget.js";import*as corePosition from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{isLocationLink}from"../../../common/languages.js";import{ReferencesController}from"./peek/referencesController.js";import{ReferencesModel}from"./referencesModel.js";import{ISymbolNavigationService}from"./symbolNavigation.js";import{MessageController}from"../../message/browser/messageController.js";import{PeekContext}from"../../peekView/browser/peekView.js";import*as nls from"../../../../nls.js";import{MenuId,MenuRegistry,registerAction2}from"../../../../platform/actions/common/actions.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{ContextKeyExpr}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../../platform/progress/common/progress.js";import{getDeclarationsAtPosition,getDefinitionsAtPosition,getImplementationsAtPosition,getReferencesAtPosition,getTypeDefinitionsAtPosition}from"./goToSymbol.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{Iterable}from"../../../../base/common/iterator.js";MenuRegistry.appendMenuItem(MenuId.EditorContext,{submenu:MenuId.EditorContextPeek,title:nls.localize("peek.submenu","Peek"),group:"navigation",order:100});export class SymbolNavigationAnchor{static is(e){return!(!e||"object"!=typeof e)&&(e instanceof SymbolNavigationAnchor||!(!corePosition.Position.isIPosition(e.position)||!e.model))}constructor(e,o){this.model=e,this.position=o}}class SymbolNavigationAction extends EditorAction2{static all(){return SymbolNavigationAction._allSymbolNavigationCommands.values()}static _patchConfig(e){const o=Object.assign(Object.assign({},e),{f1:!0});if(o.menu)for(const t of Iterable.wrap(o.menu))t.id!==MenuId.EditorContext&&t.id!==MenuId.EditorContextPeek||(t.when=ContextKeyExpr.and(e.precondition,t.when));return o}constructor(e,o){super(SymbolNavigationAction._patchConfig(o)),this.configuration=e,SymbolNavigationAction._allSymbolNavigationCommands.set(o.id,this)}runEditorCommand(e,o,t,i){if(!o.hasModel())return Promise.resolve(void 0);const n=e.get(INotificationService),r=e.get(ICodeEditorService),s=e.get(IEditorProgressService),a=e.get(ISymbolNavigationService),l=e.get(ILanguageFeaturesService),d=e.get(IInstantiationService),c=o.getModel(),m=o.getPosition(),g=SymbolNavigationAnchor.is(t)?t:new SymbolNavigationAnchor(c,m),p=new EditorStateCancellationTokenSource(o,5),u=raceCancellation(this._getLocationModel(l,g.model,g.position,p.token),p.token).then((e=>__awaiter(this,void 0,void 0,(function*(){var n;if(!e||p.token.isCancellationRequested)return;let s;if(alert(e.ariaMessage),e.referenceAt(c.uri,m)){const e=this._getAlternativeCommand(o);!SymbolNavigationAction._activeAlternativeCommands.has(e)&&SymbolNavigationAction._allSymbolNavigationCommands.has(e)&&(s=SymbolNavigationAction._allSymbolNavigationCommands.get(e))}const l=e.references.length;if(0===l){if(!this.configuration.muteMessage){const e=c.getWordAtPosition(m);null===(n=MessageController.get(o))||void 0===n||n.showMessage(this._getNoResultFoundMessage(e),m)}}else{if(1!==l||!s)return this._onResult(r,a,o,e,i);SymbolNavigationAction._activeAlternativeCommands.add(this.desc.id),d.invokeFunction((e=>s.runEditorCommand(e,o,t,i).finally((()=>{SymbolNavigationAction._activeAlternativeCommands.delete(this.desc.id)}))))}}))),(e=>{n.error(e)})).finally((()=>{p.dispose()}));return s.showWhile(u,250),u}_onResult(e,o,t,i,n){return __awaiter(this,void 0,void 0,(function*(){const r=this._getGoToPreference(t);if(t instanceof EmbeddedCodeEditorWidget||!(this.configuration.openInPeek||"peek"===r&&i.references.length>1)){const s=i.firstReference(),a=i.references.length>1&&"gotoAndPeek"===r,l=yield this._openReference(t,e,s,this.configuration.openToSide,!a);a&&l?this._openInPeek(l,i,n):i.dispose(),"goto"===r&&o.put(s)}else this._openInPeek(t,i,n)}))}_openReference(e,o,t,i,n){return __awaiter(this,void 0,void 0,(function*(){let r;if(isLocationLink(t)&&(r=t.targetSelectionRange),r||(r=t.range),!r)return;const s=yield o.openCodeEditor({resource:t.uri,options:{selection:Range.collapseToStart(r),selectionRevealType:3,selectionSource:"code.jump"}},e,i);if(s){if(n){const e=s.getModel(),o=s.createDecorationsCollection([{range:r,options:{description:"symbol-navigate-action-highlight",className:"symbolHighlight"}}]);setTimeout((()=>{s.getModel()===e&&o.clear()}),350)}return s}}))}_openInPeek(e,o,t){const i=ReferencesController.get(e);i&&e.hasModel()?i.toggleWidget(null!=t?t:e.getSelection(),createCancelablePromise((e=>Promise.resolve(o))),this.configuration.openInPeek):o.dispose()}}SymbolNavigationAction._allSymbolNavigationCommands=new Map,SymbolNavigationAction._activeAlternativeCommands=new Set;export{SymbolNavigationAction};export class DefinitionAction extends SymbolNavigationAction{_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getDefinitionsAtPosition(e.definitionProvider,o,t,i),nls.localize("def.title","Definitions"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("noResultWord","No definition found for '{0}'",e.word):nls.localize("generic.noResults","No definition found")}_getAlternativeCommand(e){return e.getOption(55).alternativeDefinitionCommand}_getGoToPreference(e){return e.getOption(55).multipleDefinitions}}const goToDefinitionKb=isWeb&&!isStandalone()?2118:70;registerAction2(((_a=class e extends DefinitionAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.id,title:{value:nls.localize("actions.goToDecl.label","Go to Definition"),original:"Go to Definition",mnemonicTitle:nls.localize({key:"miGotoDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Definition")},precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:goToDefinitionKb,weight:100},menu:[{id:MenuId.EditorContext,group:"navigation",order:1.1},{id:MenuId.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:2}]}),CommandsRegistry.registerCommandAlias("editor.action.goToDeclaration",e.id)}}).id="editor.action.revealDefinition",_a)),registerAction2(((_b=class e extends DefinitionAction{constructor(){super({openToSide:!0,openInPeek:!1,muteMessage:!1},{id:e.id,title:{value:nls.localize("actions.goToDeclToSide.label","Open Definition to the Side"),original:"Open Definition to the Side"},precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:KeyChord(2089,goToDefinitionKb),weight:100}}),CommandsRegistry.registerCommandAlias("editor.action.openDeclarationToTheSide",e.id)}}).id="editor.action.revealDefinitionAside",_b)),registerAction2(((_c=class e extends DefinitionAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.id,title:{value:nls.localize("actions.previewDecl.label","Peek Definition"),original:"Peek Definition"},precondition:ContextKeyExpr.and(EditorContextKeys.hasDefinitionProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:582,linux:{primary:3140},weight:100},menu:{id:MenuId.EditorContextPeek,group:"peek",order:2}}),CommandsRegistry.registerCommandAlias("editor.action.previewDeclaration",e.id)}}).id="editor.action.peekDefinition",_c));class DeclarationAction extends SymbolNavigationAction{_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getDeclarationsAtPosition(e.declarationProvider,o,t,i),nls.localize("decl.title","Declarations"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("decl.noResultWord","No declaration found for '{0}'",e.word):nls.localize("decl.generic.noResults","No declaration found")}_getAlternativeCommand(e){return e.getOption(55).alternativeDeclarationCommand}_getGoToPreference(e){return e.getOption(55).multipleDeclarations}}registerAction2(((_d=class e extends DeclarationAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.id,title:{value:nls.localize("actions.goToDeclaration.label","Go to Declaration"),original:"Go to Declaration",mnemonicTitle:nls.localize({key:"miGotoDeclaration",comment:["&& denotes a mnemonic"]},"Go to &&Declaration")},precondition:ContextKeyExpr.and(EditorContextKeys.hasDeclarationProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),menu:[{id:MenuId.EditorContext,group:"navigation",order:1.3},{id:MenuId.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:3}]})}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("decl.noResultWord","No declaration found for '{0}'",e.word):nls.localize("decl.generic.noResults","No declaration found")}}).id="editor.action.revealDeclaration",_d)),registerAction2(class extends DeclarationAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.peekDeclaration",title:{value:nls.localize("actions.peekDecl.label","Peek Declaration"),original:"Peek Declaration"},precondition:ContextKeyExpr.and(EditorContextKeys.hasDeclarationProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),menu:{id:MenuId.EditorContextPeek,group:"peek",order:3}})}});class TypeDefinitionAction extends SymbolNavigationAction{_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getTypeDefinitionsAtPosition(e.typeDefinitionProvider,o,t,i),nls.localize("typedef.title","Type Definitions"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("goToTypeDefinition.noResultWord","No type definition found for '{0}'",e.word):nls.localize("goToTypeDefinition.generic.noResults","No type definition found")}_getAlternativeCommand(e){return e.getOption(55).alternativeTypeDefinitionCommand}_getGoToPreference(e){return e.getOption(55).multipleTypeDefinitions}}registerAction2(((_e=class e extends TypeDefinitionAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.ID,title:{value:nls.localize("actions.goToTypeDefinition.label","Go to Type Definition"),original:"Go to Type Definition",mnemonicTitle:nls.localize({key:"miGotoTypeDefinition",comment:["&& denotes a mnemonic"]},"Go to &&Type Definition")},precondition:ContextKeyExpr.and(EditorContextKeys.hasTypeDefinitionProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:0,weight:100},menu:[{id:MenuId.EditorContext,group:"navigation",order:1.4},{id:MenuId.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:3}]})}}).ID="editor.action.goToTypeDefinition",_e)),registerAction2(((_f=class e extends TypeDefinitionAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.ID,title:{value:nls.localize("actions.peekTypeDefinition.label","Peek Type Definition"),original:"Peek Type Definition"},precondition:ContextKeyExpr.and(EditorContextKeys.hasTypeDefinitionProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),menu:{id:MenuId.EditorContextPeek,group:"peek",order:4}})}}).ID="editor.action.peekTypeDefinition",_f));class ImplementationAction extends SymbolNavigationAction{_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getImplementationsAtPosition(e.implementationProvider,o,t,i),nls.localize("impl.title","Implementations"))}))}_getNoResultFoundMessage(e){return e&&e.word?nls.localize("goToImplementation.noResultWord","No implementation found for '{0}'",e.word):nls.localize("goToImplementation.generic.noResults","No implementation found")}_getAlternativeCommand(e){return e.getOption(55).alternativeImplementationCommand}_getGoToPreference(e){return e.getOption(55).multipleImplementations}}registerAction2(((_g=class e extends ImplementationAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:e.ID,title:{value:nls.localize("actions.goToImplementation.label","Go to Implementations"),original:"Go to Implementations",mnemonicTitle:nls.localize({key:"miGotoImplementation",comment:["&& denotes a mnemonic"]},"Go to &&Implementations")},precondition:ContextKeyExpr.and(EditorContextKeys.hasImplementationProvider,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:2118,weight:100},menu:[{id:MenuId.EditorContext,group:"navigation",order:1.45},{id:MenuId.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:4}]})}}).ID="editor.action.goToImplementation",_g)),registerAction2(((_h=class e extends ImplementationAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:e.ID,title:{value:nls.localize("actions.peekImplementation.label","Peek Implementations"),original:"Peek Implementations"},precondition:ContextKeyExpr.and(EditorContextKeys.hasImplementationProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:3142,weight:100},menu:{id:MenuId.EditorContextPeek,group:"peek",order:5}})}}).ID="editor.action.peekImplementation",_h));class ReferencesAction extends SymbolNavigationAction{_getNoResultFoundMessage(e){return e?nls.localize("references.no","No references found for '{0}'",e.word):nls.localize("references.noGeneric","No references found")}_getAlternativeCommand(e){return e.getOption(55).alternativeReferenceCommand}_getGoToPreference(e){return e.getOption(55).multipleReferences}}registerAction2(class extends ReferencesAction{constructor(){super({openToSide:!1,openInPeek:!1,muteMessage:!1},{id:"editor.action.goToReferences",title:{value:nls.localize("goToReferences.label","Go to References"),original:"Go to References",mnemonicTitle:nls.localize({key:"miGotoReference",comment:["&& denotes a mnemonic"]},"Go to &&References")},precondition:ContextKeyExpr.and(EditorContextKeys.hasReferenceProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),keybinding:{when:EditorContextKeys.editorTextFocus,primary:1094,weight:100},menu:[{id:MenuId.EditorContext,group:"navigation",order:1.45},{id:MenuId.MenubarGoMenu,precondition:null,group:"4_symbol_nav",order:5}]})}_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getReferencesAtPosition(e.referenceProvider,o,t,!0,i),nls.localize("ref.title","References"))}))}}),registerAction2(class extends ReferencesAction{constructor(){super({openToSide:!1,openInPeek:!0,muteMessage:!1},{id:"editor.action.referenceSearch.trigger",title:{value:nls.localize("references.action.label","Peek References"),original:"Peek References"},precondition:ContextKeyExpr.and(EditorContextKeys.hasReferenceProvider,PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated()),menu:{id:MenuId.EditorContextPeek,group:"peek",order:6}})}_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(yield getReferencesAtPosition(e.referenceProvider,o,t,!1,i),nls.localize("ref.title","References"))}))}});class GenericGoToLocationAction extends SymbolNavigationAction{constructor(e,o,t){super(e,{id:"editor.action.goToLocation",title:{value:nls.localize("label.generic","Go to Any Symbol"),original:"Go to Any Symbol"},precondition:ContextKeyExpr.and(PeekContext.notInPeekEditor,EditorContextKeys.isInWalkThroughSnippet.toNegated())}),this._references=o,this._gotoMultipleBehaviour=t}_getLocationModel(e,o,t,i){return __awaiter(this,void 0,void 0,(function*(){return new ReferencesModel(this._references,nls.localize("generic.title","Locations"))}))}_getNoResultFoundMessage(e){return e&&nls.localize("generic.noResult","No results for '{0}'",e.word)||""}_getGoToPreference(e){var o;return null!==(o=this._gotoMultipleBehaviour)&&void 0!==o?o:e.getOption(55).multipleReferences}_getAlternativeCommand(){return""}}CommandsRegistry.registerCommand({id:"editor.action.goToLocations",description:{description:"Go to locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:URI},{name:"position",description:"The position at which to start",constraint:corePosition.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto"},{name:"noResultsMessage",description:"Human readable message that shows when locations is empty."}]},handler:(e,o,t,i,n,r,s)=>__awaiter(void 0,void 0,void 0,(function*(){assertType(URI.isUri(o)),assertType(corePosition.Position.isIPosition(t)),assertType(Array.isArray(i)),assertType(void 0===n||"string"==typeof n),assertType(void 0===s||"boolean"==typeof s);const a=e.get(ICodeEditorService),l=yield a.openCodeEditor({resource:o},a.getFocusedCodeEditor());if(isCodeEditor(l))return l.setPosition(t),l.revealPositionInCenterIfOutsideViewport(t,0),l.invokeWithinContext((e=>{const o=new class extends GenericGoToLocationAction{_getNoResultFoundMessage(e){return r||super._getNoResultFoundMessage(e)}}({muteMessage:!Boolean(r),openInPeek:Boolean(s),openToSide:!1},i,n);e.get(IInstantiationService).invokeFunction(o.run.bind(o),l)}))}))}),CommandsRegistry.registerCommand({id:"editor.action.peekLocations",description:{description:"Peek locations from a position in a file",args:[{name:"uri",description:"The text document in which to start",constraint:URI},{name:"position",description:"The position at which to start",constraint:corePosition.Position.isIPosition},{name:"locations",description:"An array of locations.",constraint:Array},{name:"multiple",description:"Define what to do when having multiple results, either `peek`, `gotoAndPeek`, or `goto"}]},handler:(e,o,t,i,n)=>__awaiter(void 0,void 0,void 0,(function*(){e.get(ICommandService).executeCommand("editor.action.goToLocations",o,t,i,n,void 0,!0)}))}),CommandsRegistry.registerCommand({id:"editor.action.findReferences",handler:(e,o,t)=>{assertType(URI.isUri(o)),assertType(corePosition.Position.isIPosition(t));const i=e.get(ILanguageFeaturesService),n=e.get(ICodeEditorService);return n.openCodeEditor({resource:o},n.getFocusedCodeEditor()).then((e=>{if(!isCodeEditor(e)||!e.hasModel())return;const o=ReferencesController.get(e);if(!o)return;const n=createCancelablePromise((o=>getReferencesAtPosition(i.referenceProvider,e.getModel(),corePosition.Position.lift(t),!1,o).then((e=>new ReferencesModel(e,nls.localize("ref.title","References")))))),r=new Range(t.lineNumber,t.column,t.lineNumber,t.column);return Promise.resolve(o.toggleWidget(r,n,!1))}))}}),CommandsRegistry.registerCommandAlias("editor.action.showReferences","editor.action.peekLocations");