var __decorate=this&&this.__decorate||function(e,o,t,i){var r,n=arguments.length,s=n<3?o:null===i?i=Object.getOwnPropertyDescriptor(o,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,o,t,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n<3?r(s):n>3?r(o,t,s):r(o,t))||s);return n>3&&s&&Object.defineProperty(o,t,s),s},__param=this&&this.__param||function(e,o){return function(t,i){o(t,i,e)}},__awaiter=this&&this.__awaiter||function(e,o,t,i){return new(t||(t=Promise))((function(r,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(s,a)}c((i=i.apply(e,o||[])).next())}))};import{DeferredPromise}from"../../../../base/common/async.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{Codicon}from"../../../../base/common/codicons.js";import{ThemeIcon}from"../../../../base/common/themables.js";import{pieceToQuery,prepareQuery,scoreFuzzy2}from"../../../../base/common/fuzzyScorer.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import{format,trim}from"../../../../base/common/strings.js";import{Range}from"../../../common/core/range.js";import{SymbolKinds}from"../../../common/languages.js";import{IOutlineModelService}from"../../documentSymbols/browser/outlineModel.js";import{AbstractEditorNavigationQuickAccessProvider}from"./editorNavigationQuickAccess.js";import{localize}from"../../../../nls.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{findLast}from"../../../../base/common/arrays.js";let AbstractGotoSymbolQuickAccessProvider=class e extends AbstractEditorNavigationQuickAccessProvider{constructor(e,o,t=Object.create(null)){super(t),this._languageFeaturesService=e,this._outlineModelService=o,this.options=t,this.options.canAcceptInBackground=!0}provideWithoutTextEditor(e){return this.provideLabelPick(e,localize("cannotRunGotoSymbolWithoutEditor","To go to a symbol, first open a text editor with symbol information.")),Disposable.None}provideWithTextEditor(e,o,t){const i=e.editor,r=this.getModel(i);return r?this._languageFeaturesService.documentSymbolProvider.has(r)?this.doProvideWithEditorSymbols(e,r,o,t):this.doProvideWithoutEditorSymbols(e,r,o,t):Disposable.None}doProvideWithoutEditorSymbols(e,o,t,i){const r=new DisposableStore;return this.provideLabelPick(t,localize("cannotRunGotoSymbolWithoutSymbolProvider","The active text editor does not provide symbol information.")),(()=>{__awaiter(this,void 0,void 0,(function*(){(yield this.waitForLanguageSymbolRegistry(o,r))&&!i.isCancellationRequested&&r.add(this.doProvideWithEditorSymbols(e,o,t,i))}))})(),r}provideLabelPick(e,o){e.items=[{label:o,index:0,kind:14}],e.ariaLabel=o}waitForLanguageSymbolRegistry(e,o){return __awaiter(this,void 0,void 0,(function*(){if(this._languageFeaturesService.documentSymbolProvider.has(e))return!0;const t=new DeferredPromise,i=o.add(this._languageFeaturesService.documentSymbolProvider.onDidChange((()=>{this._languageFeaturesService.documentSymbolProvider.has(e)&&(i.dispose(),t.complete(!0))})));return o.add(toDisposable((()=>t.complete(!1)))),t.p}))}doProvideWithEditorSymbols(o,t,i,r){var n;const s=o.editor,a=new DisposableStore;a.add(i.onDidAccept((e=>{const[t]=i.selectedItems;t&&t.range&&(this.gotoLocation(o,{range:t.range.selection,keyMods:i.keyMods,preserveFocus:e.inBackground}),e.inBackground||i.hide())}))),a.add(i.onDidTriggerItemButton((({item:e})=>{e&&e.range&&(this.gotoLocation(o,{range:e.range.selection,keyMods:i.keyMods,forceSideBySide:!0}),i.hide())})));const c=this.getDocumentSymbols(t,r);let l;const d=o=>__awaiter(this,void 0,void 0,(function*(){null==l||l.dispose(!0),i.busy=!1,l=new CancellationTokenSource(r),i.busy=!0;try{const t=prepareQuery(i.value.substr(e.PREFIX.length).trim()),n=yield this.doGetSymbolPicks(c,t,void 0,l.token);if(r.isCancellationRequested)return;if(n.length>0){if(i.items=n,o&&0===t.original.length){const e=findLast(n,(e=>Boolean("separator"!==e.type&&e.range&&Range.containsPosition(e.range.decoration,o))));e&&(i.activeItems=[e])}}else t.original.length>0?this.provideLabelPick(i,localize("noMatchingSymbolResults","No matching editor symbols")):this.provideLabelPick(i,localize("noSymbolResults","No editor symbols"))}finally{r.isCancellationRequested||(i.busy=!1)}}));return a.add(i.onDidChangeValue((()=>d(void 0)))),d(null===(n=s.getSelection())||void 0===n?void 0:n.getPosition()),a.add(i.onDidChangeActive((()=>{const[e]=i.activeItems;e&&e.range&&(s.revealRangeInCenter(e.range.selection,0),this.addDecorations(s,e.range.decoration))}))),a}doGetSymbolPicks(o,t,i,r){var n,s;return __awaiter(this,void 0,void 0,(function*(){const a=yield o;if(r.isCancellationRequested)return[];const c=0===t.original.indexOf(e.SCOPE_PREFIX),l=c?1:0;let d,u,m;t.values&&t.values.length>1?(d=pieceToQuery(t.values[0]),u=pieceToQuery(t.values.slice(1))):d=t;const b=null===(s=null===(n=this.options)||void 0===n?void 0:n.openSideBySideDirection)||void 0===s?void 0:s.call(n);b&&(m=[{iconClass:"right"===b?ThemeIcon.asClassName(Codicon.splitHorizontal):ThemeIcon.asClassName(Codicon.splitVertical),tooltip:"right"===b?localize("openToSide","Open to the Side"):localize("openToBottom","Open to the Bottom")}]);const p=[];for(let h=0;h<a.length;h++){const f=a[h],v=trim(f.name),S=`$(${SymbolKinds.toIcon(f.kind).id}) ${v}`,_=S.length-v.length;let P,z,L,k,A=f.containerName;if((null==i?void 0:i.extraContainerLabel)&&(A=A?`${i.extraContainerLabel} â€¢ ${A}`:i.extraContainerLabel),t.original.length>l){let D=!1;if(d!==t&&([P,z]=scoreFuzzy2(S,Object.assign(Object.assign({},t),{values:void 0}),l,_),"number"==typeof P&&(D=!0)),"number"!=typeof P&&([P,z]=scoreFuzzy2(S,d,l,_),"number"!=typeof P))continue;if(!D&&u){if(A&&u.original.length>0&&([L,k]=scoreFuzzy2(A,u)),"number"!=typeof L)continue;"number"==typeof P&&(P+=L)}}const C=f.tags&&f.tags.indexOf(1)>=0;p.push({index:h,kind:f.kind,score:P,label:S,ariaLabel:v,description:A,highlights:C?void 0:{label:z,description:k},range:{selection:Range.collapseToStart(f.selectionRange),decoration:f.range},strikethrough:C,buttons:m})}const y=p.sort(((e,o)=>c?this.compareByKindAndScore(e,o):this.compareByScore(e,o)));let g=[];if(c){let I,B,R=0;function F(){B&&"number"==typeof I&&R>0&&(B.label=format(NLS_SYMBOL_KIND_CACHE[I]||FALLBACK_NLS_SYMBOL_KIND,R))}for(const N of y)I!==N.kind?(F(),I=N.kind,R=1,B={type:"separator"},g.push(B)):R++,g.push(N);F()}else y.length>0&&(g=[{label:localize("symbols","symbols ({0})",p.length),type:"separator"},...y]);return g}))}compareByScore(e,o){if("number"!=typeof e.score&&"number"==typeof o.score)return 1;if("number"==typeof e.score&&"number"!=typeof o.score)return-1;if("number"==typeof e.score&&"number"==typeof o.score){if(e.score>o.score)return-1;if(e.score<o.score)return 1}return e.index<o.index?-1:e.index>o.index?1:0}compareByKindAndScore(e,o){const t=NLS_SYMBOL_KIND_CACHE[e.kind]||FALLBACK_NLS_SYMBOL_KIND,i=NLS_SYMBOL_KIND_CACHE[o.kind]||FALLBACK_NLS_SYMBOL_KIND,r=t.localeCompare(i);return 0===r?this.compareByScore(e,o):r}getDocumentSymbols(e,o){return __awaiter(this,void 0,void 0,(function*(){const t=yield this._outlineModelService.getOrCreate(e,o);return o.isCancellationRequested?[]:t.asListOfDocumentSymbols()}))}};AbstractGotoSymbolQuickAccessProvider.PREFIX="@",AbstractGotoSymbolQuickAccessProvider.SCOPE_PREFIX=":",AbstractGotoSymbolQuickAccessProvider.PREFIX_BY_CATEGORY=`${AbstractGotoSymbolQuickAccessProvider.PREFIX}${AbstractGotoSymbolQuickAccessProvider.SCOPE_PREFIX}`,AbstractGotoSymbolQuickAccessProvider=__decorate([__param(0,ILanguageFeaturesService),__param(1,IOutlineModelService)],AbstractGotoSymbolQuickAccessProvider);export{AbstractGotoSymbolQuickAccessProvider};const FALLBACK_NLS_SYMBOL_KIND=localize("property","properties ({0})"),NLS_SYMBOL_KIND_CACHE={5:localize("method","methods ({0})"),11:localize("function","functions ({0})"),8:localize("_constructor","constructors ({0})"),12:localize("variable","variables ({0})"),4:localize("class","classes ({0})"),22:localize("struct","structs ({0})"),23:localize("event","events ({0})"),24:localize("operator","operators ({0})"),10:localize("interface","interfaces ({0})"),2:localize("namespace","namespaces ({0})"),3:localize("package","packages ({0})"),25:localize("typeParameter","type parameters ({0})"),1:localize("modules","modules ({0})"),6:localize("property","properties ({0})"),9:localize("enum","enumerations ({0})"),21:localize("enumMember","enumeration members ({0})"),14:localize("string","strings ({0})"),0:localize("file","files ({0})"),17:localize("array","arrays ({0})"),15:localize("number","numbers ({0})"),16:localize("boolean","booleans ({0})"),18:localize("object","objects ({0})"),19:localize("key","keys ({0})"),7:localize("field","fields ({0})"),13:localize("constant","constants ({0})")};