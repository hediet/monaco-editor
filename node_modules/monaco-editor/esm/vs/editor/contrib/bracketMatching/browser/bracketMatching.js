import{RunOnceScheduler}from"../../../../base/common/async.js";import{Disposable}from"../../../../base/common/lifecycle.js";import"./bracketMatching.css";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{OverviewRulerLane}from"../../../common/model.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import*as nls from"../../../../nls.js";import{MenuId,MenuRegistry}from"../../../../platform/actions/common/actions.js";import{registerColor}from"../../../../platform/theme/common/colorRegistry.js";import{themeColorFromId}from"../../../../platform/theme/common/themeService.js";const overviewRulerBracketMatchForeground=registerColor("editorOverviewRuler.bracketMatchForeground",{dark:"#A0A0A0",light:"#A0A0A0",hcDark:"#A0A0A0",hcLight:"#A0A0A0"},nls.localize("overviewRulerBracketMatchForeground","Overview ruler marker color for matching brackets."));class JumpToBracketAction extends EditorAction{constructor(){super({id:"editor.action.jumpToBracket",label:nls.localize("smartSelect.jumpBracket","Go to Bracket"),alias:"Go to Bracket",precondition:void 0,kbOpts:{kbExpr:EditorContextKeys.editorTextFocus,primary:3160,weight:100}})}run(t,e){var o;null===(o=BracketMatchingController.get(e))||void 0===o||o.jumpToBracket()}}class SelectToBracketAction extends EditorAction{constructor(){super({id:"editor.action.selectToBracket",label:nls.localize("smartSelect.selectToBracket","Select to Bracket"),alias:"Select to Bracket",precondition:void 0,description:{description:"Select to Bracket",args:[{name:"args",schema:{type:"object",properties:{selectBrackets:{type:"boolean",default:!0}}}}]}})}run(t,e,o){var r;let i=!0;o&&!1===o.selectBrackets&&(i=!1),null===(r=BracketMatchingController.get(e))||void 0===r||r.selectToBracket(i)}}class BracketsData{constructor(t,e,o){this.position=t,this.brackets=e,this.options=o}}class BracketMatchingController extends Disposable{static get(t){return t.getContribution(BracketMatchingController.ID)}constructor(t){super(),this._editor=t,this._lastBracketsData=[],this._lastVersionId=0,this._decorations=this._editor.createDecorationsCollection(),this._updateBracketsSoon=this._register(new RunOnceScheduler((()=>this._updateBrackets()),50)),this._matchBrackets=this._editor.getOption(68),this._updateBracketsSoon.schedule(),this._register(t.onDidChangeCursorPosition((t=>{"never"!==this._matchBrackets&&this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModelContent((t=>{this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModel((t=>{this._lastBracketsData=[],this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeModelLanguageConfiguration((t=>{this._lastBracketsData=[],this._updateBracketsSoon.schedule()}))),this._register(t.onDidChangeConfiguration((t=>{t.hasChanged(68)&&(this._matchBrackets=this._editor.getOption(68),this._decorations.clear(),this._lastBracketsData=[],this._lastVersionId=0,this._updateBracketsSoon.schedule())}))),this._register(t.onDidBlurEditorWidget((()=>{this._updateBracketsSoon.schedule()}))),this._register(t.onDidFocusEditorWidget((()=>{this._updateBracketsSoon.schedule()})))}jumpToBracket(){if(!this._editor.hasModel())return;const t=this._editor.getModel(),e=this._editor.getSelections().map((e=>{const o=e.getStartPosition(),r=t.bracketPairs.matchBracket(o);let i=null;if(r)r[0].containsPosition(o)&&!r[1].containsPosition(o)?i=r[1].getStartPosition():r[1].containsPosition(o)&&(i=r[0].getStartPosition());else{const e=t.bracketPairs.findEnclosingBrackets(o);if(e)i=e[1].getStartPosition();else{const e=t.bracketPairs.findNextBracket(o);e&&e.range&&(i=e.range.getStartPosition())}}return i?new Selection(i.lineNumber,i.column,i.lineNumber,i.column):new Selection(o.lineNumber,o.column,o.lineNumber,o.column)}));this._editor.setSelections(e),this._editor.revealRange(e[0])}selectToBracket(t){if(!this._editor.hasModel())return;const e=this._editor.getModel(),o=[];this._editor.getSelections().forEach((r=>{const i=r.getStartPosition();let s=e.bracketPairs.matchBracket(i);if(!s&&(s=e.bracketPairs.findEnclosingBrackets(i),!s)){const t=e.bracketPairs.findNextBracket(i);t&&t.range&&(s=e.bracketPairs.matchBracket(t.range.getStartPosition()))}let n=null,a=null;if(s){s.sort(Range.compareRangesUsingStarts);const[e,o]=s;if(n=t?e.getStartPosition():e.getEndPosition(),a=t?o.getEndPosition():o.getStartPosition(),o.containsPosition(i)){const t=n;n=a,a=t}}n&&a&&o.push(new Selection(n.lineNumber,n.column,a.lineNumber,a.column))})),o.length>0&&(this._editor.setSelections(o),this._editor.revealRange(o[0]))}_updateBrackets(){if("never"===this._matchBrackets)return;this._recomputeBrackets();const t=[];let e=0;for(const o of this._lastBracketsData){const r=o.brackets;r&&(t[e++]={range:r[0],options:o.options},t[e++]={range:r[1],options:o.options})}this._decorations.set(t)}_recomputeBrackets(){if(!this._editor.hasModel()||!this._editor.hasWidgetFocus())return this._lastBracketsData=[],void(this._lastVersionId=0);const t=this._editor.getSelections();if(t.length>100)return this._lastBracketsData=[],void(this._lastVersionId=0);const e=this._editor.getModel(),o=e.getVersionId();let r=[];this._lastVersionId===o&&(r=this._lastBracketsData);const i=[];let s=0;for(let e=0,o=t.length;e<o;e++){const o=t[e];o.isEmpty()&&(i[s++]=o.getStartPosition())}i.length>1&&i.sort(Position.compare);const n=[];let a=0,c=0;const l=r.length;for(let t=0,o=i.length;t<o;t++){const o=i[t];for(;c<l&&r[c].position.isBefore(o);)c++;if(c<l&&r[c].position.equals(o))n[a++]=r[c];else{let t=e.bracketPairs.matchBracket(o,20),r=BracketMatchingController._DECORATION_OPTIONS_WITH_OVERVIEW_RULER;t||"always"!==this._matchBrackets||(t=e.bracketPairs.findEnclosingBrackets(o,20),r=BracketMatchingController._DECORATION_OPTIONS_WITHOUT_OVERVIEW_RULER),n[a++]=new BracketsData(o,t,r)}}this._lastBracketsData=n,this._lastVersionId=o}}BracketMatchingController.ID="editor.contrib.bracketMatchingController",BracketMatchingController._DECORATION_OPTIONS_WITH_OVERVIEW_RULER=ModelDecorationOptions.register({description:"bracket-match-overview",stickiness:1,className:"bracket-match",overviewRuler:{color:themeColorFromId(overviewRulerBracketMatchForeground),position:OverviewRulerLane.Center}}),BracketMatchingController._DECORATION_OPTIONS_WITHOUT_OVERVIEW_RULER=ModelDecorationOptions.register({description:"bracket-match-no-overview",stickiness:1,className:"bracket-match"});export{BracketMatchingController};registerEditorContribution(BracketMatchingController.ID,BracketMatchingController,1),registerEditorAction(SelectToBracketAction),registerEditorAction(JumpToBracketAction),MenuRegistry.appendMenuItem(MenuId.MenubarGoMenu,{group:"5_infile_nav",command:{id:"editor.action.jumpToBracket",title:nls.localize({key:"miGoToBracket",comment:["&& denotes a mnemonic"]},"Go to &&Bracket")},order:2});