var _a,__decorate=this&&this.__decorate||function(e,o,n,t){var r,i=arguments.length,s=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,n):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,o,n,t);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(i<3?r(s):i>3?r(o,n,s):r(o,n))||s);return i>3&&s&&Object.defineProperty(o,n,s),s},__param=this&&this.__param||function(e,o){return function(n,t){o(n,t,e)}},__awaiter=this&&this.__awaiter||function(e,o,n,t){return new(n||(n=Promise))((function(r,i){function s(e){try{d(t.next(e))}catch(e){i(e)}}function a(e){try{d(t.throw(e))}catch(e){i(e)}}function d(e){var o;e.done?r(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(s,a)}d((t=t.apply(e,o||[])).next())}))};import{renderMarkdown}from"../../../../base/browser/markdownRenderer.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Emitter}from"../../../../base/common/event.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{applyFontInfo}from"../../../browser/config/domFontInfo.js";import{ILanguageService}from"../../../common/languages/language.js";import{PLAINTEXT_LANGUAGE_ID}from"../../../common/languages/modesRegistry.js";import{tokenizeToString}from"../../../common/languages/textToHtmlTokenizer.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";let MarkdownRenderer=class e{constructor(e,o,n){this._options=e,this._languageService=o,this._openerService=n,this._onDidRenderAsync=new Emitter,this.onDidRenderAsync=this._onDidRenderAsync.event}dispose(){this._onDidRenderAsync.dispose()}render(e,o,n){if(!e)return{element:document.createElement("span"),dispose:()=>{}};const t=new DisposableStore;return{element:t.add(renderMarkdown(e,Object.assign(Object.assign({},this._getRenderOptions(e,t)),o),n)).element,dispose:()=>t.dispose()}}_getRenderOptions(o,n){return{codeBlockRenderer:(o,n)=>__awaiter(this,void 0,void 0,(function*(){var t,r,i;let s;o?s=this._languageService.getLanguageIdByLanguageName(o):this._options.editor&&(s=null===(t=this._options.editor.getModel())||void 0===t?void 0:t.getLanguageId()),s||(s=PLAINTEXT_LANGUAGE_ID);const a=yield tokenizeToString(this._languageService,n,s),d=document.createElement("span");if(d.innerHTML=null!==(i=null===(r=e._ttpTokenizer)||void 0===r?void 0:r.createHTML(a))&&void 0!==i?i:a,this._options.editor){const e=this._options.editor.getOption(47);applyFontInfo(d,e)}else this._options.codeBlockFontFamily&&(d.style.fontFamily=this._options.codeBlockFontFamily);return void 0!==this._options.codeBlockFontSize&&(d.style.fontSize=this._options.codeBlockFontSize),d})),asyncRenderCallback:()=>this._onDidRenderAsync.fire(),actionHandler:{callback:e=>openLinkFromMarkdown(this._openerService,e,o.isTrusted),disposables:n}}}};MarkdownRenderer._ttpTokenizer=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("tokenizeToString",{createHTML:e=>e}),MarkdownRenderer=__decorate([__param(1,ILanguageService),__param(2,IOpenerService)],MarkdownRenderer);export{MarkdownRenderer};export function openLinkFromMarkdown(e,o,n){return __awaiter(this,void 0,void 0,(function*(){try{return yield e.open(o,{fromUserGesture:!0,allowContributedOpeners:!0,allowCommands:toAllowCommandsOption(n)})}catch(e){return onUnexpectedError(e),!1}}))}function toAllowCommandsOption(e){return!0===e||!(!e||!Array.isArray(e.enabledCommands))&&e.enabledCommands}