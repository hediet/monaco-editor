var _a;import{StringBuilder}from"../../common/core/stringBuilder.js";import*as strings from"../../../base/common/strings.js";import{applyFontInfo}from"../config/domFontInfo.js";import{LineInjectedText}from"../../common/textModelEvents.js";import{ModelLineProjectionData}from"../../common/modelLineProjectionData.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("domLineBreaksComputer",{createHTML:e=>e});export class DOMLineBreaksComputerFactory{static create(){return new DOMLineBreaksComputerFactory}constructor(){}createLineBreaksComputer(e,t,n,r,o){const a=[],i=[];return{addRequest:(e,t,n)=>{a.push(e),i.push(t)},finalize:()=>createLineBreaks(a,e,t,n,r,o,i)}}}function createLineBreaks(e,t,n,r,o,a,i){var l;function s(t){const n=i[t];if(n){const r=LineInjectedText.applyInjectedText(e[t],n),o=n.map((e=>e.options)),a=n.map((e=>e.column-1));return new ModelLineProjectionData(a,o,[r.length],[],0)}return null}if(-1===r){const t=[];for(let n=0,r=e.length;n<r;n++)t[n]=s(n);return t}const c=Math.round(r*t.typicalHalfwidthCharacterWidth),d=3===o?2:2===o?1:0,p=Math.round(n*d),u=Math.ceil(t.spaceWidth*p),h=document.createElement("div");applyFontInfo(h,t);const g=new StringBuilder(1e4),f=[],m=[],C=[],y=[],k=[];for(let r=0;r<e.length;r++){const a=LineInjectedText.applyInjectedText(e[r],i[r]);let l=0,s=0,d=c;if(0!==o)if(l=strings.firstNonWhitespaceIndex(a),-1===l)l=0;else{for(let e=0;e<l;e++)s+=9===a.charCodeAt(e)?n-s%n:1;const e=Math.ceil(t.spaceWidth*s);e+t.typicalFullwidthCharacterWidth>c?(l=0,s=0):d=c-e}const p=a.substr(l),h=renderLine(p,s,n,d,g,u);f[r]=l,m[r]=s,C[r]=p,y[r]=h[0],k[r]=h[1]}const S=g.build(),L=null!==(l=null==ttPolicy?void 0:ttPolicy.createHTML(S))&&void 0!==l?l:S;h.innerHTML=L,h.style.position="absolute",h.style.top="10000","keepAll"===a?(h.style.wordBreak="keep-all",h.style.overflowWrap="anywhere"):(h.style.wordBreak="inherit",h.style.overflowWrap="break-word"),document.body.appendChild(h);const v=document.createRange(),b=Array.prototype.slice.call(h.children,0),w=[];for(let t=0;t<e.length;t++){const e=readLineBreaks(v,b[t],C[t],y[t]);if(null===e){w[t]=s(t);continue}const n=f[t],r=m[t]+p,o=k[t],a=[];for(let t=0,n=e.length;t<n;t++)a[t]=o[e[t]];if(0!==n)for(let t=0,r=e.length;t<r;t++)e[t]+=n;let l,c;const d=i[t];d?(l=d.map((e=>e.options)),c=d.map((e=>e.column-1))):(l=null,c=null),w[t]=new ModelLineProjectionData(c,l,e,a,r)}return document.body.removeChild(h),w}function renderLine(e,t,n,r,o,a){if(0!==a){const e=String(a);o.appendString('<div style="text-indent: -'),o.appendString(e),o.appendString("px; padding-left: "),o.appendString(e),o.appendString("px; box-sizing: border-box; width:")}else o.appendString('<div style="width:');o.appendString(String(r)),o.appendString('px;">');const i=e.length;let l=t,s=0;const c=[],d=[];let p=0<i?e.charCodeAt(0):0;o.appendString("<span>");for(let t=0;t<i;t++){0!==t&&t%16384==0&&o.appendString("</span><span>"),c[t]=s,d[t]=l;const r=p;p=t+1<i?e.charCodeAt(t+1):0;let a=1,u=1;switch(r){case 9:a=n-l%n,u=a;for(let e=1;e<=a;e++)e<a?o.appendCharCode(160):o.appendASCIICharCode(32);break;case 32:32===p?o.appendCharCode(160):o.appendASCIICharCode(32);break;case 60:o.appendString("&lt;");break;case 62:o.appendString("&gt;");break;case 38:o.appendString("&amp;");break;case 0:o.appendString("&#00;");break;case 65279:case 8232:case 8233:case 133:o.appendCharCode(65533);break;default:strings.isFullWidthCharacter(r)&&u++,r<32?o.appendCharCode(9216+r):o.appendCharCode(r)}s+=a,l+=u}return o.appendString("</span>"),c[e.length]=s,d[e.length]=l,o.appendString("</div>"),[c,d]}function readLineBreaks(e,t,n,r){if(n.length<=1)return null;const o=Array.prototype.slice.call(t.children,0),a=[];try{discoverBreaks(e,o,r,0,null,n.length-1,null,a)}catch(e){return console.log(e),null}return 0===a.length?null:(a.push(n.length),a)}function discoverBreaks(e,t,n,r,o,a,i,l){if(r===a)return;if(o=o||readClientRect(e,t,n[r],n[r+1]),i=i||readClientRect(e,t,n[a],n[a+1]),Math.abs(o[0].top-i[0].top)<=.1)return;if(r+1===a)return void l.push(a);const s=r+(a-r)/2|0,c=readClientRect(e,t,n[s],n[s+1]);discoverBreaks(e,t,n,r,o,s,c,l),discoverBreaks(e,t,n,s,c,a,i,l)}function readClientRect(e,t,n,r){return e.setStart(t[n/16384|0].firstChild,n%16384),e.setEnd(t[r/16384|0].firstChild,r%16384),e.getClientRects()}