var _a,__decorate=this&&this.__decorate||function(e,i,t,o){var n,r=arguments.length,s=r<3?i:null===o?o=Object.getOwnPropertyDescriptor(i,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,i,t,o);else for(var d=e.length-1;d>=0;d--)(n=e[d])&&(s=(r<3?n(s):r>3?n(i,t,s):n(i,t))||s);return r>3&&s&&Object.defineProperty(i,t,s),s},__param=this&&this.__param||function(e,i){return function(t,o){i(t,o,e)}};import*as dom from"../../../base/browser/dom.js";import{createFastDomNode}from"../../../base/browser/fastDomNode.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}from"../../../base/browser/ui/mouseCursor/mouseCursor.js";import{Sash}from"../../../base/browser/ui/sash/sash.js";import*as assert from"../../../base/common/assert.js";import{RunOnceScheduler}from"../../../base/common/async.js";import{Codicon}from"../../../base/common/codicons.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Emitter}from"../../../base/common/event.js";import{Disposable}from"../../../base/common/lifecycle.js";import"./media/diffEditor.css";import{applyFontInfo}from"../config/domFontInfo.js";import{ElementSizeObserver}from"../config/elementSizeObserver.js";import{EditorExtensionsRegistry}from"../editorExtensions.js";import{ICodeEditorService}from"../services/codeEditorService.js";import{StableEditorScrollState}from"../stableEditorScroll.js";import{CodeEditorWidget}from"./codeEditorWidget.js";import{DiffReview}from"./diffReview.js";import{InlineDiffMargin}from"./inlineDiffMargin.js";import{WorkerBasedDocumentDiffProvider}from"./workerBasedDocumentDiffProvider.js";import{boolean as validateBooleanOption,clampedInt,EditorFontLigatures,EditorOptions,stringSet as validateStringSetOption}from"../../common/config/editorOptions.js";import{Position}from"../../common/core/position.js";import{Range}from"../../common/core/range.js";import{StringBuilder}from"../../common/core/stringBuilder.js";import*as editorCommon from"../../common/editorCommon.js";import{ModelDecorationOptions}from"../../common/model/textModel.js";import{LineDecoration}from"../../common/viewLayout/lineDecorations.js";import{RenderLineInput,renderViewLine}from"../../common/viewLayout/viewLineRenderer.js";import{InlineDecoration,ViewLineRenderingData}from"../../common/viewModel.js";import{OverviewRulerZone}from"../../common/viewModel/overviewZoneManager.js";import*as nls from"../../../nls.js";import{IClipboardService}from"../../../platform/clipboard/common/clipboardService.js";import{IContextKeyService}from"../../../platform/contextkey/common/contextkey.js";import{IContextMenuService}from"../../../platform/contextview/browser/contextView.js";import{IInstantiationService}from"../../../platform/instantiation/common/instantiation.js";import{ServiceCollection}from"../../../platform/instantiation/common/serviceCollection.js";import{INotificationService}from"../../../platform/notification/common/notification.js";import{IEditorProgressService}from"../../../platform/progress/common/progress.js";import{defaultInsertColor,defaultRemoveColor,diffDiagonalFill,diffInserted,diffOverviewRulerInserted,diffOverviewRulerRemoved,diffRemoved}from"../../../platform/theme/common/colorRegistry.js";import{registerIcon}from"../../../platform/theme/common/iconRegistry.js";import{getThemeTypeSelector,IThemeService,registerThemingParticipant}from"../../../platform/theme/common/themeService.js";import{ThemeIcon}from"../../../base/common/themables.js";class VisualEditorState{constructor(e,i){this._contextMenuService=e,this._clipboardService=i,this._zones=[],this._inlineDiffMargins=[],this._zonesMap={},this._decorations=[]}getForeignViewZones(e){return e.filter((e=>!this._zonesMap[String(e.id)]))}clean(e){this._zones.length>0&&e.changeViewZones((e=>{for(const i of this._zones)e.removeZone(i)})),this._zones=[],this._zonesMap={},e.changeDecorations((e=>{this._decorations=e.deltaDecorations(this._decorations,[])}))}apply(e,i,t,o){const n=o?StableEditorScrollState.capture(e):null;e.changeViewZones((i=>{var o;for(const e of this._zones)i.removeZone(e);for(const e of this._inlineDiffMargins)e.dispose();this._zones=[],this._zonesMap={},this._inlineDiffMargins=[];for(let n=0,r=t.zones.length;n<r;n++){const r=t.zones[n];r.suppressMouseDown=!0;const s=i.addZone(r);this._zones.push(s),this._zonesMap[String(s)]=!0,t.zones[n].diff&&r.marginDomNode&&(r.suppressMouseDown=!1,0!==(null===(o=t.zones[n].diff)||void 0===o?void 0:o.originalModel.getValueLength())&&this._inlineDiffMargins.push(new InlineDiffMargin(s,r.marginDomNode,e,t.zones[n].diff,this._contextMenuService,this._clipboardService)))}})),null==n||n.restore(e),e.changeDecorations((e=>{this._decorations=e.deltaDecorations(this._decorations,t.decorations)})),null==i||i.setZones(t.overviewZones)}}let DIFF_EDITOR_ID=0;const diffInsertIcon=registerIcon("diff-insert",Codicon.add,nls.localize("diffInsertIcon","Line decoration for inserts in the diff editor.")),diffRemoveIcon=registerIcon("diff-remove",Codicon.remove,nls.localize("diffRemoveIcon","Line decoration for removals in the diff editor.")),ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("diffEditorWidget",{createHTML:e=>e}),ariaNavigationTip=nls.localize("diff-aria-navigation-tip"," use Shift + F7 to navigate changes");let DiffEditorWidget=class e extends Disposable{constructor(i,t,o,n,r,s,d,a,l,m,h){super(),this._editorProgressService=h,this._onDidDispose=this._register(new Emitter),this.onDidDispose=this._onDidDispose.event,this._onDidChangeModel=this._register(new Emitter),this.onDidChangeModel=this._onDidChangeModel.event,this._onDidUpdateDiff=this._register(new Emitter),this.onDidUpdateDiff=this._onDidUpdateDiff.event,this._onDidContentSizeChange=this._register(new Emitter),this._lastOriginalWarning=null,this._lastModifiedWarning=null,this._documentDiffProvider=this._register(s.createInstance(WorkerBasedDocumentDiffProvider,t)),this._register(this._documentDiffProvider.onDidChange((e=>this._beginUpdateDecorationsSoon()))),this._codeEditorService=d,this._contextKeyService=this._register(r.createScoped(i)),this._instantiationService=s.createChild(new ServiceCollection([IContextKeyService,this._contextKeyService])),this._contextKeyService.createKey("isInDiffEditor",!0),this._themeService=a,this._notificationService=l,this._id=++DIFF_EDITOR_ID,this._state=0,this._updatingDiffProgress=null,this._domElement=i,t=t||{},this._options=validateDiffEditorOptions(t,{enableSplitViewResizing:!0,renderSideBySide:!0,renderMarginRevertIcon:!0,maxComputationTime:5e3,maxFileSize:50,ignoreTrimWhitespace:!0,renderIndicators:!0,originalEditable:!1,diffCodeLens:!1,renderOverviewRuler:!0,diffWordWrap:"inherit",diffAlgorithm:"smart"}),void 0!==t.isInEmbeddedEditor?this._contextKeyService.createKey("isInEmbeddedDiffEditor",t.isInEmbeddedEditor):this._contextKeyService.createKey("isInEmbeddedDiffEditor",!1),this._updateDecorationsRunner=this._register(new RunOnceScheduler((()=>this._updateDecorations()),0)),this._containerDomElement=document.createElement("div"),this._containerDomElement.className=e._getClassName(this._themeService.getColorTheme(),this._options.renderSideBySide),this._containerDomElement.style.position="relative",this._containerDomElement.style.height="100%",this._domElement.appendChild(this._containerDomElement),this._overviewViewportDomElement=createFastDomNode(document.createElement("div")),this._overviewViewportDomElement.setClassName("diffViewport"),this._overviewViewportDomElement.setPosition("absolute"),this._overviewDomElement=document.createElement("div"),this._overviewDomElement.className="diffOverview",this._overviewDomElement.style.position="absolute",this._overviewDomElement.appendChild(this._overviewViewportDomElement.domNode),this._register(dom.addStandardDisposableListener(this._overviewDomElement,dom.EventType.POINTER_DOWN,(e=>{this._modifiedEditor.delegateVerticalScrollbarPointerDown(e)}))),this._register(dom.addDisposableListener(this._overviewDomElement,dom.EventType.MOUSE_WHEEL,(e=>{this._modifiedEditor.delegateScrollFromMouseWheelEvent(e)}),{passive:!1})),this._options.renderOverviewRuler&&this._containerDomElement.appendChild(this._overviewDomElement),this._originalDomNode=document.createElement("div"),this._originalDomNode.className="editor original",this._originalDomNode.style.position="absolute",this._originalDomNode.style.height="100%",this._containerDomElement.appendChild(this._originalDomNode),this._modifiedDomNode=document.createElement("div"),this._modifiedDomNode.className="editor modified",this._modifiedDomNode.style.position="absolute",this._modifiedDomNode.style.height="100%",this._containerDomElement.appendChild(this._modifiedDomNode),this._beginUpdateDecorationsTimeout=-1,this._currentlyChangingViewZones=!1,this._diffComputationToken=0,this._originalEditorState=new VisualEditorState(m,n),this._modifiedEditorState=new VisualEditorState(m,n),this._isVisible=!0,this._isHandlingScrollEvent=!1,this._elementSizeObserver=this._register(new ElementSizeObserver(this._containerDomElement,t.dimension)),this._register(this._elementSizeObserver.onDidChange((()=>this._onDidContainerSizeChanged()))),t.automaticLayout&&this._elementSizeObserver.startObserving(),this._diffComputationResult=null,this._originalEditor=this._createLeftHandSideEditor(t,o.originalEditor||{}),this._modifiedEditor=this._createRightHandSideEditor(t,o.modifiedEditor||{}),this._originalOverviewRuler=null,this._modifiedOverviewRuler=null,this._reviewPane=s.createInstance(DiffReview,this),this._containerDomElement.appendChild(this._reviewPane.domNode.domNode),this._containerDomElement.appendChild(this._reviewPane.shadow.domNode),this._containerDomElement.appendChild(this._reviewPane.actionBarContainer.domNode),this._options.renderSideBySide?this._setStrategy(new DiffEditorWidgetSideBySide(this._createDataSource(),this._options.enableSplitViewResizing)):this._setStrategy(new DiffEditorWidgetInline(this._createDataSource(),this._options.enableSplitViewResizing)),this._register(a.onDidColorThemeChange((i=>{this._strategy&&this._strategy.applyColors(i)&&this._updateDecorationsRunner.schedule(),this._containerDomElement.className=e._getClassName(this._themeService.getColorTheme(),this._options.renderSideBySide)})));const g=EditorExtensionsRegistry.getDiffEditorContributions();for(const e of g)try{this._register(s.createInstance(e.ctor,this))}catch(e){onUnexpectedError(e)}this._codeEditorService.addDiffEditor(this)}_setState(e){this._state!==e&&(this._state=e,this._updatingDiffProgress&&(this._updatingDiffProgress.done(),this._updatingDiffProgress=null),1===this._state&&(this._updatingDiffProgress=this._editorProgressService.show(!0,1e3)))}diffReviewNext(){this._reviewPane.next()}diffReviewPrev(){this._reviewPane.prev()}static _getClassName(e,i){let t="monaco-diff-editor monaco-editor-background ";return i&&(t+="side-by-side "),t+=getThemeTypeSelector(e.type),t}_disposeOverviewRulers(){this._originalOverviewRuler&&(this._overviewDomElement.removeChild(this._originalOverviewRuler.getDomNode()),this._originalOverviewRuler.dispose(),this._originalOverviewRuler=null),this._modifiedOverviewRuler&&(this._overviewDomElement.removeChild(this._modifiedOverviewRuler.getDomNode()),this._modifiedOverviewRuler.dispose(),this._modifiedOverviewRuler=null)}_createOverviewRulers(){this._options.renderOverviewRuler&&(assert.ok(!this._originalOverviewRuler&&!this._modifiedOverviewRuler),this._originalEditor.hasModel()&&(this._originalOverviewRuler=this._originalEditor.createOverviewRuler("original diffOverviewRuler"),this._overviewDomElement.appendChild(this._originalOverviewRuler.getDomNode())),this._modifiedEditor.hasModel()&&(this._modifiedOverviewRuler=this._modifiedEditor.createOverviewRuler("modified diffOverviewRuler"),this._overviewDomElement.appendChild(this._modifiedOverviewRuler.getDomNode())),this._layoutOverviewRulers())}_createLeftHandSideEditor(i,t){const o=this._createInnerEditor(this._instantiationService,this._originalDomNode,this._adjustOptionsForLeftHandSide(i),t);this._register(o.onDidScrollChange((e=>{this._isHandlingScrollEvent||(e.scrollTopChanged||e.scrollLeftChanged||e.scrollHeightChanged)&&(this._isHandlingScrollEvent=!0,this._modifiedEditor.setScrollPosition({scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}),this._isHandlingScrollEvent=!1,this._layoutOverviewViewport())}))),this._register(o.onDidChangeViewZones((()=>{this._onViewZonesChanged()}))),this._register(o.onDidChangeConfiguration((e=>{o.getModel()&&(e.hasChanged(47)&&this._updateDecorationsRunner.schedule(),e.hasChanged(139)&&(this._updateDecorationsRunner.cancel(),this._updateDecorations()))}))),this._register(o.onDidChangeHiddenAreas((()=>{this._updateDecorationsRunner.cancel(),this._updateDecorations()}))),this._register(o.onDidChangeModelContent((()=>{this._isVisible&&this._beginUpdateDecorationsSoon()})));const n=this._contextKeyService.createKey("isInDiffLeftEditor",o.hasWidgetFocus());return this._register(o.onDidFocusEditorWidget((()=>n.set(!0)))),this._register(o.onDidBlurEditorWidget((()=>n.set(!1)))),this._register(o.onDidContentSizeChange((i=>{const t=this._originalEditor.getContentWidth()+this._modifiedEditor.getContentWidth()+e.ONE_OVERVIEW_WIDTH,o=Math.max(this._modifiedEditor.getContentHeight(),this._originalEditor.getContentHeight());this._onDidContentSizeChange.fire({contentHeight:o,contentWidth:t,contentHeightChanged:i.contentHeightChanged,contentWidthChanged:i.contentWidthChanged})}))),o}_createRightHandSideEditor(i,t){const o=this._createInnerEditor(this._instantiationService,this._modifiedDomNode,this._adjustOptionsForRightHandSide(i),t);this._register(o.onDidScrollChange((e=>{this._isHandlingScrollEvent||(e.scrollTopChanged||e.scrollLeftChanged||e.scrollHeightChanged)&&(this._isHandlingScrollEvent=!0,this._originalEditor.setScrollPosition({scrollLeft:e.scrollLeft,scrollTop:e.scrollTop}),this._isHandlingScrollEvent=!1,this._layoutOverviewViewport())}))),this._register(o.onDidChangeViewZones((()=>{this._onViewZonesChanged()}))),this._register(o.onDidChangeConfiguration((e=>{o.getModel()&&(e.hasChanged(47)&&this._updateDecorationsRunner.schedule(),e.hasChanged(139)&&(this._updateDecorationsRunner.cancel(),this._updateDecorations()))}))),this._register(o.onDidChangeHiddenAreas((()=>{this._updateDecorationsRunner.cancel(),this._updateDecorations()}))),this._register(o.onDidChangeModelContent((()=>{this._isVisible&&this._beginUpdateDecorationsSoon()}))),this._register(o.onDidChangeModelOptions((e=>{e.tabSize&&this._updateDecorationsRunner.schedule()})));const n=this._contextKeyService.createKey("isInDiffRightEditor",o.hasWidgetFocus());return this._register(o.onDidFocusEditorWidget((()=>n.set(!0)))),this._register(o.onDidBlurEditorWidget((()=>n.set(!1)))),this._register(o.onDidContentSizeChange((i=>{const t=this._originalEditor.getContentWidth()+this._modifiedEditor.getContentWidth()+e.ONE_OVERVIEW_WIDTH,o=Math.max(this._modifiedEditor.getContentHeight(),this._originalEditor.getContentHeight());this._onDidContentSizeChange.fire({contentHeight:o,contentWidth:t,contentHeightChanged:i.contentHeightChanged,contentWidthChanged:i.contentWidthChanged})}))),this._register(o.onMouseDown((e=>{var i,t;if(!e.event.rightButton&&e.target.position&&(null===(i=e.target.element)||void 0===i?void 0:i.className.includes("arrow-revert-change"))){const i=e.target.position.lineNumber,o=e.target,n=null===(t=this._diffComputationResult)||void 0===t?void 0:t.changes.find((e=>(null==o?void 0:o.detail.afterLineNumber)===e.modifiedStartLineNumber||e.modifiedEndLineNumber>0&&e.modifiedStartLineNumber===i));return n&&this.revertChange(n),e.event.stopPropagation(),void this._updateDecorations()}}))),o}revertChange(e){const i=this._modifiedEditor,t=this._originalEditor.getModel(),o=this._modifiedEditor.getModel();if(!t||!o||!i)return;const n=e.originalEndLineNumber>0?new Range(e.originalStartLineNumber,1,e.originalEndLineNumber,t.getLineMaxColumn(e.originalEndLineNumber)):null,r=n?t.getValueInRange(n):null,s=e.modifiedEndLineNumber>0?new Range(e.modifiedStartLineNumber,1,e.modifiedEndLineNumber,o.getLineMaxColumn(e.modifiedEndLineNumber)):null,d=o.getEOL();if(0===e.originalEndLineNumber&&s){let t=s;e.modifiedStartLineNumber>1?t=s.setStartPosition(e.modifiedStartLineNumber-1,o.getLineMaxColumn(e.modifiedStartLineNumber-1)):e.modifiedEndLineNumber<o.getLineCount()&&(t=s.setEndPosition(e.modifiedEndLineNumber+1,1)),i.executeEdits("diffEditor",[{range:t,text:""}])}else if(0===e.modifiedEndLineNumber&&null!==r){const t=e.modifiedStartLineNumber<o.getLineCount()?new Position(e.modifiedStartLineNumber+1,1):new Position(e.modifiedStartLineNumber,o.getLineMaxColumn(e.modifiedStartLineNumber));i.executeEdits("diffEditor",[{range:Range.fromPositions(t,t),text:e.modifiedStartLineNumber<o.getLineCount()?r+d:d+r}])}else s&&null!==r&&i.executeEdits("diffEditor",[{range:s,text:r}])}_createInnerEditor(e,i,t,o){return e.createInstance(CodeEditorWidget,i,t,o)}dispose(){this._codeEditorService.removeDiffEditor(this),-1!==this._beginUpdateDecorationsTimeout&&(window.clearTimeout(this._beginUpdateDecorationsTimeout),this._beginUpdateDecorationsTimeout=-1),this._cleanViewZonesAndDecorations(),this._originalOverviewRuler&&(this._overviewDomElement.removeChild(this._originalOverviewRuler.getDomNode()),this._originalOverviewRuler.dispose()),this._modifiedOverviewRuler&&(this._overviewDomElement.removeChild(this._modifiedOverviewRuler.getDomNode()),this._modifiedOverviewRuler.dispose()),this._overviewDomElement.removeChild(this._overviewViewportDomElement.domNode),this._options.renderOverviewRuler&&this._containerDomElement.removeChild(this._overviewDomElement),this._containerDomElement.removeChild(this._originalDomNode),this._originalEditor.dispose(),this._containerDomElement.removeChild(this._modifiedDomNode),this._modifiedEditor.dispose(),this._strategy.dispose(),this._containerDomElement.removeChild(this._reviewPane.domNode.domNode),this._containerDomElement.removeChild(this._reviewPane.shadow.domNode),this._containerDomElement.removeChild(this._reviewPane.actionBarContainer.domNode),this._reviewPane.dispose(),this._domElement.removeChild(this._containerDomElement),this._onDidDispose.fire(),super.dispose()}getId(){return this.getEditorType()+":"+this._id}getEditorType(){return editorCommon.EditorType.IDiffEditor}getLineChanges(){return this._diffComputationResult?this._diffComputationResult.changes:null}getOriginalEditor(){return this._originalEditor}getModifiedEditor(){return this._modifiedEditor}updateOptions(i){const t=validateDiffEditorOptions(i,this._options),o=changedDiffEditorOptions(this._options,t);this._options=t;const n=o.ignoreTrimWhitespace||o.renderIndicators||o.renderMarginRevertIcon,r=this._isVisible&&(o.maxComputationTime||o.maxFileSize);this._documentDiffProvider.setOptions(t),n?this._beginUpdateDecorations():r&&this._beginUpdateDecorationsSoon(),this._modifiedEditor.updateOptions(this._adjustOptionsForRightHandSide(i)),this._originalEditor.updateOptions(this._adjustOptionsForLeftHandSide(i)),this._strategy.setEnableSplitViewResizing(this._options.enableSplitViewResizing),o.renderSideBySide&&(this._options.renderSideBySide?this._setStrategy(new DiffEditorWidgetSideBySide(this._createDataSource(),this._options.enableSplitViewResizing)):this._setStrategy(new DiffEditorWidgetInline(this._createDataSource(),this._options.enableSplitViewResizing)),this._containerDomElement.className=e._getClassName(this._themeService.getColorTheme(),this._options.renderSideBySide)),o.renderOverviewRuler&&(this._options.renderOverviewRuler?this._containerDomElement.appendChild(this._overviewDomElement):this._containerDomElement.removeChild(this._overviewDomElement))}getModel(){return{original:this._originalEditor.getModel(),modified:this._modifiedEditor.getModel()}}setModel(e){if(e&&(!e.original||!e.modified))throw new Error(e.original?"DiffEditorWidget.setModel: Modified model is null":"DiffEditorWidget.setModel: Original model is null");this._cleanViewZonesAndDecorations(),this._disposeOverviewRulers(),this._originalEditor.setModel(e?e.original:null),this._modifiedEditor.setModel(e?e.modified:null),this._updateDecorationsRunner.cancel(),e&&(this._originalEditor.setScrollTop(0),this._modifiedEditor.setScrollTop(0)),this._diffComputationResult=null,this._diffComputationToken++,this._setState(0),e&&(this._createOverviewRulers(),this._beginUpdateDecorations()),this._layoutOverviewViewport(),this._onDidChangeModel.fire()}getContainerDomNode(){return this._domElement}getVisibleColumnFromPosition(e){return this._modifiedEditor.getVisibleColumnFromPosition(e)}getPosition(){return this._modifiedEditor.getPosition()}setPosition(e,i="api"){this._modifiedEditor.setPosition(e,i)}revealLine(e,i=0){this._modifiedEditor.revealLine(e,i)}revealLineInCenter(e,i=0){this._modifiedEditor.revealLineInCenter(e,i)}revealLineInCenterIfOutsideViewport(e,i=0){this._modifiedEditor.revealLineInCenterIfOutsideViewport(e,i)}revealLineNearTop(e,i=0){this._modifiedEditor.revealLineNearTop(e,i)}revealPosition(e,i=0){this._modifiedEditor.revealPosition(e,i)}revealPositionInCenter(e,i=0){this._modifiedEditor.revealPositionInCenter(e,i)}revealPositionInCenterIfOutsideViewport(e,i=0){this._modifiedEditor.revealPositionInCenterIfOutsideViewport(e,i)}revealPositionNearTop(e,i=0){this._modifiedEditor.revealPositionNearTop(e,i)}getSelection(){return this._modifiedEditor.getSelection()}getSelections(){return this._modifiedEditor.getSelections()}setSelection(e,i="api"){this._modifiedEditor.setSelection(e,i)}setSelections(e,i="api"){this._modifiedEditor.setSelections(e,i)}revealLines(e,i,t=0){this._modifiedEditor.revealLines(e,i,t)}revealLinesInCenter(e,i,t=0){this._modifiedEditor.revealLinesInCenter(e,i,t)}revealLinesInCenterIfOutsideViewport(e,i,t=0){this._modifiedEditor.revealLinesInCenterIfOutsideViewport(e,i,t)}revealLinesNearTop(e,i,t=0){this._modifiedEditor.revealLinesNearTop(e,i,t)}revealRange(e,i=0,t=!1,o=!0){this._modifiedEditor.revealRange(e,i,t,o)}revealRangeInCenter(e,i=0){this._modifiedEditor.revealRangeInCenter(e,i)}revealRangeInCenterIfOutsideViewport(e,i=0){this._modifiedEditor.revealRangeInCenterIfOutsideViewport(e,i)}revealRangeNearTop(e,i=0){this._modifiedEditor.revealRangeNearTop(e,i)}revealRangeNearTopIfOutsideViewport(e,i=0){this._modifiedEditor.revealRangeNearTopIfOutsideViewport(e,i)}revealRangeAtTop(e,i=0){this._modifiedEditor.revealRangeAtTop(e,i)}getSupportedActions(){return this._modifiedEditor.getSupportedActions()}saveViewState(){return{original:this._originalEditor.saveViewState(),modified:this._modifiedEditor.saveViewState()}}restoreViewState(e){if(e&&e.original&&e.modified){const i=e;this._originalEditor.restoreViewState(i.original),this._modifiedEditor.restoreViewState(i.modified)}}layout(e){this._elementSizeObserver.observe(e)}focus(){this._modifiedEditor.focus()}hasTextFocus(){return this._originalEditor.hasTextFocus()||this._modifiedEditor.hasTextFocus()}trigger(e,i,t){this._modifiedEditor.trigger(e,i,t)}createDecorationsCollection(e){return this._modifiedEditor.createDecorationsCollection(e)}changeDecorations(e){return this._modifiedEditor.changeDecorations(e)}_onDidContainerSizeChanged(){this._doLayout()}_getReviewHeight(){return this._reviewPane.isVisible()?this._elementSizeObserver.getHeight():0}_layoutOverviewRulers(){if(!this._options.renderOverviewRuler)return;if(!this._originalOverviewRuler||!this._modifiedOverviewRuler)return;const i=this._elementSizeObserver.getHeight(),t=this._getReviewHeight(),o=e.ENTIRE_DIFF_OVERVIEW_WIDTH-2*e.ONE_OVERVIEW_WIDTH;this._modifiedEditor.getLayoutInfo()&&(this._originalOverviewRuler.setLayout({top:0,width:e.ONE_OVERVIEW_WIDTH,right:o+e.ONE_OVERVIEW_WIDTH,height:i-t}),this._modifiedOverviewRuler.setLayout({top:0,right:0,width:e.ONE_OVERVIEW_WIDTH,height:i-t}))}_onViewZonesChanged(){this._currentlyChangingViewZones||this._updateDecorationsRunner.schedule()}_beginUpdateDecorationsSoon(){-1!==this._beginUpdateDecorationsTimeout&&(window.clearTimeout(this._beginUpdateDecorationsTimeout),this._beginUpdateDecorationsTimeout=-1),this._beginUpdateDecorationsTimeout=window.setTimeout((()=>this._beginUpdateDecorations()),e.UPDATE_DIFF_DECORATIONS_DELAY)}static _equals(e,i){return!e&&!i||!(!e||!i)&&e.toString()===i.toString()}_beginUpdateDecorations(){-1!==this._beginUpdateDecorationsTimeout&&(window.clearTimeout(this._beginUpdateDecorationsTimeout),this._beginUpdateDecorationsTimeout=-1);const i=this._originalEditor.getModel(),t=this._modifiedEditor.getModel();if(!i||!t)return;this._diffComputationToken++;const o=this._diffComputationToken,n=1024*this._options.maxFileSize*1024,r=e=>{const i=e.getValueLength();return 0===n||i<=n};r(i)&&r(t)?(this._setState(1),this._documentDiffProvider.computeDiff(i,t,{ignoreTrimWhitespace:this._options.ignoreTrimWhitespace,maxComputationTimeMs:this._options.maxComputationTime}).then((e=>{o===this._diffComputationToken&&i===this._originalEditor.getModel()&&t===this._modifiedEditor.getModel()&&(this._setState(2),this._diffComputationResult={identical:e.identical,quitEarly:e.quitEarly,changes:e.changes.map((e=>{let i,t,o,n,r=e.innerChanges;return e.originalRange.isEmpty?(i=e.originalRange.startLineNumber-1,t=0,r=void 0):(i=e.originalRange.startLineNumber,t=e.originalRange.endLineNumberExclusive-1),e.modifiedRange.isEmpty?(o=e.modifiedRange.startLineNumber-1,n=0,r=void 0):(o=e.modifiedRange.startLineNumber,n=e.modifiedRange.endLineNumberExclusive-1),{originalStartLineNumber:i,originalEndLineNumber:t,modifiedStartLineNumber:o,modifiedEndLineNumber:n,charChanges:null==r?void 0:r.map((e=>({originalStartLineNumber:e.originalRange.startLineNumber,originalStartColumn:e.originalRange.startColumn,originalEndLineNumber:e.originalRange.endLineNumber,originalEndColumn:e.originalRange.endColumn,modifiedStartLineNumber:e.modifiedRange.startLineNumber,modifiedStartColumn:e.modifiedRange.startColumn,modifiedEndLineNumber:e.modifiedRange.endLineNumber,modifiedEndColumn:e.modifiedRange.endColumn})))}}))},this._updateDecorationsRunner.schedule(),this._onDidUpdateDiff.fire())}),(e=>{o===this._diffComputationToken&&i===this._originalEditor.getModel()&&t===this._modifiedEditor.getModel()&&(this._setState(2),this._diffComputationResult=null,this._updateDecorationsRunner.schedule())}))):e._equals(i.uri,this._lastOriginalWarning)&&e._equals(t.uri,this._lastModifiedWarning)||(this._lastOriginalWarning=i.uri,this._lastModifiedWarning=t.uri,this._notificationService.warn(nls.localize("diff.tooLarge","Cannot compare files because one file is too large.")))}_cleanViewZonesAndDecorations(){this._originalEditorState.clean(this._originalEditor),this._modifiedEditorState.clean(this._modifiedEditor)}_updateDecorations(){if(!this._originalEditor.getModel()||!this._modifiedEditor.getModel())return;const e=this._diffComputationResult?this._diffComputationResult.changes:[],i=this._originalEditorState.getForeignViewZones(this._originalEditor.getWhitespaces()),t=this._modifiedEditorState.getForeignViewZones(this._modifiedEditor.getWhitespaces()),o=this._options.renderMarginRevertIcon&&!this._modifiedEditor.getOption(86),n=this._strategy.getEditorsDiffDecorations(e,this._options.ignoreTrimWhitespace,this._options.renderIndicators,o,i,t);try{this._currentlyChangingViewZones=!0,this._originalEditorState.apply(this._originalEditor,this._originalOverviewRuler,n.original,!1),this._modifiedEditorState.apply(this._modifiedEditor,this._modifiedOverviewRuler,n.modified,!0)}finally{this._currentlyChangingViewZones=!1}}_adjustOptionsForSubEditor(e){const i=Object.assign({},e);return i.inDiffEditor=!0,i.automaticLayout=!1,i.scrollbar=Object.assign({},i.scrollbar||{}),i.scrollbar.vertical="visible",i.folding=!1,i.codeLens=this._options.diffCodeLens,i.fixedOverflowWidgets=!0,i.minimap=Object.assign({},i.minimap||{}),i.minimap.enabled=!1,i}_adjustOptionsForLeftHandSide(e){const i=this._adjustOptionsForSubEditor(e);return this._options.renderSideBySide?i.wordWrapOverride1=this._options.diffWordWrap:(i.wordWrapOverride1="off",i.wordWrapOverride2="off"),e.originalAriaLabel&&(i.ariaLabel=e.originalAriaLabel),i.ariaLabel+=ariaNavigationTip,i.readOnly=!this._options.originalEditable,i.dropIntoEditor={enabled:!i.readOnly},i.extraEditorClassName="original-in-monaco-diff-editor",Object.assign(Object.assign({},i),{dimension:{height:0,width:0}})}_adjustOptionsForRightHandSide(i){const t=this._adjustOptionsForSubEditor(i);return i.modifiedAriaLabel&&(t.ariaLabel=i.modifiedAriaLabel),t.ariaLabel+=ariaNavigationTip,t.wordWrapOverride1=this._options.diffWordWrap,t.revealHorizontalRightPadding=EditorOptions.revealHorizontalRightPadding.defaultValue+e.ENTIRE_DIFF_OVERVIEW_WIDTH,t.scrollbar.verticalHasArrows=!1,t.extraEditorClassName="modified-in-monaco-diff-editor",Object.assign(Object.assign({},t),{dimension:{height:0,width:0}})}doLayout(){this._elementSizeObserver.observe(),this._doLayout()}_doLayout(){const i=this._elementSizeObserver.getWidth(),t=this._elementSizeObserver.getHeight(),o=this._getReviewHeight(),n=this._strategy.layout();this._originalDomNode.style.width=n+"px",this._originalDomNode.style.left="0px",this._modifiedDomNode.style.width=i-n+"px",this._modifiedDomNode.style.left=n+"px",this._overviewDomElement.style.top="0px",this._overviewDomElement.style.height=t-o+"px",this._overviewDomElement.style.width=e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px",this._overviewDomElement.style.left=i-e.ENTIRE_DIFF_OVERVIEW_WIDTH+"px",this._overviewViewportDomElement.setWidth(e.ENTIRE_DIFF_OVERVIEW_WIDTH),this._overviewViewportDomElement.setHeight(30),this._originalEditor.layout({width:n,height:t-o}),this._modifiedEditor.layout({width:i-n-(this._options.renderOverviewRuler?e.ENTIRE_DIFF_OVERVIEW_WIDTH:0),height:t-o}),(this._originalOverviewRuler||this._modifiedOverviewRuler)&&this._layoutOverviewRulers(),this._reviewPane.layout(t-o,i,o),this._layoutOverviewViewport()}_layoutOverviewViewport(){const e=this._computeOverviewViewport();e?(this._overviewViewportDomElement.setTop(e.top),this._overviewViewportDomElement.setHeight(e.height)):(this._overviewViewportDomElement.setTop(0),this._overviewViewportDomElement.setHeight(0))}_computeOverviewViewport(){const e=this._modifiedEditor.getLayoutInfo();if(!e)return null;const i=this._modifiedEditor.getScrollTop(),t=this._modifiedEditor.getScrollHeight(),o=Math.max(0,e.height),n=Math.max(0,o-0),r=t>0?n/t:0;return{height:Math.max(0,Math.floor(e.height*r)),top:Math.floor(i*r)}}_createDataSource(){return{getWidth:()=>this._elementSizeObserver.getWidth(),getHeight:()=>this._elementSizeObserver.getHeight()-this._getReviewHeight(),getOptions:()=>({renderOverviewRuler:this._options.renderOverviewRuler}),getContainerDomNode:()=>this._containerDomElement,relayoutEditors:()=>{this._doLayout()},getOriginalEditor:()=>this._originalEditor,getModifiedEditor:()=>this._modifiedEditor}}_setStrategy(e){var i;null===(i=this._strategy)||void 0===i||i.dispose(),this._strategy=e,this._boundarySashes&&e.setBoundarySashes(this._boundarySashes),e.applyColors(this._themeService.getColorTheme()),this._diffComputationResult&&this._updateDecorations(),this._doLayout()}_getLineChangeAtOrBeforeLineNumber(e,i){const t=this._diffComputationResult?this._diffComputationResult.changes:[];if(0===t.length||e<i(t[0]))return null;let o=0,n=t.length-1;for(;o<n;){const r=Math.floor((o+n)/2),s=i(t[r]),d=r+1<=n?i(t[r+1]):1073741824;e<s?n=r-1:e>=d?o=r+1:(o=r,n=r)}return t[o]}_getEquivalentLineForOriginalLineNumber(e){const i=this._getLineChangeAtOrBeforeLineNumber(e,(e=>e.originalStartLineNumber));if(!i)return e;const t=i.originalStartLineNumber+(i.originalEndLineNumber>0?-1:0),o=i.modifiedStartLineNumber+(i.modifiedEndLineNumber>0?-1:0),n=i.originalEndLineNumber>0?i.originalEndLineNumber-i.originalStartLineNumber+1:0,r=i.modifiedEndLineNumber>0?i.modifiedEndLineNumber-i.modifiedStartLineNumber+1:0,s=e-t;return s<=n?o+Math.min(s,r):o+r-n+s}_getEquivalentLineForModifiedLineNumber(e){const i=this._getLineChangeAtOrBeforeLineNumber(e,(e=>e.modifiedStartLineNumber));if(!i)return e;const t=i.originalStartLineNumber+(i.originalEndLineNumber>0?-1:0),o=i.modifiedStartLineNumber+(i.modifiedEndLineNumber>0?-1:0),n=i.originalEndLineNumber>0?i.originalEndLineNumber-i.originalStartLineNumber+1:0,r=i.modifiedEndLineNumber>0?i.modifiedEndLineNumber-i.modifiedStartLineNumber+1:0,s=e-o;return s<=r?t+Math.min(s,n):t+n-r+s}getDiffLineInformationForOriginal(e){return this._diffComputationResult?{equivalentLineNumber:this._getEquivalentLineForOriginalLineNumber(e)}:null}getDiffLineInformationForModified(e){return this._diffComputationResult?{equivalentLineNumber:this._getEquivalentLineForModifiedLineNumber(e)}:null}};DiffEditorWidget.ONE_OVERVIEW_WIDTH=15,DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH=30,DiffEditorWidget.UPDATE_DIFF_DECORATIONS_DELAY=200,DiffEditorWidget=__decorate([__param(3,IClipboardService),__param(4,IContextKeyService),__param(5,IInstantiationService),__param(6,ICodeEditorService),__param(7,IThemeService),__param(8,INotificationService),__param(9,IContextMenuService),__param(10,IEditorProgressService)],DiffEditorWidget);export{DiffEditorWidget};class DiffEditorWidgetStyle extends Disposable{constructor(e){super(),this._dataSource=e,this._insertColor=null,this._removeColor=null}applyColors(e){const i=e.getColor(diffOverviewRulerInserted)||(e.getColor(diffInserted)||defaultInsertColor).transparent(2),t=e.getColor(diffOverviewRulerRemoved)||(e.getColor(diffRemoved)||defaultRemoveColor).transparent(2),o=!i.equals(this._insertColor)||!t.equals(this._removeColor);return this._insertColor=i,this._removeColor=t,o}getEditorsDiffDecorations(e,i,t,o,n,r){r=r.sort(((e,i)=>e.afterLineNumber-i.afterLineNumber)),n=n.sort(((e,i)=>e.afterLineNumber-i.afterLineNumber));const s=this._getViewZones(e,n,r,t),d=this._getOriginalEditorDecorations(s,e,i,t),a=this._getModifiedEditorDecorations(s,e,i,t,o);return{original:{decorations:d.decorations,overviewZones:d.overviewZones,zones:s.original},modified:{decorations:a.decorations,overviewZones:a.overviewZones,zones:s.modified}}}setBoundarySashes(e){}}class ForeignViewZonesIterator{constructor(e){this._source=e,this._index=-1,this.current=null,this.advance()}advance(){this._index++,this._index<this._source.length?this.current=this._source[this._index]:this.current=null}}class ViewZonesComputer{constructor(e,i,t,o,n){this._lineChanges=e,this._originalForeignVZ=i,this._modifiedForeignVZ=t,this._originalEditor=o,this._modifiedEditor=n}static _getViewLineCount(e,i,t){const o=e.getModel(),n=e._getViewModel();if(o&&n){const e=getViewRange(o,n,i,t);return e.endLineNumber-e.startLineNumber+1}return t-i+1}getViewZones(){const e=this._originalEditor.getOption(63),i=this._modifiedEditor.getOption(63),t=-1!==this._originalEditor.getOption(139).wrappingColumn,o=-1!==this._modifiedEditor.getOption(139).wrappingColumn,n=t||o,r=this._originalEditor.getModel(),s=this._originalEditor._getViewModel().coordinatesConverter,d=this._modifiedEditor._getViewModel().coordinatesConverter,a=[],l=[];let m=0,h=0,g=0,u=0,f=0,c=0;const _=(e,i)=>e.afterLineNumber-i.afterLineNumber,p=(e,i)=>{if(null===i.domNode&&e.length>0){const t=e[e.length-1];if(t.afterLineNumber===i.afterLineNumber&&null===t.domNode)return void(t.heightInLines+=i.heightInLines)}e.push(i)},E=new ForeignViewZonesIterator(this._modifiedForeignVZ),v=new ForeignViewZonesIterator(this._originalForeignVZ);let S=1,D=1;for(let t=0,o=this._lineChanges.length;t<=o;t++){const N=t<o?this._lineChanges[t]:null;null!==N?(g=N.originalStartLineNumber+(N.originalEndLineNumber>0?-1:0),u=N.modifiedStartLineNumber+(N.modifiedEndLineNumber>0?-1:0),h=N.originalEndLineNumber>0?ViewZonesComputer._getViewLineCount(this._originalEditor,N.originalStartLineNumber,N.originalEndLineNumber):0,m=N.modifiedEndLineNumber>0?ViewZonesComputer._getViewLineCount(this._modifiedEditor,N.modifiedStartLineNumber,N.modifiedEndLineNumber):0,f=Math.max(N.originalStartLineNumber,N.originalEndLineNumber),c=Math.max(N.modifiedStartLineNumber,N.modifiedEndLineNumber)):(g+=1e7+h,u+=1e7+m,f=g,c=u);let L=[],b=[];if(n){let e;e=N?N.originalEndLineNumber>0?N.originalStartLineNumber-S:N.modifiedStartLineNumber-D:r.getLineCount()-S+1;for(let i=0;i<e;i++){const e=S+i,t=D+i,o=s.getModelLineViewLineCount(e),n=d.getModelLineViewLineCount(t);o<n?L.push({afterLineNumber:e,heightInLines:n-o,domNode:null,marginDomNode:null}):o>n&&b.push({afterLineNumber:t,heightInLines:o-n,domNode:null,marginDomNode:null})}N&&(S=(N.originalEndLineNumber>0?N.originalEndLineNumber:N.originalStartLineNumber)+1,D=(N.modifiedEndLineNumber>0?N.modifiedEndLineNumber:N.modifiedStartLineNumber)+1)}for(;E.current&&E.current.afterLineNumber<=c;){let e;e=E.current.afterLineNumber<=u?g-u+E.current.afterLineNumber:f;let t=null;N&&N.modifiedStartLineNumber<=E.current.afterLineNumber&&E.current.afterLineNumber<=N.modifiedEndLineNumber&&(t=this._createOriginalMarginDomNodeForModifiedForeignViewZoneInAddedRegion()),L.push({afterLineNumber:e,heightInLines:E.current.height/i,domNode:null,marginDomNode:t}),E.advance()}for(;v.current&&v.current.afterLineNumber<=f;){let i;i=v.current.afterLineNumber<=g?u-g+v.current.afterLineNumber:c,b.push({afterLineNumber:i,heightInLines:v.current.height/e,domNode:null}),v.advance()}if(null!==N&&isChangeOrInsert(N)){const e=this._produceOriginalFromDiff(N,h,m);e&&L.push(e)}if(null!==N&&isChangeOrDelete(N)){const e=this._produceModifiedFromDiff(N,h,m);e&&b.push(e)}let C=0,w=0;for(L=L.sort(_),b=b.sort(_);C<L.length&&w<b.length;){const e=L[C],i=b[w],t=e.afterLineNumber-g,o=i.afterLineNumber-u;t<o?(p(a,e),C++):o<t?(p(l,i),w++):e.shouldNotShrink?(p(a,e),C++):i.shouldNotShrink?(p(l,i),w++):e.heightInLines>=i.heightInLines?(e.heightInLines-=i.heightInLines,w++):(i.heightInLines-=e.heightInLines,C++)}for(;C<L.length;)p(a,L[C]),C++;for(;w<b.length;)p(l,b[w]),w++}return{original:ViewZonesComputer._ensureDomNodes(a),modified:ViewZonesComputer._ensureDomNodes(l)}}static _ensureDomNodes(e){return e.map((e=>(e.domNode||(e.domNode=createFakeLinesDiv()),e)))}}function createDecoration(e,i,t,o,n){return{range:new Range(e,i,t,o),options:n}}const DECORATIONS={arrowRevertChange:ModelDecorationOptions.register({description:"diff-editor-arrow-revert-change",glyphMarginClassName:"arrow-revert-change "+ThemeIcon.asClassName(Codicon.arrowRight)}),charDelete:ModelDecorationOptions.register({description:"diff-editor-char-delete",className:"char-delete"}),charDeleteWholeLine:ModelDecorationOptions.register({description:"diff-editor-char-delete-whole-line",className:"char-delete",isWholeLine:!0}),charInsert:ModelDecorationOptions.register({description:"diff-editor-char-insert",className:"char-insert"}),charInsertWholeLine:ModelDecorationOptions.register({description:"diff-editor-char-insert-whole-line",className:"char-insert",isWholeLine:!0}),lineInsert:ModelDecorationOptions.register({description:"diff-editor-line-insert",className:"line-insert",marginClassName:"gutter-insert",isWholeLine:!0}),lineInsertWithSign:ModelDecorationOptions.register({description:"diff-editor-line-insert-with-sign",className:"line-insert",linesDecorationsClassName:"insert-sign "+ThemeIcon.asClassName(diffInsertIcon),marginClassName:"gutter-insert",isWholeLine:!0}),lineDelete:ModelDecorationOptions.register({description:"diff-editor-line-delete",className:"line-delete",marginClassName:"gutter-delete",isWholeLine:!0}),lineDeleteWithSign:ModelDecorationOptions.register({description:"diff-editor-line-delete-with-sign",className:"line-delete",linesDecorationsClassName:"delete-sign "+ThemeIcon.asClassName(diffRemoveIcon),marginClassName:"gutter-delete",isWholeLine:!0}),lineDeleteMargin:ModelDecorationOptions.register({description:"diff-editor-line-delete-margin",marginClassName:"gutter-delete"})};class DiffEditorWidgetSideBySide extends DiffEditorWidgetStyle{constructor(e,i){super(e),this._disableSash=!1===i,this._sashRatio=null,this._sashPosition=null,this._startSashPosition=null,this._sash=this._register(new Sash(this._dataSource.getContainerDomNode(),this,{orientation:0})),this._disableSash&&(this._sash.state=0),this._sash.onDidStart((()=>this._onSashDragStart())),this._sash.onDidChange((e=>this._onSashDrag(e))),this._sash.onDidEnd((()=>this._onSashDragEnd())),this._sash.onDidReset((()=>this._onSashReset()))}setEnableSplitViewResizing(e){const i=!1===e;this._disableSash!==i&&(this._disableSash=i,this._sash.state=this._disableSash?0:3)}layout(e=this._sashRatio){const i=this._dataSource.getWidth()-(this._dataSource.getOptions().renderOverviewRuler?DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH:0);let t=Math.floor((e||.5)*i);const o=Math.floor(.5*i);return t=this._disableSash?o:t||o,i>2*DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH?(t<DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH&&(t=DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH),t>i-DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH&&(t=i-DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH)):t=o,this._sashPosition!==t&&(this._sashPosition=t),this._sash.layout(),this._sashPosition}_onSashDragStart(){this._startSashPosition=this._sashPosition}_onSashDrag(e){const i=this._dataSource.getWidth()-(this._dataSource.getOptions().renderOverviewRuler?DiffEditorWidget.ENTIRE_DIFF_OVERVIEW_WIDTH:0),t=this.layout((this._startSashPosition+(e.currentX-e.startX))/i);this._sashRatio=t/i,this._dataSource.relayoutEditors()}_onSashDragEnd(){this._sash.layout()}_onSashReset(){this._sashRatio=.5,this._dataSource.relayoutEditors(),this._sash.layout()}getVerticalSashTop(e){return 0}getVerticalSashLeft(e){return this._sashPosition}getVerticalSashHeight(e){return this._dataSource.getHeight()}setBoundarySashes(e){this._sash.orthogonalEndSash=e.bottom}_getViewZones(e,i,t){const o=this._dataSource.getOriginalEditor(),n=this._dataSource.getModifiedEditor();return new SideBySideViewZonesComputer(e,i,t,o,n).getViewZones()}_getOriginalEditorDecorations(e,i,t,o){const n=this._dataSource.getOriginalEditor(),r=String(this._removeColor),s={decorations:[],overviewZones:[]},d=n.getModel(),a=n._getViewModel();for(const e of i)if(isChangeOrDelete(e)){s.decorations.push({range:new Range(e.originalStartLineNumber,1,e.originalEndLineNumber,1073741824),options:o?DECORATIONS.lineDeleteWithSign:DECORATIONS.lineDelete}),isChangeOrInsert(e)&&e.charChanges||s.decorations.push(createDecoration(e.originalStartLineNumber,1,e.originalEndLineNumber,1073741824,DECORATIONS.charDeleteWholeLine));const i=getViewRange(d,a,e.originalStartLineNumber,e.originalEndLineNumber);if(s.overviewZones.push(new OverviewRulerZone(i.startLineNumber,i.endLineNumber,0,r)),e.charChanges)for(const i of e.charChanges)if(isCharChangeOrDelete(i))if(t)for(let e=i.originalStartLineNumber;e<=i.originalEndLineNumber;e++){let t,o;t=e===i.originalStartLineNumber?i.originalStartColumn:d.getLineFirstNonWhitespaceColumn(e),o=e===i.originalEndLineNumber?i.originalEndColumn:d.getLineLastNonWhitespaceColumn(e),s.decorations.push(createDecoration(e,t,e,o,DECORATIONS.charDelete))}else s.decorations.push(createDecoration(i.originalStartLineNumber,i.originalStartColumn,i.originalEndLineNumber,i.originalEndColumn,DECORATIONS.charDelete))}return s}_getModifiedEditorDecorations(e,i,t,o,n){const r=this._dataSource.getModifiedEditor(),s=String(this._insertColor),d={decorations:[],overviewZones:[]},a=r.getModel(),l=r._getViewModel();for(const r of i){if(n)if(r.modifiedEndLineNumber>0)d.decorations.push({range:new Range(r.modifiedStartLineNumber,1,r.modifiedStartLineNumber,1),options:DECORATIONS.arrowRevertChange});else{const i=e.modified.find((e=>e.afterLineNumber===r.modifiedStartLineNumber));i&&(i.marginDomNode=createViewZoneMarginArrow())}if(isChangeOrInsert(r)){d.decorations.push({range:new Range(r.modifiedStartLineNumber,1,r.modifiedEndLineNumber,1073741824),options:o?DECORATIONS.lineInsertWithSign:DECORATIONS.lineInsert}),isChangeOrDelete(r)&&r.charChanges||d.decorations.push(createDecoration(r.modifiedStartLineNumber,1,r.modifiedEndLineNumber,1073741824,DECORATIONS.charInsertWholeLine));const e=getViewRange(a,l,r.modifiedStartLineNumber,r.modifiedEndLineNumber);if(d.overviewZones.push(new OverviewRulerZone(e.startLineNumber,e.endLineNumber,0,s)),r.charChanges)for(const e of r.charChanges)if(isCharChangeOrInsert(e))if(t)for(let i=e.modifiedStartLineNumber;i<=e.modifiedEndLineNumber;i++){let t,o;t=i===e.modifiedStartLineNumber?e.modifiedStartColumn:a.getLineFirstNonWhitespaceColumn(i),o=i===e.modifiedEndLineNumber?e.modifiedEndColumn:a.getLineLastNonWhitespaceColumn(i),d.decorations.push(createDecoration(i,t,i,o,DECORATIONS.charInsert))}else d.decorations.push(createDecoration(e.modifiedStartLineNumber,e.modifiedStartColumn,e.modifiedEndLineNumber,e.modifiedEndColumn,DECORATIONS.charInsert))}}return d}}DiffEditorWidgetSideBySide.MINIMUM_EDITOR_WIDTH=100;class SideBySideViewZonesComputer extends ViewZonesComputer{constructor(e,i,t,o,n){super(e,i,t,o,n)}_createOriginalMarginDomNodeForModifiedForeignViewZoneInAddedRegion(){return null}_produceOriginalFromDiff(e,i,t){return t>i?{afterLineNumber:Math.max(e.originalStartLineNumber,e.originalEndLineNumber),heightInLines:t-i,domNode:null}:null}_produceModifiedFromDiff(e,i,t){return i>t?{afterLineNumber:Math.max(e.modifiedStartLineNumber,e.modifiedEndLineNumber),heightInLines:i-t,domNode:null}:null}}class DiffEditorWidgetInline extends DiffEditorWidgetStyle{constructor(e,i){super(e),this._decorationsLeft=e.getOriginalEditor().getLayoutInfo().decorationsLeft,this._register(e.getOriginalEditor().onDidLayoutChange((i=>{this._decorationsLeft!==i.decorationsLeft&&(this._decorationsLeft=i.decorationsLeft,e.relayoutEditors())})))}setEnableSplitViewResizing(e){}_getViewZones(e,i,t,o){const n=this._dataSource.getOriginalEditor(),r=this._dataSource.getModifiedEditor();return new InlineViewZonesComputer(e,i,t,n,r,o).getViewZones()}_getOriginalEditorDecorations(e,i,t,o){const n=String(this._removeColor),r={decorations:[],overviewZones:[]},s=this._dataSource.getOriginalEditor(),d=s.getModel(),a=s._getViewModel();let l=0;for(const t of i)if(isChangeOrDelete(t)){for(r.decorations.push({range:new Range(t.originalStartLineNumber,1,t.originalEndLineNumber,1073741824),options:DECORATIONS.lineDeleteMargin});l<e.modified.length;){const i=e.modified[l];if(i.diff&&i.diff.originalStartLineNumber>=t.originalStartLineNumber)break;l++}let i=0;if(l<e.modified.length){const o=e.modified[l];o.diff&&o.diff.originalStartLineNumber===t.originalStartLineNumber&&o.diff.originalEndLineNumber===t.originalEndLineNumber&&o.diff.modifiedStartLineNumber===t.modifiedStartLineNumber&&o.diff.modifiedEndLineNumber===t.modifiedEndLineNumber&&(i=o.heightInLines)}const o=getViewRange(d,a,t.originalStartLineNumber,t.originalEndLineNumber);r.overviewZones.push(new OverviewRulerZone(o.startLineNumber,o.endLineNumber,i,n))}return r}_getModifiedEditorDecorations(e,i,t,o,n){const r=this._dataSource.getModifiedEditor(),s=String(this._insertColor),d={decorations:[],overviewZones:[]},a=r.getModel(),l=r._getViewModel();for(const e of i)if(isChangeOrInsert(e)){d.decorations.push({range:new Range(e.modifiedStartLineNumber,1,e.modifiedEndLineNumber,1073741824),options:o?DECORATIONS.lineInsertWithSign:DECORATIONS.lineInsert});const i=getViewRange(a,l,e.modifiedStartLineNumber,e.modifiedEndLineNumber);if(d.overviewZones.push(new OverviewRulerZone(i.startLineNumber,i.endLineNumber,0,s)),e.charChanges){for(const i of e.charChanges)if(isCharChangeOrInsert(i))if(t)for(let e=i.modifiedStartLineNumber;e<=i.modifiedEndLineNumber;e++){let t,o;t=e===i.modifiedStartLineNumber?i.modifiedStartColumn:a.getLineFirstNonWhitespaceColumn(e),o=e===i.modifiedEndLineNumber?i.modifiedEndColumn:a.getLineLastNonWhitespaceColumn(e),d.decorations.push(createDecoration(e,t,e,o,DECORATIONS.charInsert))}else d.decorations.push(createDecoration(i.modifiedStartLineNumber,i.modifiedStartColumn,i.modifiedEndLineNumber,i.modifiedEndColumn,DECORATIONS.charInsert))}else d.decorations.push(createDecoration(e.modifiedStartLineNumber,1,e.modifiedEndLineNumber,1073741824,DECORATIONS.charInsertWholeLine))}return d}layout(){return Math.max(5,this._decorationsLeft)}}class InlineViewZonesComputer extends ViewZonesComputer{constructor(e,i,t,o,n,r){super(e,i,t,o,n),this._originalModel=o.getModel(),this._renderIndicators=r,this._pendingLineChange=[],this._pendingViewZones=[],this._lineBreaksComputer=this._modifiedEditor._getViewModel().createLineBreaksComputer()}getViewZones(){const e=super.getViewZones();return this._finalize(e),e}_createOriginalMarginDomNodeForModifiedForeignViewZoneInAddedRegion(){const e=document.createElement("div");return e.className="inline-added-margin-view-zone",e}_produceOriginalFromDiff(e,i,t){const o=document.createElement("div");return o.className="inline-added-margin-view-zone",{afterLineNumber:Math.max(e.originalStartLineNumber,e.originalEndLineNumber),heightInLines:t,domNode:document.createElement("div"),marginDomNode:o}}_produceModifiedFromDiff(e,i,t){const o=document.createElement("div");o.className=`view-lines line-delete ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`;const n=document.createElement("div");n.className="inline-deleted-margin-view-zone";const r={shouldNotShrink:!0,afterLineNumber:0===e.modifiedEndLineNumber?e.modifiedStartLineNumber:e.modifiedStartLineNumber-1,heightInLines:i,minWidthInPx:0,domNode:o,marginDomNode:n,diff:{originalStartLineNumber:e.originalStartLineNumber,originalEndLineNumber:e.originalEndLineNumber,modifiedStartLineNumber:e.modifiedStartLineNumber,modifiedEndLineNumber:e.modifiedEndLineNumber,originalModel:this._originalModel,viewLineCounts:null}};for(let i=e.originalStartLineNumber;i<=e.originalEndLineNumber;i++)this._lineBreaksComputer.addRequest(this._originalModel.getLineContent(i),null,null);return this._pendingLineChange.push(e),this._pendingViewZones.push(r),r}_finalize(e){const i=this._modifiedEditor.getOptions(),t=this._modifiedEditor.getModel().getOptions().tabSize,o=i.get(47),n=i.get(30),r=o.typicalHalfwidthCharacterWidth,s=i.get(98),d=this._originalModel.mightContainNonBasicASCII(),a=this._originalModel.mightContainRTL(),l=i.get(63),m=i.get(138).decorationsWidth,h=i.get(111),g=i.get(93),u=i.get(88),f=i.get(48),c=this._lineBreaksComputer.finalize();let _=0;for(let i=0;i<this._pendingLineChange.length;i++){const p=this._pendingLineChange[i],E=this._pendingViewZones[i],v=E.domNode;applyFontInfo(v,o);const S=E.marginDomNode;applyFontInfo(S,o);const D=[];if(p.charChanges)for(const e of p.charChanges)isCharChangeOrDelete(e)&&D.push(new InlineDecoration(new Range(e.originalStartLineNumber,e.originalStartColumn,e.originalEndLineNumber,e.originalEndColumn),"char-delete",0));const N=D.length>0,L=new StringBuilder(1e4);let b=0,C=0,w=null;for(let i=p.originalStartLineNumber;i<=p.originalEndLineNumber;i++){const r=i-p.originalStartLineNumber,s=this._originalModel.tokenization.getLineTokens(i),v=s.getLineContent(),O=c[_++],I=LineDecoration.filter(D,i,1,v.length+1);if(O){let c=0;for(const e of O.breakOffsets){const i=s.sliceAndInflate(c,e,0),r=v.substring(c,e);b=Math.max(b,this._renderOriginalLine(C++,r,i,LineDecoration.extractWrapped(I,c,e),N,d,a,o,n,l,m,h,g,u,f,t,L,S)),c=e}for(w||(w=[]);w.length<r;)w[w.length]=1;w[r]=O.breakOffsets.length,E.heightInLines+=O.breakOffsets.length-1;const _=document.createElement("div");_.className="gutter-delete",e.original.push({afterLineNumber:i,afterColumn:0,heightInLines:O.breakOffsets.length-1,domNode:createFakeLinesDiv(),marginDomNode:_})}else b=Math.max(b,this._renderOriginalLine(C++,v,s,I,N,d,a,o,n,l,m,h,g,u,f,t,L,S))}b+=s;const O=L.build(),I=ttPolicy?ttPolicy.createHTML(O):O;if(v.innerHTML=I,E.minWidthInPx=b*r,w){const e=p.originalEndLineNumber-p.originalStartLineNumber;for(;w.length<=e;)w[w.length]=1}E.diff.viewLineCounts=w}e.original.sort(((e,i)=>e.afterLineNumber-i.afterLineNumber))}_renderOriginalLine(e,i,t,o,n,r,s,d,a,l,m,h,g,u,f,c,_,p){_.appendString('<div class="view-line'),n||_.appendString(" char-delete"),_.appendString('" style="top:'),_.appendString(String(e*l)),_.appendString('px;width:1000000px;">');const E=ViewLineRenderingData.isBasicASCII(i,r),v=ViewLineRenderingData.containsRTL(i,E,s),S=renderViewLine(new RenderLineInput(d.isMonospace&&!a,d.canUseHalfwidthRightwardsArrow,i,!1,E,v,0,t,o,c,0,d.spaceWidth,d.middotWidth,d.wsmiddotWidth,h,g,u,f!==EditorFontLigatures.OFF,null),_);if(_.appendString("</div>"),this._renderIndicators){const i=document.createElement("div");i.className=`delete-sign ${ThemeIcon.asClassName(diffRemoveIcon)}`,i.setAttribute("style",`position:absolute;top:${e*l}px;width:${m}px;height:${l}px;right:0;`),p.appendChild(i)}return S.characterMapping.getHorizontalOffset(S.characterMapping.length)}}function validateDiffWordWrap(e,i){return validateStringSetOption(e,i,["off","on","inherit"])}function isChangeOrInsert(e){return e.modifiedEndLineNumber>0}function isChangeOrDelete(e){return e.originalEndLineNumber>0}function isCharChangeOrInsert(e){return e.modifiedStartLineNumber===e.modifiedEndLineNumber?e.modifiedEndColumn-e.modifiedStartColumn>0:e.modifiedEndLineNumber-e.modifiedStartLineNumber>0}function isCharChangeOrDelete(e){return e.originalStartLineNumber===e.originalEndLineNumber?e.originalEndColumn-e.originalStartColumn>0:e.originalEndLineNumber-e.originalStartLineNumber>0}function createFakeLinesDiv(){const e=document.createElement("div");return e.className="diagonal-fill",e}function createViewZoneMarginArrow(){const e=document.createElement("div");return e.className="arrow-revert-change "+ThemeIcon.asClassName(Codicon.arrowRight),dom.$("div",{},e)}function getViewRange(e,i,t,o){const n=e.getLineCount();return t=Math.min(n,Math.max(1,t)),o=Math.min(n,Math.max(1,o)),i.coordinatesConverter.convertModelRangeToViewRange(new Range(t,e.getLineMinColumn(t),o,e.getLineMaxColumn(o)))}function validateDiffEditorOptions(e,i){return{enableSplitViewResizing:validateBooleanOption(e.enableSplitViewResizing,i.enableSplitViewResizing),renderSideBySide:validateBooleanOption(e.renderSideBySide,i.renderSideBySide),renderMarginRevertIcon:validateBooleanOption(e.renderMarginRevertIcon,i.renderMarginRevertIcon),maxComputationTime:clampedInt(e.maxComputationTime,i.maxComputationTime,0,1073741824),maxFileSize:clampedInt(e.maxFileSize,i.maxFileSize,0,1073741824),ignoreTrimWhitespace:validateBooleanOption(e.ignoreTrimWhitespace,i.ignoreTrimWhitespace),renderIndicators:validateBooleanOption(e.renderIndicators,i.renderIndicators),originalEditable:validateBooleanOption(e.originalEditable,i.originalEditable),diffCodeLens:validateBooleanOption(e.diffCodeLens,i.diffCodeLens),renderOverviewRuler:validateBooleanOption(e.renderOverviewRuler,i.renderOverviewRuler),diffWordWrap:validateDiffWordWrap(e.diffWordWrap,i.diffWordWrap),diffAlgorithm:validateStringSetOption(e.diffAlgorithm,i.diffAlgorithm,["smart","experimental"])}}function changedDiffEditorOptions(e,i){return{enableSplitViewResizing:e.enableSplitViewResizing!==i.enableSplitViewResizing,renderSideBySide:e.renderSideBySide!==i.renderSideBySide,renderMarginRevertIcon:e.renderMarginRevertIcon!==i.renderMarginRevertIcon,maxComputationTime:e.maxComputationTime!==i.maxComputationTime,maxFileSize:e.maxFileSize!==i.maxFileSize,ignoreTrimWhitespace:e.ignoreTrimWhitespace!==i.ignoreTrimWhitespace,renderIndicators:e.renderIndicators!==i.renderIndicators,originalEditable:e.originalEditable!==i.originalEditable,diffCodeLens:e.diffCodeLens!==i.diffCodeLens,renderOverviewRuler:e.renderOverviewRuler!==i.renderOverviewRuler,diffWordWrap:e.diffWordWrap!==i.diffWordWrap,diffAlgorithm:e.diffAlgorithm!==i.diffAlgorithm}}registerThemingParticipant(((e,i)=>{const t=e.getColor(diffDiagonalFill);i.addRule(`\n\t.monaco-editor .diagonal-fill {\n\t\tbackground-image: linear-gradient(\n\t\t\t-45deg,\n\t\t\t${t} 12.5%,\n\t\t\t#0000 12.5%, #0000 50%,\n\t\t\t${t} 50%, ${t} 62.5%,\n\t\t\t#0000 62.5%, #0000 100%\n\t\t);\n\t\tbackground-size: 8px 8px;\n\t}\n\t`)}));