var __decorate=this&&this.__decorate||function(e,i,t,s){var o,r=arguments.length,n=r<3?i:null===s?s=Object.getOwnPropertyDescriptor(i,t):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,i,t,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(n=(r<3?o(n):r>3?o(i,t,n):o(i,t))||n);return r>3&&n&&Object.defineProperty(i,t,n),n},__param=this&&this.__param||function(e,i){return function(t,s){i(t,s,e)}};import*as assert from"../../../base/common/assert.js";import{Emitter}from"../../../base/common/event.js";import{Disposable}from"../../../base/common/lifecycle.js";import*as objects from"../../../base/common/objects.js";import{Range}from"../../common/core/range.js";import{AudioCue,IAudioCueService}from"../../../platform/audioCues/browser/audioCueService.js";import{ICodeEditorService}from"../services/codeEditorService.js";import{IAccessibilityService}from"../../../platform/accessibility/common/accessibility.js";const defaultOptions={followsCaret:!0,ignoreCharChanges:!0,alwaysRevealFirst:!0,findResultLoop:!0};let DiffNavigator=class extends Disposable{constructor(e,i={},t,s,o){super(),this._audioCueService=t,this._codeEditorService=s,this._accessibilityService=o,this._onDidUpdate=this._register(new Emitter),this._editor=e,this._options=objects.mixin(i,defaultOptions,!1),this.disposed=!1,this.nextIdx=-1,this.ranges=[],this.ignoreSelectionChange=!1,this.revealFirst=Boolean(this._options.alwaysRevealFirst),this._register(this._editor.onDidDispose((()=>this.dispose()))),this._register(this._editor.onDidUpdateDiff((()=>this._onDiffUpdated()))),this._options.followsCaret&&this._register(this._editor.getModifiedEditor().onDidChangeCursorPosition((e=>{this.ignoreSelectionChange||(this._updateAccessibilityState(e.position.lineNumber),this.nextIdx=-1)}))),this._options.alwaysRevealFirst&&this._register(this._editor.getModifiedEditor().onDidChangeModel((e=>{this.revealFirst=!0}))),this._init()}_init(){this._editor.getLineChanges()}_onDiffUpdated(){this._init(),this._compute(this._editor.getLineChanges()),this.revealFirst&&null!==this._editor.getLineChanges()&&(this.revealFirst=!1,this.nextIdx=-1,this.next(1))}_compute(e){this.ranges=[],e&&e.forEach((e=>{!this._options.ignoreCharChanges&&e.charChanges?e.charChanges.forEach((e=>{this.ranges.push({rhs:!0,range:new Range(e.modifiedStartLineNumber,e.modifiedStartColumn,e.modifiedEndLineNumber,e.modifiedEndColumn)})})):0===e.modifiedEndLineNumber?this.ranges.push({rhs:!0,range:new Range(e.modifiedStartLineNumber,1,e.modifiedStartLineNumber+1,1)}):this.ranges.push({rhs:!0,range:new Range(e.modifiedStartLineNumber,1,e.modifiedEndLineNumber+1,1)})})),this.ranges.sort(((e,i)=>Range.compareRangesUsingStarts(e.range,i.range))),this._onDidUpdate.fire(this)}_initIdx(e){let i=!1;const t=this._editor.getPosition();if(t){for(let s=0,o=this.ranges.length;s<o&&!i;s++){const o=this.ranges[s].range;t.isBeforeOrEqual(o.getStartPosition())&&(this.nextIdx=s+(e?0:-1),i=!0)}i||(this.nextIdx=e?0:this.ranges.length-1),this.nextIdx<0&&(this.nextIdx=this.ranges.length-1)}else this.nextIdx=0}_move(e,i){if(assert.ok(!this.disposed,"Illegal State - diff navigator has been disposed"),!this.canNavigate())return;-1===this.nextIdx?this._initIdx(e):e?(this.nextIdx+=1,this.nextIdx>=this.ranges.length&&(this.nextIdx=0)):(this.nextIdx-=1,this.nextIdx<0&&(this.nextIdx=this.ranges.length-1));const t=this.ranges[this.nextIdx];this.ignoreSelectionChange=!0;try{const e=t.range.getStartPosition();this._editor.setPosition(e),this._editor.revealRangeInCenter(t.range,i),this._updateAccessibilityState(e.lineNumber,!0)}finally{this.ignoreSelectionChange=!1}}_updateAccessibilityState(e,i){var t;const s=null===(t=this._editor.getModel())||void 0===t?void 0:t.modified;if(!s)return;const o=s.getLineDecorations(e).find((e=>"line-insert"===e.options.className));if(o)this._audioCueService.playAudioCue(AudioCue.diffLineModified,!0);else{if(!i)return;this._audioCueService.playAudioCue(AudioCue.diffLineDeleted,!0)}const r=this._codeEditorService.getActiveCodeEditor();i&&r&&o&&this._accessibilityService.isScreenReaderOptimized()&&(r.setSelection({startLineNumber:e,startColumn:0,endLineNumber:e,endColumn:Number.MAX_VALUE}),r.writeScreenReaderContent("diff-navigation"))}canNavigate(){return this.ranges&&this.ranges.length>0}next(e=0){this.canNavigateNext()&&this._move(!0,e)}previous(e=0){this.canNavigatePrevious()&&this._move(!1,e)}canNavigateNext(){return this.canNavigateLoop()||this.nextIdx<this.ranges.length-1}canNavigatePrevious(){return this.canNavigateLoop()||0!==this.nextIdx}canNavigateLoop(){return Boolean(this._options.findResultLoop)}dispose(){super.dispose(),this.ranges=[],this.disposed=!0}};DiffNavigator=__decorate([__param(2,IAudioCueService),__param(3,ICodeEditorService),__param(4,IAccessibilityService)],DiffNavigator);export{DiffNavigator};