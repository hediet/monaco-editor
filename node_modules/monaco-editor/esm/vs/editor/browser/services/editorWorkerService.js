var __decorate=this&&this.__decorate||function(e,r,t,o){var i,n=arguments.length,s=n<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(n<3?i(s):n>3?i(r,t,s):i(r,t))||s);return n>3&&s&&Object.defineProperty(r,t,s),s},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(i,n){function s(e){try{c(o.next(e))}catch(e){n(e)}}function a(e){try{c(o.throw(e))}catch(e){n(e)}}function c(e){var r;e.done?i(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,a)}c((o=o.apply(e,r||[])).next())}))};import{IntervalTimer,timeout}from"../../../base/common/async.js";import{Disposable,dispose,toDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{SimpleWorkerClient,logOnceWebWorkerWarning}from"../../../base/common/worker/simpleWorker.js";import{DefaultWorkerFactory}from"../../../base/browser/defaultWorkerFactory.js";import{Range}from"../../common/core/range.js";import{ILanguageConfigurationService}from"../../common/languages/languageConfigurationRegistry.js";import{EditorSimpleWorker}from"../../common/services/editorSimpleWorker.js";import{IModelService}from"../../common/services/model.js";import{ITextResourceConfigurationService}from"../../common/services/textResourceConfiguration.js";import{regExpFlags}from"../../../base/common/strings.js";import{isNonEmptyArray}from"../../../base/common/arrays.js";import{ILogService}from"../../../platform/log/common/log.js";import{StopWatch}from"../../../base/common/stopwatch.js";import{canceled}from"../../../base/common/errors.js";import{ILanguageFeaturesService}from"../../common/services/languageFeatures.js";import{LineRangeMapping,LineRange,RangeMapping}from"../../common/diff/linesDiffComputer.js";const STOP_SYNC_MODEL_DELTA_TIME_MS=6e4,STOP_WORKER_DELTA_TIME_MS=3e5;function canSyncModel(e,r){const t=e.getModel(r);return!!t&&!t.isTooLargeForSyncing()}let EditorWorkerService=class extends Disposable{constructor(e,r,t,o,i){super(),this._modelService=e,this._workerManager=this._register(new WorkerManager(this._modelService,o)),this._logService=t,this._register(i.linkProvider.register({language:"*",hasAccessToAllModels:!0},{provideLinks:(e,r)=>canSyncModel(this._modelService,e.uri)?this._workerManager.withWorker().then((r=>r.computeLinks(e.uri))).then((e=>e&&{links:e})):Promise.resolve({links:[]})})),this._register(i.completionProvider.register("*",new WordBasedCompletionItemProvider(this._workerManager,r,this._modelService,o)))}dispose(){super.dispose()}canComputeUnicodeHighlights(e){return canSyncModel(this._modelService,e)}computedUnicodeHighlights(e,r,t){return this._workerManager.withWorker().then((o=>o.computedUnicodeHighlights(e,r,t)))}computeDiff(e,r,t,o){return __awaiter(this,void 0,void 0,(function*(){const i=yield this._workerManager.withWorker().then((i=>i.computeDiff(e,r,t,o)));return i?{identical:i.identical,quitEarly:i.quitEarly,changes:i.changes.map((e=>{var r;return new LineRangeMapping(new LineRange(e[0],e[1]),new LineRange(e[2],e[3]),null===(r=e[4])||void 0===r?void 0:r.map((e=>new RangeMapping(new Range(e[0],e[1],e[2],e[3]),new Range(e[4],e[5],e[6],e[7])))))}))}:null}))}computeMoreMinimalEdits(e,r){if(isNonEmptyArray(r)){if(!canSyncModel(this._modelService,e))return Promise.resolve(r);const t=StopWatch.create(!0),o=this._workerManager.withWorker().then((t=>t.computeMoreMinimalEdits(e,r)));return o.finally((()=>this._logService.trace("FORMAT#computeMoreMinimalEdits",e.toString(!0),t.elapsed()))),Promise.race([o,timeout(1e3).then((()=>r))])}return Promise.resolve(void 0)}canNavigateValueSet(e){return canSyncModel(this._modelService,e)}navigateValueSet(e,r,t){return this._workerManager.withWorker().then((o=>o.navigateValueSet(e,r,t)))}canComputeWordRanges(e){return canSyncModel(this._modelService,e)}computeWordRanges(e,r){return this._workerManager.withWorker().then((t=>t.computeWordRanges(e,r)))}};EditorWorkerService=__decorate([__param(0,IModelService),__param(1,ITextResourceConfigurationService),__param(2,ILogService),__param(3,ILanguageConfigurationService),__param(4,ILanguageFeaturesService)],EditorWorkerService);export{EditorWorkerService};class WordBasedCompletionItemProvider{constructor(e,r,t,o){this.languageConfigurationService=o,this._debugDisplayName="wordbasedCompletions",this._workerManager=e,this._configurationService=r,this._modelService=t}provideCompletionItems(e,r){return __awaiter(this,void 0,void 0,(function*(){const t=this._configurationService.getValue(e.uri,r,"editor");if(!t.wordBasedSuggestions)return;const o=[];if("currentDocument"===t.wordBasedSuggestionsMode)canSyncModel(this._modelService,e.uri)&&o.push(e.uri);else for(const r of this._modelService.getModels())canSyncModel(this._modelService,r.uri)&&(r===e?o.unshift(r.uri):"allDocuments"!==t.wordBasedSuggestionsMode&&r.getLanguageId()!==e.getLanguageId()||o.push(r.uri));if(0===o.length)return;const i=this.languageConfigurationService.getLanguageConfiguration(e.getLanguageId()).getWordDefinition(),n=e.getWordAtPosition(r),s=n?new Range(r.lineNumber,n.startColumn,r.lineNumber,n.endColumn):Range.fromPositions(r),a=s.setEndPosition(r.lineNumber,r.column),c=yield this._workerManager.withWorker(),d=yield c.textualSuggest(o,null==n?void 0:n.word,i);return d?{duration:d.duration,suggestions:d.words.map((e=>({kind:18,label:e,insertText:e,range:{insert:a,replace:s}})))}:void 0}))}}class WorkerManager extends Disposable{constructor(e,r){super(),this.languageConfigurationService=r,this._modelService=e,this._editorWorkerClient=null,this._lastWorkerUsedTime=(new Date).getTime(),this._register(new IntervalTimer).cancelAndSet((()=>this._checkStopIdleWorker()),Math.round(15e4)),this._register(this._modelService.onModelRemoved((e=>this._checkStopEmptyWorker())))}dispose(){this._editorWorkerClient&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null),super.dispose()}_checkStopEmptyWorker(){this._editorWorkerClient&&0===this._modelService.getModels().length&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}_checkStopIdleWorker(){this._editorWorkerClient&&(new Date).getTime()-this._lastWorkerUsedTime>3e5&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}withWorker(){return this._lastWorkerUsedTime=(new Date).getTime(),this._editorWorkerClient||(this._editorWorkerClient=new EditorWorkerClient(this._modelService,!1,"editorWorkerService",this.languageConfigurationService)),Promise.resolve(this._editorWorkerClient)}}class EditorModelManager extends Disposable{constructor(e,r,t){if(super(),this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),this._proxy=e,this._modelService=r,!t){const e=new IntervalTimer;e.cancelAndSet((()=>this._checkStopModelSync()),Math.round(3e4)),this._register(e)}}dispose(){for(const e in this._syncedModels)dispose(this._syncedModels[e]);this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),super.dispose()}ensureSyncedResources(e,r){for(const t of e){const e=t.toString();this._syncedModels[e]||this._beginModelSync(t,r),this._syncedModels[e]&&(this._syncedModelsLastUsedTime[e]=(new Date).getTime())}}_checkStopModelSync(){const e=(new Date).getTime(),r=[];for(const t in this._syncedModelsLastUsedTime)e-this._syncedModelsLastUsedTime[t]>6e4&&r.push(t);for(const e of r)this._stopModelSync(e)}_beginModelSync(e,r){const t=this._modelService.getModel(e);if(!t)return;if(!r&&t.isTooLargeForSyncing())return;const o=e.toString();this._proxy.acceptNewModel({url:t.uri.toString(),lines:t.getLinesContent(),EOL:t.getEOL(),versionId:t.getVersionId()});const i=new DisposableStore;i.add(t.onDidChangeContent((e=>{this._proxy.acceptModelChanged(o.toString(),e)}))),i.add(t.onWillDispose((()=>{this._stopModelSync(o)}))),i.add(toDisposable((()=>{this._proxy.acceptRemovedModel(o)}))),this._syncedModels[o]=i}_stopModelSync(e){const r=this._syncedModels[e];delete this._syncedModels[e],delete this._syncedModelsLastUsedTime[e],dispose(r)}}class SynchronousWorkerClient{constructor(e){this._instance=e,this._proxyObj=Promise.resolve(this._instance)}dispose(){this._instance.dispose()}getProxyObject(){return this._proxyObj}}export class EditorWorkerHost{constructor(e){this._workerClient=e}fhr(e,r){return this._workerClient.fhr(e,r)}}export class EditorWorkerClient extends Disposable{constructor(e,r,t,o){super(),this.languageConfigurationService=o,this._disposed=!1,this._modelService=e,this._keepIdleModels=r,this._workerFactory=new DefaultWorkerFactory(t),this._worker=null,this._modelManager=null}fhr(e,r){throw new Error("Not implemented!")}_getOrCreateWorker(){if(!this._worker)try{this._worker=this._register(new SimpleWorkerClient(this._workerFactory,"vs/editor/common/services/editorSimpleWorker",new EditorWorkerHost(this)))}catch(e){logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null))}return this._worker}_getProxy(){return this._getOrCreateWorker().getProxyObject().then(void 0,(e=>(logOnceWebWorkerWarning(e),this._worker=new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this),null)),this._getOrCreateWorker().getProxyObject())))}_getOrCreateModelManager(e){return this._modelManager||(this._modelManager=this._register(new EditorModelManager(e,this._modelService,this._keepIdleModels))),this._modelManager}_withSyncedResources(e,r=!1){return __awaiter(this,void 0,void 0,(function*(){return this._disposed?Promise.reject(canceled()):this._getProxy().then((t=>(this._getOrCreateModelManager(t).ensureSyncedResources(e,r),t)))}))}computedUnicodeHighlights(e,r,t){return this._withSyncedResources([e]).then((o=>o.computeUnicodeHighlights(e.toString(),r,t)))}computeDiff(e,r,t,o){return this._withSyncedResources([e,r],!0).then((i=>i.computeDiff(e.toString(),r.toString(),t,o)))}computeMoreMinimalEdits(e,r){return this._withSyncedResources([e]).then((t=>t.computeMoreMinimalEdits(e.toString(),r)))}computeLinks(e){return this._withSyncedResources([e]).then((r=>r.computeLinks(e.toString())))}textualSuggest(e,r,t){return __awaiter(this,void 0,void 0,(function*(){const o=yield this._withSyncedResources(e),i=t.source,n=regExpFlags(t);return o.textualSuggest(e.map((e=>e.toString())),r,i,n)}))}computeWordRanges(e,r){return this._withSyncedResources([e]).then((t=>{const o=this._modelService.getModel(e);if(!o)return Promise.resolve(null);const i=this.languageConfigurationService.getLanguageConfiguration(o.getLanguageId()).getWordDefinition(),n=i.source,s=regExpFlags(i);return t.computeWordRanges(e.toString(),r,n,s)}))}navigateValueSet(e,r,t){return this._withSyncedResources([e]).then((o=>{const i=this._modelService.getModel(e);if(!i)return null;const n=this.languageConfigurationService.getLanguageConfiguration(i.getLanguageId()).getWordDefinition(),s=n.source,a=regExpFlags(n);return o.navigateValueSet(e.toString(),r,t,s,a)}))}dispose(){super.dispose(),this._disposed=!0}}