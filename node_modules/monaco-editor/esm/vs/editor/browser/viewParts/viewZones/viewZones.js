import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{ViewPart}from"../../view/viewPart.js";import{Position}from"../../../common/core/position.js";const invalidFunc=()=>{throw new Error("Invalid change accessor")};export class ViewZones extends ViewPart{constructor(e){super(e);const t=this._context.configuration.options,o=t.get(138);this._lineHeight=t.get(63),this._contentWidth=o.contentWidth,this._contentLeft=o.contentLeft,this.domNode=createFastDomNode(document.createElement("div")),this.domNode.setClassName("view-zones"),this.domNode.setPosition("absolute"),this.domNode.setAttribute("role","presentation"),this.domNode.setAttribute("aria-hidden","true"),this.marginDomNode=createFastDomNode(document.createElement("div")),this.marginDomNode.setClassName("margin-view-zones"),this.marginDomNode.setPosition("absolute"),this.marginDomNode.setAttribute("role","presentation"),this.marginDomNode.setAttribute("aria-hidden","true"),this._zones={}}dispose(){super.dispose(),this._zones={}}_recomputeWhitespacesProps(){const e=this._context.viewLayout.getWhitespaces(),t=new Map;for(const o of e)t.set(o.id,o);let o=!1;return this._context.viewModel.changeWhitespace((e=>{const i=Object.keys(this._zones);for(let n=0,s=i.length;n<s;n++){const s=i[n],r=this._zones[s],d=this._computeWhitespaceProps(r.delegate);r.isInHiddenArea=d.isInHiddenArea;const a=t.get(s);!a||a.afterLineNumber===d.afterViewLineNumber&&a.height===d.heightInPx||(e.changeOneWhitespace(s,d.afterViewLineNumber,d.heightInPx),this._safeCallOnComputedHeight(r.delegate,d.heightInPx),o=!0)}})),o}onConfigurationChanged(e){const t=this._context.configuration.options,o=t.get(138);return this._lineHeight=t.get(63),this._contentWidth=o.contentWidth,this._contentLeft=o.contentLeft,e.hasChanged(63)&&this._recomputeWhitespacesProps(),!0}onLineMappingChanged(e){return this._recomputeWhitespacesProps()}onLinesDeleted(e){return!0}onScrollChanged(e){return e.scrollTopChanged||e.scrollWidthChanged}onZonesChanged(e){return!0}onLinesInserted(e){return!0}_getZoneOrdinal(e){return void 0!==e.afterColumn?e.afterColumn:1e4}_computeWhitespaceProps(e){if(0===e.afterLineNumber)return{isInHiddenArea:!1,afterViewLineNumber:0,heightInPx:this._heightInPixels(e),minWidthInPx:this._minWidthInPixels(e)};let t,o;if(void 0!==e.afterColumn)t=this._context.viewModel.model.validatePosition({lineNumber:e.afterLineNumber,column:e.afterColumn});else{const o=this._context.viewModel.model.validatePosition({lineNumber:e.afterLineNumber,column:1}).lineNumber;t=new Position(o,this._context.viewModel.model.getLineMaxColumn(o))}o=t.column===this._context.viewModel.model.getLineMaxColumn(t.lineNumber)?this._context.viewModel.model.validatePosition({lineNumber:t.lineNumber+1,column:1}):this._context.viewModel.model.validatePosition({lineNumber:t.lineNumber,column:t.column+1});const i=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(t,e.afterColumnAffinity),n=this._context.viewModel.coordinatesConverter.modelPositionIsVisible(o);return{isInHiddenArea:!n,afterViewLineNumber:i.lineNumber,heightInPx:n?this._heightInPixels(e):0,minWidthInPx:this._minWidthInPixels(e)}}changeViewZones(e){let t=!1;return this._context.viewModel.changeWhitespace((o=>{const i={addZone:e=>(t=!0,this._addZone(o,e)),removeZone:e=>{e&&(t=this._removeZone(o,e)||t)},layoutZone:e=>{e&&(t=this._layoutZone(o,e)||t)}};safeInvoke1Arg(e,i),i.addZone=invalidFunc,i.removeZone=invalidFunc,i.layoutZone=invalidFunc})),t}_addZone(e,t){const o=this._computeWhitespaceProps(t),i={whitespaceId:e.insertWhitespace(o.afterViewLineNumber,this._getZoneOrdinal(t),o.heightInPx,o.minWidthInPx),delegate:t,isInHiddenArea:o.isInHiddenArea,isVisible:!1,domNode:createFastDomNode(t.domNode),marginDomNode:t.marginDomNode?createFastDomNode(t.marginDomNode):null};return this._safeCallOnComputedHeight(i.delegate,o.heightInPx),i.domNode.setPosition("absolute"),i.domNode.domNode.style.width="100%",i.domNode.setDisplay("none"),i.domNode.setAttribute("monaco-view-zone",i.whitespaceId),this.domNode.appendChild(i.domNode),i.marginDomNode&&(i.marginDomNode.setPosition("absolute"),i.marginDomNode.domNode.style.width="100%",i.marginDomNode.setDisplay("none"),i.marginDomNode.setAttribute("monaco-view-zone",i.whitespaceId),this.marginDomNode.appendChild(i.marginDomNode)),this._zones[i.whitespaceId]=i,this.setShouldRender(),i.whitespaceId}_removeZone(e,t){if(this._zones.hasOwnProperty(t)){const o=this._zones[t];return delete this._zones[t],e.removeWhitespace(o.whitespaceId),o.domNode.removeAttribute("monaco-visible-view-zone"),o.domNode.removeAttribute("monaco-view-zone"),o.domNode.domNode.parentNode.removeChild(o.domNode.domNode),o.marginDomNode&&(o.marginDomNode.removeAttribute("monaco-visible-view-zone"),o.marginDomNode.removeAttribute("monaco-view-zone"),o.marginDomNode.domNode.parentNode.removeChild(o.marginDomNode.domNode)),this.setShouldRender(),!0}return!1}_layoutZone(e,t){if(this._zones.hasOwnProperty(t)){const o=this._zones[t],i=this._computeWhitespaceProps(o.delegate);return o.isInHiddenArea=i.isInHiddenArea,e.changeOneWhitespace(o.whitespaceId,i.afterViewLineNumber,i.heightInPx),this._safeCallOnComputedHeight(o.delegate,i.heightInPx),this.setShouldRender(),!0}return!1}shouldSuppressMouseDownOnViewZone(e){if(this._zones.hasOwnProperty(e)){const t=this._zones[e];return Boolean(t.delegate.suppressMouseDown)}return!1}_heightInPixels(e){return"number"==typeof e.heightInPx?e.heightInPx:"number"==typeof e.heightInLines?this._lineHeight*e.heightInLines:this._lineHeight}_minWidthInPixels(e){return"number"==typeof e.minWidthInPx?e.minWidthInPx:0}_safeCallOnComputedHeight(e,t){if("function"==typeof e.onComputedHeight)try{e.onComputedHeight(t)}catch(e){onUnexpectedError(e)}}_safeCallOnDomNodeTop(e,t){if("function"==typeof e.onDomNodeTop)try{e.onDomNodeTop(t)}catch(e){onUnexpectedError(e)}}prepareRender(e){}render(e){const t=e.viewportData.whitespaceViewportData,o={};let i=!1;for(const e of t)this._zones[e.id].isInHiddenArea||(o[e.id]=e,i=!0);const n=Object.keys(this._zones);for(let t=0,i=n.length;t<i;t++){const i=n[t],s=this._zones[i];let r=0,d=0,a="none";o.hasOwnProperty(i)?(r=o[i].verticalOffset-e.bigNumbersDelta,d=o[i].height,a="block",s.isVisible||(s.domNode.setAttribute("monaco-visible-view-zone","true"),s.isVisible=!0),this._safeCallOnDomNodeTop(s.delegate,e.getScrolledTopFromAbsoluteTop(o[i].verticalOffset))):(s.isVisible&&(s.domNode.removeAttribute("monaco-visible-view-zone"),s.isVisible=!1),this._safeCallOnDomNodeTop(s.delegate,e.getScrolledTopFromAbsoluteTop(-1e6))),s.domNode.setTop(r),s.domNode.setHeight(d),s.domNode.setDisplay(a),s.marginDomNode&&(s.marginDomNode.setTop(r),s.marginDomNode.setHeight(d),s.marginDomNode.setDisplay(a))}i&&(this.domNode.setWidth(Math.max(e.scrollWidth,this._contentWidth)),this.marginDomNode.setWidth(this._contentLeft))}}function safeInvoke1Arg(e,t){try{return e(t)}catch(e){onUnexpectedError(e)}}