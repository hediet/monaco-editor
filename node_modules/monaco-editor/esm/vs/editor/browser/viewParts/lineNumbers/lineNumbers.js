import"./lineNumbers.css";import*as platform from"../../../../base/common/platform.js";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{Position}from"../../../common/core/position.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{editorDimmedLineNumber,editorLineNumbers}from"../../../common/core/editorColorRegistry.js";class LineNumbersOverlay extends DynamicViewOverlay{constructor(e){super(),this._context=e,this._readConfig(),this._lastCursorModelPosition=new Position(1,1),this._renderResult=null,this._activeLineNumber=1,this._context.addEventHandler(this)}_readConfig(){const e=this._context.configuration.options;this._lineHeight=e.get(63);const i=e.get(64);this._renderLineNumbers=i.renderType,this._renderCustomLineNumbers=i.renderFn,this._renderFinalNewline=e.get(89);const n=e.get(138);this._lineNumbersLeft=n.lineNumbersLeft,this._lineNumbersWidth=n.lineNumbersWidth}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){return this._readConfig(),!0}onCursorStateChanged(e){const i=e.selections[0].getPosition();this._lastCursorModelPosition=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(i);let n=!1;return this._activeLineNumber!==i.lineNumber&&(this._activeLineNumber=i.lineNumber,n=!0),2!==this._renderLineNumbers&&3!==this._renderLineNumbers||(n=!0),n}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}_getLineRenderLineNumber(e){const i=this._context.viewModel.coordinatesConverter.convertViewPositionToModelPosition(new Position(e,1));if(1!==i.column)return"";const n=i.lineNumber;if(this._renderCustomLineNumbers)return this._renderCustomLineNumbers(n);if(2===this._renderLineNumbers){const e=Math.abs(this._lastCursorModelPosition.lineNumber-n);return 0===e?'<span class="relative-current-line-number">'+n+"</span>":String(e)}return 3===this._renderLineNumbers?this._lastCursorModelPosition.lineNumber===n||n%10==0?String(n):"":String(n)}prepareRender(e){if(0===this._renderLineNumbers)return void(this._renderResult=null);const i=platform.isLinux?this._lineHeight%2==0?" lh-even":" lh-odd":"",n=e.visibleRange.startLineNumber,r=e.visibleRange.endLineNumber,t=this._context.viewModel.getLineCount(),s=[];for(let e=n;e<=r;e++){const r=e-n,o=this._getLineRenderLineNumber(e);if(!o){s[r]="";continue}let l="";if(e===t&&0===this._context.viewModel.getLineLength(e)){if("off"===this._renderFinalNewline){s[r]="";continue}"dimmed"===this._renderFinalNewline&&(l=" dimmed-line-number")}e===this._activeLineNumber&&(l=" active-line-number"),s[r]=`<div class="${LineNumbersOverlay.CLASS_NAME}${i}${l}" style="left:${this._lineNumbersLeft}px;width:${this._lineNumbersWidth}px;">${o}</div>`}this._renderResult=s}render(e,i){if(!this._renderResult)return"";const n=i-e;return n<0||n>=this._renderResult.length?"":this._renderResult[n]}}LineNumbersOverlay.CLASS_NAME="line-numbers";export{LineNumbersOverlay};registerThemingParticipant(((e,i)=>{const n=e.getColor(editorLineNumbers),r=e.getColor(editorDimmedLineNumber);r?i.addRule(`.monaco-editor .line-numbers.dimmed-line-number { color: ${r}; }`):n&&i.addRule(`.monaco-editor .line-numbers.dimmed-line-number { color: ${n.transparent(.4)}; }`)}));