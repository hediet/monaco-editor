import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{Color}from"../../../../base/common/color.js";import{ViewPart}from"../../view/viewPart.js";import{Position}from"../../../common/core/position.js";import{TokenizationRegistry}from"../../../common/languages.js";import{editorCursorForeground,editorOverviewRulerBorder,editorOverviewRulerBackground}from"../../../common/core/editorColorRegistry.js";import{OverviewRulerDecorationsGroup}from"../../../common/viewModel.js";class Settings{constructor(t,e){const o=t.options;this.lineHeight=o.get(63),this.pixelRatio=o.get(136),this.overviewRulerLanes=o.get(79),this.renderBorder=o.get(78);const i=e.getColor(editorOverviewRulerBorder);this.borderColor=i?i.toString():null,this.hideCursor=o.get(56);const s=e.getColor(editorCursorForeground);this.cursorColor=s?s.transparent(.7).toString():null,this.themeType=e.type;const r=o.get(69),n=r.enabled,h=r.side,d=e.getColor(editorOverviewRulerBackground),l=TokenizationRegistry.getDefaultBackground();this.backgroundColor=d||(n&&"right"===h?l:null);const a=o.get(138).overviewRuler;this.top=a.top,this.right=a.right,this.domWidth=a.width,this.domHeight=a.height,0===this.overviewRulerLanes?(this.canvasWidth=0,this.canvasHeight=0):(this.canvasWidth=this.domWidth*this.pixelRatio|0,this.canvasHeight=this.domHeight*this.pixelRatio|0);const[g,c]=this._initLanes(1,this.canvasWidth,this.overviewRulerLanes);this.x=g,this.w=c}_initLanes(t,e,o){const i=e-t;if(o>=3){const e=Math.floor(i/3),o=Math.floor(i/3),s=i-e-o,r=t+e;return[[0,t,r,t,t+e+s,t,r,t],[0,e,s,e+s,o,e+s+o,s+o,e+s+o]]}if(2===o){const e=Math.floor(i/2),o=i-e;return[[0,t,t,t,t+e,t,t,t],[0,e,e,e,o,e+o,e+o,e+o]]}return[[0,t,t,t,t,t,t,t],[0,i,i,i,i,i,i,i]]}equals(t){return this.lineHeight===t.lineHeight&&this.pixelRatio===t.pixelRatio&&this.overviewRulerLanes===t.overviewRulerLanes&&this.renderBorder===t.renderBorder&&this.borderColor===t.borderColor&&this.hideCursor===t.hideCursor&&this.cursorColor===t.cursorColor&&this.themeType===t.themeType&&Color.equals(this.backgroundColor,t.backgroundColor)&&this.top===t.top&&this.right===t.right&&this.domWidth===t.domWidth&&this.domHeight===t.domHeight&&this.canvasWidth===t.canvasWidth&&this.canvasHeight===t.canvasHeight}}export class DecorationsOverviewRuler extends ViewPart{constructor(t){super(t),this._domNode=createFastDomNode(document.createElement("canvas")),this._domNode.setClassName("decorationsOverviewRuler"),this._domNode.setPosition("absolute"),this._domNode.setLayerHinting(!0),this._domNode.setContain("strict"),this._domNode.setAttribute("aria-hidden","true"),this._updateSettings(!1),this._tokensColorTrackerListener=TokenizationRegistry.onDidChange((t=>{t.changedColorMap&&this._updateSettings(!0)})),this._cursorPositions=[]}dispose(){super.dispose(),this._tokensColorTrackerListener.dispose()}_updateSettings(t){const e=new Settings(this._context.configuration,this._context.theme);return!(this._settings&&this._settings.equals(e)||(this._settings=e,this._domNode.setTop(this._settings.top),this._domNode.setRight(this._settings.right),this._domNode.setWidth(this._settings.domWidth),this._domNode.setHeight(this._settings.domHeight),this._domNode.domNode.width=this._settings.canvasWidth,this._domNode.domNode.height=this._settings.canvasHeight,t&&this._render(),0))}onConfigurationChanged(t){return this._updateSettings(!1)}onCursorStateChanged(t){this._cursorPositions=[];for(let e=0,o=t.selections.length;e<o;e++)this._cursorPositions[e]=t.selections[e].getPosition();return this._cursorPositions.sort(Position.compare),!0}onDecorationsChanged(t){return!!t.affectsOverviewRuler}onFlushed(t){return!0}onScrollChanged(t){return t.scrollHeightChanged}onZonesChanged(t){return!0}onThemeChanged(t){return this._updateSettings(!1)}getDomNode(){return this._domNode.domNode}prepareRender(t){}render(t){this._render()}_render(){const t=this._settings.backgroundColor;if(0===this._settings.overviewRulerLanes)return this._domNode.setBackgroundColor(t?Color.Format.CSS.formatHexA(t):""),void this._domNode.setDisplay("none");this._domNode.setDisplay("block");const e=this._settings.canvasWidth,o=this._settings.canvasHeight,i=this._settings.lineHeight,s=this._context.viewLayout,r=o/this._context.viewLayout.getScrollHeight(),n=this._context.viewModel.getAllOverviewRulerDecorations(this._context.theme),h=6*this._settings.pixelRatio|0,d=h/2|0,l=this._domNode.domNode.getContext("2d");t?t.isOpaque()?(l.fillStyle=Color.Format.CSS.formatHexA(t),l.fillRect(0,0,e,o)):(l.clearRect(0,0,e,o),l.fillStyle=Color.Format.CSS.formatHexA(t),l.fillRect(0,0,e,o)):l.clearRect(0,0,e,o);const a=this._settings.x,g=this._settings.w;n.sort(OverviewRulerDecorationsGroup.cmp);for(const t of n){const e=t.color,n=t.data;l.fillStyle=e;let c=0,u=0,m=0;for(let t=0,e=n.length/3;t<e;t++){const e=n[3*t],_=n[3*t+1],v=n[3*t+2];let C=s.getVerticalOffsetForLineNumber(_)*r|0,p=(s.getVerticalOffsetForLineNumber(v)+i)*r|0;if(p-C<h){let t=(C+p)/2|0;t<d?t=d:t+d>o&&(t=o-d),C=t-d,p=t+d}C>m+1||e!==c?(0!==t&&l.fillRect(a[c],u,g[c],m-u),c=e,u=C,m=p):p>m&&(m=p)}l.fillRect(a[c],u,g[c],m-u)}if(!this._settings.hideCursor&&this._settings.cursorColor){const t=2*this._settings.pixelRatio|0,e=t/2|0,i=this._settings.x[7],n=this._settings.w[7];l.fillStyle=this._settings.cursorColor;let h=-100,d=-100;for(let a=0,g=this._cursorPositions.length;a<g;a++){const g=this._cursorPositions[a];let c=s.getVerticalOffsetForLineNumber(g.lineNumber)*r|0;c<e?c=e:c+e>o&&(c=o-e);const u=c-e,m=u+t;u>d+1?(0!==a&&l.fillRect(i,h,n,d-h),h=u,d=m):m>d&&(d=m)}l.fillRect(i,h,n,d-h)}this._settings.renderBorder&&this._settings.borderColor&&this._settings.overviewRulerLanes>0&&(l.beginPath(),l.lineWidth=1,l.strokeStyle=this._settings.borderColor,l.moveTo(0,0),l.lineTo(0,o),l.stroke(),l.moveTo(0,0),l.lineTo(e,0),l.stroke())}}