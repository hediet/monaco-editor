import*as dom from"../../../../base/browser/dom.js";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{PartFingerprints,ViewPart}from"../../view/viewPart.js";export class ViewContentWidgets extends ViewPart{constructor(t,e){super(t),this._viewDomNode=e,this._widgets={},this.domNode=createFastDomNode(document.createElement("div")),PartFingerprints.write(this.domNode,1),this.domNode.setClassName("contentWidgets"),this.domNode.setPosition("absolute"),this.domNode.setTop(0),this.overflowingContentWidgetsDomNode=createFastDomNode(document.createElement("div")),PartFingerprints.write(this.overflowingContentWidgetsDomNode,2),this.overflowingContentWidgetsDomNode.setClassName("overflowingContentWidgets")}dispose(){super.dispose(),this._widgets={}}onConfigurationChanged(t){const e=Object.keys(this._widgets);for(const i of e)this._widgets[i].onConfigurationChanged(t);return!0}onDecorationsChanged(t){return!0}onFlushed(t){return!0}onLineMappingChanged(t){return this._updateAnchorsViewPositions(),!0}onLinesChanged(t){return this._updateAnchorsViewPositions(),!0}onLinesDeleted(t){return this._updateAnchorsViewPositions(),!0}onLinesInserted(t){return this._updateAnchorsViewPositions(),!0}onScrollChanged(t){return!0}onZonesChanged(t){return!0}_updateAnchorsViewPositions(){const t=Object.keys(this._widgets);for(const e of t)this._widgets[e].updateAnchorViewPosition()}addWidget(t){const e=new Widget(this._context,this._viewDomNode,t);this._widgets[e.id]=e,e.allowEditorOverflow?this.overflowingContentWidgetsDomNode.appendChild(e.domNode):this.domNode.appendChild(e.domNode),this.setShouldRender()}setWidgetPosition(t,e,i,o,s){this._widgets[t.getId()].setPosition(e,i,o,s),this.setShouldRender()}removeWidget(t){const e=t.getId();if(this._widgets.hasOwnProperty(e)){const t=this._widgets[e];delete this._widgets[e];const i=t.domNode.domNode;i.parentNode.removeChild(i),i.removeAttribute("monaco-visible-content-widget"),this.setShouldRender()}}shouldSuppressMouseDownOnWidget(t){return!!this._widgets.hasOwnProperty(t)&&this._widgets[t].suppressMouseDown}onBeforeRender(t){const e=Object.keys(this._widgets);for(const i of e)this._widgets[i].onBeforeRender(t)}prepareRender(t){const e=Object.keys(this._widgets);for(const i of e)this._widgets[i].prepareRender(t)}render(t){const e=Object.keys(this._widgets);for(const i of e)this._widgets[i].render(t)}}class Widget{constructor(t,e,i){this._primaryAnchor=new PositionPair(null,null),this._secondaryAnchor=new PositionPair(null,null),this._context=t,this._viewDomNode=e,this._actual=i,this.domNode=createFastDomNode(this._actual.getDomNode()),this.id=this._actual.getId(),this.allowEditorOverflow=this._actual.allowEditorOverflow||!1,this.suppressMouseDown=this._actual.suppressMouseDown||!1;const o=this._context.configuration.options,s=o.get(138);this._fixedOverflowWidgets=o.get(39),this._contentWidth=s.contentWidth,this._contentLeft=s.contentLeft,this._lineHeight=o.get(63),this._affinity=null,this._preference=[],this._cachedDomNodeOffsetWidth=-1,this._cachedDomNodeOffsetHeight=-1,this._maxWidth=this._getMaxWidth(),this._isVisible=!1,this._renderData=null,this.domNode.setPosition(this._fixedOverflowWidgets&&this.allowEditorOverflow?"fixed":"absolute"),this.domNode.setDisplay("none"),this.domNode.setVisibility("hidden"),this.domNode.setAttribute("widgetId",this.id),this.domNode.setMaxWidth(this._maxWidth)}onConfigurationChanged(t){const e=this._context.configuration.options;if(this._lineHeight=e.get(63),t.hasChanged(138)){const t=e.get(138);this._contentLeft=t.contentLeft,this._contentWidth=t.contentWidth,this._maxWidth=this._getMaxWidth()}}updateAnchorViewPosition(){this._setPosition(this._affinity,this._primaryAnchor.modelPosition,this._secondaryAnchor.modelPosition)}_setPosition(t,e,i){function o(t,e,i){if(!t)return new PositionPair(null,null);const o=e.model.validatePosition(t);if(e.coordinatesConverter.modelPositionIsVisible(o)){const s=e.coordinatesConverter.convertModelPositionToViewPosition(o,null!=i?i:void 0);return new PositionPair(t,s)}return new PositionPair(t,null)}this._affinity=t,this._primaryAnchor=o(e,this._context.viewModel,this._affinity),this._secondaryAnchor=o(i,this._context.viewModel,this._affinity)}_getMaxWidth(){return this.allowEditorOverflow?window.innerWidth||document.documentElement.offsetWidth||document.body.offsetWidth:this._contentWidth}setPosition(t,e,i,o){this._setPosition(o,t,e),this._preference=i,this._primaryAnchor.viewPosition&&this._preference&&this._preference.length>0?this.domNode.setDisplay("block"):this.domNode.setDisplay("none"),this._cachedDomNodeOffsetWidth=-1,this._cachedDomNodeOffsetHeight=-1}_layoutBoxInViewport(t,e,i,o){const s=t.top,n=s,r=t.top+t.height,d=s-i,h=n>=i,a=r,l=o.viewportHeight-r>=i;let c=t.left;return c+e>o.scrollLeft+o.viewportWidth&&(c=o.scrollLeft+o.viewportWidth-e),c<o.scrollLeft&&(c=o.scrollLeft),{fitsAbove:h,aboveTop:d,fitsBelow:l,belowTop:a,left:c}}_layoutHorizontalSegmentInPage(t,e,i,o){const s=Math.max(15,e.left-o),n=Math.min(e.left+e.width+o,t.width-15);let r=e.left+i-window.scrollX;if(r+o>n){const t=r-(n-o);r-=t,i-=t}if(r<s){const t=r-s;r-=t,i-=t}return[i,r]}_layoutBoxInPage(t,e,i,o){const s=t.top-i,n=t.top+t.height,r=dom.getDomNodePagePosition(this._viewDomNode.domNode),d=r.top+s-window.scrollY,h=r.top+n-window.scrollY,a=dom.getClientArea(document.body),[l,c]=this._layoutHorizontalSegmentInPage(a,r,t.left-o.scrollLeft+this._contentLeft,e),f=d>=22,u=h+i<=a.height-22;return this._fixedOverflowWidgets?{fitsAbove:f,aboveTop:Math.max(d,22),fitsBelow:u,belowTop:h,left:c}:{fitsAbove:f,aboveTop:s,fitsBelow:u,belowTop:n,left:l}}_prepareRenderWidgetAtExactPositionOverflowing(t){return new Coordinate(t.top,t.left+this._contentLeft)}_getAnchorsCoordinates(t){var e,i;return{primary:o(this._primaryAnchor.viewPosition,this._affinity,this._lineHeight),secondary:o((null===(e=this._secondaryAnchor.viewPosition)||void 0===e?void 0:e.lineNumber)===(null===(i=this._primaryAnchor.viewPosition)||void 0===i?void 0:i.lineNumber)?this._secondaryAnchor.viewPosition:null,this._affinity,this._lineHeight)};function o(e,i,o){if(!e)return null;const s=t.visibleRangeForPosition(e);if(!s)return null;const n=1===e.column&&3===i?0:s.left,r=t.getVerticalOffsetForLineNumber(e.lineNumber)-t.scrollTop;return new AnchorCoordinate(r,n,o)}}_reduceAnchorCoordinates(t,e,i){if(!e)return t;const o=this._context.configuration.options.get(47);let s=e.left;return s=s<t.left?Math.max(s,t.left-i+o.typicalFullwidthCharacterWidth):Math.min(s,t.left+i-o.typicalFullwidthCharacterWidth),new AnchorCoordinate(t.top,s,t.height)}_prepareRenderWidget(t){if(!this._preference||0===this._preference.length)return null;const{primary:e,secondary:i}=this._getAnchorsCoordinates(t);if(!e)return null;if(-1===this._cachedDomNodeOffsetWidth||-1===this._cachedDomNodeOffsetHeight){let t=null;if("function"==typeof this._actual.beforeRender&&(t=safeInvoke(this._actual.beforeRender,this._actual)),t)this._cachedDomNodeOffsetWidth=t.width,this._cachedDomNodeOffsetHeight=t.height;else{const t=this.domNode.domNode.getBoundingClientRect();this._cachedDomNodeOffsetWidth=Math.round(t.width),this._cachedDomNodeOffsetHeight=Math.round(t.height)}}const o=this._reduceAnchorCoordinates(e,i,this._cachedDomNodeOffsetWidth);let s;s=this.allowEditorOverflow?this._layoutBoxInPage(o,this._cachedDomNodeOffsetWidth,this._cachedDomNodeOffsetHeight,t):this._layoutBoxInViewport(o,this._cachedDomNodeOffsetWidth,this._cachedDomNodeOffsetHeight,t);for(let t=1;t<=2;t++)for(const e of this._preference)if(1===e){if(!s)return null;if(2===t||s.fitsAbove)return{coordinate:new Coordinate(s.aboveTop,s.left),position:1}}else{if(2!==e)return this.allowEditorOverflow?{coordinate:this._prepareRenderWidgetAtExactPositionOverflowing(new Coordinate(o.top,o.left)),position:0}:{coordinate:new Coordinate(o.top,o.left),position:0};if(!s)return null;if(2===t||s.fitsBelow)return{coordinate:new Coordinate(s.belowTop,s.left),position:2}}return null}onBeforeRender(t){this._primaryAnchor.viewPosition&&this._preference&&(this._primaryAnchor.viewPosition.lineNumber<t.startLineNumber||this._primaryAnchor.viewPosition.lineNumber>t.endLineNumber||this.domNode.setMaxWidth(this._maxWidth))}prepareRender(t){this._renderData=this._prepareRenderWidget(t)}render(t){if(!this._renderData)return this._isVisible&&(this.domNode.removeAttribute("monaco-visible-content-widget"),this._isVisible=!1,this.domNode.setVisibility("hidden")),void("function"==typeof this._actual.afterRender&&safeInvoke(this._actual.afterRender,this._actual,null));this.allowEditorOverflow?(this.domNode.setTop(this._renderData.coordinate.top),this.domNode.setLeft(this._renderData.coordinate.left)):(this.domNode.setTop(this._renderData.coordinate.top+t.scrollTop-t.bigNumbersDelta),this.domNode.setLeft(this._renderData.coordinate.left)),this._isVisible||(this.domNode.setVisibility("inherit"),this.domNode.setAttribute("monaco-visible-content-widget","true"),this._isVisible=!0),"function"==typeof this._actual.afterRender&&safeInvoke(this._actual.afterRender,this._actual,this._renderData.position)}}class PositionPair{constructor(t,e){this.modelPosition=t,this.viewPosition=e}}class Coordinate{constructor(t,e){this.top=t,this.left=e,this._coordinateBrand=void 0}}class AnchorCoordinate{constructor(t,e,i){this.top=t,this.left=e,this.height=i,this._anchorCoordinateBrand=void 0}}function safeInvoke(t,e,...i){try{return t.call(e,...i)}catch(t){return null}}