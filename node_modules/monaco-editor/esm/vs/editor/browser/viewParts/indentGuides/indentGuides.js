import"./indentGuides.css";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{editorBracketHighlightingForeground1,editorBracketHighlightingForeground2,editorBracketHighlightingForeground3,editorBracketHighlightingForeground4,editorBracketHighlightingForeground5,editorBracketHighlightingForeground6,editorBracketPairGuideActiveBackground1,editorBracketPairGuideActiveBackground2,editorBracketPairGuideActiveBackground3,editorBracketPairGuideActiveBackground4,editorBracketPairGuideActiveBackground5,editorBracketPairGuideActiveBackground6,editorBracketPairGuideBackground1,editorBracketPairGuideBackground2,editorBracketPairGuideBackground3,editorBracketPairGuideBackground4,editorBracketPairGuideBackground5,editorBracketPairGuideBackground6}from"../../../common/core/editorColorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{Position}from"../../../common/core/position.js";import{ArrayQueue}from"../../../../base/common/arrays.js";import{isDefined}from"../../../../base/common/types.js";import{BracketPairGuidesClassNames}from"../../../common/model/guidesTextModelPart.js";import{IndentGuide,HorizontalGuidesState}from"../../../common/textModelGuides.js";export class IndentGuidesOverlay extends DynamicViewOverlay{constructor(e){super(),this._context=e,this._primaryPosition=null;const i=this._context.configuration.options,t=i.get(139),o=i.get(47);this._lineHeight=i.get(63),this._spaceWidth=o.spaceWidth,this._maxIndentLeft=-1===t.wrappingColumn?-1:t.wrappingColumn*o.typicalHalfwidthCharacterWidth,this._bracketPairGuideOptions=i.get(13),this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const i=this._context.configuration.options,t=i.get(139),o=i.get(47);return this._lineHeight=i.get(63),this._spaceWidth=o.spaceWidth,this._maxIndentLeft=-1===t.wrappingColumn?-1:t.wrappingColumn*o.typicalHalfwidthCharacterWidth,this._bracketPairGuideOptions=i.get(13),!0}onCursorStateChanged(e){var i;const t=e.selections[0].getPosition();return!(null===(i=this._primaryPosition)||void 0===i?void 0:i.equals(t))&&(this._primaryPosition=t,!0)}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}onLanguageConfigurationChanged(e){return!0}prepareRender(e){var i,t,o,r;if(!this._bracketPairGuideOptions.indentation&&!1===this._bracketPairGuideOptions.bracketPairs)return void(this._renderResult=null);const n=e.visibleRange.startLineNumber,a=e.visibleRange.endLineNumber,d=e.scrollWidth,s=this._lineHeight,c=this._primaryPosition,l=this.getGuidesByLine(n,Math.min(a+1,this._context.viewModel.getLineCount()),c),u=[];for(let c=n;c<=a;c++){const a=c-n,g=l[a];let h="";const k=null!==(t=null===(i=e.visibleRangeForPosition(new Position(c,1)))||void 0===i?void 0:i.left)&&void 0!==t?t:0;for(const i of g){const t=-1===i.column?k+(i.visibleColumn-1)*this._spaceWidth:e.visibleRangeForPosition(new Position(c,i.column)).left;if(t>d||this._maxIndentLeft>0&&t>this._maxIndentLeft)break;const n=i.horizontalLine?i.horizontalLine.top?"horizontal-top":"horizontal-bottom":"vertical",a=i.horizontalLine?(null!==(r=null===(o=e.visibleRangeForPosition(new Position(c,i.horizontalLine.endColumn)))||void 0===o?void 0:o.left)&&void 0!==r?r:t+this._spaceWidth)-t:this._spaceWidth;h+=`<div class="core-guide ${i.className} ${n}" style="left:${t}px;height:${s}px;width:${a}px"></div>`}u[a]=h}this._renderResult=u}getGuidesByLine(e,i,t){const o=!1!==this._bracketPairGuideOptions.bracketPairs?this._context.viewModel.getBracketGuidesInRangeByLine(e,i,t,{highlightActive:this._bracketPairGuideOptions.highlightActiveBracketPair,horizontalGuides:!0===this._bracketPairGuideOptions.bracketPairsHorizontal?HorizontalGuidesState.Enabled:"active"===this._bracketPairGuideOptions.bracketPairsHorizontal?HorizontalGuidesState.EnabledForActive:HorizontalGuidesState.Disabled,includeInactive:!0===this._bracketPairGuideOptions.bracketPairs}):null,r=this._bracketPairGuideOptions.indentation?this._context.viewModel.getLinesIndentGuides(e,i):null;let n=0,a=0,d=0;if(!1!==this._bracketPairGuideOptions.highlightActiveIndentation&&t){const o=this._context.viewModel.getActiveIndentGuide(t.lineNumber,e,i);n=o.startLineNumber,a=o.endLineNumber,d=o.indent}const{indentSize:s}=this._context.viewModel.model.getOptions(),c=[];for(let t=e;t<=i;t++){const i=new Array;c.push(i);const l=o?o[t-e]:[],u=new ArrayQueue(l),g=r?r[t-e]:0;for(let e=1;e<=g;e++){const o=(e-1)*s+1,r=("always"===this._bracketPairGuideOptions.highlightActiveIndentation||0===l.length)&&n<=t&&t<=a&&e===d;i.push(...u.takeWhile((e=>e.visibleColumn<o))||[]);const c=u.peek();c&&c.visibleColumn===o&&!c.horizontalLine||i.push(new IndentGuide(o,-1,r?"core-guide-indent-active":"core-guide-indent",null,-1,-1))}i.push(...u.takeWhile((e=>!0))||[])}return c}render(e,i){if(!this._renderResult)return"";const t=i-e;return t<0||t>=this._renderResult.length?"":this._renderResult[t]}}function transparentToUndefined(e){if(!e||!e.isTransparent())return e}registerThemingParticipant(((e,i)=>{const t=[{bracketColor:editorBracketHighlightingForeground1,guideColor:editorBracketPairGuideBackground1,guideColorActive:editorBracketPairGuideActiveBackground1},{bracketColor:editorBracketHighlightingForeground2,guideColor:editorBracketPairGuideBackground2,guideColorActive:editorBracketPairGuideActiveBackground2},{bracketColor:editorBracketHighlightingForeground3,guideColor:editorBracketPairGuideBackground3,guideColorActive:editorBracketPairGuideActiveBackground3},{bracketColor:editorBracketHighlightingForeground4,guideColor:editorBracketPairGuideBackground4,guideColorActive:editorBracketPairGuideActiveBackground4},{bracketColor:editorBracketHighlightingForeground5,guideColor:editorBracketPairGuideBackground5,guideColorActive:editorBracketPairGuideActiveBackground5},{bracketColor:editorBracketHighlightingForeground6,guideColor:editorBracketPairGuideBackground6,guideColorActive:editorBracketPairGuideActiveBackground6}],o=new BracketPairGuidesClassNames,r=t.map((i=>{var t,o;const r=e.getColor(i.bracketColor),n=e.getColor(i.guideColor),a=e.getColor(i.guideColorActive),d=transparentToUndefined(null!==(t=transparentToUndefined(n))&&void 0!==t?t:null==r?void 0:r.transparent(.3)),s=transparentToUndefined(null!==(o=transparentToUndefined(a))&&void 0!==o?o:r);if(d&&s)return{guideColor:d,guideColorActive:s}})).filter(isDefined);if(r.length>0){for(let e=0;e<30;e++){const t=r[e%r.length];i.addRule(`.monaco-editor .${o.getInlineClassNameOfLevel(e).replace(/ /g,".")} { --guide-color: ${t.guideColor}; --guide-color-active: ${t.guideColorActive}; }`)}i.addRule(".monaco-editor .vertical { box-shadow: 1px 0 0 0 var(--guide-color) inset; }"),i.addRule(".monaco-editor .horizontal-top { border-top: 1px solid var(--guide-color); }"),i.addRule(".monaco-editor .horizontal-bottom { border-bottom: 1px solid var(--guide-color); }"),i.addRule(`.monaco-editor .vertical.${o.activeClassName} { box-shadow: 1px 0 0 0 var(--guide-color-active) inset; }`),i.addRule(`.monaco-editor .horizontal-top.${o.activeClassName} { border-top: 1px solid var(--guide-color-active); }`),i.addRule(`.monaco-editor .horizontal-bottom.${o.activeClassName} { border-bottom: 1px solid var(--guide-color-active); }`)}}));