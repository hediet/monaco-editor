import"./selections.css";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import{editorSelectionForeground}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";class HorizontalRangeWithStyle{constructor(e){this.left=e.left,this.width=e.width,this.startStyle=null,this.endStyle=null}}class LineVisibleRangesWithStyle{constructor(e,t){this.lineNumber=e,this.ranges=t}}function toStyledRange(e){return new HorizontalRangeWithStyle(e)}function toStyled(e){return new LineVisibleRangesWithStyle(e.lineNumber,e.ranges.map(toStyledRange))}class SelectionsOverlay extends DynamicViewOverlay{constructor(e){super(),this._previousFrameVisibleRangesWithStyle=[],this._context=e;const t=this._context.configuration.options;this._lineHeight=t.get(63),this._roundedSelection=t.get(95),this._typicalHalfwidthCharacterWidth=t.get(47).typicalHalfwidthCharacterWidth,this._selections=[],this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const t=this._context.configuration.options;return this._lineHeight=t.get(63),this._roundedSelection=t.get(95),this._typicalHalfwidthCharacterWidth=t.get(47).typicalHalfwidthCharacterWidth,!0}onCursorStateChanged(e){return this._selections=e.selections.slice(0),!0}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}_visibleRangesHaveGaps(e){for(let t=0,i=e.length;t<i;t++)if(e[t].ranges.length>1)return!0;return!1}_enrichVisibleRangesWithStyle(e,t,i){const n=this._typicalHalfwidthCharacterWidth/4;let l=null,s=null;if(i&&i.length>0&&t.length>0){const n=t[0].lineNumber;if(n===e.startLineNumber)for(let e=0;!l&&e<i.length;e++)i[e].lineNumber===n&&(l=i[e].ranges[0]);const r=t[t.length-1].lineNumber;if(r===e.endLineNumber)for(let e=i.length-1;!s&&e>=0;e--)i[e].lineNumber===r&&(s=i[e].ranges[0]);l&&!l.startStyle&&(l=null),s&&!s.startStyle&&(s=null)}for(let e=0,i=t.length;e<i;e++){const r=t[e].ranges[0],o=r.left,a=r.left+r.width,c={top:0,bottom:0},h={top:0,bottom:0};if(e>0){const i=t[e-1].ranges[0].left,l=t[e-1].ranges[0].left+t[e-1].ranges[0].width;abs(o-i)<n?c.top=2:o>i&&(c.top=1),abs(a-l)<n?h.top=2:i<a&&a<l&&(h.top=1)}else l&&(c.top=l.startStyle.top,h.top=l.endStyle.top);if(e+1<i){const i=t[e+1].ranges[0].left,l=t[e+1].ranges[0].left+t[e+1].ranges[0].width;abs(o-i)<n?c.bottom=2:i<o&&o<l&&(c.bottom=1),abs(a-l)<n?h.bottom=2:a<l&&(h.bottom=1)}else s&&(c.bottom=s.startStyle.bottom,h.bottom=s.endStyle.bottom);r.startStyle=c,r.endStyle=h}}_getVisibleRangesWithStyle(e,t,i){const n=(t.linesVisibleRangesForRange(e,!0)||[]).map(toStyled);return!this._visibleRangesHaveGaps(n)&&this._roundedSelection&&this._enrichVisibleRangesWithStyle(t.visibleRange,n,i),n}_createSelectionPiece(e,t,i,n,l){return'<div class="cslr '+i+'" style="top:'+e.toString()+"px;left:"+n.toString()+"px;width:"+l.toString()+"px;height:"+t+'px;"></div>'}_actualRenderOneSelection(e,t,i,n){if(0===n.length)return;const l=!!n[0].ranges[0].startStyle,s=this._lineHeight.toString(),r=(this._lineHeight-1).toString(),o=n[0].lineNumber,a=n[n.length-1].lineNumber;for(let c=0,h=n.length;c<h;c++){const h=n[c],S=h.lineNumber,_=S-t,g=!i||S!==a&&S!==o?s:r,d=i&&S===o?1:0;let O="",u="";for(let e=0,t=h.ranges.length;e<t;e++){const t=h.ranges[e];if(l){const e=t.startStyle,i=t.endStyle;if(1===e.top||1===e.bottom){O+=this._createSelectionPiece(d,g,SelectionsOverlay.SELECTION_CLASS_NAME,t.left-SelectionsOverlay.ROUNDED_PIECE_WIDTH,SelectionsOverlay.ROUNDED_PIECE_WIDTH);let i=SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;1===e.top&&(i+=" "+SelectionsOverlay.SELECTION_TOP_RIGHT),1===e.bottom&&(i+=" "+SelectionsOverlay.SELECTION_BOTTOM_RIGHT),O+=this._createSelectionPiece(d,g,i,t.left-SelectionsOverlay.ROUNDED_PIECE_WIDTH,SelectionsOverlay.ROUNDED_PIECE_WIDTH)}if(1===i.top||1===i.bottom){O+=this._createSelectionPiece(d,g,SelectionsOverlay.SELECTION_CLASS_NAME,t.left+t.width,SelectionsOverlay.ROUNDED_PIECE_WIDTH);let e=SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME;1===i.top&&(e+=" "+SelectionsOverlay.SELECTION_TOP_LEFT),1===i.bottom&&(e+=" "+SelectionsOverlay.SELECTION_BOTTOM_LEFT),O+=this._createSelectionPiece(d,g,e,t.left+t.width,SelectionsOverlay.ROUNDED_PIECE_WIDTH)}}let i=SelectionsOverlay.SELECTION_CLASS_NAME;if(l){const e=t.startStyle,n=t.endStyle;0===e.top&&(i+=" "+SelectionsOverlay.SELECTION_TOP_LEFT),0===e.bottom&&(i+=" "+SelectionsOverlay.SELECTION_BOTTOM_LEFT),0===n.top&&(i+=" "+SelectionsOverlay.SELECTION_TOP_RIGHT),0===n.bottom&&(i+=" "+SelectionsOverlay.SELECTION_BOTTOM_RIGHT)}u+=this._createSelectionPiece(d,g,i,t.left,t.width)}e[_][0]+=O,e[_][1]+=u}}prepareRender(e){const t=[],i=e.visibleRange.startLineNumber,n=e.visibleRange.endLineNumber;for(let e=i;e<=n;e++)t[e-i]=["",""];const l=[];for(let n=0,s=this._selections.length;n<s;n++){const s=this._selections[n];if(s.isEmpty()){l[n]=null;continue}const r=this._getVisibleRangesWithStyle(s,e,this._previousFrameVisibleRangesWithStyle[n]);l[n]=r,this._actualRenderOneSelection(t,i,this._selections.length>1,r)}this._previousFrameVisibleRangesWithStyle=l,this._renderResult=t.map((([e,t])=>e+t))}render(e,t){if(!this._renderResult)return"";const i=t-e;return i<0||i>=this._renderResult.length?"":this._renderResult[i]}}SelectionsOverlay.SELECTION_CLASS_NAME="selected-text",SelectionsOverlay.SELECTION_TOP_LEFT="top-left-radius",SelectionsOverlay.SELECTION_BOTTOM_LEFT="bottom-left-radius",SelectionsOverlay.SELECTION_TOP_RIGHT="top-right-radius",SelectionsOverlay.SELECTION_BOTTOM_RIGHT="bottom-right-radius",SelectionsOverlay.EDITOR_BACKGROUND_CLASS_NAME="monaco-editor-background",SelectionsOverlay.ROUNDED_PIECE_WIDTH=10;export{SelectionsOverlay};function abs(e){return e<0?-e:e}registerThemingParticipant(((e,t)=>{const i=e.getColor(editorSelectionForeground);i&&!i.isTransparent()&&t.addRule(`.monaco-editor .view-line span.inline-selected-text { color: ${i}; }`)}));