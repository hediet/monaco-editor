import"./whitespace.css";import{DynamicViewOverlay}from"../../view/dynamicViewOverlay.js";import*as strings from"../../../../base/common/strings.js";import{LineRange}from"../../../common/viewLayout/viewLineRenderer.js";import{Position}from"../../../common/core/position.js";import{editorWhitespaces}from"../../../common/core/editorColorRegistry.js";export class WhitespaceOverlay extends DynamicViewOverlay{constructor(e){super(),this._context=e,this._options=new WhitespaceOptions(this._context.configuration),this._selection=[],this._renderResult=null,this._context.addEventHandler(this)}dispose(){this._context.removeEventHandler(this),this._renderResult=null,super.dispose()}onConfigurationChanged(e){const t=new WhitespaceOptions(this._context.configuration);return this._options.equals(t)?e.hasChanged(138):(this._options=t,!0)}onCursorStateChanged(e){return this._selection=e.selections,"selection"===this._options.renderWhitespace}onDecorationsChanged(e){return!0}onFlushed(e){return!0}onLinesChanged(e){return!0}onLinesDeleted(e){return!0}onLinesInserted(e){return!0}onScrollChanged(e){return e.scrollTopChanged}onZonesChanged(e){return!0}prepareRender(e){if("none"===this._options.renderWhitespace)return void(this._renderResult=null);const t=e.visibleRange.startLineNumber,i=e.visibleRange.endLineNumber-t+1,n=new Array(i);for(let e=0;e<i;e++)n[e]=!0;const s=this._context.viewModel.getMinimapLinesRenderingData(e.viewportData.startLineNumber,e.viewportData.endLineNumber,n);this._renderResult=[];for(let t=e.viewportData.startLineNumber;t<=e.viewportData.endLineNumber;t++){const i=t-e.viewportData.startLineNumber,n=s.data[i];let r=null;if("selection"===this._options.renderWhitespace){const e=this._selection;for(const i of e){if(i.endLineNumber<t||i.startLineNumber>t)continue;const e=i.startLineNumber===t?i.startColumn:n.minColumn,s=i.endLineNumber===t?i.endColumn:n.maxColumn;e<s&&(r||(r=[]),r.push(new LineRange(e-1,s-1)))}}this._renderResult[i]=this._applyRenderWhitespace(e,t,r,n)}}_applyRenderWhitespace(e,t,i,n){if("selection"===this._options.renderWhitespace&&!i)return"";if("trailing"===this._options.renderWhitespace&&n.continuesWithWrappedLine)return"";const s=this._context.theme.getColor(editorWhitespaces),r=this._options.renderWithSVG,o=n.content,h=-1===this._options.stopRenderingLineAfter?o.length:Math.min(this._options.stopRenderingLineAfter,o.length),d=n.continuesWithWrappedLine,a=n.minColumn-1,c="boundary"===this._options.renderWhitespace,p="trailing"===this._options.renderWhitespace,l=this._options.lineHeight,u=this._options.middotWidth,m=this._options.wsmiddotWidth,g=this._options.spaceWidth,f=Math.abs(m-g)<Math.abs(u-g)?11825:183,x=this._options.canUseHalfwidthRightwardsArrow;let w,W="",_=!1,y=strings.firstNonWhitespaceIndex(o);-1===y?(_=!0,y=h,w=h):w=strings.lastNonWhitespaceIndex(o);let v=0,R=i&&i[v],C=0;for(let n=a;n<h;n++){const s=o.charCodeAt(n);if(R&&n>=R.endOffset&&(v++,R=i&&i[v]),9!==s&&32!==s)continue;if(p&&!_&&n<=w)continue;if(c&&n>=y&&n<=w&&32===s){const e=n-1>=0?o.charCodeAt(n-1):0,t=n+1<h?o.charCodeAt(n+1):0;if(32!==e&&32!==t)continue}if(c&&d&&n===h-1){const e=n-1>=0?o.charCodeAt(n-1):0;if(32===s&&32!==e&&9!==e)continue}if(i&&(!R||R.startOffset>n||R.endOffset<=n))continue;const a=e.visibleRangeForPosition(new Position(t,n+1));a&&(r?(C=Math.max(C,a.left),W+=9===s?this._renderArrow(l,g,a.left):`<circle cx="${(a.left+g/2).toFixed(2)}" cy="${(l/2).toFixed(2)}" r="${(g/7).toFixed(2)}" />`):W+=9===s?`<div class="mwh" style="left:${a.left}px;height:${l}px;">${x?String.fromCharCode(65515):String.fromCharCode(8594)}</div>`:`<div class="mwh" style="left:${a.left}px;height:${l}px;">${String.fromCharCode(f)}</div>`)}return r?(C=Math.round(C+g),`<svg style="position:absolute;width:${C}px;height:${l}px" viewBox="0 0 ${C} ${l}" xmlns="http://www.w3.org/2000/svg" fill="${s}">`+W+"</svg>"):W}_renderArrow(e,t,i){const n=e/2,s=i,r={x:0,y:t/7/2},o={x:.8*t,y:r.y},h={x:o.x-.2*o.x,y:o.y+.2*o.x},d={x:h.x+.1*o.x,y:h.y+.1*o.x},a={x:d.x+.35*o.x,y:d.y-.35*o.x};return`<path d="M ${[r,o,h,d,a,{x:a.x,y:-a.y},{x:d.x,y:-d.y},{x:h.x,y:-h.y},{x:o.x,y:-o.y},{x:r.x,y:-r.y}].map((e=>`${(s+e.x).toFixed(2)} ${(n+e.y).toFixed(2)}`)).join(" L ")}" />`}render(e,t){if(!this._renderResult)return"";const i=t-e;return i<0||i>=this._renderResult.length?"":this._renderResult[i]}}class WhitespaceOptions{constructor(e){const t=e.options,i=t.get(47),n=t.get(35);"off"===n?(this.renderWhitespace="none",this.renderWithSVG=!1):"svg"===n?(this.renderWhitespace=t.get(93),this.renderWithSVG=!0):(this.renderWhitespace=t.get(93),this.renderWithSVG=!1),this.spaceWidth=i.spaceWidth,this.middotWidth=i.middotWidth,this.wsmiddotWidth=i.wsmiddotWidth,this.canUseHalfwidthRightwardsArrow=i.canUseHalfwidthRightwardsArrow,this.lineHeight=t.get(63),this.stopRenderingLineAfter=t.get(111)}equals(e){return this.renderWhitespace===e.renderWhitespace&&this.renderWithSVG===e.renderWithSVG&&this.spaceWidth===e.spaceWidth&&this.middotWidth===e.middotWidth&&this.wsmiddotWidth===e.wsmiddotWidth&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineHeight===e.lineHeight&&this.stopRenderingLineAfter===e.stopRenderingLineAfter}}