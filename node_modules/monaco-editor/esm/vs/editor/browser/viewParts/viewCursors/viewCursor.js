import*as dom from"../../../../base/browser/dom.js";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import*as strings from"../../../../base/common/strings.js";import{applyFontInfo}from"../../config/domFontInfo.js";import{TextEditorCursorStyle}from"../../../common/config/editorOptions.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}from"../../../../base/browser/ui/mouseCursor/mouseCursor.js";class ViewCursorRenderData{constructor(t,e,i,o,s,r,n){this.top=t,this.left=e,this.paddingLeft=i,this.width=o,this.height=s,this.textContent=r,this.textContentClassName=n}}export class ViewCursor{constructor(t){this._context=t;const e=this._context.configuration.options,i=e.get(47);this._cursorStyle=e.get(25),this._lineHeight=e.get(63),this._typicalHalfwidthCharacterWidth=i.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(e.get(28),this._typicalHalfwidthCharacterWidth),this._isVisible=!0,this._domNode=createFastDomNode(document.createElement("div")),this._domNode.setClassName(`cursor ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this._domNode.setHeight(this._lineHeight),this._domNode.setTop(0),this._domNode.setLeft(0),applyFontInfo(this._domNode,i),this._domNode.setDisplay("none"),this._position=new Position(1,1),this._lastRenderedContent="",this._renderData=null}getDomNode(){return this._domNode}getPosition(){return this._position}show(){this._isVisible||(this._domNode.setVisibility("inherit"),this._isVisible=!0)}hide(){this._isVisible&&(this._domNode.setVisibility("hidden"),this._isVisible=!1)}onConfigurationChanged(t){const e=this._context.configuration.options,i=e.get(47);return this._cursorStyle=e.get(25),this._lineHeight=e.get(63),this._typicalHalfwidthCharacterWidth=i.typicalHalfwidthCharacterWidth,this._lineCursorWidth=Math.min(e.get(28),this._typicalHalfwidthCharacterWidth),applyFontInfo(this._domNode,i),!0}onCursorPositionChanged(t,e){return this._domNode.domNode.style.transitionProperty=e?"none":"",this._position=t,!0}_getGraphemeAwarePosition(){const{lineNumber:t,column:e}=this._position,i=this._context.viewModel.getLineContent(t),[o,s]=strings.getCharContainingOffset(i,e-1);return[new Position(t,o+1),i.substring(o,s)]}_prepareRender(t){let e="",i="";const[o,s]=this._getGraphemeAwarePosition();if(this._cursorStyle===TextEditorCursorStyle.Line||this._cursorStyle===TextEditorCursorStyle.LineThin){const r=t.visibleRangeForPosition(o);if(!r||r.outsideRenderedLine)return null;let n;this._cursorStyle===TextEditorCursorStyle.Line?(n=dom.computeScreenAwareSize(this._lineCursorWidth>0?this._lineCursorWidth:2),n>2&&(e=s,i=this._getTokenClassName(o))):n=dom.computeScreenAwareSize(1);let h=r.left,d=0;n>=2&&h>=1&&(d=1,h-=d);const a=t.getVerticalOffsetForLineNumber(o.lineNumber)-t.bigNumbersDelta;return new ViewCursorRenderData(a,h,d,n,this._lineHeight,e,i)}const r=t.linesVisibleRangesForRange(new Range(o.lineNumber,o.column,o.lineNumber,o.column+s.length),!1);if(!r||0===r.length)return null;const n=r[0];if(n.outsideRenderedLine||0===n.ranges.length)return null;const h=n.ranges[0],d="\t"===s||h.width<1?this._typicalHalfwidthCharacterWidth:h.width;this._cursorStyle===TextEditorCursorStyle.Block&&(e=s,i=this._getTokenClassName(o));let a=t.getVerticalOffsetForLineNumber(o.lineNumber)-t.bigNumbersDelta,l=this._lineHeight;return this._cursorStyle!==TextEditorCursorStyle.Underline&&this._cursorStyle!==TextEditorCursorStyle.UnderlineThin||(a+=this._lineHeight-2,l=2),new ViewCursorRenderData(a,h.left,0,d,l,e,i)}_getTokenClassName(t){const e=this._context.viewModel.getViewLineData(t.lineNumber),i=e.tokens.findTokenIndexAtOffset(t.column-1);return e.tokens.getClassName(i)}prepareRender(t){this._renderData=this._prepareRender(t)}render(t){return this._renderData?(this._lastRenderedContent!==this._renderData.textContent&&(this._lastRenderedContent=this._renderData.textContent,this._domNode.domNode.textContent=this._lastRenderedContent),this._domNode.setClassName(`cursor ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME} ${this._renderData.textContentClassName}`),this._domNode.setDisplay("block"),this._domNode.setTop(this._renderData.top),this._domNode.setLeft(this._renderData.left),this._domNode.setPaddingLeft(this._renderData.paddingLeft),this._domNode.setWidth(this._renderData.width),this._domNode.setLineHeight(this._renderData.height),this._domNode.setHeight(this._renderData.height),{domNode:this._domNode.domNode,position:this._position,contentLeft:this._renderData.left,height:this._renderData.height,width:2}):(this._domNode.setDisplay("none"),null)}}