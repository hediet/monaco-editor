import*as dom from"../../base/browser/dom.js";import{Selection}from"../common/core/selection.js";import{createFastDomNode}from"../../base/browser/fastDomNode.js";import{onUnexpectedError}from"../../base/common/errors.js";import{PointerHandler}from"./controller/pointerHandler.js";import{TextAreaHandler}from"./controller/textAreaHandler.js";import{ViewController}from"./view/viewController.js";import{ViewUserInputEvents}from"./view/viewUserInputEvents.js";import{ContentViewOverlays,MarginViewOverlays}from"./view/viewOverlays.js";import{PartFingerprints}from"./view/viewPart.js";import{ViewContentWidgets}from"./viewParts/contentWidgets/contentWidgets.js";import{CurrentLineHighlightOverlay,CurrentLineMarginHighlightOverlay}from"./viewParts/currentLineHighlight/currentLineHighlight.js";import{DecorationsOverlay}from"./viewParts/decorations/decorations.js";import{EditorScrollbar}from"./viewParts/editorScrollbar/editorScrollbar.js";import{GlyphMarginOverlay}from"./viewParts/glyphMargin/glyphMargin.js";import{IndentGuidesOverlay}from"./viewParts/indentGuides/indentGuides.js";import{LineNumbersOverlay}from"./viewParts/lineNumbers/lineNumbers.js";import{ViewLines}from"./viewParts/lines/viewLines.js";import{LinesDecorationsOverlay}from"./viewParts/linesDecorations/linesDecorations.js";import{Margin}from"./viewParts/margin/margin.js";import{MarginViewLineDecorationsOverlay}from"./viewParts/marginDecorations/marginDecorations.js";import{Minimap}from"./viewParts/minimap/minimap.js";import{ViewOverlayWidgets}from"./viewParts/overlayWidgets/overlayWidgets.js";import{DecorationsOverviewRuler}from"./viewParts/overviewRuler/decorationsOverviewRuler.js";import{OverviewRuler}from"./viewParts/overviewRuler/overviewRuler.js";import{Rulers}from"./viewParts/rulers/rulers.js";import{ScrollDecorationViewPart}from"./viewParts/scrollDecoration/scrollDecoration.js";import{SelectionsOverlay}from"./viewParts/selections/selections.js";import{ViewCursors}from"./viewParts/viewCursors/viewCursors.js";import{ViewZones}from"./viewParts/viewZones/viewZones.js";import{Position}from"../common/core/position.js";import{RenderingContext}from"./view/renderingContext.js";import{ViewContext}from"../common/viewModel/viewContext.js";import{ViewportData}from"../common/viewLayout/viewLinesViewportData.js";import{ViewEventHandler}from"../common/viewEventHandler.js";import{getThemeTypeSelector}from"../../platform/theme/common/themeService.js";import{PointerHandlerLastRenderData}from"./controller/mouseTarget.js";import{BlockDecorations}from"./viewParts/blockDecorations/blockDecorations.js";import{inputLatency}from"../../base/browser/performance.js";import{WhitespaceOverlay}from"./viewParts/whitespace/whitespace.js";export class View extends ViewEventHandler{constructor(e,t,i,o,n,r){super(),this._selections=[new Selection(1,1,1,1)],this._renderAnimationFrame=null;const s=new ViewController(t,o,n,e);this._context=new ViewContext(t,i,o),this._context.addEventHandler(this),this._viewParts=[],this._textAreaHandler=new TextAreaHandler(this._context,s,this._createTextAreaHandlerHelper()),this._viewParts.push(this._textAreaHandler),this._linesContent=createFastDomNode(document.createElement("div")),this._linesContent.setClassName("lines-content monaco-editor-background"),this._linesContent.setPosition("absolute"),this.domNode=createFastDomNode(document.createElement("div")),this.domNode.setClassName(this._getEditorClassName()),this.domNode.setAttribute("role","code"),this._overflowGuardContainer=createFastDomNode(document.createElement("div")),PartFingerprints.write(this._overflowGuardContainer,3),this._overflowGuardContainer.setClassName("overflow-guard"),this._scrollbar=new EditorScrollbar(this._context,this._linesContent,this.domNode,this._overflowGuardContainer),this._viewParts.push(this._scrollbar),this._viewLines=new ViewLines(this._context,this._linesContent),this._viewZones=new ViewZones(this._context),this._viewParts.push(this._viewZones);const a=new DecorationsOverviewRuler(this._context);this._viewParts.push(a);const d=new ScrollDecorationViewPart(this._context);this._viewParts.push(d);const l=new ContentViewOverlays(this._context);this._viewParts.push(l),l.addDynamicOverlay(new CurrentLineHighlightOverlay(this._context)),l.addDynamicOverlay(new SelectionsOverlay(this._context)),l.addDynamicOverlay(new IndentGuidesOverlay(this._context)),l.addDynamicOverlay(new DecorationsOverlay(this._context)),l.addDynamicOverlay(new WhitespaceOverlay(this._context));const h=new MarginViewOverlays(this._context);this._viewParts.push(h),h.addDynamicOverlay(new CurrentLineMarginHighlightOverlay(this._context)),h.addDynamicOverlay(new GlyphMarginOverlay(this._context)),h.addDynamicOverlay(new MarginViewLineDecorationsOverlay(this._context)),h.addDynamicOverlay(new LinesDecorationsOverlay(this._context)),h.addDynamicOverlay(new LineNumbersOverlay(this._context));const c=new Margin(this._context);c.getDomNode().appendChild(this._viewZones.marginDomNode),c.getDomNode().appendChild(h.getDomNode()),this._viewParts.push(c),this._contentWidgets=new ViewContentWidgets(this._context,this.domNode),this._viewParts.push(this._contentWidgets),this._viewCursors=new ViewCursors(this._context),this._viewParts.push(this._viewCursors),this._overlayWidgets=new ViewOverlayWidgets(this._context),this._viewParts.push(this._overlayWidgets);const m=new Rulers(this._context);this._viewParts.push(m);const w=new BlockDecorations(this._context);this._viewParts.push(w);const v=new Minimap(this._context);if(this._viewParts.push(v),a){const e=this._scrollbar.getOverviewRulerLayoutInfo();e.parent.insertBefore(a.getDomNode(),e.insertBefore)}this._linesContent.appendChild(l.getDomNode()),this._linesContent.appendChild(m.domNode),this._linesContent.appendChild(w.domNode),this._linesContent.appendChild(this._viewZones.domNode),this._linesContent.appendChild(this._viewLines.getDomNode()),this._linesContent.appendChild(this._contentWidgets.domNode),this._linesContent.appendChild(this._viewCursors.getDomNode()),this._overflowGuardContainer.appendChild(c.getDomNode()),this._overflowGuardContainer.appendChild(this._scrollbar.getDomNode()),this._overflowGuardContainer.appendChild(d.getDomNode()),this._overflowGuardContainer.appendChild(this._textAreaHandler.textArea),this._overflowGuardContainer.appendChild(this._textAreaHandler.textAreaCover),this._overflowGuardContainer.appendChild(this._overlayWidgets.getDomNode()),this._overflowGuardContainer.appendChild(v.getDomNode()),this.domNode.appendChild(this._overflowGuardContainer),r?r.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode.domNode):this.domNode.appendChild(this._contentWidgets.overflowingContentWidgetsDomNode),this._applyLayout(),this._pointerHandler=this._register(new PointerHandler(this._context,s,this._createPointerHandlerHelper()))}_flushAccumulatedAndRenderNow(){inputLatency.onRenderStart(),this._renderNow()}_createPointerHandlerHelper(){return{viewDomNode:this.domNode.domNode,linesContentDomNode:this._linesContent.domNode,viewLinesDomNode:this._viewLines.getDomNode().domNode,focusTextArea:()=>{this.focus()},dispatchTextAreaEvent:e=>{this._textAreaHandler.textArea.domNode.dispatchEvent(e)},getLastRenderData:()=>{const e=this._viewCursors.getLastRenderData()||[],t=this._textAreaHandler.getLastRenderData();return new PointerHandlerLastRenderData(e,t)},renderNow:()=>{this.render(!0,!1)},shouldSuppressMouseDownOnViewZone:e=>this._viewZones.shouldSuppressMouseDownOnViewZone(e),shouldSuppressMouseDownOnWidget:e=>this._contentWidgets.shouldSuppressMouseDownOnWidget(e),getPositionFromDOMInfo:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getPositionFromDOMInfo(e,t)),visibleRangeForPosition:(e,t)=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(new Position(e,t))),getLineWidth:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.getLineWidth(e))}}_createTextAreaHandlerHelper(){return{visibleRangeForPosition:e=>(this._flushAccumulatedAndRenderNow(),this._viewLines.visibleRangeForPosition(e))}}_applyLayout(){const e=this._context.configuration.options.get(138);this.domNode.setWidth(e.width),this.domNode.setHeight(e.height),this._overflowGuardContainer.setWidth(e.width),this._overflowGuardContainer.setHeight(e.height),this._linesContent.setWidth(1e6),this._linesContent.setHeight(1e6)}_getEditorClassName(){const e=this._textAreaHandler.isFocused()?" focused":"";return this._context.configuration.options.get(135)+" "+getThemeTypeSelector(this._context.theme.type)+e}handleEvents(e){super.handleEvents(e),this._scheduleRender()}onConfigurationChanged(e){return this.domNode.setClassName(this._getEditorClassName()),this._applyLayout(),!1}onCursorStateChanged(e){return this._selections=e.selections,!1}onFocusChanged(e){return this.domNode.setClassName(this._getEditorClassName()),!1}onThemeChanged(e){return this._context.theme.update(e.theme),this.domNode.setClassName(this._getEditorClassName()),!1}dispose(){null!==this._renderAnimationFrame&&(this._renderAnimationFrame.dispose(),this._renderAnimationFrame=null),this._contentWidgets.overflowingContentWidgetsDomNode.domNode.remove(),this._context.removeEventHandler(this),this._viewLines.dispose();for(const e of this._viewParts)e.dispose();super.dispose()}_scheduleRender(){null===this._renderAnimationFrame&&(this._renderAnimationFrame=dom.runAtThisOrScheduleAtNextAnimationFrame(this._onRenderScheduled.bind(this),100))}_onRenderScheduled(){this._renderAnimationFrame=null,this._flushAccumulatedAndRenderNow()}_renderNow(){safeInvokeNoArg((()=>this._actualRender()))}_getViewPartsToRender(){const e=[];let t=0;for(const i of this._viewParts)i.shouldRender()&&(e[t++]=i);return e}_actualRender(){if(!dom.isInDOM(this.domNode.domNode))return;let e=this._getViewPartsToRender();if(!this._viewLines.shouldRender()&&0===e.length)return;const t=this._context.viewLayout.getLinesViewportData();this._context.viewModel.setViewport(t.startLineNumber,t.endLineNumber,t.centeredLineNumber);const i=new ViewportData(this._selections,t,this._context.viewLayout.getWhitespaceViewportData(),this._context.viewModel);this._contentWidgets.shouldRender()&&this._contentWidgets.onBeforeRender(i),this._viewLines.shouldRender()&&(this._viewLines.renderText(i),this._viewLines.onDidRender(),e=this._getViewPartsToRender());const o=new RenderingContext(this._context.viewLayout,i,this._viewLines);for(const t of e)t.prepareRender(o);for(const t of e)t.render(o),t.onDidRender()}delegateVerticalScrollbarPointerDown(e){this._scrollbar.delegateVerticalScrollbarPointerDown(e)}delegateScrollFromMouseWheelEvent(e){this._scrollbar.delegateScrollFromMouseWheelEvent(e)}restoreState(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e.scrollTop,scrollLeft:e.scrollLeft},1),this._context.viewModel.tokenizeViewport()}getOffsetForColumn(e,t){const i=this._context.viewModel.model.validatePosition({lineNumber:e,column:t}),o=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i);this._flushAccumulatedAndRenderNow();const n=this._viewLines.visibleRangeForPosition(new Position(o.lineNumber,o.column));return n?n.left:-1}getTargetAtClientPoint(e,t){const i=this._pointerHandler.getTargetAtClientPoint(e,t);return i?ViewUserInputEvents.convertViewToModelMouseTarget(i,this._context.viewModel.coordinatesConverter):null}createOverviewRuler(e){return new OverviewRuler(this._context,e)}change(e){this._viewZones.changeViewZones(e),this._scheduleRender()}render(e,t){if(t){this._viewLines.forceShouldRender();for(const e of this._viewParts)e.forceShouldRender()}e?this._flushAccumulatedAndRenderNow():this._scheduleRender()}writeScreenReaderContent(e){this._textAreaHandler.writeScreenReaderContent(e)}focus(){this._textAreaHandler.focusTextArea()}isFocused(){return this._textAreaHandler.isFocused()}setAriaOptions(e){this._textAreaHandler.setAriaOptions(e)}addContentWidget(e){this._contentWidgets.addWidget(e.widget),this.layoutContentWidget(e),this._scheduleRender()}layoutContentWidget(e){var t,i,o,n,r,s,a,d;this._contentWidgets.setWidgetPosition(e.widget,null!==(i=null===(t=e.position)||void 0===t?void 0:t.position)&&void 0!==i?i:null,null!==(n=null===(o=e.position)||void 0===o?void 0:o.secondaryPosition)&&void 0!==n?n:null,null!==(s=null===(r=e.position)||void 0===r?void 0:r.preference)&&void 0!==s?s:null,null!==(d=null===(a=e.position)||void 0===a?void 0:a.positionAffinity)&&void 0!==d?d:null),this._scheduleRender()}removeContentWidget(e){this._contentWidgets.removeWidget(e.widget),this._scheduleRender()}addOverlayWidget(e){this._overlayWidgets.addWidget(e.widget),this.layoutOverlayWidget(e),this._scheduleRender()}layoutOverlayWidget(e){const t=e.position?e.position.preference:null;this._overlayWidgets.setWidgetPosition(e.widget,t)&&this._scheduleRender()}removeOverlayWidget(e){this._overlayWidgets.removeWidget(e.widget),this._scheduleRender()}}function safeInvokeNoArg(e){try{return e()}catch(e){onUnexpectedError(e)}}