import"./textAreaHandler.css";import*as nls from"../../../nls.js";import*as browser from"../../../base/browser/browser.js";import{createFastDomNode}from"../../../base/browser/fastDomNode.js";import*as platform from"../../../base/common/platform.js";import*as strings from"../../../base/common/strings.js";import{applyFontInfo}from"../config/domFontInfo.js";import{CopyOptions,TextAreaInput,TextAreaWrapper}from"./textAreaInput.js";import{PagedScreenReaderStrategy,TextAreaState,_debugComposition}from"./textAreaState.js";import{PartFingerprints,ViewPart}from"../view/viewPart.js";import{LineNumbersOverlay}from"../viewParts/lineNumbers/lineNumbers.js";import{Margin}from"../viewParts/margin/margin.js";import{EditorOptions}from"../../common/config/editorOptions.js";import{getMapForWordSeparators}from"../../common/core/wordCharacterClassifier.js";import{Position}from"../../common/core/position.js";import{Range}from"../../common/core/range.js";import{Selection}from"../../common/core/selection.js";import{MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}from"../../../base/browser/ui/mouseCursor/mouseCursor.js";import{TokenizationRegistry}from"../../common/languages.js";import{Color}from"../../../base/common/color.js";import{IME}from"../../../base/common/ime.js";class VisibleTextAreaData{constructor(t,e,i,o,s){this._context=t,this.modelLineNumber=e,this.distanceToModelLineStart=i,this.widthOfHiddenLineTextBefore=o,this.distanceToModelLineEnd=s,this._visibleTextAreaBrand=void 0,this.startPosition=null,this.endPosition=null,this.visibleTextareaStart=null,this.visibleTextareaEnd=null,this._previousPresentation=null}prepareRender(t){const e=new Position(this.modelLineNumber,this.distanceToModelLineStart+1),i=new Position(this.modelLineNumber,this._context.viewModel.model.getLineMaxColumn(this.modelLineNumber)-this.distanceToModelLineEnd);this.startPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(e),this.endPosition=this._context.viewModel.coordinatesConverter.convertModelPositionToViewPosition(i),this.startPosition.lineNumber===this.endPosition.lineNumber?(this.visibleTextareaStart=t.visibleRangeForPosition(this.startPosition),this.visibleTextareaEnd=t.visibleRangeForPosition(this.endPosition)):(this.visibleTextareaStart=null,this.visibleTextareaEnd=null)}definePresentation(t){return this._previousPresentation||(this._previousPresentation=t||{foreground:1,italic:!1,bold:!1,underline:!1,strikethrough:!1}),this._previousPresentation}}const canUseZeroSizeTextarea=browser.isFirefox;export class TextAreaHandler extends ViewPart{constructor(t,e,i){super(t),this._primaryCursorPosition=new Position(1,1),this._primaryCursorVisibleRange=null,this._viewController=e,this._visibleRangeProvider=i,this._scrollLeft=0,this._scrollTop=0;const o=this._context.configuration.options,s=o.get(138);this._setAccessibilityOptions(o),this._contentLeft=s.contentLeft,this._contentWidth=s.contentWidth,this._contentHeight=s.height,this._fontInfo=o.get(47),this._lineHeight=o.get(63),this._emptySelectionClipboard=o.get(34),this._copyWithSyntaxHighlighting=o.get(22),this._visibleTextArea=null,this._selections=[new Selection(1,1,1,1)],this._modelSelections=[new Selection(1,1,1,1)],this._lastRenderPosition=null,this.textArea=createFastDomNode(document.createElement("textarea")),PartFingerprints.write(this.textArea,6),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:r}=this._context.viewModel.model.getOptions();this.textArea.domNode.style.tabSize=r*this._fontInfo.spaceWidth+"px",this.textArea.setAttribute("autocorrect","off"),this.textArea.setAttribute("autocapitalize","off"),this.textArea.setAttribute("autocomplete","off"),this.textArea.setAttribute("spellcheck","false"),this.textArea.setAttribute("aria-label",this._getAriaLabel(o)),this.textArea.setAttribute("tabindex",String(o.get(118))),this.textArea.setAttribute("role","textbox"),this.textArea.setAttribute("aria-roledescription",nls.localize("editor","editor")),this.textArea.setAttribute("aria-multiline","true"),this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),this._ensureReadOnlyAttribute(),this.textAreaCover=createFastDomNode(document.createElement("div")),this.textAreaCover.setPosition("absolute");const n={getLineCount:()=>this._context.viewModel.getLineCount(),getLineMaxColumn:t=>this._context.viewModel.getLineMaxColumn(t),getValueInRange:(t,e)=>this._context.viewModel.getValueInRange(t,e),getValueLengthInRange:(t,e)=>this._context.viewModel.getValueLengthInRange(t,e),modifyPosition:(t,e)=>this._context.viewModel.modifyPosition(t,e)},a={getDataToCopy:()=>{const t=this._context.viewModel.getPlainTextToCopy(this._modelSelections,this._emptySelectionClipboard,platform.isWindows),e=this._context.viewModel.model.getEOL(),i=this._emptySelectionClipboard&&1===this._modelSelections.length&&this._modelSelections[0].isEmpty(),o=Array.isArray(t)?t:null,s=Array.isArray(t)?t.join(e):t;let r,n=null;if(CopyOptions.forceCopyWithSyntaxHighlighting||this._copyWithSyntaxHighlighting&&s.length<65536){const t=this._context.viewModel.getRichTextToCopy(this._modelSelections,this._emptySelectionClipboard);t&&(r=t.html,n=t.mode)}return{isFromEmptySelection:i,multicursorText:o,text:s,html:r,mode:n}},getScreenReaderContent:()=>{if(1===this._accessibilitySupport){const t=this._selections[0];if(platform.isMacintosh&&t.isEmpty()){const e=t.getStartPosition();let i=this._getWordBeforePosition(e);if(0===i.length&&(i=this._getCharacterBeforePosition(e)),i.length>0)return new TextAreaState(i,i.length,i.length,Range.fromPositions(e),0)}const e=500;if(platform.isMacintosh&&!t.isEmpty()&&n.getValueLengthInRange(t,0)<e){const e=n.getValueInRange(t,0);return new TextAreaState(e,0,e.length,t,0)}if(browser.isSafari&&!t.isEmpty()){const t="vscode-placeholder";return new TextAreaState(t,0,t.length,null,void 0)}return TextAreaState.EMPTY}if(browser.isAndroid){const t=this._selections[0];if(t.isEmpty()){const e=t.getStartPosition(),[i,o]=this._getAndroidWordAtPosition(e);if(i.length>0)return new TextAreaState(i,o,o,Range.fromPositions(e),0)}return TextAreaState.EMPTY}return PagedScreenReaderStrategy.fromEditorSelection(n,this._selections[0],this._accessibilityPageSize,0===this._accessibilitySupport)},deduceModelPosition:(t,e,i)=>this._context.viewModel.deduceModelPositionRelativeToViewPosition(t,e,i)},l=this._register(new TextAreaWrapper(this.textArea.domNode));this._textAreaInput=this._register(new TextAreaInput(a,l,platform.OS,browser)),this._register(this._textAreaInput.onKeyDown((t=>{this._viewController.emitKeyDown(t)}))),this._register(this._textAreaInput.onKeyUp((t=>{this._viewController.emitKeyUp(t)}))),this._register(this._textAreaInput.onPaste((t=>{let e=!1,i=null,o=null;t.metadata&&(e=this._emptySelectionClipboard&&!!t.metadata.isFromEmptySelection,i=void 0!==t.metadata.multicursorText?t.metadata.multicursorText:null,o=t.metadata.mode),this._viewController.paste(t.text,e,i,o)}))),this._register(this._textAreaInput.onCut((()=>{this._viewController.cut()}))),this._register(this._textAreaInput.onType((t=>{t.replacePrevCharCnt||t.replaceNextCharCnt||t.positionDelta?(_debugComposition&&console.log(` => compositionType: <<${t.text}>>, ${t.replacePrevCharCnt}, ${t.replaceNextCharCnt}, ${t.positionDelta}`),this._viewController.compositionType(t.text,t.replacePrevCharCnt,t.replaceNextCharCnt,t.positionDelta)):(_debugComposition&&console.log(` => type: <<${t.text}>>`),this._viewController.type(t.text))}))),this._register(this._textAreaInput.onSelectionChangeRequest((t=>{this._viewController.setSelection(t)}))),this._register(this._textAreaInput.onCompositionStart((t=>{const e=this.textArea.domNode,i=this._modelSelections[0],{distanceToModelLineStart:o,widthOfHiddenTextBefore:s}=(()=>{const t=e.value.substring(0,Math.min(e.selectionStart,e.selectionEnd)),o=t.lastIndexOf("\n"),s=t.substring(o+1),r=s.lastIndexOf("\t"),n=s.length-r-1,a=i.getStartPosition(),l=Math.min(a.column-1,n),h=a.column-1-l,c=s.substring(0,s.length-l),{tabSize:d}=this._context.viewModel.model.getOptions();return{distanceToModelLineStart:h,widthOfHiddenTextBefore:measureText(c,this._fontInfo,d)}})(),{distanceToModelLineEnd:r}=(()=>{const t=e.value.substring(Math.max(e.selectionStart,e.selectionEnd)),o=t.indexOf("\n"),s=-1===o?t:t.substring(0,o),r=s.indexOf("\t"),n=-1===r?s.length:s.length-r-1,a=i.getEndPosition(),l=Math.min(this._context.viewModel.model.getLineMaxColumn(a.lineNumber)-a.column,n);return{distanceToModelLineEnd:this._context.viewModel.model.getLineMaxColumn(a.lineNumber)-a.column-l}})();this._context.viewModel.revealRange("keyboard",!0,Range.fromPositions(this._selections[0].getStartPosition()),0,1),this._visibleTextArea=new VisibleTextAreaData(this._context,i.startLineNumber,o,s,r),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render(),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME} ime-input`),this._viewController.compositionStart(),this._context.viewModel.onCompositionStart()}))),this._register(this._textAreaInput.onCompositionUpdate((t=>{this._visibleTextArea&&(this._visibleTextArea.prepareRender(this._visibleRangeProvider),this._render())}))),this._register(this._textAreaInput.onCompositionEnd((()=>{this._visibleTextArea=null,this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off"),this._render(),this.textArea.setClassName(`inputarea ${MOUSE_CURSOR_TEXT_CSS_CLASS_NAME}`),this._viewController.compositionEnd(),this._context.viewModel.onCompositionEnd()}))),this._register(this._textAreaInput.onFocus((()=>{this._context.viewModel.setHasFocus(!0)}))),this._register(this._textAreaInput.onBlur((()=>{this._context.viewModel.setHasFocus(!1)}))),this._register(IME.onDidChange((()=>{this._ensureReadOnlyAttribute()})))}writeScreenReaderContent(t){this._textAreaInput.writeScreenReaderContent(t)}dispose(){super.dispose()}_getAndroidWordAtPosition(t){const e=this._context.viewModel.getLineContent(t.lineNumber),i=getMapForWordSeparators('`~!@#$%^&*()-=+[{]}\\|;:",.<>/?');let o=!0,s=t.column,r=!0,n=t.column,a=0;for(;a<50&&(o||r);){if(o&&s<=1&&(o=!1),o){const t=e.charCodeAt(s-2);0!==i.get(t)?o=!1:s--}if(r&&n>e.length&&(r=!1),r){const t=e.charCodeAt(n-1);0!==i.get(t)?r=!1:n++}a++}return[e.substring(s-1,n-1),t.column-s]}_getWordBeforePosition(t){const e=this._context.viewModel.getLineContent(t.lineNumber),i=getMapForWordSeparators(this._context.configuration.options.get(124));let o=t.column,s=0;for(;o>1;){const r=e.charCodeAt(o-2);if(0!==i.get(r)||s>50)return e.substring(o-1,t.column-1);s++,o--}return e.substring(0,t.column-1)}_getCharacterBeforePosition(t){if(t.column>1){const e=this._context.viewModel.getLineContent(t.lineNumber).charAt(t.column-2);if(!strings.isHighSurrogate(e.charCodeAt(0)))return e}return""}_getAriaLabel(t){return 1===t.get(2)?nls.localize("accessibilityOffAriaLabel","The editor is not accessible at this time. Press {0} for options.",platform.isLinux?"Shift+Alt+F1":"Alt+F1"):t.get(4)}_setAccessibilityOptions(t){this._accessibilitySupport=t.get(2);const e=t.get(3);2===this._accessibilitySupport&&e===EditorOptions.accessibilityPageSize.defaultValue?this._accessibilityPageSize=500:this._accessibilityPageSize=e;const i=t.get(138).wrappingColumn;if(-1!==i&&1!==this._accessibilitySupport){const e=t.get(47);this._textAreaWrapping=!0,this._textAreaWidth=Math.round(i*e.typicalHalfwidthCharacterWidth)}else this._textAreaWrapping=!1,this._textAreaWidth=canUseZeroSizeTextarea?0:1}onConfigurationChanged(t){const e=this._context.configuration.options,i=e.get(138);this._setAccessibilityOptions(e),this._contentLeft=i.contentLeft,this._contentWidth=i.contentWidth,this._contentHeight=i.height,this._fontInfo=e.get(47),this._lineHeight=e.get(63),this._emptySelectionClipboard=e.get(34),this._copyWithSyntaxHighlighting=e.get(22),this.textArea.setAttribute("wrap",this._textAreaWrapping&&!this._visibleTextArea?"on":"off");const{tabSize:o}=this._context.viewModel.model.getOptions();return this.textArea.domNode.style.tabSize=o*this._fontInfo.spaceWidth+"px",this.textArea.setAttribute("aria-label",this._getAriaLabel(e)),this.textArea.setAttribute("tabindex",String(e.get(118))),(t.hasChanged(31)||t.hasChanged(86))&&this._ensureReadOnlyAttribute(),t.hasChanged(2)&&this._textAreaInput.writeScreenReaderContent("strategy changed"),!0}onCursorStateChanged(t){return this._selections=t.selections.slice(0),this._modelSelections=t.modelSelections.slice(0),this._textAreaInput.writeScreenReaderContent("selection changed"),!0}onDecorationsChanged(t){return!0}onFlushed(t){return!0}onLinesChanged(t){return!0}onLinesDeleted(t){return!0}onLinesInserted(t){return!0}onScrollChanged(t){return this._scrollLeft=t.scrollLeft,this._scrollTop=t.scrollTop,!0}onZonesChanged(t){return!0}isFocused(){return this._textAreaInput.isFocused()}focusTextArea(){this._textAreaInput.focusTextArea()}getLastRenderData(){return this._lastRenderPosition}setAriaOptions(t){t.activeDescendant?(this.textArea.setAttribute("aria-haspopup","true"),this.textArea.setAttribute("aria-autocomplete","list"),this.textArea.setAttribute("aria-activedescendant",t.activeDescendant)):(this.textArea.setAttribute("aria-haspopup","false"),this.textArea.setAttribute("aria-autocomplete","both"),this.textArea.removeAttribute("aria-activedescendant")),t.role&&this.textArea.setAttribute("role",t.role)}_ensureReadOnlyAttribute(){const t=this._context.configuration.options;!IME.enabled||t.get(31)&&t.get(86)?this.textArea.setAttribute("readonly","true"):this.textArea.removeAttribute("readonly")}prepareRender(t){var e;this._primaryCursorPosition=new Position(this._selections[0].positionLineNumber,this._selections[0].positionColumn),this._primaryCursorVisibleRange=t.visibleRangeForPosition(this._primaryCursorPosition),null===(e=this._visibleTextArea)||void 0===e||e.prepareRender(t)}render(t){this._textAreaInput.writeScreenReaderContent("render"),this._render()}_render(){var t;if(this._visibleTextArea){const t=this._visibleTextArea.visibleTextareaStart,e=this._visibleTextArea.visibleTextareaEnd,i=this._visibleTextArea.startPosition,o=this._visibleTextArea.endPosition;if(i&&o&&t&&e&&e.left>=this._scrollLeft&&t.left<=this._scrollLeft+this._contentWidth){const s=this._context.viewLayout.getVerticalOffsetForLineNumber(this._primaryCursorPosition.lineNumber)-this._scrollTop,r=this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));let n=this._visibleTextArea.widthOfHiddenLineTextBefore,a=this._contentLeft+t.left-this._scrollLeft,l=e.left-t.left+1;if(a<this._contentLeft){const t=this._contentLeft-a;a+=t,n+=t,l-=t}l>this._contentWidth&&(l=this._contentWidth);const h=this._context.viewModel.getViewLineData(i.lineNumber),c=h.tokens.findTokenIndexAtOffset(i.column-1),d=c===h.tokens.findTokenIndexAtOffset(o.column-1),u=this._visibleTextArea.definePresentation(d?h.tokens.getPresentation(c):null);this.textArea.domNode.scrollTop=r*this._lineHeight,this.textArea.domNode.scrollLeft=n,this._doRender({lastRenderPosition:null,top:s,left:a,width:l,height:this._lineHeight,useCover:!1,color:(TokenizationRegistry.getColorMap()||[])[u.foreground],italic:u.italic,bold:u.bold,underline:u.underline,strikethrough:u.strikethrough})}return}if(!this._primaryCursorVisibleRange)return void this._renderAtTopLeft();const e=this._contentLeft+this._primaryCursorVisibleRange.left-this._scrollLeft;if(e<this._contentLeft||e>this._contentLeft+this._contentWidth)return void this._renderAtTopLeft();const i=this._context.viewLayout.getVerticalOffsetForLineNumber(this._selections[0].positionLineNumber)-this._scrollTop;if(i<0||i>this._contentHeight)this._renderAtTopLeft();else if(platform.isMacintosh){this._doRender({lastRenderPosition:this._primaryCursorPosition,top:i,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:this._lineHeight,useCover:!1}),this.textArea.domNode.scrollLeft=this._primaryCursorVisibleRange.left;const o=null!==(t=this._textAreaInput.textAreaState.newlineCountBeforeSelection)&&void 0!==t?t:this._newlinecount(this.textArea.domNode.value.substr(0,this.textArea.domNode.selectionStart));this.textArea.domNode.scrollTop=o*this._lineHeight}else this._doRender({lastRenderPosition:this._primaryCursorPosition,top:i,left:this._textAreaWrapping?this._contentLeft:e,width:this._textAreaWidth,height:canUseZeroSizeTextarea?0:1,useCover:!1})}_newlinecount(t){let e=0,i=-1;for(;i=t.indexOf("\n",i+1),-1!==i;)e++;return e}_renderAtTopLeft(){this._doRender({lastRenderPosition:null,top:0,left:0,width:this._textAreaWidth,height:canUseZeroSizeTextarea?0:1,useCover:!0})}_doRender(t){this._lastRenderPosition=t.lastRenderPosition;const e=this.textArea,i=this.textAreaCover;applyFontInfo(e,this._fontInfo),e.setTop(t.top),e.setLeft(t.left),e.setWidth(t.width),e.setHeight(t.height),e.setColor(t.color?Color.Format.CSS.formatHex(t.color):""),e.setFontStyle(t.italic?"italic":""),t.bold&&e.setFontWeight("bold"),e.setTextDecoration(`${t.underline?" underline":""}${t.strikethrough?" line-through":""}`),i.setTop(t.useCover?t.top:0),i.setLeft(t.useCover?t.left:0),i.setWidth(t.useCover?t.width:0),i.setHeight(t.useCover?t.height:0);const o=this._context.configuration.options;o.get(54)?i.setClassName("monaco-editor-background textAreaCover "+Margin.OUTER_CLASS_NAME):0!==o.get(64).renderType?i.setClassName("monaco-editor-background textAreaCover "+LineNumbersOverlay.CLASS_NAME):i.setClassName("monaco-editor-background textAreaCover")}}function measureText(t,e,i){if(0===t.length)return 0;const o=document.createElement("div");o.style.position="absolute",o.style.top="-50000px",o.style.width="50000px";const s=document.createElement("span");applyFontInfo(s,e),s.style.whiteSpace="pre",s.style.tabSize=i*e.spaceWidth+"px",s.append(t),o.appendChild(s),document.body.appendChild(o);const r=s.offsetWidth;return document.body.removeChild(o),r}