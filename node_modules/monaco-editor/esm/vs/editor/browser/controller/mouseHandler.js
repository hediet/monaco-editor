import*as dom from"../../../base/browser/dom.js";import{StandardWheelEvent}from"../../../base/browser/mouseEvent.js";import{Disposable}from"../../../base/common/lifecycle.js";import*as platform from"../../../base/common/platform.js";import{HitTestContext,MouseTarget,MouseTargetFactory}from"./mouseTarget.js";import{ClientCoordinates,EditorMouseEvent,EditorMouseEventFactory,GlobalEditorPointerMoveMonitor,createEditorPagePosition,createCoordinatesRelativeToEditor,PageCoordinates}from"../editorDom.js";import{EditorZoom}from"../../common/config/editorZoom.js";import{Position}from"../../common/core/position.js";import{Selection}from"../../common/core/selection.js";import{ViewEventHandler}from"../../common/viewEventHandler.js";import{MouseWheelClassifier}from"../../../base/browser/ui/scrollbar/scrollableElement.js";export class MouseHandler extends ViewEventHandler{constructor(t,e,o){super(),this._mouseLeaveMonitor=null,this._context=t,this.viewController=e,this.viewHelper=o,this.mouseTargetFactory=new MouseTargetFactory(this._context,o),this._mouseDownOperation=this._register(new MouseDownOperation(this._context,this.viewController,this.viewHelper,this.mouseTargetFactory,((t,e)=>this._createMouseTarget(t,e)),(t=>this._getMouseColumn(t)))),this.lastMouseLeaveTime=-1,this._height=this._context.configuration.options.get(138).height;const i=new EditorMouseEventFactory(this.viewHelper.viewDomNode);this._register(i.onContextMenu(this.viewHelper.viewDomNode,(t=>this._onContextMenu(t,!0)))),this._register(i.onMouseMove(this.viewHelper.viewDomNode,(t=>{this._onMouseMove(t),this._mouseLeaveMonitor||(this._mouseLeaveMonitor=dom.addDisposableListener(document,"mousemove",(t=>{this.viewHelper.viewDomNode.contains(t.target)||this._onMouseLeave(new EditorMouseEvent(t,!1,this.viewHelper.viewDomNode))})))}))),this._register(i.onMouseUp(this.viewHelper.viewDomNode,(t=>this._onMouseUp(t)))),this._register(i.onMouseLeave(this.viewHelper.viewDomNode,(t=>this._onMouseLeave(t))));let s=0;this._register(i.onPointerDown(this.viewHelper.viewDomNode,((t,e)=>{s=e}))),this._register(dom.addDisposableListener(this.viewHelper.viewDomNode,dom.EventType.POINTER_UP,(t=>{this._mouseDownOperation.onPointerUp()}))),this._register(i.onMouseDown(this.viewHelper.viewDomNode,(t=>this._onMouseDown(t,s)))),this._setupMouseWheelZoomListener(),this._context.addEventHandler(this)}_setupMouseWheelZoomListener(){const t=MouseWheelClassifier.INSTANCE;let e=0,o=EditorZoom.getZoomLevel(),i=!1,s=0;function n(t){return platform.isMacintosh?(t.metaKey||t.ctrlKey)&&!t.shiftKey&&!t.altKey:t.ctrlKey&&!t.metaKey&&!t.shiftKey&&!t.altKey}this._register(dom.addDisposableListener(this.viewHelper.viewDomNode,dom.EventType.MOUSE_WHEEL,(r=>{if(this.viewController.emitMouseWheel(r),!this._context.configuration.options.get(72))return;const a=new StandardWheelEvent(r);if(t.acceptStandardWheelEvent(a),t.isPhysicalMouseWheel()){if(n(r)){const t=EditorZoom.getZoomLevel(),e=a.deltaY>0?1:-1;EditorZoom.setZoomLevel(t+e),a.preventDefault(),a.stopPropagation()}}else Date.now()-e>50&&(o=EditorZoom.getZoomLevel(),i=n(r),s=0),e=Date.now(),s+=a.deltaY,i&&(EditorZoom.setZoomLevel(o+s/5),a.preventDefault(),a.stopPropagation())}),{capture:!0,passive:!1}))}dispose(){this._context.removeEventHandler(this),this._mouseLeaveMonitor&&(this._mouseLeaveMonitor.dispose(),this._mouseLeaveMonitor=null),super.dispose()}onConfigurationChanged(t){if(t.hasChanged(138)){const t=this._context.configuration.options.get(138).height;this._height!==t&&(this._height=t,this._mouseDownOperation.onHeightChanged())}return!1}onCursorStateChanged(t){return this._mouseDownOperation.onCursorStateChanged(t),!1}onFocusChanged(t){return!1}getTargetAtClientPoint(t,e){const o=new ClientCoordinates(t,e).toPageCoordinates(),i=createEditorPagePosition(this.viewHelper.viewDomNode);if(o.y<i.y||o.y>i.y+i.height||o.x<i.x||o.x>i.x+i.width)return null;const s=createCoordinatesRelativeToEditor(this.viewHelper.viewDomNode,i,o);return this.mouseTargetFactory.createMouseTarget(this.viewHelper.getLastRenderData(),i,o,s,null)}_createMouseTarget(t,e){let o=t.target;if(!this.viewHelper.viewDomNode.contains(o)){const e=dom.getShadowRoot(this.viewHelper.viewDomNode);e&&(o=e.elementsFromPoint(t.posx,t.posy).find((t=>this.viewHelper.viewDomNode.contains(t))))}return this.mouseTargetFactory.createMouseTarget(this.viewHelper.getLastRenderData(),t.editorPos,t.pos,t.relativePos,e?o:null)}_getMouseColumn(t){return this.mouseTargetFactory.getMouseColumn(t.relativePos)}_onContextMenu(t,e){this.viewController.emitContextMenu({event:t,target:this._createMouseTarget(t,e)})}_onMouseMove(t){this.mouseTargetFactory.mouseTargetIsWidget(t)||t.preventDefault(),this._mouseDownOperation.isActive()||t.timestamp<this.lastMouseLeaveTime||this.viewController.emitMouseMove({event:t,target:this._createMouseTarget(t,!0)})}_onMouseLeave(t){this._mouseLeaveMonitor&&(this._mouseLeaveMonitor.dispose(),this._mouseLeaveMonitor=null),this.lastMouseLeaveTime=(new Date).getTime(),this.viewController.emitMouseLeave({event:t,target:null})}_onMouseUp(t){this.viewController.emitMouseUp({event:t,target:this._createMouseTarget(t,!0)})}_onMouseDown(t,e){const o=this._createMouseTarget(t,!0),i=6===o.type||7===o.type,s=2===o.type||3===o.type||4===o.type,n=3===o.type,r=this._context.configuration.options.get(103),a=8===o.type||5===o.type,u=9===o.type;let h=t.leftButton||t.middleButton;platform.isMacintosh&&t.leftButton&&t.ctrlKey&&(h=!1);const l=()=>{t.preventDefault(),this.viewHelper.focusTextArea()};if(h&&(i||n&&r))l(),this._mouseDownOperation.start(o.type,t,e);else if(s)t.preventDefault();else if(a){const i=o.detail;h&&this.viewHelper.shouldSuppressMouseDownOnViewZone(i.viewZoneId)&&(l(),this._mouseDownOperation.start(o.type,t,e),t.preventDefault())}else u&&this.viewHelper.shouldSuppressMouseDownOnWidget(o.detail)&&(l(),t.preventDefault());this.viewController.emitMouseDown({event:t,target:o})}}class MouseDownOperation extends Disposable{constructor(t,e,o,i,s,n){super(),this._context=t,this._viewController=e,this._viewHelper=o,this._mouseTargetFactory=i,this._createMouseTarget=s,this._getMouseColumn=n,this._mouseMoveMonitor=this._register(new GlobalEditorPointerMoveMonitor(this._viewHelper.viewDomNode)),this._topBottomDragScrolling=this._register(new TopBottomDragScrolling(this._context,this._viewHelper,this._mouseTargetFactory,((t,e,o)=>this._dispatchMouse(t,e,o)))),this._mouseState=new MouseDownState,this._currentSelection=new Selection(1,1,1,1),this._isActive=!1,this._lastMouseEvent=null}dispose(){super.dispose()}isActive(){return this._isActive}_onMouseDownThenMove(t){this._lastMouseEvent=t,this._mouseState.setModifiers(t);const e=this._findMousePosition(t,!1);e&&(this._mouseState.isDragAndDrop?this._viewController.emitMouseDrag({event:t,target:e}):13!==e.type||"above"!==e.outsidePosition&&"below"!==e.outsidePosition?(this._topBottomDragScrolling.stop(),this._dispatchMouse(e,!0,1)):this._topBottomDragScrolling.start(e,t))}start(t,e,o){this._lastMouseEvent=e,this._mouseState.setStartedOnLineNumbers(3===t),this._mouseState.setStartButtons(e),this._mouseState.setModifiers(e);const i=this._findMousePosition(e,!0);if(!i||!i.position)return;this._mouseState.trySetCount(e.detail,i.position),e.detail=this._mouseState.count;const s=this._context.configuration.options;if(!s.get(86)&&s.get(32)&&!s.get(19)&&!this._mouseState.altKey&&e.detail<2&&!this._isActive&&!this._currentSelection.isEmpty()&&6===i.type&&i.position&&this._currentSelection.containsPosition(i.position))return this._mouseState.isDragAndDrop=!0,this._isActive=!0,void this._mouseMoveMonitor.startMonitoring(this._viewHelper.viewLinesDomNode,o,e.buttons,(t=>this._onMouseDownThenMove(t)),(t=>{const e=this._findMousePosition(this._lastMouseEvent,!1);t&&t instanceof KeyboardEvent?this._viewController.emitMouseDropCanceled():this._viewController.emitMouseDrop({event:this._lastMouseEvent,target:e?this._createMouseTarget(this._lastMouseEvent,!0):null}),this._stop()}));this._mouseState.isDragAndDrop=!1,this._dispatchMouse(i,e.shiftKey,1),this._isActive||(this._isActive=!0,this._mouseMoveMonitor.startMonitoring(this._viewHelper.viewLinesDomNode,o,e.buttons,(t=>this._onMouseDownThenMove(t)),(()=>this._stop())))}_stop(){this._isActive=!1,this._topBottomDragScrolling.stop()}onHeightChanged(){this._mouseMoveMonitor.stopMonitoring()}onPointerUp(){this._mouseMoveMonitor.stopMonitoring()}onCursorStateChanged(t){this._currentSelection=t.selections[0]}_getPositionOutsideEditor(t){const e=t.editorPos,o=this._context.viewModel,i=this._context.viewLayout,s=this._getMouseColumn(t);if(t.posy<e.y){const o=e.y-t.posy,n=Math.max(i.getCurrentScrollTop()-o,0),r=HitTestContext.getZoneAtCoord(this._context,n);if(r){const t=this._helpPositionJumpOverViewZone(r);if(t)return MouseTarget.createOutsideEditor(s,t,"above",o)}const a=i.getLineNumberAtVerticalOffset(n);return MouseTarget.createOutsideEditor(s,new Position(a,1),"above",o)}if(t.posy>e.y+e.height){const n=t.posy-e.y-e.height,r=i.getCurrentScrollTop()+t.relativePos.y,a=HitTestContext.getZoneAtCoord(this._context,r);if(a){const t=this._helpPositionJumpOverViewZone(a);if(t)return MouseTarget.createOutsideEditor(s,t,"below",n)}const u=i.getLineNumberAtVerticalOffset(r);return MouseTarget.createOutsideEditor(s,new Position(u,o.getLineMaxColumn(u)),"below",n)}const n=i.getLineNumberAtVerticalOffset(i.getCurrentScrollTop()+t.relativePos.y);if(t.posx<e.x){const o=e.x-t.posx;return MouseTarget.createOutsideEditor(s,new Position(n,1),"left",o)}if(t.posx>e.x+e.width){const i=t.posx-e.x-e.width;return MouseTarget.createOutsideEditor(s,new Position(n,o.getLineMaxColumn(n)),"right",i)}return null}_findMousePosition(t,e){const o=this._getPositionOutsideEditor(t);if(o)return o;const i=this._createMouseTarget(t,e);if(!i.position)return null;if(8===i.type||5===i.type){const t=this._helpPositionJumpOverViewZone(i.detail);if(t)return MouseTarget.createViewZone(i.type,i.element,i.mouseColumn,t,i.detail)}return i}_helpPositionJumpOverViewZone(t){const e=new Position(this._currentSelection.selectionStartLineNumber,this._currentSelection.selectionStartColumn),o=t.positionBefore,i=t.positionAfter;return o&&i?o.isBefore(e)?o:i:null}_dispatchMouse(t,e,o){t.position&&this._viewController.dispatchMouse({position:t.position,mouseColumn:t.mouseColumn,startedOnLineNumbers:this._mouseState.startedOnLineNumbers,revealType:o,inSelectionMode:e,mouseDownCount:this._mouseState.count,altKey:this._mouseState.altKey,ctrlKey:this._mouseState.ctrlKey,metaKey:this._mouseState.metaKey,shiftKey:this._mouseState.shiftKey,leftButton:this._mouseState.leftButton,middleButton:this._mouseState.middleButton,onInjectedText:6===t.type&&null!==t.detail.injectedText})}}class TopBottomDragScrolling extends Disposable{constructor(t,e,o,i){super(),this._context=t,this._viewHelper=e,this._mouseTargetFactory=o,this._dispatchMouse=i,this._operation=null}dispose(){super.dispose(),this.stop()}start(t,e){this._operation?this._operation.setPosition(t,e):this._operation=new TopBottomDragScrollingOperation(this._context,this._viewHelper,this._mouseTargetFactory,this._dispatchMouse,t,e)}stop(){this._operation&&(this._operation.dispose(),this._operation=null)}}class TopBottomDragScrollingOperation extends Disposable{constructor(t,e,o,i,s,n){super(),this._context=t,this._viewHelper=e,this._mouseTargetFactory=o,this._dispatchMouse=i,this._position=s,this._mouseEvent=n,this._lastTime=Date.now(),this._animationFrameDisposable=dom.scheduleAtNextAnimationFrame((()=>this._execute()))}dispose(){this._animationFrameDisposable.dispose()}setPosition(t,e){this._position=t,this._mouseEvent=e}_tick(){const t=Date.now(),e=t-this._lastTime;return this._lastTime=t,e}_getScrollSpeed(){const t=this._context.configuration.options.get(63),e=this._context.configuration.options.get(138).height/t,o=this._position.outsideDistance/t;return o<=1.5?Math.max(30,e*(1+o)):o<=3?Math.max(60,e*(2+o)):Math.max(200,e*(7+o))}_execute(){const t=this._context.configuration.options.get(63),e=this._getScrollSpeed()*(this._tick()/1e3)*t,o="above"===this._position.outsidePosition?-e:e;this._context.viewModel.viewLayout.deltaScrollNow(0,o),this._viewHelper.renderNow();const i=this._context.viewLayout.getLinesViewportData(),s="above"===this._position.outsidePosition?i.startLineNumber:i.endLineNumber;let n;{const t=createEditorPagePosition(this._viewHelper.viewDomNode),e=this._context.configuration.options.get(138).horizontalScrollbarHeight,o=new PageCoordinates(this._mouseEvent.pos.x,t.y+t.height-e-.1),i=createCoordinatesRelativeToEditor(this._viewHelper.viewDomNode,t,o);n=this._mouseTargetFactory.createMouseTarget(this._viewHelper.getLastRenderData(),t,o,i,null)}n.position&&n.position.lineNumber===s||(n="above"===this._position.outsidePosition?MouseTarget.createOutsideEditor(this._position.mouseColumn,new Position(s,1),"above",this._position.outsideDistance):MouseTarget.createOutsideEditor(this._position.mouseColumn,new Position(s,this._context.viewModel.getLineMaxColumn(s)),"below",this._position.outsideDistance)),this._dispatchMouse(n,!0,2),this._animationFrameDisposable=dom.scheduleAtNextAnimationFrame((()=>this._execute()))}}class MouseDownState{get altKey(){return this._altKey}get ctrlKey(){return this._ctrlKey}get metaKey(){return this._metaKey}get shiftKey(){return this._shiftKey}get leftButton(){return this._leftButton}get middleButton(){return this._middleButton}get startedOnLineNumbers(){return this._startedOnLineNumbers}constructor(){this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._leftButton=!1,this._middleButton=!1,this._startedOnLineNumbers=!1,this._lastMouseDownPosition=null,this._lastMouseDownPositionEqualCount=0,this._lastMouseDownCount=0,this._lastSetMouseDownCountTime=0,this.isDragAndDrop=!1}get count(){return this._lastMouseDownCount}setModifiers(t){this._altKey=t.altKey,this._ctrlKey=t.ctrlKey,this._metaKey=t.metaKey,this._shiftKey=t.shiftKey}setStartButtons(t){this._leftButton=t.leftButton,this._middleButton=t.middleButton}setStartedOnLineNumbers(t){this._startedOnLineNumbers=t}trySetCount(t,e){const o=(new Date).getTime();o-this._lastSetMouseDownCountTime>MouseDownState.CLEAR_MOUSE_DOWN_COUNT_TIME&&(t=1),this._lastSetMouseDownCountTime=o,t>this._lastMouseDownCount+1&&(t=this._lastMouseDownCount+1),this._lastMouseDownPosition&&this._lastMouseDownPosition.equals(e)?this._lastMouseDownPositionEqualCount++:this._lastMouseDownPositionEqualCount=1,this._lastMouseDownPosition=e,this._lastMouseDownCount=Math.min(t,this._lastMouseDownPositionEqualCount)}}MouseDownState.CLEAR_MOUSE_DOWN_COUNT_TIME=400;