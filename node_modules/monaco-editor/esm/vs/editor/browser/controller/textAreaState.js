import*as strings from"../../../base/common/strings.js";import{Range}from"../../common/core/range.js";export const _debugComposition=!1;class TextAreaState{constructor(e,t,n,i,s){this.value=e,this.selectionStart=t,this.selectionEnd=n,this.selection=i,this.newlineCountBeforeSelection=s}toString(){return`[ <${this.value}>, selectionStart: ${this.selectionStart}, selectionEnd: ${this.selectionEnd}]`}static readFromTextArea(e,t){const n=e.getValue(),i=e.getSelectionStart(),s=e.getSelectionEnd();let o;return t&&n.substring(0,i)===t.value.substring(0,t.selectionStart)&&(o=t.newlineCountBeforeSelection),new TextAreaState(n,i,s,null,o)}collapseSelection(){return this.selectionStart===this.value.length?this:new TextAreaState(this.value,this.value.length,this.value.length,null,void 0)}writeToTextArea(e,t,n){t.setValue(e,this.value),n&&t.setSelectionRange(e,this.selectionStart,this.selectionEnd)}deduceEditorPosition(e){var t,n,i,s,o,r,a,l;if(e<=this.selectionStart){const i=this.value.substring(e,this.selectionStart);return this._finishDeduceEditorPosition(null!==(n=null===(t=this.selection)||void 0===t?void 0:t.getStartPosition())&&void 0!==n?n:null,i,-1)}if(e>=this.selectionEnd){const t=this.value.substring(this.selectionEnd,e);return this._finishDeduceEditorPosition(null!==(s=null===(i=this.selection)||void 0===i?void 0:i.getEndPosition())&&void 0!==s?s:null,t,1)}const g=this.value.substring(this.selectionStart,e);if(-1===g.indexOf(String.fromCharCode(8230)))return this._finishDeduceEditorPosition(null!==(r=null===(o=this.selection)||void 0===o?void 0:o.getStartPosition())&&void 0!==r?r:null,g,1);const u=this.value.substring(e,this.selectionEnd);return this._finishDeduceEditorPosition(null!==(l=null===(a=this.selection)||void 0===a?void 0:a.getEndPosition())&&void 0!==l?l:null,u,-1)}_finishDeduceEditorPosition(e,t,n){let i=0,s=-1;for(;-1!==(s=t.indexOf("\n",s+1));)i++;return[e,n*t.length,i]}static deduceInput(e,t,n){if(!e)return{text:"",replacePrevCharCnt:0,replaceNextCharCnt:0,positionDelta:0};const i=Math.min(strings.commonPrefixLength(e.value,t.value),e.selectionStart,t.selectionStart),s=Math.min(strings.commonSuffixLength(e.value,t.value),e.value.length-e.selectionEnd,t.value.length-t.selectionEnd),o=(e.value.substring(i,e.value.length-s),t.value.substring(i,t.value.length-s)),r=e.selectionStart-i,a=e.selectionEnd-i;if(t.selectionStart-i===t.selectionEnd-i){return{text:o,replacePrevCharCnt:e.selectionStart-i,replaceNextCharCnt:0,positionDelta:0}}return{text:o,replacePrevCharCnt:a-r,replaceNextCharCnt:0,positionDelta:0}}static deduceAndroidCompositionInput(e,t){if(!e)return{text:"",replacePrevCharCnt:0,replaceNextCharCnt:0,positionDelta:0};if(e.value===t.value)return{text:"",replacePrevCharCnt:0,replaceNextCharCnt:0,positionDelta:t.selectionEnd-e.selectionEnd};const n=Math.min(strings.commonPrefixLength(e.value,t.value),e.selectionEnd),i=Math.min(strings.commonSuffixLength(e.value,t.value),e.value.length-e.selectionEnd),s=e.value.substring(n,e.value.length-i),o=t.value.substring(n,t.value.length-i),r=(e.selectionStart,e.selectionEnd-n),a=(t.selectionStart,t.selectionEnd-n);return{text:o,replacePrevCharCnt:r,replaceNextCharCnt:s.length-r,positionDelta:a-o.length}}}TextAreaState.EMPTY=new TextAreaState("",0,0,null,void 0);export{TextAreaState};export class PagedScreenReaderStrategy{static _getPageOfLine(e,t){return Math.floor((e-1)/t)}static _getRangeForPage(e,t){const n=e*t;return new Range(n+1,1,n+t+1,1)}static fromEditorSelection(e,t,n,i){const s=500,o=PagedScreenReaderStrategy._getPageOfLine(t.startLineNumber,n),r=PagedScreenReaderStrategy._getRangeForPage(o,n),a=PagedScreenReaderStrategy._getPageOfLine(t.endLineNumber,n),l=PagedScreenReaderStrategy._getRangeForPage(a,n);let g=r.intersectRanges(new Range(1,1,t.startLineNumber,t.startColumn));if(i&&e.getValueLengthInRange(g,1)>s){const t=e.modifyPosition(g.getEndPosition(),-500);g=Range.fromPositions(t,g.getEndPosition())}const u=e.getValueInRange(g,1),c=e.getLineCount(),h=e.getLineMaxColumn(c);let d=l.intersectRanges(new Range(t.endLineNumber,t.endColumn,c,h));if(i&&e.getValueLengthInRange(d,1)>s){const t=e.modifyPosition(d.getStartPosition(),s);d=Range.fromPositions(d.getStartPosition(),t)}const v=e.getValueInRange(d,1);let S;if(o===a||o+1===a)S=e.getValueInRange(t,1);else{const n=r.intersectRanges(t),i=l.intersectRanges(t);S=e.getValueInRange(n,1)+String.fromCharCode(8230)+e.getValueInRange(i,1)}return i&&S.length>1e3&&(S=S.substring(0,s)+String.fromCharCode(8230)+S.substring(S.length-s,S.length)),new TextAreaState(u+S+v,u.length,u.length+S.length,t,g.endLineNumber-g.startLineNumber)}}