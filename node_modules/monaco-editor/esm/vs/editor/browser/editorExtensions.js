import*as nls from"../../nls.js";import{URI}from"../../base/common/uri.js";import{ICodeEditorService}from"./services/codeEditorService.js";import{Position}from"../common/core/position.js";import{IModelService}from"../common/services/model.js";import{ITextModelService}from"../common/services/resolverService.js";import{MenuId,MenuRegistry,Action2}from"../../platform/actions/common/actions.js";import{CommandsRegistry}from"../../platform/commands/common/commands.js";import{ContextKeyExpr,IContextKeyService}from"../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../platform/instantiation/common/instantiation.js";import{KeybindingsRegistry}from"../../platform/keybinding/common/keybindingsRegistry.js";import{Registry}from"../../platform/registry/common/platform.js";import{ITelemetryService}from"../../platform/telemetry/common/telemetry.js";import{withNullAsUndefined,assertType}from"../../base/common/types.js";import{ILogService}from"../../platform/log/common/log.js";export class Command{constructor(t){this.id=t.id,this.precondition=t.precondition,this._kbOpts=t.kbOpts,this._menuOpts=t.menuOpts,this._description=t.description}register(){if(Array.isArray(this._menuOpts)?this._menuOpts.forEach(this._registerMenuItem,this):this._menuOpts&&this._registerMenuItem(this._menuOpts),this._kbOpts){const t=Array.isArray(this._kbOpts)?this._kbOpts:[this._kbOpts];for(const i of t){let t=i.kbExpr;this.precondition&&(t=t?ContextKeyExpr.and(t,this.precondition):this.precondition);const e={id:this.id,weight:i.weight,args:i.args,when:t,primary:i.primary,secondary:i.secondary,win:i.win,linux:i.linux,mac:i.mac};KeybindingsRegistry.registerKeybindingRule(e)}}CommandsRegistry.registerCommand({id:this.id,handler:(t,i)=>this.runCommand(t,i),description:this._description})}_registerMenuItem(t){MenuRegistry.appendMenuItem(t.menuId,{group:t.group,command:{id:this.id,title:t.title,icon:t.icon,precondition:this.precondition},when:t.when,order:t.order})}}export class MultiCommand extends Command{constructor(){super(...arguments),this._implementations=[]}addImplementation(t,i,e){return this._implementations.push({priority:t,name:i,implementation:e}),this._implementations.sort(((t,i)=>i.priority-t.priority)),{dispose:()=>{for(let t=0;t<this._implementations.length;t++)if(this._implementations[t].implementation===e)return void this._implementations.splice(t,1)}}}runCommand(t,i){const e=t.get(ILogService);e.trace(`Executing Command '${this.id}' which has ${this._implementations.length} bound.`);for(const o of this._implementations){const n=o.implementation(t,i);if(n){if(e.trace(`Command '${this.id}' was handled by '${o.name}'.`),"boolean"==typeof n)return;return n}}e.trace(`The Command '${this.id}' was not handled by any implementation.`)}}export class ProxyCommand extends Command{constructor(t,i){super(i),this.command=t}runCommand(t,i){return this.command.runCommand(t,i)}}export class EditorCommand extends Command{static bindToContribution(t){return class extends EditorCommand{constructor(t){super(t),this._callback=t.handler}runEditorCommand(i,e,o){const n=t(e);n&&this._callback(n,o)}}}static runEditorCommand(t,i,e,o){const n=t.get(ICodeEditorService),r=n.getFocusedCodeEditor()||n.getActiveCodeEditor();if(r)return r.invokeWithinContext((t=>{if(t.get(IContextKeyService).contextMatchesRules(withNullAsUndefined(e)))return o(t,r,i)}))}runCommand(t,i){return EditorCommand.runEditorCommand(t,i,this.precondition,((t,i,e)=>this.runEditorCommand(t,i,e)))}}export class EditorAction extends EditorCommand{static convertOptions(t){let i;function e(i){return i.menuId||(i.menuId=MenuId.EditorContext),i.title||(i.title=t.label),i.when=ContextKeyExpr.and(t.precondition,i.when),i}return i=Array.isArray(t.menuOpts)?t.menuOpts:t.menuOpts?[t.menuOpts]:[],Array.isArray(t.contextMenuOpts)?i.push(...t.contextMenuOpts.map(e)):t.contextMenuOpts&&i.push(e(t.contextMenuOpts)),t.menuOpts=i,t}constructor(t){super(EditorAction.convertOptions(t)),this.label=t.label,this.alias=t.alias}runEditorCommand(t,i,e){return this.reportTelemetry(t,i),this.run(t,i,e||{})}reportTelemetry(t,i){t.get(ITelemetryService).publicLog2("editorActionInvoked",{name:this.label,id:this.id})}}export class MultiEditorAction extends EditorAction{constructor(){super(...arguments),this._implementations=[]}addImplementation(t,i){return this._implementations.push([t,i]),this._implementations.sort(((t,i)=>i[0]-t[0])),{dispose:()=>{for(let t=0;t<this._implementations.length;t++)if(this._implementations[t][1]===i)return void this._implementations.splice(t,1)}}}run(t,i,e){for(const o of this._implementations){const n=o[1](t,i,e);if(n){if("boolean"==typeof n)return;return n}}}}export class EditorAction2 extends Action2{run(t,...i){const e=t.get(ICodeEditorService),o=e.getFocusedCodeEditor()||e.getActiveCodeEditor();if(o)return o.invokeWithinContext((t=>{if(t.get(IContextKeyService).contextMatchesRules(withNullAsUndefined(this.desc.precondition)))return this.runEditorCommand(t,o,...i)}))}}export function registerModelAndPositionCommand(t,i){CommandsRegistry.registerCommand(t,(function(t,...e){const o=t.get(IInstantiationService),[n,r]=e;assertType(URI.isUri(n)),assertType(Position.isIPosition(r));const s=t.get(IModelService).getModel(n);if(s){const t=Position.lift(r);return o.invokeFunction(i,s,t,...e.slice(2))}return t.get(ITextModelService).createModelReference(n).then((t=>new Promise(((n,s)=>{try{n(o.invokeFunction(i,t.object.textEditorModel,Position.lift(r),e.slice(2)))}catch(t){s(t)}})).finally((()=>{t.dispose()}))))}))}export function registerEditorCommand(t){return EditorContributionRegistry.INSTANCE.registerEditorCommand(t),t}export function registerEditorAction(t){const i=new t;return EditorContributionRegistry.INSTANCE.registerEditorAction(i),i}export function registerMultiEditorAction(t){return EditorContributionRegistry.INSTANCE.registerEditorAction(t),t}export function registerInstantiatedEditorAction(t){EditorContributionRegistry.INSTANCE.registerEditorAction(t)}export function registerEditorContribution(t,i,e){EditorContributionRegistry.INSTANCE.registerEditorContribution(t,i,e)}export var EditorExtensionsRegistry;!function(t){t.getEditorCommand=function(t){return EditorContributionRegistry.INSTANCE.getEditorCommand(t)},t.getEditorActions=function(){return EditorContributionRegistry.INSTANCE.getEditorActions()},t.getEditorContributions=function(){return EditorContributionRegistry.INSTANCE.getEditorContributions()},t.getSomeEditorContributions=function(t){return EditorContributionRegistry.INSTANCE.getEditorContributions().filter((i=>t.indexOf(i.id)>=0))},t.getDiffEditorContributions=function(){return EditorContributionRegistry.INSTANCE.getDiffEditorContributions()}}(EditorExtensionsRegistry||(EditorExtensionsRegistry={}));const Extensions={EditorCommonContributions:"editor.contributions"};class EditorContributionRegistry{constructor(){this.editorContributions=[],this.diffEditorContributions=[],this.editorActions=[],this.editorCommands=Object.create(null)}registerEditorContribution(t,i,e){this.editorContributions.push({id:t,ctor:i,instantiation:e})}getEditorContributions(){return this.editorContributions.slice(0)}getDiffEditorContributions(){return this.diffEditorContributions.slice(0)}registerEditorAction(t){t.register(),this.editorActions.push(t)}getEditorActions(){return this.editorActions}registerEditorCommand(t){t.register(),this.editorCommands[t.id]=t}getEditorCommand(t){return this.editorCommands[t]||null}}function registerCommand(t){return t.register(),t}EditorContributionRegistry.INSTANCE=new EditorContributionRegistry,Registry.add(Extensions.EditorCommonContributions,EditorContributionRegistry.INSTANCE);export const UndoCommand=registerCommand(new MultiCommand({id:"undo",precondition:void 0,kbOpts:{weight:0,primary:2104},menuOpts:[{menuId:MenuId.MenubarEditMenu,group:"1_do",title:nls.localize({key:"miUndo",comment:["&& denotes a mnemonic"]},"&&Undo"),order:1},{menuId:MenuId.CommandPalette,group:"",title:nls.localize("undo","Undo"),order:1}]}));registerCommand(new ProxyCommand(UndoCommand,{id:"default:undo",precondition:void 0}));export const RedoCommand=registerCommand(new MultiCommand({id:"redo",precondition:void 0,kbOpts:{weight:0,primary:2103,secondary:[3128],mac:{primary:3128}},menuOpts:[{menuId:MenuId.MenubarEditMenu,group:"1_do",title:nls.localize({key:"miRedo",comment:["&& denotes a mnemonic"]},"&&Redo"),order:2},{menuId:MenuId.CommandPalette,group:"",title:nls.localize("redo","Redo"),order:1}]}));registerCommand(new ProxyCommand(RedoCommand,{id:"default:redo",precondition:void 0}));export const SelectAllCommand=registerCommand(new MultiCommand({id:"editor.action.selectAll",precondition:void 0,kbOpts:{weight:0,kbExpr:null,primary:2079},menuOpts:[{menuId:MenuId.MenubarSelectionMenu,group:"1_basic",title:nls.localize({key:"miSelectAll",comment:["&& denotes a mnemonic"]},"&&Select All"),order:1},{menuId:MenuId.CommandPalette,group:"",title:nls.localize("selectAll","Select All"),order:1}]}));