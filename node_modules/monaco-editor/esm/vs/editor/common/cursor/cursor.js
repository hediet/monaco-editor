import{onUnexpectedError}from"../../../base/common/errors.js";import*as strings from"../../../base/common/strings.js";import{CursorCollection}from"./cursorCollection.js";import{CursorState,EditOperationResult}from"../cursorCommon.js";import{CursorContext}from"./cursorContext.js";import{DeleteOperations}from"./cursorDeleteOperations.js";import{CompositionOutcome,TypeOperations,TypeWithAutoClosingCommand}from"./cursorTypeOperations.js";import{Range}from"../core/range.js";import{Selection}from"../core/selection.js";import{ModelInjectedTextChangedEvent}from"../textModelEvents.js";import{ViewCursorStateChangedEvent,ViewRevealRangeRequestEvent}from"../viewEvents.js";import{dispose,Disposable}from"../../../base/common/lifecycle.js";import{CursorStateChangedEvent}from"../viewModelEventDispatcher.js";export class CursorsController extends Disposable{constructor(t,e,o,s){super(),this._model=t,this._knownModelVersionId=this._model.getVersionId(),this._viewModel=e,this._coordinatesConverter=o,this.context=new CursorContext(this._model,this._viewModel,this._coordinatesConverter,s),this._cursors=new CursorCollection(this.context),this._hasFocus=!1,this._isHandling=!1,this._compositionState=null,this._columnSelectData=null,this._autoClosedActions=[],this._prevEditOperationType=0}dispose(){this._cursors.dispose(),this._autoClosedActions=dispose(this._autoClosedActions),super.dispose()}updateConfiguration(t){this.context=new CursorContext(this._model,this._viewModel,this._coordinatesConverter,t),this._cursors.updateContext(this.context)}onLineMappingChanged(t){this._knownModelVersionId===this._model.getVersionId()&&this.setStates(t,"viewModel",0,this.getCursorStates())}setHasFocus(t){this._hasFocus=t}_validateAutoClosedActions(){if(this._autoClosedActions.length>0){const t=this._cursors.getSelections();for(let e=0;e<this._autoClosedActions.length;e++){const o=this._autoClosedActions[e];o.isValid(t)||(o.dispose(),this._autoClosedActions.splice(e,1),e--)}}}getPrimaryCursorState(){return this._cursors.getPrimaryCursor()}getLastAddedCursorIndex(){return this._cursors.getLastAddedCursorIndex()}getCursorStates(){return this._cursors.getAll()}setStates(t,e,o,s){let i=!1;const n=this.context.cursorConfig.multiCursorLimit;null!==s&&s.length>n&&(s=s.slice(0,n),i=!0);const r=CursorModelState.from(this._model,this);return this._cursors.setStates(s),this._cursors.normalize(),this._columnSelectData=null,this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(t,e,o,r,i)}setCursorColumnSelectData(t){this._columnSelectData=t}revealPrimary(t,e,o,s,i,n){const r=this._cursors.getViewPositions();let a=null,l=null;r.length>1?l=this._cursors.getViewSelections():a=Range.fromPositions(r[0],r[0]),t.emitViewEvent(new ViewRevealRangeRequestEvent(e,o,a,l,s,i,n))}saveState(){const t=[],e=this._cursors.getSelections();for(let o=0,s=e.length;o<s;o++){const s=e[o];t.push({inSelectionMode:!s.isEmpty(),selectionStart:{lineNumber:s.selectionStartLineNumber,column:s.selectionStartColumn},position:{lineNumber:s.positionLineNumber,column:s.positionColumn}})}return t}restoreState(t,e){const o=[];for(let t=0,s=e.length;t<s;t++){const s=e[t];let i=1,n=1;s.position&&s.position.lineNumber&&(i=s.position.lineNumber),s.position&&s.position.column&&(n=s.position.column);let r=i,a=n;s.selectionStart&&s.selectionStart.lineNumber&&(r=s.selectionStart.lineNumber),s.selectionStart&&s.selectionStart.column&&(a=s.selectionStart.column),o.push({selectionStartLineNumber:r,selectionStartColumn:a,positionLineNumber:i,positionColumn:n})}this.setStates(t,"restoreState",0,CursorState.fromModelSelections(o)),this.revealPrimary(t,"restoreState",!1,0,!0,1)}onModelContentChanged(t,e){if(e instanceof ModelInjectedTextChangedEvent){if(this._isHandling)return;this._isHandling=!0;try{this.setStates(t,"modelChange",0,this.getCursorStates())}finally{this._isHandling=!1}}else{const o=e.rawContentChangedEvent;if(this._knownModelVersionId=o.versionId,this._isHandling)return;const s=o.containsEvent(1);if(this._prevEditOperationType=0,s)this._cursors.dispose(),this._cursors=new CursorCollection(this.context),this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(t,"model",1,null,!1);else if(this._hasFocus&&o.resultingSelection&&o.resultingSelection.length>0){const e=CursorState.fromModelSelections(o.resultingSelection);this.setStates(t,"modelChange",o.isUndoing?5:o.isRedoing?6:2,e)&&this.revealPrimary(t,"modelChange",!1,0,!0,0)}else{const e=this._cursors.readSelectionFromMarkers();this.setStates(t,"modelChange",2,CursorState.fromModelSelections(e))}}}getSelection(){return this._cursors.getPrimaryCursor().modelState.selection}getTopMostViewPosition(){return this._cursors.getTopMostViewPosition()}getBottomMostViewPosition(){return this._cursors.getBottomMostViewPosition()}getCursorColumnSelectData(){if(this._columnSelectData)return this._columnSelectData;const t=this._cursors.getPrimaryCursor(),e=t.viewState.selectionStart.getStartPosition(),o=t.viewState.position;return{isReal:!1,fromViewLineNumber:e.lineNumber,fromViewVisualColumn:this.context.cursorConfig.visibleColumnFromColumn(this._viewModel,e),toViewLineNumber:o.lineNumber,toViewVisualColumn:this.context.cursorConfig.visibleColumnFromColumn(this._viewModel,o)}}getSelections(){return this._cursors.getSelections()}setSelections(t,e,o,s){this.setStates(t,e,s,CursorState.fromModelSelections(o))}getPrevEditOperationType(){return this._prevEditOperationType}setPrevEditOperationType(t){this._prevEditOperationType=t}_pushAutoClosedAction(t,e){const o=[],s=[];for(let i=0,n=t.length;i<n;i++)o.push({range:t[i],options:{description:"auto-closed-character",inlineClassName:"auto-closed-character",stickiness:1}}),s.push({range:e[i],options:{description:"auto-closed-enclosing",stickiness:1}});const i=this._model.deltaDecorations([],o),n=this._model.deltaDecorations([],s);this._autoClosedActions.push(new AutoClosedAction(this._model,i,n))}_executeEditOperation(t){if(!t)return;t.shouldPushStackElementBefore&&this._model.pushStackElement();const e=CommandExecutor.executeCommands(this._model,this._cursors.getSelections(),t.commands);if(e){this._interpretCommandResult(e);const o=[],s=[];for(let e=0;e<t.commands.length;e++){const i=t.commands[e];i instanceof TypeWithAutoClosingCommand&&i.enclosingRange&&i.closeCharacterRange&&(o.push(i.closeCharacterRange),s.push(i.enclosingRange))}o.length>0&&this._pushAutoClosedAction(o,s),this._prevEditOperationType=t.type}t.shouldPushStackElementAfter&&this._model.pushStackElement()}_interpretCommandResult(t){t&&0!==t.length||(t=this._cursors.readSelectionFromMarkers()),this._columnSelectData=null,this._cursors.setSelections(t),this._cursors.normalize()}_emitStateChangedIfNecessary(t,e,o,s,i){const n=CursorModelState.from(this._model,this);if(n.equals(s))return!1;const r=this._cursors.getSelections(),a=this._cursors.getViewSelections();if(t.emitViewEvent(new ViewCursorStateChangedEvent(a,r,o)),!s||s.cursorState.length!==n.cursorState.length||n.cursorState.some(((t,e)=>!t.modelState.equals(s.cursorState[e].modelState)))){const a=s?s.cursorState.map((t=>t.modelState.selection)):null,l=s?s.modelVersionId:0;t.emitOutgoingEvent(new CursorStateChangedEvent(a,r,l,n.modelVersionId,e||"keyboard",o,i))}return!0}_findAutoClosingPairs(t){if(!t.length)return null;const e=[];for(let o=0,s=t.length;o<s;o++){const s=t[o];if(!s.text||s.text.indexOf("\n")>=0)return null;const i=s.text.match(/([)\]}>'"`])([^)\]}>'"`]*)$/);if(!i)return null;const n=i[1],r=this.context.cursorConfig.autoClosingPairs.autoClosingPairsCloseSingleChar.get(n);if(!r||1!==r.length)return null;const a=r[0].open,l=s.text.length-i[2].length-1,c=s.text.lastIndexOf(a,l-1);if(-1===c)return null;e.push([c,l])}return e}executeEdits(t,e,o,s){let i=null;"snippet"===e&&(i=this._findAutoClosingPairs(o)),i&&(o[0]._isTracked=!0);const n=[],r=[],a=this._model.pushEditOperations(this.getSelections(),o,(t=>{if(i)for(let e=0,o=i.length;e<o;e++){const[o,s]=i[e],a=t[e],l=a.range.startLineNumber,c=a.range.startColumn-1+o,u=a.range.startColumn-1+s;n.push(new Range(l,u+1,l,u+2)),r.push(new Range(l,c+1,l,u+2))}const e=s(t);return e&&(this._isHandling=!0),e}));a&&(this._isHandling=!1,this.setSelections(t,e,a,0)),n.length>0&&this._pushAutoClosedAction(n,r)}_executeEdit(t,e,o,s=0){if(this.context.cursorConfig.readOnly)return;const i=CursorModelState.from(this._model,this);this._cursors.stopTrackingSelections(),this._isHandling=!0;try{this._cursors.ensureValidState(),t()}catch(t){onUnexpectedError(t)}this._isHandling=!1,this._cursors.startTrackingSelections(),this._validateAutoClosedActions(),this._emitStateChangedIfNecessary(e,o,s,i,!1)&&this.revealPrimary(e,o,!1,0,!0,0)}getAutoClosedCharacters(){return AutoClosedAction.getAllAutoClosedCharacters(this._autoClosedActions)}startComposition(t){this._compositionState=new CompositionState(this._model,this.getSelections())}endComposition(t,e){const o=this._compositionState?this._compositionState.deduceOutcome(this._model,this.getSelections()):null;this._compositionState=null,this._executeEdit((()=>{"keyboard"===e&&this._executeEditOperation(TypeOperations.compositionEndWithInterceptors(this._prevEditOperationType,this.context.cursorConfig,this._model,o,this.getSelections(),this.getAutoClosedCharacters()))}),t,e)}type(t,e,o){this._executeEdit((()=>{if("keyboard"===o){const t=e.length;let o=0;for(;o<t;){const t=strings.nextCharLength(e,o),s=e.substr(o,t);this._executeEditOperation(TypeOperations.typeWithInterceptors(!!this._compositionState,this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),this.getAutoClosedCharacters(),s)),o+=t}}else this._executeEditOperation(TypeOperations.typeWithoutInterceptors(this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),e))}),t,o)}compositionType(t,e,o,s,i,n){if(0!==e.length||0!==o||0!==s)this._executeEdit((()=>{this._executeEditOperation(TypeOperations.compositionType(this._prevEditOperationType,this.context.cursorConfig,this._model,this.getSelections(),e,o,s,i))}),t,n);else if(0!==i){const e=this.getSelections().map((t=>{const e=t.getPosition();return new Selection(e.lineNumber,e.column+i,e.lineNumber,e.column+i)}));this.setSelections(t,n,e,0)}}paste(t,e,o,s,i){this._executeEdit((()=>{this._executeEditOperation(TypeOperations.paste(this.context.cursorConfig,this._model,this.getSelections(),e,o,s||[]))}),t,i,4)}cut(t,e){this._executeEdit((()=>{this._executeEditOperation(DeleteOperations.cut(this.context.cursorConfig,this._model,this.getSelections()))}),t,e)}executeCommand(t,e,o){this._executeEdit((()=>{this._cursors.killSecondaryCursors(),this._executeEditOperation(new EditOperationResult(0,[e],{shouldPushStackElementBefore:!1,shouldPushStackElementAfter:!1}))}),t,o)}executeCommands(t,e,o){this._executeEdit((()=>{this._executeEditOperation(new EditOperationResult(0,e,{shouldPushStackElementBefore:!1,shouldPushStackElementAfter:!1}))}),t,o)}}class CursorModelState{static from(t,e){return new CursorModelState(t.getVersionId(),e.getCursorStates())}constructor(t,e){this.modelVersionId=t,this.cursorState=e}equals(t){if(!t)return!1;if(this.modelVersionId!==t.modelVersionId)return!1;if(this.cursorState.length!==t.cursorState.length)return!1;for(let e=0,o=this.cursorState.length;e<o;e++)if(!this.cursorState[e].equals(t.cursorState[e]))return!1;return!0}}class AutoClosedAction{static getAllAutoClosedCharacters(t){let e=[];for(const o of t)e=e.concat(o.getAutoClosedCharactersRanges());return e}constructor(t,e,o){this._model=t,this._autoClosedCharactersDecorations=e,this._autoClosedEnclosingDecorations=o}dispose(){this._autoClosedCharactersDecorations=this._model.deltaDecorations(this._autoClosedCharactersDecorations,[]),this._autoClosedEnclosingDecorations=this._model.deltaDecorations(this._autoClosedEnclosingDecorations,[])}getAutoClosedCharactersRanges(){const t=[];for(let e=0;e<this._autoClosedCharactersDecorations.length;e++){const o=this._model.getDecorationRange(this._autoClosedCharactersDecorations[e]);o&&t.push(o)}return t}isValid(t){const e=[];for(let t=0;t<this._autoClosedEnclosingDecorations.length;t++){const o=this._model.getDecorationRange(this._autoClosedEnclosingDecorations[t]);if(o&&(e.push(o),o.startLineNumber!==o.endLineNumber))return!1}e.sort(Range.compareRangesUsingStarts),t.sort(Range.compareRangesUsingStarts);for(let o=0;o<t.length;o++){if(o>=e.length)return!1;if(!e[o].strictContainsRange(t[o]))return!1}return!0}}class CommandExecutor{static executeCommands(t,e,o){const s={model:t,selectionsBefore:e,trackedRanges:[],trackedRangesDirection:[]},i=this._innerExecuteCommands(s,o);for(let t=0,e=s.trackedRanges.length;t<e;t++)s.model._setTrackedRange(s.trackedRanges[t],null,0);return i}static _innerExecuteCommands(t,e){if(this._arrayIsEmpty(e))return null;const o=this._getEditOperations(t,e);if(0===o.operations.length)return null;const s=o.operations,i=this._getLoserCursorMap(s);if(i.hasOwnProperty("0"))return console.warn("Ignoring commands"),null;const n=[];for(let t=0,e=s.length;t<e;t++)i.hasOwnProperty(s[t].identifier.major.toString())||n.push(s[t]);o.hadTrackedEditOperation&&n.length>0&&(n[0]._isTracked=!0);let r=t.model.pushEditOperations(t.selectionsBefore,n,(o=>{const s=[];for(let e=0;e<t.selectionsBefore.length;e++)s[e]=[];for(const t of o)t.identifier&&s[t.identifier.major].push(t);const i=(t,e)=>t.identifier.minor-e.identifier.minor,n=[];for(let o=0;o<t.selectionsBefore.length;o++)s[o].length>0?(s[o].sort(i),n[o]=e[o].computeCursorState(t.model,{getInverseEditOperations:()=>s[o],getTrackedSelection:e=>{const o=parseInt(e,10),s=t.model._getTrackedRange(t.trackedRanges[o]);return 0===t.trackedRangesDirection[o]?new Selection(s.startLineNumber,s.startColumn,s.endLineNumber,s.endColumn):new Selection(s.endLineNumber,s.endColumn,s.startLineNumber,s.startColumn)}})):n[o]=t.selectionsBefore[o];return n}));r||(r=t.selectionsBefore);const a=[];for(const t in i)i.hasOwnProperty(t)&&a.push(parseInt(t,10));a.sort(((t,e)=>e-t));for(const t of a)r.splice(t,1);return r}static _arrayIsEmpty(t){for(let e=0,o=t.length;e<o;e++)if(t[e])return!1;return!0}static _getEditOperations(t,e){let o=[],s=!1;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n){const e=this._getEditOperationsFromCommand(t,i,n);o=o.concat(e.operations),s=s||e.hadTrackedEditOperation}}return{operations:o,hadTrackedEditOperation:s}}static _getEditOperationsFromCommand(t,e,o){const s=[];let i=0;const n=(t,n,r=!1)=>{Range.isEmpty(t)&&""===n||s.push({identifier:{major:e,minor:i++},range:t,text:n,forceMoveMarkers:r,isAutoWhitespaceEdit:o.insertsAutoWhitespace})};let r=!1;const a={addEditOperation:n,addTrackedEditOperation:(t,e,o)=>{r=!0,n(t,e,o)},trackSelection:(e,o)=>{const s=Selection.liftSelection(e);let i;if(s.isEmpty())if("boolean"==typeof o)i=o?2:3;else{const e=t.model.getLineMaxColumn(s.startLineNumber);i=s.startColumn===e?2:3}else i=1;const n=t.trackedRanges.length,r=t.model._setTrackedRange(null,s,i);return t.trackedRanges[n]=r,t.trackedRangesDirection[n]=s.getDirection(),n.toString()}};try{o.getEditOperations(t.model,a)}catch(t){return onUnexpectedError(t),{operations:[],hadTrackedEditOperation:!1}}return{operations:s,hadTrackedEditOperation:r}}static _getLoserCursorMap(t){(t=t.slice(0)).sort(((t,e)=>-Range.compareRangesUsingEnds(t.range,e.range)));const e={};for(let o=1;o<t.length;o++){const s=t[o-1],i=t[o];if(Range.getStartPosition(s.range).isBefore(Range.getEndPosition(i.range))){let n;n=s.identifier.major>i.identifier.major?s.identifier.major:i.identifier.major,e[n.toString()]=!0;for(let e=0;e<t.length;e++)t[e].identifier.major===n&&(t.splice(e,1),e<o&&o--,e--);o>0&&o--}}return e}}class CompositionLineState{constructor(t,e,o){this.text=t,this.startSelection=e,this.endSelection=o}}class CompositionState{static _capture(t,e){const o=[];for(const s of e){if(s.startLineNumber!==s.endLineNumber)return null;o.push(new CompositionLineState(t.getLineContent(s.startLineNumber),s.startColumn-1,s.endColumn-1))}return o}constructor(t,e){this._original=CompositionState._capture(t,e)}deduceOutcome(t,e){if(!this._original)return null;const o=CompositionState._capture(t,e);if(!o)return null;if(this._original.length!==o.length)return null;const s=[];for(let t=0,e=this._original.length;t<e;t++)s.push(CompositionState._deduceOutcome(this._original[t],o[t]));return s}static _deduceOutcome(t,e){const o=Math.min(t.startSelection,e.startSelection,strings.commonPrefixLength(t.text,e.text)),s=Math.min(t.text.length-t.endSelection,e.text.length-e.endSelection,strings.commonSuffixLength(t.text,e.text)),i=t.text.substring(o,t.text.length-s),n=e.text.substring(o,e.text.length-s);return new CompositionOutcome(i,t.startSelection-o,t.endSelection-o,n,e.startSelection-o,e.endSelection-o)}}