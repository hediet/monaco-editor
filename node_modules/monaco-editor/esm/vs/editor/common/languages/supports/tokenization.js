import{Color}from"../../../../base/common/color.js";export class ParsedTokenThemeRule{constructor(e,t,r,o,n){this._parsedThemeRuleBrand=void 0,this.token=e,this.index=t,this.fontStyle=r,this.foreground=o,this.background=n}}export function parseTokenTheme(e){if(!e||!Array.isArray(e))return[];const t=[];let r=0;for(let o=0,n=e.length;o<n;o++){const n=e[o];let s=-1;if("string"==typeof n.fontStyle){s=0;const e=n.fontStyle.split(" ");for(let t=0,r=e.length;t<r;t++)switch(e[t]){case"italic":s|=1;break;case"bold":s|=2;break;case"underline":s|=4;break;case"strikethrough":s|=8}}let i=null;"string"==typeof n.foreground&&(i=n.foreground);let l=null;"string"==typeof n.background&&(l=n.background),t[r++]=new ParsedTokenThemeRule(n.token||"",o,s,i,l)}return t}function resolveParsedTokenThemeRules(e,t){e.sort(((e,t)=>{const r=strcmp(e.token,t.token);return 0!==r?r:e.index-t.index}));let r=0,o="000000",n="ffffff";for(;e.length>=1&&""===e[0].token;){const t=e.shift();-1!==t.fontStyle&&(r=t.fontStyle),null!==t.foreground&&(o=t.foreground),null!==t.background&&(n=t.background)}const s=new ColorMap;for(const e of t)s.getId(e);const i=s.getId(o),l=s.getId(n),c=new ThemeTrieElementRule(r,i,l),h=new ThemeTrieElement(c);for(let t=0,r=e.length;t<r;t++){const r=e[t];h.insert(r.token,r.fontStyle,s.getId(r.foreground),s.getId(r.background))}return new TokenTheme(s,h)}const colorRegExp=/^#?([0-9A-Fa-f]{6})([0-9A-Fa-f]{2})?$/;export class ColorMap{constructor(){this._lastColorId=0,this._id2color=[],this._color2id=new Map}getId(e){if(null===e)return 0;const t=e.match(colorRegExp);if(!t)throw new Error("Illegal value for token color: "+e);e=t[1].toUpperCase();let r=this._color2id.get(e);return r||(r=++this._lastColorId,this._color2id.set(e,r),this._id2color[r]=Color.fromHex("#"+e),r)}getColorMap(){return this._id2color.slice(0)}}export class TokenTheme{static createFromRawTokenTheme(e,t){return this.createFromParsedTokenTheme(parseTokenTheme(e),t)}static createFromParsedTokenTheme(e,t){return resolveParsedTokenThemeRules(e,t)}constructor(e,t){this._colorMap=e,this._root=t,this._cache=new Map}getColorMap(){return this._colorMap.getColorMap()}_match(e){return this._root.match(e)}match(e,t){let r=this._cache.get(t);if(void 0===r){const e=this._match(t),o=toStandardTokenType(t);r=(e.metadata|o<<8)>>>0,this._cache.set(t,r)}return(r|e<<0)>>>0}}const STANDARD_TOKEN_TYPE_REGEXP=/\b(comment|string|regex|regexp)\b/;export function toStandardTokenType(e){const t=e.match(STANDARD_TOKEN_TYPE_REGEXP);if(!t)return 0;switch(t[1]){case"comment":return 1;case"string":return 2;case"regex":case"regexp":return 3}throw new Error("Unexpected match for standard token type!")}export function strcmp(e,t){return e<t?-1:e>t?1:0}export class ThemeTrieElementRule{constructor(e,t,r){this._themeTrieElementRuleBrand=void 0,this._fontStyle=e,this._foreground=t,this._background=r,this.metadata=(this._fontStyle<<11|this._foreground<<15|this._background<<24)>>>0}clone(){return new ThemeTrieElementRule(this._fontStyle,this._foreground,this._background)}acceptOverwrite(e,t,r){-1!==e&&(this._fontStyle=e),0!==t&&(this._foreground=t),0!==r&&(this._background=r),this.metadata=(this._fontStyle<<11|this._foreground<<15|this._background<<24)>>>0}}export class ThemeTrieElement{constructor(e){this._themeTrieElementBrand=void 0,this._mainRule=e,this._children=new Map}match(e){if(""===e)return this._mainRule;const t=e.indexOf(".");let r,o;-1===t?(r=e,o=""):(r=e.substring(0,t),o=e.substring(t+1));const n=this._children.get(r);return void 0!==n?n.match(o):this._mainRule}insert(e,t,r,o){if(""===e)return void this._mainRule.acceptOverwrite(t,r,o);const n=e.indexOf(".");let s,i;-1===n?(s=e,i=""):(s=e.substring(0,n),i=e.substring(n+1));let l=this._children.get(s);void 0===l&&(l=new ThemeTrieElement(this._mainRule.clone()),this._children.set(s,l)),l.insert(i,t,r,o)}}export function generateTokensCSSForColorMap(e){const t=[];for(let r=1,o=e.length;r<o;r++){const o=e[r];t[r]=`.mtk${r} { color: ${o}; }`}return t.push(".mtki { font-style: italic; }"),t.push(".mtkb { font-weight: bold; }"),t.push(".mtku { text-decoration: underline; text-underline-position: under; }"),t.push(".mtks { text-decoration: line-through; }"),t.push(".mtks.mtku { text-decoration: underline line-through; text-underline-position: under; }"),t.join("\n")}