import{CharacterClassifier}from"../core/characterClassifier.js";class Uint8Matrix{constructor(e,t,s){const a=new Uint8Array(e*t);for(let r=0,n=e*t;r<n;r++)a[r]=s;this._data=a,this.rows=e,this.cols=t}get(e,t){return this._data[e*this.cols+t]}set(e,t,s){this._data[e*this.cols+t]=s}}export class StateMachine{constructor(e){let t=0,s=0;for(let a=0,r=e.length;a<r;a++){const[r,n,i]=e[a];n>t&&(t=n),r>s&&(s=r),i>s&&(s=i)}t++,s++;const a=new Uint8Matrix(s,t,0);for(let t=0,s=e.length;t<s;t++){const[s,r,n]=e[t];a.set(s,r,n)}this._states=a,this._maxCharCode=t}nextState(e,t){return t<0||t>=this._maxCharCode?0:this._states.get(e,t)}}let _stateMachine=null;function getStateMachine(){return null===_stateMachine&&(_stateMachine=new StateMachine([[1,104,2],[1,72,2],[1,102,6],[1,70,6],[2,116,3],[2,84,3],[3,116,4],[3,84,4],[4,112,5],[4,80,5],[5,115,9],[5,83,9],[5,58,10],[6,105,7],[6,73,7],[7,108,8],[7,76,8],[8,101,9],[8,69,9],[9,58,10],[10,47,11],[11,47,12]])),_stateMachine}let _classifier=null;function getClassifier(){if(null===_classifier){_classifier=new CharacterClassifier(0);const e=", \t<>'\"、。｡､，．：；‘〈「『〔（［｛｢｣｝］）〕』」〉’｀～…";for(let t=0;t<e.length;t++)_classifier.set(e.charCodeAt(t),1);const t=".;:";for(let e=0;e<t.length;e++)_classifier.set(t.charCodeAt(e),2)}return _classifier}export class LinkComputer{static _createLink(e,t,s,a,r){let n=r-1;do{const s=t.charCodeAt(n);if(2!==e.get(s))break;n--}while(n>a);if(a>0){const e=t.charCodeAt(a-1),s=t.charCodeAt(n);(40===e&&41===s||91===e&&93===s||123===e&&125===s)&&n--}return{range:{startLineNumber:s,startColumn:a+1,endLineNumber:s,endColumn:n+2},url:t.substring(a,n+1)}}static computeLinks(e,t=getStateMachine()){const s=getClassifier(),a=[];for(let r=1,n=e.getLineCount();r<=n;r++){const n=e.getLineContent(r),i=n.length;let c=0,o=0,l=0,h=1,u=!1,f=!1,C=!1,k=!1;for(;c<i;){let e=!1;const i=n.charCodeAt(c);if(13===h){let t;switch(i){case 40:u=!0,t=0;break;case 41:t=u?0:1;break;case 91:C=!0,f=!0,t=0;break;case 93:C=!1,t=f?0:1;break;case 123:k=!0,t=0;break;case 125:t=k?0:1;break;case 39:case 34:case 96:t=l===i?1:39===l||34===l||96===l?0:1;break;case 42:t=42===l?1:0;break;case 124:t=124===l?1:0;break;case 32:t=C?0:1;break;default:t=s.get(i)}1===t&&(a.push(LinkComputer._createLink(s,n,r,o,c)),e=!0)}else if(12===h){let t;91===i?(f=!0,t=0):t=s.get(i),1===t?e=!0:h=13}else h=t.nextState(h,i),0===h&&(e=!0);e&&(h=1,u=!1,f=!1,k=!1,o=c+1,l=i),c++}13===h&&a.push(LinkComputer._createLink(s,n,r,o,i))}return a}}export function computeLinks(e){return e&&"function"==typeof e.getLineCount&&"function"==typeof e.getLineContent?LinkComputer.computeLinks(e):[]}