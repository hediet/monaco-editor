var IdentityHash,__decorate=this&&this.__decorate||function(e,t,o,a){var r,n=arguments.length,i=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,o):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,a);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(i=(n<3?r(i):n>3?r(t,o,i):r(t,o))||i);return n>3&&i&&Object.defineProperty(t,o,i),i},__param=this&&this.__param||function(e,t){return function(o,a){t(o,a,e)}};import{doHash}from"../../../base/common/hash.js";import{LRUCache}from"../../../base/common/map.js";import{clamp,MovingAverage,SlidingWindowAverage}from"../../../base/common/numbers.js";import{registerSingleton}from"../../../platform/instantiation/common/extensions.js";import{createDecorator}from"../../../platform/instantiation/common/instantiation.js";import{ILogService}from"../../../platform/log/common/log.js";import{matchesScheme}from"../../../platform/opener/common/opener.js";export const ILanguageFeatureDebounceService=createDecorator("ILanguageFeatureDebounceService");!function(e){const t=new WeakMap;let o=0;e.of=function(e){let a=t.get(e);return void 0===a&&(a=++o,t.set(e,a)),a}}(IdentityHash||(IdentityHash={}));class FeatureDebounceInformation{constructor(e,t,o,a,r,n){this._logService=e,this._name=t,this._registry=o,this._default=a,this._min=r,this._max=n,this._cache=new LRUCache(50,.7)}_key(e){return e.id+this._registry.all(e).reduce(((e,t)=>doHash(IdentityHash.of(t),e)),0)}get(e){const t=this._key(e),o=this._cache.get(t);return o?clamp(o.value,this._min,this._max):this.default()}update(e,t){const o=this._key(e);let a=this._cache.get(o);a||(a=new SlidingWindowAverage(6),this._cache.set(o,a));const r=clamp(a.update(t),this._min,this._max);return matchesScheme(e.uri,"output")||this._logService.trace(`[DEBOUNCE: ${this._name}] for ${e.uri.toString()} is ${r}ms`),r}_overall(){const e=new MovingAverage;for(const[,t]of this._cache)e.update(t.value);return e.value}default(){const e=0|this._overall()||this._default;return clamp(e,this._min,this._max)}}let LanguageFeatureDebounceService=class{constructor(e){this._logService=e,this._data=new Map}for(e,t,o){var a,r,n;const i=null!==(a=null==o?void 0:o.min)&&void 0!==a?a:50,c=null!==(r=null==o?void 0:o.max)&&void 0!==r?r:Math.pow(i,2),s=null!==(n=null==o?void 0:o.key)&&void 0!==n?n:void 0,u=`${IdentityHash.of(e)},${i}${s?","+s:""}`;let l=this._data.get(u);return l||(l=new FeatureDebounceInformation(this._logService,t,e,0|this._overallAverage()||1.5*i,i,c),this._data.set(u,l)),l}_overallAverage(){const e=new MovingAverage;for(const t of this._data.values())e.update(t.default());return e.value}};LanguageFeatureDebounceService=__decorate([__param(0,ILogService)],LanguageFeatureDebounceService);export{LanguageFeatureDebounceService};registerSingleton(ILanguageFeatureDebounceService,LanguageFeatureDebounceService,1);