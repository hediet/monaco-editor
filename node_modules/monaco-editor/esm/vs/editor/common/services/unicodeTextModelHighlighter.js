import{Range}from"../core/range.js";import{Searcher}from"../model/textModelSearch.js";import*as strings from"../../../base/common/strings.js";import{assertNever}from"../../../base/common/assert.js";import{DEFAULT_WORD_REGEXP,getWordAtText}from"../core/wordHelper.js";export class UnicodeTextModelHighlighter{static computeUnicodeHighlights(e,t,s){const i=s?s.startLineNumber:1,o=s?s.endLineNumber:e.getLineCount(),n=new CodePointHighlighter(t),r=n.getCandidateCodePoints();let a;a="allNonBasicAscii"===r?new RegExp("[^\\t\\n\\r\\x20-\\x7E]","g"):new RegExp(`${buildRegExpCharClassExpr(Array.from(r))}`,"g");const c=new Searcher(null,a),l=[];let g,h=!1,u=0,d=0,C=0;e:for(let t=i,s=o;t<=s;t++){const s=e.getLineContent(t),i=s.length;c.reset(0);do{if(g=c.next(s),g){let e=g.index,o=g.index+g[0].length;if(e>0){const t=s.charCodeAt(e-1);strings.isHighSurrogate(t)&&e--}if(o+1<i){const e=s.charCodeAt(o-1);strings.isHighSurrogate(e)&&o++}const r=s.substring(e,o);let a=getWordAtText(e+1,DEFAULT_WORD_REGEXP,s,0);a&&a.endColumn<=e+1&&(a=null);const c=n.shouldHighlightNonBasicASCII(r,a?a.word:null);if(0!==c){3===c?u++:2===c?d++:1===c?C++:assertNever(c);const s=1e3;if(l.length>=s){h=!0;break e}l.push(new Range(t,e+1,t,o+1))}}}while(g)}return{ranges:l,hasMore:h,ambiguousCharacterCount:u,invisibleCharacterCount:d,nonBasicAsciiCharacterCount:C}}static computeUnicodeHighlightReason(e,t){const s=new CodePointHighlighter(t);switch(s.shouldHighlightNonBasicASCII(e,null)){case 0:return null;case 2:return{kind:1};case 3:{const i=e.codePointAt(0),o=s.ambiguousCharacters.getPrimaryConfusable(i),n=strings.AmbiguousCharacters.getLocales().filter((e=>!strings.AmbiguousCharacters.getInstance(new Set([...t.allowedLocales,e])).isAmbiguous(i)));return{kind:0,confusableWith:String.fromCodePoint(o),notAmbiguousInLocales:n}}case 1:return{kind:2}}}}function buildRegExpCharClassExpr(e,t){return`[${strings.escapeRegExpCharacters(e.map((e=>String.fromCodePoint(e))).join(""))}]`}class CodePointHighlighter{constructor(e){this.options=e,this.allowedCodePoints=new Set(e.allowedCodePoints),this.ambiguousCharacters=strings.AmbiguousCharacters.getInstance(new Set(e.allowedLocales))}getCandidateCodePoints(){if(this.options.nonBasicASCII)return"allNonBasicAscii";const e=new Set;if(this.options.invisibleCharacters)for(const t of strings.InvisibleCharacters.codePoints)isAllowedInvisibleCharacter(String.fromCodePoint(t))||e.add(t);if(this.options.ambiguousCharacters)for(const t of this.ambiguousCharacters.getConfusableCodePoints())e.add(t);for(const t of this.allowedCodePoints)e.delete(t);return e}shouldHighlightNonBasicASCII(e,t){const s=e.codePointAt(0);if(this.allowedCodePoints.has(s))return 0;if(this.options.nonBasicASCII)return 1;let i=!1,o=!1;if(t)for(const e of t){const t=e.codePointAt(0),s=strings.isBasicASCII(e);i=i||s,s||this.ambiguousCharacters.isAmbiguous(t)||strings.InvisibleCharacters.isInvisibleCharacter(t)||(o=!0)}return!i&&o?0:this.options.invisibleCharacters&&!isAllowedInvisibleCharacter(e)&&strings.InvisibleCharacters.isInvisibleCharacter(s)?2:this.options.ambiguousCharacters&&this.ambiguousCharacters.isAmbiguous(s)?3:0}}function isAllowedInvisibleCharacter(e){return" "===e||"\n"===e||"\t"===e}