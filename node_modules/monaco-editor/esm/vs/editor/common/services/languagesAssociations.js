import{parse}from"../../../base/common/glob.js";import{Mimes}from"../../../base/common/mime.js";import{Schemas}from"../../../base/common/network.js";import{basename,posix}from"../../../base/common/path.js";import{DataUri}from"../../../base/common/resources.js";import{startsWithUTF8BOM}from"../../../base/common/strings.js";import{PLAINTEXT_LANGUAGE_ID}from"../languages/modesRegistry.js";let registeredAssociations=[],nonUserRegisteredAssociations=[],userRegisteredAssociations=[];export function registerPlatformLanguageAssociation(e,i=!1){_registerLanguageAssociation(e,!1,i)}function _registerLanguageAssociation(e,i,t){const n=toLanguageAssociationItem(e,i);registeredAssociations.push(n),n.userConfigured?userRegisteredAssociations.push(n):nonUserRegisteredAssociations.push(n),t&&!n.userConfigured&&registeredAssociations.forEach((e=>{e.mime===n.mime||e.userConfigured||(n.extension&&e.extension===n.extension&&console.warn(`Overwriting extension <<${n.extension}>> to now point to mime <<${n.mime}>>`),n.filename&&e.filename===n.filename&&console.warn(`Overwriting filename <<${n.filename}>> to now point to mime <<${n.mime}>>`),n.filepattern&&e.filepattern===n.filepattern&&console.warn(`Overwriting filepattern <<${n.filepattern}>> to now point to mime <<${n.mime}>>`),n.firstline&&e.firstline===n.firstline&&console.warn(`Overwriting firstline <<${n.firstline}>> to now point to mime <<${n.mime}>>`))}))}function toLanguageAssociationItem(e,i){return{id:e.id,mime:e.mime,filename:e.filename,extension:e.extension,filepattern:e.filepattern,firstline:e.firstline,userConfigured:i,filenameLowercase:e.filename?e.filename.toLowerCase():void 0,extensionLowercase:e.extension?e.extension.toLowerCase():void 0,filepatternLowercase:e.filepattern?parse(e.filepattern.toLowerCase()):void 0,filepatternOnPath:!!e.filepattern&&e.filepattern.indexOf(posix.sep)>=0}}export function clearPlatformLanguageAssociations(){registeredAssociations=registeredAssociations.filter((e=>e.userConfigured)),nonUserRegisteredAssociations=[]}export function getLanguageIds(e,i){return getAssociations(e,i).map((e=>e.id))}function getAssociations(e,i){let t;if(e)switch(e.scheme){case Schemas.file:t=e.fsPath;break;case Schemas.data:t=DataUri.parseMetaData(e).get(DataUri.META_DATA_LABEL);break;case Schemas.vscodeNotebookCell:t=void 0;break;default:t=e.path}if(!t)return[{id:"unknown",mime:Mimes.unknown}];t=t.toLowerCase();const n=basename(t),s=getAssociationByPath(t,n,userRegisteredAssociations);if(s)return[s,{id:PLAINTEXT_LANGUAGE_ID,mime:Mimes.text}];const o=getAssociationByPath(t,n,nonUserRegisteredAssociations);if(o)return[o,{id:PLAINTEXT_LANGUAGE_ID,mime:Mimes.text}];if(i){const e=getAssociationByFirstline(i);if(e)return[e,{id:PLAINTEXT_LANGUAGE_ID,mime:Mimes.text}]}return[{id:"unknown",mime:Mimes.unknown}]}function getAssociationByPath(e,i,t){var n;let s,o,r;for(let a=t.length-1;a>=0;a--){const m=t[a];if(i===m.filenameLowercase){s=m;break}if(m.filepattern&&(!o||m.filepattern.length>o.filepattern.length)){const t=m.filepatternOnPath?e:i;(null===(n=m.filepatternLowercase)||void 0===n?void 0:n.call(m,t))&&(o=m)}m.extension&&(!r||m.extension.length>r.extension.length)&&i.endsWith(m.extensionLowercase)&&(r=m)}return s||o||r||void 0}function getAssociationByFirstline(e){if(startsWithUTF8BOM(e)&&(e=e.substr(1)),e.length>0)for(let i=registeredAssociations.length-1;i>=0;i--){const t=registeredAssociations[i];if(!t.firstline)continue;const n=e.match(t.firstline);if(n&&n.length>0)return t}}