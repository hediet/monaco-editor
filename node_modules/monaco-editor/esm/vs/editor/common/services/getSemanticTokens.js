var __awaiter=this&&this.__awaiter||function(e,n,t,o){return new(t||(t=Promise))((function(r,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(a,s)}c((o=o.apply(e,n||[])).next())}))};import{CancellationToken}from"../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../base/common/errors.js";import{URI}from"../../../base/common/uri.js";import{IModelService}from"./model.js";import{CommandsRegistry,ICommandService}from"../../../platform/commands/common/commands.js";import{assertType}from"../../../base/common/types.js";import{encodeSemanticTokensDto}from"./semanticTokensDto.js";import{Range}from"../core/range.js";import{ILanguageFeaturesService}from"./languageFeatures.js";export function isSemanticTokens(e){return e&&!!e.data}export function isSemanticTokensEdits(e){return e&&Array.isArray(e.edits)}export class DocumentSemanticTokensResult{constructor(e,n,t){this.provider=e,this.tokens=n,this.error=t}}export function hasDocumentSemanticTokensProvider(e,n){return e.has(n)}function getDocumentSemanticTokensProviders(e,n){const t=e.orderedGroups(n);return t.length>0?t[0]:[]}export function getDocumentSemanticTokens(e,n,t,o,r){return __awaiter(this,void 0,void 0,(function*(){const i=getDocumentSemanticTokensProviders(e,n),a=yield Promise.all(i.map((e=>__awaiter(this,void 0,void 0,(function*(){let i,a=null;try{i=yield e.provideDocumentSemanticTokens(n,e===t?o:null,r)}catch(e){a=e,i=null}return i&&(isSemanticTokens(i)||isSemanticTokensEdits(i))||(i=null),new DocumentSemanticTokensResult(e,i,a)})))));for(const e of a){if(e.error)throw e.error;if(e.tokens)return e}return a.length>0?a[0]:null}))}function _getDocumentSemanticTokensProviderHighestGroup(e,n){const t=e.orderedGroups(n);return t.length>0?t[0]:null}class DocumentRangeSemanticTokensResult{constructor(e,n){this.provider=e,this.tokens=n}}export function hasDocumentRangeSemanticTokensProvider(e,n){return e.has(n)}function getDocumentRangeSemanticTokensProviders(e,n){const t=e.orderedGroups(n);return t.length>0?t[0]:[]}export function getDocumentRangeSemanticTokens(e,n,t,o){return __awaiter(this,void 0,void 0,(function*(){const r=getDocumentRangeSemanticTokensProviders(e,n),i=yield Promise.all(r.map((e=>__awaiter(this,void 0,void 0,(function*(){let r;try{r=yield e.provideDocumentRangeSemanticTokens(n,t,o)}catch(e){onUnexpectedExternalError(e),r=null}return r&&isSemanticTokens(r)||(r=null),new DocumentRangeSemanticTokensResult(e,r)})))));for(const e of i)if(e.tokens)return e;return i.length>0?i[0]:null}))}CommandsRegistry.registerCommand("_provideDocumentSemanticTokensLegend",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t]=n;assertType(t instanceof URI);const o=e.get(IModelService).getModel(t);if(!o)return;const{documentSemanticTokensProvider:r}=e.get(ILanguageFeaturesService),i=_getDocumentSemanticTokensProviderHighestGroup(r,o);return i?i[0].getLegend():e.get(ICommandService).executeCommand("_provideDocumentRangeSemanticTokensLegend",t)})))),CommandsRegistry.registerCommand("_provideDocumentSemanticTokens",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t]=n;assertType(t instanceof URI);const o=e.get(IModelService).getModel(t);if(!o)return;const{documentSemanticTokensProvider:r}=e.get(ILanguageFeaturesService);if(!hasDocumentSemanticTokensProvider(r,o))return e.get(ICommandService).executeCommand("_provideDocumentRangeSemanticTokens",t,o.getFullModelRange());const i=yield getDocumentSemanticTokens(r,o,null,null,CancellationToken.None);if(!i)return;const{provider:a,tokens:s}=i;if(!s||!isSemanticTokens(s))return;const c=encodeSemanticTokensDto({id:0,type:"full",data:s.data});return s.resultId&&a.releaseDocumentSemanticTokens(s.resultId),c})))),CommandsRegistry.registerCommand("_provideDocumentRangeSemanticTokensLegend",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t,o]=n;assertType(t instanceof URI);const r=e.get(IModelService).getModel(t);if(!r)return;const{documentRangeSemanticTokensProvider:i}=e.get(ILanguageFeaturesService),a=getDocumentRangeSemanticTokensProviders(i,r);if(0===a.length)return;if(1===a.length)return a[0].getLegend();if(!o||!Range.isIRange(o))return console.warn("provideDocumentRangeSemanticTokensLegend might be out-of-sync with provideDocumentRangeSemanticTokens unless a range argument is passed in"),a[0].getLegend();const s=yield getDocumentRangeSemanticTokens(i,r,Range.lift(o),CancellationToken.None);return s?s.provider.getLegend():void 0})))),CommandsRegistry.registerCommand("_provideDocumentRangeSemanticTokens",((e,...n)=>__awaiter(void 0,void 0,void 0,(function*(){const[t,o]=n;assertType(t instanceof URI),assertType(Range.isIRange(o));const r=e.get(IModelService).getModel(t);if(!r)return;const{documentRangeSemanticTokensProvider:i}=e.get(ILanguageFeaturesService),a=yield getDocumentRangeSemanticTokens(i,r,Range.lift(o),CancellationToken.None);return a&&a.tokens?encodeSemanticTokensDto({id:0,type:"full",data:a.tokens.data}):void 0}))));