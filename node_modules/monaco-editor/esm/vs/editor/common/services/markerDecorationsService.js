var __decorate=this&&this.__decorate||function(e,r,t,o){var i,a=arguments.length,s=a<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,o);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(s=(a<3?i(s):a>3?i(r,t,s):i(r,t))||s);return a>3&&s&&Object.defineProperty(r,t,s),s},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}};import{IMarkerService,MarkerSeverity}from"../../../platform/markers/common/markers.js";import{Disposable,toDisposable}from"../../../base/common/lifecycle.js";import{OverviewRulerLane,MinimapPosition}from"../model.js";import{themeColorFromId}from"../../../platform/theme/common/themeService.js";import{overviewRulerWarning,overviewRulerInfo,overviewRulerError}from"../core/editorColorRegistry.js";import{IModelService}from"./model.js";import{Range}from"../core/range.js";import{Schemas}from"../../../base/common/network.js";import{Emitter}from"../../../base/common/event.js";import{minimapWarning,minimapError}from"../../../platform/theme/common/colorRegistry.js";import{ResourceMap}from"../../../base/common/map.js";class MarkerDecorations extends Disposable{constructor(e){super(),this.model=e,this._markersData=new Map,this._register(toDisposable((()=>{this.model.deltaDecorations([...this._markersData.keys()],[]),this._markersData.clear()})))}update(e,r){const t=[...this._markersData.keys()];this._markersData.clear();const o=this.model.deltaDecorations(t,r);for(let r=0;r<o.length;r++)this._markersData.set(o[r],e[r]);return 0!==t.length||0!==o.length}getMarker(e){return this._markersData.get(e.id)}}let MarkerDecorationsService=class extends Disposable{constructor(e,r){super(),this._markerService=r,this._onDidChangeMarker=this._register(new Emitter),this._markerDecorations=new ResourceMap,e.getModels().forEach((e=>this._onModelAdded(e))),this._register(e.onModelAdded(this._onModelAdded,this)),this._register(e.onModelRemoved(this._onModelRemoved,this)),this._register(this._markerService.onMarkerChanged(this._handleMarkerChange,this))}dispose(){super.dispose(),this._markerDecorations.forEach((e=>e.dispose())),this._markerDecorations.clear()}getMarker(e,r){const t=this._markerDecorations.get(e);return t&&t.getMarker(r)||null}_handleMarkerChange(e){e.forEach((e=>{const r=this._markerDecorations.get(e);r&&this._updateDecorations(r)}))}_onModelAdded(e){const r=new MarkerDecorations(e);this._markerDecorations.set(e.uri,r),this._updateDecorations(r)}_onModelRemoved(e){var r;const t=this._markerDecorations.get(e.uri);t&&(t.dispose(),this._markerDecorations.delete(e.uri)),e.uri.scheme!==Schemas.inMemory&&e.uri.scheme!==Schemas.internal&&e.uri.scheme!==Schemas.vscode||null===(r=this._markerService)||void 0===r||r.read({resource:e.uri}).map((e=>e.owner)).forEach((r=>this._markerService.remove(r,[e.uri])))}_updateDecorations(e){const r=this._markerService.read({resource:e.model.uri,take:500}),t=r.map((r=>({range:this._createDecorationRange(e.model,r),options:this._createDecorationOption(r)})));e.update(r,t)&&this._onDidChangeMarker.fire(e.model)}_createDecorationRange(e,r){let t=Range.lift(r);if(r.severity!==MarkerSeverity.Hint||this._hasMarkerTag(r,1)||this._hasMarkerTag(r,2)||(t=t.setEndPosition(t.startLineNumber,t.startColumn+2)),t=e.validateRange(t),t.isEmpty()){const r=e.getLineLastNonWhitespaceColumn(t.startLineNumber)||e.getLineMaxColumn(t.startLineNumber);if(1===r||t.endColumn>=r)return t;const o=e.getWordAtPosition(t.getStartPosition());o&&(t=new Range(t.startLineNumber,o.startColumn,t.endLineNumber,o.endColumn))}else if(r.endColumn===Number.MAX_VALUE&&1===r.startColumn&&t.startLineNumber===t.endLineNumber){const o=e.getLineFirstNonWhitespaceColumn(r.startLineNumber);o<t.endColumn&&(t=new Range(t.startLineNumber,o,t.endLineNumber,t.endColumn),r.startColumn=o)}return t}_createDecorationOption(e){let r,t,o,i,a;switch(e.severity){case MarkerSeverity.Hint:r=this._hasMarkerTag(e,2)?void 0:this._hasMarkerTag(e,1)?"squiggly-unnecessary":"squiggly-hint",o=0;break;case MarkerSeverity.Warning:r="squiggly-warning",t=themeColorFromId(overviewRulerWarning),o=20,a={color:themeColorFromId(minimapWarning),position:MinimapPosition.Inline};break;case MarkerSeverity.Info:r="squiggly-info",t=themeColorFromId(overviewRulerInfo),o=10;break;case MarkerSeverity.Error:default:r="squiggly-error",t=themeColorFromId(overviewRulerError),o=30,a={color:themeColorFromId(minimapError),position:MinimapPosition.Inline}}return e.tags&&(-1!==e.tags.indexOf(1)&&(i="squiggly-inline-unnecessary"),-1!==e.tags.indexOf(2)&&(i="squiggly-inline-deprecated")),{description:"marker-decoration",stickiness:1,className:r,showIfCollapsed:!0,overviewRuler:{color:t,position:OverviewRulerLane.Right},minimap:a,zIndex:o,inlineClassName:i}}_hasMarkerTag(e,r){return!!e.tags&&e.tags.indexOf(r)>=0}};MarkerDecorationsService=__decorate([__param(0,IModelService),__param(1,IMarkerService)],MarkerDecorationsService);export{MarkerDecorationsService};