var __decorate=this&&this.__decorate||function(e,t,n,i){var r,a=arguments.length,o=a<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(o=(a<3?r(o):a>3?r(t,n,o):r(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};import{TokenMetadata}from"../encodedTokenAttributes.js";import{IThemeService}from"../../../platform/theme/common/themeService.js";import{ILogService,LogLevel}from"../../../platform/log/common/log.js";import{SparseMultilineTokens}from"../tokens/sparseMultilineTokens.js";import{ILanguageService}from"../languages/language.js";let SemanticTokensProviderStyling=class{constructor(e,t,n,i){this._legend=e,this._themeService=t,this._languageService=n,this._logService=i,this._hasWarnedOverlappingTokens=!1,this._hasWarnedInvalidLengthTokens=!1,this._hasWarnedInvalidEditStart=!1,this._hashTable=new HashTable}getMetadata(e,t,n){const i=this._languageService.languageIdCodec.encodeLanguageId(n),r=this._hashTable.get(e,t,i);let a;if(r)a=r.metadata,this._logService.getLevel()===LogLevel.Trace&&this._logService.trace(`SemanticTokensProviderStyling [CACHED] ${e} / ${t}: foreground ${TokenMetadata.getForeground(a)}, fontStyle ${TokenMetadata.getFontStyle(a).toString(2)}`);else{let r=this._legend.tokenTypes[e];const o=[];if(r){let e=t;for(let t=0;e>0&&t<this._legend.tokenModifiers.length;t++)1&e&&o.push(this._legend.tokenModifiers[t]),e>>=1;e>0&&this._logService.getLevel()===LogLevel.Trace&&(this._logService.trace(`SemanticTokensProviderStyling: unknown token modifier index: ${t.toString(2)} for legend: ${JSON.stringify(this._legend.tokenModifiers)}`),o.push("not-in-legend"));const i=this._themeService.getColorTheme().getTokenStyleMetadata(r,o,n);void 0===i?a=2147483647:(a=0,void 0!==i.italic&&(a|=1|(i.italic?1:0)<<11),void 0!==i.bold&&(a|=2|(i.bold?2:0)<<11),void 0!==i.underline&&(a|=4|(i.underline?4:0)<<11),void 0!==i.strikethrough&&(a|=8|(i.strikethrough?8:0)<<11),i.foreground&&(a|=16|i.foreground<<15),0===a&&(a=2147483647))}else this._logService.getLevel()===LogLevel.Trace&&this._logService.trace(`SemanticTokensProviderStyling: unknown token type index: ${e} for legend: ${JSON.stringify(this._legend.tokenTypes)}`),a=2147483647,r="not-in-legend";this._hashTable.add(e,t,i,a),this._logService.getLevel()===LogLevel.Trace&&this._logService.trace(`SemanticTokensProviderStyling ${e} (${r}) / ${t} (${o.join(" ")}): foreground ${TokenMetadata.getForeground(a)}, fontStyle ${TokenMetadata.getFontStyle(a).toString(2)}`)}return a}warnOverlappingSemanticTokens(e,t){this._hasWarnedOverlappingTokens||(this._hasWarnedOverlappingTokens=!0,console.warn(`Overlapping semantic tokens detected at lineNumber ${e}, column ${t}`))}warnInvalidLengthSemanticTokens(e,t){this._hasWarnedInvalidLengthTokens||(this._hasWarnedInvalidLengthTokens=!0,console.warn(`Semantic token with invalid length detected at lineNumber ${e}, column ${t}`))}warnInvalidEditStart(e,t,n,i,r){this._hasWarnedInvalidEditStart||(this._hasWarnedInvalidEditStart=!0,console.warn(`Invalid semantic tokens edit detected (previousResultId: ${e}, resultId: ${t}) at edit #${n}: The provided start offset ${i} is outside the previous data (length ${r}).`))}};SemanticTokensProviderStyling=__decorate([__param(1,IThemeService),__param(2,ILanguageService),__param(3,ILogService)],SemanticTokensProviderStyling);export{SemanticTokensProviderStyling};export function toMultilineTokens2(e,t,n){const i=e.data,r=e.data.length/5|0,a=Math.max(Math.ceil(r/1024),400),o=[];let s=0,l=1,h=0;for(;s<r;){const e=s;let d=Math.min(e+a,r);if(d<r){let t=d;for(;t-1>e&&0===i[5*t];)t--;if(t-1===e){let e=d;for(;e+1<r&&0===i[5*e];)e++;d=e}else d=t}let g=new Uint32Array(4*(d-e)),c=0,u=0,_=0,S=0;for(;s<d;){const e=5*s,r=i[e],a=i[e+1],o=l+r|0,d=0===r?h+a|0:a,v=d+i[e+2]|0,m=i[e+3],f=i[e+4];if(v<=d)t.warnInvalidLengthSemanticTokens(o,d+1);else if(_===o&&S>d)t.warnOverlappingSemanticTokens(o,d+1);else{const e=t.getMetadata(m,f,n);2147483647!==e&&(0===u&&(u=o),g[c]=o-u,g[c+1]=d,g[c+2]=v,g[c+3]=e,c+=4,_=o,S=v)}l=o,h=d,s++}c!==g.length&&(g=g.subarray(0,c));const v=SparseMultilineTokens.create(u,g);o.push(v)}return o}class HashTableEntry{constructor(e,t,n,i){this.tokenTypeIndex=e,this.tokenModifierSet=t,this.languageId=n,this.metadata=i,this.next=null}}class HashTable{constructor(){this._elementsCount=0,this._currentLengthIndex=0,this._currentLength=HashTable._SIZES[this._currentLengthIndex],this._growCount=Math.round(this._currentLengthIndex+1<HashTable._SIZES.length?2/3*this._currentLength:0),this._elements=[],HashTable._nullOutEntries(this._elements,this._currentLength)}static _nullOutEntries(e,t){for(let n=0;n<t;n++)e[n]=null}_hash2(e,t){return(e<<5)-e+t|0}_hashFunc(e,t,n){return this._hash2(this._hash2(e,t),n)%this._currentLength}get(e,t,n){const i=this._hashFunc(e,t,n);let r=this._elements[i];for(;r;){if(r.tokenTypeIndex===e&&r.tokenModifierSet===t&&r.languageId===n)return r;r=r.next}return null}add(e,t,n,i){if(this._elementsCount++,0!==this._growCount&&this._elementsCount>=this._growCount){const e=this._elements;this._currentLengthIndex++,this._currentLength=HashTable._SIZES[this._currentLengthIndex],this._growCount=Math.round(this._currentLengthIndex+1<HashTable._SIZES.length?2/3*this._currentLength:0),this._elements=[],HashTable._nullOutEntries(this._elements,this._currentLength);for(const t of e){let e=t;for(;e;){const t=e.next;e.next=null,this._add(e),e=t}}}this._add(new HashTableEntry(e,t,n,i))}_add(e){const t=this._hashFunc(e.tokenTypeIndex,e.tokenModifierSet,e.languageId);e.next=this._elements[t],this._elements[t]=e}}HashTable._SIZES=[3,7,13,31,61,127,251,509,1021,2039,4093,8191,16381,32749,65521,131071,262139,524287,1048573,2097143];