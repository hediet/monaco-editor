import{CallbackIterable,compareBy}from"../../../../base/common/arrays.js";import{Emitter}from"../../../../base/common/event.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../../base/common/lifecycle.js";import{Range}from"../../core/range.js";import{ignoreBracketsInToken}from"../../languages/supports.js";import{BracketsUtils}from"../../languages/supports/richEditBrackets.js";import{BracketPairsTree}from"./bracketPairsTree/bracketPairsTree.js";export class BracketPairsTextModelPart extends Disposable{get canBuildAST(){return this.textModel.getValueLength()<=5e6}constructor(e,t){super(),this.textModel=e,this.languageConfigurationService=t,this.bracketPairsTree=this._register(new MutableDisposable),this.onDidChangeEmitter=new Emitter,this.onDidChange=this.onDidChangeEmitter.event,this.bracketsRequested=!1,this._register(this.languageConfigurationService.onDidChange((e=>{var t;e.languageId&&!(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.didLanguageChange(e.languageId))||(this.bracketPairsTree.clear(),this.updateBracketPairsTree())})))}handleDidChangeOptions(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeLanguage(e){this.bracketPairsTree.clear(),this.updateBracketPairsTree()}handleDidChangeContent(e){var t;null===(t=this.bracketPairsTree.value)||void 0===t||t.object.handleContentChanged(e)}handleDidChangeBackgroundTokenizationState(){var e;null===(e=this.bracketPairsTree.value)||void 0===e||e.object.handleDidChangeBackgroundTokenizationState()}handleDidChangeTokens(e){var t;null===(t=this.bracketPairsTree.value)||void 0===t||t.object.handleDidChangeTokens(e)}updateBracketPairsTree(){if(this.bracketsRequested&&this.canBuildAST){if(!this.bracketPairsTree.value){const e=new DisposableStore;this.bracketPairsTree.value=createDisposableRef(e.add(new BracketPairsTree(this.textModel,(e=>this.languageConfigurationService.getLanguageConfiguration(e)))),e),e.add(this.bracketPairsTree.value.object.onDidChange((e=>this.onDidChangeEmitter.fire(e)))),this.onDidChangeEmitter.fire()}}else this.bracketPairsTree.value&&(this.bracketPairsTree.clear(),this.onDidChangeEmitter.fire())}getBracketPairsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!1))||CallbackIterable.empty}getBracketPairsInRangeWithMinIndentation(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketPairsInRange(e,!0))||CallbackIterable.empty}getBracketsInRange(e){var t;return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getBracketsInRange(e))||CallbackIterable.empty}findMatchingBracketUp(e,t,n){const a=this.textModel.validatePosition(t),r=this.textModel.getLanguageIdAtPosition(a.lineNumber,a.column);if(this.canBuildAST){const n=this.languageConfigurationService.getLanguageConfiguration(r).bracketsNew.getClosingBracketInfo(e);if(!n)return null;const a=this.getBracketPairsInRange(Range.fromPositions(t,t)).findLast((e=>n.closes(e.openingBracketInfo)));return a?a.openingBracketRange:null}{const t=e.toLowerCase(),i=this.languageConfigurationService.getLanguageConfiguration(r).brackets;if(!i)return null;const o=i.textIsBracket[t];return o?stripBracketSearchCanceled(this._findMatchingBracketUp(o,a,createTimeBasedContinueBracketSearchPredicate(n))):null}}matchBracket(e,t){if(this.canBuildAST){const t=this.getBracketPairsInRange(Range.fromPositions(e,e)).filter((t=>void 0!==t.closingBracketRange&&(t.openingBracketRange.containsPosition(e)||t.closingBracketRange.containsPosition(e)))).findLastMaxBy(compareBy((t=>t.openingBracketRange.containsPosition(e)?t.openingBracketRange:t.closingBracketRange),Range.compareRangesUsingStarts));return t?[t.openingBracketRange,t.closingBracketRange]:null}{const n=createTimeBasedContinueBracketSearchPredicate(t);return this._matchBracket(this.textModel.validatePosition(e),n)}}_establishBracketSearchOffsets(e,t,n,a){const r=t.getCount(),i=t.getLanguageId(a);let o=Math.max(0,e.column-1-n.maxBracketLength);for(let e=a-1;e>=0;e--){const n=t.getEndOffset(e);if(n<=o)break;if(ignoreBracketsInToken(t.getStandardTokenType(e))||t.getLanguageId(e)!==i){o=n;break}}let s=Math.min(t.getLineContent().length,e.column-1+n.maxBracketLength);for(let e=a+1;e<r;e++){const n=t.getStartOffset(e);if(n>=s)break;if(ignoreBracketsInToken(t.getStandardTokenType(e))||t.getLanguageId(e)!==i){s=n;break}}return{searchStartOffset:o,searchEndOffset:s}}_matchBracket(e,t){const n=e.lineNumber,a=this.textModel.tokenization.getLineTokens(n),r=this.textModel.getLineContent(n),i=a.findTokenIndexAtOffset(e.column-1);if(i<0)return null;const o=this.languageConfigurationService.getLanguageConfiguration(a.getLanguageId(i)).brackets;if(o&&!ignoreBracketsInToken(a.getStandardTokenType(i))){let{searchStartOffset:s,searchEndOffset:c}=this._establishBracketSearchOffsets(e,a,o,i),g=null;for(;;){const a=BracketsUtils.findNextBracketInRange(o.forwardRegex,n,r,s,c);if(!a)break;if(a.startColumn<=e.column&&e.column<=a.endColumn){const e=r.substring(a.startColumn-1,a.endColumn-1).toLowerCase(),n=this._matchFoundBracket(a,o.textIsBracket[e],o.textIsOpenBracket[e],t);if(n){if(n instanceof BracketSearchCanceled)return null;g=n}}s=a.endColumn-1}if(g)return g}if(i>0&&a.getStartOffset(i)===e.column-1){const o=i-1,s=this.languageConfigurationService.getLanguageConfiguration(a.getLanguageId(o)).brackets;if(s&&!ignoreBracketsInToken(a.getStandardTokenType(o))){const{searchStartOffset:i,searchEndOffset:c}=this._establishBracketSearchOffsets(e,a,s,o),g=BracketsUtils.findPrevBracketInRange(s.reversedRegex,n,r,i,c);if(g&&g.startColumn<=e.column&&e.column<=g.endColumn){const e=r.substring(g.startColumn-1,g.endColumn-1).toLowerCase(),n=this._matchFoundBracket(g,s.textIsBracket[e],s.textIsOpenBracket[e],t);if(n)return n instanceof BracketSearchCanceled?null:n}}}return null}_matchFoundBracket(e,t,n,a){if(!t)return null;const r=n?this._findMatchingBracketDown(t,e.getEndPosition(),a):this._findMatchingBracketUp(t,e.getStartPosition(),a);return r?r instanceof BracketSearchCanceled?r:[e,r]:null}_findMatchingBracketUp(e,t,n){const a=e.languageId,r=e.reversedRegex;let i=-1,o=0;const s=(t,a,s,c)=>{for(;;){if(n&&++o%100==0&&!n())return BracketSearchCanceled.INSTANCE;const g=BracketsUtils.findPrevBracketInRange(r,t,a,s,c);if(!g)break;const l=a.substring(g.startColumn-1,g.endColumn-1).toLowerCase();if(e.isOpen(l)?i++:e.isClose(l)&&i--,0===i)return g;c=g.startColumn-1}return null};for(let e=t.lineNumber;e>=1;e--){const n=this.textModel.tokenization.getLineTokens(e),r=n.getCount(),i=this.textModel.getLineContent(e);let o=r-1,c=i.length,g=i.length;e===t.lineNumber&&(o=n.findTokenIndexAtOffset(t.column-1),c=t.column-1,g=t.column-1);let l=!0;for(;o>=0;o--){const t=n.getLanguageId(o)===a&&!ignoreBracketsInToken(n.getStandardTokenType(o));if(t)l?c=n.getStartOffset(o):(c=n.getStartOffset(o),g=n.getEndOffset(o));else if(l&&c!==g){const t=s(e,i,c,g);if(t)return t}l=t}if(l&&c!==g){const t=s(e,i,c,g);if(t)return t}}return null}_findMatchingBracketDown(e,t,n){const a=e.languageId,r=e.forwardRegex;let i=1,o=0;const s=(t,a,s,c)=>{for(;;){if(n&&++o%100==0&&!n())return BracketSearchCanceled.INSTANCE;const g=BracketsUtils.findNextBracketInRange(r,t,a,s,c);if(!g)break;const l=a.substring(g.startColumn-1,g.endColumn-1).toLowerCase();if(e.isOpen(l)?i++:e.isClose(l)&&i--,0===i)return g;s=g.endColumn-1}return null},c=this.textModel.getLineCount();for(let e=t.lineNumber;e<=c;e++){const n=this.textModel.tokenization.getLineTokens(e),r=n.getCount(),i=this.textModel.getLineContent(e);let o=0,c=0,g=0;e===t.lineNumber&&(o=n.findTokenIndexAtOffset(t.column-1),c=t.column-1,g=t.column-1);let l=!0;for(;o<r;o++){const t=n.getLanguageId(o)===a&&!ignoreBracketsInToken(n.getStandardTokenType(o));if(t)l||(c=n.getStartOffset(o)),g=n.getEndOffset(o);else if(l&&c!==g){const t=s(e,i,c,g);if(t)return t}l=t}if(l&&c!==g){const t=s(e,i,c,g);if(t)return t}}return null}findPrevBracket(e){var t;const n=this.textModel.validatePosition(e);if(this.canBuildAST)return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getFirstBracketBefore(n))||null;let a=null,r=null,i=null;for(let e=n.lineNumber;e>=1;e--){const t=this.textModel.tokenization.getLineTokens(e),o=t.getCount(),s=this.textModel.getLineContent(e);let c=o-1,g=s.length,l=s.length;if(e===n.lineNumber){c=t.findTokenIndexAtOffset(n.column-1),g=n.column-1,l=n.column-1;const e=t.getLanguageId(c);a!==e&&(a=e,r=this.languageConfigurationService.getLanguageConfiguration(a).brackets,i=this.languageConfigurationService.getLanguageConfiguration(a).bracketsNew)}let u=!0;for(;c>=0;c--){const n=t.getLanguageId(c);if(a!==n){if(r&&i&&u&&g!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,g,l);if(t)return this._toFoundBracket(i,t);u=!1}a=n,r=this.languageConfigurationService.getLanguageConfiguration(a).brackets,i=this.languageConfigurationService.getLanguageConfiguration(a).bracketsNew}const o=!!r&&!ignoreBracketsInToken(t.getStandardTokenType(c));if(o)u?g=t.getStartOffset(c):(g=t.getStartOffset(c),l=t.getEndOffset(c));else if(i&&r&&u&&g!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,g,l);if(t)return this._toFoundBracket(i,t)}u=o}if(i&&r&&u&&g!==l){const t=BracketsUtils.findPrevBracketInRange(r.reversedRegex,e,s,g,l);if(t)return this._toFoundBracket(i,t)}}return null}findNextBracket(e){var t;const n=this.textModel.validatePosition(e);if(this.canBuildAST)return this.bracketsRequested=!0,this.updateBracketPairsTree(),(null===(t=this.bracketPairsTree.value)||void 0===t?void 0:t.object.getFirstBracketAfter(n))||null;const a=this.textModel.getLineCount();let r=null,i=null,o=null;for(let e=n.lineNumber;e<=a;e++){const t=this.textModel.tokenization.getLineTokens(e),a=t.getCount(),s=this.textModel.getLineContent(e);let c=0,g=0,l=0;if(e===n.lineNumber){c=t.findTokenIndexAtOffset(n.column-1),g=n.column-1,l=n.column-1;const e=t.getLanguageId(c);r!==e&&(r=e,i=this.languageConfigurationService.getLanguageConfiguration(r).brackets,o=this.languageConfigurationService.getLanguageConfiguration(r).bracketsNew)}let u=!0;for(;c<a;c++){const n=t.getLanguageId(c);if(r!==n){if(o&&i&&u&&g!==l){const t=BracketsUtils.findNextBracketInRange(i.forwardRegex,e,s,g,l);if(t)return this._toFoundBracket(o,t);u=!1}r=n,i=this.languageConfigurationService.getLanguageConfiguration(r).brackets,o=this.languageConfigurationService.getLanguageConfiguration(r).bracketsNew}const a=!!i&&!ignoreBracketsInToken(t.getStandardTokenType(c));if(a)u||(g=t.getStartOffset(c)),l=t.getEndOffset(c);else if(o&&i&&u&&g!==l){const t=BracketsUtils.findNextBracketInRange(i.forwardRegex,e,s,g,l);if(t)return this._toFoundBracket(o,t)}u=a}if(o&&i&&u&&g!==l){const t=BracketsUtils.findNextBracketInRange(i.forwardRegex,e,s,g,l);if(t)return this._toFoundBracket(o,t)}}return null}findEnclosingBrackets(e,t){const n=this.textModel.validatePosition(e);if(this.canBuildAST){const e=Range.fromPositions(n),t=this.getBracketPairsInRange(Range.fromPositions(n,n)).findLast((t=>void 0!==t.closingBracketRange&&t.range.strictContainsRange(e)));return t?[t.openingBracketRange,t.closingBracketRange]:null}const a=createTimeBasedContinueBracketSearchPredicate(t),r=this.textModel.getLineCount(),i=new Map;let o=[];const s=(e,t)=>{if(!i.has(e)){const n=[];for(let e=0,a=t?t.brackets.length:0;e<a;e++)n[e]=0;i.set(e,n)}o=i.get(e)};let c=0;const g=(e,t,n,r,i)=>{for(;;){if(a&&++c%100==0&&!a())return BracketSearchCanceled.INSTANCE;const s=BracketsUtils.findNextBracketInRange(e.forwardRegex,t,n,r,i);if(!s)break;const g=n.substring(s.startColumn-1,s.endColumn-1).toLowerCase(),l=e.textIsBracket[g];if(l&&(l.isOpen(g)?o[l.index]++:l.isClose(g)&&o[l.index]--,-1===o[l.index]))return this._matchFoundBracket(s,l,!1,a);r=s.endColumn-1}return null};let l=null,u=null;for(let e=n.lineNumber;e<=r;e++){const t=this.textModel.tokenization.getLineTokens(e),a=t.getCount(),r=this.textModel.getLineContent(e);let i=0,o=0,c=0;if(e===n.lineNumber){i=t.findTokenIndexAtOffset(n.column-1),o=n.column-1,c=n.column-1;const e=t.getLanguageId(i);l!==e&&(l=e,u=this.languageConfigurationService.getLanguageConfiguration(l).brackets,s(l,u))}let d=!0;for(;i<a;i++){const n=t.getLanguageId(i);if(l!==n){if(u&&d&&o!==c){const t=g(u,e,r,o,c);if(t)return stripBracketSearchCanceled(t);d=!1}l=n,u=this.languageConfigurationService.getLanguageConfiguration(l).brackets,s(l,u)}const a=!!u&&!ignoreBracketsInToken(t.getStandardTokenType(i));if(a)d||(o=t.getStartOffset(i)),c=t.getEndOffset(i);else if(u&&d&&o!==c){const t=g(u,e,r,o,c);if(t)return stripBracketSearchCanceled(t)}d=a}if(u&&d&&o!==c){const t=g(u,e,r,o,c);if(t)return stripBracketSearchCanceled(t)}}return null}_toFoundBracket(e,t){if(!t)return null;let n=this.textModel.getValueInRange(t);n=n.toLowerCase();const a=e.getBracketInfo(n);return a?{range:t,bracketInfo:a}:null}}function createDisposableRef(e,t){return{object:e,dispose:()=>null==t?void 0:t.dispose()}}function createTimeBasedContinueBracketSearchPredicate(e){if(void 0===e)return()=>!0;{const t=Date.now();return()=>Date.now()-t<=e}}class BracketSearchCanceled{constructor(){this._searchCanceledBrand=void 0}}function stripBracketSearchCanceled(e){return e instanceof BracketSearchCanceled?null:e}BracketSearchCanceled.INSTANCE=new BracketSearchCanceled;