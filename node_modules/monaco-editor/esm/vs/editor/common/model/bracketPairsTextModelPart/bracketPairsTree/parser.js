import{InvalidBracketAstNode,ListAstNode,PairAstNode}from"./ast.js";import{BeforeEditPositionMapper}from"./beforeEditPositionMapper.js";import{SmallImmutableSet}from"./smallImmutableSet.js";import{lengthIsZero,lengthLessThan}from"./length.js";import{concat23Trees,concat23TreesOfSameHeight}from"./concat23Trees.js";import{NodeReader}from"./nodeReader.js";export function parseDocument(e,t,s,r){return new Parser(e,t,s,r).parseDocument()}class Parser{constructor(e,t,s,r){if(this.tokenizer=e,this.createImmutableLists=r,this._itemsConstructed=0,this._itemsFromCache=0,s&&r)throw new Error("Not supported");this.oldNodeReader=s?new NodeReader(s):void 0,this.positionMapper=new BeforeEditPositionMapper(t)}parseDocument(){this._itemsConstructed=0,this._itemsFromCache=0;let e=this.parseList(SmallImmutableSet.getEmpty());return e||(e=ListAstNode.getEmpty()),e}parseList(e){const t=[];for(;;){let s=this.tryReadChildFromCache(e);if(!s){const t=this.tokenizer.peek();if(!t||2===t.kind&&t.bracketIds.intersects(e))break;s=this.parseChild(e)}4===s.kind&&0===s.childrenLength||t.push(s)}return this.oldNodeReader?concat23Trees(t):concat23TreesOfSameHeight(t,this.createImmutableLists)}tryReadChildFromCache(e){if(this.oldNodeReader){const t=this.positionMapper.getDistanceToNextChange(this.tokenizer.offset);if(null===t||!lengthIsZero(t)){const s=this.oldNodeReader.readLongestNodeAt(this.positionMapper.getOffsetBeforeChange(this.tokenizer.offset),(s=>!(null!==t&&!lengthLessThan(s.length,t))&&s.canBeReused(e)));if(s)return this._itemsFromCache++,this.tokenizer.skip(s.length),s}}}parseChild(e){this._itemsConstructed++;const t=this.tokenizer.read();switch(t.kind){case 2:return new InvalidBracketAstNode(t.bracketIds,t.length);case 0:return t.astNode;case 1:{const s=e.merge(t.bracketIds),r=this.parseList(s),o=this.tokenizer.peek();return o&&2===o.kind&&(o.bracketId===t.bracketId||o.bracketIds.intersects(t.bracketIds))?(this.tokenizer.read(),PairAstNode.create(t.astNode,r,o.astNode)):PairAstNode.create(t.astNode,r,null)}default:throw new Error("unexpected")}}}