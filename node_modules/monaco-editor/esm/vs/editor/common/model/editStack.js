import*as nls from"../../../nls.js";import{onUnexpectedError}from"../../../base/common/errors.js";import{Selection}from"../core/selection.js";import{URI}from"../../../base/common/uri.js";import{TextChange,compressConsecutiveTextChanges}from"../core/textChange.js";import*as buffer from"../../../base/common/buffer.js";import{basename}from"../../../base/common/resources.js";function uriGetComparisonKey(t){return t.toString()}export class SingleModelEditStackData{static create(t,e){const i=t.getAlternativeVersionId(),s=getModelEOL(t);return new SingleModelEditStackData(i,i,s,s,e,e,[])}constructor(t,e,i,s,r,n,a){this.beforeVersionId=t,this.afterVersionId=e,this.beforeEOL=i,this.afterEOL=s,this.beforeCursorState=r,this.afterCursorState=n,this.changes=a}append(t,e,i,s,r){e.length>0&&(this.changes=compressConsecutiveTextChanges(this.changes,e)),this.afterEOL=i,this.afterVersionId=s,this.afterCursorState=r}static _writeSelectionsSize(t){return 4+16*(t?t.length:0)}static _writeSelections(t,e,i){if(buffer.writeUInt32BE(t,e?e.length:0,i),i+=4,e)for(const s of e)buffer.writeUInt32BE(t,s.selectionStartLineNumber,i),i+=4,buffer.writeUInt32BE(t,s.selectionStartColumn,i),i+=4,buffer.writeUInt32BE(t,s.positionLineNumber,i),i+=4,buffer.writeUInt32BE(t,s.positionColumn,i),i+=4;return i}static _readSelections(t,e,i){const s=buffer.readUInt32BE(t,e);e+=4;for(let r=0;r<s;r++){const s=buffer.readUInt32BE(t,e);e+=4;const r=buffer.readUInt32BE(t,e);e+=4;const n=buffer.readUInt32BE(t,e);e+=4;const a=buffer.readUInt32BE(t,e);e+=4,i.push(new Selection(s,r,n,a))}return e}serialize(){let t=10+SingleModelEditStackData._writeSelectionsSize(this.beforeCursorState)+SingleModelEditStackData._writeSelectionsSize(this.afterCursorState)+4;for(const e of this.changes)t+=e.writeSize();const e=new Uint8Array(t);let i=0;buffer.writeUInt32BE(e,this.beforeVersionId,i),i+=4,buffer.writeUInt32BE(e,this.afterVersionId,i),i+=4,buffer.writeUInt8(e,this.beforeEOL,i),i+=1,buffer.writeUInt8(e,this.afterEOL,i),i+=1,i=SingleModelEditStackData._writeSelections(e,this.beforeCursorState,i),i=SingleModelEditStackData._writeSelections(e,this.afterCursorState,i),buffer.writeUInt32BE(e,this.changes.length,i),i+=4;for(const t of this.changes)i=t.write(e,i);return e.buffer}static deserialize(t){const e=new Uint8Array(t);let i=0;const s=buffer.readUInt32BE(e,i);i+=4;const r=buffer.readUInt32BE(e,i);i+=4;const n=buffer.readUInt8(e,i);i+=1;const a=buffer.readUInt8(e,i);i+=1;const o=[];i=SingleModelEditStackData._readSelections(e,i,o);const d=[];i=SingleModelEditStackData._readSelections(e,i,d);const l=buffer.readUInt32BE(e,i);i+=4;const c=[];for(let t=0;t<l;t++)i=TextChange.read(e,i,c);return new SingleModelEditStackData(s,r,n,a,o,d,c)}}export class SingleModelEditStackElement{get type(){return 0}get resource(){return URI.isUri(this.model)?this.model:this.model.uri}constructor(t,e,i,s){this.label=t,this.code=e,this.model=i,this._data=SingleModelEditStackData.create(i,s)}toString(){return(this._data instanceof SingleModelEditStackData?this._data:SingleModelEditStackData.deserialize(this._data)).changes.map((t=>t.toString())).join(", ")}matchesResource(t){return(URI.isUri(this.model)?this.model:this.model.uri).toString()===t.toString()}setModel(t){this.model=t}canAppend(t){return this.model===t&&this._data instanceof SingleModelEditStackData}append(t,e,i,s,r){this._data instanceof SingleModelEditStackData&&this._data.append(t,e,i,s,r)}close(){this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize())}open(){this._data instanceof SingleModelEditStackData||(this._data=SingleModelEditStackData.deserialize(this._data))}undo(){if(URI.isUri(this.model))throw new Error("Invalid SingleModelEditStackElement");this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize());const t=SingleModelEditStackData.deserialize(this._data);this.model._applyUndo(t.changes,t.beforeEOL,t.beforeVersionId,t.beforeCursorState)}redo(){if(URI.isUri(this.model))throw new Error("Invalid SingleModelEditStackElement");this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize());const t=SingleModelEditStackData.deserialize(this._data);this.model._applyRedo(t.changes,t.afterEOL,t.afterVersionId,t.afterCursorState)}heapSize(){return this._data instanceof SingleModelEditStackData&&(this._data=this._data.serialize()),this._data.byteLength+168}}export class MultiModelEditStackElement{get resources(){return this._editStackElementsArr.map((t=>t.resource))}constructor(t,e,i){this.label=t,this.code=e,this.type=1,this._isOpen=!0,this._editStackElementsArr=i.slice(0),this._editStackElementsMap=new Map;for(const t of this._editStackElementsArr){const e=uriGetComparisonKey(t.resource);this._editStackElementsMap.set(e,t)}this._delegate=null}prepareUndoRedo(){if(this._delegate)return this._delegate.prepareUndoRedo(this)}matchesResource(t){const e=uriGetComparisonKey(t);return this._editStackElementsMap.has(e)}setModel(t){const e=uriGetComparisonKey(URI.isUri(t)?t:t.uri);this._editStackElementsMap.has(e)&&this._editStackElementsMap.get(e).setModel(t)}canAppend(t){if(!this._isOpen)return!1;const e=uriGetComparisonKey(t.uri);return!!this._editStackElementsMap.has(e)&&this._editStackElementsMap.get(e).canAppend(t)}append(t,e,i,s,r){const n=uriGetComparisonKey(t.uri);this._editStackElementsMap.get(n).append(t,e,i,s,r)}close(){this._isOpen=!1}open(){}undo(){this._isOpen=!1;for(const t of this._editStackElementsArr)t.undo()}redo(){for(const t of this._editStackElementsArr)t.redo()}heapSize(t){const e=uriGetComparisonKey(t);return this._editStackElementsMap.has(e)?this._editStackElementsMap.get(e).heapSize():0}split(){return this._editStackElementsArr}toString(){const t=[];for(const e of this._editStackElementsArr)t.push(`${basename(e.resource)}: ${e}`);return`{${t.join(", ")}}`}}function getModelEOL(t){return"\n"===t.getEOL()?0:1}export function isEditStackElement(t){return!!t&&(t instanceof SingleModelEditStackElement||t instanceof MultiModelEditStackElement)}export class EditStack{constructor(t,e){this._model=t,this._undoRedoService=e}pushStackElement(){const t=this._undoRedoService.getLastElement(this._model.uri);isEditStackElement(t)&&t.close()}popStackElement(){const t=this._undoRedoService.getLastElement(this._model.uri);isEditStackElement(t)&&t.open()}clear(){this._undoRedoService.removeElements(this._model.uri)}_getOrCreateEditStackElement(t,e){const i=this._undoRedoService.getLastElement(this._model.uri);if(isEditStackElement(i)&&i.canAppend(this._model))return i;const s=new SingleModelEditStackElement(nls.localize("edit","Typing"),"undoredo.textBufferEdit",this._model,t);return this._undoRedoService.pushElement(s,e),s}pushEOL(t){const e=this._getOrCreateEditStackElement(null,void 0);this._model.setEOL(t),e.append(this._model,[],getModelEOL(this._model),this._model.getAlternativeVersionId(),null)}pushEditOperation(t,e,i,s){const r=this._getOrCreateEditStackElement(t,s),n=this._model.applyEdits(e,!0),a=EditStack._computeCursorState(i,n),o=n.map(((t,e)=>({index:e,textChange:t.textChange})));return o.sort(((t,e)=>t.textChange.oldPosition===e.textChange.oldPosition?t.index-e.index:t.textChange.oldPosition-e.textChange.oldPosition)),r.append(this._model,o.map((t=>t.textChange)),getModelEOL(this._model),this._model.getAlternativeVersionId(),a),a}static _computeCursorState(t,e){try{return t?t(e):null}catch(t){return onUnexpectedError(t),null}}}