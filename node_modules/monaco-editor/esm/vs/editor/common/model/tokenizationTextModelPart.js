import{Emitter}from"../../../base/common/event.js";import{Position}from"../core/position.js";import{getWordAtText}from"../core/wordHelper.js";import{TextModelPart}from"./textModelPart.js";import{TextModelTokenization}from"./textModelTokens.js";import{ContiguousTokensStore}from"../tokens/contiguousTokensStore.js";import{SparseTokensStore}from"../tokens/sparseTokensStore.js";export class TokenizationTextModelPart extends TextModelPart{constructor(e,t,n,i,o){super(),this._languageService=e,this._languageConfigurationService=t,this._textModel=n,this.bracketPairsTextModelPart=i,this._languageId=o,this._onDidChangeLanguage=this._register(new Emitter),this.onDidChangeLanguage=this._onDidChangeLanguage.event,this._onDidChangeLanguageConfiguration=this._register(new Emitter),this.onDidChangeLanguageConfiguration=this._onDidChangeLanguageConfiguration.event,this._onDidChangeTokens=this._register(new Emitter),this.onDidChangeTokens=this._onDidChangeTokens.event,this._backgroundTokenizationState=0,this._onBackgroundTokenizationStateChanged=this._register(new Emitter),this._tokens=new ContiguousTokensStore(this._languageService.languageIdCodec),this._semanticTokens=new SparseTokensStore(this._languageService.languageIdCodec),this._tokenization=new TextModelTokenization(n,this,this._languageService.languageIdCodec),this._languageRegistryListener=this._languageConfigurationService.onDidChange((e=>{e.affects(this._languageId)&&this._onDidChangeLanguageConfiguration.fire({})}))}acceptEdit(e,t,n,i,o){this._tokens.acceptEdit(e,n,i),this._semanticTokens.acceptEdit(e,n,i,o,t.length>0?t.charCodeAt(0):0)}handleDidChangeAttached(){this._tokenization.handleDidChangeAttached()}flush(){this._tokens.flush(),this._semanticTokens.flush()}handleDidChangeContent(e){this._tokenization.handleDidChangeContent(e)}dispose(){this._languageRegistryListener.dispose(),this._tokenization.dispose(),super.dispose()}get backgroundTokenizationState(){return this._backgroundTokenizationState}handleTokenizationProgress(e){if(2===this._backgroundTokenizationState)return;const t=e?2:1;this._backgroundTokenizationState!==t&&(this._backgroundTokenizationState=t,this.bracketPairsTextModelPart.handleDidChangeBackgroundTokenizationState(),this._onBackgroundTokenizationStateChanged.fire())}setTokens(e,t=!1){if(0!==e.length){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];let o=0,a=0,s=!1;for(let e=i.startLineNumber;e<=i.endLineNumber;e++)s?(this._tokens.setTokens(this._languageId,e-1,this._textModel.getLineLength(e),i.getLineTokens(e),!1),a=e):this._tokens.setTokens(this._languageId,e-1,this._textModel.getLineLength(e),i.getLineTokens(e),!0)&&(s=!0,o=e,a=e);s&&t.push({fromLineNumber:o,toLineNumber:a})}t.length>0&&this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:!1,ranges:t})}this.handleTokenizationProgress(t)}setSemanticTokens(e,t){this._semanticTokens.set(e,t),this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:null!==e,ranges:[{fromLineNumber:1,toLineNumber:this._textModel.getLineCount()}]})}hasCompleteSemanticTokens(){return this._semanticTokens.isComplete()}hasSomeSemanticTokens(){return!this._semanticTokens.isEmpty()}setPartialSemanticTokens(e,t){if(this.hasCompleteSemanticTokens())return;const n=this._textModel.validateRange(this._semanticTokens.setPartial(e,t));this._emitModelTokensChangedEvent({tokenizationSupportChanged:!1,semanticTokensApplied:!0,ranges:[{fromLineNumber:n.startLineNumber,toLineNumber:n.endLineNumber}]})}tokenizeViewport(e,t){e=Math.max(1,e),t=Math.min(this._textModel.getLineCount(),t),this._tokenization.tokenizeViewport(e,t)}clearTokens(){this._tokens.flush(),this._emitModelTokensChangedEvent({tokenizationSupportChanged:!0,semanticTokensApplied:!1,ranges:[{fromLineNumber:1,toLineNumber:this._textModel.getLineCount()}]})}_emitModelTokensChangedEvent(e){this._textModel._isDisposing()||(this.bracketPairsTextModelPart.handleDidChangeTokens(e),this._onDidChangeTokens.fire(e))}resetTokenization(){this._tokenization.reset()}forceTokenization(e){if(e<1||e>this._textModel.getLineCount())throw new Error("Illegal value for lineNumber");this._tokenization.forceTokenization(e)}isCheapToTokenize(e){return this._tokenization.isCheapToTokenize(e)}tokenizeIfCheap(e){this.isCheapToTokenize(e)&&this.forceTokenization(e)}getLineTokens(e){if(e<1||e>this._textModel.getLineCount())throw new Error("Illegal value for lineNumber");return this._getLineTokens(e)}_getLineTokens(e){const t=this._textModel.getLineContent(e),n=this._tokens.getTokens(this._languageId,e-1,t);return this._semanticTokens.addSparseTokens(e,n)}getTokenTypeIfInsertingCharacter(e,t,n){const i=this._textModel.validatePosition(new Position(e,t));return this._tokenization.getTokenTypeIfInsertingCharacter(i,n)}tokenizeLineWithEdit(e,t,n){const i=this._textModel.validatePosition(e);return this._tokenization.tokenizeLineWithEdit(i,t,n)}getLanguageConfiguration(e){return this._languageConfigurationService.getLanguageConfiguration(e)}getWordAtPosition(e){this.assertNotDisposed();const t=this._textModel.validatePosition(e),n=this._textModel.getLineContent(t.lineNumber),i=this._getLineTokens(t.lineNumber),o=i.findTokenIndexAtOffset(t.column-1),[a,s]=TokenizationTextModelPart._findLanguageBoundaries(i,o),r=getWordAtText(t.column,this.getLanguageConfiguration(i.getLanguageId(o)).getWordDefinition(),n.substring(a,s),a);if(r&&r.startColumn<=e.column&&e.column<=r.endColumn)return r;if(o>0&&a===t.column-1){const[a,s]=TokenizationTextModelPart._findLanguageBoundaries(i,o-1),r=getWordAtText(t.column,this.getLanguageConfiguration(i.getLanguageId(o-1)).getWordDefinition(),n.substring(a,s),a);if(r&&r.startColumn<=e.column&&e.column<=r.endColumn)return r}return null}static _findLanguageBoundaries(e,t){const n=e.getLanguageId(t);let i=0;for(let o=t;o>=0&&e.getLanguageId(o)===n;o--)i=e.getStartOffset(o);let o=e.getLineContent().length;for(let i=t,a=e.getCount();i<a&&e.getLanguageId(i)===n;i++)o=e.getEndOffset(i);return[i,o]}getWordUntilPosition(e){const t=this.getWordAtPosition(e);return t?{word:t.word.substr(0,e.column-t.startColumn),startColumn:t.startColumn,endColumn:e.column}:{word:"",startColumn:e.column,endColumn:e.column}}getLanguageId(){return this._languageId}getLanguageIdAtPosition(e,t){const n=this._textModel.validatePosition(new Position(e,t)),i=this.getLineTokens(n.lineNumber);return i.getLanguageId(i.findTokenIndexAtOffset(n.column-1))}setLanguageId(e,t="api"){if(this._languageId===e)return;const n={oldLanguage:this._languageId,newLanguage:e,source:t};this._languageId=e,this.bracketPairsTextModelPart.handleDidChangeLanguage(n),this._tokenization.handleDidChangeLanguage(n),this._onDidChangeLanguage.fire(n),this._onDidChangeLanguageConfiguration.fire({})}}