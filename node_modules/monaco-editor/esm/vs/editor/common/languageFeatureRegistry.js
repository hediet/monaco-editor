import{Emitter}from"../../base/common/event.js";import{toDisposable}from"../../base/common/lifecycle.js";import{shouldSynchronizeModel}from"./model.js";import{score}from"./languageSelector.js";function isExclusive(e){return"string"!=typeof e&&(Array.isArray(e)?e.every(isExclusive):!!e.exclusive)}class MatchCandidate{constructor(e,t,o,r){this.uri=e,this.languageId=t,this.notebookUri=o,this.notebookType=r}equals(e){var t,o;return this.notebookType===e.notebookType&&this.languageId===e.languageId&&this.uri.toString()===e.uri.toString()&&(null===(t=this.notebookUri)||void 0===t?void 0:t.toString())===(null===(o=e.notebookUri)||void 0===o?void 0:o.toString())}}export class LanguageFeatureRegistry{constructor(e){this._notebookInfoResolver=e,this._clock=0,this._entries=[],this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event}register(e,t){let o={selector:e,provider:t,_score:-1,_time:this._clock++};return this._entries.push(o),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),toDisposable((()=>{if(o){const e=this._entries.indexOf(o);e>=0&&(this._entries.splice(e,1),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),o=void 0)}}))}has(e){return this.all(e).length>0}all(e){if(!e)return[];this._updateScores(e);const t=[];for(const e of this._entries)e._score>0&&t.push(e.provider);return t}ordered(e){const t=[];return this._orderedForEach(e,(e=>t.push(e.provider))),t}orderedGroups(e){const t=[];let o,r;return this._orderedForEach(e,(e=>{o&&r===e._score?o.push(e.provider):(r=e._score,o=[e.provider],t.push(o))})),t}_orderedForEach(e,t){this._updateScores(e);for(const e of this._entries)e._score>0&&t(e)}_updateScores(e){var t,o;const r=null===(t=this._notebookInfoResolver)||void 0===t?void 0:t.call(this,e.uri),i=r?new MatchCandidate(e.uri,e.getLanguageId(),r.uri,r.type):new MatchCandidate(e.uri,e.getLanguageId(),void 0,void 0);if(!(null===(o=this._lastCandidate)||void 0===o?void 0:o.equals(i))){this._lastCandidate=i;for(const t of this._entries)if(t._score=score(t.selector,i.uri,i.languageId,shouldSynchronizeModel(e),i.notebookUri,i.notebookType),isExclusive(t.selector)&&t._score>0){for(const e of this._entries)e._score=0;t._score=1e3;break}this._entries.sort(LanguageFeatureRegistry._compareByScoreAndTime)}}static _compareByScoreAndTime(e,t){return e._score<t._score?1:e._score>t._score?-1:e._time<t._time?1:e._time>t._time?-1:0}}