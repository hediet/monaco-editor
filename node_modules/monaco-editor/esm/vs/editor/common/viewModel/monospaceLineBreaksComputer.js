import*as strings from"../../../base/common/strings.js";import{CharacterClassifier}from"../core/characterClassifier.js";import{LineInjectedText}from"../textModelEvents.js";import{ModelLineProjectionData}from"../modelLineProjectionData.js";export class MonospaceLineBreaksComputerFactory{static create(e){return new MonospaceLineBreaksComputerFactory(e.get(127),e.get(126))}constructor(e,t){this.classifier=new WrappingCharacterClassifier(e,t)}createLineBreaksComputer(e,t,r,a,n){const i=[],o=[],s=[];return{addRequest:(e,t,r)=>{i.push(e),o.push(t),s.push(r)},finalize:()=>{const l=e.typicalFullwidthCharacterWidth/e.typicalHalfwidthCharacterWidth,c=[];for(let e=0,h=i.length;e<h;e++){const h=o[e],f=s[e];!f||f.injectionOptions||h?c[e]=createLineBreaks(this.classifier,i[e],h,t,r,l,a,n):c[e]=createLineBreaksFromPreviousLineBreaks(this.classifier,f,i[e],t,r,l,a,n)}return arrPool1.length=0,arrPool2.length=0,c}}}}class WrappingCharacterClassifier extends CharacterClassifier{constructor(e,t){super(0);for(let t=0;t<e.length;t++)this.set(e.charCodeAt(t),1);for(let e=0;e<t.length;e++)this.set(t.charCodeAt(e),2)}get(e){return e>=0&&e<256?this._asciiMap[e]:e>=12352&&e<=12543||e>=13312&&e<=19903||e>=19968&&e<=40959?3:this._map.get(e)||this._defaultValue}}let arrPool1=[],arrPool2=[];function createLineBreaksFromPreviousLineBreaks(e,t,r,a,n,i,o,s){if(-1===n)return null;const l=r.length;if(l<=1)return null;const c="keepAll"===s,h=t.breakOffsets,f=t.breakOffsetsVisibleColumn,u=computeWrappedTextIndentLength(r,a,n,i,o),g=n-u,d=arrPool1,p=arrPool2;let C=0,m=0,k=0,b=n;const L=h.length;let W=0;if(W>=0){let e=Math.abs(f[W]-b);for(;W+1<L;){const t=Math.abs(f[W+1]-b);if(t>=e)break;e=t,W++}}for(;W<L;){let t=W<0?0:h[W],n=W<0?0:f[W];m>t&&(t=m,n=k);let o=0,s=0,u=0,P=0;if(n<=b){let k=n,L=0===t?0:r.charCodeAt(t-1),W=0===t?0:e.get(L),A=!0;for(let n=t;n<l;n++){const t=n,l=r.charCodeAt(n);let h,f;if(strings.isHighSurrogate(l)?(n++,h=0,f=2):(h=e.get(l),f=computeCharWidth(l,k,a,i)),t>m&&canBreak(L,W,l,h,c)&&(o=t,s=k),k+=f,k>b){t>m?(u=t,P=k-f):(u=n+1,P=k),k-s>g&&(o=0),A=!1;break}L=l,W=h}if(A){C>0&&(d[C]=h[h.length-1],p[C]=f[h.length-1],C++);break}}if(0===o){let l=n,h=r.charCodeAt(t),f=e.get(h),d=!1;for(let a=t-1;a>=m;a--){const t=a+1,n=r.charCodeAt(a);if(9===n){d=!0;break}let p,C;if(strings.isLowSurrogate(n)?(a--,p=0,C=2):(p=e.get(n),C=strings.isFullWidthCharacter(n)?i:1),l<=b){if(0===u&&(u=t,P=l),l<=b-g)break;if(canBreak(n,p,h,f,c)){o=t,s=l;break}}l-=C,h=n,f=p}if(0!==o){const e=g-(P-s);if(e<=a){const t=r.charCodeAt(u);let n;n=strings.isHighSurrogate(t)?2:computeCharWidth(t,P,a,i),e-n<0&&(o=0)}}if(d){W--;continue}}if(0===o&&(o=u,s=P),o<=m){const e=r.charCodeAt(m);strings.isHighSurrogate(e)?(o=m+2,s=k+2):(o=m+1,s=k+computeCharWidth(e,k,a,i))}for(m=o,d[C]=o,k=s,p[C]=s,C++,b=s+g;W<0||W<L&&f[W]<s;)W++;let A=Math.abs(f[W]-b);for(;W+1<L;){const e=Math.abs(f[W+1]-b);if(e>=A)break;A=e,W++}}return 0===C?null:(d.length=C,p.length=C,arrPool1=t.breakOffsets,arrPool2=t.breakOffsetsVisibleColumn,t.breakOffsets=d,t.breakOffsetsVisibleColumn=p,t.wrappedTextIndentLength=u,t)}function createLineBreaks(e,t,r,a,n,i,o,s){const l=LineInjectedText.applyInjectedText(t,r);let c,h;if(r&&r.length>0?(c=r.map((e=>e.options)),h=r.map((e=>e.column-1))):(c=null,h=null),-1===n)return c?new ModelLineProjectionData(h,c,[l.length],[],0):null;const f=l.length;if(f<=1)return c?new ModelLineProjectionData(h,c,[l.length],[],0):null;const u="keepAll"===s,g=computeWrappedTextIndentLength(l,a,n,i,o),d=n-g,p=[],C=[];let m=0,k=0,b=0,L=n,W=l.charCodeAt(0),P=e.get(W),A=computeCharWidth(W,0,a,i),j=1;strings.isHighSurrogate(W)&&(A+=1,W=l.charCodeAt(1),P=e.get(W),j++);for(let t=j;t<f;t++){const r=t,n=l.charCodeAt(t);let o,s;strings.isHighSurrogate(n)?(t++,o=0,s=2):(o=e.get(n),s=computeCharWidth(n,A,a,i)),canBreak(W,P,n,o,u)&&(k=r,b=A),A+=s,A>L&&((0===k||A-b>d)&&(k=r,b=A-s),p[m]=k,C[m]=b,m++,L=b+d,k=0),W=n,P=o}return 0!==m||r&&0!==r.length?(p[m]=f,C[m]=A,new ModelLineProjectionData(h,c,p,C,g)):null}function computeCharWidth(e,t,r,a){return 9===e?r-t%r:strings.isFullWidthCharacter(e)||e<32?a:1}function tabCharacterWidth(e,t){return t-e%t}function canBreak(e,t,r,a,n){return 32!==r&&(2===t&&2!==a||1!==t&&1===a||!n&&3===t&&2!==a||!n&&3===a&&1!==t)}function computeWrappedTextIndentLength(e,t,r,a,n){let i=0;if(0!==n){const o=strings.firstNonWhitespaceIndex(e);if(-1!==o){for(let r=0;r<o;r++)i+=9===e.charCodeAt(r)?tabCharacterWidth(i,t):1;const s=3===n?2:2===n?1:0;for(let e=0;e<s;e++)i+=tabCharacterWidth(i,t);i+a>r&&(i=0)}}return i}