import{Position}from"../core/position.js";import{Range}from"../core/range.js";import{InlineDecoration,ViewModelDecoration}from"../viewModel.js";import{filterValidationDecorations}from"../config/editorOptions.js";export class ViewModelDecorations{constructor(e,n,o,t,i){this._cachedOnlyMinimapDecorations=null,this.editorId=e,this.model=n,this.configuration=o,this._linesCollection=t,this._coordinatesConverter=i,this._decorationsCache=Object.create(null),this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}_clearCachedModelDecorationsResolver(){this._cachedModelDecorationsResolver=null,this._cachedModelDecorationsResolverViewRange=null}dispose(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}reset(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onModelDecorationsChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}onLineMappingChanged(){this._decorationsCache=Object.create(null),this._clearCachedModelDecorationsResolver()}_getOrCreateViewModelDecoration(e){const n=e.id;let o=this._decorationsCache[n];if(!o){const t=e.range,i=e.options;let r;if(i.isWholeLine){const e=this._coordinatesConverter.convertModelPositionToViewPosition(new Position(t.startLineNumber,1),0),n=this._coordinatesConverter.convertModelPositionToViewPosition(new Position(t.endLineNumber,this.model.getLineMaxColumn(t.endLineNumber)),1);r=new Range(e.lineNumber,e.column,n.lineNumber,n.column)}else r=this._coordinatesConverter.convertModelRangeToViewRange(t,1);o=new ViewModelDecoration(r,i),this._decorationsCache[n]=o}return o}getDecorationsViewportData(e,n=!1){let o=null!==this._cachedModelDecorationsResolver;return o=o&&e.equalsRange(this._cachedModelDecorationsResolverViewRange),o=o&&this._cachedOnlyMinimapDecorations===n,o||(this._cachedModelDecorationsResolver=this._getDecorationsInRange(e,n),this._cachedModelDecorationsResolverViewRange=e,this._cachedOnlyMinimapDecorations=n),this._cachedModelDecorationsResolver}getInlineDecorationsOnLine(e,n=!1){const o=new Range(e,this._linesCollection.getViewLineMinColumn(e),e,this._linesCollection.getViewLineMaxColumn(e));return this._getDecorationsInRange(o,n).inlineDecorations[0]}_getDecorationsInRange(e,n){const o=this._linesCollection.getDecorationsInRange(e,this.editorId,filterValidationDecorations(this.configuration.options),n),t=e.startLineNumber,i=e.endLineNumber,r=[];let s=0;const a=[];for(let e=t;e<=i;e++)a[e-t]=[];for(let e=0,n=o.length;e<n;e++){const n=o[e],c=n.options;if(!isModelDecorationVisible(this.model,n))continue;const l=this._getOrCreateViewModelDecoration(n),d=l.range;if(r[s++]=l,c.inlineClassName){const e=new InlineDecoration(d,c.inlineClassName,c.inlineClassNameAffectsLetterSpacing?3:0),n=Math.max(t,d.startLineNumber),o=Math.min(i,d.endLineNumber);for(let i=n;i<=o;i++)a[i-t].push(e)}if(c.beforeContentClassName&&t<=d.startLineNumber&&d.startLineNumber<=i){const e=new InlineDecoration(new Range(d.startLineNumber,d.startColumn,d.startLineNumber,d.startColumn),c.beforeContentClassName,1);a[d.startLineNumber-t].push(e)}if(c.afterContentClassName&&t<=d.endLineNumber&&d.endLineNumber<=i){const e=new InlineDecoration(new Range(d.endLineNumber,d.endColumn,d.endLineNumber,d.endColumn),c.afterContentClassName,2);a[d.endLineNumber-t].push(e)}}return{decorations:r,inlineDecorations:a}}}export function isModelDecorationVisible(e,n){return!(n.options.hideInCommentTokens&&isModelDecorationInComment(e,n)||n.options.hideInStringTokens&&isModelDecorationInString(e,n))}export function isModelDecorationInComment(e,n){return testTokensInRange(e,n.range,(e=>1===e))}export function isModelDecorationInString(e,n){return testTokensInRange(e,n.range,(e=>2===e))}function testTokensInRange(e,n,o){for(let t=n.startLineNumber;t<=n.endLineNumber;t++){const i=e.tokenization.getLineTokens(t),r=t===n.startLineNumber,s=t===n.endLineNumber;let a=r?i.findTokenIndexAtOffset(n.startColumn-1):0;for(;a<i.getCount()&&!(s&&i.getStartOffset(a)>n.endColumn-1);){if(!o(i.getStandardTokenType(a)))return!1;a++}}return!0}