import*as nls from"../../../nls.js";import*as strings from"../../../base/common/strings.js";import{StringBuilder}from"../core/stringBuilder.js";import{LineDecoration,LineDecorationsNormalizer}from"./lineDecorations.js";import{LinePart}from"./linePart.js";export class LineRange{constructor(e,t){this.startOffset=e,this.endOffset=t}equals(e){return this.startOffset===e.startOffset&&this.endOffset===e.endOffset}}export class RenderLineInput{constructor(e,t,n,r,i,s,a,o,h,c,p,d,l,f,g,u,C,L,m){this.useMonospaceOptimizations=e,this.canUseHalfwidthRightwardsArrow=t,this.lineContent=n,this.continuesWithWrappedLine=r,this.isBasicASCII=i,this.containsRTL=s,this.fauxIndentLength=a,this.lineTokens=o,this.lineDecorations=h.sort(LineDecoration.compare),this.tabSize=c,this.startVisibleColumn=p,this.spaceWidth=d,this.stopRenderingLineAfter=g,this.renderWhitespace="all"===u?4:"boundary"===u?1:"selection"===u?2:"trailing"===u?3:0,this.renderControlCharacters=C,this.fontLigatures=L,this.selectionsOnLine=m&&m.sort(((e,t)=>e.startOffset<t.startOffset?-1:1)),Math.abs(f-d)<Math.abs(l-d)?(this.renderSpaceWidth=f,this.renderSpaceCharCode=11825):(this.renderSpaceWidth=l,this.renderSpaceCharCode=183)}sameSelection(e){if(null===this.selectionsOnLine)return null===e;if(null===e)return!1;if(e.length!==this.selectionsOnLine.length)return!1;for(let t=0;t<this.selectionsOnLine.length;t++)if(!this.selectionsOnLine[t].equals(e[t]))return!1;return!0}equals(e){return this.useMonospaceOptimizations===e.useMonospaceOptimizations&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineContent===e.lineContent&&this.continuesWithWrappedLine===e.continuesWithWrappedLine&&this.isBasicASCII===e.isBasicASCII&&this.containsRTL===e.containsRTL&&this.fauxIndentLength===e.fauxIndentLength&&this.tabSize===e.tabSize&&this.startVisibleColumn===e.startVisibleColumn&&this.spaceWidth===e.spaceWidth&&this.renderSpaceWidth===e.renderSpaceWidth&&this.renderSpaceCharCode===e.renderSpaceCharCode&&this.stopRenderingLineAfter===e.stopRenderingLineAfter&&this.renderWhitespace===e.renderWhitespace&&this.renderControlCharacters===e.renderControlCharacters&&this.fontLigatures===e.fontLigatures&&LineDecoration.equalsArr(this.lineDecorations,e.lineDecorations)&&this.lineTokens.equals(e.lineTokens)&&this.sameSelection(e.selectionsOnLine)}}export class DomPosition{constructor(e,t){this.partIndex=e,this.charIndex=t}}export class CharacterMapping{static getPartIndex(e){return(4294901760&e)>>>16}static getCharIndex(e){return(65535&e)>>>0}constructor(e,t){this.length=e,this._data=new Uint32Array(this.length),this._horizontalOffset=new Uint32Array(this.length)}setColumnInfo(e,t,n,r){const i=(t<<16|n<<0)>>>0;this._data[e-1]=i,this._horizontalOffset[e-1]=r}getHorizontalOffset(e){return 0===this._horizontalOffset.length?0:this._horizontalOffset[e-1]}charOffsetToPartData(e){return 0===this.length?0:e<0?this._data[0]:e>=this.length?this._data[this.length-1]:this._data[e]}getDomPosition(e){const t=this.charOffsetToPartData(e-1),n=CharacterMapping.getPartIndex(t),r=CharacterMapping.getCharIndex(t);return new DomPosition(n,r)}getColumn(e,t){return this.partDataToCharOffset(e.partIndex,t,e.charIndex)+1}partDataToCharOffset(e,t,n){if(0===this.length)return 0;const r=(e<<16|n<<0)>>>0;let i=0,s=this.length-1;for(;i+1<s;){const e=i+s>>>1,t=this._data[e];if(t===r)return e;t>r?s=e:i=e}if(i===s)return i;const a=this._data[i],o=this._data[s];if(a===r)return i;if(o===r)return s;const h=CharacterMapping.getPartIndex(a),c=CharacterMapping.getCharIndex(a);let p;return p=h!==CharacterMapping.getPartIndex(o)?t:CharacterMapping.getCharIndex(o),n-c<=p-n?i:s}}export class RenderLineOutput{constructor(e,t,n){this._renderLineOutputBrand=void 0,this.characterMapping=e,this.containsRTL=t,this.containsForeignElements=n}}export function renderViewLine(e,t){if(0===e.lineContent.length){if(e.lineDecorations.length>0){t.appendString("<span>");let n=0,r=0,i=0;for(const s of e.lineDecorations)1!==s.type&&2!==s.type||(t.appendString('<span class="'),t.appendString(s.className),t.appendString('"></span>'),1===s.type&&(i|=1,n++),2===s.type&&(i|=2,r++));t.appendString("</span>");const s=new CharacterMapping(1,n+r);return s.setColumnInfo(1,n,0,0),new RenderLineOutput(s,!1,i)}return t.appendString("<span><span></span></span>"),new RenderLineOutput(new CharacterMapping(0,0),!1,0)}return _renderLine(resolveRenderLineInput(e),t)}export class RenderLineOutput2{constructor(e,t,n,r){this.characterMapping=e,this.html=t,this.containsRTL=n,this.containsForeignElements=r}}export function renderViewLine2(e){const t=new StringBuilder(1e4),n=renderViewLine(e,t);return new RenderLineOutput2(n.characterMapping,t.build(),n.containsRTL,n.containsForeignElements)}class ResolvedRenderLineInput{constructor(e,t,n,r,i,s,a,o,h,c,p,d,l,f,g,u){this.fontIsMonospace=e,this.canUseHalfwidthRightwardsArrow=t,this.lineContent=n,this.len=r,this.isOverflowing=i,this.overflowingCharCount=s,this.parts=a,this.containsForeignElements=o,this.fauxIndentLength=h,this.tabSize=c,this.startVisibleColumn=p,this.containsRTL=d,this.spaceWidth=l,this.renderSpaceCharCode=f,this.renderWhitespace=g,this.renderControlCharacters=u}}function resolveRenderLineInput(e){const t=e.lineContent;let n,r,i;-1!==e.stopRenderingLineAfter&&e.stopRenderingLineAfter<t.length?(n=!0,r=t.length-e.stopRenderingLineAfter,i=e.stopRenderingLineAfter):(n=!1,r=0,i=t.length);let s=transformAndRemoveOverflowing(t,e.containsRTL,e.lineTokens,e.fauxIndentLength,i);e.renderControlCharacters&&!e.isBasicASCII&&(s=extractControlCharacters(t,s)),(4===e.renderWhitespace||1===e.renderWhitespace||2===e.renderWhitespace&&e.selectionsOnLine||3===e.renderWhitespace&&!e.continuesWithWrappedLine)&&(s=_applyRenderWhitespace(e,t,i,s));let a=0;if(e.lineDecorations.length>0){for(let t=0,n=e.lineDecorations.length;t<n;t++){const n=e.lineDecorations[t];3===n.type||1===n.type?a|=1:2===n.type&&(a|=2)}s=_applyInlineDecorations(t,i,s,e.lineDecorations)}return e.containsRTL||(s=splitLargeTokens(t,s,!e.isBasicASCII||e.fontLigatures)),new ResolvedRenderLineInput(e.useMonospaceOptimizations,e.canUseHalfwidthRightwardsArrow,t,i,n,r,s,a,e.fauxIndentLength,e.tabSize,e.startVisibleColumn,e.containsRTL,e.spaceWidth,e.renderSpaceCharCode,e.renderWhitespace,e.renderControlCharacters)}function transformAndRemoveOverflowing(e,t,n,r,i){const s=[];let a=0;r>0&&(s[a++]=new LinePart(r,"",0,!1));let o=r;for(let h=0,c=n.getCount();h<c;h++){const c=n.getEndOffset(h);if(c<=r)continue;const p=n.getClassName(h);if(c>=i){const n=!!t&&strings.containsRTL(e.substring(o,i));s[a++]=new LinePart(i,p,0,n);break}const d=!!t&&strings.containsRTL(e.substring(o,c));s[a++]=new LinePart(c,p,0,d),o=c}return s}function splitLargeTokens(e,t,n){let r=0;const i=[];let s=0;if(n)for(let n=0,a=t.length;n<a;n++){const a=t[n],o=a.endIndex;if(r+50<o){const t=a.type,n=a.metadata,h=a.containsRTL;let c=-1,p=r;for(let a=r;a<o;a++)32===e.charCodeAt(a)&&(c=a),-1!==c&&a-p>=50&&(i[s++]=new LinePart(c+1,t,n,h),p=c+1,c=-1);p!==o&&(i[s++]=new LinePart(o,t,n,h))}else i[s++]=a;r=o}else for(let e=0,n=t.length;e<n;e++){const n=t[e],a=n.endIndex,o=a-r;if(o>50){const e=n.type,t=n.metadata,h=n.containsRTL,c=Math.ceil(o/50);for(let n=1;n<c;n++){const a=r+50*n;i[s++]=new LinePart(a,e,t,h)}i[s++]=new LinePart(a,e,t,h)}else i[s++]=n;r=a}return i}function isControlCharacter(e){return e<32?9!==e:127===e||e>=8234&&e<=8238||e>=8294&&e<=8297||e>=8206&&e<=8207||1564===e}function extractControlCharacters(e,t){const n=[];let r=new LinePart(0,"",0,!1),i=0;for(const s of t){const t=s.endIndex;for(;i<t;i++)isControlCharacter(e.charCodeAt(i))&&(i>r.endIndex&&(r=new LinePart(i,s.type,s.metadata,s.containsRTL),n.push(r)),r=new LinePart(i+1,"mtkcontrol",s.metadata,!1),n.push(r));i>r.endIndex&&(r=new LinePart(t,s.type,s.metadata,s.containsRTL),n.push(r))}return n}function _applyRenderWhitespace(e,t,n,r){const i=e.continuesWithWrappedLine,s=e.fauxIndentLength,a=e.tabSize,o=e.startVisibleColumn,h=e.useMonospaceOptimizations,c=e.selectionsOnLine,p=1===e.renderWhitespace,d=3===e.renderWhitespace,l=e.renderSpaceWidth!==e.spaceWidth,f=[];let g=0,u=0,C=r[u].type,L=r[u].containsRTL,m=r[u].endIndex;const w=r.length;let I,S=!1,O=strings.firstNonWhitespaceIndex(t);-1===O?(S=!0,O=n,I=n):I=strings.lastNonWhitespaceIndex(t);let R=!1,x=0,W=c&&c[x],A=o%a;for(let e=s;e<n;e++){const i=t.charCodeAt(e);let o;if(W&&e>=W.endOffset&&(x++,W=c&&c[x]),e<O||e>I)o=!0;else if(9===i)o=!0;else if(32===i)if(p)if(R)o=!0;else{const r=e+1<n?t.charCodeAt(e+1):0;o=32===r||9===r}else o=!0;else o=!1;if(o&&c&&(o=!!W&&W.startOffset<=e&&W.endOffset>e),o&&d&&(o=S||e>I),o&&L&&e>=O&&e<=I&&(o=!1),R){if(!o||!h&&A>=a){if(l)for(let t=(g>0?f[g-1].endIndex:s)+1;t<=e;t++)f[g++]=new LinePart(t,"mtkw",1,!1);else f[g++]=new LinePart(e,"mtkw",1,!1);A%=a}}else(e===m||o&&e>s)&&(f[g++]=new LinePart(e,C,0,L),A%=a);for(9===i?A=a:strings.isFullWidthCharacter(i)?A+=2:A++,R=o;e===m&&(u++,u<w);)C=r[u].type,L=r[u].containsRTL,m=r[u].endIndex}let P=!1;if(R)if(i&&p){const e=n>0?t.charCodeAt(n-1):0,r=n>1?t.charCodeAt(n-2):0;32===e&&32!==r&&9!==r||(P=!0)}else P=!0;if(P)if(l)for(let e=(g>0?f[g-1].endIndex:s)+1;e<=n;e++)f[g++]=new LinePart(e,"mtkw",1,!1);else f[g++]=new LinePart(n,"mtkw",1,!1);else f[g++]=new LinePart(n,C,0,L);return f}function _applyInlineDecorations(e,t,n,r){r.sort(LineDecoration.compare);const i=LineDecorationsNormalizer.normalize(e,r),s=i.length;let a=0;const o=[];let h=0,c=0;for(let e=0,t=n.length;e<t;e++){const t=n[e],r=t.endIndex,p=t.type,d=t.metadata,l=t.containsRTL;for(;a<s&&i[a].startOffset<r;){const e=i[a];if(e.startOffset>c&&(c=e.startOffset,o[h++]=new LinePart(c,p,d,l)),!(e.endOffset+1<=r)){c=r,o[h++]=new LinePart(c,p+" "+e.className,d|e.metadata,l);break}c=e.endOffset+1,o[h++]=new LinePart(c,p+" "+e.className,d|e.metadata,l),a++}r>c&&(c=r,o[h++]=new LinePart(c,p,d,l))}const p=n[n.length-1].endIndex;if(a<s&&i[a].startOffset===p)for(;a<s&&i[a].startOffset===p;){const e=i[a];o[h++]=new LinePart(c,e.className,e.metadata,!1),a++}return o}function _renderLine(e,t){const n=e.fontIsMonospace,r=e.canUseHalfwidthRightwardsArrow,i=e.containsForeignElements,s=e.lineContent,a=e.len,o=e.isOverflowing,h=e.overflowingCharCount,c=e.parts,p=e.fauxIndentLength,d=e.tabSize,l=e.startVisibleColumn,f=e.containsRTL,g=e.spaceWidth,u=e.renderSpaceCharCode,C=e.renderWhitespace,L=e.renderControlCharacters,m=new CharacterMapping(a+1,c.length);let w=!1,I=0,S=l,O=0,R=0,x=0;f?t.appendString('<span dir="ltr">'):t.appendString("<span>");for(let e=0,o=c.length;e<o;e++){const o=c[e],h=o.endIndex,l=o.type,f=o.containsRTL,W=0!==C&&o.isWhitespace(),A=W&&!n&&("mtkw"===l||!i),P=I===h&&o.isPseudoAfter();if(O=0,t.appendString("<span "),f&&t.appendString('style="unicode-bidi:isolate" '),t.appendString('class="'),t.appendString(A?"mtkz":l),t.appendASCIICharCode(34),W){let n=0;{let e=I,t=S;for(;e<h;e++){const r=0|(9===s.charCodeAt(e)?d-t%d:1);n+=r,e>=p&&(t+=r)}}for(A&&(t.appendString(' style="width:'),t.appendString(String(g*n)),t.appendString('px"')),t.appendASCIICharCode(62);I<h;I++){let n,i;if(m.setColumnInfo(I+1,e-x,O,R),x=0,9===s.charCodeAt(I)){n=d-S%d|0,i=n,!r||i>1?t.appendCharCode(8594):t.appendCharCode(65515);for(let e=2;e<=i;e++)t.appendCharCode(160)}else n=2,i=1,t.appendCharCode(u),t.appendCharCode(8204);O+=n,R+=i,I>=p&&(S+=i)}}else for(t.appendASCIICharCode(62);I<h;I++){m.setColumnInfo(I+1,e-x,O,R),x=0;const n=s.charCodeAt(I);let r=1,i=1;switch(n){case 9:r=d-S%d,i=r;for(let e=1;e<=r;e++)t.appendCharCode(160);break;case 32:t.appendCharCode(160);break;case 60:t.appendString("&lt;");break;case 62:t.appendString("&gt;");break;case 38:t.appendString("&amp;");break;case 0:L?t.appendCharCode(9216):t.appendString("&#00;");break;case 65279:case 8232:case 8233:case 133:t.appendCharCode(65533);break;default:strings.isFullWidthCharacter(n)&&i++,L&&n<32?t.appendCharCode(9216+n):L&&127===n?t.appendCharCode(9249):L&&isControlCharacter(n)?(t.appendString("[U+"),t.appendString(to4CharHex(n)),t.appendString("]"),r=8,i=r):t.appendCharCode(n)}O+=r,R+=i,I>=p&&(S+=i)}P?x++:x=0,I>=a&&!w&&o.isPseudoAfter()&&(w=!0,m.setColumnInfo(I+1,e,O,R)),t.appendString("</span>")}return w||m.setColumnInfo(a+1,c.length-1,O,R),o&&(t.appendString('<span class="mtkoverflow">'),t.appendString(nls.localize("showMore","Show more ({0})",renderOverflowingCharCount(h))),t.appendString("</span>")),t.appendString("</span>"),new RenderLineOutput(m,f,i)}function to4CharHex(e){return e.toString(16).toUpperCase().padStart(4,"0")}function renderOverflowingCharCount(e){return e<1024?nls.localize("overflow.chars","{0} chars",e):e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1024/1024).toFixed(1)} MB`}