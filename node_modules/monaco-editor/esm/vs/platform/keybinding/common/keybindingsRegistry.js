import{decodeKeybinding}from"../../../base/common/keybindings.js";import{OS}from"../../../base/common/platform.js";import{CommandsRegistry}from"../../commands/common/commands.js";import{Registry}from"../../registry/common/platform.js";import{combinedDisposable,DisposableStore,toDisposable}from"../../../base/common/lifecycle.js";import{LinkedList}from"../../../base/common/linkedList.js";class KeybindingsRegistryImpl{constructor(){this._coreKeybindings=new LinkedList,this._extensionKeybindings=[],this._cachedMergedKeybindings=null}static bindToCurrentPlatform(e){if(1===OS){if(e&&e.win)return e.win}else if(2===OS){if(e&&e.mac)return e.mac}else if(e&&e.linux)return e.linux;return e}registerKeybindingRule(e){const i=KeybindingsRegistryImpl.bindToCurrentPlatform(e),n=new DisposableStore;if(i&&i.primary){const s=decodeKeybinding(i.primary,OS);s&&n.add(this._registerDefaultKeybinding(s,e.id,e.args,e.weight,0,e.when))}if(i&&Array.isArray(i.secondary))for(let s=0,r=i.secondary.length;s<r;s++){const r=i.secondary[s],t=decodeKeybinding(r,OS);t&&n.add(this._registerDefaultKeybinding(t,e.id,e.args,e.weight,-s-1,e.when))}return n}registerCommandAndKeybindingRule(e){return combinedDisposable(this.registerKeybindingRule(e),CommandsRegistry.registerCommand(e))}_registerDefaultKeybinding(e,i,n,s,r,t){const o=this._coreKeybindings.push({keybinding:e,command:i,commandArgs:n,when:t,weight1:s,weight2:r,extensionId:null,isBuiltinExtension:!1});return this._cachedMergedKeybindings=null,toDisposable((()=>{o(),this._cachedMergedKeybindings=null}))}getDefaultKeybindings(){return this._cachedMergedKeybindings||(this._cachedMergedKeybindings=Array.from(this._coreKeybindings).concat(this._extensionKeybindings),this._cachedMergedKeybindings.sort(sorter)),this._cachedMergedKeybindings.slice(0)}}export const KeybindingsRegistry=new KeybindingsRegistryImpl;export const Extensions={EditorModes:"platform.keybindingsRegistry"};function sorter(e,i){if(e.weight1!==i.weight1)return e.weight1-i.weight1;if(e.command&&i.command){if(e.command<i.command)return-1;if(e.command>i.command)return 1}return e.weight2-i.weight2}Registry.add(Extensions.EditorModes,KeybindingsRegistry);