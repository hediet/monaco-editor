import{Emitter,PauseableEmitter}from"../../../base/common/event.js";import{Disposable}from"../../../base/common/lifecycle.js";import{isUndefinedOrNull}from"../../../base/common/types.js";import{InMemoryStorageDatabase,Storage,StorageHint}from"../../../base/parts/storage/common/storage.js";import{createDecorator}from"../../instantiation/common/instantiation.js";export const TARGET_KEY="__$__targetStorageMarker";export const IStorageService=createDecorator("storageService");export var WillSaveStateReason;!function(e){e[e.NONE=0]="NONE",e[e.SHUTDOWN=1]="SHUTDOWN"}(WillSaveStateReason||(WillSaveStateReason={}));export function loadKeyTargets(e){const t=e.get(TARGET_KEY);if(t)try{return JSON.parse(t)}catch(e){}return Object.create(null)}class AbstractStorageService extends Disposable{constructor(e={flushInterval:AbstractStorageService.DEFAULT_FLUSH_INTERVAL}){super(),this.options=e,this._onDidChangeValue=this._register(new PauseableEmitter),this.onDidChangeValue=this._onDidChangeValue.event,this._onDidChangeTarget=this._register(new PauseableEmitter),this._onWillSaveState=this._register(new Emitter),this.onWillSaveState=this._onWillSaveState.event,this._workspaceKeyTargets=void 0,this._profileKeyTargets=void 0,this._applicationKeyTargets=void 0}emitDidChangeValue(e,t){if(t===TARGET_KEY){switch(e){case-1:this._applicationKeyTargets=void 0;break;case 0:this._profileKeyTargets=void 0;break;case 1:this._workspaceKeyTargets=void 0}this._onDidChangeTarget.fire({scope:e})}else this._onDidChangeValue.fire({scope:e,key:t,target:this.getKeyTargets(e)[t]})}get(e,t,r){var a;return null===(a=this.getStorage(t))||void 0===a?void 0:a.get(e,r)}getBoolean(e,t,r){var a;return null===(a=this.getStorage(t))||void 0===a?void 0:a.getBoolean(e,r)}getNumber(e,t,r){var a;return null===(a=this.getStorage(t))||void 0===a?void 0:a.getNumber(e,r)}store(e,t,r,a){isUndefinedOrNull(t)?this.remove(e,r):this.withPausedEmitters((()=>{var i;this.updateKeyTarget(e,r,a),null===(i=this.getStorage(r))||void 0===i||i.set(e,t)}))}remove(e,t){this.withPausedEmitters((()=>{var r;this.updateKeyTarget(e,t,void 0),null===(r=this.getStorage(t))||void 0===r||r.delete(e)}))}withPausedEmitters(e){this._onDidChangeValue.pause(),this._onDidChangeTarget.pause();try{e()}finally{this._onDidChangeValue.resume(),this._onDidChangeTarget.resume()}}updateKeyTarget(e,t,r){var a,i;const s=this.getKeyTargets(t);"number"==typeof r?s[e]!==r&&(s[e]=r,null===(a=this.getStorage(t))||void 0===a||a.set(TARGET_KEY,JSON.stringify(s))):"number"==typeof s[e]&&(delete s[e],null===(i=this.getStorage(t))||void 0===i||i.set(TARGET_KEY,JSON.stringify(s)))}get workspaceKeyTargets(){return this._workspaceKeyTargets||(this._workspaceKeyTargets=this.loadKeyTargets(1)),this._workspaceKeyTargets}get profileKeyTargets(){return this._profileKeyTargets||(this._profileKeyTargets=this.loadKeyTargets(0)),this._profileKeyTargets}get applicationKeyTargets(){return this._applicationKeyTargets||(this._applicationKeyTargets=this.loadKeyTargets(-1)),this._applicationKeyTargets}getKeyTargets(e){switch(e){case-1:return this.applicationKeyTargets;case 0:return this.profileKeyTargets;default:return this.workspaceKeyTargets}}loadKeyTargets(e){const t=this.getStorage(e);return t?loadKeyTargets(t):Object.create(null)}}AbstractStorageService.DEFAULT_FLUSH_INTERVAL=6e4;export{AbstractStorageService};export class InMemoryStorageService extends AbstractStorageService{constructor(){super(),this.applicationStorage=this._register(new Storage(new InMemoryStorageDatabase,{hint:StorageHint.STORAGE_IN_MEMORY})),this.profileStorage=this._register(new Storage(new InMemoryStorageDatabase,{hint:StorageHint.STORAGE_IN_MEMORY})),this.workspaceStorage=this._register(new Storage(new InMemoryStorageDatabase,{hint:StorageHint.STORAGE_IN_MEMORY})),this._register(this.workspaceStorage.onDidChangeStorage((e=>this.emitDidChangeValue(1,e)))),this._register(this.profileStorage.onDidChangeStorage((e=>this.emitDidChangeValue(0,e)))),this._register(this.applicationStorage.onDidChangeStorage((e=>this.emitDidChangeValue(-1,e))))}getStorage(e){switch(e){case-1:return this.applicationStorage;case 0:return this.profileStorage;default:return this.workspaceStorage}}}