var __decorate=this&&this.__decorate||function(e,o,t,i){var s,r=arguments.length,n=r<3?o:null===i?i=Object.getOwnPropertyDescriptor(o,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,o,t,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(n=(r<3?s(n):r>3?s(o,t,n):s(o,t))||n);return r>3&&n&&Object.defineProperty(o,t,n),n},__param=this&&this.__param||function(e,o){return function(t,i){o(t,i,e)}},__awaiter=this&&this.__awaiter||function(e,o,t,i){return new(t||(t=Promise))((function(s,r){function n(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var o;e.done?s(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(n,a)}c((i=i.apply(e,o||[])).next())}))};import{toErrorMessage}from"../../../base/common/errorMessage.js";import{isCancellationError}from"../../../base/common/errors.js";import{matchesContiguousSubString,matchesPrefix,matchesWords,or}from"../../../base/common/filters.js";import{Disposable}from"../../../base/common/lifecycle.js";import{LRUCache}from"../../../base/common/map.js";import Severity from"../../../base/common/severity.js";import{withNullAsUndefined}from"../../../base/common/types.js";import{localize}from"../../../nls.js";import{ICommandService}from"../../commands/common/commands.js";import{IConfigurationService}from"../../configuration/common/configuration.js";import{IDialogService}from"../../dialogs/common/dialogs.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{IKeybindingService}from"../../keybinding/common/keybinding.js";import{PickerQuickAccessProvider}from"./pickerQuickAccess.js";import{IStorageService}from"../../storage/common/storage.js";import{ITelemetryService}from"../../telemetry/common/telemetry.js";let AbstractCommandsQuickAccessProvider=class e extends PickerQuickAccessProvider{constructor(o,t,i,s,r,n){super(e.PREFIX,o),this.instantiationService=t,this.keybindingService=i,this.commandService=s,this.telemetryService=r,this.dialogService=n,this.commandsHistory=this._register(this.instantiationService.createInstance(CommandsHistory)),this.options=o}_getPicks(o,t,i,s){var r,n;return __awaiter(this,void 0,void 0,(function*(){const t=yield this.getCommandPicks(i);if(i.isCancellationRequested)return[];const a=[];for(const i of t){const t=withNullAsUndefined(e.WORD_FILTER(o,i.label)),s=i.commandAlias?withNullAsUndefined(e.WORD_FILTER(o,i.commandAlias)):void 0;t||s?(i.highlights={label:t,detail:this.options.showAlias?s:void 0},a.push(i)):o===i.commandId&&a.push(i)}const c=new Map;for(const e of a){const o=c.get(e.label);o?(e.description=e.commandId,o.description=o.commandId):c.set(e.label,e)}a.sort(((e,o)=>{const t=this.commandsHistory.peek(e.commandId),i=this.commandsHistory.peek(o.commandId);if(t&&i)return t>i?-1:1;if(t)return-1;if(i)return 1;if(this.options.suggestedCommandIds){const t=this.options.suggestedCommandIds.has(e.commandId),i=this.options.suggestedCommandIds.has(o.commandId);if(t&&i)return 0;if(t)return-1;if(i)return 1}return e.label.localeCompare(o.label)}));const m=[];let d=!1,l=!!this.options.suggestedCommandIds;for(let e=0;e<a.length;e++){const o=a[e],t=this.keybindingService.lookupKeybinding(o.commandId),i=t?localize("commandPickAriaLabelWithKeybinding","{0}, {1}",o.label,t.getAriaLabel()):o.label;0===e&&this.commandsHistory.peek(o.commandId)&&(m.push({type:"separator",label:localize("recentlyUsed","recently used")}),d=!0),l&&!this.commandsHistory.peek(o.commandId)&&(null===(r=this.options.suggestedCommandIds)||void 0===r?void 0:r.has(o.commandId))&&(m.push({type:"separator",label:localize("commonlyUsed","commonly used")}),d=!0,l=!1),!d||this.commandsHistory.peek(o.commandId)||(null===(n=this.options.suggestedCommandIds)||void 0===n?void 0:n.has(o.commandId))||(m.push({type:"separator",label:localize("morecCommands","other commands")}),d=!1),m.push(Object.assign(Object.assign({},o),{ariaLabel:i,detail:this.options.showAlias&&o.commandAlias!==o.label?o.commandAlias:void 0,keybinding:t,accept:()=>__awaiter(this,void 0,void 0,(function*(){var e;this.commandsHistory.push(o.commandId),this.telemetryService.publicLog2("workbenchActionExecuted",{id:o.commandId,from:null!==(e=null==s?void 0:s.from)&&void 0!==e?e:"quick open"});try{yield this.commandService.executeCommand(o.commandId)}catch(e){isCancellationError(e)||this.dialogService.show(Severity.Error,localize("canNotRun","Command '{0}' resulted in an error ({1})",o.label,toErrorMessage(e)))}}))}))}return m}))}};AbstractCommandsQuickAccessProvider.PREFIX=">",AbstractCommandsQuickAccessProvider.WORD_FILTER=or(matchesPrefix,matchesWords,matchesContiguousSubString),AbstractCommandsQuickAccessProvider=__decorate([__param(1,IInstantiationService),__param(2,IKeybindingService),__param(3,ICommandService),__param(4,ITelemetryService),__param(5,IDialogService)],AbstractCommandsQuickAccessProvider);export{AbstractCommandsQuickAccessProvider};let CommandsHistory=class e extends Disposable{constructor(e,o){super(),this.storageService=e,this.configurationService=o,this.configuredCommandsHistoryLength=0,this.updateConfiguration(),this.load(),this.registerListeners()}registerListeners(){this._register(this.configurationService.onDidChangeConfiguration((e=>this.updateConfiguration(e))))}updateConfiguration(o){o&&!o.affectsConfiguration("workbench.commandPalette.history")||(this.configuredCommandsHistoryLength=e.getConfiguredCommandHistoryLength(this.configurationService),e.cache&&e.cache.limit!==this.configuredCommandsHistoryLength&&(e.cache.limit=this.configuredCommandsHistoryLength,e.saveState(this.storageService)))}load(){const o=this.storageService.get(e.PREF_KEY_CACHE,0);let t;if(o)try{t=JSON.parse(o)}catch(e){}const i=e.cache=new LRUCache(this.configuredCommandsHistoryLength,1);if(t){let e;e=t.usesLRU?t.entries:t.entries.sort(((e,o)=>e.value-o.value)),e.forEach((e=>i.set(e.key,e.value)))}e.counter=this.storageService.getNumber(e.PREF_KEY_COUNTER,0,e.counter)}push(o){e.cache&&(e.cache.set(o,e.counter++),e.saveState(this.storageService))}peek(o){var t;return null===(t=e.cache)||void 0===t?void 0:t.peek(o)}static saveState(o){if(!e.cache)return;const t={usesLRU:!0,entries:[]};e.cache.forEach(((e,o)=>t.entries.push({key:o,value:e}))),o.store(e.PREF_KEY_CACHE,JSON.stringify(t),0,0),o.store(e.PREF_KEY_COUNTER,e.counter,0,0)}static getConfiguredCommandHistoryLength(o){var t,i;const s=null===(i=null===(t=o.getValue().workbench)||void 0===t?void 0:t.commandPalette)||void 0===i?void 0:i.history;return"number"==typeof s?s:e.DEFAULT_COMMANDS_HISTORY_LENGTH}};CommandsHistory.DEFAULT_COMMANDS_HISTORY_LENGTH=50,CommandsHistory.PREF_KEY_CACHE="commandPalette.mru.cache",CommandsHistory.PREF_KEY_COUNTER="commandPalette.mru.counter",CommandsHistory.counter=1,CommandsHistory=__decorate([__param(0,IStorageService),__param(1,IConfigurationService)],CommandsHistory);export{CommandsHistory};