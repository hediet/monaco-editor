var __awaiter=this&&this.__awaiter||function(i,e,t,s){return new(t||(t=Promise))((function(n,o){function c(i){try{a(s.next(i))}catch(i){o(i)}}function r(i){try{a(s.throw(i))}catch(i){o(i)}}function a(i){var e;i.done?n(i.value):(e=i.value,e instanceof t?e:new t((function(i){i(e)}))).then(c,r)}a((s=s.apply(i,e||[])).next())}))};import{timeout}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../base/common/lifecycle.js";export var TriggerAction;function isPicksWithActive(i){const e=i;return Array.isArray(e.items)}function isFastAndSlowPicks(i){const e=i;return!!e.picks&&e.additionalPicks instanceof Promise}!function(i){i[i.NO_ACTION=0]="NO_ACTION",i[i.CLOSE_PICKER=1]="CLOSE_PICKER",i[i.REFRESH_PICKER=2]="REFRESH_PICKER",i[i.REMOVE_ITEM=3]="REMOVE_ITEM"}(TriggerAction||(TriggerAction={}));class PickerQuickAccessProvider extends Disposable{constructor(i,e){super(),this.prefix=i,this.options=e}provide(i,e,t){var s;const n=new DisposableStore;let o;i.canAcceptInBackground=!!(null===(s=this.options)||void 0===s?void 0:s.canAcceptInBackground),i.matchOnLabel=i.matchOnDescription=i.matchOnDetail=i.sortByLabel=!1;const c=n.add(new MutableDisposable),r=()=>__awaiter(this,void 0,void 0,(function*(){const s=c.value=new DisposableStore;null==o||o.dispose(!0),i.busy=!1,o=new CancellationTokenSource(e);const n=o.token,r=i.value.substr(this.prefix.length).trim(),a=this._getPicks(r,s,n,t),l=(e,t)=>{var s;let n,o;if(isPicksWithActive(e)?(n=e.items,o=e.active):n=e,0===n.length){if(t)return!1;r.length>0&&(null===(s=this.options)||void 0===s?void 0:s.noResultsPick)&&(n=[this.options.noResultsPick])}return i.items=n,o&&(i.activeItems=[o]),!0};if(null===a);else if(isFastAndSlowPicks(a)){let e=!1,t=!1;yield Promise.all([(()=>__awaiter(this,void 0,void 0,(function*(){yield timeout(PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY),n.isCancellationRequested||t||(e=l(a.picks,!0))})))(),(()=>__awaiter(this,void 0,void 0,(function*(){i.busy=!0;try{const s=yield a.additionalPicks;if(n.isCancellationRequested)return;let o,c,r,u;if(isPicksWithActive(a.picks)?(o=a.picks.items,c=a.picks.active):o=a.picks,isPicksWithActive(s)?(r=s.items,u=s.active):r=s,r.length>0||!e){let e;if(!c&&!u){const t=i.activeItems[0];t&&-1!==o.indexOf(t)&&(e=t)}l({items:[...o,...r],active:c||u||e})}}finally{n.isCancellationRequested||(i.busy=!1),t=!0}})))()])}else if(a instanceof Promise){i.busy=!0;try{const e=yield a;if(n.isCancellationRequested)return;l(e)}finally{n.isCancellationRequested||(i.busy=!1)}}else l(a)}));return n.add(i.onDidChangeValue((()=>r()))),r(),n.add(i.onDidAccept((e=>{const[t]=i.selectedItems;"function"==typeof(null==t?void 0:t.accept)&&(e.inBackground||i.hide(),t.accept(i.keyMods,e))}))),n.add(i.onDidTriggerItemButton((({button:t,item:s})=>__awaiter(this,void 0,void 0,(function*(){var n,o;if("function"==typeof s.trigger){const c=null!==(o=null===(n=s.buttons)||void 0===n?void 0:n.indexOf(t))&&void 0!==o?o:-1;if(c>=0){const t=s.trigger(c,i.keyMods),n="number"==typeof t?t:yield t;if(e.isCancellationRequested)return;switch(n){case TriggerAction.NO_ACTION:break;case TriggerAction.CLOSE_PICKER:i.hide();break;case TriggerAction.REFRESH_PICKER:r();break;case TriggerAction.REMOVE_ITEM:{const e=i.items.indexOf(s);if(-1!==e){const t=i.items.slice(),s=t.splice(e,1),n=i.activeItems.filter((i=>i!==s[0])),o=i.keepScrollPosition;i.keepScrollPosition=!0,i.items=t,n&&(i.activeItems=n),i.keepScrollPosition=o}break}}}}}))))),n}}PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY=200;export{PickerQuickAccessProvider};