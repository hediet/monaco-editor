import{$,addDisposableListener,EventType,getActiveElement,isAncestor,isHTMLElement}from"../../../base/browser/dom.js";import{StandardMouseEvent}from"../../../base/browser/mouseEvent.js";import{Menu}from"../../../base/browser/ui/menu/menu.js";import{ActionRunner}from"../../../base/common/actions.js";import{isCancellationError}from"../../../base/common/errors.js";import{combinedDisposable,DisposableStore}from"../../../base/common/lifecycle.js";import{defaultMenuStyles}from"../../theme/browser/defaultStyles.js";export class ContextMenuHandler{constructor(e,t,i,o){this.contextViewService=e,this.telemetryService=t,this.notificationService=i,this.keybindingService=o,this.focusToReturn=null,this.lastContainer=null,this.block=null,this.blockDisposable=null,this.options={blockMouse:!0}}configure(e){this.options=e}showContextMenu(e){const t=e.getActions();if(!t.length)return;let i;this.focusToReturn=document.activeElement;const o=isHTMLElement(e.domForShadowRoot)?e.domForShadowRoot:void 0;this.contextViewService.showContextView({getAnchor:()=>e.getAnchor(),canRelayout:!1,anchorAlignment:e.anchorAlignment,anchorAxisAlignment:e.anchorAxisAlignment,render:o=>{var n;this.lastContainer=o;const s=e.getMenuClassName?e.getMenuClassName():"";s&&(o.className+=" "+s),this.options.blockMouse&&(this.block=o.appendChild($(".context-view-block")),this.block.style.position="fixed",this.block.style.cursor="initial",this.block.style.left="0",this.block.style.top="0",this.block.style.width="100%",this.block.style.height="100%",this.block.style.zIndex="-1",null===(n=this.blockDisposable)||void 0===n||n.dispose(),this.blockDisposable=addDisposableListener(this.block,EventType.MOUSE_DOWN,(e=>e.stopPropagation())));const l=new DisposableStore,r=e.actionRunner||new ActionRunner;return r.onWillRun(this.onActionRun,this,l),r.onDidRun(this.onDidActionRun,this,l),i=new Menu(o,t,{actionViewItemProvider:e.getActionViewItem,context:e.getActionsContext?e.getActionsContext():null,actionRunner:r,getKeyBinding:e.getKeyBinding?e.getKeyBinding:e=>this.keybindingService.lookupKeybinding(e.id)},defaultMenuStyles),i.onDidCancel((()=>this.contextViewService.hideContextView(!0)),null,l),i.onDidBlur((()=>this.contextViewService.hideContextView(!0)),null,l),l.add(addDisposableListener(window,EventType.BLUR,(()=>this.contextViewService.hideContextView(!0)))),l.add(addDisposableListener(window,EventType.MOUSE_DOWN,(e=>{if(e.defaultPrevented)return;const t=new StandardMouseEvent(e);let i=t.target;if(!t.rightButton){for(;i;){if(i===o)return;i=i.parentElement}this.contextViewService.hideContextView(!0)}}))),combinedDisposable(l,i)},focus:()=>{null==i||i.focus(!!e.autoSelectFirstItem)},onHide:t=>{var i,o,n;null===(i=e.onHide)||void 0===i||i.call(e,!!t),this.block&&(this.block.remove(),this.block=null),null===(o=this.blockDisposable)||void 0===o||o.dispose(),this.blockDisposable=null,this.lastContainer&&(getActiveElement()===this.lastContainer||isAncestor(getActiveElement(),this.lastContainer))&&(null===(n=this.focusToReturn)||void 0===n||n.focus()),this.lastContainer=null}},o,!!o)}onActionRun(e){this.telemetryService.publicLog2("workbenchActionExecuted",{id:e.action.id,from:"contextMenu"}),this.contextViewService.hideContextView(!1)}onDidActionRun(e){e.error&&!isCancellationError(e.error)&&this.notificationService.error(e.error)}}