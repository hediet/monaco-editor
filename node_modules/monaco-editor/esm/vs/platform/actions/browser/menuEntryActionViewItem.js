var __decorate=this&&this.__decorate||function(e,t,i,n){var o,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var r=e.length-1;r>=0;r--)(o=e[r])&&(a=(s<3?o(a):s>3?o(t,i,a):o(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function r(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,r)}c((n=n.apply(e,t||[])).next())}))};import{$,addDisposableListener,append,asCSSUrl,EventType,ModifierKeyEmitter,prepend}from"../../../base/browser/dom.js";import{StandardKeyboardEvent}from"../../../base/browser/keyboardEvent.js";import{ActionViewItem,BaseActionViewItem,SelectActionViewItem}from"../../../base/browser/ui/actionbar/actionViewItems.js";import{DropdownMenuActionViewItem}from"../../../base/browser/ui/dropdown/dropdownActionViewItem.js";import{ActionRunner,Separator,SubmenuAction}from"../../../base/common/actions.js";import{UILabelProvider}from"../../../base/common/keybindingLabels.js";import{combinedDisposable,MutableDisposable,toDisposable}from"../../../base/common/lifecycle.js";import{isLinux,isWindows,OS}from"../../../base/common/platform.js";import"./menuEntryActionViewItem.css";import{localize}from"../../../nls.js";import{IMenuService,MenuItemAction,SubmenuItemAction}from"../common/actions.js";import{isICommandActionToggleInfo}from"../../action/common/action.js";import{IContextKeyService}from"../../contextkey/common/contextkey.js";import{IContextMenuService,IContextViewService}from"../../contextview/browser/contextView.js";import{IInstantiationService}from"../../instantiation/common/instantiation.js";import{IKeybindingService}from"../../keybinding/common/keybinding.js";import{INotificationService}from"../../notification/common/notification.js";import{IStorageService}from"../../storage/common/storage.js";import{IThemeService}from"../../theme/common/themeService.js";import{ThemeIcon}from"../../../base/common/themables.js";import{isDark}from"../../theme/common/theme.js";import{assertType}from"../../../base/common/types.js";import{asCssVariable,selectBorder}from"../../theme/common/colorRegistry.js";import{defaultSelectBoxStyles}from"../../theme/browser/defaultStyles.js";export function createAndFillInContextMenuActions(e,t,i,n){const o=e.getActions(t),s=ModifierKeyEmitter.getInstance();fillInActions(o,i,s.keyStatus.altKey||(isWindows||isLinux)&&s.keyStatus.shiftKey,n?e=>e===n:e=>"navigation"===e)}export function createAndFillInActionBarActions(e,t,i,n,o,s){fillInActions(e.getActions(t),i,!1,"string"==typeof n?e=>e===n:n,o,s)}function fillInActions(e,t,i,n=(e=>"navigation"===e),o=(()=>!1),s=!1){let a,r;Array.isArray(t)?(a=t,r=t):(a=t.primary,r=t.secondary);const c=new Set;for(const[t,o]of e){let e;n(t)?(e=a,e.length>0&&s&&e.push(new Separator)):(e=r,e.length>0&&e.push(new Separator));for(let n of o){i&&(n=n instanceof MenuItemAction&&n.alt?n.alt:n);const o=e.push(n);n instanceof SubmenuAction&&c.add({group:t,action:n,index:o-1})}}for(const{group:e,action:t,index:i}of c){const s=n(e)?a:r,c=t.actions;c.length<=1&&o(t,e,s.length)&&s.splice(i,1,...c)}}let MenuEntryActionViewItem=class extends ActionViewItem{constructor(e,t,i,n,o,s,a){super(void 0,e,{icon:!(!e.class&&!e.item.icon),label:!e.class&&!e.item.icon,draggable:null==t?void 0:t.draggable,keybinding:null==t?void 0:t.keybinding,hoverDelegate:null==t?void 0:t.hoverDelegate}),this._keybindingService=i,this._notificationService=n,this._contextKeyService=o,this._themeService=s,this._contextMenuService=a,this._wantsAltCommand=!1,this._itemClassDispose=this._register(new MutableDisposable),this._altKey=ModifierKeyEmitter.getInstance()}get _menuItemAction(){return this._action}get _commandAction(){return this._wantsAltCommand&&this._menuItemAction.alt||this._menuItemAction}onClick(e){return __awaiter(this,void 0,void 0,(function*(){e.preventDefault(),e.stopPropagation();try{yield this.actionRunner.run(this._commandAction,this._context)}catch(e){this._notificationService.error(e)}}))}render(e){super.render(e),e.classList.add("menu-entry"),this._updateItemClass(this._menuItemAction.item);let t=!1,i=this._altKey.keyStatus.altKey||(isWindows||isLinux)&&this._altKey.keyStatus.shiftKey;const n=()=>{var e;const n=t&&i&&!!(null===(e=this._commandAction.alt)||void 0===e?void 0:e.enabled);n!==this._wantsAltCommand&&(this._wantsAltCommand=n,this.updateLabel(),this.updateTooltip(),this.updateClass())};this._menuItemAction.alt&&this._register(this._altKey.event((e=>{i=e.altKey||(isWindows||isLinux)&&e.shiftKey,n()}))),this._register(addDisposableListener(e,"mouseleave",(e=>{t=!1,n()}))),this._register(addDisposableListener(e,"mouseenter",(e=>{t=!0,n()})))}updateLabel(){this.options.label&&this.label&&(this.label.textContent=this._commandAction.label)}getTooltip(){var e;const t=this._keybindingService.lookupKeybinding(this._commandAction.id,this._contextKeyService),i=t&&t.getLabel(),n=this._commandAction.tooltip||this._commandAction.label;let o=i?localize("titleAndKb","{0} ({1})",n,i):n;if(!this._wantsAltCommand&&(null===(e=this._menuItemAction.alt)||void 0===e?void 0:e.enabled)){const e=this._menuItemAction.alt.tooltip||this._menuItemAction.alt.label,t=this._keybindingService.lookupKeybinding(this._menuItemAction.alt.id,this._contextKeyService),i=t&&t.getLabel(),n=i?localize("titleAndKb","{0} ({1})",e,i):e;o=localize("titleAndKbAndAlt","{0}\n[{1}] {2}",o,UILabelProvider.modifierLabels[OS].altKey,n)}return o}updateClass(){this.options.icon&&(this._commandAction!==this._menuItemAction?this._menuItemAction.alt&&this._updateItemClass(this._menuItemAction.alt.item):this._updateItemClass(this._menuItemAction.item))}_updateItemClass(e){this._itemClassDispose.value=void 0;const{element:t,label:i}=this;if(!t||!i)return;const n=this._commandAction.checked&&isICommandActionToggleInfo(e.toggled)&&e.toggled.icon?e.toggled.icon:e.icon;if(n)if(ThemeIcon.isThemeIcon(n)){const e=ThemeIcon.asClassNameArray(n);i.classList.add(...e),this._itemClassDispose.value=toDisposable((()=>{i.classList.remove(...e)}))}else i.style.backgroundImage=isDark(this._themeService.getColorTheme().type)?asCSSUrl(n.dark):asCSSUrl(n.light),i.classList.add("icon"),this._itemClassDispose.value=combinedDisposable(toDisposable((()=>{i.style.backgroundImage="",i.classList.remove("icon")})),this._themeService.onDidColorThemeChange((()=>{this.updateClass()})))}};MenuEntryActionViewItem=__decorate([__param(2,IKeybindingService),__param(3,INotificationService),__param(4,IContextKeyService),__param(5,IThemeService),__param(6,IContextMenuService)],MenuEntryActionViewItem);export{MenuEntryActionViewItem};let SubmenuEntryActionViewItem=class extends DropdownMenuActionViewItem{constructor(e,t,i,n){var o,s;const a=Object.assign({},null!=t?t:Object.create(null),{menuAsChild:null!==(o=null==t?void 0:t.menuAsChild)&&void 0!==o&&o,classNames:null!==(s=null==t?void 0:t.classNames)&&void 0!==s?s:ThemeIcon.isThemeIcon(e.item.icon)?ThemeIcon.asClassName(e.item.icon):void 0});super(e,{getActions:()=>e.actions},i,a),this._contextMenuService=i,this._themeService=n}render(e){super.render(e),assertType(this.element),e.classList.add("menu-entry");const t=this._action,{icon:i}=t.item;if(i&&!ThemeIcon.isThemeIcon(i)){this.element.classList.add("icon");const e=()=>{this.element&&(this.element.style.backgroundImage=isDark(this._themeService.getColorTheme().type)?asCSSUrl(i.dark):asCSSUrl(i.light))};e(),this._register(this._themeService.onDidColorThemeChange((()=>{e()})))}}};SubmenuEntryActionViewItem=__decorate([__param(2,IContextMenuService),__param(3,IThemeService)],SubmenuEntryActionViewItem);export{SubmenuEntryActionViewItem};let DropdownWithDefaultActionViewItem=class extends BaseActionViewItem{constructor(e,t,i,n,o,s,a,r){var c,l,m;let d;super(null,e),this._keybindingService=i,this._notificationService=n,this._contextMenuService=o,this._menuService=s,this._instaService=a,this._storageService=r,this._container=null,this._options=t,this._storageKey=`${e.item.submenu.id}_lastActionId`;const u=r.get(this._storageKey,1);u&&(d=e.actions.find((e=>u===e.id))),d||(d=e.actions[0]),this._defaultAction=this._instaService.createInstance(MenuEntryActionViewItem,d,{keybinding:this._getDefaultActionKeybindingLabel(d)});const h=Object.assign({},null!=t?t:Object.create(null),{menuAsChild:null===(c=null==t?void 0:t.menuAsChild)||void 0===c||c,classNames:null!==(l=null==t?void 0:t.classNames)&&void 0!==l?l:["codicon","codicon-chevron-down"],actionRunner:null!==(m=null==t?void 0:t.actionRunner)&&void 0!==m?m:new ActionRunner});this._dropdown=new DropdownMenuActionViewItem(e,e.actions,this._contextMenuService,h),this._dropdown.actionRunner.onDidRun((e=>{e.action instanceof MenuItemAction&&this.update(e.action)}))}update(e){this._storageService.store(this._storageKey,e.id,1,0),this._defaultAction.dispose(),this._defaultAction=this._instaService.createInstance(MenuEntryActionViewItem,e,{keybinding:this._getDefaultActionKeybindingLabel(e)}),this._defaultAction.actionRunner=new class extends ActionRunner{runAction(e,t){return __awaiter(this,void 0,void 0,(function*(){yield e.run(void 0)}))}},this._container&&this._defaultAction.render(prepend(this._container,$(".action-container")))}_getDefaultActionKeybindingLabel(e){var t;let i;if(null===(t=this._options)||void 0===t?void 0:t.renderKeybindingWithDefaultActionLabel){const t=this._keybindingService.lookupKeybinding(e.id);t&&(i=`(${t.getLabel()})`)}return i}setActionContext(e){super.setActionContext(e),this._defaultAction.setActionContext(e),this._dropdown.setActionContext(e)}render(e){this._container=e,super.render(this._container),this._container.classList.add("monaco-dropdown-with-default");const t=$(".action-container");this._defaultAction.render(append(this._container,t)),this._register(addDisposableListener(t,EventType.KEY_DOWN,(e=>{const t=new StandardKeyboardEvent(e);t.equals(17)&&(this._defaultAction.element.tabIndex=-1,this._dropdown.focus(),t.stopPropagation())})));const i=$(".dropdown-action-container");this._dropdown.render(append(this._container,i)),this._register(addDisposableListener(i,EventType.KEY_DOWN,(e=>{var t;const i=new StandardKeyboardEvent(e);i.equals(15)&&(this._defaultAction.element.tabIndex=0,this._dropdown.setFocusable(!1),null===(t=this._defaultAction.element)||void 0===t||t.focus(),i.stopPropagation())})))}focus(e){e?this._dropdown.focus():(this._defaultAction.element.tabIndex=0,this._defaultAction.element.focus())}blur(){this._defaultAction.element.tabIndex=-1,this._dropdown.blur(),this._container.blur()}setFocusable(e){e?this._defaultAction.element.tabIndex=0:(this._defaultAction.element.tabIndex=-1,this._dropdown.setFocusable(!1))}dispose(){this._defaultAction.dispose(),this._dropdown.dispose(),super.dispose()}};DropdownWithDefaultActionViewItem=__decorate([__param(2,IKeybindingService),__param(3,INotificationService),__param(4,IContextMenuService),__param(5,IMenuService),__param(6,IInstantiationService),__param(7,IStorageService)],DropdownWithDefaultActionViewItem);export{DropdownWithDefaultActionViewItem};let SubmenuEntrySelectActionViewItem=class extends SelectActionViewItem{constructor(e,t){super(null,e,e.actions.map((e=>({text:e.id===Separator.ID?"─────────":e.label,isDisabled:!e.enabled}))),0,t,defaultSelectBoxStyles,{ariaLabel:e.tooltip,optionsAsChildren:!0}),this.select(Math.max(0,e.actions.findIndex((e=>e.checked))))}render(e){super.render(e),e.style.borderColor=asCssVariable(selectBorder)}runAction(e,t){const i=this.action.actions[t];i&&this.actionRunner.run(i)}};SubmenuEntrySelectActionViewItem=__decorate([__param(1,IContextViewService)],SubmenuEntrySelectActionViewItem);export function createActionViewItem(e,t,i){return t instanceof MenuItemAction?e.createInstance(MenuEntryActionViewItem,t,i):t instanceof SubmenuItemAction?t.item.isSelection?e.createInstance(SubmenuEntrySelectActionViewItem,t):t.item.rememberDefaultAction?e.createInstance(DropdownWithDefaultActionViewItem,t,i):e.createInstance(SubmenuEntryActionViewItem,t,i):void 0}