var __decorate=this&&this.__decorate||function(e,t,n,i){var s,o=arguments.length,r=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(o<3?s(r):o>3?s(t,n,r):s(t,n))||r);return o>3&&r&&Object.defineProperty(t,n,r),r},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};import{RunOnceScheduler}from"../../../base/common/async.js";import{DebounceEmitter,Emitter}from"../../../base/common/event.js";import{DisposableStore}from"../../../base/common/lifecycle.js";import{isIMenuItem,isISubmenuItem,MenuItemAction,MenuRegistry,SubmenuItemAction}from"./actions.js";import{ICommandService}from"../../commands/common/commands.js";import{IContextKeyService}from"../../contextkey/common/contextkey.js";import{Separator,toAction}from"../../../base/common/actions.js";import{IStorageService}from"../../storage/common/storage.js";import{removeFastWithoutKeepingOrder}from"../../../base/common/arrays.js";import{localize}from"../../../nls.js";let MenuService=class{constructor(e,t){this._commandService=e,this._hiddenStates=new PersistedMenuHideState(t)}createMenu(e,t,n){return new MenuImpl(e,this._hiddenStates,Object.assign({emitEventsForSubmenuChanges:!1,eventDebounceDelay:50},n),this._commandService,t)}resetHiddenStates(e){this._hiddenStates.reset(e)}};MenuService=__decorate([__param(0,ICommandService),__param(1,IStorageService)],MenuService);export{MenuService};let PersistedMenuHideState=class e{constructor(t){this._storageService=t,this._disposables=new DisposableStore,this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event,this._ignoreChangeEvent=!1,this._hiddenByDefaultCache=new Map;try{const n=t.get(e._key,0,"{}");this._data=JSON.parse(n)}catch(e){this._data=Object.create(null)}this._disposables.add(t.onDidChangeValue((n=>{if(n.key===e._key){if(!this._ignoreChangeEvent)try{const n=t.get(e._key,0,"{}");this._data=JSON.parse(n)}catch(e){console.log("FAILED to read storage after UPDATE",e)}this._onDidChange.fire()}})))}dispose(){this._onDidChange.dispose(),this._disposables.dispose()}_isHiddenByDefault(e,t){var n;return null!==(n=this._hiddenByDefaultCache.get(`${e.id}/${t}`))&&void 0!==n&&n}setDefaultState(e,t,n){this._hiddenByDefaultCache.set(`${e.id}/${t}`,n)}isHidden(e,t){var n,i;const s=this._isHiddenByDefault(e,t),o=null!==(i=null===(n=this._data[e.id])||void 0===n?void 0:n.includes(t))&&void 0!==i&&i;return s?!o:o}updateHidden(e,t,n){this._isHiddenByDefault(e,t)&&(n=!n);const i=this._data[e.id];if(n)i?i.indexOf(t)<0&&i.push(t):this._data[e.id]=[t];else if(i){const n=i.indexOf(t);n>=0&&removeFastWithoutKeepingOrder(i,n),0===i.length&&delete this._data[e.id]}this._persist()}reset(e){if(void 0===e)this._data=Object.create(null),this._persist();else{for(const{id:t}of e)this._data[t]&&delete this._data[t];this._persist()}}_persist(){try{this._ignoreChangeEvent=!0;const t=JSON.stringify(this._data);this._storageService.store(e._key,t,0,0)}finally{this._ignoreChangeEvent=!1}}};PersistedMenuHideState._key="menu.hiddenCommands",PersistedMenuHideState=__decorate([__param(0,IStorageService)],PersistedMenuHideState);let MenuInfo=class e{constructor(e,t,n,i,s){this._id=e,this._hiddenStates=t,this._collectContextKeysForSubmenus=n,this._commandService=i,this._contextKeyService=s,this._menuGroups=[],this._structureContextKeys=new Set,this._preconditionContextKeys=new Set,this._toggledContextKeys=new Set,this.refresh()}get structureContextKeys(){return this._structureContextKeys}get preconditionContextKeys(){return this._preconditionContextKeys}get toggledContextKeys(){return this._toggledContextKeys}refresh(){this._menuGroups.length=0,this._structureContextKeys.clear(),this._preconditionContextKeys.clear(),this._toggledContextKeys.clear();const t=MenuRegistry.getMenuItems(this._id);let n;t.sort(e._compareMenuItems);for(const e of t){const t=e.group||"";n&&n[0]===t||(n=[t,[]],this._menuGroups.push(n)),n[1].push(e),this._collectContextKeys(e)}}_collectContextKeys(t){if(e._fillInKbExprKeys(t.when,this._structureContextKeys),isIMenuItem(t)){if(t.command.precondition&&e._fillInKbExprKeys(t.command.precondition,this._preconditionContextKeys),t.command.toggled){const n=t.command.toggled.condition||t.command.toggled;e._fillInKbExprKeys(n,this._toggledContextKeys)}}else this._collectContextKeysForSubmenus&&MenuRegistry.getMenuItems(t.submenu).forEach(this._collectContextKeys,this)}createActionGroups(t){const n=[];for(const i of this._menuGroups){const[s,o]=i,r=[];for(const n of o)if(this._contextKeyService.contextMatchesRules(n.when)){const i=isIMenuItem(n);i&&this._hiddenStates.setDefaultState(this._id,n.command.id,!!n.isHiddenByDefault);const s=createMenuHide(this._id,i?n.command:n,this._hiddenStates);if(i)r.push(new MenuItemAction(n.command,n.alt,t,s,this._contextKeyService,this._commandService));else{const i=new e(n.submenu,this._hiddenStates,this._collectContextKeysForSubmenus,this._commandService,this._contextKeyService).createActionGroups(t),o=Separator.join(...i.map((e=>e[1])));o.length>0&&r.push(new SubmenuItemAction(n,s,o))}}r.length>0&&n.push([s,r])}return n}static _fillInKbExprKeys(e,t){if(e)for(const n of e.keys())t.add(n)}static _compareMenuItems(t,n){const i=t.group,s=n.group;if(i!==s){if(!i)return 1;if(!s)return-1;if("navigation"===i)return-1;if("navigation"===s)return 1;const e=i.localeCompare(s);if(0!==e)return e}const o=t.order||0,r=n.order||0;return o<r?-1:o>r?1:e._compareTitles(isIMenuItem(t)?t.command.title:t.title,isIMenuItem(n)?n.command.title:n.title)}static _compareTitles(e,t){const n="string"==typeof e?e:e.original,i="string"==typeof t?t:t.original;return n.localeCompare(i)}};MenuInfo=__decorate([__param(3,ICommandService),__param(4,IContextKeyService)],MenuInfo);let MenuImpl=class{constructor(e,t,n,i,s){this._disposables=new DisposableStore,this._menuInfo=new MenuInfo(e,t,n.emitEventsForSubmenuChanges,i,s);const o=new RunOnceScheduler((()=>{this._menuInfo.refresh(),this._onDidChange.fire({menu:this,isStructuralChange:!0,isEnablementChange:!0,isToggleChange:!0})}),n.eventDebounceDelay);this._disposables.add(o),this._disposables.add(MenuRegistry.onDidChangeMenu((t=>{t.has(e)&&o.schedule()})));const r=this._disposables.add(new DisposableStore);this._onDidChange=new DebounceEmitter({onWillAddFirstListener:()=>{r.add(s.onDidChangeContext((e=>{const t=e.affectsSome(this._menuInfo.structureContextKeys),n=e.affectsSome(this._menuInfo.preconditionContextKeys),i=e.affectsSome(this._menuInfo.toggledContextKeys);(t||n||i)&&this._onDidChange.fire({menu:this,isStructuralChange:t,isEnablementChange:n,isToggleChange:i})}))),r.add(t.onDidChange((e=>{this._onDidChange.fire({menu:this,isStructuralChange:!0,isEnablementChange:!1,isToggleChange:!1})})))},onDidRemoveLastListener:r.clear.bind(r),delay:n.eventDebounceDelay,merge:e=>{let t=!1,n=!1,i=!1;for(const s of e)if(t=t||s.isStructuralChange,n=n||s.isEnablementChange,i=i||s.isToggleChange,t&&n&&i)break;return{menu:this,isStructuralChange:t,isEnablementChange:n,isToggleChange:i}}}),this.onDidChange=this._onDidChange.event}getActions(e){return this._menuInfo.createActionGroups(e)}dispose(){this._disposables.dispose(),this._onDidChange.dispose()}};function createMenuHide(e,t,n){const i=isISubmenuItem(t)?t.submenu.id:t.id,s="string"==typeof t.title?t.title:t.title.value,o=toAction({id:`hide/${e.id}/${i}`,label:localize("hide.label","Hide '{0}'",s),run(){n.updateHidden(e,i,!0)}}),r=toAction({id:`toggle/${e.id}/${i}`,label:s,get checked(){return!n.isHidden(e,i)},run(){n.updateHidden(e,i,!!this.checked)}});return{hide:o,toggle:r,get isHidden(){return!r.checked}}}MenuImpl=__decorate([__param(3,ICommandService),__param(4,IContextKeyService)],MenuImpl);