var __decorate=this&&this.__decorate||function(e,t,i,o){var n,c=arguments.length,r=c<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(r=(c<3?n(r):c>3?n(t,i,r):n(t,i))||r);return c>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import*as dom from"../../../base/browser/dom.js";import{ActionBar}from"../../../base/browser/ui/actionbar/actionbar.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../base/common/lifecycle.js";import"./actionWidget.css";import{localize}from"../../../nls.js";import{acceptSelectedActionCommand,ActionList,previewSelectedActionCommand}from"./actionList.js";import{Action2,registerAction2}from"../../actions/common/actions.js";import{IContextKeyService,RawContextKey}from"../../contextkey/common/contextkey.js";import{IContextViewService}from"../../contextview/browser/contextView.js";import{registerSingleton}from"../../instantiation/common/extensions.js";import{createDecorator,IInstantiationService}from"../../instantiation/common/instantiation.js";const ActionWidgetContextKeys={Visible:new RawContextKey("codeActionMenuVisible",!1,localize("codeActionMenuVisible","Whether the action widget list is visible"))};export const IActionWidgetService=createDecorator("actionWidgetService");let ActionWidgetService=class extends Disposable{get isVisible(){return ActionWidgetContextKeys.Visible.getValue(this._contextKeyService)||!1}constructor(e,t,i){super(),this._contextViewService=e,this._contextKeyService=t,this._instantiationService=i,this._list=this._register(new MutableDisposable)}show(e,t,i,o,n,c,r){const s=ActionWidgetContextKeys.Visible.bindTo(this._contextKeyService),a=this._instantiationService.createInstance(ActionList,e,t,i,o);this._contextViewService.showContextView({getAnchor:()=>n,render:e=>(s.set(!0),this._renderWidget(e,a,null!=r?r:[])),onHide:e=>{s.reset(),this._onWidgetClosed(e)}},c,!1)}acceptSelected(e){var t;null===(t=this._list.value)||void 0===t||t.acceptSelected(e)}focusPrevious(){var e,t;null===(t=null===(e=this._list)||void 0===e?void 0:e.value)||void 0===t||t.focusPrevious()}focusNext(){var e,t;null===(t=null===(e=this._list)||void 0===e?void 0:e.value)||void 0===t||t.focusNext()}hide(){var e;null===(e=this._list.value)||void 0===e||e.hide(),this._list.clear()}_renderWidget(e,t,i){var o;const n=document.createElement("div");if(n.classList.add("action-widget"),e.appendChild(n),this._list.value=t,!this._list.value)throw new Error("List has no value");n.appendChild(this._list.value.domNode);const c=new DisposableStore,r=document.createElement("div"),s=e.appendChild(r);s.classList.add("context-view-block"),c.add(dom.addDisposableListener(s,dom.EventType.MOUSE_DOWN,(e=>e.stopPropagation())));const a=document.createElement("div"),d=e.appendChild(a);d.classList.add("context-view-pointerBlock"),c.add(dom.addDisposableListener(d,dom.EventType.POINTER_MOVE,(()=>d.remove()))),c.add(dom.addDisposableListener(d,dom.EventType.MOUSE_DOWN,(()=>d.remove())));let l=0;if(i.length){const e=this._createActionBar(".action-widget-action-bar",i);e&&(n.appendChild(e.getContainer().parentElement),c.add(e),l=e.getContainer().offsetWidth)}const v=null===(o=this._list.value)||void 0===o?void 0:o.layout(l);n.style.width=`${v}px`;const p=c.add(dom.trackFocus(e));return c.add(p.onDidBlur((()=>this.hide()))),c}_createActionBar(e,t){if(!t.length)return;const i=dom.$(e),o=new ActionBar(i);return o.push(t,{icon:!1,label:!0}),o}_onWidgetClosed(e){var t;null===(t=this._list.value)||void 0===t||t.hide(e)}};ActionWidgetService=__decorate([__param(0,IContextViewService),__param(1,IContextKeyService),__param(2,IInstantiationService)],ActionWidgetService),registerSingleton(IActionWidgetService,ActionWidgetService,1);const weight=1100;registerAction2(class extends Action2{constructor(){super({id:"hideCodeActionWidget",title:{value:localize("hideCodeActionWidget.title","Hide action widget"),original:"Hide action widget"},precondition:ActionWidgetContextKeys.Visible,keybinding:{weight:1100,primary:9,secondary:[1033]}})}run(e){e.get(IActionWidgetService).hide()}}),registerAction2(class extends Action2{constructor(){super({id:"selectPrevCodeAction",title:{value:localize("selectPrevCodeAction.title","Select previous action"),original:"Select previous action"},precondition:ActionWidgetContextKeys.Visible,keybinding:{weight:1100,primary:16,secondary:[2064],mac:{primary:16,secondary:[2064,302]}}})}run(e){const t=e.get(IActionWidgetService);t instanceof ActionWidgetService&&t.focusPrevious()}}),registerAction2(class extends Action2{constructor(){super({id:"selectNextCodeAction",title:{value:localize("selectNextCodeAction.title","Select next action"),original:"Select next action"},precondition:ActionWidgetContextKeys.Visible,keybinding:{weight:1100,primary:18,secondary:[2066],mac:{primary:18,secondary:[2066,300]}}})}run(e){const t=e.get(IActionWidgetService);t instanceof ActionWidgetService&&t.focusNext()}}),registerAction2(class extends Action2{constructor(){super({id:acceptSelectedActionCommand,title:{value:localize("acceptSelected.title","Accept selected action"),original:"Accept selected action"},precondition:ActionWidgetContextKeys.Visible,keybinding:{weight:1100,primary:3,secondary:[2132]}})}run(e){const t=e.get(IActionWidgetService);t instanceof ActionWidgetService&&t.acceptSelected()}}),registerAction2(class extends Action2{constructor(){super({id:previewSelectedActionCommand,title:{value:localize("previewSelected.title","Preview selected action"),original:"Preview selected action"},precondition:ActionWidgetContextKeys.Visible,keybinding:{weight:1100,primary:2051}})}run(e){const t=e.get(IActionWidgetService);t instanceof ActionWidgetService&&t.acceptSelected(!0)}});