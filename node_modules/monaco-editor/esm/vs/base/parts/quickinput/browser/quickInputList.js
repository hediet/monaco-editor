var __decorate=this&&this.__decorate||function(e,t,s,i){var n,o=arguments.length,l=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,s,i);else for(var r=e.length-1;r>=0;r--)(n=e[r])&&(l=(o<3?n(l):o>3?n(t,s,l):n(t,s))||l);return o>3&&l&&Object.defineProperty(t,s,l),l};import*as dom from"../../../browser/dom.js";import{StandardKeyboardEvent}from"../../../browser/keyboardEvent.js";import{ActionBar}from"../../../browser/ui/actionbar/actionbar.js";import{IconLabel}from"../../../browser/ui/iconLabel/iconLabel.js";import{KeybindingLabel}from"../../../browser/ui/keybindingLabel/keybindingLabel.js";import{range}from"../../../common/arrays.js";import{compareAnything}from"../../../common/comparers.js";import{memoize}from"../../../common/decorators.js";import{Emitter,Event}from"../../../common/event.js";import{getCodiconAriaLabel,matchesFuzzyIconAware,parseLabelWithIcons}from"../../../common/iconLabels.js";import{dispose}from"../../../common/lifecycle.js";import*as platform from"../../../common/platform.js";import{ltrim}from"../../../common/strings.js";import{withNullAsUndefined}from"../../../common/types.js";import{getIconClass}from"./quickInputUtils.js";import"./media/quickInput.css";import{localize}from"../../../../nls.js";const $=dom.$;class ListElement{get checked(){return!!this._checked}set checked(e){e!==this._checked&&(this._checked=e,this._onChecked.fire(e))}constructor(e){this.hidden=!1,this._onChecked=new Emitter,this.onChecked=this._onChecked.event,Object.assign(this,e)}dispose(){this._onChecked.dispose()}}class ListElementRenderer{get templateId(){return ListElementRenderer.ID}renderTemplate(e){const t=Object.create(null);t.toDisposeElement=[],t.toDisposeTemplate=[],t.entry=dom.append(e,$(".quick-input-list-entry"));const s=dom.append(t.entry,$("label.quick-input-list-label"));t.toDisposeTemplate.push(dom.addStandardDisposableListener(s,dom.EventType.CLICK,(e=>{t.checkbox.offsetParent||e.preventDefault()}))),t.checkbox=dom.append(s,$("input.quick-input-list-checkbox")),t.checkbox.type="checkbox",t.toDisposeTemplate.push(dom.addStandardDisposableListener(t.checkbox,dom.EventType.CHANGE,(e=>{t.element.checked=t.checkbox.checked})));const i=dom.append(s,$(".quick-input-list-rows")),n=dom.append(i,$(".quick-input-list-row")),o=dom.append(i,$(".quick-input-list-row"));t.label=new IconLabel(n,{supportHighlights:!0,supportDescriptionHighlights:!0,supportIcons:!0});const l=dom.append(n,$(".quick-input-list-entry-keybinding"));t.keybinding=new KeybindingLabel(l,platform.OS);const r=dom.append(o,$(".quick-input-list-label-meta"));return t.detail=new IconLabel(r,{supportHighlights:!0,supportIcons:!0}),t.separator=dom.append(t.entry,$(".quick-input-list-separator")),t.actionBar=new ActionBar(t.entry),t.actionBar.domNode.classList.add("quick-input-list-entry-action-bar"),t.toDisposeTemplate.push(t.actionBar),t}renderElement(e,t,s){s.element=e;const i=e.item?e.item:e.separator;s.checkbox.checked=e.checked,s.toDisposeElement.push(e.onChecked((e=>s.checkbox.checked=e)));const{labelHighlights:n,descriptionHighlights:o,detailHighlights:l}=e,r=Object.create(null);r.matches=n||[],r.descriptionTitle=e.saneDescription,r.descriptionMatches=o||[],"separator"!==i.type?(r.extraClasses=i.iconClasses,r.italic=i.italic,r.strikethrough=i.strikethrough,s.entry.classList.remove("quick-input-list-separator-as-item")):s.entry.classList.add("quick-input-list-separator-as-item"),s.label.setLabel(e.saneLabel,e.saneDescription,r),s.keybinding.set("separator"===i.type?void 0:i.keybinding),e.saneDetail&&s.detail.setLabel(e.saneDetail,void 0,{matches:l,title:e.saneDetail}),e.item&&e.separator&&e.separator.label?(s.separator.textContent=e.separator.label,s.separator.style.display=""):s.separator.style.display="none",s.entry.classList.toggle("quick-input-list-separator-border",!!e.separator);const a=i.buttons;a&&a.length?(s.actionBar.push(a.map(((t,s)=>{let n=t.iconClass||(t.iconPath?getIconClass(t.iconPath):void 0);return t.alwaysVisible&&(n=n?`${n} always-visible`:"always-visible"),{id:`id-${s}`,class:n,enabled:!0,label:"",tooltip:t.tooltip||"",run:()=>{"separator"!==i.type?e.fireButtonTriggered({button:t,item:i}):e.fireSeparatorButtonTriggered({button:t,separator:i})}}})),{icon:!0,label:!1}),s.entry.classList.add("has-actions")):s.entry.classList.remove("has-actions")}disposeElement(e,t,s){s.toDisposeElement=dispose(s.toDisposeElement),s.actionBar.clear()}disposeTemplate(e){e.toDisposeElement=dispose(e.toDisposeElement),e.toDisposeTemplate=dispose(e.toDisposeTemplate)}}ListElementRenderer.ID="listelement";class ListElementDelegate{getHeight(e){return e.item?e.saneDetail?44:22:24}getTemplateId(e){return ListElementRenderer.ID}}export var QuickInputListFocus;!function(e){e[e.First=1]="First",e[e.Second=2]="Second",e[e.Last=3]="Last",e[e.Next=4]="Next",e[e.Previous=5]="Previous",e[e.NextPage=6]="NextPage",e[e.PreviousPage=7]="PreviousPage"}(QuickInputListFocus||(QuickInputListFocus={}));export class QuickInputList{constructor(e,t,s){this.parent=e,this.inputElements=[],this.elements=[],this.elementsToIndexes=new Map,this.matchOnDescription=!1,this.matchOnDetail=!1,this.matchOnLabel=!0,this.matchOnLabelMode="fuzzy",this.matchOnMeta=!0,this.sortByLabel=!0,this._onChangedAllVisibleChecked=new Emitter,this.onChangedAllVisibleChecked=this._onChangedAllVisibleChecked.event,this._onChangedCheckedCount=new Emitter,this.onChangedCheckedCount=this._onChangedCheckedCount.event,this._onChangedVisibleCount=new Emitter,this.onChangedVisibleCount=this._onChangedVisibleCount.event,this._onChangedCheckedElements=new Emitter,this.onChangedCheckedElements=this._onChangedCheckedElements.event,this._onButtonTriggered=new Emitter,this.onButtonTriggered=this._onButtonTriggered.event,this._onSeparatorButtonTriggered=new Emitter,this.onSeparatorButtonTriggered=this._onSeparatorButtonTriggered.event,this._onKeyDown=new Emitter,this.onKeyDown=this._onKeyDown.event,this._onLeave=new Emitter,this.onLeave=this._onLeave.event,this._fireCheckedEvents=!0,this.elementDisposables=[],this.disposables=[],this.id=t,this.container=dom.append(this.parent,$(".quick-input-list"));const i=new ListElementDelegate,n=new QuickInputAccessibilityProvider;this.list=s.createList("QuickInput",this.container,i,[new ListElementRenderer],{identityProvider:{getId:e=>e.saneLabel},setRowLineHeight:!1,multipleSelectionSupport:!1,horizontalScrolling:!1,accessibilityProvider:n}),this.list.getHTMLElement().id=t,this.disposables.push(this.list),this.disposables.push(this.list.onKeyDown((e=>{const t=new StandardKeyboardEvent(e);switch(t.keyCode){case 10:this.toggleCheckbox();break;case 31:(platform.isMacintosh?e.metaKey:e.ctrlKey)&&this.list.setFocus(range(this.list.length));break;case 16:{const e=this.list.getFocus();1===e.length&&0===e[0]&&this._onLeave.fire();break}case 18:{const e=this.list.getFocus();1===e.length&&e[0]===this.list.length-1&&this._onLeave.fire();break}}this._onKeyDown.fire(t)}))),this.disposables.push(this.list.onMouseDown((e=>{2!==e.browserEvent.button&&e.browserEvent.preventDefault()}))),this.disposables.push(dom.addDisposableListener(this.container,dom.EventType.CLICK,(e=>{(e.x||e.y)&&this._onLeave.fire()}))),this.disposables.push(this.list.onMouseMiddleClick((e=>{this._onLeave.fire()}))),this.disposables.push(this.list.onContextMenu((e=>{"number"==typeof e.index&&(e.browserEvent.preventDefault(),this.list.setSelection([e.index]))}))),this.disposables.push(this._onChangedAllVisibleChecked,this._onChangedCheckedCount,this._onChangedVisibleCount,this._onChangedCheckedElements,this._onButtonTriggered,this._onSeparatorButtonTriggered,this._onLeave,this._onKeyDown)}get onDidChangeFocus(){return Event.map(this.list.onDidChangeFocus,(e=>e.elements.map((e=>e.item))))}get onDidChangeSelection(){return Event.map(this.list.onDidChangeSelection,(e=>({items:e.elements.map((e=>e.item)),event:e.browserEvent})))}get scrollTop(){return this.list.scrollTop}set scrollTop(e){this.list.scrollTop=e}getAllVisibleChecked(){return this.allVisibleChecked(this.elements,!1)}allVisibleChecked(e,t=!0){for(let s=0,i=e.length;s<i;s++){const i=e[s];if(!i.hidden){if(!i.checked)return!1;t=!0}}return t}getCheckedCount(){let e=0;const t=this.elements;for(let s=0,i=t.length;s<i;s++)t[s].checked&&e++;return e}getVisibleCount(){let e=0;const t=this.elements;for(let s=0,i=t.length;s<i;s++)t[s].hidden||e++;return e}setAllVisibleChecked(e){try{this._fireCheckedEvents=!1,this.elements.forEach((t=>{t.hidden||(t.checked=e)}))}finally{this._fireCheckedEvents=!0,this.fireCheckedEvents()}}setElements(e){this.elementDisposables=dispose(this.elementDisposables);const t=e=>this.fireButtonTriggered(e),s=e=>this.fireSeparatorButtonTriggered(e);this.inputElements=e,this.elements=e.reduce(((i,n,o)=>{var l,r,a;const h=o&&e[o-1],c=n.label?n.label.replace(/\r?\n/g," "):"",d=parseLabelWithIcons(c).text.trim();let p,u,m,g,b,k;"separator"!==n.type&&(p=n.meta&&n.meta.replace(/\r?\n/g," "),u=n.description&&n.description.replace(/\r?\n/g," "),m=n.detail&&n.detail.replace(/\r?\n/g," "),g=null===(l=n.highlights)||void 0===l?void 0:l.label,b=null===(r=n.highlights)||void 0===r?void 0:r.description,k=null===(a=n.highlights)||void 0===a?void 0:a.detail);const f=n.ariaLabel||[c,u,m].map((e=>getCodiconAriaLabel(e))).filter((e=>!!e)).join(", "),C=this.parent.classList.contains("show-checkboxes");let v;if("separator"===n.type){if(!n.buttons)return i;v=n}else h&&"separator"===h.type&&!h.buttons&&(v=h);const y=new ListElement({hasCheckbox:C,index:o,item:"separator"!==n.type?n:void 0,saneLabel:c,saneSortLabel:d,saneMeta:p,saneAriaLabel:f,saneDescription:u,saneDetail:m,labelHighlights:g,descriptionHighlights:b,detailHighlights:k,checked:!1,separator:v,fireButtonTriggered:t,fireSeparatorButtonTriggered:s});return this.elementDisposables.push(y),this.elementDisposables.push(y.onChecked((()=>this.fireCheckedEvents()))),i.push(y),i}),[]),this.elementsToIndexes=this.elements.reduce(((e,t,s)=>{var i;return e.set(null!==(i=t.item)&&void 0!==i?i:t.separator,s),e}),new Map),this.list.splice(0,this.list.length),this.list.splice(0,this.list.length,this.elements),this._onChangedVisibleCount.fire(this.elements.length)}getFocusedElements(){return this.list.getFocusedElements().map((e=>e.item))}setFocusedElements(e){if(this.list.setFocus(e.filter((e=>this.elementsToIndexes.has(e))).map((e=>this.elementsToIndexes.get(e)))),e.length>0){const e=this.list.getFocus()[0];"number"==typeof e&&this.list.reveal(e)}}getActiveDescendant(){return this.list.getHTMLElement().getAttribute("aria-activedescendant")}setSelectedElements(e){this.list.setSelection(e.filter((e=>this.elementsToIndexes.has(e))).map((e=>this.elementsToIndexes.get(e))))}getCheckedElements(){return this.elements.filter((e=>e.checked)).map((e=>e.item)).filter((e=>!!e))}setCheckedElements(e){try{this._fireCheckedEvents=!1;const t=new Set;for(const s of e)t.add(s);for(const e of this.elements)e.checked=t.has(e.item)}finally{this._fireCheckedEvents=!0,this.fireCheckedEvents()}}set enabled(e){this.list.getHTMLElement().style.pointerEvents=e?"":"none"}focus(e){if(!this.list.length)return;switch(e===QuickInputListFocus.Second&&this.list.length<2&&(e=QuickInputListFocus.First),e){case QuickInputListFocus.First:this.list.scrollTop=0,this.list.focusFirst(void 0,(e=>!!e.item));break;case QuickInputListFocus.Second:this.list.scrollTop=0,this.list.focusNth(1,void 0,(e=>!!e.item));break;case QuickInputListFocus.Last:this.list.scrollTop=this.list.scrollHeight,this.list.focusLast(void 0,(e=>!!e.item));break;case QuickInputListFocus.Next:{this.list.focusNext(void 0,!0,void 0,(e=>!!e.item));const e=this.list.getFocus()[0];0!==e&&!this.elements[e-1].item&&this.list.firstVisibleIndex>e-1&&this.list.reveal(e-1);break}case QuickInputListFocus.Previous:{this.list.focusPrevious(void 0,!0,void 0,(e=>!!e.item));const e=this.list.getFocus()[0];0!==e&&!this.elements[e-1].item&&this.list.firstVisibleIndex>e-1&&this.list.reveal(e-1);break}case QuickInputListFocus.NextPage:this.list.focusNextPage(void 0,(e=>!!e.item));break;case QuickInputListFocus.PreviousPage:this.list.focusPreviousPage(void 0,(e=>!!e.item))}const t=this.list.getFocus()[0];"number"==typeof t&&this.list.reveal(t)}clearFocus(){this.list.setFocus([])}domFocus(){this.list.domFocus()}layout(e){this.list.getHTMLElement().style.maxHeight=e?`calc(${44*Math.floor(e/44)}px)`:"",this.list.layout()}filter(e){if(!(this.sortByLabel||this.matchOnLabel||this.matchOnDescription||this.matchOnDetail))return this.list.layout(),!1;const t=e;if((e=e.trim())&&(this.matchOnLabel||this.matchOnDescription||this.matchOnDetail)){let s;this.elements.forEach((i=>{let n;n="fuzzy"===this.matchOnLabelMode?this.matchOnLabel?withNullAsUndefined(matchesFuzzyIconAware(e,parseLabelWithIcons(i.saneLabel))):void 0:this.matchOnLabel?withNullAsUndefined(matchesContiguousIconAware(t,parseLabelWithIcons(i.saneLabel))):void 0;const o=this.matchOnDescription?withNullAsUndefined(matchesFuzzyIconAware(e,parseLabelWithIcons(i.saneDescription||""))):void 0,l=this.matchOnDetail?withNullAsUndefined(matchesFuzzyIconAware(e,parseLabelWithIcons(i.saneDetail||""))):void 0,r=this.matchOnMeta?withNullAsUndefined(matchesFuzzyIconAware(e,parseLabelWithIcons(i.saneMeta||""))):void 0;if(n||o||l||r?(i.labelHighlights=n,i.descriptionHighlights=o,i.detailHighlights=l,i.hidden=!1):(i.labelHighlights=void 0,i.descriptionHighlights=void 0,i.detailHighlights=void 0,i.hidden=!i.item||!i.item.alwaysShow),!this.sortByLabel){const e=i.index&&this.inputElements[i.index-1];s=e&&"separator"===e.type?e:s,s&&!i.hidden&&(i.separator=s,s=void 0)}}))}else this.elements.forEach((e=>{e.labelHighlights=void 0,e.descriptionHighlights=void 0,e.detailHighlights=void 0,e.hidden=!1;const t=e.index&&this.inputElements[e.index-1];e.item&&(e.separator=t&&"separator"===t.type&&!t.buttons?t:void 0)}));const s=this.elements.filter((e=>!e.hidden));if(this.sortByLabel&&e){const t=e.toLowerCase();s.sort(((e,s)=>compareEntries(e,s,t)))}return this.elementsToIndexes=s.reduce(((e,t,s)=>{var i;return e.set(null!==(i=t.item)&&void 0!==i?i:t.separator,s),e}),new Map),this.list.splice(0,this.list.length,s),this.list.setFocus([]),this.list.layout(),this._onChangedAllVisibleChecked.fire(this.getAllVisibleChecked()),this._onChangedVisibleCount.fire(s.length),!0}toggleCheckbox(){try{this._fireCheckedEvents=!1;const e=this.list.getFocusedElements(),t=this.allVisibleChecked(e);for(const s of e)s.checked=!t}finally{this._fireCheckedEvents=!0,this.fireCheckedEvents()}}display(e){this.container.style.display=e?"":"none"}isDisplayed(){return"none"!==this.container.style.display}dispose(){this.elementDisposables=dispose(this.elementDisposables),this.disposables=dispose(this.disposables)}fireCheckedEvents(){this._fireCheckedEvents&&(this._onChangedAllVisibleChecked.fire(this.getAllVisibleChecked()),this._onChangedCheckedCount.fire(this.getCheckedCount()),this._onChangedCheckedElements.fire(this.getCheckedElements()))}fireButtonTriggered(e){this._onButtonTriggered.fire(e)}fireSeparatorButtonTriggered(e){this._onSeparatorButtonTriggered.fire(e)}style(e){this.list.style(e)}}function matchesContiguousIconAware(e,t){const{text:s,iconOffsets:i}=t;if(!i||0===i.length)return matchesContiguous(e,s);const n=ltrim(s," "),o=s.length-n.length,l=matchesContiguous(e,n);if(l)for(const e of l){const t=i[e.start+o]+o;e.start+=t,e.end+=t}return l}function matchesContiguous(e,t){const s=t.toLowerCase().indexOf(e.toLowerCase());return-1!==s?[{start:s,end:s+e.length}]:null}function compareEntries(e,t,s){const i=e.labelHighlights||[],n=t.labelHighlights||[];return i.length&&!n.length?-1:!i.length&&n.length?1:0===i.length&&0===n.length?0:compareAnything(e.saneSortLabel,t.saneSortLabel,s)}__decorate([memoize],QuickInputList.prototype,"onDidChangeFocus",null),__decorate([memoize],QuickInputList.prototype,"onDidChangeSelection",null);class QuickInputAccessibilityProvider{getWidgetAriaLabel(){return localize("quickInput","Quick Input")}getAriaLabel(e){var t;return(null===(t=e.separator)||void 0===t?void 0:t.label)?`${e.saneAriaLabel}, ${e.separator.label}`:e.saneAriaLabel}getWidgetRole(){return"listbox"}getRole(e){return e.hasCheckbox?"checkbox":"option"}isChecked(e){if(e.hasCheckbox)return{value:e.checked,onDidChange:e.onChecked}}}