import*as DOM from"./dom.js";import*as dompurify from"./dompurify/dompurify.js";import{DomEmitter}from"./event.js";import{createElement}from"./formattedTextRenderer.js";import{StandardKeyboardEvent}from"./keyboardEvent.js";import{StandardMouseEvent}from"./mouseEvent.js";import{renderLabelWithIcons}from"./ui/iconLabel/iconLabels.js";import{onUnexpectedError}from"../common/errors.js";import{Event}from"../common/event.js";import{escapeDoubleQuotes,parseHrefAndDimensions,removeMarkdownEscapes}from"../common/htmlContent.js";import{markdownEscapeEscapedIcons}from"../common/iconLabels.js";import{defaultGenerator}from"../common/idGenerator.js";import{Lazy}from"../common/lazy.js";import{DisposableStore}from"../common/lifecycle.js";import{marked}from"../common/marked/marked.js";import{parse}from"../common/marshalling.js";import{FileAccess,Schemas}from"../common/network.js";import{cloneAndChange}from"../common/objects.js";import{dirname,resolvePath}from"../common/resources.js";import{escape}from"../common/strings.js";import{URI}from"../common/uri.js";const defaultMarkedRenderers=Object.freeze({image:(e,t,r)=>{let o=[],a=[];return e&&(({href:e,dimensions:o}=parseHrefAndDimensions(e)),a.push(`src="${escapeDoubleQuotes(e)}"`)),r&&a.push(`alt="${escapeDoubleQuotes(r)}"`),t&&a.push(`title="${escapeDoubleQuotes(t)}"`),o.length&&(a=a.concat(o)),"<img "+a.join(" ")+">"},paragraph:e=>`<p>${e}</p>`,link:(e,t,r)=>"string"!=typeof e?"":(e===r&&(r=removeMarkdownEscapes(r)),t="string"==typeof t?escapeDoubleQuotes(removeMarkdownEscapes(t)):"",`<a href="${e=(e=removeMarkdownEscapes(e)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}" title="${t||e}">${r}</a>`)});export function renderMarkdown(e,t={},r={}){var o;const a=new DisposableStore;let n=!1;const s=createElement(t),i=function(t){let r;try{r=parse(decodeURIComponent(t))}catch(e){}return r?(r=cloneAndChange(r,(t=>e.uris&&e.uris[t]?URI.revive(e.uris[t]):void 0)),encodeURIComponent(JSON.stringify(r))):t},c=function(t,r){const o=e.uris&&e.uris[t];let a=URI.revive(o);return r?t.startsWith(Schemas.data+":")?t:(a||(a=URI.parse(t)),FileAccess.uriToBrowserUri(a).toString(!0)):a?URI.parse(t).toString()===a.toString()?t:(a.query&&(a=a.with({query:i(a.query)})),a.toString()):t},d=new marked.Renderer;d.image=defaultMarkedRenderers.image,d.link=defaultMarkedRenderers.link,d.paragraph=defaultMarkedRenderers.paragraph;const l=[];if(t.codeBlockRenderer&&(d.code=(e,r)=>{const o=defaultGenerator.nextId(),a=t.codeBlockRenderer(postProcessCodeBlockLanguageId(r),e);return l.push(a.then((e=>[o,e]))),`<div class="code" data-code="${o}">${escape(e)}</div>`}),t.actionHandler){const r=function(r){let o=r.target;if("A"===o.tagName||(o=o.parentElement,o&&"A"===o.tagName))try{let a=o.dataset.href;a&&(e.baseUri&&(a=resolveWithBaseUri(URI.from(e.baseUri),a)),t.actionHandler.callback(a,r))}catch(e){onUnexpectedError(e)}finally{r.preventDefault()}},o=t.actionHandler.disposables.add(new DomEmitter(s,"click")),a=t.actionHandler.disposables.add(new DomEmitter(s,"auxclick"));t.actionHandler.disposables.add(Event.any(o.event,a.event)((e=>{const t=new StandardMouseEvent(e);(t.leftButton||t.middleButton)&&r(t)}))),t.actionHandler.disposables.add(DOM.addDisposableListener(s,"keydown",(e=>{const t=new StandardKeyboardEvent(e);(t.equals(10)||t.equals(3))&&r(t)})))}e.supportHtml||(r.sanitizer=t=>(e.isTrusted?t.match(/^(<span[^>]+>)|(<\/\s*span>)$/):void 0)?t:"",r.sanitize=!0,r.silent=!0),r.renderer=d;let m=null!==(o=e.value)&&void 0!==o?o:"";m.length>1e5&&(m=`${m.substr(0,1e5)}â€¦`),e.supportThemeIcons&&(m=markdownEscapeEscapedIcons(m));let p=marked.parse(m,r);e.supportThemeIcons&&(p=renderLabelWithIcons(p).map((e=>"string"==typeof e?e:e.outerHTML)).join(""));const u=(new DOMParser).parseFromString(sanitizeRenderedMarkdown(e,p),"text/html");if(u.body.querySelectorAll("img").forEach((t=>{const r=t.getAttribute("src");if(r){let o=r;try{e.baseUri&&(o=resolveWithBaseUri(URI.from(e.baseUri),o))}catch(e){}t.src=c(o,!0)}})),u.body.querySelectorAll("a").forEach((t=>{const r=t.getAttribute("href");if(t.removeAttribute("href"),!r||/^data:|javascript:/i.test(r)||/^command:/i.test(r)&&!e.isTrusted||/^command:(\/\/\/)?_workbench\.downloadResource/i.test(r))t.replaceWith(...t.childNodes);else{let o=c(r,!1);e.baseUri&&(o=resolveWithBaseUri(URI.from(e.baseUri),r)),t.dataset.href=o}})),s.innerHTML=sanitizeRenderedMarkdown(e,u.body.innerHTML),l.length>0&&Promise.all(l).then((e=>{var r,o;if(n)return;const a=new Map(e),i=s.querySelectorAll("div[data-code]");for(const e of i){const t=a.get(null!==(r=e.dataset.code)&&void 0!==r?r:"");t&&DOM.reset(e,t)}null===(o=t.asyncRenderCallback)||void 0===o||o.call(t)})),t.asyncRenderCallback)for(const e of s.getElementsByTagName("img")){const r=a.add(DOM.addDisposableListener(e,"load",(()=>{r.dispose(),t.asyncRenderCallback()})))}return{element:s,dispose:()=>{n=!0,a.dispose()}}}function postProcessCodeBlockLanguageId(e){if(!e)return"";const t=e.split(/[\s+|:|,|\{|\?]/,1);return t.length?t[0]:e}function resolveWithBaseUri(e,t){return/^\w[\w\d+.-]*:/.test(t)?t:e.path.endsWith("/")?resolvePath(e,t).toString():resolvePath(dirname(e),t).toString()}function sanitizeRenderedMarkdown(e,t){const{config:r,allowedSchemes:o}=getSanitizerOptions(e);dompurify.addHook("uponSanitizeAttribute",((e,t)=>{if("style"!==t.attrName&&"class"!==t.attrName);else{if("SPAN"===e.tagName){if("style"===t.attrName)return void(t.keepAttr=/^(color\:#[0-9a-fA-F]+;)?(background-color\:#[0-9a-fA-F]+;)?$/.test(t.attrValue));if("class"===t.attrName)return void(t.keepAttr=/^codicon codicon-[a-z\-]+( codicon-modifier-[a-z\-]+)?$/.test(t.attrValue))}t.keepAttr=!1}}));const a=DOM.hookDomPurifyHrefAndSrcSanitizer(o);try{return dompurify.sanitize(t,Object.assign(Object.assign({},r),{RETURN_TRUSTED_TYPE:!0}))}finally{dompurify.removeHook("uponSanitizeAttribute"),a.dispose()}}export const allowedMarkdownAttr=["align","autoplay","alt","class","controls","data-code","data-href","height","href","loop","muted","playsinline","poster","src","style","target","title","width"];function getSanitizerOptions(e){const t=[Schemas.http,Schemas.https,Schemas.mailto,Schemas.data,Schemas.file,Schemas.vscodeFileResource,Schemas.vscodeRemote,Schemas.vscodeRemoteResource];return e.isTrusted&&t.push(Schemas.command),{config:{ALLOWED_TAGS:[...DOM.basicMarkupHtmlTags],ALLOWED_ATTR:allowedMarkdownAttr,ALLOW_UNKNOWN_PROTOCOLS:!0},allowedSchemes:t}}const unescapeInfo=new Map([["&quot;",'"'],["&nbsp;"," "],["&amp;","&"],["&#39;","'"],["&lt;","<"],["&gt;",">"]]),plainTextRenderer=new Lazy((()=>{const e=new marked.Renderer;return e.code=e=>e,e.blockquote=e=>e,e.html=e=>"",e.heading=(e,t,r)=>e+"\n",e.hr=()=>"",e.list=(e,t)=>e,e.listitem=e=>e+"\n",e.paragraph=e=>e+"\n",e.table=(e,t)=>e+t+"\n",e.tablerow=e=>e,e.tablecell=(e,t)=>e+" ",e.strong=e=>e,e.em=e=>e,e.codespan=e=>e,e.br=()=>"\n",e.del=e=>e,e.image=(e,t,r)=>"",e.text=e=>e,e.link=(e,t,r)=>r,e}));