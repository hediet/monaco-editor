var __decorate=this&&this.__decorate||function(e,t,i,a){var s,n=arguments.length,o=n<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,a);else for(var r=e.length-1;r>=0;r--)(s=e[r])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};import*as DomUtils from"./dom.js";import*as arrays from"../common/arrays.js";import{memoize}from"../common/decorators.js";import{Disposable,toDisposable}from"../common/lifecycle.js";import{LinkedList}from"../common/linkedList.js";export var EventType;!function(e){e.Tap="-monaco-gesturetap",e.Change="-monaco-gesturechange",e.Start="-monaco-gesturestart",e.End="-monaco-gesturesend",e.Contextmenu="-monaco-gesturecontextmenu"}(EventType||(EventType={}));class Gesture extends Disposable{constructor(){super(),this.dispatched=!1,this.targets=new LinkedList,this.ignoreTargets=new LinkedList,this.activeTouches={},this.handle=null,this._lastSetTapCountTime=0,this._register(DomUtils.addDisposableListener(document,"touchstart",(e=>this.onTouchStart(e)),{passive:!1})),this._register(DomUtils.addDisposableListener(document,"touchend",(e=>this.onTouchEnd(e)))),this._register(DomUtils.addDisposableListener(document,"touchmove",(e=>this.onTouchMove(e)),{passive:!1}))}static addTarget(e){if(!Gesture.isTouchDevice())return Disposable.None;Gesture.INSTANCE||(Gesture.INSTANCE=new Gesture);const t=Gesture.INSTANCE.targets.push(e);return toDisposable(t)}static ignoreTarget(e){if(!Gesture.isTouchDevice())return Disposable.None;Gesture.INSTANCE||(Gesture.INSTANCE=new Gesture);const t=Gesture.INSTANCE.ignoreTargets.push(e);return toDisposable(t)}static isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0}dispose(){this.handle&&(this.handle.dispose(),this.handle=null),super.dispose()}onTouchStart(e){const t=Date.now();this.handle&&(this.handle.dispose(),this.handle=null);for(let i=0,a=e.targetTouches.length;i<a;i++){const a=e.targetTouches.item(i);this.activeTouches[a.identifier]={id:a.identifier,initialTarget:a.target,initialTimeStamp:t,initialPageX:a.pageX,initialPageY:a.pageY,rollingTimestamps:[t],rollingPageX:[a.pageX],rollingPageY:[a.pageY]};const s=this.newGestureEvent(EventType.Start,a.target);s.pageX=a.pageX,s.pageY=a.pageY,this.dispatchEvent(s)}this.dispatched&&(e.preventDefault(),e.stopPropagation(),this.dispatched=!1)}onTouchEnd(e){const t=Date.now(),i=Object.keys(this.activeTouches).length;for(let a=0,s=e.changedTouches.length;a<s;a++){const s=e.changedTouches.item(a);if(!this.activeTouches.hasOwnProperty(String(s.identifier))){console.warn("move of an UNKNOWN touch",s);continue}const n=this.activeTouches[s.identifier],o=Date.now()-n.initialTimeStamp;if(o<Gesture.HOLD_DELAY&&Math.abs(n.initialPageX-arrays.tail(n.rollingPageX))<30&&Math.abs(n.initialPageY-arrays.tail(n.rollingPageY))<30){const e=this.newGestureEvent(EventType.Tap,n.initialTarget);e.pageX=arrays.tail(n.rollingPageX),e.pageY=arrays.tail(n.rollingPageY),this.dispatchEvent(e)}else if(o>=Gesture.HOLD_DELAY&&Math.abs(n.initialPageX-arrays.tail(n.rollingPageX))<30&&Math.abs(n.initialPageY-arrays.tail(n.rollingPageY))<30){const e=this.newGestureEvent(EventType.Contextmenu,n.initialTarget);e.pageX=arrays.tail(n.rollingPageX),e.pageY=arrays.tail(n.rollingPageY),this.dispatchEvent(e)}else if(1===i){const e=arrays.tail(n.rollingPageX),i=arrays.tail(n.rollingPageY),a=arrays.tail(n.rollingTimestamps)-n.rollingTimestamps[0],s=e-n.rollingPageX[0],o=i-n.rollingPageY[0],r=[...this.targets].filter((e=>n.initialTarget instanceof Node&&e.contains(n.initialTarget)));this.inertia(r,t,Math.abs(s)/a,s>0?1:-1,e,Math.abs(o)/a,o>0?1:-1,i)}this.dispatchEvent(this.newGestureEvent(EventType.End,n.initialTarget)),delete this.activeTouches[s.identifier]}this.dispatched&&(e.preventDefault(),e.stopPropagation(),this.dispatched=!1)}newGestureEvent(e,t){const i=document.createEvent("CustomEvent");return i.initEvent(e,!1,!0),i.initialTarget=t,i.tapCount=0,i}dispatchEvent(e){if(e.type===EventType.Tap){const t=(new Date).getTime();let i=0;i=t-this._lastSetTapCountTime>Gesture.CLEAR_TAP_COUNT_TIME?1:2,this._lastSetTapCountTime=t,e.tapCount=i}else e.type!==EventType.Change&&e.type!==EventType.Contextmenu||(this._lastSetTapCountTime=0);if(e.initialTarget instanceof Node){for(const t of this.ignoreTargets)if(t.contains(e.initialTarget))return;for(const t of this.targets)t.contains(e.initialTarget)&&(t.dispatchEvent(e),this.dispatched=!0)}}inertia(e,t,i,a,s,n,o,r){this.handle=DomUtils.scheduleAtNextAnimationFrame((()=>{const l=Date.now(),h=l-t;let c=0,g=0,p=!0;i+=Gesture.SCROLL_FRICTION*h,n+=Gesture.SCROLL_FRICTION*h,i>0&&(p=!1,c=a*i*h),n>0&&(p=!1,g=o*n*h);const u=this.newGestureEvent(EventType.Change);u.translationX=c,u.translationY=g,e.forEach((e=>e.dispatchEvent(u))),p||this.inertia(e,l,i,a,s+c,n,o,r+g)}))}onTouchMove(e){const t=Date.now();for(let i=0,a=e.changedTouches.length;i<a;i++){const a=e.changedTouches.item(i);if(!this.activeTouches.hasOwnProperty(String(a.identifier))){console.warn("end of an UNKNOWN touch",a);continue}const s=this.activeTouches[a.identifier],n=this.newGestureEvent(EventType.Change,s.initialTarget);n.translationX=a.pageX-arrays.tail(s.rollingPageX),n.translationY=a.pageY-arrays.tail(s.rollingPageY),n.pageX=a.pageX,n.pageY=a.pageY,this.dispatchEvent(n),s.rollingPageX.length>3&&(s.rollingPageX.shift(),s.rollingPageY.shift(),s.rollingTimestamps.shift()),s.rollingPageX.push(a.pageX),s.rollingPageY.push(a.pageY),s.rollingTimestamps.push(t)}this.dispatched&&(e.preventDefault(),e.stopPropagation(),this.dispatched=!1)}}Gesture.SCROLL_FRICTION=-.005,Gesture.HOLD_DELAY=700,Gesture.CLEAR_TAP_COUNT_TIME=400,__decorate([memoize],Gesture,"isTouchDevice",null);export{Gesture};