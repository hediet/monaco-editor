import*as browser from"./browser.js";import{BrowserFeatures}from"./canIUse.js";import{StandardKeyboardEvent}from"./keyboardEvent.js";import{StandardMouseEvent}from"./mouseEvent.js";import{onUnexpectedError}from"../common/errors.js";import*as event from"../common/event.js";import*as dompurify from"./dompurify/dompurify.js";import{Disposable,DisposableStore,toDisposable}from"../common/lifecycle.js";import{FileAccess,RemoteAuthorities}from"../common/network.js";import*as platform from"../common/platform.js";export function clearNode(e){for(;e.firstChild;)e.firstChild.remove()}export function isInDOM(e){var t;return null!==(t=null==e?void 0:e.isConnected)&&void 0!==t&&t}class DomListener{constructor(e,t,i,s){this._node=e,this._type=t,this._handler=i,this._options=s||!1,this._node.addEventListener(this._type,this._handler,this._options)}dispose(){this._handler&&(this._node.removeEventListener(this._type,this._handler,this._options),this._node=null,this._handler=null)}}export function addDisposableListener(e,t,i,s){return new DomListener(e,t,i,s)}function _wrapAsStandardMouseEvent(e){return function(t){return e(new StandardMouseEvent(t))}}function _wrapAsStandardKeyboardEvent(e){return function(t){return e(new StandardKeyboardEvent(t))}}export const addStandardDisposableListener=function(e,t,i,s){let r=i;return"click"===t||"mousedown"===t?r=_wrapAsStandardMouseEvent(i):"keydown"!==t&&"keypress"!==t&&"keyup"!==t||(r=_wrapAsStandardKeyboardEvent(i)),addDisposableListener(e,t,r,s)};export const addStandardDisposableGenericMouseDownListener=function(e,t,i){return addDisposableGenericMouseDownListener(e,_wrapAsStandardMouseEvent(t),i)};export const addStandardDisposableGenericMouseUpListener=function(e,t,i){return addDisposableGenericMouseUpListener(e,_wrapAsStandardMouseEvent(t),i)};export function addDisposableGenericMouseDownListener(e,t,i){return addDisposableListener(e,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_DOWN:EventType.MOUSE_DOWN,t,i)}export function addDisposableGenericMouseUpListener(e,t,i){return addDisposableListener(e,platform.isIOS&&BrowserFeatures.pointerEvents?EventType.POINTER_UP:EventType.MOUSE_UP,t,i)}export let runAtThisOrScheduleAtNextAnimationFrame;export let scheduleAtNextAnimationFrame;class AnimationFrameQueueItem{constructor(e,t=0){this._runner=e,this.priority=t,this._canceled=!1}dispose(){this._canceled=!0}execute(){if(!this._canceled)try{this._runner()}catch(e){onUnexpectedError(e)}}static sort(e,t){return t.priority-e.priority}}!function(){let e=[],t=null,i=!1,s=!1;const r=()=>{for(i=!1,t=e,e=[],s=!0;t.length>0;)t.sort(AnimationFrameQueueItem.sort),t.shift().execute();s=!1};scheduleAtNextAnimationFrame=(t,s=0)=>{const n=new AnimationFrameQueueItem(t,s);return e.push(n),i||(i=!0,requestAnimationFrame(r)),n},runAtThisOrScheduleAtNextAnimationFrame=(e,i)=>{if(s){const s=new AnimationFrameQueueItem(e,i);return t.push(s),s}return scheduleAtNextAnimationFrame(e,i)}}();export function getComputedStyle(e){return document.defaultView.getComputedStyle(e,null)}export function getClientArea(e){if(e!==document.body)return new Dimension(e.clientWidth,e.clientHeight);if(platform.isIOS&&window.visualViewport)return new Dimension(window.visualViewport.width,window.visualViewport.height);if(window.innerWidth&&window.innerHeight)return new Dimension(window.innerWidth,window.innerHeight);if(document.body&&document.body.clientWidth&&document.body.clientHeight)return new Dimension(document.body.clientWidth,document.body.clientHeight);if(document.documentElement&&document.documentElement.clientWidth&&document.documentElement.clientHeight)return new Dimension(document.documentElement.clientWidth,document.documentElement.clientHeight);throw new Error("Unable to figure out browser width and height")}class SizeUtils{static convertToPixels(e,t){return parseFloat(t)||0}static getDimension(e,t,i){const s=getComputedStyle(e),r=s?s.getPropertyValue(t):"0";return SizeUtils.convertToPixels(e,r)}static getBorderLeftWidth(e){return SizeUtils.getDimension(e,"border-left-width","borderLeftWidth")}static getBorderRightWidth(e){return SizeUtils.getDimension(e,"border-right-width","borderRightWidth")}static getBorderTopWidth(e){return SizeUtils.getDimension(e,"border-top-width","borderTopWidth")}static getBorderBottomWidth(e){return SizeUtils.getDimension(e,"border-bottom-width","borderBottomWidth")}static getPaddingLeft(e){return SizeUtils.getDimension(e,"padding-left","paddingLeft")}static getPaddingRight(e){return SizeUtils.getDimension(e,"padding-right","paddingRight")}static getPaddingTop(e){return SizeUtils.getDimension(e,"padding-top","paddingTop")}static getPaddingBottom(e){return SizeUtils.getDimension(e,"padding-bottom","paddingBottom")}static getMarginLeft(e){return SizeUtils.getDimension(e,"margin-left","marginLeft")}static getMarginTop(e){return SizeUtils.getDimension(e,"margin-top","marginTop")}static getMarginRight(e){return SizeUtils.getDimension(e,"margin-right","marginRight")}static getMarginBottom(e){return SizeUtils.getDimension(e,"margin-bottom","marginBottom")}}class Dimension{constructor(e,t){this.width=e,this.height=t}with(e=this.width,t=this.height){return e!==this.width||t!==this.height?new Dimension(e,t):this}static is(e){return"object"==typeof e&&"number"==typeof e.height&&"number"==typeof e.width}static lift(e){return e instanceof Dimension?e:new Dimension(e.width,e.height)}static equals(e,t){return e===t||!(!e||!t)&&e.width===t.width&&e.height===t.height}}Dimension.None=new Dimension(0,0);export{Dimension};export function getTopLeftOffset(e){let t=e.offsetParent,i=e.offsetTop,s=e.offsetLeft;for(;null!==(e=e.parentNode)&&e!==document.body&&e!==document.documentElement;){i-=e.scrollTop;const r=isShadowRoot(e)?null:getComputedStyle(e);r&&(s-="rtl"!==r.direction?e.scrollLeft:-e.scrollLeft),e===t&&(s+=SizeUtils.getBorderLeftWidth(e),i+=SizeUtils.getBorderTopWidth(e),i+=e.offsetTop,s+=e.offsetLeft,t=e.offsetParent)}return{left:s,top:i}}export function size(e,t,i){"number"==typeof t&&(e.style.width=`${t}px`),"number"==typeof i&&(e.style.height=`${i}px`)}export function getDomNodePagePosition(e){const t=e.getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY,width:t.width,height:t.height}}export function getDomNodeZoomLevel(e){let t=e,i=1;do{const e=getComputedStyle(t).zoom;null!=e&&"1"!==e&&(i*=e),t=t.parentElement}while(null!==t&&t!==document.documentElement);return i}export function getTotalWidth(e){const t=SizeUtils.getMarginLeft(e)+SizeUtils.getMarginRight(e);return e.offsetWidth+t}export function getContentWidth(e){const t=SizeUtils.getBorderLeftWidth(e)+SizeUtils.getBorderRightWidth(e),i=SizeUtils.getPaddingLeft(e)+SizeUtils.getPaddingRight(e);return e.offsetWidth-t-i}export function getContentHeight(e){const t=SizeUtils.getBorderTopWidth(e)+SizeUtils.getBorderBottomWidth(e),i=SizeUtils.getPaddingTop(e)+SizeUtils.getPaddingBottom(e);return e.offsetHeight-t-i}export function getTotalHeight(e){const t=SizeUtils.getMarginTop(e)+SizeUtils.getMarginBottom(e);return e.offsetHeight+t}export function isAncestor(e,t){for(;e;){if(e===t)return!0;e=e.parentNode}return!1}export function findParentWithClass(e,t,i){for(;e&&e.nodeType===e.ELEMENT_NODE;){if(e.classList.contains(t))return e;if(i)if("string"==typeof i){if(e.classList.contains(i))return null}else if(e===i)return null;e=e.parentNode}return null}export function hasParentWithClass(e,t,i){return!!findParentWithClass(e,t,i)}export function isShadowRoot(e){return e&&!!e.host&&!!e.mode}export function isInShadowDOM(e){return!!getShadowRoot(e)}export function getShadowRoot(e){for(;e.parentNode;){if(e===document.body)return null;e=e.parentNode}return isShadowRoot(e)?e:null}export function getActiveElement(){let e=document.activeElement;for(;null==e?void 0:e.shadowRoot;)e=e.shadowRoot.activeElement;return e}export function createStyleSheet(e=document.getElementsByTagName("head")[0]){const t=document.createElement("style");return t.type="text/css",t.media="screen",e.appendChild(t),t}let _sharedStyleSheet=null;function getSharedStyleSheet(){return _sharedStyleSheet||(_sharedStyleSheet=createStyleSheet()),_sharedStyleSheet}function getDynamicStyleSheetRules(e){var t,i;return(null===(t=null==e?void 0:e.sheet)||void 0===t?void 0:t.rules)?e.sheet.rules:(null===(i=null==e?void 0:e.sheet)||void 0===i?void 0:i.cssRules)?e.sheet.cssRules:[]}export function createCSSRule(e,t,i=getSharedStyleSheet()){i&&t&&i.sheet.insertRule(e+"{"+t+"}",0)}export function removeCSSRulesContainingSelector(e,t=getSharedStyleSheet()){if(!t)return;const i=getDynamicStyleSheetRules(t),s=[];for(let t=0;t<i.length;t++)-1!==i[t].selectorText.indexOf(e)&&s.push(t);for(let e=s.length-1;e>=0;e--)t.sheet.deleteRule(s[e])}export function isHTMLElement(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}export const EventType={CLICK:"click",AUXCLICK:"auxclick",DBLCLICK:"dblclick",MOUSE_UP:"mouseup",MOUSE_DOWN:"mousedown",MOUSE_OVER:"mouseover",MOUSE_MOVE:"mousemove",MOUSE_OUT:"mouseout",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",MOUSE_WHEEL:"wheel",POINTER_UP:"pointerup",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",POINTER_LEAVE:"pointerleave",CONTEXT_MENU:"contextmenu",WHEEL:"wheel",KEY_DOWN:"keydown",KEY_PRESS:"keypress",KEY_UP:"keyup",LOAD:"load",BEFORE_UNLOAD:"beforeunload",UNLOAD:"unload",PAGE_SHOW:"pageshow",PAGE_HIDE:"pagehide",ABORT:"abort",ERROR:"error",RESIZE:"resize",SCROLL:"scroll",FULLSCREEN_CHANGE:"fullscreenchange",WK_FULLSCREEN_CHANGE:"webkitfullscreenchange",SELECT:"select",CHANGE:"change",SUBMIT:"submit",RESET:"reset",FOCUS:"focus",FOCUS_IN:"focusin",FOCUS_OUT:"focusout",BLUR:"blur",INPUT:"input",STORAGE:"storage",DRAG_START:"dragstart",DRAG:"drag",DRAG_ENTER:"dragenter",DRAG_LEAVE:"dragleave",DRAG_OVER:"dragover",DROP:"drop",DRAG_END:"dragend",ANIMATION_START:browser.isWebKit?"webkitAnimationStart":"animationstart",ANIMATION_END:browser.isWebKit?"webkitAnimationEnd":"animationend",ANIMATION_ITERATION:browser.isWebKit?"webkitAnimationIteration":"animationiteration"};export const EventHelper={stop:(e,t)=>(e.preventDefault(),t&&e.stopPropagation(),e)};export function saveParentsScrollTop(e){const t=[];for(let i=0;e&&e.nodeType===e.ELEMENT_NODE;i++)t[i]=e.scrollTop,e=e.parentNode;return t}export function restoreParentsScrollTop(e,t){for(let i=0;e&&e.nodeType===e.ELEMENT_NODE;i++)e.scrollTop!==t[i]&&(e.scrollTop=t[i]),e=e.parentNode}class FocusTracker extends Disposable{static hasFocusWithin(e){const t=getShadowRoot(e);return isAncestor(t?t.activeElement:document.activeElement,e)}constructor(e){super(),this._onDidFocus=this._register(new event.Emitter),this.onDidFocus=this._onDidFocus.event,this._onDidBlur=this._register(new event.Emitter),this.onDidBlur=this._onDidBlur.event;let t=FocusTracker.hasFocusWithin(e),i=!1;const s=()=>{i=!1,t||(t=!0,this._onDidFocus.fire())},r=()=>{t&&(i=!0,window.setTimeout((()=>{i&&(i=!1,t=!1,this._onDidBlur.fire())}),0))};this._refreshStateHandler=()=>{FocusTracker.hasFocusWithin(e)!==t&&(t?r():s())},this._register(addDisposableListener(e,EventType.FOCUS,s,!0)),this._register(addDisposableListener(e,EventType.BLUR,r,!0)),this._register(addDisposableListener(e,EventType.FOCUS_IN,(()=>this._refreshStateHandler()))),this._register(addDisposableListener(e,EventType.FOCUS_OUT,(()=>this._refreshStateHandler())))}}export function trackFocus(e){return new FocusTracker(e)}export function append(e,...t){if(e.append(...t),1===t.length&&"string"!=typeof t[0])return t[0]}export function prepend(e,t){return e.insertBefore(t,e.firstChild),t}export function reset(e,...t){e.innerText="",append(e,...t)}const SELECTOR_REGEX=/([\w\-]+)?(#([\w\-]+))?((\.([\w\-]+))*)/;export var Namespace;function _$(e,t,i,...s){const r=SELECTOR_REGEX.exec(t);if(!r)throw new Error("Bad use of emmet");const n=r[1]||"div";let o;return o=e!==Namespace.HTML?document.createElementNS(e,n):document.createElement(n),r[3]&&(o.id=r[3]),r[4]&&(o.className=r[4].replace(/\./g," ").trim()),i&&Object.entries(i).forEach((([e,t])=>{void 0!==t&&(/^on\w+$/.test(e)?o[e]=t:"selected"===e?t&&o.setAttribute(e,"true"):o.setAttribute(e,t))})),o.append(...s),o}!function(e){e.HTML="http://www.w3.org/1999/xhtml",e.SVG="http://www.w3.org/2000/svg"}(Namespace||(Namespace={}));export function $(e,t,...i){return _$(Namespace.HTML,e,t,...i)}$.SVG=function(e,t,...i){return _$(Namespace.SVG,e,t,...i)};export function show(...e){for(const t of e)t.style.display="",t.removeAttribute("aria-hidden")}export function hide(...e){for(const t of e)t.style.display="none",t.setAttribute("aria-hidden","true")}export function computeScreenAwareSize(e){const t=window.devicePixelRatio*e;return Math.max(1,Math.floor(t))/window.devicePixelRatio}export function windowOpenNoOpener(e){window.open(e,"_blank","noopener")}export function animate(e){const t=()=>{e(),i=scheduleAtNextAnimationFrame(t)};let i=scheduleAtNextAnimationFrame(t);return toDisposable((()=>i.dispose()))}RemoteAuthorities.setPreferredWebSchema(/^https:/.test(window.location.href)?"https":"http");export function asCSSUrl(e){return e?`url('${FileAccess.uriToBrowserUri(e).toString(!0).replace(/'/g,"%27")}')`:"url('')"}export function asCSSPropertyValue(e){return`'${e.replace(/'/g,"%27")}'`}export function asCssValueWithDefault(e,t){if(void 0!==e){const i=e.match(/^\s*var\((.+)\)$/);if(i){const e=i[1].split(",",2);return 2===e.length&&(t=asCssValueWithDefault(e[1].trim(),t)),`var(${e[0]}, ${t})`}return e}return t}export function hookDomPurifyHrefAndSrcSanitizer(e,t=!1){const i=document.createElement("a");return dompurify.addHook("afterSanitizeAttributes",(s=>{for(const r of["href","src"])if(s.hasAttribute(r)){const n=s.getAttribute(r);if("href"===r&&n.startsWith("#"))continue;if(i.href=n,!e.includes(i.protocol.replace(/:$/,""))){if(t&&"src"===r&&i.href.startsWith("data:"))continue;s.removeAttribute(r)}}})),toDisposable((()=>{dompurify.removeHook("afterSanitizeAttributes")}))}export const basicMarkupHtmlTags=Object.freeze(["a","abbr","b","bdo","blockquote","br","caption","cite","code","col","colgroup","dd","del","details","dfn","div","dl","dt","em","figcaption","figure","h1","h2","h3","h4","h5","h6","hr","i","img","ins","kbd","label","li","mark","ol","p","pre","q","rp","rt","ruby","samp","small","small","source","span","strike","strong","sub","summary","sup","table","tbody","td","tfoot","th","thead","time","tr","tt","u","ul","var","video","wbr"]);const defaultDomPurifyConfig=Object.freeze({ALLOWED_TAGS:["a","button","blockquote","code","div","h1","h2","h3","h4","h5","h6","hr","input","label","li","p","pre","select","small","span","strong","textarea","ul","ol"],ALLOWED_ATTR:["href","data-href","data-command","target","title","name","src","alt","class","id","role","tabindex","style","data-code","width","height","align","x-dispatch","required","checked","placeholder","type"],RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1,RETURN_TRUSTED_TYPE:!0});export class ModifierKeyEmitter extends event.Emitter{constructor(){super(),this._subscriptions=new DisposableStore,this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1},this._subscriptions.add(addDisposableListener(window,"keydown",(e=>{if(e.defaultPrevented)return;const t=new StandardKeyboardEvent(e);if(6!==t.keyCode||!e.repeat){if(e.altKey&&!this._keyStatus.altKey)this._keyStatus.lastKeyPressed="alt";else if(e.ctrlKey&&!this._keyStatus.ctrlKey)this._keyStatus.lastKeyPressed="ctrl";else if(e.metaKey&&!this._keyStatus.metaKey)this._keyStatus.lastKeyPressed="meta";else if(e.shiftKey&&!this._keyStatus.shiftKey)this._keyStatus.lastKeyPressed="shift";else{if(6===t.keyCode)return;this._keyStatus.lastKeyPressed=void 0}this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyPressed&&(this._keyStatus.event=e,this.fire(this._keyStatus))}}),!0)),this._subscriptions.add(addDisposableListener(window,"keyup",(e=>{e.defaultPrevented||(!e.altKey&&this._keyStatus.altKey?this._keyStatus.lastKeyReleased="alt":!e.ctrlKey&&this._keyStatus.ctrlKey?this._keyStatus.lastKeyReleased="ctrl":!e.metaKey&&this._keyStatus.metaKey?this._keyStatus.lastKeyReleased="meta":!e.shiftKey&&this._keyStatus.shiftKey?this._keyStatus.lastKeyReleased="shift":this._keyStatus.lastKeyReleased=void 0,this._keyStatus.lastKeyPressed!==this._keyStatus.lastKeyReleased&&(this._keyStatus.lastKeyPressed=void 0),this._keyStatus.altKey=e.altKey,this._keyStatus.ctrlKey=e.ctrlKey,this._keyStatus.metaKey=e.metaKey,this._keyStatus.shiftKey=e.shiftKey,this._keyStatus.lastKeyReleased&&(this._keyStatus.event=e,this.fire(this._keyStatus)))}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousedown",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mouseup",(()=>{this._keyStatus.lastKeyPressed=void 0}),!0)),this._subscriptions.add(addDisposableListener(document.body,"mousemove",(e=>{e.buttons&&(this._keyStatus.lastKeyPressed=void 0)}),!0)),this._subscriptions.add(addDisposableListener(window,"blur",(()=>{this.resetKeyStatus()})))}get keyStatus(){return this._keyStatus}resetKeyStatus(){this.doResetKeyStatus(),this.fire(this._keyStatus)}doResetKeyStatus(){this._keyStatus={altKey:!1,shiftKey:!1,ctrlKey:!1,metaKey:!1}}static getInstance(){return ModifierKeyEmitter.instance||(ModifierKeyEmitter.instance=new ModifierKeyEmitter),ModifierKeyEmitter.instance}dispose(){super.dispose(),this._subscriptions.dispose()}}export class DragAndDropObserver extends Disposable{constructor(e,t){super(),this.element=e,this.callbacks=t,this.counter=0,this.dragStartTime=0,this.registerListeners()}registerListeners(){this._register(addDisposableListener(this.element,EventType.DRAG_ENTER,(e=>{this.counter++,this.dragStartTime=e.timeStamp,this.callbacks.onDragEnter(e)}))),this._register(addDisposableListener(this.element,EventType.DRAG_OVER,(e=>{var t,i;e.preventDefault(),null===(i=(t=this.callbacks).onDragOver)||void 0===i||i.call(t,e,e.timeStamp-this.dragStartTime)}))),this._register(addDisposableListener(this.element,EventType.DRAG_LEAVE,(e=>{this.counter--,0===this.counter&&(this.dragStartTime=0,this.callbacks.onDragLeave(e))}))),this._register(addDisposableListener(this.element,EventType.DRAG_END,(e=>{this.counter=0,this.dragStartTime=0,this.callbacks.onDragEnd(e)}))),this._register(addDisposableListener(this.element,EventType.DROP,(e=>{this.counter=0,this.dragStartTime=0,this.callbacks.onDrop(e)})))}}const H_REGEX=/(?<tag>[\w\-]+)?(?:#(?<id>[\w\-]+))?(?<class>(?:\.(?:[\w\-]+))*)(?:@(?<name>(?:[\w\_])+))?/;export function h(e,...t){let i,s;Array.isArray(t[0])?(i={},s=t[0]):(i=t[0]||{},s=t[1]);const r=H_REGEX.exec(e);if(!r||!r.groups)throw new Error("Bad use of h");const n=r.groups.tag||"div",o=document.createElement(n);r.groups.id&&(o.id=r.groups.id);const a=[];if(r.groups.class)for(const e of r.groups.class.split("."))""!==e&&a.push(e);if(void 0!==i.className)for(const e of i.className.split("."))""!==e&&a.push(e);a.length>0&&(o.className=a.join(" "));const d={};if(r.groups.name&&(d[r.groups.name]=o),s)for(const e of s)e instanceof HTMLElement?o.appendChild(e):"string"==typeof e?o.append(e):(Object.assign(d,e),o.appendChild(e.root));for(const[e,t]of Object.entries(i))if("className"!==e)if("style"===e)for(const[e,i]of Object.entries(t))o.style.setProperty(camelCaseToHyphenCase(e),"number"==typeof i?i+"px":""+i);else"tabIndex"===e?o.tabIndex=t:o.setAttribute(camelCaseToHyphenCase(e),t.toString());return d.root=o,d}function camelCaseToHyphenCase(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}