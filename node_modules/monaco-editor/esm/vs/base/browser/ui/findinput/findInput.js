import*as dom from"../../dom.js";import{CaseSensitiveToggle,RegexToggle,WholeWordsToggle}from"./findInputToggles.js";import{HistoryInputBox}from"../inputbox/inputBox.js";import{Widget}from"../widget.js";import{Emitter}from"../../../common/event.js";import"./findInput.css";import*as nls from"../../../../nls.js";import{DisposableStore}from"../../../common/lifecycle.js";const NLS_DEFAULT_LABEL=nls.localize("defaultLabel","input");export class FindInput extends Widget{constructor(i,e,s){super(),this.fixFocusOnOptionClickEnabled=!0,this.imeSessionInProgress=!1,this.additionalTogglesDisposables=new DisposableStore,this.additionalToggles=[],this._onDidOptionChange=this._register(new Emitter),this.onDidOptionChange=this._onDidOptionChange.event,this._onKeyDown=this._register(new Emitter),this.onKeyDown=this._onKeyDown.event,this._onMouseDown=this._register(new Emitter),this.onMouseDown=this._onMouseDown.event,this._onInput=this._register(new Emitter),this._onKeyUp=this._register(new Emitter),this._onCaseSensitiveKeyDown=this._register(new Emitter),this.onCaseSensitiveKeyDown=this._onCaseSensitiveKeyDown.event,this._onRegexKeyDown=this._register(new Emitter),this.onRegexKeyDown=this._onRegexKeyDown.event,this._lastHighlightFindOptions=0,this.placeholder=s.placeholder||"",this.validation=s.validation,this.label=s.label||NLS_DEFAULT_LABEL,this.showCommonFindToggles=!!s.showCommonFindToggles;const t=s.appendCaseSensitiveLabel||"",o=s.appendWholeWordsLabel||"",n=s.appendRegexLabel||"",l=s.history||[],h=!!s.flexibleHeight,d=!!s.flexibleWidth,a=s.flexibleMaxHeight;if(this.domNode=document.createElement("div"),this.domNode.classList.add("monaco-findInput"),this.inputBox=this._register(new HistoryInputBox(this.domNode,e,{placeholder:this.placeholder||"",ariaLabel:this.label||"",validationOptions:{validation:this.validation},history:l,showHistoryHint:s.showHistoryHint,flexibleHeight:h,flexibleWidth:d,flexibleMaxHeight:a,inputBoxStyles:s.inputBoxStyles})),this.showCommonFindToggles){this.regex=this._register(new RegexToggle(Object.assign({appendTitle:n,isChecked:!1},s.toggleStyles))),this._register(this.regex.onChange((i=>{this._onDidOptionChange.fire(i),!i&&this.fixFocusOnOptionClickEnabled&&this.inputBox.focus(),this.validate()}))),this._register(this.regex.onKeyDown((i=>{this._onRegexKeyDown.fire(i)}))),this.wholeWords=this._register(new WholeWordsToggle(Object.assign({appendTitle:o,isChecked:!1},s.toggleStyles))),this._register(this.wholeWords.onChange((i=>{this._onDidOptionChange.fire(i),!i&&this.fixFocusOnOptionClickEnabled&&this.inputBox.focus(),this.validate()}))),this.caseSensitive=this._register(new CaseSensitiveToggle(Object.assign({appendTitle:t,isChecked:!1},s.toggleStyles))),this._register(this.caseSensitive.onChange((i=>{this._onDidOptionChange.fire(i),!i&&this.fixFocusOnOptionClickEnabled&&this.inputBox.focus(),this.validate()}))),this._register(this.caseSensitive.onKeyDown((i=>{this._onCaseSensitiveKeyDown.fire(i)})));const i=[this.caseSensitive.domNode,this.wholeWords.domNode,this.regex.domNode];this.onkeydown(this.domNode,(e=>{if(e.equals(15)||e.equals(17)||e.equals(9)){const s=i.indexOf(document.activeElement);if(s>=0){let t=-1;e.equals(17)?t=(s+1)%i.length:e.equals(15)&&(t=0===s?i.length-1:s-1),e.equals(9)?(i[s].blur(),this.inputBox.focus()):t>=0&&i[t].focus(),dom.EventHelper.stop(e,!0)}}}))}this.controls=document.createElement("div"),this.controls.className="controls",this.controls.style.display=this.showCommonFindToggles?"block":"none",this.caseSensitive&&this.controls.append(this.caseSensitive.domNode),this.wholeWords&&this.controls.appendChild(this.wholeWords.domNode),this.regex&&this.controls.appendChild(this.regex.domNode),this.setAdditionalToggles(null==s?void 0:s.additionalToggles),this.controls&&this.domNode.appendChild(this.controls),null==i||i.appendChild(this.domNode),this._register(dom.addDisposableListener(this.inputBox.inputElement,"compositionstart",(i=>{this.imeSessionInProgress=!0}))),this._register(dom.addDisposableListener(this.inputBox.inputElement,"compositionend",(i=>{this.imeSessionInProgress=!1,this._onInput.fire()}))),this.onkeydown(this.inputBox.inputElement,(i=>this._onKeyDown.fire(i))),this.onkeyup(this.inputBox.inputElement,(i=>this._onKeyUp.fire(i))),this.oninput(this.inputBox.inputElement,(i=>this._onInput.fire())),this.onmousedown(this.inputBox.inputElement,(i=>this._onMouseDown.fire(i)))}get onDidChange(){return this.inputBox.onDidChange}enable(){var i,e,s;this.domNode.classList.remove("disabled"),this.inputBox.enable(),null===(i=this.regex)||void 0===i||i.enable(),null===(e=this.wholeWords)||void 0===e||e.enable(),null===(s=this.caseSensitive)||void 0===s||s.enable();for(const i of this.additionalToggles)i.enable()}disable(){var i,e,s;this.domNode.classList.add("disabled"),this.inputBox.disable(),null===(i=this.regex)||void 0===i||i.disable(),null===(e=this.wholeWords)||void 0===e||e.disable(),null===(s=this.caseSensitive)||void 0===s||s.disable();for(const i of this.additionalToggles)i.disable()}setFocusInputOnOptionClick(i){this.fixFocusOnOptionClickEnabled=i}setEnabled(i){i?this.enable():this.disable()}setAdditionalToggles(i){var e,s,t,o,n,l;for(const i of this.additionalToggles)i.domNode.remove();this.additionalToggles=[],this.additionalTogglesDisposables.dispose(),this.additionalTogglesDisposables=new DisposableStore;for(const e of null!=i?i:[])this.additionalTogglesDisposables.add(e),this.controls.appendChild(e.domNode),this.additionalTogglesDisposables.add(e.onChange((i=>{this._onDidOptionChange.fire(i),!i&&this.fixFocusOnOptionClickEnabled&&this.inputBox.focus()}))),this.additionalToggles.push(e);this.additionalToggles.length>0&&(this.controls.style.display="block"),this.inputBox.paddingRight=(null!==(s=null===(e=this.caseSensitive)||void 0===e?void 0:e.width())&&void 0!==s?s:0)+(null!==(o=null===(t=this.wholeWords)||void 0===t?void 0:t.width())&&void 0!==o?o:0)+(null!==(l=null===(n=this.regex)||void 0===n?void 0:n.width())&&void 0!==l?l:0)+this.additionalToggles.reduce(((i,e)=>i+e.width()),0)}getValue(){return this.inputBox.value}setValue(i){this.inputBox.value!==i&&(this.inputBox.value=i)}select(){this.inputBox.select()}focus(){this.inputBox.focus()}getCaseSensitive(){var i,e;return null!==(e=null===(i=this.caseSensitive)||void 0===i?void 0:i.checked)&&void 0!==e&&e}setCaseSensitive(i){this.caseSensitive&&(this.caseSensitive.checked=i)}getWholeWords(){var i,e;return null!==(e=null===(i=this.wholeWords)||void 0===i?void 0:i.checked)&&void 0!==e&&e}setWholeWords(i){this.wholeWords&&(this.wholeWords.checked=i)}getRegex(){var i,e;return null!==(e=null===(i=this.regex)||void 0===i?void 0:i.checked)&&void 0!==e&&e}setRegex(i){this.regex&&(this.regex.checked=i,this.validate())}focusOnCaseSensitive(){var i;null===(i=this.caseSensitive)||void 0===i||i.focus()}highlightFindOptions(){this.domNode.classList.remove("highlight-"+this._lastHighlightFindOptions),this._lastHighlightFindOptions=1-this._lastHighlightFindOptions,this.domNode.classList.add("highlight-"+this._lastHighlightFindOptions)}validate(){this.inputBox.validate()}showMessage(i){this.inputBox.showMessage(i)}clearMessage(){this.inputBox.hideMessage()}}