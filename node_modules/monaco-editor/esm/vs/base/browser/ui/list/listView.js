var __decorate=this&&this.__decorate||function(e,t,s,i){var o,r=arguments.length,n=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,s,i);else for(var l=e.length-1;l>=0;l--)(o=e[l])&&(n=(r<3?o(n):r>3?o(t,s,n):o(t,s))||n);return r>3&&n&&Object.defineProperty(t,s,n),n};import{DataTransfers}from"../../dnd.js";import{$,addDisposableListener,animate,getContentHeight,getContentWidth,getTopLeftOffset,scheduleAtNextAnimationFrame}from"../../dom.js";import{DomEmitter}from"../../event.js";import{EventType as TouchEventType,Gesture}from"../../touch.js";import{SmoothScrollableElement}from"../scrollbar/scrollableElement.js";import{distinct,equals}from"../../../common/arrays.js";import{Delayer,disposableTimeout}from"../../../common/async.js";import{memoize}from"../../../common/decorators.js";import{Emitter,Event}from"../../../common/event.js";import{Disposable,DisposableStore,dispose,toDisposable}from"../../../common/lifecycle.js";import{Range}from"../../../common/range.js";import{Scrollable}from"../../../common/scrollable.js";import{RangeMap,shift}from"./rangeMap.js";import{RowCache}from"./rowCache.js";import{BugIndicatingError}from"../../../common/errors.js";const StaticDND={CurrentDragAndDropData:void 0},DefaultOptions={useShadows:!0,verticalScrollMode:1,setRowLineHeight:!0,setRowHeight:!0,supportDynamicHeights:!1,dnd:{getDragElements:e=>[e],getDragURI:()=>null,onDragStart(){},onDragOver:()=>!1,drop(){}},horizontalScrolling:!1,transformOptimization:!0,alwaysConsumeMouseWheel:!0};export class ElementsDragAndDropData{constructor(e){this.elements=e}update(){}getData(){return this.elements}}export class ExternalElementsDragAndDropData{constructor(e){this.elements=e}update(){}getData(){return this.elements}}export class NativeDragAndDropData{constructor(){this.types=[],this.files=[]}update(e){if(e.types&&this.types.splice(0,this.types.length,...e.types),e.files){this.files.splice(0,this.files.length);for(let t=0;t<e.files.length;t++){const s=e.files.item(t);s&&(s.size||s.type)&&this.files.push(s)}}}getData(){return{types:this.types,files:this.files}}}function equalsDragFeedback(e,t){return Array.isArray(e)&&Array.isArray(t)?equals(e,t):e===t}class ListViewAccessibilityProvider{constructor(e){(null==e?void 0:e.getSetSize)?this.getSetSize=e.getSetSize.bind(e):this.getSetSize=(e,t,s)=>s,(null==e?void 0:e.getPosInSet)?this.getPosInSet=e.getPosInSet.bind(e):this.getPosInSet=(e,t)=>t+1,(null==e?void 0:e.getRole)?this.getRole=e.getRole.bind(e):this.getRole=e=>"listitem",(null==e?void 0:e.isChecked)?this.isChecked=e.isChecked.bind(e):this.isChecked=e=>{}}}class ListView{get contentHeight(){return this.rangeMap.size}get horizontalScrolling(){return this._horizontalScrolling}set horizontalScrolling(e){if(e!==this._horizontalScrolling){if(e&&this.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");if(this._horizontalScrolling=e,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this._horizontalScrolling){for(const e of this.items)this.measureItemWidth(e);this.updateScrollWidth(),this.scrollableElement.setScrollDimensions({width:getContentWidth(this.domNode)}),this.rowsContainer.style.width=`${Math.max(this.scrollWidth||0,this.renderWidth)}px`}else this.scrollableElementWidthDelayer.cancel(),this.scrollableElement.setScrollDimensions({width:this.renderWidth,scrollWidth:this.renderWidth}),this.rowsContainer.style.width=""}}constructor(e,t,s,i=DefaultOptions){var o,r,n,l,a,d,h,c,m,p,g,u;if(this.virtualDelegate=t,this.domId="list_id_"+ ++ListView.InstanceCount,this.renderers=new Map,this.renderWidth=0,this._scrollHeight=0,this.scrollableElementUpdateDisposable=null,this.scrollableElementWidthDelayer=new Delayer(50),this.splicing=!1,this.dragOverAnimationStopDisposable=Disposable.None,this.dragOverMouseY=0,this.canDrop=!1,this.currentDragFeedbackDisposable=Disposable.None,this.onDragLeaveTimeout=Disposable.None,this.disposables=new DisposableStore,this._onDidChangeContentHeight=new Emitter,this._horizontalScrolling=!1,i.horizontalScrolling&&i.supportDynamicHeights)throw new Error("Horizontal scrolling and dynamic heights not supported simultaneously");this.items=[],this.itemId=0,this.rangeMap=new RangeMap;for(const e of s)this.renderers.set(e.templateId,e);this.cache=this.disposables.add(new RowCache(this.renderers)),this.lastRenderTop=0,this.lastRenderHeight=0,this.domNode=document.createElement("div"),this.domNode.className="monaco-list",this.domNode.classList.add(this.domId),this.domNode.tabIndex=0,this.domNode.classList.toggle("mouse-support","boolean"!=typeof i.mouseSupport||i.mouseSupport),this._horizontalScrolling=null!==(o=i.horizontalScrolling)&&void 0!==o?o:DefaultOptions.horizontalScrolling,this.domNode.classList.toggle("horizontal-scrolling",this._horizontalScrolling),this.additionalScrollHeight=void 0===i.additionalScrollHeight?0:i.additionalScrollHeight,this.accessibilityProvider=new ListViewAccessibilityProvider(i.accessibilityProvider),this.rowsContainer=document.createElement("div"),this.rowsContainer.className="monaco-list-rows",(null!==(r=i.transformOptimization)&&void 0!==r?r:DefaultOptions.transformOptimization)&&(this.rowsContainer.style.transform="translate3d(0px, 0px, 0px)",this.rowsContainer.style.overflow="hidden",this.rowsContainer.style.contain="strict"),this.disposables.add(Gesture.addTarget(this.rowsContainer)),this.scrollable=new Scrollable({forceIntegerValues:!0,smoothScrollDuration:null!==(n=i.smoothScrolling)&&void 0!==n&&n?125:0,scheduleAtNextAnimationFrame:e=>scheduleAtNextAnimationFrame(e)}),this.scrollableElement=this.disposables.add(new SmoothScrollableElement(this.rowsContainer,{alwaysConsumeMouseWheel:null!==(l=i.alwaysConsumeMouseWheel)&&void 0!==l?l:DefaultOptions.alwaysConsumeMouseWheel,horizontal:1,vertical:null!==(a=i.verticalScrollMode)&&void 0!==a?a:DefaultOptions.verticalScrollMode,useShadows:null!==(d=i.useShadows)&&void 0!==d?d:DefaultOptions.useShadows,mouseWheelScrollSensitivity:i.mouseWheelScrollSensitivity,fastScrollSensitivity:i.fastScrollSensitivity,scrollByPage:i.scrollByPage},this.scrollable)),this.domNode.appendChild(this.scrollableElement.getDomNode()),e.appendChild(this.domNode),this.scrollableElement.onScroll(this.onScroll,this,this.disposables),this.disposables.add(addDisposableListener(this.rowsContainer,TouchEventType.Change,(e=>this.onTouchChange(e)))),this.disposables.add(addDisposableListener(this.scrollableElement.getDomNode(),"scroll",(e=>e.target.scrollTop=0))),this.disposables.add(addDisposableListener(this.domNode,"dragover",(e=>this.onDragOver(this.toDragEvent(e))))),this.disposables.add(addDisposableListener(this.domNode,"drop",(e=>this.onDrop(this.toDragEvent(e))))),this.disposables.add(addDisposableListener(this.domNode,"dragleave",(e=>this.onDragLeave(this.toDragEvent(e))))),this.disposables.add(addDisposableListener(this.domNode,"dragend",(e=>this.onDragEnd(e)))),this.setRowLineHeight=null!==(h=i.setRowLineHeight)&&void 0!==h?h:DefaultOptions.setRowLineHeight,this.setRowHeight=null!==(c=i.setRowHeight)&&void 0!==c?c:DefaultOptions.setRowHeight,this.supportDynamicHeights=null!==(m=i.supportDynamicHeights)&&void 0!==m?m:DefaultOptions.supportDynamicHeights,this.dnd=null!==(p=i.dnd)&&void 0!==p?p:DefaultOptions.dnd,this.layout(null===(g=i.initialSize)||void 0===g?void 0:g.height,null===(u=i.initialSize)||void 0===u?void 0:u.width)}updateOptions(e){let t;void 0!==e.additionalScrollHeight&&(this.additionalScrollHeight=e.additionalScrollHeight,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),void 0!==e.smoothScrolling&&this.scrollable.setSmoothScrollDuration(e.smoothScrolling?125:0),void 0!==e.horizontalScrolling&&(this.horizontalScrolling=e.horizontalScrolling),void 0!==e.scrollByPage&&(t=Object.assign(Object.assign({},null!=t?t:{}),{scrollByPage:e.scrollByPage})),void 0!==e.mouseWheelScrollSensitivity&&(t=Object.assign(Object.assign({},null!=t?t:{}),{mouseWheelScrollSensitivity:e.mouseWheelScrollSensitivity})),void 0!==e.fastScrollSensitivity&&(t=Object.assign(Object.assign({},null!=t?t:{}),{fastScrollSensitivity:e.fastScrollSensitivity})),t&&this.scrollableElement.updateOptions(t)}splice(e,t,s=[]){if(this.splicing)throw new Error("Can't run recursive splices.");this.splicing=!0;try{return this._splice(e,t,s)}finally{this.splicing=!1,this._onDidChangeContentHeight.fire(this.contentHeight)}}_splice(e,t,s=[]){const i=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),o={start:e,end:e+t},r=Range.intersect(i,o),n=new Map;for(let e=r.end-1;e>=r.start;e--){const t=this.items[e];if(t.dragStartDisposable.dispose(),t.checkedDisposable.dispose(),t.row){let s=n.get(t.templateId);s||(s=[],n.set(t.templateId,s));const i=this.renderers.get(t.templateId);i&&i.disposeElement&&i.disposeElement(t.element,e,t.row.templateData,t.size),s.push(t.row)}t.row=null}const l={start:e+t,end:this.items.length},a=Range.intersect(l,i),d=Range.relativeComplement(l,i),h=s.map((e=>({id:String(this.itemId++),element:e,templateId:this.virtualDelegate.getTemplateId(e),size:this.virtualDelegate.getHeight(e),width:void 0,hasDynamicHeight:!!this.virtualDelegate.hasDynamicHeight&&this.virtualDelegate.hasDynamicHeight(e),lastDynamicHeightWidth:void 0,row:null,uri:void 0,dropTarget:!1,dragStartDisposable:Disposable.None,checkedDisposable:Disposable.None})));let c;0===e&&t>=this.items.length?(this.rangeMap=new RangeMap,this.rangeMap.splice(0,0,h),c=this.items,this.items=h):(this.rangeMap.splice(e,t,h),c=this.items.splice(e,t,...h));const m=s.length-t,p=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),g=shift(a,m),u=Range.intersect(p,g);for(let e=u.start;e<u.end;e++)this.updateItemInDOM(this.items[e],e);const D=Range.relativeComplement(g,p);for(const e of D)for(let t=e.start;t<e.end;t++)this.removeItemFromDOM(t);const v=d.map((e=>shift(e,m))),b=[{start:e,end:e+s.length},...v].map((e=>Range.intersect(p,e))),f=this.getNextToLastElement(b);for(const e of b)for(let t=e.start;t<e.end;t++){const e=this.items[t],s=n.get(e.templateId),i=null==s?void 0:s.pop();this.insertItemInDOM(t,f,i)}for(const e of n.values())for(const t of e)this.cache.release(t);return this.eventuallyUpdateScrollDimensions(),this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight),c.map((e=>e.element))}eventuallyUpdateScrollDimensions(){this._scrollHeight=this.contentHeight,this.rowsContainer.style.height=`${this._scrollHeight}px`,this.scrollableElementUpdateDisposable||(this.scrollableElementUpdateDisposable=scheduleAtNextAnimationFrame((()=>{this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight}),this.updateScrollWidth(),this.scrollableElementUpdateDisposable=null})))}eventuallyUpdateScrollWidth(){this.horizontalScrolling?this.scrollableElementWidthDelayer.trigger((()=>this.updateScrollWidth())):this.scrollableElementWidthDelayer.cancel()}updateScrollWidth(){if(!this.horizontalScrolling)return;let e=0;for(const t of this.items)void 0!==t.width&&(e=Math.max(e,t.width));this.scrollWidth=e,this.scrollableElement.setScrollDimensions({scrollWidth:0===e?0:e+10})}rerender(){if(this.supportDynamicHeights){for(const e of this.items)e.lastDynamicHeightWidth=void 0;this._rerender(this.lastRenderTop,this.lastRenderHeight)}}get length(){return this.items.length}get renderHeight(){return this.scrollableElement.getScrollDimensions().height}get firstVisibleIndex(){const e=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),t=this.rangeMap.positionAt(e.start),s=this.rangeMap.positionAt(e.start+1);return-1!==s&&(s-t)/2+t<this.scrollTop?e.start+1:e.start}element(e){return this.items[e].element}domElement(e){const t=this.items[e].row;return t&&t.domNode}elementHeight(e){return this.items[e].size}elementTop(e){return this.rangeMap.positionAt(e)}indexAt(e){return this.rangeMap.indexAt(e)}indexAfter(e){return this.rangeMap.indexAfter(e)}layout(e,t){const s={height:"number"==typeof e?e:getContentHeight(this.domNode)};this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,s.scrollHeight=this.scrollHeight),this.scrollableElement.setScrollDimensions(s),void 0!==t&&(this.renderWidth=t,this.supportDynamicHeights&&this._rerender(this.scrollTop,this.renderHeight)),this.horizontalScrolling&&this.scrollableElement.setScrollDimensions({width:"number"==typeof t?t:getContentWidth(this.domNode)})}render(e,t,s,i,o,r=!1){const n=this.getRenderRange(t,s),l=Range.relativeComplement(n,e),a=Range.relativeComplement(e,n),d=this.getNextToLastElement(l);if(r){const t=Range.intersect(e,n);for(let e=t.start;e<t.end;e++)this.updateItemInDOM(this.items[e],e)}this.cache.transact((()=>{for(const e of a)for(let t=e.start;t<e.end;t++)this.removeItemFromDOM(t);for(const e of l)for(let t=e.start;t<e.end;t++)this.insertItemInDOM(t,d)})),void 0!==i&&(this.rowsContainer.style.left=`-${i}px`),this.rowsContainer.style.top=`-${t}px`,this.horizontalScrolling&&void 0!==o&&(this.rowsContainer.style.width=`${Math.max(o,this.renderWidth)}px`),this.lastRenderTop=t,this.lastRenderHeight=s}insertItemInDOM(e,t,s){const i=this.items[e];let o=!1;if(!i.row)if(s)i.row=s;else{const e=this.cache.alloc(i.templateId);i.row=e.row,o=e.isReusingConnectedDomNode}const r=this.accessibilityProvider.getRole(i.element)||"listitem";i.row.domNode.setAttribute("role",r);const n=this.accessibilityProvider.isChecked(i.element);if("boolean"==typeof n)i.row.domNode.setAttribute("aria-checked",String(!!n));else if(n){const e=e=>i.row.domNode.setAttribute("aria-checked",String(!!e));e(n.value),i.checkedDisposable=n.onDidChange(e)}!o&&i.row.domNode.parentElement||(t?this.rowsContainer.insertBefore(i.row.domNode,t):this.rowsContainer.appendChild(i.row.domNode)),this.updateItemInDOM(i,e);const l=this.renderers.get(i.templateId);if(!l)throw new Error(`No renderer found for template id ${i.templateId}`);null==l||l.renderElement(i.element,e,i.row.templateData,i.size);const a=this.dnd.getDragURI(i.element);i.dragStartDisposable.dispose(),i.row.domNode.draggable=!!a,a&&(i.dragStartDisposable=addDisposableListener(i.row.domNode,"dragstart",(e=>this.onDragStart(i.element,a,e)))),this.horizontalScrolling&&(this.measureItemWidth(i),this.eventuallyUpdateScrollWidth())}measureItemWidth(e){if(!e.row||!e.row.domNode)return;e.row.domNode.style.width="fit-content",e.width=getContentWidth(e.row.domNode);const t=window.getComputedStyle(e.row.domNode);t.paddingLeft&&(e.width+=parseFloat(t.paddingLeft)),t.paddingRight&&(e.width+=parseFloat(t.paddingRight)),e.row.domNode.style.width=""}updateItemInDOM(e,t){e.row.domNode.style.top=`${this.elementTop(t)}px`,this.setRowHeight&&(e.row.domNode.style.height=`${e.size}px`),this.setRowLineHeight&&(e.row.domNode.style.lineHeight=`${e.size}px`),e.row.domNode.setAttribute("data-index",`${t}`),e.row.domNode.setAttribute("data-last-element",t===this.length-1?"true":"false"),e.row.domNode.setAttribute("data-parity",t%2==0?"even":"odd"),e.row.domNode.setAttribute("aria-setsize",String(this.accessibilityProvider.getSetSize(e.element,t,this.length))),e.row.domNode.setAttribute("aria-posinset",String(this.accessibilityProvider.getPosInSet(e.element,t))),e.row.domNode.setAttribute("id",this.getElementDomId(t)),e.row.domNode.classList.toggle("drop-target",e.dropTarget)}removeItemFromDOM(e){const t=this.items[e];if(t.dragStartDisposable.dispose(),t.checkedDisposable.dispose(),t.row){const s=this.renderers.get(t.templateId);s&&s.disposeElement&&s.disposeElement(t.element,e,t.row.templateData,t.size),this.cache.release(t.row),t.row=null}this.horizontalScrolling&&this.eventuallyUpdateScrollWidth()}getScrollTop(){return this.scrollableElement.getScrollPosition().scrollTop}setScrollTop(e,t){this.scrollableElementUpdateDisposable&&(this.scrollableElementUpdateDisposable.dispose(),this.scrollableElementUpdateDisposable=null,this.scrollableElement.setScrollDimensions({scrollHeight:this.scrollHeight})),this.scrollableElement.setScrollPosition({scrollTop:e,reuseAnimation:t})}get scrollTop(){return this.getScrollTop()}set scrollTop(e){this.setScrollTop(e)}get scrollHeight(){return this._scrollHeight+(this.horizontalScrolling?10:0)+this.additionalScrollHeight}get onMouseClick(){return Event.map(this.disposables.add(new DomEmitter(this.domNode,"click")).event,(e=>this.toMouseEvent(e)),this.disposables)}get onMouseDblClick(){return Event.map(this.disposables.add(new DomEmitter(this.domNode,"dblclick")).event,(e=>this.toMouseEvent(e)),this.disposables)}get onMouseMiddleClick(){return Event.filter(Event.map(this.disposables.add(new DomEmitter(this.domNode,"auxclick")).event,(e=>this.toMouseEvent(e)),this.disposables),(e=>1===e.browserEvent.button),this.disposables)}get onMouseDown(){return Event.map(this.disposables.add(new DomEmitter(this.domNode,"mousedown")).event,(e=>this.toMouseEvent(e)),this.disposables)}get onMouseOver(){return Event.map(this.disposables.add(new DomEmitter(this.domNode,"mouseover")).event,(e=>this.toMouseEvent(e)),this.disposables)}get onContextMenu(){return Event.any(Event.map(this.disposables.add(new DomEmitter(this.domNode,"contextmenu")).event,(e=>this.toMouseEvent(e)),this.disposables),Event.map(this.disposables.add(new DomEmitter(this.domNode,TouchEventType.Contextmenu)).event,(e=>this.toGestureEvent(e)),this.disposables))}get onTouchStart(){return Event.map(this.disposables.add(new DomEmitter(this.domNode,"touchstart")).event,(e=>this.toTouchEvent(e)),this.disposables)}get onTap(){return Event.map(this.disposables.add(new DomEmitter(this.rowsContainer,TouchEventType.Tap)).event,(e=>this.toGestureEvent(e)),this.disposables)}toMouseEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),s=void 0===t?void 0:this.items[t];return{browserEvent:e,index:t,element:s&&s.element}}toTouchEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),s=void 0===t?void 0:this.items[t];return{browserEvent:e,index:t,element:s&&s.element}}toGestureEvent(e){const t=this.getItemIndexFromEventTarget(e.initialTarget||null),s=void 0===t?void 0:this.items[t];return{browserEvent:e,index:t,element:s&&s.element}}toDragEvent(e){const t=this.getItemIndexFromEventTarget(e.target||null),s=void 0===t?void 0:this.items[t];return{browserEvent:e,index:t,element:s&&s.element}}onScroll(e){try{const t=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);this.render(t,e.scrollTop,e.height,e.scrollLeft,e.scrollWidth),this.supportDynamicHeights&&this._rerender(e.scrollTop,e.height,e.inSmoothScrolling)}catch(t){throw console.error("Got bad scroll event:",e),t}}onTouchChange(e){e.preventDefault(),e.stopPropagation(),this.scrollTop-=e.translationY}onDragStart(e,t,s){var i,o;if(!s.dataTransfer)return;const r=this.dnd.getDragElements(e);if(s.dataTransfer.effectAllowed="copyMove",s.dataTransfer.setData(DataTransfers.TEXT,t),s.dataTransfer.setDragImage){let e;this.dnd.getDragLabel&&(e=this.dnd.getDragLabel(r,s)),void 0===e&&(e=String(r.length));const t=$(".monaco-drag-image");t.textContent=e;const i=(e=>{for(;e&&!e.classList.contains("monaco-workbench");)e=e.parentElement;return e||document.body})(this.domNode);i.appendChild(t),s.dataTransfer.setDragImage(t,-10,-10),setTimeout((()=>i.removeChild(t)),0)}this.domNode.classList.add("dragging"),this.currentDragData=new ElementsDragAndDropData(r),StaticDND.CurrentDragAndDropData=new ExternalElementsDragAndDropData(r),null===(o=(i=this.dnd).onDragStart)||void 0===o||o.call(i,this.currentDragData,s)}onDragOver(e){var t;if(e.browserEvent.preventDefault(),this.onDragLeaveTimeout.dispose(),StaticDND.CurrentDragAndDropData&&"vscode-ui"===StaticDND.CurrentDragAndDropData.getData())return!1;if(this.setupDragAndDropScrollTopAnimation(e.browserEvent),!e.browserEvent.dataTransfer)return!1;if(!this.currentDragData)if(StaticDND.CurrentDragAndDropData)this.currentDragData=StaticDND.CurrentDragAndDropData;else{if(!e.browserEvent.dataTransfer.types)return!1;this.currentDragData=new NativeDragAndDropData}const s=this.dnd.onDragOver(this.currentDragData,e.element,e.index,e.browserEvent);if(this.canDrop="boolean"==typeof s?s:s.accept,!this.canDrop)return this.currentDragFeedback=void 0,this.currentDragFeedbackDisposable.dispose(),!1;let i;if(e.browserEvent.dataTransfer.dropEffect="boolean"!=typeof s&&0===s.effect?"copy":"move",i="boolean"!=typeof s&&s.feedback?s.feedback:void 0===e.index?[-1]:[e.index],i=distinct(i).filter((e=>e>=-1&&e<this.length)).sort(((e,t)=>e-t)),i=-1===i[0]?[-1]:i,equalsDragFeedback(this.currentDragFeedback,i))return!0;if(this.currentDragFeedback=i,this.currentDragFeedbackDisposable.dispose(),-1===i[0])this.domNode.classList.add("drop-target"),this.rowsContainer.classList.add("drop-target"),this.currentDragFeedbackDisposable=toDisposable((()=>{this.domNode.classList.remove("drop-target"),this.rowsContainer.classList.remove("drop-target")}));else{for(const e of i){const s=this.items[e];s.dropTarget=!0,null===(t=s.row)||void 0===t||t.domNode.classList.add("drop-target")}this.currentDragFeedbackDisposable=toDisposable((()=>{var e;for(const t of i){const s=this.items[t];s.dropTarget=!1,null===(e=s.row)||void 0===e||e.domNode.classList.remove("drop-target")}}))}return!0}onDragLeave(e){var t,s;this.onDragLeaveTimeout.dispose(),this.onDragLeaveTimeout=disposableTimeout((()=>this.clearDragOverFeedback()),100),this.currentDragData&&(null===(s=(t=this.dnd).onDragLeave)||void 0===s||s.call(t,this.currentDragData,e.element,e.index,e.browserEvent))}onDrop(e){if(!this.canDrop)return;const t=this.currentDragData;this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,StaticDND.CurrentDragAndDropData=void 0,t&&e.browserEvent.dataTransfer&&(e.browserEvent.preventDefault(),t.update(e.browserEvent.dataTransfer),this.dnd.drop(t,e.element,e.index,e.browserEvent))}onDragEnd(e){var t,s;this.canDrop=!1,this.teardownDragAndDropScrollTopAnimation(),this.clearDragOverFeedback(),this.domNode.classList.remove("dragging"),this.currentDragData=void 0,StaticDND.CurrentDragAndDropData=void 0,null===(s=(t=this.dnd).onDragEnd)||void 0===s||s.call(t,e)}clearDragOverFeedback(){this.currentDragFeedback=void 0,this.currentDragFeedbackDisposable.dispose(),this.currentDragFeedbackDisposable=Disposable.None}setupDragAndDropScrollTopAnimation(e){if(!this.dragOverAnimationDisposable){const e=getTopLeftOffset(this.domNode).top;this.dragOverAnimationDisposable=animate(this.animateDragAndDropScrollTop.bind(this,e))}this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationStopDisposable=disposableTimeout((()=>{this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)}),1e3),this.dragOverMouseY=e.pageY}animateDragAndDropScrollTop(e){if(void 0===this.dragOverMouseY)return;const t=this.dragOverMouseY-e,s=this.renderHeight-35;t<35?this.scrollTop+=Math.max(-14,Math.floor(.3*(t-35))):t>s&&(this.scrollTop+=Math.min(14,Math.floor(.3*(t-s))))}teardownDragAndDropScrollTopAnimation(){this.dragOverAnimationStopDisposable.dispose(),this.dragOverAnimationDisposable&&(this.dragOverAnimationDisposable.dispose(),this.dragOverAnimationDisposable=void 0)}getItemIndexFromEventTarget(e){const t=this.scrollableElement.getDomNode();let s=e;for(;s instanceof HTMLElement&&s!==this.rowsContainer&&t.contains(s);){const e=s.getAttribute("data-index");if(e){const t=Number(e);if(!isNaN(t))return t}s=s.parentElement}}getRenderRange(e,t){return{start:this.rangeMap.indexAt(e),end:this.rangeMap.indexAfter(e+t-1)}}_rerender(e,t,s){const i=this.getRenderRange(e,t);let o,r;e===this.elementTop(i.start)?(o=i.start,r=0):i.end-i.start>1&&(o=i.start+1,r=this.elementTop(o)-e);let n=0;for(;;){const l=this.getRenderRange(e,t);let a=!1;for(let e=l.start;e<l.end;e++){const t=this.probeDynamicHeight(e);0!==t&&this.rangeMap.splice(e,1,[this.items[e]]),n+=t,a=a||0!==t}if(!a){0!==n&&this.eventuallyUpdateScrollDimensions();const t=Range.relativeComplement(i,l);for(const e of t)for(let t=e.start;t<e.end;t++)this.items[t].row&&this.removeItemFromDOM(t);const a=Range.relativeComplement(l,i);for(const e of a)for(let t=e.start;t<e.end;t++){const e=t+1,s=e<this.items.length?this.items[e].row:null,i=s?s.domNode:null;this.insertItemInDOM(t,i)}for(let e=l.start;e<l.end;e++)this.items[e].row&&this.updateItemInDOM(this.items[e],e);if("number"==typeof o){const t=this.scrollable.getFutureScrollPosition().scrollTop-e,i=this.elementTop(o)-r+t;this.setScrollTop(i,s)}return void this._onDidChangeContentHeight.fire(this.contentHeight)}}}probeDynamicHeight(e){var t,s,i;const o=this.items[e];if(this.virtualDelegate.getDynamicHeight){const e=this.virtualDelegate.getDynamicHeight(o.element);if(null!==e){const t=o.size;return o.size=e,o.lastDynamicHeightWidth=this.renderWidth,e-t}}if(!o.hasDynamicHeight||o.lastDynamicHeightWidth===this.renderWidth)return 0;if(this.virtualDelegate.hasDynamicHeight&&!this.virtualDelegate.hasDynamicHeight(o.element))return 0;const r=o.size;if(o.row)return o.row.domNode.style.height="",o.size=o.row.domNode.offsetHeight,o.lastDynamicHeightWidth=this.renderWidth,o.size-r;const{row:n}=this.cache.alloc(o.templateId);n.domNode.style.height="",this.rowsContainer.appendChild(n.domNode);const l=this.renderers.get(o.templateId);if(!l)throw new BugIndicatingError("Missing renderer for templateId: "+o.templateId);return l.renderElement(o.element,e,n.templateData,void 0),o.size=n.domNode.offsetHeight,null===(t=l.disposeElement)||void 0===t||t.call(l,o.element,e,n.templateData,void 0),null===(i=(s=this.virtualDelegate).setDynamicHeight)||void 0===i||i.call(s,o.element,o.size),o.lastDynamicHeightWidth=this.renderWidth,this.rowsContainer.removeChild(n.domNode),this.cache.release(n),o.size-r}getNextToLastElement(e){const t=e[e.length-1];if(!t)return null;const s=this.items[t.end];return s&&s.row?s.row.domNode:null}getElementDomId(e){return`${this.domId}_${e}`}dispose(){var e;if(this.items){for(const t of this.items)if(t.row){const s=this.renderers.get(t.row.templateId);s&&(null===(e=s.disposeElement)||void 0===e||e.call(s,t.element,-1,t.row.templateData,void 0),s.disposeTemplate(t.row.templateData))}this.items=[]}this.domNode&&this.domNode.parentNode&&this.domNode.parentNode.removeChild(this.domNode),dispose(this.disposables)}}ListView.InstanceCount=0,__decorate([memoize],ListView.prototype,"onMouseClick",null),__decorate([memoize],ListView.prototype,"onMouseDblClick",null),__decorate([memoize],ListView.prototype,"onMouseMiddleClick",null),__decorate([memoize],ListView.prototype,"onMouseDown",null),__decorate([memoize],ListView.prototype,"onMouseOver",null),__decorate([memoize],ListView.prototype,"onContextMenu",null),__decorate([memoize],ListView.prototype,"onTouchStart",null),__decorate([memoize],ListView.prototype,"onTap",null);export{ListView};