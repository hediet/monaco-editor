var __awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(n,o){function r(e){try{l(s.next(e))}catch(e){o(e)}}function d(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,d)}l((s=s.apply(e,t||[])).next())}))};import{$,append,clearNode,createStyleSheet,h,hasParentWithClass}from"../../dom.js";import{DomEmitter}from"../../event.js";import{StandardKeyboardEvent}from"../../keyboardEvent.js";import{ActionBar}from"../actionbar/actionbar.js";import{FindInput}from"../findinput/findInput.js";import{unthemedInboxStyles}from"../inputbox/inputBox.js";import{ElementsDragAndDropData}from"../list/listView.js";import{isButton,isInputElement,isMonacoEditor,List,MouseController}from"../list/listWidget.js";import{Toggle,unthemedToggleStyles}from"../toggle/toggle.js";import{getVisibleState,isFilterResult}from"./indexTreeModel.js";import{TreeMouseEventTarget}from"./tree.js";import{Action}from"../../../common/actions.js";import{distinct,equals,range}from"../../../common/arrays.js";import{disposableTimeout,timeout}from"../../../common/async.js";import{Codicon}from"../../../common/codicons.js";import{ThemeIcon}from"../../../common/themables.js";import{SetMap}from"../../../common/collections.js";import{Emitter,Event,EventBufferer,Relay}from"../../../common/event.js";import{fuzzyScore,FuzzyScore}from"../../../common/filters.js";import{Disposable,DisposableStore,dispose,toDisposable}from"../../../common/lifecycle.js";import{clamp}from"../../../common/numbers.js";import{isNumber}from"../../../common/types.js";import"./media/tree.css";import{localize}from"../../../../nls.js";class TreeElementsDragAndDropData extends ElementsDragAndDropData{constructor(e){super(e.elements.map((e=>e.element))),this.data=e}}function asTreeDragAndDropData(e){return e instanceof ElementsDragAndDropData?new TreeElementsDragAndDropData(e):e}class TreeNodeListDragAndDrop{constructor(e,t){this.modelProvider=e,this.dnd=t,this.autoExpandDisposable=Disposable.None}getDragURI(e){return this.dnd.getDragURI(e.element)}getDragLabel(e,t){if(this.dnd.getDragLabel)return this.dnd.getDragLabel(e.map((e=>e.element)),t)}onDragStart(e,t){var i,s;null===(s=(i=this.dnd).onDragStart)||void 0===s||s.call(i,asTreeDragAndDropData(e),t)}onDragOver(e,t,i,s,n=!0){const o=this.dnd.onDragOver(asTreeDragAndDropData(e),t&&t.element,i,s),r=this.autoExpandNode!==t;if(r&&(this.autoExpandDisposable.dispose(),this.autoExpandNode=t),void 0===t)return o;if(r&&"boolean"!=typeof o&&o.autoExpand&&(this.autoExpandDisposable=disposableTimeout((()=>{const e=this.modelProvider(),i=e.getNodeLocation(t);e.isCollapsed(i)&&e.setCollapsed(i,!1),this.autoExpandNode=void 0}),500)),"boolean"==typeof o||!o.accept||void 0===o.bubble||o.feedback)return n?o:{accept:"boolean"==typeof o?o:o.accept,effect:"boolean"==typeof o?void 0:o.effect,feedback:[i]};if(1===o.bubble){const i=this.modelProvider(),n=i.getNodeLocation(t),o=i.getParentNodeLocation(n),r=i.getNode(o),d=o&&i.getListIndex(o);return this.onDragOver(e,r,d,s,!1)}const d=this.modelProvider(),l=d.getNodeLocation(t),a=d.getListIndex(l),h=d.getListRenderCount(l);return Object.assign(Object.assign({},o),{feedback:range(a,a+h)})}drop(e,t,i,s){this.autoExpandDisposable.dispose(),this.autoExpandNode=void 0,this.dnd.drop(asTreeDragAndDropData(e),t&&t.element,i,s)}onDragEnd(e){var t,i;null===(i=(t=this.dnd).onDragEnd)||void 0===i||i.call(t,e)}}function asListOptions(e,t){return t&&Object.assign(Object.assign({},t),{identityProvider:t.identityProvider&&{getId:e=>t.identityProvider.getId(e.element)},dnd:t.dnd&&new TreeNodeListDragAndDrop(e,t.dnd),multipleSelectionController:t.multipleSelectionController&&{isSelectionSingleChangeEvent:e=>t.multipleSelectionController.isSelectionSingleChangeEvent(Object.assign(Object.assign({},e),{element:e.element})),isSelectionRangeChangeEvent:e=>t.multipleSelectionController.isSelectionRangeChangeEvent(Object.assign(Object.assign({},e),{element:e.element}))},accessibilityProvider:t.accessibilityProvider&&Object.assign(Object.assign({},t.accessibilityProvider),{getSetSize(t){const i=e(),s=i.getNodeLocation(t),n=i.getParentNodeLocation(s);return i.getNode(n).visibleChildrenCount},getPosInSet:e=>e.visibleChildIndex+1,isChecked:t.accessibilityProvider&&t.accessibilityProvider.isChecked?e=>t.accessibilityProvider.isChecked(e.element):void 0,getRole:t.accessibilityProvider&&t.accessibilityProvider.getRole?e=>t.accessibilityProvider.getRole(e.element):()=>"treeitem",getAriaLabel:e=>t.accessibilityProvider.getAriaLabel(e.element),getWidgetAriaLabel:()=>t.accessibilityProvider.getWidgetAriaLabel(),getWidgetRole:t.accessibilityProvider&&t.accessibilityProvider.getWidgetRole?()=>t.accessibilityProvider.getWidgetRole():()=>"tree",getAriaLevel:t.accessibilityProvider&&t.accessibilityProvider.getAriaLevel?e=>t.accessibilityProvider.getAriaLevel(e.element):e=>e.depth,getActiveDescendantId:t.accessibilityProvider.getActiveDescendantId&&(e=>t.accessibilityProvider.getActiveDescendantId(e.element))}),keyboardNavigationLabelProvider:t.keyboardNavigationLabelProvider&&Object.assign(Object.assign({},t.keyboardNavigationLabelProvider),{getKeyboardNavigationLabel:e=>t.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e.element)})})}export class ComposedTreeDelegate{constructor(e){this.delegate=e}getHeight(e){return this.delegate.getHeight(e.element)}getTemplateId(e){return this.delegate.getTemplateId(e.element)}hasDynamicHeight(e){return!!this.delegate.hasDynamicHeight&&this.delegate.hasDynamicHeight(e.element)}setDynamicHeight(e,t){var i,s;null===(s=(i=this.delegate).setDynamicHeight)||void 0===s||s.call(i,e.element,t)}}export var RenderIndentGuides;!function(e){e.None="none",e.OnHover="onHover",e.Always="always"}(RenderIndentGuides||(RenderIndentGuides={}));class EventCollection{get elements(){return this._elements}constructor(e,t=[]){this._elements=t,this.disposables=new DisposableStore,this.onDidChange=Event.forEach(e,(e=>this._elements=e),this.disposables)}dispose(){this.disposables.dispose()}}class TreeRenderer{constructor(e,t,i,s,n,o={}){var r;this.renderer=e,this.modelProvider=t,this.activeNodes=s,this.renderedIndentGuides=n,this.renderedElements=new Map,this.renderedNodes=new Map,this.indent=TreeRenderer.DefaultIndent,this.hideTwistiesOfChildlessElements=!1,this.shouldRenderIndentGuides=!1,this.activeIndentNodes=new Set,this.indentGuidesDisposable=Disposable.None,this.disposables=new DisposableStore,this.templateId=e.templateId,this.updateOptions(o),Event.map(i,(e=>e.node))(this.onDidChangeNodeTwistieState,this,this.disposables),null===(r=e.onDidChangeTwistieState)||void 0===r||r.call(e,this.onDidChangeTwistieState,this,this.disposables)}updateOptions(e={}){if(void 0!==e.indent){const t=clamp(e.indent,0,40);if(t!==this.indent){this.indent=t;for(const[e,t]of this.renderedNodes)this.renderTreeElement(e,t)}}if(void 0!==e.renderIndentGuides){const t=e.renderIndentGuides!==RenderIndentGuides.None;if(t!==this.shouldRenderIndentGuides){this.shouldRenderIndentGuides=t;for(const[e,t]of this.renderedNodes)this._renderIndentGuides(e,t);if(this.indentGuidesDisposable.dispose(),t){const e=new DisposableStore;this.activeNodes.onDidChange(this._onDidChangeActiveNodes,this,e),this.indentGuidesDisposable=e,this._onDidChangeActiveNodes(this.activeNodes.elements)}}}void 0!==e.hideTwistiesOfChildlessElements&&(this.hideTwistiesOfChildlessElements=e.hideTwistiesOfChildlessElements)}renderTemplate(e){const t=append(e,$(".monaco-tl-row")),i=append(t,$(".monaco-tl-indent")),s=append(t,$(".monaco-tl-twistie")),n=append(t,$(".monaco-tl-contents")),o=this.renderer.renderTemplate(n);return{container:e,indent:i,twistie:s,indentGuidesDisposable:Disposable.None,templateData:o}}renderElement(e,t,i,s){this.renderedNodes.set(e,i),this.renderedElements.set(e.element,e),this.renderTreeElement(e,i),this.renderer.renderElement(e,t,i.templateData,s)}disposeElement(e,t,i,s){var n,o;i.indentGuidesDisposable.dispose(),null===(o=(n=this.renderer).disposeElement)||void 0===o||o.call(n,e,t,i.templateData,s),"number"==typeof s&&(this.renderedNodes.delete(e),this.renderedElements.delete(e.element))}disposeTemplate(e){this.renderer.disposeTemplate(e.templateData)}onDidChangeTwistieState(e){const t=this.renderedElements.get(e);t&&this.onDidChangeNodeTwistieState(t)}onDidChangeNodeTwistieState(e){const t=this.renderedNodes.get(e);t&&(this._onDidChangeActiveNodes(this.activeNodes.elements),this.renderTreeElement(e,t))}renderTreeElement(e,t){const i=TreeRenderer.DefaultIndent+(e.depth-1)*this.indent;t.twistie.style.paddingLeft=`${i}px`,t.indent.style.width=i+this.indent-16+"px",e.collapsible?t.container.setAttribute("aria-expanded",String(!e.collapsed)):t.container.removeAttribute("aria-expanded"),t.twistie.classList.remove(...ThemeIcon.asClassNameArray(Codicon.treeItemExpanded));let s=!1;this.renderer.renderTwistie&&(s=this.renderer.renderTwistie(e.element,t.twistie)),e.collapsible&&(!this.hideTwistiesOfChildlessElements||e.visibleChildrenCount>0)?(s||t.twistie.classList.add(...ThemeIcon.asClassNameArray(Codicon.treeItemExpanded)),t.twistie.classList.add("collapsible"),t.twistie.classList.toggle("collapsed",e.collapsed)):t.twistie.classList.remove("collapsible","collapsed"),this._renderIndentGuides(e,t)}_renderIndentGuides(e,t){if(clearNode(t.indent),t.indentGuidesDisposable.dispose(),!this.shouldRenderIndentGuides)return;const i=new DisposableStore,s=this.modelProvider();for(;;){const n=s.getNodeLocation(e),o=s.getParentNodeLocation(n);if(!o)break;const r=s.getNode(o),d=$(".indent-guide",{style:`width: ${this.indent}px`});this.activeIndentNodes.has(r)&&d.classList.add("active"),0===t.indent.childElementCount?t.indent.appendChild(d):t.indent.insertBefore(d,t.indent.firstElementChild),this.renderedIndentGuides.add(r,d),i.add(toDisposable((()=>this.renderedIndentGuides.delete(r,d)))),e=r}t.indentGuidesDisposable=i}_onDidChangeActiveNodes(e){if(!this.shouldRenderIndentGuides)return;const t=new Set,i=this.modelProvider();e.forEach((e=>{const s=i.getNodeLocation(e);try{const n=i.getParentNodeLocation(s);e.collapsible&&e.children.length>0&&!e.collapsed?t.add(e):n&&t.add(i.getNode(n))}catch(e){}})),this.activeIndentNodes.forEach((e=>{t.has(e)||this.renderedIndentGuides.forEach(e,(e=>e.classList.remove("active")))})),t.forEach((e=>{this.activeIndentNodes.has(e)||this.renderedIndentGuides.forEach(e,(e=>e.classList.add("active")))})),this.activeIndentNodes=t}dispose(){this.renderedNodes.clear(),this.renderedElements.clear(),this.indentGuidesDisposable.dispose(),dispose(this.disposables)}}TreeRenderer.DefaultIndent=8;class FindFilter{get totalCount(){return this._totalCount}get matchCount(){return this._matchCount}constructor(e,t,i){this.tree=e,this.keyboardNavigationLabelProvider=t,this._filter=i,this._totalCount=0,this._matchCount=0,this._pattern="",this._lowercasePattern="",this.disposables=new DisposableStore,e.onWillRefilter(this.reset,this,this.disposables)}filter(e,t){let i=1;if(this._filter){const s=this._filter.filter(e,t);if(i="boolean"==typeof s?s?1:0:isFilterResult(s)?getVisibleState(s.visibility):s,0===i)return!1}if(this._totalCount++,!this._pattern)return this._matchCount++,{data:FuzzyScore.Default,visibility:i};const s=this.keyboardNavigationLabelProvider.getKeyboardNavigationLabel(e),n=Array.isArray(s)?s:[s];for(const e of n){const t=e&&e.toString();if(void 0===t)return{data:FuzzyScore.Default,visibility:i};let s;if(this.tree.findMatchType===TreeFindMatchType.Contiguous){const e=t.toLowerCase().indexOf(this._lowercasePattern);if(e>-1){s=[Number.MAX_SAFE_INTEGER,0];for(let t=this._lowercasePattern.length;t>0;t--)s.push(e+t-1)}}else s=fuzzyScore(this._pattern,this._lowercasePattern,0,t,t.toLowerCase(),0,{firstMatchCanBeWeak:!0,boostFullMatch:!0});if(s)return this._matchCount++,1===n.length?{data:s,visibility:i}:{data:{label:t,score:s},visibility:i}}return this.tree.findMode===TreeFindMode.Filter?"number"==typeof this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility:this.tree.options.defaultFindVisibility?this.tree.options.defaultFindVisibility(e):2:{data:FuzzyScore.Default,visibility:i}}reset(){this._totalCount=0,this._matchCount=0}dispose(){dispose(this.disposables)}}export class ModeToggle extends Toggle{constructor(e){var t;super({icon:Codicon.listFilter,title:localize("filter","Filter"),isChecked:null!==(t=e.isChecked)&&void 0!==t&&t,inputActiveOptionBorder:e.inputActiveOptionBorder,inputActiveOptionForeground:e.inputActiveOptionForeground,inputActiveOptionBackground:e.inputActiveOptionBackground})}}export class FuzzyToggle extends Toggle{constructor(e){var t;super({icon:Codicon.searchFuzzy,title:localize("fuzzySearch","Fuzzy Match"),isChecked:null!==(t=e.isChecked)&&void 0!==t&&t,inputActiveOptionBorder:e.inputActiveOptionBorder,inputActiveOptionForeground:e.inputActiveOptionForeground,inputActiveOptionBackground:e.inputActiveOptionBackground})}}const unthemedFindWidgetStyles={inputBoxStyles:unthemedInboxStyles,toggleStyles:unthemedToggleStyles,listFilterWidgetBackground:void 0,listFilterWidgetNoMatchesOutline:void 0,listFilterWidgetOutline:void 0,listFilterWidgetShadow:void 0};export var TreeFindMode;!function(e){e[e.Highlight=0]="Highlight",e[e.Filter=1]="Filter"}(TreeFindMode||(TreeFindMode={}));export var TreeFindMatchType;!function(e){e[e.Fuzzy=0]="Fuzzy",e[e.Contiguous=1]="Contiguous"}(TreeFindMatchType||(TreeFindMatchType={}));class FindWidget extends Disposable{set mode(e){this.modeToggle.checked=e===TreeFindMode.Filter,this.findInput.inputBox.setPlaceHolder(e===TreeFindMode.Filter?localize("type to filter","Type to filter"):localize("type to search","Type to search"))}set matchType(e){this.matchTypeToggle.checked=e===TreeFindMatchType.Fuzzy}constructor(e,t,i,s,n,o){var r;super(),this.tree=t,this.elements=h(".monaco-tree-type-filter",[h(".monaco-tree-type-filter-grab.codicon.codicon-debug-gripper@grab",{tabIndex:0}),h(".monaco-tree-type-filter-input@findInput"),h(".monaco-tree-type-filter-actionbar@actionbar")]),this.width=0,this.right=0,this.top=0,this._onDidDisable=new Emitter,e.appendChild(this.elements.root),this._register(toDisposable((()=>e.removeChild(this.elements.root))));const d=null!==(r=null==o?void 0:o.styles)&&void 0!==r?r:unthemedFindWidgetStyles;d.listFilterWidgetBackground&&(this.elements.root.style.backgroundColor=d.listFilterWidgetBackground),d.listFilterWidgetShadow&&(this.elements.root.style.boxShadow=`0 0 8px 2px ${d.listFilterWidgetShadow}`),this.modeToggle=this._register(new ModeToggle(Object.assign(Object.assign({},d.toggleStyles),{isChecked:s===TreeFindMode.Filter}))),this.matchTypeToggle=this._register(new FuzzyToggle(Object.assign(Object.assign({},d.toggleStyles),{isChecked:n===TreeFindMatchType.Fuzzy}))),this.onDidChangeMode=Event.map(this.modeToggle.onChange,(()=>this.modeToggle.checked?TreeFindMode.Filter:TreeFindMode.Highlight),this._store),this.onDidChangeMatchType=Event.map(this.matchTypeToggle.onChange,(()=>this.matchTypeToggle.checked?TreeFindMatchType.Fuzzy:TreeFindMatchType.Contiguous),this._store),this.findInput=this._register(new FindInput(this.elements.findInput,i,{label:localize("type to search","Type to search"),additionalToggles:[this.modeToggle,this.matchTypeToggle],showCommonFindToggles:!1,inputBoxStyles:d.inputBoxStyles,toggleStyles:d.toggleStyles,history:null==o?void 0:o.history})),this.actionbar=this._register(new ActionBar(this.elements.actionbar)),this.mode=s;const l=this._register(new DomEmitter(this.findInput.inputBox.inputElement,"keydown")),a=this._register(Event.chain(l.event)).map((e=>new StandardKeyboardEvent(e))).event;this._register(a((e=>e.equals(3)?(e.preventDefault(),e.stopPropagation(),this.findInput.inputBox.addToHistory(),void this.tree.domFocus()):e.equals(18)?(e.preventDefault(),e.stopPropagation(),void(this.findInput.inputBox.isAtLastInHistory()||this.findInput.inputBox.isNowhereInHistory()?(this.findInput.inputBox.addToHistory(),this.tree.domFocus()):this.findInput.inputBox.showNextValue())):e.equals(16)?(e.preventDefault(),e.stopPropagation(),void this.findInput.inputBox.showPreviousValue()):void 0)));const c=this._register(new Action("close",localize("close","Close"),"codicon codicon-close",!0,(()=>this.dispose())));this.actionbar.push(c,{icon:!0,label:!1});const p=this._register(new DomEmitter(this.elements.grab,"mousedown"));this._register(p.event((e=>{const t=new DisposableStore,i=t.add(new DomEmitter(window,"mousemove")),s=t.add(new DomEmitter(window,"mouseup")),n=this.right,o=e.pageX,r=this.top,d=e.pageY;this.elements.grab.classList.add("grabbing");const l=this.elements.root.style.transition;this.elements.root.style.transition="unset";const a=e=>{const t=e.pageX-o;this.right=n-t;const i=e.pageY-d;this.top=r+i,this.layout()};t.add(i.event(a)),t.add(s.event((e=>{a(e),this.elements.grab.classList.remove("grabbing"),this.elements.root.style.transition=l,t.dispose()})))})));const u=this._register(Event.chain(this._register(new DomEmitter(this.elements.grab,"keydown")).event)).map((e=>new StandardKeyboardEvent(e))).event;this._register(u((e=>{let t,i;if(15===e.keyCode?t=Number.POSITIVE_INFINITY:17===e.keyCode?t=0:10===e.keyCode&&(t=0===this.right?Number.POSITIVE_INFINITY:0),16===e.keyCode?i=0:18===e.keyCode&&(i=Number.POSITIVE_INFINITY),void 0!==t&&(e.preventDefault(),e.stopPropagation(),this.right=t,this.layout()),void 0!==i){e.preventDefault(),e.stopPropagation(),this.top=i;const t=this.elements.root.style.transition;this.elements.root.style.transition="unset",this.layout(),setTimeout((()=>{this.elements.root.style.transition=t}),0)}}))),this.onDidChangeValue=this.findInput.onDidChange}layout(e=this.width){this.width=e,this.right=clamp(this.right,0,Math.max(0,e-212)),this.elements.root.style.right=`${this.right}px`,this.top=clamp(this.top,0,24),this.elements.root.style.top=`${this.top}px`}showMessage(e){this.findInput.showMessage(e)}clearMessage(){this.findInput.clearMessage()}dispose(){const e=Object.create(null,{dispose:{get:()=>super.dispose}});return __awaiter(this,void 0,void 0,(function*(){this._onDidDisable.fire(),this.elements.root.classList.add("disabled"),yield timeout(300),e.dispose.call(this)}))}}class FindController{get pattern(){return this._pattern}get mode(){return this._mode}set mode(e){e!==this._mode&&(this._mode=e,this.widget&&(this.widget.mode=this._mode),this.tree.refilter(),this.render(),this._onDidChangeMode.fire(e))}get matchType(){return this._matchType}set matchType(e){e!==this._matchType&&(this._matchType=e,this.widget&&(this.widget.matchType=this._matchType),this.tree.refilter(),this.render(),this._onDidChangeMatchType.fire(e))}constructor(e,t,i,s,n,o={}){var r,d;this.tree=e,this.view=i,this.filter=s,this.contextViewProvider=n,this.options=o,this._pattern="",this.width=0,this._onDidChangeMode=new Emitter,this.onDidChangeMode=this._onDidChangeMode.event,this._onDidChangeMatchType=new Emitter,this.onDidChangeMatchType=this._onDidChangeMatchType.event,this._onDidChangePattern=new Emitter,this._onDidChangeOpenState=new Emitter,this.onDidChangeOpenState=this._onDidChangeOpenState.event,this.enabledDisposables=new DisposableStore,this.disposables=new DisposableStore,this._mode=null!==(r=e.options.defaultFindMode)&&void 0!==r?r:TreeFindMode.Highlight,this._matchType=null!==(d=e.options.defaultFindMatchType)&&void 0!==d?d:TreeFindMatchType.Fuzzy,t.onDidSplice(this.onDidSpliceModel,this,this.disposables)}updateOptions(e={}){void 0!==e.defaultFindMode&&(this.mode=e.defaultFindMode),void 0!==e.defaultFindMatchType&&(this.matchType=e.defaultFindMatchType)}onDidSpliceModel(){this.widget&&0!==this.pattern.length&&(this.tree.refilter(),this.render())}render(){var e,t,i,s;const n=this.filter.totalCount>0&&0===this.filter.matchCount;this.pattern&&n?null===(e=this.tree.options.showNotFoundMessage)||void 0===e||e?null===(t=this.widget)||void 0===t||t.showMessage({type:2,content:localize("not found","No elements found.")}):null===(i=this.widget)||void 0===i||i.showMessage({type:2}):null===(s=this.widget)||void 0===s||s.clearMessage()}shouldAllowFocus(e){return!this.widget||!this.pattern||this._mode===TreeFindMode.Filter||this.filter.totalCount>0&&this.filter.matchCount<=1||!FuzzyScore.isDefault(e.filterData)}layout(e){var t;this.width=e,null===(t=this.widget)||void 0===t||t.layout(e)}dispose(){this._history=void 0,this._onDidChangePattern.dispose(),this.enabledDisposables.dispose(),this.disposables.dispose()}}function asTreeMouseEvent(e){let t=TreeMouseEventTarget.Unknown;return hasParentWithClass(e.browserEvent.target,"monaco-tl-twistie","monaco-tl-row")?t=TreeMouseEventTarget.Twistie:hasParentWithClass(e.browserEvent.target,"monaco-tl-contents","monaco-tl-row")?t=TreeMouseEventTarget.Element:hasParentWithClass(e.browserEvent.target,"monaco-tree-type-filter","monaco-list")&&(t=TreeMouseEventTarget.Filter),{browserEvent:e.browserEvent,element:e.element?e.element.element:null,target:t}}function dfs(e,t){t(e),e.children.forEach((e=>dfs(e,t)))}class Trait{get nodeSet(){return this._nodeSet||(this._nodeSet=this.createNodeSet()),this._nodeSet}constructor(e,t){this.getFirstViewElementWithTrait=e,this.identityProvider=t,this.nodes=[],this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event}set(e,t){!(null==t?void 0:t.__forceEvent)&&equals(this.nodes,e)||this._set(e,!1,t)}_set(e,t,i){if(this.nodes=[...e],this.elements=void 0,this._nodeSet=void 0,!t){const e=this;this._onDidChange.fire({get elements(){return e.get()},browserEvent:i})}}get(){return this.elements||(this.elements=this.nodes.map((e=>e.element))),[...this.elements]}getNodes(){return this.nodes}has(e){return this.nodeSet.has(e)}onDidModelSplice({insertedNodes:e,deletedNodes:t}){if(!this.identityProvider){const e=this.createNodeSet(),i=t=>e.delete(t);return t.forEach((e=>dfs(e,i))),void this.set([...e.values()])}const i=new Set,s=e=>i.add(this.identityProvider.getId(e.element).toString());t.forEach((e=>dfs(e,s)));const n=new Map,o=e=>n.set(this.identityProvider.getId(e.element).toString(),e);e.forEach((e=>dfs(e,o)));const r=[];for(const e of this.nodes){const t=this.identityProvider.getId(e.element).toString();if(i.has(t)){const e=n.get(t);e&&r.push(e)}else r.push(e)}if(this.nodes.length>0&&0===r.length){const e=this.getFirstViewElementWithTrait();e&&r.push(e)}this._set(r,!0)}createNodeSet(){const e=new Set;for(const t of this.nodes)e.add(t);return e}}class TreeNodeListMouseController extends MouseController{constructor(e,t){super(e),this.tree=t}onViewPointer(e){if(isButton(e.browserEvent.target)||isInputElement(e.browserEvent.target)||isMonacoEditor(e.browserEvent.target))return;const t=e.element;if(!t)return super.onViewPointer(e);if(this.isSelectionRangeChangeEvent(e)||this.isSelectionSingleChangeEvent(e))return super.onViewPointer(e);const i=e.browserEvent.target,s=i.classList.contains("monaco-tl-twistie")||i.classList.contains("monaco-icon-label")&&i.classList.contains("folder-icon")&&e.browserEvent.offsetX<16;let n=!1;if(n="function"==typeof this.tree.expandOnlyOnTwistieClick?this.tree.expandOnlyOnTwistieClick(t.element):!!this.tree.expandOnlyOnTwistieClick,n&&!s&&2!==e.browserEvent.detail)return super.onViewPointer(e);if(!this.tree.expandOnDoubleClick&&2===e.browserEvent.detail)return super.onViewPointer(e);if(t.collapsible){const i=this.tree.getNodeLocation(t),o=e.browserEvent.altKey;if(this.tree.setFocus([i]),this.tree.toggleCollapsed(i,o),n&&s)return}super.onViewPointer(e)}onDoubleClick(e){!e.browserEvent.target.classList.contains("monaco-tl-twistie")&&this.tree.expandOnDoubleClick&&super.onDoubleClick(e)}}class TreeNodeList extends List{constructor(e,t,i,s,n,o,r,d){super(e,t,i,s,d),this.focusTrait=n,this.selectionTrait=o,this.anchorTrait=r}createMouseController(e){return new TreeNodeListMouseController(this,e.tree)}splice(e,t,i=[]){if(super.splice(e,t,i),0===i.length)return;const s=[],n=[];let o;i.forEach(((t,i)=>{this.focusTrait.has(t)&&s.push(e+i),this.selectionTrait.has(t)&&n.push(e+i),this.anchorTrait.has(t)&&(o=e+i)})),s.length>0&&super.setFocus(distinct([...super.getFocus(),...s])),n.length>0&&super.setSelection(distinct([...super.getSelection(),...n])),"number"==typeof o&&super.setAnchor(o)}setFocus(e,t,i=!1){super.setFocus(e,t),i||this.focusTrait.set(e.map((e=>this.element(e))),t)}setSelection(e,t,i=!1){super.setSelection(e,t),i||this.selectionTrait.set(e.map((e=>this.element(e))),t)}setAnchor(e,t=!1){super.setAnchor(e),t||(void 0===e?this.anchorTrait.set([]):this.anchorTrait.set([this.element(e)]))}}export class AbstractTree{get onDidChangeFocus(){return this.eventBufferer.wrapEvent(this.focus.onDidChange)}get onDidChangeSelection(){return this.eventBufferer.wrapEvent(this.selection.onDidChange)}get onMouseDblClick(){return Event.filter(Event.map(this.view.onMouseDblClick,asTreeMouseEvent),(e=>e.target!==TreeMouseEventTarget.Filter))}get onPointer(){return Event.map(this.view.onPointer,asTreeMouseEvent)}get onDidFocus(){return this.view.onDidFocus}get onDidChangeModel(){return Event.signal(this.model.onDidSplice)}get onDidChangeCollapseState(){return this.model.onDidChangeCollapseState}get findMode(){var e,t;return null!==(t=null===(e=this.findController)||void 0===e?void 0:e.mode)&&void 0!==t?t:TreeFindMode.Highlight}set findMode(e){this.findController&&(this.findController.mode=e)}get findMatchType(){var e,t;return null!==(t=null===(e=this.findController)||void 0===e?void 0:e.matchType)&&void 0!==t?t:TreeFindMatchType.Fuzzy}set findMatchType(e){this.findController&&(this.findController.matchType=e)}get expandOnDoubleClick(){return void 0===this._options.expandOnDoubleClick||this._options.expandOnDoubleClick}get expandOnlyOnTwistieClick(){return void 0===this._options.expandOnlyOnTwistieClick||this._options.expandOnlyOnTwistieClick}get onDidDispose(){return this.view.onDidDispose}constructor(e,t,i,s,n={}){var o;this._user=e,this._options=n,this.eventBufferer=new EventBufferer,this.onDidChangeFindOpenState=Event.None,this.disposables=new DisposableStore,this._onWillRefilter=new Emitter,this.onWillRefilter=this._onWillRefilter.event,this._onDidUpdateOptions=new Emitter;const r=new ComposedTreeDelegate(i),d=new Relay,l=new Relay,a=this.disposables.add(new EventCollection(l.event)),h=new SetMap;this.renderers=s.map((e=>new TreeRenderer(e,(()=>this.model),d.event,a,h,n)));for(const e of this.renderers)this.disposables.add(e);let c;n.keyboardNavigationLabelProvider&&(c=new FindFilter(this,n.keyboardNavigationLabelProvider,n.filter),n=Object.assign(Object.assign({},n),{filter:c}),this.disposables.add(c)),this.focus=new Trait((()=>this.view.getFocusedElements()[0]),n.identityProvider),this.selection=new Trait((()=>this.view.getSelectedElements()[0]),n.identityProvider),this.anchor=new Trait((()=>this.view.getAnchorElement()),n.identityProvider),this.view=new TreeNodeList(e,t,r,this.renderers,this.focus,this.selection,this.anchor,Object.assign(Object.assign({},asListOptions((()=>this.model),n)),{tree:this})),this.model=this.createModel(e,this.view,n),d.input=this.model.onDidChangeCollapseState;const p=Event.forEach(this.model.onDidSplice,(e=>{this.eventBufferer.bufferEvents((()=>{this.focus.onDidModelSplice(e),this.selection.onDidModelSplice(e)}))}),this.disposables);if(p((()=>null),null,this.disposables),l.input=Event.chain(Event.any(p,this.focus.onDidChange,this.selection.onDidChange)).debounce((()=>null),0).map((()=>{const e=new Set;for(const t of this.focus.getNodes())e.add(t);for(const t of this.selection.getNodes())e.add(t);return[...e.values()]})).event,!1!==n.keyboardSupport){const e=Event.chain(this.view.onKeyDown).filter((e=>!isInputElement(e.target))).map((e=>new StandardKeyboardEvent(e)));e.filter((e=>15===e.keyCode)).on(this.onLeftArrow,this,this.disposables),e.filter((e=>17===e.keyCode)).on(this.onRightArrow,this,this.disposables),e.filter((e=>10===e.keyCode)).on(this.onSpace,this,this.disposables)}if((null===(o=n.findWidgetEnabled)||void 0===o||o)&&n.keyboardNavigationLabelProvider&&n.contextViewProvider){const e=this.options.findWidgetStyles?{styles:this.options.findWidgetStyles}:void 0;this.findController=new FindController(this,this.model,this.view,c,n.contextViewProvider,e),this.focusNavigationFilter=e=>this.findController.shouldAllowFocus(e),this.onDidChangeFindOpenState=this.findController.onDidChangeOpenState,this.disposables.add(this.findController),this.onDidChangeFindMode=this.findController.onDidChangeMode,this.onDidChangeFindMatchType=this.findController.onDidChangeMatchType}else this.onDidChangeFindMode=Event.None,this.onDidChangeFindMatchType=Event.None;this.styleElement=createStyleSheet(this.view.getHTMLElement()),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides===RenderIndentGuides.Always)}updateOptions(e={}){var t;this._options=Object.assign(Object.assign({},this._options),e);for(const t of this.renderers)t.updateOptions(e);this.view.updateOptions(this._options),null===(t=this.findController)||void 0===t||t.updateOptions(e),this._onDidUpdateOptions.fire(this._options),this.getHTMLElement().classList.toggle("always",this._options.renderIndentGuides===RenderIndentGuides.Always)}get options(){return this._options}getHTMLElement(){return this.view.getHTMLElement()}get scrollTop(){return this.view.scrollTop}set scrollTop(e){this.view.scrollTop=e}domFocus(){this.view.domFocus()}layout(e,t){var i;this.view.layout(e,t),isNumber(t)&&(null===(i=this.findController)||void 0===i||i.layout(t))}style(e){const t=`.${this.view.domId}`,i=[];e.treeIndentGuidesStroke&&(i.push(`.monaco-list${t}:hover .monaco-tl-indent > .indent-guide, .monaco-list${t}.always .monaco-tl-indent > .indent-guide  { border-color: ${e.treeInactiveIndentGuidesStroke}; }`),i.push(`.monaco-list${t} .monaco-tl-indent > .indent-guide.active { border-color: ${e.treeIndentGuidesStroke}; }`)),this.styleElement.textContent=i.join("\n"),this.view.style(e)}getParentElement(e){const t=this.model.getParentNodeLocation(e);return this.model.getNode(t).element}getFirstElementChild(e){return this.model.getFirstElementChild(e)}getNode(e){return this.model.getNode(e)}getNodeLocation(e){return this.model.getNodeLocation(e)}collapse(e,t=!1){return this.model.setCollapsed(e,!0,t)}expand(e,t=!1){return this.model.setCollapsed(e,!1,t)}toggleCollapsed(e,t=!1){return this.model.setCollapsed(e,void 0,t)}isCollapsible(e){return this.model.isCollapsible(e)}setCollapsible(e,t){return this.model.setCollapsible(e,t)}isCollapsed(e){return this.model.isCollapsed(e)}refilter(){this._onWillRefilter.fire(void 0),this.model.refilter()}setSelection(e,t){const i=e.map((e=>this.model.getNode(e)));this.selection.set(i,t);const s=e.map((e=>this.model.getListIndex(e))).filter((e=>e>-1));this.view.setSelection(s,t,!0)}getSelection(){return this.selection.get()}setFocus(e,t){const i=e.map((e=>this.model.getNode(e)));this.focus.set(i,t);const s=e.map((e=>this.model.getListIndex(e))).filter((e=>e>-1));this.view.setFocus(s,t,!0)}getFocus(){return this.focus.get()}reveal(e,t){this.model.expandTo(e);const i=this.model.getListIndex(e);-1!==i&&this.view.reveal(i,t)}onLeftArrow(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i);if(!this.model.setCollapsed(s,!0)){const e=this.model.getParentNodeLocation(s);if(!e)return;const t=this.model.getListIndex(e);this.view.reveal(t),this.view.setFocus([t])}}onRightArrow(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i);if(!this.model.setCollapsed(s,!1)){if(!i.children.some((e=>e.visible)))return;const[e]=this.view.getFocus(),t=e+1;this.view.reveal(t),this.view.setFocus([t])}}onSpace(e){e.preventDefault(),e.stopPropagation();const t=this.view.getFocusedElements();if(0===t.length)return;const i=t[0],s=this.model.getNodeLocation(i),n=e.browserEvent.altKey;this.model.setCollapsed(s,void 0,n)}dispose(){dispose(this.disposables),this.view.dispose()}}