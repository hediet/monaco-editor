var __awaiter=this&&this.__awaiter||function(e,o,t,i){return new(t||(t=Promise))((function(n,s){function a(e){try{d(i.next(e))}catch(e){s(e)}}function r(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var o;e.done?n(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(a,r)}d((i=i.apply(e,o||[])).next())}))};import*as dom from"../../dom.js";import{TimeoutTimer}from"../../../common/async.js";import{CancellationTokenSource}from"../../../common/cancellation.js";import{isMarkdownString}from"../../../common/htmlContent.js";import{stripIcons}from"../../../common/iconLabels.js";import{DisposableStore}from"../../../common/lifecycle.js";import{isFunction,isString}from"../../../common/types.js";import{localize}from"../../../../nls.js";export function setupNativeHover(e,o){isString(o)?e.title=stripIcons(o):(null==o?void 0:o.markdownNotSupportedFallback)?e.title=o.markdownNotSupportedFallback:e.removeAttribute("title")}class UpdatableHoverWidget{constructor(e,o,t){this.hoverDelegate=e,this.target=o,this.fadeInAnimation=t}update(e,o,t){var i;return __awaiter(this,void 0,void 0,(function*(){if(this._cancellationTokenSource&&(this._cancellationTokenSource.dispose(!0),this._cancellationTokenSource=void 0),this.isDisposed)return;let n;if(void 0===e||isString(e)||e instanceof HTMLElement)n=e;else if(isFunction(e.markdown)){this._hoverWidget||this.show(localize("iconLabel.loading","Loading..."),o),this._cancellationTokenSource=new CancellationTokenSource;const t=this._cancellationTokenSource.token;if(n=yield e.markdown(t),void 0===n&&(n=e.markdownNotSupportedFallback),this.isDisposed||t.isCancellationRequested)return}else n=null!==(i=e.markdown)&&void 0!==i?i:e.markdownNotSupportedFallback;this.show(n,o,t)}))}show(e,o,t){const i=this._hoverWidget;if(this.hasContent(e)){const n=Object.assign({content:e,target:this.target,showPointer:"element"===this.hoverDelegate.placement,hoverPosition:2,skipFadeInAnimation:!this.fadeInAnimation||!!i},t);this._hoverWidget=this.hoverDelegate.showHover(n,o)}null==i||i.dispose()}hasContent(e){return!(!e||isMarkdownString(e)&&!e.value)}get isDisposed(){var e;return null===(e=this._hoverWidget)||void 0===e?void 0:e.isDisposed}dispose(){var e,o;null===(e=this._hoverWidget)||void 0===e||e.dispose(),null===(o=this._cancellationTokenSource)||void 0===o||o.dispose(!0),this._cancellationTokenSource=void 0}}export function setupCustomHover(e,o,t,i){let n,s;const a=(o,t)=>{var i;o&&(null==s||s.dispose(),s=void 0),t&&(null==n||n.dispose(),n=void 0),null===(i=e.onDidHideHover)||void 0===i||i.call(e)},r=(n,a,r)=>new TimeoutTimer((()=>__awaiter(this,void 0,void 0,(function*(){s&&!s.isDisposed||(s=new UpdatableHoverWidget(e,r||o,n>0),yield s.update(t,a,i))}))),n),d=dom.addDisposableListener(o,dom.EventType.MOUSE_OVER,(()=>{if(n)return;const t=new DisposableStore;t.add(dom.addDisposableListener(o,dom.EventType.MOUSE_LEAVE,(e=>a(!1,e.fromElement===o)),!0)),t.add(dom.addDisposableListener(o,dom.EventType.MOUSE_DOWN,(()=>a(!0,!0)),!0));const i={targetElements:[o],dispose:()=>{}};if(void 0===e.placement||"mouse"===e.placement){const e=e=>{i.x=e.x+10,e.target instanceof HTMLElement&&e.target.classList.contains("action-label")&&a(!0,!0)};t.add(dom.addDisposableListener(o,dom.EventType.MOUSE_MOVE,e,!0))}t.add(r(e.delay,!1,i)),n=t}),!0);return{show:e=>{a(!1,!0),r(0,e)},hide:()=>{a(!0,!0)},update:(e,o)=>__awaiter(this,void 0,void 0,(function*(){t=e,yield null==s?void 0:s.update(t,void 0,o)})),dispose:()=>{d.dispose(),a(!0,!0)}}}