import"./iconlabel.css";import*as dom from"../../dom.js";import{HighlightedLabel}from"../highlightedlabel/highlightedLabel.js";import{setupCustomHover,setupNativeHover}from"./iconLabelHover.js";import{Disposable}from"../../../common/lifecycle.js";import{equals}from"../../../common/objects.js";import{Range}from"../../../common/range.js";class FastLabelNode{constructor(e){this._element=e}get element(){return this._element}set textContent(e){this.disposed||e===this._textContent||(this._textContent=e,this._element.textContent=e)}set className(e){this.disposed||e===this._className||(this._className=e,this._element.className=e)}set empty(e){this.disposed||e===this._empty||(this._empty=e,this._element.style.marginLeft=e?"0":"")}dispose(){this.disposed=!0}}export class IconLabel extends Disposable{constructor(e,t){super(),this.customHovers=new Map,this.creationOptions=t,this.domNode=this._register(new FastLabelNode(dom.append(e,dom.$(".monaco-icon-label")))),this.labelContainer=dom.append(this.domNode.element,dom.$(".monaco-icon-label-container"));const s=dom.append(this.labelContainer,dom.$("span.monaco-icon-name-container"));(null==t?void 0:t.supportHighlights)||(null==t?void 0:t.supportIcons)?this.nameNode=new LabelWithHighlights(s,!!t.supportIcons):this.nameNode=new Label(s),this.hoverDelegate=null==t?void 0:t.hoverDelegate}get element(){return this.domNode.element}setLabel(e,t,s){const i=["monaco-icon-label"],o=["monaco-icon-label-container"];if(s&&(s.extraClasses&&i.push(...s.extraClasses),s.italic&&i.push("italic"),s.strikethrough&&i.push("strikethrough"),s.disabledCommand&&o.push("disabled")),this.domNode.className=i.join(" "),this.labelContainer.className=o.join(" "),this.setupHover((null==s?void 0:s.descriptionTitle)?this.labelContainer:this.element,null==s?void 0:s.title),this.nameNode.setLabel(e,s),t||this.descriptionNode){const e=this.getOrCreateDescriptionNode();e instanceof HighlightedLabel?(e.set(t||"",s?s.descriptionMatches:void 0,void 0,null==s?void 0:s.labelEscapeNewLines),this.setupHover(e.element,null==s?void 0:s.descriptionTitle)):(e.textContent=t&&(null==s?void 0:s.labelEscapeNewLines)?HighlightedLabel.escapeNewLines(t,[]):t||"",this.setupHover(e.element,(null==s?void 0:s.descriptionTitle)||""),e.empty=!t)}}setupHover(e,t){const s=this.customHovers.get(e);if(s&&(s.dispose(),this.customHovers.delete(e)),t)if(this.hoverDelegate){const s=setupCustomHover(this.hoverDelegate,e,t);s&&this.customHovers.set(e,s)}else setupNativeHover(e,t);else e.removeAttribute("title")}dispose(){super.dispose();for(const e of this.customHovers.values())e.dispose();this.customHovers.clear()}getOrCreateDescriptionNode(){var e;if(!this.descriptionNode){const t=this._register(new FastLabelNode(dom.append(this.labelContainer,dom.$("span.monaco-icon-description-container"))));(null===(e=this.creationOptions)||void 0===e?void 0:e.supportDescriptionHighlights)?this.descriptionNode=new HighlightedLabel(dom.append(t.element,dom.$("span.label-description")),{supportIcons:!!this.creationOptions.supportIcons}):this.descriptionNode=this._register(new FastLabelNode(dom.append(t.element,dom.$("span.label-description"))))}return this.descriptionNode}}class Label{constructor(e){this.container=e,this.label=void 0,this.singleLabel=void 0}setLabel(e,t){if(this.label!==e||!equals(this.options,t))if(this.label=e,this.options=t,"string"==typeof e)this.singleLabel||(this.container.innerText="",this.container.classList.remove("multiple"),this.singleLabel=dom.append(this.container,dom.$("a.label-name",{id:null==t?void 0:t.domId}))),this.singleLabel.textContent=e;else{this.container.innerText="",this.container.classList.add("multiple"),this.singleLabel=void 0;for(let s=0;s<e.length;s++){const i=e[s],o=(null==t?void 0:t.domId)&&`${null==t?void 0:t.domId}_${s}`;dom.append(this.container,dom.$("a.label-name",{id:o,"data-icon-label-count":e.length,"data-icon-label-index":s,role:"treeitem"},i)),s<e.length-1&&dom.append(this.container,dom.$("span.label-separator",void 0,(null==t?void 0:t.separator)||"/"))}}}}function splitMatches(e,t,s){if(!s)return;let i=0;return e.map((e=>{const o={start:i,end:i+e.length},n=s.map((e=>Range.intersect(o,e))).filter((e=>!Range.isEmpty(e))).map((({start:e,end:t})=>({start:e-i,end:t-i})));return i=o.end+t.length,n}))}class LabelWithHighlights{constructor(e,t){this.container=e,this.supportIcons=t,this.label=void 0,this.singleLabel=void 0}setLabel(e,t){if(this.label!==e||!equals(this.options,t))if(this.label=e,this.options=t,"string"==typeof e)this.singleLabel||(this.container.innerText="",this.container.classList.remove("multiple"),this.singleLabel=new HighlightedLabel(dom.append(this.container,dom.$("a.label-name",{id:null==t?void 0:t.domId})),{supportIcons:this.supportIcons})),this.singleLabel.set(e,null==t?void 0:t.matches,void 0,null==t?void 0:t.labelEscapeNewLines);else{this.container.innerText="",this.container.classList.add("multiple"),this.singleLabel=void 0;const s=(null==t?void 0:t.separator)||"/",i=splitMatches(e,s,null==t?void 0:t.matches);for(let o=0;o<e.length;o++){const n=e[o],l=i?i[o]:void 0,a=(null==t?void 0:t.domId)&&`${null==t?void 0:t.domId}_${o}`,d=dom.$("a.label-name",{id:a,"data-icon-label-count":e.length,"data-icon-label-index":o,role:"treeitem"});new HighlightedLabel(dom.append(this.container,d),{supportIcons:this.supportIcons}).set(n,l,void 0,null==t?void 0:t.labelEscapeNewLines),o<e.length-1&&dom.append(d,dom.$("span.label-separator",void 0,s))}}}}