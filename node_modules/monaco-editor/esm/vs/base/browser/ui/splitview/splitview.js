import{$,addDisposableListener,append,scheduleAtNextAnimationFrame}from"../../dom.js";import{DomEmitter}from"../../event.js";import{Sash}from"../sash/sash.js";import{SmoothScrollableElement}from"../scrollbar/scrollableElement.js";import{pushToEnd,pushToStart,range}from"../../../common/arrays.js";import{Color}from"../../../common/color.js";import{Emitter,Event}from"../../../common/event.js";import{combinedDisposable,Disposable,dispose,toDisposable}from"../../../common/lifecycle.js";import{clamp}from"../../../common/numbers.js";import{Scrollable}from"../../../common/scrollable.js";import*as types from"../../../common/types.js";import"./splitview.css";const defaultStyles={separatorBorder:Color.transparent};class ViewItem{set size(e){this._size=e}get size(){return this._size}get visible(){return void 0===this._cachedVisibleSize}setVisible(e,i){var t,s;e!==this.visible&&(e?(this.size=clamp(this._cachedVisibleSize,this.viewMinimumSize,this.viewMaximumSize),this._cachedVisibleSize=void 0):(this._cachedVisibleSize="number"==typeof i?i:this.size,this.size=0),this.container.classList.toggle("visible",e),null===(s=(t=this.view).setVisible)||void 0===s||s.call(t,e))}get minimumSize(){return this.visible?this.view.minimumSize:0}get viewMinimumSize(){return this.view.minimumSize}get maximumSize(){return this.visible?this.view.maximumSize:0}get viewMaximumSize(){return this.view.maximumSize}get priority(){return this.view.priority}get proportionalLayout(){var e;return null===(e=this.view.proportionalLayout)||void 0===e||e}get snap(){return!!this.view.snap}set enabled(e){this.container.style.pointerEvents=e?"":"none"}constructor(e,i,t,s){this.container=e,this.view=i,this.disposable=s,this._cachedVisibleSize=void 0,"number"==typeof t?(this._size=t,this._cachedVisibleSize=void 0,e.classList.add("visible")):(this._size=0,this._cachedVisibleSize=t.cachedVisibleSize)}layout(e,i){this.layoutContainer(e),this.view.layout(this.size,e,i)}dispose(){return this.disposable.dispose(),this.view}}class VerticalViewItem extends ViewItem{layoutContainer(e){this.container.style.top=`${e}px`,this.container.style.height=`${this.size}px`}}class HorizontalViewItem extends ViewItem{layoutContainer(e){this.container.style.left=`${e}px`,this.container.style.width=`${this.size}px`}}var State;!function(e){e[e.Idle=0]="Idle",e[e.Busy=1]="Busy"}(State||(State={}));export var Sizing;!function(e){e.Distribute={type:"distribute"},e.Split=function(e){return{type:"split",index:e}},e.Invisible=function(e){return{type:"invisible",cachedVisibleSize:e}}}(Sizing||(Sizing={}));export class SplitView extends Disposable{get orthogonalStartSash(){return this._orthogonalStartSash}get orthogonalEndSash(){return this._orthogonalEndSash}get startSnappingEnabled(){return this._startSnappingEnabled}get endSnappingEnabled(){return this._endSnappingEnabled}set orthogonalStartSash(e){for(const i of this.sashItems)i.sash.orthogonalStartSash=e;this._orthogonalStartSash=e}set orthogonalEndSash(e){for(const i of this.sashItems)i.sash.orthogonalEndSash=e;this._orthogonalEndSash=e}set startSnappingEnabled(e){this._startSnappingEnabled!==e&&(this._startSnappingEnabled=e,this.updateSashEnablement())}set endSnappingEnabled(e){this._endSnappingEnabled!==e&&(this._endSnappingEnabled=e,this.updateSashEnablement())}constructor(e,i={}){var t,s,n,o,a;super(),this.size=0,this.contentSize=0,this.proportions=void 0,this.viewItems=[],this.sashItems=[],this.state=State.Idle,this._onDidSashChange=this._register(new Emitter),this._onDidSashReset=this._register(new Emitter),this._startSnappingEnabled=!0,this._endSnappingEnabled=!0,this.onDidSashChange=this._onDidSashChange.event,this.onDidSashReset=this._onDidSashReset.event,this.orientation=null!==(t=i.orientation)&&void 0!==t?t:0,this.inverseAltBehavior=null!==(s=i.inverseAltBehavior)&&void 0!==s&&s,this.proportionalLayout=null===(n=i.proportionalLayout)||void 0===n||n,this.getSashOrthogonalSize=i.getSashOrthogonalSize,this.el=document.createElement("div"),this.el.classList.add("monaco-split-view2"),this.el.classList.add(0===this.orientation?"vertical":"horizontal"),e.appendChild(this.el),this.sashContainer=append(this.el,$(".sash-container")),this.viewContainer=$(".split-view-container"),this.scrollable=new Scrollable({forceIntegerValues:!0,smoothScrollDuration:125,scheduleAtNextAnimationFrame}),this.scrollableElement=this._register(new SmoothScrollableElement(this.viewContainer,{vertical:0===this.orientation?null!==(o=i.scrollbarVisibility)&&void 0!==o?o:1:2,horizontal:1===this.orientation?null!==(a=i.scrollbarVisibility)&&void 0!==a?a:1:2},this.scrollable));const r=this._register(new DomEmitter(this.viewContainer,"scroll")).event;this._register(r((e=>{const i=this.scrollableElement.getScrollPosition(),t=Math.abs(this.viewContainer.scrollLeft-i.scrollLeft)<=1?void 0:this.viewContainer.scrollLeft,s=Math.abs(this.viewContainer.scrollTop-i.scrollTop)<=1?void 0:this.viewContainer.scrollTop;void 0===t&&void 0===s||this.scrollableElement.setScrollPosition({scrollLeft:t,scrollTop:s})}))),this.onDidScroll=this.scrollableElement.onScroll,this._register(this.onDidScroll((e=>{e.scrollTopChanged&&(this.viewContainer.scrollTop=e.scrollTop),e.scrollLeftChanged&&(this.viewContainer.scrollLeft=e.scrollLeft)}))),append(this.el,this.scrollableElement.getDomNode()),this.style(i.styles||defaultStyles),i.descriptor&&(this.size=i.descriptor.size,i.descriptor.views.forEach(((e,i)=>{const t=types.isUndefined(e.visible)||e.visible?e.size:{type:"invisible",cachedVisibleSize:e.size},s=e.view;this.doAddView(s,t,i,!0)})),this.contentSize=this.viewItems.reduce(((e,i)=>e+i.size),0),this.saveProportions())}style(e){e.separatorBorder.isTransparent()?(this.el.classList.remove("separator-border"),this.el.style.removeProperty("--separator-border")):(this.el.classList.add("separator-border"),this.el.style.setProperty("--separator-border",e.separatorBorder.toString()))}addView(e,i,t=this.viewItems.length,s){this.doAddView(e,i,t,s)}layout(e,i){const t=Math.max(this.size,this.contentSize);if(this.size=e,this.layoutContext=i,this.proportions){let i=0;for(let t=0;t<this.viewItems.length;t++){const s=this.viewItems[t],n=this.proportions[t];"number"==typeof n?i+=n:e-=s.size}for(let t=0;t<this.viewItems.length;t++){const s=this.viewItems[t],n=this.proportions[t];"number"==typeof n&&(s.size=clamp(Math.round(n*e/i),s.minimumSize,s.maximumSize))}}else{const i=range(this.viewItems.length),s=i.filter((e=>1===this.viewItems[e].priority)),n=i.filter((e=>2===this.viewItems[e].priority));this.resize(this.viewItems.length-1,e-t,void 0,s,n)}this.distributeEmptySpace(),this.layoutViews()}saveProportions(){this.proportionalLayout&&this.contentSize>0&&(this.proportions=this.viewItems.map((e=>e.proportionalLayout?e.size/this.contentSize:void 0)))}onSashStart({sash:e,start:i,alt:t}){for(const e of this.viewItems)e.enabled=!1;const s=this.sashItems.findIndex((i=>i.sash===e)),n=combinedDisposable(addDisposableListener(document.body,"keydown",(e=>o(this.sashDragState.current,e.altKey))),addDisposableListener(document.body,"keyup",(()=>o(this.sashDragState.current,!1)))),o=(e,i)=>{const t=this.viewItems.map((e=>e.size));let o,a,r=Number.NEGATIVE_INFINITY,h=Number.POSITIVE_INFINITY;if(this.inverseAltBehavior&&(i=!i),i)if(s===this.sashItems.length-1){const e=this.viewItems[s];r=(e.minimumSize-e.size)/2,h=(e.maximumSize-e.size)/2}else{const e=this.viewItems[s+1];r=(e.size-e.maximumSize)/2,h=(e.size-e.minimumSize)/2}if(!i){const e=range(s,-1),i=range(s+1,this.viewItems.length),n=e.reduce(((e,i)=>e+(this.viewItems[i].minimumSize-t[i])),0),r=e.reduce(((e,i)=>e+(this.viewItems[i].viewMaximumSize-t[i])),0),h=0===i.length?Number.POSITIVE_INFINITY:i.reduce(((e,i)=>e+(t[i]-this.viewItems[i].minimumSize)),0),l=0===i.length?Number.NEGATIVE_INFINITY:i.reduce(((e,i)=>e+(t[i]-this.viewItems[i].viewMaximumSize)),0),m=Math.max(n,l),p=Math.min(h,r),d=this.findFirstSnapIndex(e),c=this.findFirstSnapIndex(i);if("number"==typeof d){const e=this.viewItems[d],i=Math.floor(e.viewMinimumSize/2);o={index:d,limitDelta:e.visible?m-i:m+i,size:e.size}}if("number"==typeof c){const e=this.viewItems[c],i=Math.floor(e.viewMinimumSize/2);a={index:c,limitDelta:e.visible?p+i:p-i,size:e.size}}}this.sashDragState={start:e,current:e,index:s,sizes:t,minDelta:r,maxDelta:h,alt:i,snapBefore:o,snapAfter:a,disposable:n}};o(i,t)}onSashChange({current:e}){const{index:i,start:t,sizes:s,alt:n,minDelta:o,maxDelta:a,snapBefore:r,snapAfter:h}=this.sashDragState;this.sashDragState.current=e;const l=e-t,m=this.resize(i,l,s,void 0,void 0,o,a,r,h);if(n){const e=i===this.sashItems.length-1,t=this.viewItems.map((e=>e.size)),s=e?i:i+1,n=this.viewItems[s],o=n.size-n.maximumSize,a=n.size-n.minimumSize,r=e?i-1:i+1;this.resize(r,-m,t,void 0,void 0,o,a)}this.distributeEmptySpace(),this.layoutViews()}onSashEnd(e){this._onDidSashChange.fire(e),this.sashDragState.disposable.dispose(),this.saveProportions();for(const e of this.viewItems)e.enabled=!0}onViewChange(e,i){const t=this.viewItems.indexOf(e);t<0||t>=this.viewItems.length||(i="number"==typeof i?i:e.size,i=clamp(i,e.minimumSize,e.maximumSize),this.inverseAltBehavior&&t>0?(this.resize(t-1,Math.floor((e.size-i)/2)),this.distributeEmptySpace(),this.layoutViews()):(e.size=i,this.relayout([t],void 0)))}resizeView(e,i){if(this.state!==State.Idle)throw new Error("Cant modify splitview");if(this.state=State.Busy,e<0||e>=this.viewItems.length)return;const t=range(this.viewItems.length).filter((i=>i!==e)),s=[...t.filter((e=>1===this.viewItems[e].priority)),e],n=t.filter((e=>2===this.viewItems[e].priority)),o=this.viewItems[e];i=Math.round(i),i=clamp(i,o.minimumSize,Math.min(o.maximumSize,this.size)),o.size=i,this.relayout(s,n),this.state=State.Idle}distributeViewSizes(){const e=[];let i=0;for(const t of this.viewItems)t.maximumSize-t.minimumSize>0&&(e.push(t),i+=t.size);const t=Math.floor(i/e.length);for(const i of e)i.size=clamp(t,i.minimumSize,i.maximumSize);const s=range(this.viewItems.length),n=s.filter((e=>1===this.viewItems[e].priority)),o=s.filter((e=>2===this.viewItems[e].priority));this.relayout(n,o)}getViewSize(e){return e<0||e>=this.viewItems.length?-1:this.viewItems[e].size}doAddView(e,i,t=this.viewItems.length,s){if(this.state!==State.Idle)throw new Error("Cant modify splitview");this.state=State.Busy;const n=$(".split-view-view");t===this.viewItems.length?this.viewContainer.appendChild(n):this.viewContainer.insertBefore(n,this.viewContainer.children.item(t));const o=e.onDidChange((e=>this.onViewChange(l,e))),a=toDisposable((()=>this.viewContainer.removeChild(n))),r=combinedDisposable(o,a);let h;h="number"==typeof i?i:"split"===i.type?this.getViewSize(i.index)/2:"invisible"===i.type?{cachedVisibleSize:i.cachedVisibleSize}:e.minimumSize;const l=0===this.orientation?new VerticalViewItem(n,e,h,r):new HorizontalViewItem(n,e,h,r);if(this.viewItems.splice(t,0,l),this.viewItems.length>1){const e={orthogonalStartSash:this.orthogonalStartSash,orthogonalEndSash:this.orthogonalEndSash},i=0===this.orientation?new Sash(this.sashContainer,{getHorizontalSashTop:e=>this.getSashPosition(e),getHorizontalSashWidth:this.getSashOrthogonalSize},Object.assign(Object.assign({},e),{orientation:1})):new Sash(this.sashContainer,{getVerticalSashLeft:e=>this.getSashPosition(e),getVerticalSashHeight:this.getSashOrthogonalSize},Object.assign(Object.assign({},e),{orientation:0})),s=0===this.orientation?e=>({sash:i,start:e.startY,current:e.currentY,alt:e.altKey}):e=>({sash:i,start:e.startX,current:e.currentX,alt:e.altKey}),n=Event.map(i.onDidStart,s)(this.onSashStart,this),o=Event.map(i.onDidChange,s)(this.onSashChange,this),a=Event.map(i.onDidEnd,(()=>this.sashItems.findIndex((e=>e.sash===i)))),r=a(this.onSashEnd,this),h=i.onDidReset((()=>{const e=this.sashItems.findIndex((e=>e.sash===i)),t=range(e,-1),s=range(e+1,this.viewItems.length),n=this.findFirstSnapIndex(t),o=this.findFirstSnapIndex(s);("number"!=typeof n||this.viewItems[n].visible)&&("number"!=typeof o||this.viewItems[o].visible)&&this._onDidSashReset.fire(e)})),l=combinedDisposable(n,o,r,h,i),m={sash:i,disposable:l};this.sashItems.splice(t-1,0,m)}let m;n.appendChild(e.element),"number"!=typeof i&&"split"===i.type&&(m=[i.index]),s||this.relayout([t],m),this.state=State.Idle,s||"number"==typeof i||"distribute"!==i.type||this.distributeViewSizes()}relayout(e,i){const t=this.viewItems.reduce(((e,i)=>e+i.size),0);this.resize(this.viewItems.length-1,this.size-t,void 0,e,i),this.distributeEmptySpace(),this.layoutViews(),this.saveProportions()}resize(e,i,t=this.viewItems.map((e=>e.size)),s,n,o=Number.NEGATIVE_INFINITY,a=Number.POSITIVE_INFINITY,r,h){if(e<0||e>=this.viewItems.length)return 0;const l=range(e,-1),m=range(e+1,this.viewItems.length);if(n)for(const e of n)pushToStart(l,e),pushToStart(m,e);if(s)for(const e of s)pushToEnd(l,e),pushToEnd(m,e);const p=l.map((e=>this.viewItems[e])),d=l.map((e=>t[e])),c=m.map((e=>this.viewItems[e])),S=m.map((e=>t[e])),u=l.reduce(((e,i)=>e+(this.viewItems[i].minimumSize-t[i])),0),v=l.reduce(((e,i)=>e+(this.viewItems[i].maximumSize-t[i])),0),z=0===m.length?Number.POSITIVE_INFINITY:m.reduce(((e,i)=>e+(t[i]-this.viewItems[i].minimumSize)),0),w=0===m.length?Number.NEGATIVE_INFINITY:m.reduce(((e,i)=>e+(t[i]-this.viewItems[i].maximumSize)),0),I=Math.max(u,w,o),b=Math.min(z,v,a);let g=!1;if(r){const e=this.viewItems[r.index],t=i>=r.limitDelta;g=t!==e.visible,e.setVisible(t,r.size)}if(!g&&h){const e=this.viewItems[h.index],t=i<h.limitDelta;g=t!==e.visible,e.setVisible(t,h.size)}if(g)return this.resize(e,i,t,s,n,o,a);for(let e=0,t=i=clamp(i,I,b);e<p.length;e++){const i=p[e],s=clamp(d[e]+t,i.minimumSize,i.maximumSize);t-=s-d[e],i.size=s}for(let e=0,t=i;e<c.length;e++){const i=c[e],s=clamp(S[e]-t,i.minimumSize,i.maximumSize);t+=s-S[e],i.size=s}return i}distributeEmptySpace(e){const i=this.viewItems.reduce(((e,i)=>e+i.size),0);let t=this.size-i;const s=range(this.viewItems.length-1,-1),n=s.filter((e=>1===this.viewItems[e].priority)),o=s.filter((e=>2===this.viewItems[e].priority));for(const e of o)pushToStart(s,e);for(const e of n)pushToEnd(s,e);"number"==typeof e&&pushToEnd(s,e);for(let e=0;0!==t&&e<s.length;e++){const i=this.viewItems[s[e]],n=clamp(i.size+t,i.minimumSize,i.maximumSize);t-=n-i.size,i.size=n}}layoutViews(){this.contentSize=this.viewItems.reduce(((e,i)=>e+i.size),0);let e=0;for(const i of this.viewItems)i.layout(e,this.layoutContext),e+=i.size;this.sashItems.forEach((e=>e.sash.layout())),this.updateSashEnablement(),this.updateScrollableElement()}updateScrollableElement(){0===this.orientation?this.scrollableElement.setScrollDimensions({height:this.size,scrollHeight:this.contentSize}):this.scrollableElement.setScrollDimensions({width:this.size,scrollWidth:this.contentSize})}updateSashEnablement(){let e=!1;const i=this.viewItems.map((i=>e=i.size-i.minimumSize>0||e));e=!1;const t=this.viewItems.map((i=>e=i.maximumSize-i.size>0||e)),s=[...this.viewItems].reverse();e=!1;const n=s.map((i=>e=i.size-i.minimumSize>0||e)).reverse();e=!1;const o=s.map((i=>e=i.maximumSize-i.size>0||e)).reverse();let a=0;for(let e=0;e<this.sashItems.length;e++){const{sash:s}=this.sashItems[e];a+=this.viewItems[e].size;const r=!(i[e]&&o[e+1]),h=!(t[e]&&n[e+1]);if(r&&h){const t=range(e,-1),o=range(e+1,this.viewItems.length),r=this.findFirstSnapIndex(t),h=this.findFirstSnapIndex(o),l="number"==typeof r&&!this.viewItems[r].visible,m="number"==typeof h&&!this.viewItems[h].visible;l&&n[e]&&(a>0||this.startSnappingEnabled)?s.state=1:m&&i[e]&&(a<this.contentSize||this.endSnappingEnabled)?s.state=2:s.state=0}else s.state=r&&!h?1:!r&&h?2:3}}getSashPosition(e){let i=0;for(let t=0;t<this.sashItems.length;t++)if(i+=this.viewItems[t].size,this.sashItems[t].sash===e)return i;return 0}findFirstSnapIndex(e){for(const i of e){const e=this.viewItems[i];if(e.visible&&e.snap)return i}for(const i of e){const e=this.viewItems[i];if(e.visible&&e.maximumSize-e.minimumSize>0)return;if(!e.visible&&e.snap)return i}}dispose(){super.dispose(),dispose(this.viewItems),this.viewItems=[],this.sashItems.forEach((e=>e.disposable.dispose())),this.sashItems=[]}}