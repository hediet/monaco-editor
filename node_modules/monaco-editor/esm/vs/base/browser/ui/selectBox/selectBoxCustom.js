import*as dom from"../../dom.js";import{DomEmitter}from"../../event.js";import{StandardKeyboardEvent}from"../../keyboardEvent.js";import{renderMarkdown}from"../../markdownRenderer.js";import{List}from"../list/listWidget.js";import*as arrays from"../../../common/arrays.js";import{Emitter,Event}from"../../../common/event.js";import{KeyCodeUtils}from"../../../common/keyCodes.js";import{Disposable}from"../../../common/lifecycle.js";import{isMacintosh}from"../../../common/platform.js";import"./selectBoxCustom.css";import{localize}from"../../../../nls.js";const $=dom.$,SELECT_OPTION_ENTRY_TEMPLATE_ID="selectOption.entry.template";class SelectListRenderer{get templateId(){return"selectOption.entry.template"}renderTemplate(e){const t=Object.create(null);return t.root=e,t.text=dom.append(e,$(".option-text")),t.detail=dom.append(e,$(".option-detail")),t.decoratorRight=dom.append(e,$(".option-decorator-right")),t}renderElement(e,t,s){const i=s,o=e.text,n=e.detail,l=e.decoratorRight,r=e.isDisabled;i.text.textContent=o,i.detail.textContent=n||"",i.decoratorRight.innerText=l||"",r?i.root.classList.add("option-disabled"):i.root.classList.remove("option-disabled")}disposeTemplate(e){}}class SelectBoxList extends Disposable{constructor(e,t,s,i,o){super(),this.options=[],this._currentSelection=0,this._hasDetails=!1,this._skipLayout=!1,this._sticky=!1,this._isVisible=!1,this.styles=i,this.selectBoxOptions=o||Object.create(null),"number"!=typeof this.selectBoxOptions.minBottomMargin?this.selectBoxOptions.minBottomMargin=SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_BOTTOM_MARGIN:this.selectBoxOptions.minBottomMargin<0&&(this.selectBoxOptions.minBottomMargin=0),this.selectElement=document.createElement("select"),this.selectElement.className="monaco-select-box monaco-select-box-dropdown-padding","string"==typeof this.selectBoxOptions.ariaLabel&&this.selectElement.setAttribute("aria-label",this.selectBoxOptions.ariaLabel),"string"==typeof this.selectBoxOptions.ariaDescription&&this.selectElement.setAttribute("aria-description",this.selectBoxOptions.ariaDescription),this._onDidSelect=new Emitter,this._register(this._onDidSelect),this.registerListeners(),this.constructSelectDropDown(s),this.selected=t||0,e&&this.setOptions(e,t),this.initStyleSheet()}getHeight(){return 22}getTemplateId(){return"selectOption.entry.template"}constructSelectDropDown(e){this.contextViewProvider=e,this.selectDropDownContainer=dom.$(".monaco-select-box-dropdown-container"),this.selectDropDownContainer.classList.add("monaco-select-box-dropdown-padding"),this.selectionDetailsPane=dom.append(this.selectDropDownContainer,$(".select-box-details-pane"));const t=dom.append(this.selectDropDownContainer,$(".select-box-dropdown-container-width-control")),s=dom.append(t,$(".width-control-div"));this.widthControlElement=document.createElement("span"),this.widthControlElement.className="option-text-width-control",dom.append(s,this.widthControlElement),this._dropDownPosition=0,this.styleElement=dom.createStyleSheet(this.selectDropDownContainer),this.selectDropDownContainer.setAttribute("draggable","true"),this._register(dom.addDisposableListener(this.selectDropDownContainer,dom.EventType.DRAG_START,(e=>{dom.EventHelper.stop(e,!0)})))}registerListeners(){let e;this._register(dom.addStandardDisposableListener(this.selectElement,"change",(e=>{this.selected=e.target.selectedIndex,this._onDidSelect.fire({index:e.target.selectedIndex,selected:e.target.value}),this.options[this.selected]&&this.options[this.selected].text&&(this.selectElement.title=this.options[this.selected].text)}))),this._register(dom.addDisposableListener(this.selectElement,dom.EventType.CLICK,(e=>{dom.EventHelper.stop(e),this._isVisible?this.hideSelectDropDown(!0):this.showSelectDropDown()}))),this._register(dom.addDisposableListener(this.selectElement,dom.EventType.MOUSE_DOWN,(e=>{dom.EventHelper.stop(e)}))),this._register(dom.addDisposableListener(this.selectElement,"touchstart",(t=>{e=this._isVisible}))),this._register(dom.addDisposableListener(this.selectElement,"touchend",(t=>{dom.EventHelper.stop(t),e?this.hideSelectDropDown(!0):this.showSelectDropDown()}))),this._register(dom.addDisposableListener(this.selectElement,dom.EventType.KEY_DOWN,(e=>{const t=new StandardKeyboardEvent(e);let s=!1;isMacintosh?18!==t.keyCode&&16!==t.keyCode&&10!==t.keyCode&&3!==t.keyCode||(s=!0):(18===t.keyCode&&t.altKey||16===t.keyCode&&t.altKey||10===t.keyCode||3===t.keyCode)&&(s=!0),s&&(this.showSelectDropDown(),dom.EventHelper.stop(e,!0))})))}get onDidSelect(){return this._onDidSelect.event}setOptions(e,t){arrays.equals(this.options,e)||(this.options=e,this.selectElement.options.length=0,this._hasDetails=!1,this._cachedMaxDetailsHeight=void 0,this.options.forEach(((e,t)=>{this.selectElement.add(this.createOption(e.text,t,e.isDisabled)),"string"==typeof e.description&&(this._hasDetails=!0)}))),void 0!==t&&(this.select(t),this._currentSelection=this.selected)}setOptionsList(){var e;null===(e=this.selectList)||void 0===e||e.splice(0,this.selectList.length,this.options)}select(e){e>=0&&e<this.options.length?this.selected=e:e>this.options.length-1?this.select(this.options.length-1):this.selected<0&&(this.selected=0),this.selectElement.selectedIndex=this.selected,this.options[this.selected]&&this.options[this.selected].text&&(this.selectElement.title=this.options[this.selected].text)}focus(){this.selectElement&&(this.selectElement.tabIndex=0,this.selectElement.focus())}blur(){this.selectElement&&(this.selectElement.tabIndex=-1,this.selectElement.blur())}setFocusable(e){this.selectElement.tabIndex=e?0:-1}render(e){this.container=e,e.classList.add("select-container"),e.appendChild(this.selectElement),this.styleSelectElement()}initStyleSheet(){const e=[];this.styles.listFocusBackground&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row.focused { background-color: ${this.styles.listFocusBackground} !important; }`),this.styles.listFocusForeground&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row.focused { color: ${this.styles.listFocusForeground} !important; }`),this.styles.decoratorRightForeground&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row:not(.focused) .option-decorator-right { color: ${this.styles.decoratorRightForeground}; }`),this.styles.selectBackground&&this.styles.selectBorder&&this.styles.selectBorder!==this.styles.selectBackground?(e.push(`.monaco-select-box-dropdown-container { border: 1px solid ${this.styles.selectBorder} } `),e.push(`.monaco-select-box-dropdown-container > .select-box-details-pane.border-top { border-top: 1px solid ${this.styles.selectBorder} } `),e.push(`.monaco-select-box-dropdown-container > .select-box-details-pane.border-bottom { border-bottom: 1px solid ${this.styles.selectBorder} } `)):this.styles.selectListBorder&&(e.push(`.monaco-select-box-dropdown-container > .select-box-details-pane.border-top { border-top: 1px solid ${this.styles.selectListBorder} } `),e.push(`.monaco-select-box-dropdown-container > .select-box-details-pane.border-bottom { border-bottom: 1px solid ${this.styles.selectListBorder} } `)),this.styles.listHoverForeground&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row:not(.option-disabled):not(.focused):hover { color: ${this.styles.listHoverForeground} !important; }`),this.styles.listHoverBackground&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row:not(.option-disabled):not(.focused):hover { background-color: ${this.styles.listHoverBackground} !important; }`),this.styles.listFocusOutline&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row.focused { outline: 1.6px dotted ${this.styles.listFocusOutline} !important; outline-offset: -1.6px !important; }`),this.styles.listHoverOutline&&e.push(`.monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row:not(.option-disabled):not(.focused):hover { outline: 1.6px dashed ${this.styles.listHoverOutline} !important; outline-offset: -1.6px !important; }`),e.push(".monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row.option-disabled.focused { background-color: transparent !important; color: inherit !important; outline: none !important; }"),e.push(".monaco-select-box-dropdown-container > .select-box-dropdown-list-container .monaco-list .monaco-list-row.option-disabled:hover { background-color: transparent !important; color: inherit !important; outline: none !important; }"),this.styleElement.textContent=e.join("\n")}styleSelectElement(){var e,t,s;const i=null!==(e=this.styles.selectBackground)&&void 0!==e?e:"",o=null!==(t=this.styles.selectForeground)&&void 0!==t?t:"",n=null!==(s=this.styles.selectBorder)&&void 0!==s?s:"";this.selectElement.style.backgroundColor=i,this.selectElement.style.color=o,this.selectElement.style.borderColor=n}styleList(){var e,t;const s=null!==(e=this.styles.selectBackground)&&void 0!==e?e:"",i=dom.asCssValueWithDefault(this.styles.selectListBackground,s);this.selectDropDownListContainer.style.backgroundColor=i,this.selectionDetailsPane.style.backgroundColor=i;const o=null!==(t=this.styles.focusBorder)&&void 0!==t?t:"";this.selectDropDownContainer.style.outlineColor=o,this.selectDropDownContainer.style.outlineOffset="-1px",this.selectList.style(this.styles)}createOption(e,t,s){const i=document.createElement("option");return i.value=e,i.text=e,i.disabled=!!s,i}showSelectDropDown(){this.selectionDetailsPane.innerText="",this.contextViewProvider&&!this._isVisible&&(this.createSelectList(this.selectDropDownContainer),this.setOptionsList(),this.contextViewProvider.showContextView({getAnchor:()=>this.selectElement,render:e=>this.renderSelectDropDown(e,!0),layout:()=>{this.layoutSelectDropDown()},onHide:()=>{this.selectDropDownContainer.classList.remove("visible"),this.selectElement.classList.remove("synthetic-focus")},anchorPosition:this._dropDownPosition},this.selectBoxOptions.optionsAsChildren?this.container:void 0),this._isVisible=!0,this.hideSelectDropDown(!1),this.contextViewProvider.showContextView({getAnchor:()=>this.selectElement,render:e=>this.renderSelectDropDown(e),layout:()=>this.layoutSelectDropDown(),onHide:()=>{this.selectDropDownContainer.classList.remove("visible"),this.selectElement.classList.remove("synthetic-focus")},anchorPosition:this._dropDownPosition},this.selectBoxOptions.optionsAsChildren?this.container:void 0),this._currentSelection=this.selected,this._isVisible=!0,this.selectElement.setAttribute("aria-expanded","true"))}hideSelectDropDown(e){this.contextViewProvider&&this._isVisible&&(this._isVisible=!1,this.selectElement.setAttribute("aria-expanded","false"),e&&this.selectElement.focus(),this.contextViewProvider.hideContextView())}renderSelectDropDown(e,t){return e.appendChild(this.selectDropDownContainer),this.layoutSelectDropDown(t),{dispose:()=>{try{e.removeChild(this.selectDropDownContainer)}catch(e){}}}}measureMaxDetailsHeight(){let e=0;return this.options.forEach(((t,s)=>{this.updateDetail(s),this.selectionDetailsPane.offsetHeight>e&&(e=this.selectionDetailsPane.offsetHeight)})),e}layoutSelectDropDown(e){if(this._skipLayout)return!1;if(this.selectList){this.selectDropDownContainer.classList.add("visible");const t=dom.getDomNodePagePosition(this.selectElement),s=getComputedStyle(this.selectElement),i=parseFloat(s.getPropertyValue("--dropdown-padding-top"))+parseFloat(s.getPropertyValue("--dropdown-padding-bottom")),o=window.innerHeight-t.top-t.height-(this.selectBoxOptions.minBottomMargin||0),n=t.top-SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_TOP_MARGIN,l=this.selectElement.offsetWidth,r=this.setWidthControlElement(this.widthControlElement),c=Math.max(r,Math.round(l)).toString()+"px";this.selectDropDownContainer.style.width=c,this.selectList.getHTMLElement().style.height="",this.selectList.layout();let h=this.selectList.contentHeight;this._hasDetails&&void 0===this._cachedMaxDetailsHeight&&(this._cachedMaxDetailsHeight=this.measureMaxDetailsHeight());const d=this._hasDetails?this._cachedMaxDetailsHeight:0,a=h+i+d,p=Math.floor((o-i-d)/this.getHeight()),m=Math.floor((n-i-d)/this.getHeight());if(e)return!(t.top+t.height>window.innerHeight-22||t.top<SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_TOP_MARGIN||p<1&&m<1||(p<SelectBoxList.DEFAULT_MINIMUM_VISIBLE_OPTIONS&&m>p&&this.options.length>p?(this._dropDownPosition=1,this.selectDropDownContainer.removeChild(this.selectDropDownListContainer),this.selectDropDownContainer.removeChild(this.selectionDetailsPane),this.selectDropDownContainer.appendChild(this.selectionDetailsPane),this.selectDropDownContainer.appendChild(this.selectDropDownListContainer),this.selectionDetailsPane.classList.remove("border-top"),this.selectionDetailsPane.classList.add("border-bottom")):(this._dropDownPosition=0,this.selectDropDownContainer.removeChild(this.selectDropDownListContainer),this.selectDropDownContainer.removeChild(this.selectionDetailsPane),this.selectDropDownContainer.appendChild(this.selectDropDownListContainer),this.selectDropDownContainer.appendChild(this.selectionDetailsPane),this.selectionDetailsPane.classList.remove("border-bottom"),this.selectionDetailsPane.classList.add("border-top")),0));if(t.top+t.height>window.innerHeight-22||t.top<SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_TOP_MARGIN||0===this._dropDownPosition&&p<1||1===this._dropDownPosition&&m<1)return this.hideSelectDropDown(!0),!1;if(0===this._dropDownPosition){if(this._isVisible&&p+m<1)return this.hideSelectDropDown(!0),!1;a>o&&(h=p*this.getHeight())}else a>n&&(h=m*this.getHeight());return this.selectList.layout(h),this.selectList.domFocus(),this.selectList.length>0&&(this.selectList.setFocus([this.selected||0]),this.selectList.reveal(this.selectList.getFocus()[0]||0)),this._hasDetails?(this.selectList.getHTMLElement().style.height=h+i+"px",this.selectDropDownContainer.style.height=""):this.selectDropDownContainer.style.height=h+i+"px",this.updateDetail(this.selected),this.selectDropDownContainer.style.width=c,this.selectDropDownListContainer.setAttribute("tabindex","0"),this.selectElement.classList.add("synthetic-focus"),this.selectDropDownContainer.classList.add("synthetic-focus"),!0}return!1}setWidthControlElement(e){let t=0;if(e){let s=0,i=0;this.options.forEach(((e,t)=>{const o=e.detail?e.detail.length:0,n=e.decoratorRight?e.decoratorRight.length:0,l=e.text.length+o+n;l>i&&(s=t,i=l)})),e.textContent=this.options[s].text+(this.options[s].decoratorRight?this.options[s].decoratorRight+" ":""),t=dom.getTotalWidth(e)}return t}createSelectList(e){if(this.selectList)return;this.selectDropDownListContainer=dom.append(e,$(".select-box-dropdown-list-container")),this.listRenderer=new SelectListRenderer,this.selectList=new List("SelectBoxCustom",this.selectDropDownListContainer,this,[this.listRenderer],{useShadows:!1,verticalScrollMode:3,keyboardSupport:!1,mouseSupport:!1,accessibilityProvider:{getAriaLabel:e=>{let t=e.text;return e.detail&&(t+=`. ${e.detail}`),e.decoratorRight&&(t+=`. ${e.decoratorRight}`),e.description&&(t+=`. ${e.description}`),t},getWidgetAriaLabel:()=>localize({key:"selectBox",comment:["Behave like native select dropdown element."]},"Select Box"),getRole:()=>"option",getWidgetRole:()=>"listbox"}}),this.selectBoxOptions.ariaLabel&&(this.selectList.ariaLabel=this.selectBoxOptions.ariaLabel);const t=this._register(new DomEmitter(this.selectDropDownListContainer,"keydown")),s=Event.chain(t.event).filter((()=>this.selectList.length>0)).map((e=>new StandardKeyboardEvent(e)));this._register(s.filter((e=>3===e.keyCode)).on((e=>this.onEnter(e)),this)),this._register(s.filter((e=>2===e.keyCode)).on((e=>this.onEnter(e)),this)),this._register(s.filter((e=>9===e.keyCode)).on((e=>this.onEscape(e)),this)),this._register(s.filter((e=>16===e.keyCode)).on((e=>this.onUpArrow(e)),this)),this._register(s.filter((e=>18===e.keyCode)).on((e=>this.onDownArrow(e)),this)),this._register(s.filter((e=>12===e.keyCode)).on(this.onPageDown,this)),this._register(s.filter((e=>11===e.keyCode)).on(this.onPageUp,this)),this._register(s.filter((e=>14===e.keyCode)).on(this.onHome,this)),this._register(s.filter((e=>13===e.keyCode)).on(this.onEnd,this)),this._register(s.filter((e=>e.keyCode>=21&&e.keyCode<=56||e.keyCode>=80&&e.keyCode<=108)).on(this.onCharacter,this)),this._register(dom.addDisposableListener(this.selectList.getHTMLElement(),dom.EventType.POINTER_UP,(e=>this.onPointerUp(e)))),this._register(this.selectList.onMouseOver((e=>void 0!==e.index&&this.selectList.setFocus([e.index])))),this._register(this.selectList.onDidChangeFocus((e=>this.onListFocus(e)))),this._register(dom.addDisposableListener(this.selectDropDownContainer,dom.EventType.FOCUS_OUT,(e=>{this._isVisible&&!dom.isAncestor(e.relatedTarget,this.selectDropDownContainer)&&this.onListBlur()}))),this.selectList.getHTMLElement().setAttribute("aria-label",this.selectBoxOptions.ariaLabel||""),this.selectList.getHTMLElement().setAttribute("aria-expanded","true"),this.styleList()}onPointerUp(e){if(!this.selectList.length)return;dom.EventHelper.stop(e);const t=e.target;if(!t)return;if(t.classList.contains("slider"))return;const s=t.closest(".monaco-list-row");if(!s)return;const i=Number(s.getAttribute("data-index")),o=s.classList.contains("option-disabled");i>=0&&i<this.options.length&&!o&&(this.selected=i,this.select(this.selected),this.selectList.setFocus([this.selected]),this.selectList.reveal(this.selectList.getFocus()[0]),this.selected!==this._currentSelection&&(this._currentSelection=this.selected,this._onDidSelect.fire({index:this.selectElement.selectedIndex,selected:this.options[this.selected].text}),this.options[this.selected]&&this.options[this.selected].text&&(this.selectElement.title=this.options[this.selected].text)),this.hideSelectDropDown(!0))}onListBlur(){this._sticky||(this.selected!==this._currentSelection&&this.select(this._currentSelection),this.hideSelectDropDown(!1))}renderDescriptionMarkdown(e,t){const s=e=>{for(let t=0;t<e.childNodes.length;t++){const i=e.childNodes.item(t);"img"===(i.tagName&&i.tagName.toLowerCase())?e.removeChild(i):s(i)}},i=renderMarkdown({value:e,supportThemeIcons:!0},{actionHandler:t});return i.element.classList.add("select-box-description-markdown"),s(i.element),i.element}onListFocus(e){this._isVisible&&this._hasDetails&&this.updateDetail(e.indexes[0])}updateDetail(e){var t,s;this.selectionDetailsPane.innerText="";const i=this.options[e],o=null!==(t=null==i?void 0:i.description)&&void 0!==t?t:"",n=null!==(s=null==i?void 0:i.descriptionIsMarkdown)&&void 0!==s&&s;if(o){if(n){const e=i.descriptionMarkdownActionHandler;this.selectionDetailsPane.appendChild(this.renderDescriptionMarkdown(o,e))}else this.selectionDetailsPane.innerText=o;this.selectionDetailsPane.style.display="block"}else this.selectionDetailsPane.style.display="none";this._skipLayout=!0,this.contextViewProvider.layout(),this._skipLayout=!1}onEscape(e){dom.EventHelper.stop(e),this.select(this._currentSelection),this.hideSelectDropDown(!0)}onEnter(e){dom.EventHelper.stop(e),this.selected!==this._currentSelection&&(this._currentSelection=this.selected,this._onDidSelect.fire({index:this.selectElement.selectedIndex,selected:this.options[this.selected].text}),this.options[this.selected]&&this.options[this.selected].text&&(this.selectElement.title=this.options[this.selected].text)),this.hideSelectDropDown(!0)}onDownArrow(e){if(this.selected<this.options.length-1){dom.EventHelper.stop(e,!0);const t=this.options[this.selected+1].isDisabled;if(t&&this.options.length>this.selected+2)this.selected+=2;else{if(t)return;this.selected++}this.select(this.selected),this.selectList.setFocus([this.selected]),this.selectList.reveal(this.selectList.getFocus()[0])}}onUpArrow(e){this.selected>0&&(dom.EventHelper.stop(e,!0),this.options[this.selected-1].isDisabled&&this.selected>1?this.selected-=2:this.selected--,this.select(this.selected),this.selectList.setFocus([this.selected]),this.selectList.reveal(this.selectList.getFocus()[0]))}onPageUp(e){dom.EventHelper.stop(e),this.selectList.focusPreviousPage(),setTimeout((()=>{this.selected=this.selectList.getFocus()[0],this.options[this.selected].isDisabled&&this.selected<this.options.length-1&&(this.selected++,this.selectList.setFocus([this.selected])),this.selectList.reveal(this.selected),this.select(this.selected)}),1)}onPageDown(e){dom.EventHelper.stop(e),this.selectList.focusNextPage(),setTimeout((()=>{this.selected=this.selectList.getFocus()[0],this.options[this.selected].isDisabled&&this.selected>0&&(this.selected--,this.selectList.setFocus([this.selected])),this.selectList.reveal(this.selected),this.select(this.selected)}),1)}onHome(e){dom.EventHelper.stop(e),this.options.length<2||(this.selected=0,this.options[this.selected].isDisabled&&this.selected>1&&this.selected++,this.selectList.setFocus([this.selected]),this.selectList.reveal(this.selected),this.select(this.selected))}onEnd(e){dom.EventHelper.stop(e),this.options.length<2||(this.selected=this.options.length-1,this.options[this.selected].isDisabled&&this.selected>1&&this.selected--,this.selectList.setFocus([this.selected]),this.selectList.reveal(this.selected),this.select(this.selected))}onCharacter(e){const t=KeyCodeUtils.toString(e.keyCode);let s=-1;for(let i=0;i<this.options.length-1;i++)if(s=(i+this.selected+1)%this.options.length,this.options[s].text.charAt(0).toUpperCase()===t&&!this.options[s].isDisabled){this.select(s),this.selectList.setFocus([s]),this.selectList.reveal(this.selectList.getFocus()[0]),dom.EventHelper.stop(e);break}}dispose(){this.hideSelectDropDown(!1),super.dispose()}}SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_BOTTOM_MARGIN=32,SelectBoxList.DEFAULT_DROPDOWN_MINIMUM_TOP_MARGIN=2,SelectBoxList.DEFAULT_MINIMUM_VISIBLE_OPTIONS=3;export{SelectBoxList};