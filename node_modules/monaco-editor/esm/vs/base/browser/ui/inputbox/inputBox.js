import*as dom from"../../dom.js";import{DomEmitter}from"../../event.js";import{renderFormattedText,renderText}from"../../formattedTextRenderer.js";import{ActionBar}from"../actionbar/actionbar.js";import*as aria from"../aria/aria.js";import{ScrollableElement}from"../scrollbar/scrollableElement.js";import{Widget}from"../widget.js";import{Emitter,Event}from"../../../common/event.js";import{HistoryNavigator}from"../../../common/history.js";import"./inputBox.css";import*as nls from"../../../../nls.js";const $=dom.$;export const unthemedInboxStyles={inputBackground:"#3C3C3C",inputForeground:"#CCCCCC",inputValidationInfoBorder:"#55AAFF",inputValidationInfoBackground:"#063B49",inputValidationWarningBorder:"#B89500",inputValidationWarningBackground:"#352A05",inputValidationErrorBorder:"#BE1100",inputValidationErrorBackground:"#5A1D1D",inputBorder:void 0,inputValidationErrorForeground:void 0,inputValidationInfoForeground:void 0,inputValidationWarningForeground:void 0};export class InputBox extends Widget{constructor(t,e,i){var s;super(),this.state="idle",this.maxHeight=Number.POSITIVE_INFINITY,this._onDidChange=this._register(new Emitter),this.onDidChange=this._onDidChange.event,this._onDidHeightChange=this._register(new Emitter),this.onDidHeightChange=this._onDidHeightChange.event,this.contextViewProvider=e,this.options=i,this.message=null,this.placeholder=this.options.placeholder||"",this.tooltip=null!==(s=this.options.tooltip)&&void 0!==s?s:this.placeholder||"",this.ariaLabel=this.options.ariaLabel||"",this.options.validationOptions&&(this.validation=this.options.validationOptions.validation),this.element=dom.append(t,$(".monaco-inputbox.idle"));const o=this.options.flexibleHeight?"textarea":"input",r=dom.append(this.element,$(".ibwrapper"));if(this.input=dom.append(r,$(o+".input.empty")),this.input.setAttribute("autocorrect","off"),this.input.setAttribute("autocapitalize","off"),this.input.setAttribute("spellcheck","false"),this.onfocus(this.input,(()=>this.element.classList.add("synthetic-focus"))),this.onblur(this.input,(()=>this.element.classList.remove("synthetic-focus"))),this.options.flexibleHeight){this.maxHeight="number"==typeof this.options.flexibleMaxHeight?this.options.flexibleMaxHeight:Number.POSITIVE_INFINITY,this.mirror=dom.append(r,$("div.mirror")),this.mirror.innerText=" ",this.scrollableElement=new ScrollableElement(this.element,{vertical:1}),this.options.flexibleWidth&&(this.input.setAttribute("wrap","off"),this.mirror.style.whiteSpace="pre",this.mirror.style.wordWrap="initial"),dom.append(t,this.scrollableElement.getDomNode()),this._register(this.scrollableElement),this._register(this.scrollableElement.onScroll((t=>this.input.scrollTop=t.scrollTop)));const e=this._register(new DomEmitter(document,"selectionchange")),i=Event.filter(e.event,(()=>{const t=document.getSelection();return(null==t?void 0:t.anchorNode)===r}));this._register(i(this.updateScrollDimensions,this)),this._register(this.onDidHeightChange(this.updateScrollDimensions,this))}else this.input.type=this.options.type||"text",this.input.setAttribute("wrap","off");this.ariaLabel&&this.input.setAttribute("aria-label",this.ariaLabel),this.placeholder&&!this.options.showPlaceholderOnFocus&&this.setPlaceHolder(this.placeholder),this.tooltip&&this.setTooltip(this.tooltip),this.oninput(this.input,(()=>this.onValueChange())),this.onblur(this.input,(()=>this.onBlur())),this.onfocus(this.input,(()=>this.onFocus())),this._register(this.ignoreGesture(this.input)),setTimeout((()=>this.updateMirror()),0),this.options.actions&&(this.actionbar=this._register(new ActionBar(this.element)),this.actionbar.push(this.options.actions,{icon:!0,label:!1})),this.applyStyles()}onBlur(){this._hideMessage(),this.options.showPlaceholderOnFocus&&this.input.setAttribute("placeholder","")}onFocus(){this._showMessage(),this.options.showPlaceholderOnFocus&&this.input.setAttribute("placeholder",this.placeholder||"")}setPlaceHolder(t){this.placeholder=t,this.input.setAttribute("placeholder",t)}setTooltip(t){this.tooltip=t,this.input.title=t}setAriaLabel(t){this.ariaLabel=t,t?this.input.setAttribute("aria-label",this.ariaLabel):this.input.removeAttribute("aria-label")}getAriaLabel(){return this.ariaLabel}get inputElement(){return this.input}get value(){return this.input.value}set value(t){this.input.value!==t&&(this.input.value=t,this.onValueChange())}get height(){return"number"==typeof this.cachedHeight?this.cachedHeight:dom.getTotalHeight(this.element)}focus(){this.input.focus()}blur(){this.input.blur()}hasFocus(){return document.activeElement===this.input}select(t=null){this.input.select(),t&&(this.input.setSelectionRange(t.start,t.end),t.end===this.input.value.length&&(this.input.scrollLeft=this.input.scrollWidth))}isSelectionAtEnd(){return this.input.selectionEnd===this.input.value.length&&this.input.selectionStart===this.input.selectionEnd}enable(){this.input.removeAttribute("disabled")}disable(){this.blur(),this.input.disabled=!0,this._hideMessage()}set paddingRight(t){this.input.style.width=`calc(100% - ${t}px)`,this.mirror&&(this.mirror.style.paddingRight=t+"px")}updateScrollDimensions(){if("number"!=typeof this.cachedContentHeight||"number"!=typeof this.cachedHeight||!this.scrollableElement)return;const t=this.cachedContentHeight,e=this.cachedHeight,i=this.input.scrollTop;this.scrollableElement.setScrollDimensions({scrollHeight:t,height:e}),this.scrollableElement.setScrollPosition({scrollTop:i})}showMessage(t,e){this.message=t,this.element.classList.remove("idle"),this.element.classList.remove("info"),this.element.classList.remove("warning"),this.element.classList.remove("error"),this.element.classList.add(this.classForType(t.type));const i=this.stylesForType(this.message.type);this.element.style.border=`1px solid ${dom.asCssValueWithDefault(i.border,"transparent")}`,this.message.content&&(this.hasFocus()||e)&&this._showMessage()}hideMessage(){this.message=null,this.element.classList.remove("info"),this.element.classList.remove("warning"),this.element.classList.remove("error"),this.element.classList.add("idle"),this._hideMessage(),this.applyStyles()}validate(){let t=null;return this.validation&&(t=this.validation(this.value),t?(this.inputElement.setAttribute("aria-invalid","true"),this.showMessage(t)):this.inputElement.hasAttribute("aria-invalid")&&(this.inputElement.removeAttribute("aria-invalid"),this.hideMessage())),null==t?void 0:t.type}stylesForType(t){const e=this.options.inputBoxStyles;switch(t){case 1:return{border:e.inputValidationInfoBorder,background:e.inputValidationInfoBackground,foreground:e.inputValidationInfoForeground};case 2:return{border:e.inputValidationWarningBorder,background:e.inputValidationWarningBackground,foreground:e.inputValidationWarningForeground};default:return{border:e.inputValidationErrorBorder,background:e.inputValidationErrorBackground,foreground:e.inputValidationErrorForeground}}}classForType(t){switch(t){case 1:return"info";case 2:return"warning";default:return"error"}}_showMessage(){if(!this.contextViewProvider||!this.message)return;let t;const e=()=>t.style.width=dom.getTotalWidth(this.element)+"px";let i;this.contextViewProvider.showContextView({getAnchor:()=>this.element,anchorAlignment:1,render:i=>{var s,o;if(!this.message)return null;t=dom.append(i,$(".monaco-inputbox-container")),e();const r={inline:!0,className:"monaco-inputbox-message"},n=this.message.formatContent?renderFormattedText(this.message.content,r):renderText(this.message.content,r);n.classList.add(this.classForType(this.message.type));const h=this.stylesForType(this.message.type);return n.style.backgroundColor=null!==(s=h.background)&&void 0!==s?s:"",n.style.color=null!==(o=h.foreground)&&void 0!==o?o:"",n.style.border=h.border?`1px solid ${h.border}`:"",dom.append(t,n),null},onHide:()=>{this.state="closed"},layout:e}),i=3===this.message.type?nls.localize("alertErrorMessage","Error: {0}",this.message.content):2===this.message.type?nls.localize("alertWarningMessage","Warning: {0}",this.message.content):nls.localize("alertInfoMessage","Info: {0}",this.message.content),aria.alert(i),this.state="open"}_hideMessage(){this.contextViewProvider&&("open"===this.state&&this.contextViewProvider.hideContextView(),this.state="idle")}onValueChange(){this._onDidChange.fire(this.value),this.validate(),this.updateMirror(),this.input.classList.toggle("empty",!this.value),"open"===this.state&&this.contextViewProvider&&this.contextViewProvider.layout()}updateMirror(){if(!this.mirror)return;const t=this.value,e=10===t.charCodeAt(t.length-1)?" ":"";(t+e).replace(/\u000c/g,"")?this.mirror.textContent=t+e:this.mirror.innerText=" ",this.layout()}applyStyles(){var t,e,i;const s=this.options.inputBoxStyles,o=null!==(t=s.inputBackground)&&void 0!==t?t:"",r=null!==(e=s.inputForeground)&&void 0!==e?e:"",n=null!==(i=s.inputBorder)&&void 0!==i?i:"";this.element.style.backgroundColor=o,this.element.style.color=r,this.input.style.backgroundColor="inherit",this.input.style.color=r,this.element.style.border=`1px solid ${dom.asCssValueWithDefault(n,"transparent")}`}layout(){if(!this.mirror)return;const t=this.cachedContentHeight;this.cachedContentHeight=dom.getTotalHeight(this.mirror),t!==this.cachedContentHeight&&(this.cachedHeight=Math.min(this.cachedContentHeight,this.maxHeight),this.input.style.height=this.cachedHeight+"px",this._onDidHeightChange.fire(this.cachedContentHeight))}insertAtCursor(t){const e=this.inputElement,i=e.selectionStart,s=e.selectionEnd,o=e.value;null!==i&&null!==s&&(this.value=o.substr(0,i)+t+o.substr(s),e.setSelectionRange(i+1,i+1),this.layout())}dispose(){var t;this._hideMessage(),this.message=null,null===(t=this.actionbar)||void 0===t||t.dispose(),super.dispose()}}export class HistoryInputBox extends InputBox{constructor(t,e,i){const s=nls.localize({key:"history.inputbox.hint",comment:["Text will be prefixed with ⇅ plus a single space, then used as a hint where input field keeps history"]},"for history"),o=` or ⇅ ${s}`,r=` (⇅ ${s})`;super(t,e,i),this._onDidFocus=this._register(new Emitter),this.onDidFocus=this._onDidFocus.event,this._onDidBlur=this._register(new Emitter),this.onDidBlur=this._onDidBlur.event,this.history=new HistoryNavigator(i.history,100);const n=()=>{if(i.showHistoryHint&&i.showHistoryHint()&&!this.placeholder.endsWith(o)&&!this.placeholder.endsWith(r)&&this.history.getHistory().length){const t=this.placeholder.endsWith(")")?o:r,e=this.placeholder+t;i.showPlaceholderOnFocus&&document.activeElement!==this.input?this.placeholder=e:this.setPlaceHolder(e)}};this.observer=new MutationObserver(((t,e)=>{t.forEach((t=>{t.target.textContent||n()}))})),this.observer.observe(this.input,{attributeFilter:["class"]}),this.onfocus(this.input,(()=>n())),this.onblur(this.input,(()=>{const t=t=>{if(this.placeholder.endsWith(t)){const e=this.placeholder.slice(0,this.placeholder.length-t.length);return i.showPlaceholderOnFocus?this.placeholder=e:this.setPlaceHolder(e),!0}return!1};t(r)||t(o)}))}dispose(){super.dispose(),this.observer&&(this.observer.disconnect(),this.observer=void 0)}addToHistory(t){this.value&&(t||this.value!==this.getCurrentValue())&&this.history.add(this.value)}isAtLastInHistory(){return this.history.isLast()}isNowhereInHistory(){return this.history.isNowhere()}showNextValue(){this.history.has(this.value)||this.addToHistory();let t=this.getNextValue();t&&(t=t===this.value?this.getNextValue():t),t&&(this.value=t,aria.status(this.value))}showPreviousValue(){this.history.has(this.value)||this.addToHistory();let t=this.getPreviousValue();t&&(t=t===this.value?this.getPreviousValue():t),t&&(this.value=t,aria.status(this.value))}onBlur(){super.onBlur(),this._onDidBlur.fire()}onFocus(){super.onFocus(),this._onDidFocus.fire()}getCurrentValue(){let t=this.history.current();return t||(t=this.history.last(),this.history.next()),t}getPreviousValue(){return this.history.previous()||this.history.first()}getNextValue(){return this.history.next()||this.history.last()}}