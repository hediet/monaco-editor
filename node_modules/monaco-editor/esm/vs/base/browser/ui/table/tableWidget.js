import{$,append,clearNode,createStyleSheet}from"../../dom.js";import{List,unthemedListStyles}from"../list/listWidget.js";import{SplitView}from"../splitview/splitview.js";import{Emitter,Event}from"../../../common/event.js";import{DisposableStore}from"../../../common/lifecycle.js";import"./table.css";class TableListRenderer{constructor(e,t,i){this.columns=e,this.getColumnSize=i,this.templateId=TableListRenderer.TemplateId,this.renderedTemplates=new Set;const s=new Map(t.map((e=>[e.templateId,e])));this.renderers=[];for(const t of e){const e=s.get(t.templateId);if(!e)throw new Error(`Table cell renderer for template id ${t.templateId} not found.`);this.renderers.push(e)}}renderTemplate(e){const t=append(e,$(".monaco-table-tr")),i=[],s=[];for(let e=0;e<this.columns.length;e++){const l=this.renderers[e],o=append(t,$(".monaco-table-td",{"data-col-index":e}));o.style.width=`${this.getColumnSize(e)}px`,i.push(o),s.push(l.renderTemplate(o))}const l={container:e,cellContainers:i,cellTemplateData:s};return this.renderedTemplates.add(l),l}renderElement(e,t,i,s){for(let l=0;l<this.columns.length;l++){const o=this.columns[l].project(e);this.renderers[l].renderElement(o,t,i.cellTemplateData[l],s)}}disposeElement(e,t,i,s){for(let l=0;l<this.columns.length;l++){const o=this.renderers[l];if(o.disposeElement){const n=this.columns[l].project(e);o.disposeElement(n,t,i.cellTemplateData[l],s)}}}disposeTemplate(e){for(let t=0;t<this.columns.length;t++)this.renderers[t].disposeTemplate(e.cellTemplateData[t]);clearNode(e.container),this.renderedTemplates.delete(e)}layoutColumn(e,t){for(const{cellContainers:i}of this.renderedTemplates)i[e].style.width=`${t}px`}}function asListVirtualDelegate(e){return{getHeight:t=>e.getHeight(t),getTemplateId:()=>TableListRenderer.TemplateId}}TableListRenderer.TemplateId="row";class ColumnHeader{get minimumSize(){var e;return null!==(e=this.column.minimumWidth)&&void 0!==e?e:120}get maximumSize(){var e;return null!==(e=this.column.maximumWidth)&&void 0!==e?e:Number.POSITIVE_INFINITY}get onDidChange(){var e;return null!==(e=this.column.onDidChangeWidthConstraints)&&void 0!==e?e:Event.None}constructor(e,t){this.column=e,this.index=t,this._onDidLayout=new Emitter,this.onDidLayout=this._onDidLayout.event,this.element=$(".monaco-table-th",{"data-col-index":t,title:e.tooltip},e.label)}layout(e){this._onDidLayout.fire([this.index,e])}}class Table{get onDidChangeFocus(){return this.list.onDidChangeFocus}get onDidChangeSelection(){return this.list.onDidChangeSelection}get onMouseDblClick(){return this.list.onMouseDblClick}get onPointer(){return this.list.onPointer}get onDidFocus(){return this.list.onDidFocus}get onDidDispose(){return this.list.onDidDispose}constructor(e,t,i,s,l,o){this.virtualDelegate=i,this.domId="table_id_"+ ++Table.InstanceCount,this.disposables=new DisposableStore,this.cachedWidth=0,this.cachedHeight=0,this.domNode=append(t,$(`.monaco-table.${this.domId}`));const n=s.map(((e,t)=>new ColumnHeader(e,t))),r={size:n.reduce(((e,t)=>e+t.column.weight),0),views:n.map((e=>({size:e.column.weight,view:e})))};this.splitview=this.disposables.add(new SplitView(this.domNode,{orientation:1,scrollbarVisibility:2,getSashOrthogonalSize:()=>this.cachedHeight,descriptor:r})),this.splitview.el.style.height=`${i.headerRowHeight}px`,this.splitview.el.style.lineHeight=`${i.headerRowHeight}px`;const a=new TableListRenderer(s,l,(e=>this.splitview.getViewSize(e)));this.list=this.disposables.add(new List(e,this.domNode,asListVirtualDelegate(i),[a],o)),Event.any(...n.map((e=>e.onDidLayout)))((([e,t])=>a.layoutColumn(e,t)),null,this.disposables),this.splitview.onDidSashReset((e=>{const t=s.reduce(((e,t)=>e+t.weight),0),i=s[e].weight/t*this.cachedWidth;this.splitview.resizeView(e,i)}),null,this.disposables),this.styleElement=createStyleSheet(this.domNode),this.style(unthemedListStyles)}updateOptions(e){this.list.updateOptions(e)}splice(e,t,i=[]){this.list.splice(e,t,i)}getHTMLElement(){return this.domNode}style(e){const t=[];t.push(`.monaco-table.${this.domId} > .monaco-split-view2 .monaco-sash.vertical::before {\n\t\t\ttop: ${this.virtualDelegate.headerRowHeight+1}px;\n\t\t\theight: calc(100% - ${this.virtualDelegate.headerRowHeight}px);\n\t\t}`),this.styleElement.textContent=t.join("\n"),this.list.style(e)}getSelectedElements(){return this.list.getSelectedElements()}getSelection(){return this.list.getSelection()}getFocus(){return this.list.getFocus()}dispose(){this.disposables.dispose()}}Table.InstanceCount=0;export{Table};