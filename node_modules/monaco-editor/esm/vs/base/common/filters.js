import{LRUCache}from"./map.js";import*as strings from"./strings.js";export function or(...e){return function(t,r){for(let n=0,o=e.length;n<o;n++){const o=e[n](t,r);if(o)return o}return null}}export const matchesStrictPrefix=_matchesPrefix.bind(void 0,!1);export const matchesPrefix=_matchesPrefix.bind(void 0,!0);function _matchesPrefix(e,t,r){if(!r||r.length<t.length)return null;let n;return n=e?strings.startsWithIgnoreCase(r,t):0===r.indexOf(t),n?t.length>0?[{start:0,end:t.length}]:[]:null}export function matchesContiguousSubString(e,t){const r=t.toLowerCase().indexOf(e.toLowerCase());return-1===r?null:[{start:r,end:r+e.length}]}export function matchesSubString(e,t){return _matchesSubString(e.toLowerCase(),t.toLowerCase(),0,0)}function _matchesSubString(e,t,r,n){if(r===e.length)return[];if(n===t.length)return null;if(e[r]===t[n]){let o=null;return(o=_matchesSubString(e,t,r+1,n+1))?join({start:n,end:n+1},o):null}return _matchesSubString(e,t,r,n+1)}function isLower(e){return 97<=e&&e<=122}export function isUpper(e){return 65<=e&&e<=90}function isNumber(e){return 48<=e&&e<=57}function isWhitespace(e){return 32===e||9===e||10===e||13===e}const wordSeparators=new Set;function isWordSeparator(e){return isWhitespace(e)||wordSeparators.has(e)}function charactersMatch(e,t){return e===t||isWordSeparator(e)&&isWordSeparator(t)}function isAlphanumeric(e){return isLower(e)||isUpper(e)||isNumber(e)}function join(e,t){return 0===t.length?t=[e]:e.end===t[0].start?t[0].start=e.start:t.unshift(e),t}function nextAnchor(e,t){for(let r=t;r<e.length;r++){const t=e.charCodeAt(r);if(isUpper(t)||isNumber(t)||r>0&&!isAlphanumeric(e.charCodeAt(r-1)))return r}return e.length}function _matchesCamelCase(e,t,r,n){if(r===e.length)return[];if(n===t.length)return null;if(e[r]!==t[n].toLowerCase())return null;{let o=null,s=n+1;for(o=_matchesCamelCase(e,t,r+1,n+1);!o&&(s=nextAnchor(t,s))<t.length;)o=_matchesCamelCase(e,t,r+1,s),s++;return null===o?null:join({start:n,end:n+1},o)}}function analyzeCamelCaseWord(e){let t=0,r=0,n=0,o=0,s=0;for(let a=0;a<e.length;a++)s=e.charCodeAt(a),isUpper(s)&&t++,isLower(s)&&r++,isAlphanumeric(s)&&n++,isNumber(s)&&o++;return{upperPercent:t/e.length,lowerPercent:r/e.length,alphaPercent:n/e.length,numericPercent:o/e.length}}function isUpperCaseWord(e){const{upperPercent:t,lowerPercent:r}=e;return 0===r&&t>.6}function isCamelCaseWord(e){const{upperPercent:t,lowerPercent:r,alphaPercent:n,numericPercent:o}=e;return r>.2&&t<.8&&n>.6&&o<.2}function isCamelCasePattern(e){let t=0,r=0,n=0,o=0;for(let s=0;s<e.length;s++)n=e.charCodeAt(s),isUpper(n)&&t++,isLower(n)&&r++,isWhitespace(n)&&o++;return 0!==t&&0!==r||0!==o?t<=5:e.length<=30}"()[]{}<>`'\"-/;:,.?!".split("").forEach((e=>wordSeparators.add(e.charCodeAt(0))));export function matchesCamelCase(e,t){if(!t)return null;if(0===(t=t.trim()).length)return null;if(!isCamelCasePattern(e))return null;if(t.length>60)return null;const r=analyzeCamelCaseWord(t);if(!isCamelCaseWord(r)){if(!isUpperCaseWord(r))return null;t=t.toLowerCase()}let n=null,o=0;for(e=e.toLowerCase();o<t.length&&null===(n=_matchesCamelCase(e,t,0,o));)o=nextAnchor(t,o+1);return n}export function matchesWords(e,t,r=!1){if(!t||0===t.length)return null;let n=null,o=0;for(e=e.toLowerCase(),t=t.toLowerCase();o<t.length&&null===(n=_matchesWords(e,t,0,o,r));)o=nextWord(t,o+1);return n}function _matchesWords(e,t,r,n,o){if(r===e.length)return[];if(n===t.length)return null;if(charactersMatch(e.charCodeAt(r),t.charCodeAt(n))){let s=null,a=n+1;if(s=_matchesWords(e,t,r+1,n+1,o),!o)for(;!s&&(a=nextWord(t,a))<t.length;)s=_matchesWords(e,t,r+1,a,o),a++;return s?e.charCodeAt(r)!==t.charCodeAt(n)?s:join({start:n,end:n+1},s):null}return null}function nextWord(e,t){for(let r=t;r<e.length;r++)if(isWordSeparator(e.charCodeAt(r))||r>0&&isWordSeparator(e.charCodeAt(r-1)))return r;return e.length}const fuzzyContiguousFilter=or(matchesPrefix,matchesCamelCase,matchesContiguousSubString),fuzzySeparateFilter=or(matchesPrefix,matchesCamelCase,matchesSubString),fuzzyRegExpCache=new LRUCache(1e4);export function matchesFuzzy(e,t,r=!1){if("string"!=typeof e||"string"!=typeof t)return null;let n=fuzzyRegExpCache.get(e);n||(n=new RegExp(strings.convertSimple2RegExpPattern(e),"i"),fuzzyRegExpCache.set(e,n));const o=n.exec(t);return o?[{start:o.index,end:o.index+o[0].length}]:r?fuzzySeparateFilter(e,t):fuzzyContiguousFilter(e,t)}export function anyScore(e,t,r,n,o,s){const a=Math.min(13,e.length);for(;r<a;r++){const a=fuzzyScore(e,t,r,n,o,s,{firstMatchCanBeWeak:!0,boostFullMatch:!0});if(a)return a}return[0,s]}export function createMatches(e){if(void 0===e)return[];const t=[],r=e[1];for(let n=e.length-1;n>1;n--){const o=e[n]+r,s=t[t.length-1];s&&s.end===o?s.end=o+1:t.push({start:o,end:o+1})}return t}const _maxLen=128;function initTable(){const e=[],t=[];for(let e=0;e<=128;e++)t[e]=0;for(let r=0;r<=128;r++)e.push(t.slice(0));return e}function initArr(e){const t=[];for(let r=0;r<=e;r++)t[r]=0;return t}const _minWordMatchPos=initArr(256),_maxWordMatchPos=initArr(256),_diag=initTable(),_table=initTable(),_arrows=initTable(),_debug=!1;function printTable(e,t,r,n,o){function s(e,t,r=" "){for(;e.length<t;)e=r+e;return e}let a=` |   |${n.split("").map((e=>s(e,3))).join("|")}\n`;for(let n=0;n<=r;n++)a+=0===n?" |":`${t[n-1]}|`,a+=e[n].slice(0,o+1).map((e=>s(e.toString(),3))).join("|")+"\n";return a}function printTables(e,t,r,n){e=e.substr(t),r=r.substr(n),console.log(printTable(_table,e,e.length,r,r.length)),console.log(printTable(_arrows,e,e.length,r,r.length)),console.log(printTable(_diag,e,e.length,r,r.length))}function isSeparatorAtPos(e,t){if(t<0||t>=e.length)return!1;const r=e.codePointAt(t);switch(r){case 95:case 45:case 46:case 32:case 47:case 92:case 39:case 34:case 58:case 36:case 60:case 62:case 40:case 41:case 91:case 93:case 123:case 125:return!0;case void 0:return!1;default:return!!strings.isEmojiImprecise(r)}}function isWhitespaceAtPos(e,t){if(t<0||t>=e.length)return!1;switch(e.charCodeAt(t)){case 32:case 9:return!0;default:return!1}}function isUpperCaseAtPos(e,t,r){return t[e]!==r[e]}export function isPatternInWord(e,t,r,n,o,s,a=!1){for(;t<r&&o<s;)e[t]===n[o]&&(a&&(_minWordMatchPos[t]=o),t+=1),o+=1;return t===r}export var FuzzyScore;!function(e){e.Default=[-100,0],e.isDefault=function(e){return!e||2===e.length&&-100===e[0]&&0===e[1]}}(FuzzyScore||(FuzzyScore={}));class FuzzyScoreOptions{constructor(e,t){this.firstMatchCanBeWeak=e,this.boostFullMatch=t}}FuzzyScoreOptions.default={boostFullMatch:!0,firstMatchCanBeWeak:!1};export{FuzzyScoreOptions};export function fuzzyScore(e,t,r,n,o,s,a=FuzzyScoreOptions.default){const i=e.length>128?128:e.length,c=n.length>128?128:n.length;if(r>=i||s>=c||i-r>c-s)return;if(!isPatternInWord(t,r,i,o,s,c,!0))return;_fillInMaxWordMatchPos(i,c,r,s,t,o);let u=1,l=1,h=r,f=s;const p=[!1];for(u=1,h=r;h<i;u++,h++){const a=_minWordMatchPos[h],g=_maxWordMatchPos[h],d=h+1<i?_maxWordMatchPos[h+1]:c;for(l=a-s+1,f=a;f<d;l++,f++){let i=Number.MIN_SAFE_INTEGER,d=!1;f<=g&&(i=_doScore(e,t,h,r,n,o,f,c,s,0===_diag[u-1][l-1],p));let m=0;i!==Number.MAX_SAFE_INTEGER&&(d=!0,m=i+_table[u-1][l-1]);const C=f>a,_=C?_table[u][l-1]+(_diag[u][l-1]>0?-5:0):0,S=f>a+1&&_diag[u][l-1]>0,P=S?_table[u][l-2]+(_diag[u][l-2]>0?-5:0):0;if(S&&(!C||P>=_)&&(!d||P>=m))_table[u][l]=P,_arrows[u][l]=3,_diag[u][l]=0;else if(C&&(!d||_>=m))_table[u][l]=_,_arrows[u][l]=2,_diag[u][l]=0;else{if(!d)throw new Error("not possible");_table[u][l]=m,_arrows[u][l]=1,_diag[u][l]=_diag[u-1][l-1]+1}}}if(!p[0]&&!a.firstMatchCanBeWeak)return;u--,l--;const g=[_table[u][l],s];let d=0,m=0;for(;u>=1;){let e=l;do{const t=_arrows[u][e];if(3===t)e-=2;else{if(2!==t)break;e-=1}}while(e>=1);d>1&&t[r+u-1]===o[s+l-1]&&!isUpperCaseAtPos(e+s-1,n,o)&&d+1>_diag[u][e]&&(e=l),e===l?d++:d=1,m||(m=e),u--,l=e-1,g.push(l)}c===i&&a.boostFullMatch&&(g[0]+=2);const C=m-i;return g[0]-=C,g}function _fillInMaxWordMatchPos(e,t,r,n,o,s){let a=e-1,i=t-1;for(;a>=r&&i>=n;)o[a]===s[i]&&(_maxWordMatchPos[a]=i,a--),i--}function _doScore(e,t,r,n,o,s,a,i,c,u,l){if(t[r]!==s[a])return Number.MIN_SAFE_INTEGER;let h=1,f=!1;return a===r-n?h=e[r]===o[a]?7:5:!isUpperCaseAtPos(a,o,s)||0!==a&&isUpperCaseAtPos(a-1,o,s)?!isSeparatorAtPos(s,a)||0!==a&&isSeparatorAtPos(s,a-1)?(isSeparatorAtPos(s,a-1)||isWhitespaceAtPos(s,a-1))&&(h=5,f=!0):h=5:(h=e[r]===o[a]?7:5,f=!0),h>1&&r===n&&(l[0]=!0),f||(f=isUpperCaseAtPos(a,o,s)||isSeparatorAtPos(s,a-1)||isWhitespaceAtPos(s,a-1)),r===n?a>c&&(h-=f?3:5):h+=u?f?2:0:f?0:1,a+1===i&&(h-=f?3:5),h}export function fuzzyScoreGracefulAggressive(e,t,r,n,o,s,a){return fuzzyScoreWithPermutations(e,t,r,n,o,s,!0,a)}function fuzzyScoreWithPermutations(e,t,r,n,o,s,a,i){let c=fuzzyScore(e,t,r,n,o,s,i);if(c&&!a)return c;if(e.length>=3){const t=Math.min(7,e.length-1);for(let a=r+1;a<t;a++){const t=nextTypoPermutation(e,a);if(t){const e=fuzzyScore(t,t.toLowerCase(),r,n,o,s,i);e&&(e[0]-=3,(!c||e[0]>c[0])&&(c=e))}}}return c}function nextTypoPermutation(e,t){if(t+1>=e.length)return;const r=e[t],n=e[t+1];return r!==n?e.slice(0,t)+n+r+e.slice(t+2):void 0}