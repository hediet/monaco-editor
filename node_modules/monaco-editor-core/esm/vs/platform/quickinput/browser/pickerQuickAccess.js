var __awaiter=this&&this.__awaiter||function(i,e,t,n){return new(t||(t=Promise))((function(s,o){function c(i){try{a(n.next(i))}catch(i){o(i)}}function r(i){try{a(n.throw(i))}catch(i){o(i)}}function a(i){var e;i.done?s(i.value):(e=i.value,e instanceof t?e:new t((function(i){i(e)}))).then(c,r)}a((n=n.apply(i,e||[])).next())}))};import{timeout}from"../../../base/common/async.js";import{CancellationTokenSource}from"../../../base/common/cancellation.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../base/common/lifecycle.js";export var TriggerAction;function isPicksWithActive(i){const e=i;return Array.isArray(e.items)}function isFastAndSlowPicks(i){const e=i;return!!e.picks&&e.additionalPicks instanceof Promise}!function(i){i[i.NO_ACTION=0]="NO_ACTION",i[i.CLOSE_PICKER=1]="CLOSE_PICKER",i[i.REFRESH_PICKER=2]="REFRESH_PICKER",i[i.REMOVE_ITEM=3]="REMOVE_ITEM"}(TriggerAction||(TriggerAction={}));export class PickerQuickAccessProvider extends Disposable{constructor(i,e){super(),this.prefix=i,this.options=e}provide(i,e,t){var n;const s=new DisposableStore;let o;i.canAcceptInBackground=!!(null===(n=this.options)||void 0===n?void 0:n.canAcceptInBackground),i.matchOnLabel=i.matchOnDescription=i.matchOnDetail=i.sortByLabel=!1;const c=s.add(new MutableDisposable),r=()=>__awaiter(this,void 0,void 0,(function*(){const n=c.value=new DisposableStore;null==o||o.dispose(!0),i.busy=!1,o=new CancellationTokenSource(e);const s=o.token,r=i.value.substr(this.prefix.length).trim(),a=this._getPicks(r,n,s,t),l=(e,t)=>{var n;let s,o;if(isPicksWithActive(e)?(s=e.items,o=e.active):s=e,0===s.length){if(t)return!1;r.length>0&&(null===(n=this.options)||void 0===n?void 0:n.noResultsPick)&&(s=[this.options.noResultsPick])}return i.items=s,o&&(i.activeItems=[o]),!0};if(null===a);else if(isFastAndSlowPicks(a)){let e=!1,t=!1;yield Promise.all([(()=>__awaiter(this,void 0,void 0,(function*(){yield timeout(PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY),s.isCancellationRequested||t||(e=l(a.picks,!0))})))(),(()=>__awaiter(this,void 0,void 0,(function*(){i.busy=!0;try{const n=yield a.additionalPicks;if(s.isCancellationRequested)return;let o,c,r,u;if(isPicksWithActive(a.picks)?(o=a.picks.items,c=a.picks.active):o=a.picks,isPicksWithActive(n)?(r=n.items,u=n.active):r=n,r.length>0||!e){let e;if(!c&&!u){const t=i.activeItems[0];t&&-1!==o.indexOf(t)&&(e=t)}l({items:[...o,...r],active:c||u||e})}}finally{s.isCancellationRequested||(i.busy=!1),t=!0}})))()])}else if(a instanceof Promise){i.busy=!0;try{const e=yield a;if(s.isCancellationRequested)return;l(e)}finally{s.isCancellationRequested||(i.busy=!1)}}else l(a)}));return s.add(i.onDidChangeValue((()=>r()))),r(),s.add(i.onDidAccept((e=>{const[t]=i.selectedItems;"function"==typeof(null==t?void 0:t.accept)&&(e.inBackground||i.hide(),t.accept(i.keyMods,e))}))),s.add(i.onDidTriggerItemButton((({button:t,item:n})=>__awaiter(this,void 0,void 0,(function*(){var s,o;if("function"==typeof n.trigger){const c=null!==(o=null===(s=n.buttons)||void 0===s?void 0:s.indexOf(t))&&void 0!==o?o:-1;if(c>=0){const t=n.trigger(c,i.keyMods),s="number"==typeof t?t:yield t;if(e.isCancellationRequested)return;switch(s){case TriggerAction.NO_ACTION:break;case TriggerAction.CLOSE_PICKER:i.hide();break;case TriggerAction.REFRESH_PICKER:r();break;case TriggerAction.REMOVE_ITEM:{const e=i.items.indexOf(n);if(-1!==e){const t=i.items.slice(),n=t.splice(e,1),s=i.activeItems.filter((i=>i!==n[0])),o=i.keepScrollPosition;i.keepScrollPosition=!0,i.items=t,s&&(i.activeItems=s),i.keepScrollPosition=o}break}}}}}))))),s}}PickerQuickAccessProvider.FAST_PICKS_RACE_DELAY=200;