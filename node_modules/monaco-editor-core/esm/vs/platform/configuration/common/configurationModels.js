import*as arrays from"../../../base/common/arrays.js";import{ResourceMap}from"../../../base/common/map.js";import*as objects from"../../../base/common/objects.js";import*as types from"../../../base/common/types.js";import{URI}from"../../../base/common/uri.js";import{addToValueTree,getConfigurationValue,removeFromValueTree,toValuesTree}from"./configuration.js";import{Extensions,overrideIdentifiersFromKey,OVERRIDE_PROPERTY_REGEX}from"./configurationRegistry.js";import{Registry}from"../../registry/common/platform.js";export class ConfigurationModel{constructor(e={},t=[],o=[],i){this._contents=e,this._keys=t,this._overrides=o,this.raw=i,this.frozen=!1,this.overrideConfigurations=new Map}get rawConfiguration(){var e;if(!this._rawConfiguration)if(null===(e=this.raw)||void 0===e?void 0:e.length){const e=this.raw.map((e=>{if(e instanceof ConfigurationModel)return e;const t=new ConfigurationModelParser("");return t.parseRaw(e),t.configurationModel}));this._rawConfiguration=e.reduce(((e,t)=>t===e?t:e.merge(t)),e[0])}else this._rawConfiguration=this;return this._rawConfiguration}get contents(){return this.checkAndFreeze(this._contents)}get overrides(){return this.checkAndFreeze(this._overrides)}get keys(){return this.checkAndFreeze(this._keys)}isEmpty(){return 0===this._keys.length&&0===Object.keys(this._contents).length&&0===this._overrides.length}getValue(e){return e?getConfigurationValue(this.contents,e):this.contents}inspect(e,t){const o=this.rawConfiguration.getValue(e);return{value:o,override:t?this.rawConfiguration.getOverrideValue(e,t):void 0,merged:t?this.rawConfiguration.override(t).getValue(e):o}}getOverrideValue(e,t){const o=this.getContentsForOverrideIdentifer(t);return o?e?getConfigurationValue(o,e):o:void 0}override(e){let t=this.overrideConfigurations.get(e);return t||(t=this.createOverrideConfigurationModel(e),this.overrideConfigurations.set(e,t)),t}merge(...e){var t,o;const i=objects.deepClone(this.contents),r=objects.deepClone(this.overrides),s=[...this.keys],n=(null===(t=this.raw)||void 0===t?void 0:t.length)?[...this.raw]:[this];for(const t of e)if(n.push(...(null===(o=t.raw)||void 0===o?void 0:o.length)?t.raw:[t]),!t.isEmpty()){this.mergeContents(i,t.contents);for(const e of t.overrides){const[t]=r.filter((t=>arrays.equals(t.identifiers,e.identifiers)));t?(this.mergeContents(t.contents,e.contents),t.keys.push(...e.keys),t.keys=arrays.distinct(t.keys)):r.push(objects.deepClone(e))}for(const e of t.keys)-1===s.indexOf(e)&&s.push(e)}return new ConfigurationModel(i,s,r,n.every((e=>e instanceof ConfigurationModel))?void 0:n)}freeze(){return this.frozen=!0,this}createOverrideConfigurationModel(e){const t=this.getContentsForOverrideIdentifer(e);if(!t||"object"!=typeof t||!Object.keys(t).length)return this;const o={};for(const e of arrays.distinct([...Object.keys(this.contents),...Object.keys(t)])){let i=this.contents[e];const r=t[e];r&&("object"==typeof i&&"object"==typeof r?(i=objects.deepClone(i),this.mergeContents(i,r)):i=r),o[e]=i}return new ConfigurationModel(o,this.keys,this.overrides)}mergeContents(e,t){for(const o of Object.keys(t))o in e&&types.isObject(e[o])&&types.isObject(t[o])?this.mergeContents(e[o],t[o]):e[o]=objects.deepClone(t[o])}checkAndFreeze(e){return this.frozen&&!Object.isFrozen(e)?objects.deepFreeze(e):e}getContentsForOverrideIdentifer(e){let t=null,o=null;const i=e=>{e&&(o?this.mergeContents(o,e):o=objects.deepClone(e))};for(const o of this.overrides)arrays.equals(o.identifiers,[e])?t=o.contents:o.identifiers.includes(e)&&i(o.contents);return i(t),o}toJSON(){return{contents:this.contents,overrides:this.overrides,keys:this.keys}}setValue(e,t){this.addKey(e),addToValueTree(this.contents,e,t,(e=>{throw new Error(e)}))}removeValue(e){this.removeKey(e)&&removeFromValueTree(this.contents,e)}addKey(e){let t=this.keys.length;for(let o=0;o<t;o++)0===e.indexOf(this.keys[o])&&(t=o);this.keys.splice(t,1,e)}removeKey(e){const t=this.keys.indexOf(e);return-1!==t&&(this.keys.splice(t,1),!0)}}export class ConfigurationModelParser{constructor(e){this._name=e,this._raw=null,this._configurationModel=null,this._restrictedConfigurations=[]}get configurationModel(){return this._configurationModel||new ConfigurationModel}parseRaw(e,t){this._raw=e;const{contents:o,keys:i,overrides:r,restricted:s,hasExcludedProperties:n}=this.doParseRaw(e,t);this._configurationModel=new ConfigurationModel(o,i,r,n?[e]:void 0),this._restrictedConfigurations=s||[]}doParseRaw(e,t){const o=Registry.as(Extensions.Configuration).getConfigurationProperties(),i=this.filter(e,o,!0,t);return e=i.raw,{contents:toValuesTree(e,(e=>console.error(`Conflict in settings file ${this._name}: ${e}`))),keys:Object.keys(e),overrides:this.toOverrides(e,(e=>console.error(`Conflict in settings file ${this._name}: ${e}`))),restricted:i.restricted,hasExcludedProperties:i.hasExcludedProperties}}filter(e,t,o,i){let r=!1;if(!(null==i?void 0:i.scopes)&&!(null==i?void 0:i.skipRestricted))return{raw:e,restricted:[],hasExcludedProperties:r};const s={},n=[];for(const a in e)if(OVERRIDE_PROPERTY_REGEX.test(a)&&o){const o=this.filter(e[a],t,!1,i);s[a]=o.raw,r=r||o.hasExcludedProperties,n.push(...o.restricted)}else{const o=t[a],u=o?void 0!==o.scope?o.scope:3:void 0;(null==o?void 0:o.restricted)&&n.push(a),void 0!==u&&void 0!==i.scopes&&!i.scopes.includes(u)||i.skipRestricted&&(null==o?void 0:o.restricted)?r=!0:s[a]=e[a]}return{raw:s,restricted:n,hasExcludedProperties:r}}toOverrides(e,t){const o=[];for(const i of Object.keys(e))if(OVERRIDE_PROPERTY_REGEX.test(i)){const r={};for(const t in e[i])r[t]=e[i][t];o.push({identifiers:overrideIdentifiersFromKey(i),keys:Object.keys(r),contents:toValuesTree(r,t)})}return o}}class ConfigurationInspectValue{constructor(e,t,o,i,r,s,n,a,u,f,c,d,l){this.key=e,this.overrides=t,this.value=o,this.overrideIdentifiers=i,this.defaultConfiguration=r,this.policyConfiguration=s,this.applicationConfiguration=n,this.userConfiguration=a,this.localUserConfiguration=u,this.remoteUserConfiguration=f,this.workspaceConfiguration=c,this.folderConfigurationModel=d,this.memoryInspectValue=l}get userInspectValue(){return this._userInspectValue||(this._userInspectValue=this.userConfiguration.inspect(this.key,this.overrides.overrideIdentifier)),this._userInspectValue}get user(){return void 0!==this.userInspectValue.value||void 0!==this.userInspectValue.override?{value:this.userInspectValue.value,override:this.userInspectValue.override}:void 0}}export class Configuration{constructor(e,t,o,i,r=new ConfigurationModel,s=new ConfigurationModel,n=new ResourceMap,a=new ConfigurationModel,u=new ResourceMap,f=!0){this._defaultConfiguration=e,this._policyConfiguration=t,this._applicationConfiguration=o,this._localUserConfiguration=i,this._remoteUserConfiguration=r,this._workspaceConfiguration=s,this._folderConfigurations=n,this._memoryConfiguration=a,this._memoryConfigurationByResource=u,this._freeze=f,this._workspaceConsolidatedConfiguration=null,this._foldersConsolidatedConfigurations=new ResourceMap,this._userConfiguration=null}getValue(e,t,o){return this.getConsolidatedConfigurationModel(e,t,o).getValue(e)}updateValue(e,t,o={}){let i;o.resource?(i=this._memoryConfigurationByResource.get(o.resource),i||(i=new ConfigurationModel,this._memoryConfigurationByResource.set(o.resource,i))):i=this._memoryConfiguration,void 0===t?i.removeValue(e):i.setValue(e,t),o.resource||(this._workspaceConsolidatedConfiguration=null)}inspect(e,t,o){const i=this.getConsolidatedConfigurationModel(e,t,o),r=arrays.distinct(i.overrides.map((e=>e.identifiers)).flat()).filter((t=>void 0!==i.getOverrideValue(e,t))),s=this.getFolderConfigurationModelForResource(t.resource,o),n=t.resource&&this._memoryConfigurationByResource.get(t.resource)||this._memoryConfiguration;return new ConfigurationInspectValue(e,t,i.getValue(e),r.length?r:void 0,this._defaultConfiguration,this._policyConfiguration.isEmpty()?void 0:this._policyConfiguration.freeze(),this.applicationConfiguration.isEmpty()?void 0:this.applicationConfiguration.freeze(),this.userConfiguration.freeze(),this.localUserConfiguration.freeze(),this.remoteUserConfiguration.freeze(),o?this._workspaceConfiguration.freeze():void 0,s?s.freeze():void 0,n.inspect(e,t.overrideIdentifier))}get applicationConfiguration(){return this._applicationConfiguration}get userConfiguration(){return this._userConfiguration||(this._userConfiguration=this._remoteUserConfiguration.isEmpty()?this._localUserConfiguration:this._localUserConfiguration.merge(this._remoteUserConfiguration),this._freeze&&this._userConfiguration.freeze()),this._userConfiguration}get localUserConfiguration(){return this._localUserConfiguration}get remoteUserConfiguration(){return this._remoteUserConfiguration}getConsolidatedConfigurationModel(e,t,o){let i=this.getConsolidatedConfigurationModelForResource(t,o);return t.overrideIdentifier&&(i=i.override(t.overrideIdentifier)),this._policyConfiguration.isEmpty()||void 0===this._policyConfiguration.getValue(e)||(i=i.merge(this._policyConfiguration)),i}getConsolidatedConfigurationModelForResource({resource:e},t){let o=this.getWorkspaceConsolidatedConfiguration();if(t&&e){const i=t.getFolder(e);i&&(o=this.getFolderConsolidatedConfiguration(i.uri)||o);const r=this._memoryConfigurationByResource.get(e);r&&(o=o.merge(r))}return o}getWorkspaceConsolidatedConfiguration(){return this._workspaceConsolidatedConfiguration||(this._workspaceConsolidatedConfiguration=this._defaultConfiguration.merge(this.applicationConfiguration,this.userConfiguration,this._workspaceConfiguration,this._memoryConfiguration),this._freeze&&(this._workspaceConfiguration=this._workspaceConfiguration.freeze())),this._workspaceConsolidatedConfiguration}getFolderConsolidatedConfiguration(e){let t=this._foldersConsolidatedConfigurations.get(e);if(!t){const o=this.getWorkspaceConsolidatedConfiguration(),i=this._folderConfigurations.get(e);i?(t=o.merge(i),this._freeze&&(t=t.freeze()),this._foldersConsolidatedConfigurations.set(e,t)):t=o}return t}getFolderConfigurationModelForResource(e,t){if(t&&e){const o=t.getFolder(e);if(o)return this._folderConfigurations.get(o.uri)}}toData(){return{defaults:{contents:this._defaultConfiguration.contents,overrides:this._defaultConfiguration.overrides,keys:this._defaultConfiguration.keys},policy:{contents:this._policyConfiguration.contents,overrides:this._policyConfiguration.overrides,keys:this._policyConfiguration.keys},application:{contents:this.applicationConfiguration.contents,overrides:this.applicationConfiguration.overrides,keys:this.applicationConfiguration.keys},user:{contents:this.userConfiguration.contents,overrides:this.userConfiguration.overrides,keys:this.userConfiguration.keys},workspace:{contents:this._workspaceConfiguration.contents,overrides:this._workspaceConfiguration.overrides,keys:this._workspaceConfiguration.keys},folders:[...this._folderConfigurations.keys()].reduce(((e,t)=>{const{contents:o,overrides:i,keys:r}=this._folderConfigurations.get(t);return e.push([t,{contents:o,overrides:i,keys:r}]),e}),[])}}static parse(e){const t=this.parseConfigurationModel(e.defaults),o=this.parseConfigurationModel(e.policy),i=this.parseConfigurationModel(e.application),r=this.parseConfigurationModel(e.user),s=this.parseConfigurationModel(e.workspace),n=e.folders.reduce(((e,t)=>(e.set(URI.revive(t[0]),this.parseConfigurationModel(t[1])),e)),new ResourceMap);return new Configuration(t,o,i,r,new ConfigurationModel,s,n,new ConfigurationModel,new ResourceMap,!1)}static parseConfigurationModel(e){return new ConfigurationModel(e.contents,e.keys,e.overrides).freeze()}}export class ConfigurationChangeEvent{constructor(e,t,o,i){this.change=e,this.previous=t,this.currentConfiguraiton=o,this.currentWorkspace=i,this._previousConfiguration=void 0;const r=new Set;e.keys.forEach((e=>r.add(e))),e.overrides.forEach((([,e])=>e.forEach((e=>r.add(e))))),this.affectedKeys=[...r.values()];const s=new ConfigurationModel;this.affectedKeys.forEach((e=>s.setValue(e,{}))),this.affectedKeysTree=s.contents}get previousConfiguration(){return!this._previousConfiguration&&this.previous&&(this._previousConfiguration=Configuration.parse(this.previous.data)),this._previousConfiguration}affectsConfiguration(e,t){var o;if(this.doesAffectedKeysTreeContains(this.affectedKeysTree,e)){if(t){const i=this.previousConfiguration?this.previousConfiguration.getValue(e,t,null===(o=this.previous)||void 0===o?void 0:o.workspace):void 0,r=this.currentConfiguraiton.getValue(e,t,this.currentWorkspace);return!objects.equals(i,r)}return!0}return!1}doesAffectedKeysTreeContains(e,t){let o,i=toValuesTree({[t]:!0},(()=>{}));for(;"object"==typeof i&&(o=Object.keys(i)[0]);){if(!(e=e[o]))return!1;i=i[o]}return!0}}