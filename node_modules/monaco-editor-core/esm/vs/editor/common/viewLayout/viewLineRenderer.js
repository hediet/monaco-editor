import*as strings from"../../../base/common/strings.js";import{StringBuilder}from"../core/stringBuilder.js";import{LineDecoration,LineDecorationsNormalizer}from"./lineDecorations.js";import{LinePart}from"./linePart.js";export class LineRange{constructor(e,t){this.startOffset=e,this.endOffset=t}equals(e){return this.startOffset===e.startOffset&&this.endOffset===e.endOffset}}export class RenderLineInput{constructor(e,t,n,r,i,s,a,o,c,h,l,p,d,f,g,u,C,I,L){this.useMonospaceOptimizations=e,this.canUseHalfwidthRightwardsArrow=t,this.lineContent=n,this.continuesWithWrappedLine=r,this.isBasicASCII=i,this.containsRTL=s,this.fauxIndentLength=a,this.lineTokens=o,this.lineDecorations=c.sort(LineDecoration.compare),this.tabSize=h,this.startVisibleColumn=l,this.spaceWidth=p,this.stopRenderingLineAfter=g,this.renderWhitespace="all"===u?4:"boundary"===u?1:"selection"===u?2:"trailing"===u?3:0,this.renderControlCharacters=C,this.fontLigatures=I,this.selectionsOnLine=L&&L.sort(((e,t)=>e.startOffset<t.startOffset?-1:1)),Math.abs(f-p)<Math.abs(d-p)?(this.renderSpaceWidth=f,this.renderSpaceCharCode=11825):(this.renderSpaceWidth=d,this.renderSpaceCharCode=183)}sameSelection(e){if(null===this.selectionsOnLine)return null===e;if(null===e)return!1;if(e.length!==this.selectionsOnLine.length)return!1;for(let t=0;t<this.selectionsOnLine.length;t++)if(!this.selectionsOnLine[t].equals(e[t]))return!1;return!0}equals(e){return this.useMonospaceOptimizations===e.useMonospaceOptimizations&&this.canUseHalfwidthRightwardsArrow===e.canUseHalfwidthRightwardsArrow&&this.lineContent===e.lineContent&&this.continuesWithWrappedLine===e.continuesWithWrappedLine&&this.isBasicASCII===e.isBasicASCII&&this.containsRTL===e.containsRTL&&this.fauxIndentLength===e.fauxIndentLength&&this.tabSize===e.tabSize&&this.startVisibleColumn===e.startVisibleColumn&&this.spaceWidth===e.spaceWidth&&this.renderSpaceWidth===e.renderSpaceWidth&&this.renderSpaceCharCode===e.renderSpaceCharCode&&this.stopRenderingLineAfter===e.stopRenderingLineAfter&&this.renderWhitespace===e.renderWhitespace&&this.renderControlCharacters===e.renderControlCharacters&&this.fontLigatures===e.fontLigatures&&LineDecoration.equalsArr(this.lineDecorations,e.lineDecorations)&&this.lineTokens.equals(e.lineTokens)&&this.sameSelection(e.selectionsOnLine)}}export class DomPosition{constructor(e,t){this.partIndex=e,this.charIndex=t}}export class CharacterMapping{static getPartIndex(e){return(4294901760&e)>>>16}static getCharIndex(e){return(65535&e)>>>0}constructor(e,t){this.length=e,this._data=new Uint32Array(this.length),this._horizontalOffset=new Uint32Array(this.length)}setColumnInfo(e,t,n,r){const i=(t<<16|n<<0)>>>0;this._data[e-1]=i,this._horizontalOffset[e-1]=r}getHorizontalOffset(e){return 0===this._horizontalOffset.length?0:this._horizontalOffset[e-1]}charOffsetToPartData(e){return 0===this.length?0:e<0?this._data[0]:e>=this.length?this._data[this.length-1]:this._data[e]}getDomPosition(e){const t=this.charOffsetToPartData(e-1),n=CharacterMapping.getPartIndex(t),r=CharacterMapping.getCharIndex(t);return new DomPosition(n,r)}getColumn(e,t){return this.partDataToCharOffset(e.partIndex,t,e.charIndex)+1}partDataToCharOffset(e,t,n){if(0===this.length)return 0;const r=(e<<16|n<<0)>>>0;let i=0,s=this.length-1;for(;i+1<s;){const e=i+s>>>1,t=this._data[e];if(t===r)return e;t>r?s=e:i=e}if(i===s)return i;const a=this._data[i],o=this._data[s];if(a===r)return i;if(o===r)return s;const c=CharacterMapping.getPartIndex(a),h=CharacterMapping.getCharIndex(a);let l;return l=c!==CharacterMapping.getPartIndex(o)?t:CharacterMapping.getCharIndex(o),n-h<=l-n?i:s}}export class RenderLineOutput{constructor(e,t,n){this._renderLineOutputBrand=void 0,this.characterMapping=e,this.containsRTL=t,this.containsForeignElements=n}}export function renderViewLine(e,t){if(0===e.lineContent.length){if(e.lineDecorations.length>0){t.appendASCIIString("<span>");let n=0,r=0,i=0;for(const s of e.lineDecorations)1!==s.type&&2!==s.type||(t.appendASCIIString('<span class="'),t.appendASCIIString(s.className),t.appendASCIIString('"></span>'),1===s.type&&(i|=1,n++),2===s.type&&(i|=2,r++));t.appendASCIIString("</span>");const s=new CharacterMapping(1,n+r);return s.setColumnInfo(1,n,0,0),new RenderLineOutput(s,!1,i)}return t.appendASCIIString("<span><span></span></span>"),new RenderLineOutput(new CharacterMapping(0,0),!1,0)}return _renderLine(resolveRenderLineInput(e),t)}export class RenderLineOutput2{constructor(e,t,n,r){this.characterMapping=e,this.html=t,this.containsRTL=n,this.containsForeignElements=r}}export function renderViewLine2(e){const t=new StringBuilder(1e4),n=renderViewLine(e,t);return new RenderLineOutput2(n.characterMapping,t.build(),n.containsRTL,n.containsForeignElements)}class ResolvedRenderLineInput{constructor(e,t,n,r,i,s,a,o,c,h,l,p,d,f,g){this.fontIsMonospace=e,this.canUseHalfwidthRightwardsArrow=t,this.lineContent=n,this.len=r,this.isOverflowing=i,this.parts=s,this.containsForeignElements=a,this.fauxIndentLength=o,this.tabSize=c,this.startVisibleColumn=h,this.containsRTL=l,this.spaceWidth=p,this.renderSpaceCharCode=d,this.renderWhitespace=f,this.renderControlCharacters=g}}function resolveRenderLineInput(e){const t=e.lineContent;let n,r;-1!==e.stopRenderingLineAfter&&e.stopRenderingLineAfter<t.length?(n=!0,r=e.stopRenderingLineAfter):(n=!1,r=t.length);let i=transformAndRemoveOverflowing(t,e.containsRTL,e.lineTokens,e.fauxIndentLength,r);e.renderControlCharacters&&!e.isBasicASCII&&(i=extractControlCharacters(t,i)),(4===e.renderWhitespace||1===e.renderWhitespace||2===e.renderWhitespace&&e.selectionsOnLine||3===e.renderWhitespace)&&(i=_applyRenderWhitespace(e,t,r,i));let s=0;if(e.lineDecorations.length>0){for(let t=0,n=e.lineDecorations.length;t<n;t++){const n=e.lineDecorations[t];3===n.type||1===n.type?s|=1:2===n.type&&(s|=2)}i=_applyInlineDecorations(t,r,i,e.lineDecorations)}return e.containsRTL||(i=splitLargeTokens(t,i,!e.isBasicASCII||e.fontLigatures)),new ResolvedRenderLineInput(e.useMonospaceOptimizations,e.canUseHalfwidthRightwardsArrow,t,r,n,i,s,e.fauxIndentLength,e.tabSize,e.startVisibleColumn,e.containsRTL,e.spaceWidth,e.renderSpaceCharCode,e.renderWhitespace,e.renderControlCharacters)}function transformAndRemoveOverflowing(e,t,n,r,i){const s=[];let a=0;r>0&&(s[a++]=new LinePart(r,"",0,!1));let o=r;for(let c=0,h=n.getCount();c<h;c++){const h=n.getEndOffset(c);if(h<=r)continue;const l=n.getClassName(c);if(h>=i){const n=!!t&&strings.containsRTL(e.substring(o,i));s[a++]=new LinePart(i,l,0,n);break}const p=!!t&&strings.containsRTL(e.substring(o,h));s[a++]=new LinePart(h,l,0,p),o=h}return s}function splitLargeTokens(e,t,n){let r=0;const i=[];let s=0;if(n)for(let n=0,a=t.length;n<a;n++){const a=t[n],o=a.endIndex;if(r+50<o){const t=a.type,n=a.metadata,c=a.containsRTL;let h=-1,l=r;for(let a=r;a<o;a++)32===e.charCodeAt(a)&&(h=a),-1!==h&&a-l>=50&&(i[s++]=new LinePart(h+1,t,n,c),l=h+1,h=-1);l!==o&&(i[s++]=new LinePart(o,t,n,c))}else i[s++]=a;r=o}else for(let e=0,n=t.length;e<n;e++){const n=t[e],a=n.endIndex,o=a-r;if(o>50){const e=n.type,t=n.metadata,c=n.containsRTL,h=Math.ceil(o/50);for(let n=1;n<h;n++){const a=r+50*n;i[s++]=new LinePart(a,e,t,c)}i[s++]=new LinePart(a,e,t,c)}else i[s++]=n;r=a}return i}function isControlCharacter(e){return e<32?9!==e:127===e||e>=8234&&e<=8238||e>=8294&&e<=8297||e>=8206&&e<=8207||1564===e}function extractControlCharacters(e,t){const n=[];let r=new LinePart(0,"",0,!1),i=0;for(const s of t){const t=s.endIndex;for(;i<t;i++)isControlCharacter(e.charCodeAt(i))&&(i>r.endIndex&&(r=new LinePart(i,s.type,s.metadata,s.containsRTL),n.push(r)),r=new LinePart(i+1,"mtkcontrol",s.metadata,!1),n.push(r));i>r.endIndex&&(r=new LinePart(t,s.type,s.metadata,s.containsRTL),n.push(r))}return n}function _applyRenderWhitespace(e,t,n,r){const i=e.continuesWithWrappedLine,s=e.fauxIndentLength,a=e.tabSize,o=e.startVisibleColumn,c=e.useMonospaceOptimizations,h=e.selectionsOnLine,l=1===e.renderWhitespace,p=3===e.renderWhitespace,d=e.renderSpaceWidth!==e.spaceWidth,f=[];let g=0,u=0,C=r[u].type,I=r[u].containsRTL,L=r[u].endIndex;const S=r.length;let w,m=!1,A=strings.firstNonWhitespaceIndex(t);-1===A?(m=!0,A=n,w=n):w=strings.lastNonWhitespaceIndex(t);let O=!1,R=0,x=h&&h[R],W=o%a;for(let e=s;e<n;e++){const i=t.charCodeAt(e);let o;if(x&&e>=x.endOffset&&(R++,x=h&&h[R]),e<A||e>w)o=!0;else if(9===i)o=!0;else if(32===i)if(l)if(O)o=!0;else{const r=e+1<n?t.charCodeAt(e+1):0;o=32===r||9===r}else o=!0;else o=!1;if(o&&h&&(o=!!x&&x.startOffset<=e&&x.endOffset>e),o&&p&&(o=m||e>w),o&&I&&e>=A&&e<=w&&(o=!1),O){if(!o||!c&&W>=a){if(d)for(let t=(g>0?f[g-1].endIndex:s)+1;t<=e;t++)f[g++]=new LinePart(t,"mtkw",1,!1);else f[g++]=new LinePart(e,"mtkw",1,!1);W%=a}}else(e===L||o&&e>s)&&(f[g++]=new LinePart(e,C,0,I),W%=a);for(9===i?W=a:strings.isFullWidthCharacter(i)?W+=2:W++,O=o;e===L&&(u++,u<S);)C=r[u].type,I=r[u].containsRTL,L=r[u].endIndex}let P=!1;if(O)if(i&&l){const e=n>0?t.charCodeAt(n-1):0,r=n>1?t.charCodeAt(n-2):0;32===e&&32!==r&&9!==r||(P=!0)}else P=!0;if(P)if(d)for(let e=(g>0?f[g-1].endIndex:s)+1;e<=n;e++)f[g++]=new LinePart(e,"mtkw",1,!1);else f[g++]=new LinePart(n,"mtkw",1,!1);else f[g++]=new LinePart(n,C,0,I);return f}function _applyInlineDecorations(e,t,n,r){r.sort(LineDecoration.compare);const i=LineDecorationsNormalizer.normalize(e,r),s=i.length;let a=0;const o=[];let c=0,h=0;for(let e=0,t=n.length;e<t;e++){const t=n[e],r=t.endIndex,l=t.type,p=t.metadata,d=t.containsRTL;for(;a<s&&i[a].startOffset<r;){const e=i[a];if(e.startOffset>h&&(h=e.startOffset,o[c++]=new LinePart(h,l,p,d)),!(e.endOffset+1<=r)){h=r,o[c++]=new LinePart(h,l+" "+e.className,p|e.metadata,d);break}h=e.endOffset+1,o[c++]=new LinePart(h,l+" "+e.className,p|e.metadata,d),a++}r>h&&(h=r,o[c++]=new LinePart(h,l,p,d))}const l=n[n.length-1].endIndex;if(a<s&&i[a].startOffset===l)for(;a<s&&i[a].startOffset===l;){const e=i[a];o[c++]=new LinePart(h,e.className,e.metadata,!1),a++}return o}function _renderLine(e,t){const n=e.fontIsMonospace,r=e.canUseHalfwidthRightwardsArrow,i=e.containsForeignElements,s=e.lineContent,a=e.len,o=e.isOverflowing,c=e.parts,h=e.fauxIndentLength,l=e.tabSize,p=e.startVisibleColumn,d=e.containsRTL,f=e.spaceWidth,g=e.renderSpaceCharCode,u=e.renderWhitespace,C=e.renderControlCharacters,I=new CharacterMapping(a+1,c.length);let L=!1,S=0,w=p,m=0,A=0,O=0;d?t.appendASCIIString('<span dir="ltr">'):t.appendASCIIString("<span>");for(let e=0,o=c.length;e<o;e++){const o=c[e],p=o.endIndex,d=o.type,R=o.containsRTL,x=0!==u&&o.isWhitespace(),W=x&&!n&&("mtkw"===d||!i),P=S===p&&o.isPseudoAfter();if(m=0,t.appendASCIIString("<span "),R&&t.appendASCIIString('style="unicode-bidi:isolate" '),t.appendASCIIString('class="'),t.appendASCIIString(W?"mtkz":d),t.appendASCII(34),x){let n=0;{let e=S,t=w;for(;e<p;e++){const r=0|(9===s.charCodeAt(e)?l-t%l:1);n+=r,e>=h&&(t+=r)}}for(W&&(t.appendASCIIString(' style="width:'),t.appendASCIIString(String(f*n)),t.appendASCIIString('px"')),t.appendASCII(62);S<p;S++){let n,i;if(I.setColumnInfo(S+1,e-O,m,A),O=0,9===s.charCodeAt(S)){n=l-w%l|0,i=n,!r||i>1?t.write1(8594):t.write1(65515);for(let e=2;e<=i;e++)t.write1(160)}else n=2,i=1,t.write1(g),t.write1(8204);m+=n,A+=i,S>=h&&(w+=i)}}else for(t.appendASCII(62);S<p;S++){I.setColumnInfo(S+1,e-O,m,A),O=0;const n=s.charCodeAt(S);let r=1,i=1;switch(n){case 9:r=l-w%l,i=r;for(let e=1;e<=r;e++)t.write1(160);break;case 32:t.write1(160);break;case 60:t.appendASCIIString("&lt;");break;case 62:t.appendASCIIString("&gt;");break;case 38:t.appendASCIIString("&amp;");break;case 0:C?t.write1(9216):t.appendASCIIString("&#00;");break;case 65279:case 8232:case 8233:case 133:t.write1(65533);break;default:strings.isFullWidthCharacter(n)&&i++,C&&n<32?t.write1(9216+n):C&&127===n?t.write1(9249):C&&isControlCharacter(n)?(t.appendASCIIString("[U+"),t.appendASCIIString(to4CharHex(n)),t.appendASCIIString("]"),r=8,i=r):t.write1(n)}m+=r,A+=i,S>=h&&(w+=i)}P?O++:O=0,S>=a&&!L&&o.isPseudoAfter()&&(L=!0,I.setColumnInfo(S+1,e,m,A)),t.appendASCIIString("</span>")}return L||I.setColumnInfo(a+1,c.length-1,m,A),o&&t.appendASCIIString("<span>&hellip;</span>"),t.appendASCIIString("</span>"),new RenderLineOutput(I,d,i)}function to4CharHex(e){return e.toString(16).toUpperCase().padStart(4,"0")}