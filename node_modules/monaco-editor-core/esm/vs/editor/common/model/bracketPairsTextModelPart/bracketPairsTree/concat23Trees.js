import{ListAstNode}from"./ast.js";export function concat23Trees(e){if(0===e.length)return null;if(1===e.length)return e[0];let t=0;function n(){if(t>=e.length)return null;const n=t,i=e[n].listHeight;for(t++;t<e.length&&e[t].listHeight===i;)t++;return t-n>=2?concat23TreesOfSameHeight(0===n&&t===e.length?e:e.slice(n,t),!1):e[n]}let i=n(),l=n();if(!l)return i;for(let e=n();e;e=n())heightDiff(i,l)<=heightDiff(l,e)?(i=concat(i,l),l=e):l=concat(l,e);return concat(i,l)}export function concat23TreesOfSameHeight(e,t=!1){if(0===e.length)return null;if(1===e.length)return e[0];let n=e.length;for(;n>3;){const i=n>>1;for(let l=0;l<i;l++){const i=l<<1;e[l]=ListAstNode.create23(e[i],e[i+1],i+3===n?e[i+2]:null,t)}n=i}return ListAstNode.create23(e[0],e[1],n>=3?e[2]:null,t)}function heightDiff(e,t){return Math.abs(e.listHeight-t.listHeight)}function concat(e,t){return e.listHeight===t.listHeight?ListAstNode.create23(e,t,null,!1):e.listHeight>t.listHeight?append(e,t):prepend(t,e)}function append(e,t){let n=e=e.toMutable();const i=new Array;let l;for(;;){if(t.listHeight===n.listHeight){l=t;break}if(4!==n.kind)throw new Error("unexpected");i.push(n),n=n.makeLastElementMutable()}for(let e=i.length-1;e>=0;e--){const t=i[e];l?t.childrenLength>=3?l=ListAstNode.create23(t.unappendChild(),l,null,!1):(t.appendChildOfSameHeight(l),l=void 0):t.handleChildrenChanged()}return l?ListAstNode.create23(e,l,null,!1):e}function prepend(e,t){let n=e=e.toMutable();const i=new Array;for(;t.listHeight!==n.listHeight;){if(4!==n.kind)throw new Error("unexpected");i.push(n),n=n.makeFirstElementMutable()}let l=t;for(let e=i.length-1;e>=0;e--){const t=i[e];l?t.childrenLength>=3?l=ListAstNode.create23(l,t.unprependChild(),null,!1):(t.prependChildOfSameHeight(l),l=void 0):t.handleChildrenChanged()}return l?ListAstNode.create23(l,e,null,!1):e}