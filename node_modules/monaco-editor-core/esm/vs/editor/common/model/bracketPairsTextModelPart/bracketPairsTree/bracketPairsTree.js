import{Emitter}from"../../../../../base/common/event.js";import{Disposable}from"../../../../../base/common/lifecycle.js";import{Range}from"../../../core/range.js";import{BracketInfo,BracketPairWithMinIndentationInfo}from"../../../textModelBracketPairs.js";import{TextEditInfo}from"./beforeEditPositionMapper.js";import{LanguageAgnosticBracketTokens}from"./brackets.js";import{lengthAdd,lengthGreaterThanEqual,lengthLessThan,lengthLessThanEqual,lengthOfString,lengthsToRange,lengthZero,positionToLength,toLength}from"./length.js";import{parseDocument}from"./parser.js";import{DenseKeyProvider}from"./smallImmutableSet.js";import{FastTokenizer,TextBufferTokenizer}from"./tokenizer.js";import{CallbackIterable}from"../../../../../base/common/arrays.js";export class BracketPairsTree extends Disposable{didLanguageChange(t){return this.brackets.didLanguageChange(t)}constructor(t,e){if(super(),this.textModel=t,this.getLanguageConfiguration=e,this.didChangeEmitter=new Emitter,this.denseKeyProvider=new DenseKeyProvider,this.brackets=new LanguageAgnosticBracketTokens(this.denseKeyProvider,this.getLanguageConfiguration),this.onDidChange=this.didChangeEmitter.event,0===t.tokenization.backgroundTokenizationState){const t=this.brackets.getSingleLanguageBracketTokens(this.textModel.getLanguageId()),e=new FastTokenizer(this.textModel.getValue(),t);this.initialAstWithoutTokens=parseDocument(e,[],void 0,!0),this.astWithTokens=this.initialAstWithoutTokens}else 2===t.tokenization.backgroundTokenizationState?(this.initialAstWithoutTokens=void 0,this.astWithTokens=this.parseDocumentFromTextBuffer([],void 0,!1)):1===t.tokenization.backgroundTokenizationState&&(this.initialAstWithoutTokens=this.parseDocumentFromTextBuffer([],void 0,!0),this.astWithTokens=this.initialAstWithoutTokens)}handleDidChangeBackgroundTokenizationState(){if(2===this.textModel.tokenization.backgroundTokenizationState){const t=void 0===this.initialAstWithoutTokens;this.initialAstWithoutTokens=void 0,t||this.didChangeEmitter.fire()}}handleDidChangeTokens({ranges:t}){const e=t.map((t=>new TextEditInfo(toLength(t.fromLineNumber-1,0),toLength(t.toLineNumber,0),toLength(t.toLineNumber-t.fromLineNumber+1,0))));this.astWithTokens=this.parseDocumentFromTextBuffer(e,this.astWithTokens,!1),this.initialAstWithoutTokens||this.didChangeEmitter.fire()}handleContentChanged(t){const e=t.changes.map((t=>{const e=Range.lift(t.range);return new TextEditInfo(positionToLength(e.getStartPosition()),positionToLength(e.getEndPosition()),lengthOfString(t.text))})).reverse();this.astWithTokens=this.parseDocumentFromTextBuffer(e,this.astWithTokens,!1),this.initialAstWithoutTokens&&(this.initialAstWithoutTokens=this.parseDocumentFromTextBuffer(e,this.initialAstWithoutTokens,!1))}parseDocumentFromTextBuffer(t,e,n){const i=e,o=new TextBufferTokenizer(this.textModel,this.brackets);return parseDocument(o,t,i,n)}getBracketsInRange(t){const e=toLength(t.startLineNumber-1,t.startColumn-1),n=toLength(t.endLineNumber-1,t.endColumn-1);return new CallbackIterable((t=>{const i=this.initialAstWithoutTokens||this.astWithTokens;collectBrackets(i,lengthZero,i.length,e,n,t,0,new Map)}))}getBracketPairsInRange(t,e){const n=positionToLength(t.getStartPosition()),i=positionToLength(t.getEndPosition());return new CallbackIterable((t=>{const o=this.initialAstWithoutTokens||this.astWithTokens,r=new CollectBracketPairsContext(t,e,this.textModel);collectBracketPairs(o,lengthZero,o.length,n,i,r,0,new Map)}))}getFirstBracketAfter(t){const e=this.initialAstWithoutTokens||this.astWithTokens;return getFirstBracketAfter(e,lengthZero,e.length,positionToLength(t))}getFirstBracketBefore(t){const e=this.initialAstWithoutTokens||this.astWithTokens;return getFirstBracketBefore(e,lengthZero,e.length,positionToLength(t))}}function getFirstBracketBefore(t,e,n,i){if(4===t.kind||2===t.kind){const o=[];for(const i of t.children)n=lengthAdd(e,i.length),o.push({nodeOffsetStart:e,nodeOffsetEnd:n}),e=n;for(let e=o.length-1;e>=0;e--){const{nodeOffsetStart:n,nodeOffsetEnd:r}=o[e];if(lengthLessThan(n,i)){const o=getFirstBracketBefore(t.children[e],n,r,i);if(o)return o}}return null}if(3===t.kind)return null;if(1===t.kind){const i=lengthsToRange(e,n);return{bracketInfo:t.bracketInfo,range:i}}return null}function getFirstBracketAfter(t,e,n,i){if(4===t.kind||2===t.kind){for(const o of t.children){if(n=lengthAdd(e,o.length),lengthLessThan(i,n)){const t=getFirstBracketAfter(o,e,n,i);if(t)return t}e=n}return null}if(3===t.kind)return null;if(1===t.kind){const i=lengthsToRange(e,n);return{bracketInfo:t.bracketInfo,range:i}}return null}function collectBrackets(t,e,n,i,o,r,s,a){if(s>200)return!0;t:for(;;)switch(t.kind){case 4:{const h=t.childrenLength;for(let l=0;l<h;l++){const h=t.getChild(l);if(h){if(n=lengthAdd(e,h.length),lengthLessThanEqual(e,o)&&lengthGreaterThanEqual(n,i)){if(lengthGreaterThanEqual(n,o)){t=h;continue t}if(!collectBrackets(h,e,n,i,o,r,s,a))return!1}e=n}}return!0}case 2:{let h=0;if(a){let e=a.get(t.openingBracket.text);void 0===e&&(e=0),h=e,e++,a.set(t.openingBracket.text,e)}const l=t.childrenLength;for(let h=0;h<l;h++){const l=t.getChild(h);if(l){if(n=lengthAdd(e,l.length),lengthLessThanEqual(e,o)&&lengthGreaterThanEqual(n,i)){if(lengthGreaterThanEqual(n,o)){t=l,s++;continue t}if(!collectBrackets(l,e,n,i,o,r,s+1,a))return!1}e=n}}return null==a||a.set(t.openingBracket.text,h),!0}case 3:{const t=lengthsToRange(e,n);return r(new BracketInfo(t,s-1,0,!0))}case 1:{const t=lengthsToRange(e,n);return r(new BracketInfo(t,s-1,0,!1))}case 0:return!0}}class CollectBracketPairsContext{constructor(t,e,n){this.push=t,this.includeMinIndentation=e,this.textModel=n}}function collectBracketPairs(t,e,n,i,o,r,s,a){var h;if(s>200)return!0;let l=!0;if(2===t.kind){let g=0;if(a){let e=a.get(t.openingBracket.text);void 0===e&&(e=0),g=e,e++,a.set(t.openingBracket.text,e)}const c=lengthAdd(e,t.openingBracket.length);let u=-1;if(r.includeMinIndentation&&(u=t.computeMinIndentation(e,r.textModel)),l=r.push(new BracketPairWithMinIndentationInfo(lengthsToRange(e,n),lengthsToRange(e,c),t.closingBracket?lengthsToRange(lengthAdd(c,(null===(h=t.child)||void 0===h?void 0:h.length)||lengthZero),n):void 0,s,g,t,u)),e=c,l&&t.child){const h=t.child;if(n=lengthAdd(e,h.length),lengthLessThanEqual(e,o)&&lengthGreaterThanEqual(n,i)&&(l=collectBracketPairs(h,e,n,i,o,r,s+1,a),!l))return!1}null==a||a.set(t.openingBracket.text,g)}else{let n=e;for(const e of t.children){const t=n;if(n=lengthAdd(n,e.length),lengthLessThanEqual(t,o)&&lengthLessThanEqual(i,n)&&(l=collectBracketPairs(e,t,n,i,o,r,s,a),!l))return!1}}return l}