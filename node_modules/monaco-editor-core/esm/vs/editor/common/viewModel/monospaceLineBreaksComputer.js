import*as strings from"../../../base/common/strings.js";import{CharacterClassifier}from"../core/characterClassifier.js";import{LineInjectedText}from"../textModelEvents.js";import{ModelLineProjectionData}from"../modelLineProjectionData.js";export class MonospaceLineBreaksComputerFactory{static create(e){return new MonospaceLineBreaksComputerFactory(e.get(122),e.get(121))}constructor(e,t){this.classifier=new WrappingCharacterClassifier(e,t)}createLineBreaksComputer(e,t,r,a){const n=[],i=[],o=[];return{addRequest:(e,t,r)=>{n.push(e),i.push(t),o.push(r)},finalize:()=>{const s=e.typicalFullwidthCharacterWidth/e.typicalHalfwidthCharacterWidth,c=[];for(let e=0,l=n.length;e<l;e++){const l=i[e],h=o[e];!h||h.injectionOptions||l?c[e]=createLineBreaks(this.classifier,n[e],l,t,r,s,a):c[e]=createLineBreaksFromPreviousLineBreaks(this.classifier,h,n[e],t,r,s,a)}return arrPool1.length=0,arrPool2.length=0,c}}}}class WrappingCharacterClassifier extends CharacterClassifier{constructor(e,t){super(0);for(let t=0;t<e.length;t++)this.set(e.charCodeAt(t),1);for(let e=0;e<t.length;e++)this.set(t.charCodeAt(e),2)}get(e){return e>=0&&e<256?this._asciiMap[e]:e>=12352&&e<=12543||e>=13312&&e<=19903||e>=19968&&e<=40959?3:this._map.get(e)||this._defaultValue}}let arrPool1=[],arrPool2=[];function createLineBreaksFromPreviousLineBreaks(e,t,r,a,n,i,o){if(-1===n)return null;const s=r.length;if(s<=1)return null;const c=t.breakOffsets,l=t.breakOffsetsVisibleColumn,h=computeWrappedTextIndentLength(r,a,n,i,o),f=n-h,u=arrPool1,g=arrPool2;let d=0,p=0,C=0,m=n;const k=c.length;let b=0;if(b>=0){let e=Math.abs(l[b]-m);for(;b+1<k;){const t=Math.abs(l[b+1]-m);if(t>=e)break;e=t,b++}}for(;b<k;){let t=b<0?0:c[b],n=b<0?0:l[b];p>t&&(t=p,n=C);let o=0,h=0,L=0,W=0;if(n<=m){let C=n,k=0===t?0:r.charCodeAt(t-1),b=0===t?0:e.get(k),P=!0;for(let n=t;n<s;n++){const t=n,s=r.charCodeAt(n);let c,l;if(strings.isHighSurrogate(s)?(n++,c=0,l=2):(c=e.get(s),l=computeCharWidth(s,C,a,i)),t>p&&canBreak(k,b,s,c)&&(o=t,h=C),C+=l,C>m){t>p?(L=t,W=C-l):(L=n+1,W=C),C-h>f&&(o=0),P=!1;break}k=s,b=c}if(P){d>0&&(u[d]=c[c.length-1],g[d]=l[c.length-1],d++);break}}if(0===o){let s=n,c=r.charCodeAt(t),l=e.get(c),u=!1;for(let a=t-1;a>=p;a--){const t=a+1,n=r.charCodeAt(a);if(9===n){u=!0;break}let g,d;if(strings.isLowSurrogate(n)?(a--,g=0,d=2):(g=e.get(n),d=strings.isFullWidthCharacter(n)?i:1),s<=m){if(0===L&&(L=t,W=s),s<=m-f)break;if(canBreak(n,g,c,l)){o=t,h=s;break}}s-=d,c=n,l=g}if(0!==o){const e=f-(W-h);if(e<=a){const t=r.charCodeAt(L);let n;n=strings.isHighSurrogate(t)?2:computeCharWidth(t,W,a,i),e-n<0&&(o=0)}}if(u){b--;continue}}if(0===o&&(o=L,h=W),o<=p){const e=r.charCodeAt(p);strings.isHighSurrogate(e)?(o=p+2,h=C+2):(o=p+1,h=C+computeCharWidth(e,C,a,i))}for(p=o,u[d]=o,C=h,g[d]=h,d++,m=h+f;b<0||b<k&&l[b]<h;)b++;let P=Math.abs(l[b]-m);for(;b+1<k;){const e=Math.abs(l[b+1]-m);if(e>=P)break;P=e,b++}}return 0===d?null:(u.length=d,g.length=d,arrPool1=t.breakOffsets,arrPool2=t.breakOffsetsVisibleColumn,t.breakOffsets=u,t.breakOffsetsVisibleColumn=g,t.wrappedTextIndentLength=h,t)}function createLineBreaks(e,t,r,a,n,i,o){const s=LineInjectedText.applyInjectedText(t,r);let c,l;if(r&&r.length>0?(c=r.map((e=>e.options)),l=r.map((e=>e.column-1))):(c=null,l=null),-1===n)return c?new ModelLineProjectionData(l,c,[s.length],[],0):null;const h=s.length;if(h<=1)return c?new ModelLineProjectionData(l,c,[s.length],[],0):null;const f=computeWrappedTextIndentLength(s,a,n,i,o),u=n-f,g=[],d=[];let p=0,C=0,m=0,k=n,b=s.charCodeAt(0),L=e.get(b),W=computeCharWidth(b,0,a,i),P=1;strings.isHighSurrogate(b)&&(W+=1,b=s.charCodeAt(1),L=e.get(b),P++);for(let t=P;t<h;t++){const r=t,n=s.charCodeAt(t);let o,c;strings.isHighSurrogate(n)?(t++,o=0,c=2):(o=e.get(n),c=computeCharWidth(n,W,a,i)),canBreak(b,L,n,o)&&(C=r,m=W),W+=c,W>k&&((0===C||W-m>u)&&(C=r,m=W-c),g[p]=C,d[p]=m,p++,k=m+u,C=0),b=n,L=o}return 0!==p||r&&0!==r.length?(g[p]=h,d[p]=W,new ModelLineProjectionData(l,c,g,d,f)):null}function computeCharWidth(e,t,r,a){return 9===e?r-t%r:strings.isFullWidthCharacter(e)||e<32?a:1}function tabCharacterWidth(e,t){return t-e%t}function canBreak(e,t,r,a){return 32!==r&&(2===t&&2!==a||1!==t&&1===a||3===t&&2!==a||3===a&&1!==t)}function computeWrappedTextIndentLength(e,t,r,a,n){let i=0;if(0!==n){const o=strings.firstNonWhitespaceIndex(e);if(-1!==o){for(let r=0;r<o;r++)i+=9===e.charCodeAt(r)?tabCharacterWidth(i,t):1;const s=3===n?2:2===n?1:0;for(let e=0;e<s;e++)i+=tabCharacterWidth(i,t);i+a>r&&(i=0)}}return i}