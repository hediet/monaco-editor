import"./minimap.css";import*as dom from"../../../../base/browser/dom.js";import{createFastDomNode}from"../../../../base/browser/fastDomNode.js";import{GlobalPointerMoveMonitor}from"../../../../base/browser/globalPointerMoveMonitor.js";import{Disposable}from"../../../../base/common/lifecycle.js";import*as platform from"../../../../base/common/platform.js";import*as strings from"../../../../base/common/strings.js";import{RenderedLinesCollection}from"../../view/viewLayer.js";import{PartFingerprints,ViewPart}from"../../view/viewPart.js";import{MINIMAP_GUTTER_WIDTH,EditorLayoutInfoComputer}from"../../../common/config/editorOptions.js";import{Range}from"../../../common/core/range.js";import{RGBA8}from"../../../common/core/rgba.js";import{MinimapTokensColorTracker}from"../../../common/viewModel/minimapTokensColorTracker.js";import{ViewModelDecoration}from"../../../common/viewModel.js";import{minimapSelection,scrollbarShadow,minimapBackground,minimapSliderBackground,minimapSliderHoverBackground,minimapSliderActiveBackground,minimapForegroundOpacity}from"../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";import{Selection}from"../../../common/core/selection.js";import{EventType,Gesture}from"../../../../base/browser/touch.js";import{MinimapCharRendererFactory}from"./minimapCharRendererFactory.js";import{MinimapPosition}from"../../../common/model.js";import{once}from"../../../../base/common/functional.js";const POINTER_DRAG_RESET_DISTANCE=140,GUTTER_DECORATION_WIDTH=2;class MinimapOptions{constructor(e,t,i){const n=e.options,s=n.get(131),o=n.get(133),a=o.minimap,r=n.get(45),h=n.get(66);this.renderMinimap=a.renderMinimap,this.size=h.size,this.minimapHeightIsEditorHeight=a.minimapHeightIsEditorHeight,this.scrollBeyondLastLine=n.get(95),this.showSlider=h.showSlider,this.autohide=h.autohide,this.pixelRatio=s,this.typicalHalfwidthCharacterWidth=r.typicalHalfwidthCharacterWidth,this.lineHeight=n.get(60),this.minimapLeft=a.minimapLeft,this.minimapWidth=a.minimapWidth,this.minimapHeight=o.height,this.canvasInnerWidth=a.minimapCanvasInnerWidth,this.canvasInnerHeight=a.minimapCanvasInnerHeight,this.canvasOuterWidth=a.minimapCanvasOuterWidth,this.canvasOuterHeight=a.minimapCanvasOuterHeight,this.isSampling=a.minimapIsSampling,this.editorHeight=o.height,this.fontScale=a.minimapScale,this.minimapLineHeight=a.minimapLineHeight,this.minimapCharWidth=1*this.fontScale,this.charRenderer=once((()=>MinimapCharRendererFactory.create(this.fontScale,r.fontFamily))),this.defaultBackgroundColor=i.getColor(2),this.backgroundColor=MinimapOptions._getMinimapBackground(t,this.defaultBackgroundColor),this.foregroundAlpha=MinimapOptions._getMinimapForegroundOpacity(t)}static _getMinimapBackground(e,t){const i=e.getColor(minimapBackground);return i?new RGBA8(i.rgba.r,i.rgba.g,i.rgba.b,Math.round(255*i.rgba.a)):t}static _getMinimapForegroundOpacity(e){const t=e.getColor(minimapForegroundOpacity);return t?RGBA8._clamp(Math.round(255*t.rgba.a)):255}equals(e){return this.renderMinimap===e.renderMinimap&&this.size===e.size&&this.minimapHeightIsEditorHeight===e.minimapHeightIsEditorHeight&&this.scrollBeyondLastLine===e.scrollBeyondLastLine&&this.showSlider===e.showSlider&&this.autohide===e.autohide&&this.pixelRatio===e.pixelRatio&&this.typicalHalfwidthCharacterWidth===e.typicalHalfwidthCharacterWidth&&this.lineHeight===e.lineHeight&&this.minimapLeft===e.minimapLeft&&this.minimapWidth===e.minimapWidth&&this.minimapHeight===e.minimapHeight&&this.canvasInnerWidth===e.canvasInnerWidth&&this.canvasInnerHeight===e.canvasInnerHeight&&this.canvasOuterWidth===e.canvasOuterWidth&&this.canvasOuterHeight===e.canvasOuterHeight&&this.isSampling===e.isSampling&&this.editorHeight===e.editorHeight&&this.fontScale===e.fontScale&&this.minimapLineHeight===e.minimapLineHeight&&this.minimapCharWidth===e.minimapCharWidth&&this.defaultBackgroundColor&&this.defaultBackgroundColor.equals(e.defaultBackgroundColor)&&this.backgroundColor&&this.backgroundColor.equals(e.backgroundColor)&&this.foregroundAlpha===e.foregroundAlpha}}class MinimapLayout{constructor(e,t,i,n,s,o,a,r){this.scrollTop=e,this.scrollHeight=t,this.sliderNeeded=i,this._computedSliderRatio=n,this.sliderTop=s,this.sliderHeight=o,this.startLineNumber=a,this.endLineNumber=r}getDesiredScrollTopFromDelta(e){return Math.round(this.scrollTop+e/this._computedSliderRatio)}getDesiredScrollTopFromTouchLocation(e){return Math.round((e-this.sliderHeight/2)/this._computedSliderRatio)}static create(e,t,i,n,s,o,a,r,h,l,d){const m=e.pixelRatio,c=e.minimapLineHeight,p=Math.floor(e.canvasInnerHeight/c),u=e.lineHeight;if(e.minimapHeightIsEditorHeight){const t=r*e.lineHeight+(e.scrollBeyondLastLine?s-e.lineHeight:0),i=Math.max(1,Math.floor(s*s/t)),n=Math.max(0,e.minimapHeight-i),o=n/(l-s),d=h*o,m=n>0,c=Math.floor(e.canvasInnerHeight/e.minimapLineHeight);return new MinimapLayout(h,l,m,o,d,i,1,Math.min(a,c))}let g,_;if(o&&i!==a){const e=i-t+1;g=Math.floor(e*c/m)}else{const e=s/u;g=Math.floor(e*c/m)}_=e.scrollBeyondLastLine?(a-1)*c/m:Math.max(0,a*c/m-g),_=Math.min(e.minimapHeight-g,_);const L=_/(l-s),f=h*L;let C=0;if(e.scrollBeyondLastLine&&(C=s/u-1),p>=a+C)return new MinimapLayout(h,l,_>0,L,f,g,1,a);{let e=Math.max(1,Math.floor(t-f*m/c));d&&d.scrollHeight===l&&(d.scrollTop>h&&(e=Math.min(e,d.startLineNumber)),d.scrollTop<h&&(e=Math.max(e,d.startLineNumber)));const i=Math.min(a,e+p-1);return new MinimapLayout(h,l,!0,L,(t-e+(h-n)/u)*c/m,g,e,i)}}}class MinimapLine{constructor(e){this.dy=e}onContentChanged(){this.dy=-1}onTokensChanged(){this.dy=-1}}MinimapLine.INVALID=new MinimapLine(-1);class RenderData{constructor(e,t,i){this.renderedLayout=e,this._imageData=t,this._renderedLines=new RenderedLinesCollection((()=>MinimapLine.INVALID)),this._renderedLines._set(e.startLineNumber,i)}linesEquals(e){if(!this.scrollEquals(e))return!1;const t=this._renderedLines._get().lines;for(let e=0,i=t.length;e<i;e++)if(-1===t[e].dy)return!1;return!0}scrollEquals(e){return this.renderedLayout.startLineNumber===e.startLineNumber&&this.renderedLayout.endLineNumber===e.endLineNumber}_get(){const e=this._renderedLines._get();return{imageData:this._imageData,rendLineNumberStart:e.rendLineNumberStart,lines:e.lines}}onLinesChanged(e,t){return this._renderedLines.onLinesChanged(e,t)}onLinesDeleted(e,t){this._renderedLines.onLinesDeleted(e,t)}onLinesInserted(e,t){this._renderedLines.onLinesInserted(e,t)}onTokensChanged(e){return this._renderedLines.onTokensChanged(e)}}class MinimapBuffers{constructor(e,t,i,n){this._backgroundFillData=MinimapBuffers._createBackgroundFillData(t,i,n),this._buffers=[e.createImageData(t,i),e.createImageData(t,i)],this._lastUsedBuffer=0}getBuffer(){this._lastUsedBuffer=1-this._lastUsedBuffer;const e=this._buffers[this._lastUsedBuffer];return e.data.set(this._backgroundFillData),e}static _createBackgroundFillData(e,t,i){const n=i.r,s=i.g,o=i.b,a=i.a,r=new Uint8ClampedArray(e*t*4);let h=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++)r[h]=n,r[h+1]=s,r[h+2]=o,r[h+3]=a,h+=4;return r}}class MinimapSamplingState{static compute(e,t,i){if(0===e.renderMinimap||!e.isSampling)return[null,[]];const n=e.pixelRatio,s=e.lineHeight,o=e.scrollBeyondLastLine,{minimapLineCount:a}=EditorLayoutInfoComputer.computeContainedMinimapLineCount({viewLineCount:t,scrollBeyondLastLine:o,height:e.editorHeight,lineHeight:s,pixelRatio:n}),r=t/a,h=r/2;if(!i||0===i.minimapLines.length){const e=[];if(e[0]=1,a>1){for(let t=0,i=a-1;t<i;t++)e[t]=Math.round(t*r+h);e[a-1]=t}return[new MinimapSamplingState(r,e),[]]}const l=i.minimapLines,d=l.length,m=[];let c=0,p=0,u=1,g=[],_=null;for(let e=0;e<a;e++){const i=Math.max(u,Math.round(e*r)),n=Math.max(i,Math.round((e+1)*r));for(;c<d&&l[c]<i;){if(g.length<10){const e=c+1+p;_&&"deleted"===_.type&&_._oldIndex===c-1?_.deleteToLineNumber++:(_={type:"deleted",_oldIndex:c,deleteFromLineNumber:e,deleteToLineNumber:e},g.push(_)),p--}c++}let s;if(c<d&&l[c]<=n)s=l[c],c++;else if(s=0===e?1:e+1===a?t:Math.round(e*r+h),g.length<10){const t=c+1+p;_&&"inserted"===_.type&&_._i===e-1?_.insertToLineNumber++:(_={type:"inserted",_i:e,insertFromLineNumber:t,insertToLineNumber:t},g.push(_)),p++}m[e]=s,u=s}if(g.length<10)for(;c<d;){const e=c+1+p;_&&"deleted"===_.type&&_._oldIndex===c-1?_.deleteToLineNumber++:(_={type:"deleted",_oldIndex:c,deleteFromLineNumber:e,deleteToLineNumber:e},g.push(_)),p--,c++}else g=[{type:"flush"}];return[new MinimapSamplingState(r,m),g]}constructor(e,t){this.samplingRatio=e,this.minimapLines=t}modelLineToMinimapLine(e){return Math.min(this.minimapLines.length,Math.max(1,Math.round(e/this.samplingRatio)))}modelLineRangeToMinimapLineRange(e,t){let i=this.modelLineToMinimapLine(e)-1;for(;i>0&&this.minimapLines[i-1]>=e;)i--;let n=this.modelLineToMinimapLine(t)-1;for(;n+1<this.minimapLines.length&&this.minimapLines[n+1]<=t;)n++;if(i===n){const n=this.minimapLines[i];if(n<e||n>t)return null}return[i+1,n+1]}decorationLineRangeToMinimapLineRange(e,t){let i=this.modelLineToMinimapLine(e),n=this.modelLineToMinimapLine(t);return e!==t&&n===i&&(n===this.minimapLines.length?i>1&&i--:n++),[i,n]}onLinesDeleted(e){const t=e.toLineNumber-e.fromLineNumber+1;let i=this.minimapLines.length,n=0;for(let s=this.minimapLines.length-1;s>=0&&!(this.minimapLines[s]<e.fromLineNumber);s--)this.minimapLines[s]<=e.toLineNumber?(this.minimapLines[s]=Math.max(1,e.fromLineNumber-1),i=Math.min(i,s),n=Math.max(n,s)):this.minimapLines[s]-=t;return[i,n]}onLinesInserted(e){const t=e.toLineNumber-e.fromLineNumber+1;for(let i=this.minimapLines.length-1;i>=0&&!(this.minimapLines[i]<e.fromLineNumber);i--)this.minimapLines[i]+=t}}export class Minimap extends ViewPart{constructor(e){super(e),this.tokensColorTracker=MinimapTokensColorTracker.getInstance(),this._selections=[],this._minimapSelections=null,this.options=new MinimapOptions(this._context.configuration,this._context.theme,this.tokensColorTracker);const[t]=MinimapSamplingState.compute(this.options,this._context.viewModel.getLineCount(),null);this._samplingState=t,this._shouldCheckSampling=!1,this._actual=new InnerMinimap(e.theme,this)}dispose(){this._actual.dispose(),super.dispose()}getDomNode(){return this._actual.getDomNode()}_onOptionsMaybeChanged(){const e=new MinimapOptions(this._context.configuration,this._context.theme,this.tokensColorTracker);return!this.options.equals(e)&&(this.options=e,this._recreateLineSampling(),this._actual.onDidChangeOptions(),!0)}onConfigurationChanged(e){return this._onOptionsMaybeChanged()}onCursorStateChanged(e){return this._selections=e.selections,this._minimapSelections=null,this._actual.onSelectionChanged()}onDecorationsChanged(e){return!!e.affectsMinimap&&this._actual.onDecorationsChanged()}onFlushed(e){return this._samplingState&&(this._shouldCheckSampling=!0),this._actual.onFlushed()}onLinesChanged(e){if(this._samplingState){const t=this._samplingState.modelLineRangeToMinimapLineRange(e.fromLineNumber,e.fromLineNumber+e.count-1);return!!t&&this._actual.onLinesChanged(t[0],t[1]-t[0]+1)}return this._actual.onLinesChanged(e.fromLineNumber,e.count)}onLinesDeleted(e){if(this._samplingState){const[t,i]=this._samplingState.onLinesDeleted(e);return t<=i&&this._actual.onLinesChanged(t+1,i-t+1),this._shouldCheckSampling=!0,!0}return this._actual.onLinesDeleted(e.fromLineNumber,e.toLineNumber)}onLinesInserted(e){return this._samplingState?(this._samplingState.onLinesInserted(e),this._shouldCheckSampling=!0,!0):this._actual.onLinesInserted(e.fromLineNumber,e.toLineNumber)}onScrollChanged(e){return this._actual.onScrollChanged()}onThemeChanged(e){return this._actual.onThemeChanged(),this._onOptionsMaybeChanged(),!0}onTokensChanged(e){if(this._samplingState){const t=[];for(const i of e.ranges){const e=this._samplingState.modelLineRangeToMinimapLineRange(i.fromLineNumber,i.toLineNumber);e&&t.push({fromLineNumber:e[0],toLineNumber:e[1]})}return!!t.length&&this._actual.onTokensChanged(t)}return this._actual.onTokensChanged(e.ranges)}onTokensColorsChanged(e){return this._onOptionsMaybeChanged(),this._actual.onTokensColorsChanged()}onZonesChanged(e){return this._actual.onZonesChanged()}prepareRender(e){this._shouldCheckSampling&&(this._shouldCheckSampling=!1,this._recreateLineSampling())}render(e){let t=e.visibleRange.startLineNumber,i=e.visibleRange.endLineNumber;this._samplingState&&(t=this._samplingState.modelLineToMinimapLine(t),i=this._samplingState.modelLineToMinimapLine(i));const n={viewportContainsWhitespaceGaps:e.viewportData.whitespaceViewportData.length>0,scrollWidth:e.scrollWidth,scrollHeight:e.scrollHeight,viewportStartLineNumber:t,viewportEndLineNumber:i,viewportStartLineNumberVerticalOffset:e.getVerticalOffsetForLineNumber(t),scrollTop:e.scrollTop,scrollLeft:e.scrollLeft,viewportWidth:e.viewportWidth,viewportHeight:e.viewportHeight};this._actual.render(n)}_recreateLineSampling(){this._minimapSelections=null;const e=Boolean(this._samplingState),[t,i]=MinimapSamplingState.compute(this.options,this._context.viewModel.getLineCount(),this._samplingState);if(this._samplingState=t,e&&this._samplingState)for(const e of i)switch(e.type){case"deleted":this._actual.onLinesDeleted(e.deleteFromLineNumber,e.deleteToLineNumber);break;case"inserted":this._actual.onLinesInserted(e.insertFromLineNumber,e.insertToLineNumber);break;case"flush":this._actual.onFlushed()}}getLineCount(){return this._samplingState?this._samplingState.minimapLines.length:this._context.viewModel.getLineCount()}getRealLineCount(){return this._context.viewModel.getLineCount()}getLineContent(e){return this._samplingState?this._context.viewModel.getLineContent(this._samplingState.minimapLines[e-1]):this._context.viewModel.getLineContent(e)}getLineMaxColumn(e){return this._samplingState?this._context.viewModel.getLineMaxColumn(this._samplingState.minimapLines[e-1]):this._context.viewModel.getLineMaxColumn(e)}getMinimapLinesRenderingData(e,t,i){if(this._samplingState){const n=[];for(let s=0,o=t-e+1;s<o;s++)i[s]?n[s]=this._context.viewModel.getViewLineData(this._samplingState.minimapLines[e+s-1]):n[s]=null;return n}return this._context.viewModel.getMinimapLinesRenderingData(e,t,i).data}getSelections(){if(null===this._minimapSelections)if(this._samplingState){this._minimapSelections=[];for(const e of this._selections){const[t,i]=this._samplingState.decorationLineRangeToMinimapLineRange(e.startLineNumber,e.endLineNumber);this._minimapSelections.push(new Selection(t,e.startColumn,i,e.endColumn))}}else this._minimapSelections=this._selections;return this._minimapSelections}getMinimapDecorationsInViewport(e,t){let i;if(this._samplingState){const n=this._samplingState.minimapLines[e-1],s=this._samplingState.minimapLines[t-1];i=new Range(n,1,s,this._context.viewModel.getLineMaxColumn(s))}else i=new Range(e,1,t,this._context.viewModel.getLineMaxColumn(t));const n=this._context.viewModel.getDecorationsInViewport(i,!0);if(this._samplingState){const e=[];for(const t of n){if(!t.options.minimap)continue;const i=t.range,n=this._samplingState.modelLineToMinimapLine(i.startLineNumber),s=this._samplingState.modelLineToMinimapLine(i.endLineNumber);e.push(new ViewModelDecoration(new Range(n,i.startColumn,s,i.endColumn),t.options))}return e}return n}getOptions(){return this._context.viewModel.model.getOptions()}revealLineNumber(e){this._samplingState&&(e=this._samplingState.minimapLines[e-1]),this._context.viewModel.revealRange("mouse",!1,new Range(e,1,e,1),1,0)}setScrollTop(e){this._context.viewModel.viewLayout.setScrollPosition({scrollTop:e},1)}}class InnerMinimap extends Disposable{constructor(e,t){super(),this._renderDecorations=!1,this._gestureInProgress=!1,this._theme=e,this._model=t,this._lastRenderData=null,this._buffers=null,this._selectionColor=this._theme.getColor(minimapSelection),this._domNode=createFastDomNode(document.createElement("div")),PartFingerprints.write(this._domNode,8),this._domNode.setClassName(this._getMinimapDomNodeClassName()),this._domNode.setPosition("absolute"),this._domNode.setAttribute("role","presentation"),this._domNode.setAttribute("aria-hidden","true"),this._shadow=createFastDomNode(document.createElement("div")),this._shadow.setClassName("minimap-shadow-hidden"),this._domNode.appendChild(this._shadow),this._canvas=createFastDomNode(document.createElement("canvas")),this._canvas.setPosition("absolute"),this._canvas.setLeft(0),this._domNode.appendChild(this._canvas),this._decorationsCanvas=createFastDomNode(document.createElement("canvas")),this._decorationsCanvas.setPosition("absolute"),this._decorationsCanvas.setClassName("minimap-decorations-layer"),this._decorationsCanvas.setLeft(0),this._domNode.appendChild(this._decorationsCanvas),this._slider=createFastDomNode(document.createElement("div")),this._slider.setPosition("absolute"),this._slider.setClassName("minimap-slider"),this._slider.setLayerHinting(!0),this._slider.setContain("strict"),this._domNode.appendChild(this._slider),this._sliderHorizontal=createFastDomNode(document.createElement("div")),this._sliderHorizontal.setPosition("absolute"),this._sliderHorizontal.setClassName("minimap-slider-horizontal"),this._slider.appendChild(this._sliderHorizontal),this._applyLayout(),this._pointerDownListener=dom.addStandardDisposableListener(this._domNode.domNode,dom.EventType.POINTER_DOWN,(e=>{if(e.preventDefault(),0===this._model.options.renderMinimap)return;if(!this._lastRenderData)return;if("proportional"!==this._model.options.size){if(0===e.button&&this._lastRenderData){const t=dom.getDomNodePagePosition(this._slider.domNode),i=t.top+t.height/2;this._startSliderDragging(e,i,this._lastRenderData.renderedLayout)}return}const t=this._model.options.minimapLineHeight,i=this._model.options.canvasInnerHeight/this._model.options.canvasOuterHeight*e.offsetY;let n=Math.floor(i/t)+this._lastRenderData.renderedLayout.startLineNumber;n=Math.min(n,this._model.getLineCount()),this._model.revealLineNumber(n)})),this._sliderPointerMoveMonitor=new GlobalPointerMoveMonitor,this._sliderPointerDownListener=dom.addStandardDisposableListener(this._slider.domNode,dom.EventType.POINTER_DOWN,(e=>{e.preventDefault(),e.stopPropagation(),0===e.button&&this._lastRenderData&&this._startSliderDragging(e,e.pageY,this._lastRenderData.renderedLayout)})),this._gestureDisposable=Gesture.addTarget(this._domNode.domNode),this._sliderTouchStartListener=dom.addDisposableListener(this._domNode.domNode,EventType.Start,(e=>{e.preventDefault(),e.stopPropagation(),this._lastRenderData&&(this._slider.toggleClassName("active",!0),this._gestureInProgress=!0,this.scrollDueToTouchEvent(e))}),{passive:!1}),this._sliderTouchMoveListener=dom.addDisposableListener(this._domNode.domNode,EventType.Change,(e=>{e.preventDefault(),e.stopPropagation(),this._lastRenderData&&this._gestureInProgress&&this.scrollDueToTouchEvent(e)}),{passive:!1}),this._sliderTouchEndListener=dom.addStandardDisposableListener(this._domNode.domNode,EventType.End,(e=>{e.preventDefault(),e.stopPropagation(),this._gestureInProgress=!1,this._slider.toggleClassName("active",!1)}))}_startSliderDragging(e,t,i){if(!(e.target&&e.target instanceof Element))return;const n=e.pageX;this._slider.toggleClassName("active",!0);const s=(e,s)=>{const o=Math.abs(s-n);if(platform.isWindows&&o>140)return void this._model.setScrollTop(i.scrollTop);const a=e-t;this._model.setScrollTop(i.getDesiredScrollTopFromDelta(a))};e.pageY!==t&&s(e.pageY,n),this._sliderPointerMoveMonitor.startMonitoring(e.target,e.pointerId,e.buttons,(e=>s(e.pageY,e.pageX)),(()=>{this._slider.toggleClassName("active",!1)}))}scrollDueToTouchEvent(e){const t=this._domNode.domNode.getBoundingClientRect().top,i=this._lastRenderData.renderedLayout.getDesiredScrollTopFromTouchLocation(e.pageY-t);this._model.setScrollTop(i)}dispose(){this._pointerDownListener.dispose(),this._sliderPointerMoveMonitor.dispose(),this._sliderPointerDownListener.dispose(),this._gestureDisposable.dispose(),this._sliderTouchStartListener.dispose(),this._sliderTouchMoveListener.dispose(),this._sliderTouchEndListener.dispose(),super.dispose()}_getMinimapDomNodeClassName(){const e=["minimap"];return"always"===this._model.options.showSlider?e.push("slider-always"):e.push("slider-mouseover"),this._model.options.autohide&&e.push("autohide"),e.join(" ")}getDomNode(){return this._domNode}_applyLayout(){this._domNode.setLeft(this._model.options.minimapLeft),this._domNode.setWidth(this._model.options.minimapWidth),this._domNode.setHeight(this._model.options.minimapHeight),this._shadow.setHeight(this._model.options.minimapHeight),this._canvas.setWidth(this._model.options.canvasOuterWidth),this._canvas.setHeight(this._model.options.canvasOuterHeight),this._canvas.domNode.width=this._model.options.canvasInnerWidth,this._canvas.domNode.height=this._model.options.canvasInnerHeight,this._decorationsCanvas.setWidth(this._model.options.canvasOuterWidth),this._decorationsCanvas.setHeight(this._model.options.canvasOuterHeight),this._decorationsCanvas.domNode.width=this._model.options.canvasInnerWidth,this._decorationsCanvas.domNode.height=this._model.options.canvasInnerHeight,this._slider.setWidth(this._model.options.minimapWidth)}_getBuffer(){return this._buffers||this._model.options.canvasInnerWidth>0&&this._model.options.canvasInnerHeight>0&&(this._buffers=new MinimapBuffers(this._canvas.domNode.getContext("2d"),this._model.options.canvasInnerWidth,this._model.options.canvasInnerHeight,this._model.options.backgroundColor)),this._buffers?this._buffers.getBuffer():null}onDidChangeOptions(){this._lastRenderData=null,this._buffers=null,this._applyLayout(),this._domNode.setClassName(this._getMinimapDomNodeClassName())}onSelectionChanged(){return this._renderDecorations=!0,!0}onDecorationsChanged(){return this._renderDecorations=!0,!0}onFlushed(){return this._lastRenderData=null,!0}onLinesChanged(e,t){return!!this._lastRenderData&&this._lastRenderData.onLinesChanged(e,t)}onLinesDeleted(e,t){var i;return null===(i=this._lastRenderData)||void 0===i||i.onLinesDeleted(e,t),!0}onLinesInserted(e,t){var i;return null===(i=this._lastRenderData)||void 0===i||i.onLinesInserted(e,t),!0}onScrollChanged(){return this._renderDecorations=!0,!0}onThemeChanged(){return this._selectionColor=this._theme.getColor(minimapSelection),this._renderDecorations=!0,!0}onTokensChanged(e){return!!this._lastRenderData&&this._lastRenderData.onTokensChanged(e)}onTokensColorsChanged(){return this._lastRenderData=null,this._buffers=null,!0}onZonesChanged(){return this._lastRenderData=null,!0}render(e){if(0===this._model.options.renderMinimap)return this._shadow.setClassName("minimap-shadow-hidden"),this._sliderHorizontal.setWidth(0),void this._sliderHorizontal.setHeight(0);e.scrollLeft+e.viewportWidth>=e.scrollWidth?this._shadow.setClassName("minimap-shadow-hidden"):this._shadow.setClassName("minimap-shadow-visible");const t=MinimapLayout.create(this._model.options,e.viewportStartLineNumber,e.viewportEndLineNumber,e.viewportStartLineNumberVerticalOffset,e.viewportHeight,e.viewportContainsWhitespaceGaps,this._model.getLineCount(),this._model.getRealLineCount(),e.scrollTop,e.scrollHeight,this._lastRenderData?this._lastRenderData.renderedLayout:null);this._slider.setDisplay(t.sliderNeeded?"block":"none"),this._slider.setTop(t.sliderTop),this._slider.setHeight(t.sliderHeight),this._sliderHorizontal.setLeft(0),this._sliderHorizontal.setWidth(this._model.options.minimapWidth),this._sliderHorizontal.setTop(0),this._sliderHorizontal.setHeight(t.sliderHeight),this.renderDecorations(t),this._lastRenderData=this.renderLines(t)}renderDecorations(e){if(this._renderDecorations){this._renderDecorations=!1;const t=this._model.getSelections();t.sort(Range.compareRangesUsingStarts);const i=this._model.getMinimapDecorationsInViewport(e.startLineNumber,e.endLineNumber);i.sort(((e,t)=>(e.options.zIndex||0)-(t.options.zIndex||0)));const{canvasInnerWidth:n,canvasInnerHeight:s}=this._model.options,o=this._model.options.minimapLineHeight,a=this._model.options.minimapCharWidth,r=this._model.getOptions().tabSize,h=this._decorationsCanvas.domNode.getContext("2d");h.clearRect(0,0,n,s);const l=new ContiguousLineMap(e.startLineNumber,e.endLineNumber,!1);this._renderSelectionLineHighlights(h,t,l,e,o),this._renderDecorationsLineHighlights(h,i,l,e,o);const d=new ContiguousLineMap(e.startLineNumber,e.endLineNumber,null);this._renderSelectionsHighlights(h,t,d,e,o,r,a,n),this._renderDecorationsHighlights(h,i,d,e,o,r,a,n)}}_renderSelectionLineHighlights(e,t,i,n,s){if(!this._selectionColor||this._selectionColor.isTransparent())return;e.fillStyle=this._selectionColor.transparent(.5).toString();let o=0,a=0;for(const r of t){const t=Math.max(n.startLineNumber,r.startLineNumber),h=Math.min(n.endLineNumber,r.endLineNumber);if(t>h)continue;for(let e=t;e<=h;e++)i.set(e,!0);const l=(t-n.startLineNumber)*s,d=(h-n.startLineNumber)*s+s;a>=l||(a>o&&e.fillRect(MINIMAP_GUTTER_WIDTH,o,e.canvas.width,a-o),o=l),a=d}a>o&&e.fillRect(MINIMAP_GUTTER_WIDTH,o,e.canvas.width,a-o)}_renderDecorationsLineHighlights(e,t,i,n,s){const o=new Map;for(let a=t.length-1;a>=0;a--){const r=t[a],h=r.options.minimap;if(!h||h.position!==MinimapPosition.Inline)continue;const l=Math.max(n.startLineNumber,r.range.startLineNumber),d=Math.min(n.endLineNumber,r.range.endLineNumber);if(l>d)continue;const m=h.getColor(this._theme.value);if(!m||m.isTransparent())continue;let c=o.get(m.toString());c||(c=m.transparent(.5).toString(),o.set(m.toString(),c)),e.fillStyle=c;for(let t=l;t<=d;t++){if(i.has(t))continue;i.set(t,!0);const o=(l-n.startLineNumber)*s;e.fillRect(MINIMAP_GUTTER_WIDTH,o,e.canvas.width,s)}}}_renderSelectionsHighlights(e,t,i,n,s,o,a,r){if(this._selectionColor&&!this._selectionColor.isTransparent())for(const h of t){const t=Math.max(n.startLineNumber,h.startLineNumber),l=Math.min(n.endLineNumber,h.endLineNumber);if(!(t>l))for(let d=t;d<=l;d++)this.renderDecorationOnLine(e,i,h,this._selectionColor,n,d,s,s,o,a,r)}}_renderDecorationsHighlights(e,t,i,n,s,o,a,r){for(const h of t){const t=h.options.minimap;if(!t)continue;const l=Math.max(n.startLineNumber,h.range.startLineNumber),d=Math.min(n.endLineNumber,h.range.endLineNumber);if(l>d)continue;const m=t.getColor(this._theme.value);if(m&&!m.isTransparent())for(let c=l;c<=d;c++)switch(t.position){case MinimapPosition.Inline:this.renderDecorationOnLine(e,i,h.range,m,n,c,s,s,o,a,r);continue;case MinimapPosition.Gutter:{const t=(c-n.startLineNumber)*s,i=2;this.renderDecoration(e,m,i,t,2,s);continue}}}}renderDecorationOnLine(e,t,i,n,s,o,a,r,h,l,d){const m=(o-s.startLineNumber)*r;if(m+a<0||m>this._model.options.canvasInnerHeight)return;const{startLineNumber:c,endLineNumber:p}=i,u=c===o?i.startColumn:1,g=p===o?i.endColumn:this._model.getLineMaxColumn(o),_=this.getXOffsetForPosition(t,o,u,h,l,d),L=this.getXOffsetForPosition(t,o,g,h,l,d);this.renderDecoration(e,n,_,m,L-_,a)}getXOffsetForPosition(e,t,i,n,s,o){if(1===i)return MINIMAP_GUTTER_WIDTH;if((i-1)*s>=o)return o;let a=e.get(t);if(!a){const i=this._model.getLineContent(t);a=[MINIMAP_GUTTER_WIDTH];let r=MINIMAP_GUTTER_WIDTH;for(let e=1;e<i.length+1;e++){const t=i.charCodeAt(e-1),h=r+(9===t?n*s:strings.isFullWidthCharacter(t)?2*s:s);if(h>=o){a[e]=o;break}a[e]=h,r=h}e.set(t,a)}return i-1<a.length?a[i-1]:o}renderDecoration(e,t,i,n,s,o){e.fillStyle=t&&t.toString()||"",e.fillRect(i,n,s,o)}renderLines(e){const t=e.startLineNumber,i=e.endLineNumber,n=this._model.options.minimapLineHeight;if(this._lastRenderData&&this._lastRenderData.linesEquals(e)){const t=this._lastRenderData._get();return new RenderData(e,t.imageData,t.lines)}const s=this._getBuffer();if(!s)return null;const[o,a,r]=InnerMinimap._renderUntouchedLines(s,t,i,n,this._lastRenderData),h=this._model.getMinimapLinesRenderingData(t,i,r),l=this._model.getOptions().tabSize,d=this._model.options.defaultBackgroundColor,m=this._model.options.backgroundColor,c=this._model.options.foregroundAlpha,p=this._model.tokensColorTracker,u=p.backgroundIsLight(),g=this._model.options.renderMinimap,_=this._model.options.charRenderer(),L=this._model.options.fontScale,f=this._model.options.minimapCharWidth,C=(1===g?2:3)*L,b=n>C?Math.floor((n-C)/2):0,N=m.a/255,M=new RGBA8(Math.round((m.r-d.r)*N+d.r),Math.round((m.g-d.g)*N+d.g),Math.round((m.b-d.b)*N+d.b),255);let v=0;const D=[];for(let e=0,o=i-t+1;e<o;e++)r[e]&&InnerMinimap._renderLine(s,M,m.a,u,g,f,p,c,_,v,b,l,h[e],L,n),D[e]=new MinimapLine(v),v+=n;const S=-1===o?0:o,T=(-1===a?s.height:a)-S;return this._canvas.domNode.getContext("2d").putImageData(s,0,0,0,S,s.width,T),new RenderData(e,s,D)}static _renderUntouchedLines(e,t,i,n,s){const o=[];if(!s){for(let e=0,n=i-t+1;e<n;e++)o[e]=!0;return[-1,-1,o]}const a=s._get(),r=a.imageData.data,h=a.rendLineNumberStart,l=a.lines,d=l.length,m=e.width,c=e.data,p=(i-t+1)*n*m*4;let u=-1,g=-1,_=-1,L=-1,f=-1,C=-1,b=0;for(let e=t;e<=i;e++){const i=e-t,s=e-h,a=s>=0&&s<d?l[s].dy:-1;if(-1===a){o[i]=!0,b+=n;continue}const N=a*m*4,M=(a+n)*m*4,v=b*m*4,D=(b+n)*m*4;L===N&&C===v?(L=M,C=D):(-1!==_&&(c.set(r.subarray(_,L),f),-1===u&&0===_&&_===f&&(u=L),-1===g&&L===p&&_===f&&(g=_)),_=N,L=M,f=v,C=D),o[i]=!1,b+=n}return-1!==_&&(c.set(r.subarray(_,L),f),-1===u&&0===_&&_===f&&(u=L),-1===g&&L===p&&_===f&&(g=_)),[-1===u?-1:u/(4*m),-1===g?-1:g/(4*m),o]}static _renderLine(e,t,i,n,s,o,a,r,h,l,d,m,c,p,u){const g=c.content,_=c.tokens,L=e.width-o,f=1===u;let C=MINIMAP_GUTTER_WIDTH,b=0,N=0;for(let c=0,u=_.getCount();c<u;c++){const u=_.getEndOffset(c),M=_.getForeground(c),v=a.getColor(M);for(;b<u;b++){if(C>L)return;const a=g.charCodeAt(b);if(9===a){const e=m-(b+N)%m;N+=e-1,C+=e*o}else if(32===a)C+=o;else{const m=strings.isFullWidthCharacter(a)?2:1;for(let c=0;c<m;c++)if(2===s?h.blockRenderChar(e,C,l+d,v,r,t,i,f):h.renderChar(e,C,l+d,a,v,r,t,i,p,n,f),C+=o,C>L)return}}}}}class ContiguousLineMap{constructor(e,t,i){this._startLineNumber=e,this._endLineNumber=t,this._defaultValue=i,this._values=[];for(let e=0,t=this._endLineNumber-this._startLineNumber+1;e<t;e++)this._values[e]=i}has(e){return this.get(e)!==this._defaultValue}set(e,t){e<this._startLineNumber||e>this._endLineNumber||(this._values[e-this._startLineNumber]=t)}get(e){return e<this._startLineNumber||e>this._endLineNumber?this._defaultValue:this._values[e-this._startLineNumber]}}registerThemingParticipant(((e,t)=>{const i=e.getColor(minimapSliderBackground);i&&t.addRule(`.monaco-editor .minimap-slider .minimap-slider-horizontal { background: ${i}; }`);const n=e.getColor(minimapSliderHoverBackground);n&&t.addRule(`.monaco-editor .minimap-slider:hover .minimap-slider-horizontal { background: ${n}; }`);const s=e.getColor(minimapSliderActiveBackground);s&&t.addRule(`.monaco-editor .minimap-slider.active .minimap-slider-horizontal { background: ${s}; }`);const o=e.getColor(scrollbarShadow);o&&t.addRule(`.monaco-editor .minimap-shadow-visible { box-shadow: ${o} -6px 0 6px -6px inset; }`)}));