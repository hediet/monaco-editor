var _a;import{StringBuilder}from"../../common/core/stringBuilder.js";import*as strings from"../../../base/common/strings.js";import{applyFontInfo}from"../config/domFontInfo.js";import{LineInjectedText}from"../../common/textModelEvents.js";import{ModelLineProjectionData}from"../../common/modelLineProjectionData.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("domLineBreaksComputer",{createHTML:e=>e});export class DOMLineBreaksComputerFactory{static create(){return new DOMLineBreaksComputerFactory}constructor(){}createLineBreaksComputer(e,t,n,r){const i=[],o=[];return{addRequest:(e,t,n)=>{i.push(e),o.push(t)},finalize:()=>createLineBreaks(i,e,t,n,r,o)}}}function createLineBreaks(e,t,n,r,i,o){var a;function l(t){const n=o[t];if(n){const r=LineInjectedText.applyInjectedText(e[t],n),i=n.map((e=>e.options)),o=n.map((e=>e.column-1));return new ModelLineProjectionData(o,i,[r.length],[],0)}return null}if(-1===r){const t=[];for(let n=0,r=e.length;n<r;n++)t[n]=l(n);return t}const c=Math.round(r*t.typicalHalfwidthCharacterWidth),s=3===i?2:2===i?1:0,d=Math.round(n*s),p=Math.ceil(t.spaceWidth*d),u=document.createElement("div");applyFontInfo(u,t);const h=new StringBuilder(1e4),g=[],I=[],f=[],S=[],m=[];for(let r=0;r<e.length;r++){const a=LineInjectedText.applyInjectedText(e[r],o[r]);let l=0,s=0,d=c;if(0!==i)if(l=strings.firstNonWhitespaceIndex(a),-1===l)l=0;else{for(let e=0;e<l;e++)s+=9===a.charCodeAt(e)?n-s%n:1;const e=Math.ceil(t.spaceWidth*s);e+t.typicalFullwidthCharacterWidth>c?(l=0,s=0):d=c-e}const u=a.substr(l),C=renderLine(u,s,n,d,h,p);g[r]=l,I[r]=s,f[r]=u,S[r]=C[0],m[r]=C[1]}const C=h.build(),y=null!==(a=null==ttPolicy?void 0:ttPolicy.createHTML(C))&&void 0!==a?a:C;u.innerHTML=y,u.style.position="absolute",u.style.top="10000",u.style.wordWrap="break-word",document.body.appendChild(u);const A=document.createRange(),k=Array.prototype.slice.call(u.children,0),L=[];for(let t=0;t<e.length;t++){const e=readLineBreaks(A,k[t],f[t],S[t]);if(null===e){L[t]=l(t);continue}const n=g[t],r=I[t]+d,i=m[t],a=[];for(let t=0,n=e.length;t<n;t++)a[t]=i[e[t]];if(0!==n)for(let t=0,r=e.length;t<r;t++)e[t]+=n;let c,s;const p=o[t];p?(c=p.map((e=>e.options)),s=p.map((e=>e.column-1))):(c=null,s=null),L[t]=new ModelLineProjectionData(s,c,e,a,r)}return document.body.removeChild(u),L}function renderLine(e,t,n,r,i,o){if(0!==o){const e=String(o);i.appendASCIIString('<div style="text-indent: -'),i.appendASCIIString(e),i.appendASCIIString("px; padding-left: "),i.appendASCIIString(e),i.appendASCIIString("px; box-sizing: border-box; width:")}else i.appendASCIIString('<div style="width:');i.appendASCIIString(String(r)),i.appendASCIIString('px;">');const a=e.length;let l=t,c=0;const s=[],d=[];let p=0<a?e.charCodeAt(0):0;i.appendASCIIString("<span>");for(let t=0;t<a;t++){0!==t&&t%16384==0&&i.appendASCIIString("</span><span>"),s[t]=c,d[t]=l;const r=p;p=t+1<a?e.charCodeAt(t+1):0;let o=1,u=1;switch(r){case 9:o=n-l%n,u=o;for(let e=1;e<=o;e++)e<o?i.write1(160):i.appendASCII(32);break;case 32:32===p?i.write1(160):i.appendASCII(32);break;case 60:i.appendASCIIString("&lt;");break;case 62:i.appendASCIIString("&gt;");break;case 38:i.appendASCIIString("&amp;");break;case 0:i.appendASCIIString("&#00;");break;case 65279:case 8232:case 8233:case 133:i.write1(65533);break;default:strings.isFullWidthCharacter(r)&&u++,r<32?i.write1(9216+r):i.write1(r)}c+=o,l+=u}return i.appendASCIIString("</span>"),s[e.length]=c,d[e.length]=l,i.appendASCIIString("</div>"),[s,d]}function readLineBreaks(e,t,n,r){if(n.length<=1)return null;const i=Array.prototype.slice.call(t.children,0),o=[];try{discoverBreaks(e,i,r,0,null,n.length-1,null,o)}catch(e){return console.log(e),null}return 0===o.length?null:(o.push(n.length),o)}function discoverBreaks(e,t,n,r,i,o,a,l){if(r===o)return;if(i=i||readClientRect(e,t,n[r],n[r+1]),a=a||readClientRect(e,t,n[o],n[o+1]),Math.abs(i[0].top-a[0].top)<=.1)return;if(r+1===o)return void l.push(o);const c=r+(o-r)/2|0,s=readClientRect(e,t,n[c],n[c+1]);discoverBreaks(e,t,n,r,i,c,s,l),discoverBreaks(e,t,n,c,s,o,a,l)}function readClientRect(e,t,n,r){return e.setStart(t[n/16384|0].firstChild,n%16384),e.setEnd(t[r/16384|0].firstChild,r%16384),e.getClientRects()}