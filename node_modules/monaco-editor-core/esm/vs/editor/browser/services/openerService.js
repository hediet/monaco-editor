var __decorate=this&&this.__decorate||function(e,r,t,o){var n,i=arguments.length,s=i<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,r,t,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(r,t,s):n(r,t))||s);return i>3&&s&&Object.defineProperty(r,t,s),s},__param=this&&this.__param||function(e,r){return function(t,o){r(t,o,e)}},__awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,a)}c((o=o.apply(e,r||[])).next())}))};import*as dom from"../../../base/browser/dom.js";import{CancellationToken}from"../../../base/common/cancellation.js";import{LinkedList}from"../../../base/common/linkedList.js";import{ResourceMap}from"../../../base/common/map.js";import{parse}from"../../../base/common/marshalling.js";import{Schemas}from"../../../base/common/network.js";import{normalizePath}from"../../../base/common/resources.js";import{URI}from"../../../base/common/uri.js";import{ICodeEditorService}from"./codeEditorService.js";import{ICommandService}from"../../../platform/commands/common/commands.js";import{EditorOpenSource}from"../../../platform/editor/common/editor.js";import{extractSelection,matchesScheme,matchesSomeScheme}from"../../../platform/opener/common/opener.js";let CommandOpener=class{constructor(e){this._commandService=e}open(e,r){return __awaiter(this,void 0,void 0,(function*(){if(!matchesScheme(e,Schemas.command))return!1;if(!(null==r?void 0:r.allowCommands))return!0;"string"==typeof e&&(e=URI.parse(e));let t=[];try{t=parse(decodeURIComponent(e.query))}catch(r){try{t=parse(e.query)}catch(e){}}return Array.isArray(t)||(t=[t]),yield this._commandService.executeCommand(e.path,...t),!0}))}};CommandOpener=__decorate([__param(0,ICommandService)],CommandOpener);let EditorOpener=class{constructor(e){this._editorService=e}open(e,r){return __awaiter(this,void 0,void 0,(function*(){"string"==typeof e&&(e=URI.parse(e));const{selection:t,uri:o}=extractSelection(e);return(e=o).scheme===Schemas.file&&(e=normalizePath(e)),yield this._editorService.openCodeEditor({resource:e,options:Object.assign({selection:t,source:(null==r?void 0:r.fromUserGesture)?EditorOpenSource.USER:EditorOpenSource.API},null==r?void 0:r.editorOptions)},this._editorService.getFocusedCodeEditor(),null==r?void 0:r.openToSide),!0}))}};EditorOpener=__decorate([__param(0,ICodeEditorService)],EditorOpener);let OpenerService=class{constructor(e,r){this._openers=new LinkedList,this._validators=new LinkedList,this._resolvers=new LinkedList,this._resolvedUriTargets=new ResourceMap((e=>e.with({path:null,fragment:null,query:null}).toString())),this._externalOpeners=new LinkedList,this._defaultExternalOpener={openExternal:e=>__awaiter(this,void 0,void 0,(function*(){return matchesSomeScheme(e,Schemas.http,Schemas.https)?dom.windowOpenNoOpener(e):window.location.href=e,!0}))},this._openers.push({open:(e,r)=>__awaiter(this,void 0,void 0,(function*(){return!(!(null==r?void 0:r.openExternal)&&!matchesSomeScheme(e,Schemas.mailto,Schemas.http,Schemas.https,Schemas.vsls)||(yield this._doOpenExternal(e,r),0))}))}),this._openers.push(new CommandOpener(r)),this._openers.push(new EditorOpener(e))}registerOpener(e){return{dispose:this._openers.unshift(e)}}registerValidator(e){return{dispose:this._validators.push(e)}}registerExternalUriResolver(e){return{dispose:this._resolvers.push(e)}}setDefaultExternalOpener(e){this._defaultExternalOpener=e}registerExternalOpener(e){return{dispose:this._externalOpeners.push(e)}}open(e,r){var t;return __awaiter(this,void 0,void 0,(function*(){const o="string"==typeof e?URI.parse(e):e,n=null!==(t=this._resolvedUriTargets.get(o))&&void 0!==t?t:e;for(const e of this._validators)if(!(yield e.shouldOpen(n,r)))return!1;for(const t of this._openers)if(yield t.open(e,r))return!0;return!1}))}resolveExternalUri(e,r){return __awaiter(this,void 0,void 0,(function*(){for(const t of this._resolvers)try{const o=yield t.resolveExternalUri(e,r);if(o)return this._resolvedUriTargets.has(o.resolved)||this._resolvedUriTargets.set(o.resolved,e),o}catch(e){}throw new Error("Could not resolve external URI: "+e.toString())}))}_doOpenExternal(e,r){return __awaiter(this,void 0,void 0,(function*(){const t="string"==typeof e?URI.parse(e):e;let o,n;try{o=(yield this.resolveExternalUri(t,r)).resolved}catch(e){o=t}if(n="string"==typeof e&&t.toString()===o.toString()?e:encodeURI(o.toString(!0)),null==r?void 0:r.allowContributedOpeners){const e="string"==typeof(null==r?void 0:r.allowContributedOpeners)?null==r?void 0:r.allowContributedOpeners:void 0;for(const r of this._externalOpeners)if(yield r.openExternal(n,{sourceUri:t,preferredOpenerId:e},CancellationToken.None))return!0}return this._defaultExternalOpener.openExternal(n,{sourceUri:t},CancellationToken.None)}))}dispose(){this._validators.clear()}};OpenerService=__decorate([__param(0,ICodeEditorService),__param(1,ICommandService)],OpenerService);export{OpenerService};