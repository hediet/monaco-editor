var _a,__decorate=this&&this.__decorate||function(e,i,t,n){var o,r=arguments.length,s=r<3?i:null===n?n=Object.getOwnPropertyDescriptor(i,t):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,i,t,n);else for(var d=e.length-1;d>=0;d--)(o=e[d])&&(s=(r<3?o(s):r>3?o(i,t,s):o(i,t))||s);return r>3&&s&&Object.defineProperty(i,t,s),s},__param=this&&this.__param||function(e,i){return function(t,n){i(t,n,e)}},__awaiter=this&&this.__awaiter||function(e,i,t,n){return new(t||(t=Promise))((function(o,r){function s(e){try{a(n.next(e))}catch(e){r(e)}}function d(e){try{a(n.throw(e))}catch(e){r(e)}}function a(e){var i;e.done?o(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(s,d)}a((n=n.apply(e,i||[])).next())}))};import"./media/diffReview.css";import*as nls from"../../../nls.js";import*as dom from"../../../base/browser/dom.js";import{createFastDomNode}from"../../../base/browser/fastDomNode.js";import{ActionBar}from"../../../base/browser/ui/actionbar/actionbar.js";import{DomScrollableElement}from"../../../base/browser/ui/scrollbar/scrollableElement.js";import{Action}from"../../../base/common/actions.js";import{Disposable}from"../../../base/common/lifecycle.js";import{applyFontInfo}from"../config/domFontInfo.js";import{EditorAction,registerEditorAction}from"../editorExtensions.js";import{ICodeEditorService}from"../services/codeEditorService.js";import{EditorFontLigatures}from"../../common/config/editorOptions.js";import{LineTokens}from"../../common/tokens/lineTokens.js";import{Position}from"../../common/core/position.js";import{editorLineNumbers}from"../../common/core/editorColorRegistry.js";import{RenderLineInput,renderViewLine2 as renderViewLine}from"../../common/viewLayout/viewLineRenderer.js";import{ViewLineRenderingData}from"../../common/viewModel.js";import{ContextKeyExpr}from"../../../platform/contextkey/common/contextkey.js";import{scrollbarShadow}from"../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant,ThemeIcon}from"../../../platform/theme/common/themeService.js";import{Codicon}from"../../../base/common/codicons.js";import{registerIcon}from"../../../platform/theme/common/iconRegistry.js";import{ILanguageService}from"../../common/languages/language.js";const DIFF_LINES_PADDING=3;class DiffEntry{constructor(e,i,t,n){this.originalLineStart=e,this.originalLineEnd=i,this.modifiedLineStart=t,this.modifiedLineEnd=n}getType(){return 0===this.originalLineStart?1:0===this.modifiedLineStart?2:0}}class Diff{constructor(e){this.entries=e}}const diffReviewInsertIcon=registerIcon("diff-review-insert",Codicon.add,nls.localize("diffReviewInsertIcon","Icon for 'Insert' in diff review.")),diffReviewRemoveIcon=registerIcon("diff-review-remove",Codicon.remove,nls.localize("diffReviewRemoveIcon","Icon for 'Remove' in diff review.")),diffReviewCloseIcon=registerIcon("diff-review-close",Codicon.close,nls.localize("diffReviewCloseIcon","Icon for 'Close' in diff review."));let DiffReview=class e extends Disposable{constructor(e,i){super(),this._languageService=i,this._width=0,this._diffEditor=e,this._isVisible=!1,this.shadow=createFastDomNode(document.createElement("div")),this.shadow.setClassName("diff-review-shadow"),this.actionBarContainer=createFastDomNode(document.createElement("div")),this.actionBarContainer.setClassName("diff-review-actions"),this._actionBar=this._register(new ActionBar(this.actionBarContainer.domNode)),this._actionBar.push(new Action("diffreview.close",nls.localize("label.close","Close"),"close-diff-review "+ThemeIcon.asClassName(diffReviewCloseIcon),!0,(()=>__awaiter(this,void 0,void 0,(function*(){return this.hide()})))),{label:!1,icon:!0}),this.domNode=createFastDomNode(document.createElement("div")),this.domNode.setClassName("diff-review monaco-editor-background"),this._content=createFastDomNode(document.createElement("div")),this._content.setClassName("diff-review-content"),this._content.setAttribute("role","code"),this.scrollbar=this._register(new DomScrollableElement(this._content.domNode,{})),this.domNode.domNode.appendChild(this.scrollbar.getDomNode()),this._register(e.onDidUpdateDiff((()=>{this._isVisible&&(this._diffs=this._compute(),this._render())}))),this._register(e.getModifiedEditor().onDidChangeCursorPosition((()=>{this._isVisible&&this._render()}))),this._register(dom.addStandardDisposableListener(this.domNode.domNode,"click",(e=>{e.preventDefault();const i=dom.findParentWithClass(e.target,"diff-review-row");i&&this._goToRow(i)}))),this._register(dom.addStandardDisposableListener(this.domNode.domNode,"keydown",(e=>{(e.equals(18)||e.equals(2066)||e.equals(530))&&(e.preventDefault(),this._goToRow(this._getNextRow())),(e.equals(16)||e.equals(2064)||e.equals(528))&&(e.preventDefault(),this._goToRow(this._getPrevRow())),(e.equals(9)||e.equals(2057)||e.equals(521)||e.equals(1033))&&(e.preventDefault(),this.hide()),(e.equals(10)||e.equals(3))&&(e.preventDefault(),this.accept())}))),this._diffs=[],this._currentDiff=null}prev(){let e=0;if(this._isVisible||(this._diffs=this._compute()),this._isVisible){let i=-1;for(let e=0,t=this._diffs.length;e<t;e++)if(this._diffs[e]===this._currentDiff){i=e;break}e=this._diffs.length+i-1}else e=this._findDiffIndex(this._diffEditor.getPosition());if(0===this._diffs.length)return;e%=this._diffs.length;const i=this._diffs[e].entries;this._diffEditor.setPosition(new Position(i[0].modifiedLineStart,1)),this._diffEditor.setSelection({startColumn:1,startLineNumber:i[0].modifiedLineStart,endColumn:1073741824,endLineNumber:i[i.length-1].modifiedLineEnd}),this._isVisible=!0,this._diffEditor.doLayout(),this._render(),this._goToRow(this._getNextRow())}next(){let e=0;if(this._isVisible||(this._diffs=this._compute()),this._isVisible){let i=-1;for(let e=0,t=this._diffs.length;e<t;e++)if(this._diffs[e]===this._currentDiff){i=e;break}e=i+1}else e=this._findDiffIndex(this._diffEditor.getPosition());if(0===this._diffs.length)return;e%=this._diffs.length;const i=this._diffs[e].entries;this._diffEditor.setPosition(new Position(i[0].modifiedLineStart,1)),this._diffEditor.setSelection({startColumn:1,startLineNumber:i[0].modifiedLineStart,endColumn:1073741824,endLineNumber:i[i.length-1].modifiedLineEnd}),this._isVisible=!0,this._diffEditor.doLayout(),this._render(),this._goToRow(this._getNextRow())}accept(){let e=-1;const i=this._getCurrentFocusedRow();if(i){const t=parseInt(i.getAttribute("data-line"),10);isNaN(t)||(e=t)}this.hide(),-1!==e&&(this._diffEditor.setPosition(new Position(e,1)),this._diffEditor.revealPosition(new Position(e,1),1))}hide(){this._isVisible=!1,this._diffEditor.updateOptions({readOnly:!1}),this._diffEditor.focus(),this._diffEditor.doLayout(),this._render()}_getPrevRow(){const e=this._getCurrentFocusedRow();return e?e.previousElementSibling?e.previousElementSibling:e:this._getFirstRow()}_getNextRow(){const e=this._getCurrentFocusedRow();return e?e.nextElementSibling?e.nextElementSibling:e:this._getFirstRow()}_getFirstRow(){return this.domNode.domNode.querySelector(".diff-review-row")}_getCurrentFocusedRow(){const e=document.activeElement;return e&&/diff-review-row/.test(e.className)?e:null}_goToRow(e){const i=this._getCurrentFocusedRow();e.tabIndex=0,e.focus(),i&&i!==e&&(i.tabIndex=-1),this.scrollbar.scanDomNode()}isVisible(){return this._isVisible}layout(e,i,t){this._width=i,this.shadow.setTop(e-6),this.shadow.setWidth(i),this.shadow.setHeight(this._isVisible?6:0),this.domNode.setTop(e),this.domNode.setWidth(i),this.domNode.setHeight(t),this._content.setHeight(t),this._content.setWidth(i),this._isVisible?(this.actionBarContainer.setAttribute("aria-hidden","false"),this.actionBarContainer.setDisplay("block")):(this.actionBarContainer.setAttribute("aria-hidden","true"),this.actionBarContainer.setDisplay("none"))}_compute(){const i=this._diffEditor.getLineChanges();if(!i||0===i.length)return[];const t=this._diffEditor.getOriginalEditor().getModel(),n=this._diffEditor.getModifiedEditor().getModel();return t&&n?e._mergeAdjacent(i,t.getLineCount(),n.getLineCount()):[]}static _mergeAdjacent(e,i,t){if(!e||0===e.length)return[];const n=[];let o=0;for(let r=0,s=e.length;r<s;r++){const d=e[r],a=d.originalStartLineNumber,l=d.originalEndLineNumber,f=d.modifiedStartLineNumber,c=d.modifiedEndLineNumber,h=[];let m=0;{const i=0===l?a:a-1,t=0===c?f:f-1;let n=1,o=1;if(r>0){const i=e[r-1];n=0===i.originalEndLineNumber?i.originalStartLineNumber+1:i.originalEndLineNumber+1,o=0===i.modifiedEndLineNumber?i.modifiedStartLineNumber+1:i.modifiedEndLineNumber+1}let s=i-3+1,d=t-3+1;if(s<n){const e=n-s;s+=e,d+=e}if(d<o){const e=o-d;s+=e,d+=e}h[m++]=new DiffEntry(s,i,d,t)}0!==l&&(h[m++]=new DiffEntry(a,l,0,0)),0!==c&&(h[m++]=new DiffEntry(0,0,f,c));{const n=0===l?a+1:l+1,o=0===c?f+1:c+1;let d=i,g=t;if(r+1<s){const i=e[r+1];d=0===i.originalEndLineNumber?i.originalStartLineNumber:i.originalStartLineNumber-1,g=0===i.modifiedEndLineNumber?i.modifiedStartLineNumber:i.modifiedStartLineNumber-1}let u=n+3-1,_=o+3-1;if(u>d){const e=d-u;u+=e,_+=e}if(_>g){const e=g-_;u+=e,_+=e}h[m++]=new DiffEntry(n,u,o,_)}n[o++]=new Diff(h)}let r=n[0].entries;const s=[];let d=0;for(let e=1,i=n.length;e<i;e++){const i=n[e].entries,t=r[r.length-1],o=i[0];0===t.getType()&&0===o.getType()&&o.originalLineStart<=t.originalLineEnd?(r[r.length-1]=new DiffEntry(t.originalLineStart,o.originalLineEnd,t.modifiedLineStart,o.modifiedLineEnd),r=r.concat(i.slice(1))):(s[d++]=new Diff(r),r=i)}return s[d++]=new Diff(r),s}_findDiffIndex(e){const i=e.lineNumber;for(let e=0,t=this._diffs.length;e<t;e++){const t=this._diffs[e].entries;if(i<=t[t.length-1].modifiedLineEnd)return e}return 0}_render(){const i=this._diffEditor.getOriginalEditor().getOptions(),t=this._diffEditor.getModifiedEditor().getOptions(),n=this._diffEditor.getOriginalEditor().getModel(),o=this._diffEditor.getModifiedEditor().getModel(),r=n.getOptions(),s=o.getOptions();if(!this._isVisible||!n||!o)return dom.clearNode(this._content.domNode),this._currentDiff=null,void this.scrollbar.scanDomNode();this._diffEditor.updateOptions({readOnly:!0});const d=this._findDiffIndex(this._diffEditor.getPosition());if(this._diffs[d]===this._currentDiff)return;this._currentDiff=this._diffs[d];const a=this._diffs[d].entries,l=document.createElement("div");l.className="diff-review-table",l.setAttribute("role","list"),l.setAttribute("aria-label",'Difference review. Use "Stage | Unstage | Revert Selected Ranges" commands'),applyFontInfo(l,t.get(45));let f=0,c=0,h=0,m=0;for(let e=0,i=a.length;e<i;e++){const i=a[e],t=i.originalLineStart,n=i.originalLineEnd,o=i.modifiedLineStart,r=i.modifiedLineEnd;0!==t&&(0===f||t<f)&&(f=t),0!==n&&(0===c||n>c)&&(c=n),0!==o&&(0===h||o<h)&&(h=o),0!==r&&(0===m||r>m)&&(m=r)}const g=document.createElement("div");g.className="diff-review-row";const u=document.createElement("div");u.className="diff-review-cell diff-review-summary";const _=c-f+1,p=m-h+1;u.appendChild(document.createTextNode(`${d+1}/${this._diffs.length}: @@ -${f},${_} +${h},${p} @@`)),g.setAttribute("data-line",String(h));const w=e=>0===e?nls.localize("no_lines_changed","no lines changed"):1===e?nls.localize("one_line_changed","1 line changed"):nls.localize("more_lines_changed","{0} lines changed",e),b=w(_),v=w(p);g.setAttribute("aria-label",nls.localize({key:"header",comment:["This is the ARIA label for a git diff header.","A git diff header looks like this: @@ -154,12 +159,39 @@.","That encodes that at original line 154 (which is now line 159), 12 lines were removed/changed with 39 lines.","Variables 0 and 1 refer to the diff index out of total number of diffs.","Variables 2 and 4 will be numbers (a line number).",'Variables 3 and 5 will be "no lines changed", "1 line changed" or "X lines changed", localized separately.']},"Difference {0} of {1}: original line {2}, {3}, modified line {4}, {5}",d+1,this._diffs.length,f,b,h,v)),g.appendChild(u),g.setAttribute("role","listitem"),l.appendChild(g);const E=t.get(60);let L=h;for(let d=0,f=a.length;d<f;d++){const f=a[d];e._renderSection(l,f,L,E,this._width,i,n,r,t,o,s,this._languageService.languageIdCodec),0!==f.modifiedLineStart&&(L=f.modifiedLineEnd)}dom.clearNode(this._content.domNode),this._content.domNode.appendChild(l),this.scrollbar.scanDomNode()}static _renderSection(i,t,n,o,r,s,d,a,l,f,c,h){const m=t.getType();let g="diff-review-row",u="",_=null;switch(m){case 1:g="diff-review-row line-insert",u=" char-insert",_=diffReviewInsertIcon;break;case 2:g="diff-review-row line-delete",u=" char-delete",_=diffReviewRemoveIcon}const p=t.originalLineStart,w=t.originalLineEnd,b=t.modifiedLineStart,v=t.modifiedLineEnd,E=Math.max(v-b,w-p),L=s.get(133),N=L.glyphMarginWidth+L.lineNumbersWidth,D=l.get(133),R=10+D.glyphMarginWidth+D.lineNumbersWidth;for(let t=0;t<=E;t++){const w=0===p?0:p+t,v=0===b?0:b+t,E=document.createElement("div");E.style.minWidth=r+"px",E.className=g,E.setAttribute("role","listitem"),0!==v&&(n=v),E.setAttribute("data-line",String(n));const L=document.createElement("div");L.className="diff-review-cell",L.style.height=`${o}px`,E.appendChild(L);const D=document.createElement("span");D.style.width=N+"px",D.style.minWidth=N+"px",D.className="diff-review-line-number"+u,0!==w?D.appendChild(document.createTextNode(String(w))):D.innerText=" ",L.appendChild(D);const C=document.createElement("span");C.style.width=R+"px",C.style.minWidth=R+"px",C.style.paddingRight="10px",C.className="diff-review-line-number"+u,0!==v?C.appendChild(document.createTextNode(String(v))):C.innerText=" ",L.appendChild(C);const y=document.createElement("span");if(y.className="diff-review-spacer",_){const e=document.createElement("span");e.className=ThemeIcon.asClassName(_),e.innerText="  ",y.appendChild(e)}else y.innerText="  ";let S;if(L.appendChild(y),0!==v){let i=this._renderLine(f,l,c.tabSize,v,h);e._ttPolicy&&(i=e._ttPolicy.createHTML(i)),L.insertAdjacentHTML("beforeend",i),S=f.getLineContent(v)}else{let i=this._renderLine(d,s,a.tabSize,w,h);e._ttPolicy&&(i=e._ttPolicy.createHTML(i)),L.insertAdjacentHTML("beforeend",i),S=d.getLineContent(w)}0===S.length&&(S=nls.localize("blankLine","blank"));let x="";switch(m){case 0:x=w===v?nls.localize({key:"unchangedLine",comment:["The placeholders are contents of the line and should not be translated."]},"{0} unchanged line {1}",S,w):nls.localize("equalLine","{0} original line {1} modified line {2}",S,w,v);break;case 1:x=nls.localize("insertLine","+ {0} modified line {1}",S,v);break;case 2:x=nls.localize("deleteLine","- {0} original line {1}",S,w)}E.setAttribute("aria-label",x),i.appendChild(E)}}static _renderLine(e,i,t,n,o){const r=e.getLineContent(n),s=i.get(45),d=LineTokens.createEmpty(r,o),a=ViewLineRenderingData.isBasicASCII(r,e.mightContainNonBasicASCII()),l=ViewLineRenderingData.containsRTL(r,a,e.mightContainRTL());return renderViewLine(new RenderLineInput(s.isMonospace&&!i.get(29),s.canUseHalfwidthRightwardsArrow,r,!1,a,l,0,d,[],t,0,s.spaceWidth,s.middotWidth,s.wsmiddotWidth,i.get(107),i.get(89),i.get(84),i.get(46)!==EditorFontLigatures.OFF,null)).html}};DiffReview._ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("diffReview",{createHTML:e=>e}),DiffReview=__decorate([__param(1,ILanguageService)],DiffReview);export{DiffReview};registerThemingParticipant(((e,i)=>{const t=e.getColor(editorLineNumbers);t&&i.addRule(`.monaco-diff-editor .diff-review-line-number { color: ${t}; }`);const n=e.getColor(scrollbarShadow);n&&i.addRule(`.monaco-diff-editor .diff-review-shadow { box-shadow: ${n} 0 -6px 6px -6px inset; }`)}));class DiffReviewNext extends EditorAction{constructor(){super({id:"editor.action.diffReview.next",label:nls.localize("editor.action.diffReview.next","Go to Next Difference"),alias:"Go to Next Difference",precondition:ContextKeyExpr.has("isInDiffEditor"),kbOpts:{kbExpr:null,primary:65,weight:100}})}run(e,i){const t=findFocusedDiffEditor(e);null==t||t.diffReviewNext()}}class DiffReviewPrev extends EditorAction{constructor(){super({id:"editor.action.diffReview.prev",label:nls.localize("editor.action.diffReview.prev","Go to Previous Difference"),alias:"Go to Previous Difference",precondition:ContextKeyExpr.has("isInDiffEditor"),kbOpts:{kbExpr:null,primary:1089,weight:100}})}run(e,i){const t=findFocusedDiffEditor(e);null==t||t.diffReviewPrev()}}function findFocusedDiffEditor(e){const i=e.get(ICodeEditorService),t=i.listDiffEditors(),n=i.getActiveCodeEditor();if(!n)return null;for(let e=0,i=t.length;e<i;e++){const i=t[e];if(i.getModifiedEditor().getId()===n.getId()||i.getOriginalEditor().getId()===n.getId())return i}return null}registerEditorAction(DiffReviewNext),registerEditorAction(DiffReviewPrev);