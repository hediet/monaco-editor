var __decorate=this&&this.__decorate||function(t,e,n,i){var o,s=arguments.length,r=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s<3?o(r):s>3?o(e,n,r):o(e,n))||r);return s>3&&r&&Object.defineProperty(e,n,r),r},__param=this&&this.__param||function(t,e){return function(n,i){e(n,i,t)}};import{DisposableStore}from"../../../../base/common/lifecycle.js";import*as strings from"../../../../base/common/strings.js";import{EditorAction,registerEditorAction,registerEditorContribution}from"../../../browser/editorExtensions.js";import{ShiftCommand}from"../../../common/commands/shiftCommand.js";import{EditOperation}from"../../../common/core/editOperation.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{EditorContextKeys}from"../../../common/editorContextKeys.js";import{ILanguageConfigurationService}from"../../../common/languages/languageConfigurationRegistry.js";import{IModelService}from"../../../common/services/model.js";import*as indentUtils from"./indentUtils.js";import*as nls from"../../../../nls.js";import{IQuickInputService}from"../../../../platform/quickinput/common/quickInput.js";import{normalizeIndentation}from"../../../common/core/indentation.js";import{getGoodIndentForLine,getIndentMetadata}from"../../../common/languages/autoIndent.js";export function getReindentEditOperations(t,e,n,i,o){if(1===t.getLineCount()&&1===t.getLineMaxColumn(1))return[];const s=e.getLanguageConfiguration(t.getLanguageId()).indentationRules;if(!s)return[];for(i=Math.min(i,t.getLineCount());n<=i&&s.unIndentedLinePattern;){const e=t.getLineContent(n);if(!s.unIndentedLinePattern.test(e))break;n++}if(n>i-1)return[];const{tabSize:r,indentSize:a,insertSpaces:d}=t.getOptions(),c=(t,e)=>(e=e||1,ShiftCommand.shiftIndent(t,t.length+e,r,a,d)),l=(t,e)=>(e=e||1,ShiftCommand.unshiftIndent(t,t.length+e,r,a,d)),g=[];let u;const p=t.getLineContent(n);let h=p;if(null!=o){u=o;const t=strings.getLeadingWhitespace(p);h=u+p.substring(t.length),s.decreaseIndentPattern&&s.decreaseIndentPattern.test(h)&&(u=l(u),h=u+p.substring(t.length)),p!==h&&g.push(EditOperation.replaceMove(new Selection(n,1,n,t.length+1),normalizeIndentation(u,a,d)))}else u=strings.getLeadingWhitespace(p);let m=u;s.increaseIndentPattern&&s.increaseIndentPattern.test(h)?(m=c(m),u=c(u)):s.indentNextLinePattern&&s.indentNextLinePattern.test(h)&&(m=c(m));for(let e=++n;e<=i;e++){const n=t.getLineContent(e),i=strings.getLeadingWhitespace(n),o=m+n.substring(i.length);s.decreaseIndentPattern&&s.decreaseIndentPattern.test(o)&&(m=l(m),u=l(u)),i!==m&&g.push(EditOperation.replaceMove(new Selection(e,1,e,i.length+1),normalizeIndentation(m,a,d))),s.unIndentedLinePattern&&s.unIndentedLinePattern.test(n)||(s.increaseIndentPattern&&s.increaseIndentPattern.test(o)?(u=c(u),m=u):m=s.indentNextLinePattern&&s.indentNextLinePattern.test(o)?c(m):u)}return g}export class IndentationToSpacesAction extends EditorAction{constructor(){super({id:IndentationToSpacesAction.ID,label:nls.localize("indentationToSpaces","Convert Indentation to Spaces"),alias:"Convert Indentation to Spaces",precondition:EditorContextKeys.writable})}run(t,e){const n=e.getModel();if(!n)return;const i=n.getOptions(),o=e.getSelection();if(!o)return;const s=new IndentationToSpacesCommand(o,i.tabSize);e.pushUndoStop(),e.executeCommands(this.id,[s]),e.pushUndoStop(),n.updateOptions({insertSpaces:!0})}}IndentationToSpacesAction.ID="editor.action.indentationToSpaces";export class IndentationToTabsAction extends EditorAction{constructor(){super({id:IndentationToTabsAction.ID,label:nls.localize("indentationToTabs","Convert Indentation to Tabs"),alias:"Convert Indentation to Tabs",precondition:EditorContextKeys.writable})}run(t,e){const n=e.getModel();if(!n)return;const i=n.getOptions(),o=e.getSelection();if(!o)return;const s=new IndentationToTabsCommand(o,i.tabSize);e.pushUndoStop(),e.executeCommands(this.id,[s]),e.pushUndoStop(),n.updateOptions({insertSpaces:!1})}}IndentationToTabsAction.ID="editor.action.indentationToTabs";export class ChangeIndentationSizeAction extends EditorAction{constructor(t,e){super(e),this.insertSpaces=t}run(t,e){const n=t.get(IQuickInputService),i=t.get(IModelService),o=e.getModel();if(!o)return;const s=i.getCreationOptions(o.getLanguageId(),o.uri,o.isForSimpleWidget),r=[1,2,3,4,5,6,7,8].map((t=>({id:t.toString(),label:t.toString(),description:t===s.tabSize?nls.localize("configuredTabSize","Configured Tab Size"):void 0}))),a=Math.min(o.getOptions().tabSize-1,7);setTimeout((()=>{n.pick(r,{placeHolder:nls.localize({key:"selectTabWidth",comment:["Tab corresponds to the tab key"]},"Select Tab Size for Current File"),activeItem:r[a]}).then((t=>{t&&o&&!o.isDisposed()&&o.updateOptions({tabSize:parseInt(t.label,10),insertSpaces:this.insertSpaces})}))}),50)}}export class IndentUsingTabs extends ChangeIndentationSizeAction{constructor(){super(!1,{id:IndentUsingTabs.ID,label:nls.localize("indentUsingTabs","Indent Using Tabs"),alias:"Indent Using Tabs",precondition:void 0})}}IndentUsingTabs.ID="editor.action.indentUsingTabs";export class IndentUsingSpaces extends ChangeIndentationSizeAction{constructor(){super(!0,{id:IndentUsingSpaces.ID,label:nls.localize("indentUsingSpaces","Indent Using Spaces"),alias:"Indent Using Spaces",precondition:void 0})}}IndentUsingSpaces.ID="editor.action.indentUsingSpaces";export class DetectIndentation extends EditorAction{constructor(){super({id:DetectIndentation.ID,label:nls.localize("detectIndentation","Detect Indentation from Content"),alias:"Detect Indentation from Content",precondition:void 0})}run(t,e){const n=t.get(IModelService),i=e.getModel();if(!i)return;const o=n.getCreationOptions(i.getLanguageId(),i.uri,i.isForSimpleWidget);i.detectIndentation(o.insertSpaces,o.tabSize)}}DetectIndentation.ID="editor.action.detectIndentation";export class ReindentLinesAction extends EditorAction{constructor(){super({id:"editor.action.reindentlines",label:nls.localize("editor.reindentlines","Reindent Lines"),alias:"Reindent Lines",precondition:EditorContextKeys.writable})}run(t,e){const n=t.get(ILanguageConfigurationService),i=e.getModel();if(!i)return;const o=getReindentEditOperations(i,n,1,i.getLineCount());o.length>0&&(e.pushUndoStop(),e.executeEdits(this.id,o),e.pushUndoStop())}}export class ReindentSelectedLinesAction extends EditorAction{constructor(){super({id:"editor.action.reindentselectedlines",label:nls.localize("editor.reindentselectedlines","Reindent Selected Lines"),alias:"Reindent Selected Lines",precondition:EditorContextKeys.writable})}run(t,e){const n=t.get(ILanguageConfigurationService),i=e.getModel();if(!i)return;const o=e.getSelections();if(null===o)return;const s=[];for(const t of o){let e=t.startLineNumber,o=t.endLineNumber;if(e!==o&&1===t.endColumn&&o--,1===e){if(e===o)continue}else e--;const r=getReindentEditOperations(i,n,e,o);s.push(...r)}s.length>0&&(e.pushUndoStop(),e.executeEdits(this.id,s),e.pushUndoStop())}}export class AutoIndentOnPasteCommand{constructor(t,e){this._initialSelection=e,this._edits=[],this._selectionId=null;for(const e of t)e.range&&"string"==typeof e.text&&this._edits.push(e)}getEditOperations(t,e){for(const t of this._edits)e.addEditOperation(Range.lift(t.range),t.text);let n=!1;Array.isArray(this._edits)&&1===this._edits.length&&this._initialSelection.isEmpty()&&(this._edits[0].range.startColumn===this._initialSelection.endColumn&&this._edits[0].range.startLineNumber===this._initialSelection.endLineNumber?(n=!0,this._selectionId=e.trackSelection(this._initialSelection,!0)):this._edits[0].range.endColumn===this._initialSelection.startColumn&&this._edits[0].range.endLineNumber===this._initialSelection.startLineNumber&&(n=!0,this._selectionId=e.trackSelection(this._initialSelection,!1))),n||(this._selectionId=e.trackSelection(this._initialSelection))}computeCursorState(t,e){return e.getTrackedSelection(this._selectionId)}}let AutoIndentOnPaste=class{constructor(t,e){this.editor=t,this._languageConfigurationService=e,this.callOnDispose=new DisposableStore,this.callOnModel=new DisposableStore,this.callOnDispose.add(t.onDidChangeConfiguration((()=>this.update()))),this.callOnDispose.add(t.onDidChangeModel((()=>this.update()))),this.callOnDispose.add(t.onDidChangeModelLanguage((()=>this.update())))}update(){this.callOnModel.clear(),this.editor.getOption(9)<4||this.editor.getOption(49)||this.editor.hasModel()&&this.callOnModel.add(this.editor.onDidPaste((({range:t})=>{this.trigger(t)})))}trigger(t){const e=this.editor.getSelections();if(null===e||e.length>1)return;const n=this.editor.getModel();if(!n)return;if(!n.tokenization.isCheapToTokenize(t.getStartPosition().lineNumber))return;const i=this.editor.getOption(9),{tabSize:o,indentSize:s,insertSpaces:r}=n.getOptions(),a=[],d={shiftIndent:t=>ShiftCommand.shiftIndent(t,t.length+1,o,s,r),unshiftIndent:t=>ShiftCommand.unshiftIndent(t,t.length+1,o,s,r)};let c=t.startLineNumber;for(;c<=t.endLineNumber&&this.shouldIgnoreLine(n,c);)c++;if(c>t.endLineNumber)return;let l=n.getLineContent(c);if(!/\S/.test(l.substring(0,t.startColumn-1))){const t=getGoodIndentForLine(i,n,n.getLanguageId(),c,d,this._languageConfigurationService);if(null!==t){const e=strings.getLeadingWhitespace(l),i=indentUtils.getSpaceCnt(t,o);if(i!==indentUtils.getSpaceCnt(e,o)){const t=indentUtils.generateIndent(i,o,r);a.push({range:new Range(c,1,c,e.length+1),text:t}),l=t+l.substr(e.length)}else{const t=getIndentMetadata(n,c,this._languageConfigurationService);if(0===t||8===t)return}}}const g=c;for(;c<t.endLineNumber&&!/\S/.test(n.getLineContent(c+1));)c++;if(c!==t.endLineNumber){const e=getGoodIndentForLine(i,{tokenization:{getLineTokens:t=>n.tokenization.getLineTokens(t),getLanguageId:()=>n.getLanguageId(),getLanguageIdAtPosition:(t,e)=>n.getLanguageIdAtPosition(t,e)},getLineContent:t=>t===g?l:n.getLineContent(t)},n.getLanguageId(),c+1,d,this._languageConfigurationService);if(null!==e){const i=indentUtils.getSpaceCnt(e,o),s=indentUtils.getSpaceCnt(strings.getLeadingWhitespace(n.getLineContent(c+1)),o);if(i!==s){const e=i-s;for(let i=c+1;i<=t.endLineNumber;i++){const t=n.getLineContent(i),s=strings.getLeadingWhitespace(t),d=indentUtils.getSpaceCnt(s,o)+e,c=indentUtils.generateIndent(d,o,r);c!==s&&a.push({range:new Range(i,1,i,s.length+1),text:c})}}}}if(a.length>0){this.editor.pushUndoStop();const t=new AutoIndentOnPasteCommand(a,this.editor.getSelection());this.editor.executeCommand("autoIndentOnPaste",t),this.editor.pushUndoStop()}}shouldIgnoreLine(t,e){t.tokenization.forceTokenization(e);const n=t.getLineFirstNonWhitespaceColumn(e);if(0===n)return!0;const i=t.tokenization.getLineTokens(e);if(i.getCount()>0){const t=i.findTokenIndexAtOffset(n);if(t>=0&&1===i.getStandardTokenType(t))return!0}return!1}dispose(){this.callOnDispose.dispose(),this.callOnModel.dispose()}};AutoIndentOnPaste.ID="editor.contrib.autoIndentOnPaste",AutoIndentOnPaste=__decorate([__param(1,ILanguageConfigurationService)],AutoIndentOnPaste);export{AutoIndentOnPaste};function getIndentationEditOperations(t,e,n,i){if(1===t.getLineCount()&&1===t.getLineMaxColumn(1))return;let o="";for(let t=0;t<n;t++)o+=" ";const s=new RegExp(o,"gi");for(let n=1,r=t.getLineCount();n<=r;n++){let r=t.getLineFirstNonWhitespaceColumn(n);if(0===r&&(r=t.getLineMaxColumn(n)),1===r)continue;const a=new Range(n,1,n,r),d=t.getValueInRange(a),c=i?d.replace(/\t/gi,o):d.replace(s,"\t");e.addEditOperation(a,c)}}export class IndentationToSpacesCommand{constructor(t,e){this.selection=t,this.tabSize=e,this.selectionId=null}getEditOperations(t,e){this.selectionId=e.trackSelection(this.selection),getIndentationEditOperations(t,e,this.tabSize,!0)}computeCursorState(t,e){return e.getTrackedSelection(this.selectionId)}}export class IndentationToTabsCommand{constructor(t,e){this.selection=t,this.tabSize=e,this.selectionId=null}getEditOperations(t,e){this.selectionId=e.trackSelection(this.selection),getIndentationEditOperations(t,e,this.tabSize,!1)}computeCursorState(t,e){return e.getTrackedSelection(this.selectionId)}}registerEditorContribution(AutoIndentOnPaste.ID,AutoIndentOnPaste),registerEditorAction(IndentationToSpacesAction),registerEditorAction(IndentationToTabsAction),registerEditorAction(IndentUsingTabs),registerEditorAction(IndentUsingSpaces),registerEditorAction(DetectIndentation),registerEditorAction(ReindentLinesAction),registerEditorAction(ReindentSelectedLinesAction);