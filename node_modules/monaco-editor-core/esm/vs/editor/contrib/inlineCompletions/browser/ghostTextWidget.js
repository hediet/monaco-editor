var _a,__decorate=this&&this.__decorate||function(e,t,o,i){var n,s=arguments.length,r=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,i);else for(var d=e.length-1;d>=0;d--)(n=e[d])&&(r=(s<3?n(r):s>3?n(t,o,r):n(t,o))||r);return s>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import*as dom from"../../../../base/browser/dom.js";import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import*as strings from"../../../../base/common/strings.js";import"./ghostText.css";import{applyFontInfo}from"../../../browser/config/domFontInfo.js";import{EditorFontLigatures}from"../../../common/config/editorOptions.js";import{LineTokens}from"../../../common/tokens/lineTokens.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{StringBuilder}from"../../../common/core/stringBuilder.js";import{InjectedTextCursorStops}from"../../../common/model.js";import{ILanguageService}from"../../../common/languages/language.js";import{ghostTextBackground,ghostTextBorder,ghostTextForeground}from"../../../common/core/editorColorRegistry.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{GhostTextReplacement}from"./ghostText.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{registerThemingParticipant}from"../../../../platform/theme/common/themeService.js";const ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("editorGhostText",{createHTML:e=>e});let GhostTextWidget=class extends Disposable{constructor(e,t,o,i){super(),this.editor=e,this.model=t,this.instantiationService=o,this.languageService=i,this.disposed=!1,this.partsWidget=this._register(this.instantiationService.createInstance(DecorationsWidget,this.editor)),this.additionalLinesWidget=this._register(new AdditionalLinesWidget(this.editor,this.languageService.languageIdCodec)),this.viewMoreContentWidget=void 0,this.replacementDecoration=this._register(new DisposableDecorations(this.editor)),this._register(this.editor.onDidChangeConfiguration((e=>{(e.hasChanged(29)||e.hasChanged(107)||e.hasChanged(89)||e.hasChanged(84)||e.hasChanged(46)||e.hasChanged(45)||e.hasChanged(60))&&this.update()}))),this._register(toDisposable((()=>{var e;this.disposed=!0,this.update(),null===(e=this.viewMoreContentWidget)||void 0===e||e.dispose(),this.viewMoreContentWidget=void 0}))),this._register(t.onDidChange((()=>{this.update()}))),this.update()}shouldShowHoverAtViewZone(e){return this.additionalLinesWidget.viewZoneId===e}update(){var e;const t=this.model.ghostText;if(!this.editor.hasModel()||!t||this.disposed)return this.partsWidget.clear(),this.additionalLinesWidget.clear(),void this.replacementDecoration.clear();const o=new Array,i=new Array;function n(e,t){if(i.length>0){const o=i[i.length-1];t&&o.decorations.push(new LineDecoration(o.content.length+1,o.content.length+1+e[0].length,t,0)),o.content+=e[0],e=e.slice(1)}for(const o of e)i.push({content:o,decorations:t?[new LineDecoration(1,o.length+1,t,0)]:[]})}t instanceof GhostTextReplacement?this.replacementDecoration.setDecorations([{range:new Range(t.lineNumber,t.columnStart,t.lineNumber,t.columnStart+t.length),options:{inlineClassName:"inline-completion-text-to-replace",description:"GhostTextReplacement"}}]):this.replacementDecoration.setDecorations([]);const s=this.editor.getModel().getLineContent(t.lineNumber);let r,d=0;for(const e of t.parts){let t=e.lines;void 0===r?(o.push({column:e.column,text:t[0],preview:e.preview}),t=t.slice(1)):n([s.substring(d,e.column-1)],void 0),t.length>0&&(n(t,"ghost-text"),void 0===r&&e.column<=s.length&&(r=e.column)),d=e.column-1}void 0!==r&&n([s.substring(d)],void 0),this.partsWidget.setParts(t.lineNumber,o,void 0!==r?{column:r,length:s.length+1-r}:void 0),this.additionalLinesWidget.updateLines(t.lineNumber,i,t.additionalReservedLineCount),null===(e=this.viewMoreContentWidget)||void 0===e||e.dispose(),this.viewMoreContentWidget=void 0}renderViewMoreLines(e,t,o){const i=this.editor.getOption(45),n=document.createElement("div");n.className="suggest-preview-additional-widget",applyFontInfo(n,i);const s=document.createElement("span");s.className="content-spacer",s.append(t),n.append(s);const r=document.createElement("span");r.className="content-newline suggest-preview-text",r.append("⏎  "),n.append(r);const d=new DisposableStore,a=document.createElement("div");return a.className="button suggest-preview-text",a.append(`+${o} lines…`),d.add(dom.addStandardDisposableListener(a,"mousedown",(e=>{var t;null===(t=this.model)||void 0===t||t.setExpanded(!0),e.preventDefault(),this.editor.focus()}))),n.append(a),new ViewMoreLinesContentWidget(this.editor,e,n,d)}};GhostTextWidget=__decorate([__param(2,IInstantiationService),__param(3,ILanguageService)],GhostTextWidget);export{GhostTextWidget};class DisposableDecorations{constructor(e){this.editor=e,this.decorationIds=[]}setDecorations(e){this.editor.changeDecorations((t=>{this.decorationIds=t.deltaDecorations(this.decorationIds,e)}))}clear(){this.setDecorations([])}dispose(){this.clear()}}class DecorationsWidget{constructor(e){this.editor=e,this.decorationIds=[]}dispose(){this.clear()}clear(){this.editor.changeDecorations((e=>{this.decorationIds=e.deltaDecorations(this.decorationIds,[])}))}setParts(e,t,o){if(!this.editor.getModel())return;const i=new Array;o&&i.push({range:Range.fromPositions(new Position(e,o.column),new Position(e,o.column+o.length)),options:{inlineClassName:"ghost-text-hidden",description:"ghost-text-hidden"}}),this.editor.changeDecorations((o=>{this.decorationIds=o.deltaDecorations(this.decorationIds,t.map((t=>({range:Range.fromPositions(new Position(e,t.column)),options:{description:"ghost-text",after:{content:t.text,inlineClassName:t.preview?"ghost-text-decoration-preview":"ghost-text-decoration",cursorStops:InjectedTextCursorStops.Left},showIfCollapsed:!0}}))).concat(i))}))}}class AdditionalLinesWidget{get viewZoneId(){return this._viewZoneId}constructor(e,t){this.editor=e,this.languageIdCodec=t,this._viewZoneId=void 0}dispose(){this.clear()}clear(){this.editor.changeViewZones((e=>{this._viewZoneId&&(e.removeZone(this._viewZoneId),this._viewZoneId=void 0)}))}updateLines(e,t,o){const i=this.editor.getModel();if(!i)return;const{tabSize:n}=i.getOptions();this.editor.changeViewZones((i=>{this._viewZoneId&&(i.removeZone(this._viewZoneId),this._viewZoneId=void 0);const s=Math.max(t.length,o);if(s>0){const o=document.createElement("div");renderLines(o,n,t,this.editor.getOptions(),this.languageIdCodec),this._viewZoneId=i.addZone({afterLineNumber:e,heightInLines:s,domNode:o,afterColumnAffinity:1})}}))}}function renderLines(e,t,o,i,n){const s=i.get(29),r=i.get(107),d=i.get(84),a=i.get(46),c=i.get(45),g=i.get(60),h=new StringBuilder(1e4);h.appendASCIIString('<div class="suggest-preview-text">');for(let e=0,i=o.length;e<i;e++){const i=o[e],l=i.content;h.appendASCIIString('<div class="view-line'),h.appendASCIIString('" style="top:'),h.appendASCIIString(String(e*g)),h.appendASCIIString('px;width:1000000px;">');const p=strings.isBasicASCII(l),m=strings.containsRTL(l),u=LineTokens.createEmpty(l,n);renderViewLine(new RenderLineInput(c.isMonospace&&!s,c.canUseHalfwidthRightwardsArrow,l,!1,p,m,0,u,i.decorations,t,0,c.spaceWidth,c.middotWidth,c.wsmiddotWidth,r,"none",d,a!==EditorFontLigatures.OFF,null),h),h.appendASCIIString("</div>")}h.appendASCIIString("</div>"),applyFontInfo(e,c);const l=h.build(),p=ttPolicy?ttPolicy.createHTML(l):l;e.innerHTML=p}class ViewMoreLinesContentWidget extends Disposable{constructor(e,t,o,i){super(),this.editor=e,this.position=t,this.domNode=o,this.allowEditorOverflow=!1,this.suppressMouseDown=!1,this._register(i),this._register(toDisposable((()=>{this.editor.removeContentWidget(this)}))),this.editor.addContentWidget(this)}getId(){return"editor.widget.viewMoreLinesWidget"}getDomNode(){return this.domNode}getPosition(){return{position:this.position,preference:[0]}}}registerThemingParticipant(((e,t)=>{const o=e.getColor(ghostTextForeground);o&&(t.addRule(`.monaco-editor .ghost-text-decoration { color: ${o.toString()} !important; }`),t.addRule(`.monaco-editor .ghost-text-decoration-preview { color: ${o.toString()} !important; }`),t.addRule(`.monaco-editor .suggest-preview-text .ghost-text { color: ${o.toString()} !important; }`));const i=e.getColor(ghostTextBackground);i&&(t.addRule(`.monaco-editor .ghost-text-decoration { background-color: ${i.toString()}; }`),t.addRule(`.monaco-editor .ghost-text-decoration-preview { background-color: ${i.toString()}; }`),t.addRule(`.monaco-editor .suggest-preview-text .ghost-text { background-color: ${i.toString()}; }`));const n=e.getColor(ghostTextBorder);n&&(t.addRule(`.monaco-editor .suggest-preview-text .ghost-text { border: 1px solid ${n}; }`),t.addRule(`.monaco-editor .ghost-text-decoration { border: 1px solid ${n}; }`),t.addRule(`.monaco-editor .ghost-text-decoration-preview { border: 1px solid ${n}; }`))}));