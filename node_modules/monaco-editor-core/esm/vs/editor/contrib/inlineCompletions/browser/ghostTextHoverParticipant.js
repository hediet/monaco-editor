var __decorate=this&&this.__decorate||function(e,o,n,t){var r,i=arguments.length,s=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,n):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,o,n,t);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(i<3?r(s):i>3?r(o,n,s):r(o,n))||s);return i>3&&s&&Object.defineProperty(o,n,s),s},__param=this&&this.__param||function(e,o){return function(n,t){o(n,t,e)}};import*as dom from"../../../../base/browser/dom.js";import{MarkdownString}from"../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../base/common/lifecycle.js";import{MarkdownRenderer}from"../../markdownRenderer/browser/markdownRenderer.js";import{Range}from"../../../common/core/range.js";import{ILanguageService}from"../../../common/languages/language.js";import{HoverForeignElementAnchor}from"../../hover/browser/hoverTypes.js";import{GhostTextController,ShowNextInlineSuggestionAction,ShowPreviousInlineSuggestionAction}from"./ghostTextController.js";import*as nls from"../../../../nls.js";import{IAccessibilityService}from"../../../../platform/accessibility/common/accessibility.js";import{IMenuService,MenuId,MenuItemAction}from"../../../../platform/actions/common/actions.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IOpenerService}from"../../../../platform/opener/common/opener.js";import{inlineSuggestCommitId}from"./consts.js";export class InlineCompletionsHover{constructor(e,o,n){this.owner=e,this.range=o,this.controller=n}isValidForHoverAnchor(e){return 1===e.type&&this.range.startColumn<=e.range.startColumn&&this.range.endColumn>=e.range.endColumn}hasMultipleSuggestions(){return this.controller.hasMultipleInlineCompletions()}get commands(){var e,o,n;return(null===(n=null===(o=null===(e=this.controller.activeModel)||void 0===e?void 0:e.activeInlineCompletionsModel)||void 0===o?void 0:o.completionSession.value)||void 0===n?void 0:n.commands)||[]}}let InlineCompletionsHoverParticipant=class{constructor(e,o,n,t,r,i,s){this._editor=e,this._commandService=o,this._menuService=n,this._contextKeyService=t,this._languageService=r,this._openerService=i,this.accessibilityService=s,this.hoverOrdinal=3}suggestHoverAnchor(e){const o=GhostTextController.get(this._editor);if(!o)return null;const n=e.target;if(8===n.type){const t=n.detail;if(o.shouldShowHoverAtViewZone(t.viewZoneId))return new HoverForeignElementAnchor(1e3,this,Range.fromPositions(t.positionBefore||t.position,t.positionBefore||t.position),e.event.posx,e.event.posy)}return 7===n.type&&o.shouldShowHoverAt(n.range)||6===n.type&&n.detail.mightBeForeignElement&&o.shouldShowHoverAt(n.range)?new HoverForeignElementAnchor(1e3,this,n.range,e.event.posx,e.event.posy):null}computeSync(e,o){const n=GhostTextController.get(this._editor);return n&&n.shouldShowHoverAt(e.range)?[new InlineCompletionsHover(this,e.range,n)]:[]}renderHoverParts(e,o){const n=new DisposableStore,t=o[0];this.accessibilityService.isScreenReaderOptimized()&&this.renderScreenReaderText(e,t,n);const r=n.add(this._menuService.createMenu(MenuId.InlineCompletionsActions,this._contextKeyService)),i=e.statusBar.addAction({label:nls.localize("showNextInlineSuggestion","Next"),commandId:ShowNextInlineSuggestionAction.ID,run:()=>this._commandService.executeCommand(ShowNextInlineSuggestionAction.ID)}),s=e.statusBar.addAction({label:nls.localize("showPreviousInlineSuggestion","Previous"),commandId:ShowPreviousInlineSuggestionAction.ID,run:()=>this._commandService.executeCommand(ShowPreviousInlineSuggestionAction.ID)});e.statusBar.addAction({label:nls.localize("acceptInlineSuggestion","Accept"),commandId:inlineSuggestCommitId,run:()=>this._commandService.executeCommand(inlineSuggestCommitId)});const c=[i,s];for(const e of c)e.setEnabled(!1);t.hasMultipleSuggestions().then((e=>{for(const o of c)o.setEnabled(e)}));for(const o of t.commands)e.statusBar.addAction({label:o.title,commandId:o.id,run:()=>this._commandService.executeCommand(o.id,...o.arguments||[])});for(const[o,n]of r.getActions())for(const o of n)o instanceof MenuItemAction&&e.statusBar.addAction({label:o.label,commandId:o.item.id,run:()=>this._commandService.executeCommand(o.item.id)});return n}renderScreenReaderText(e,o,n){var t,r;const i=dom.$,s=i("div.hover-row.markdown-hover"),c=dom.append(s,i("div.hover-contents")),a=n.add(new MarkdownRenderer({editor:this._editor},this._languageService,this._openerService)),l=null===(r=null===(t=o.controller.activeModel)||void 0===t?void 0:t.inlineCompletionsModel)||void 0===r?void 0:r.ghostText;if(l){const o=this._editor.getModel().getLineContent(l.lineNumber);(o=>{n.add(a.onDidRenderAsync((()=>{c.className="hover-contents code-hover-contents",e.onContentsChanged()})));const t=nls.localize("inlineSuggestionFollows","Suggestion:"),r=n.add(a.render((new MarkdownString).appendText(t).appendCodeblock("text",o)));c.replaceChildren(r.element)})(l.renderForScreenReader(o))}e.fragment.appendChild(s)}};InlineCompletionsHoverParticipant=__decorate([__param(1,ICommandService),__param(2,IMenuService),__param(3,IContextKeyService),__param(4,ILanguageService),__param(5,IOpenerService),__param(6,IAccessibilityService)],InlineCompletionsHoverParticipant);export{InlineCompletionsHoverParticipant};