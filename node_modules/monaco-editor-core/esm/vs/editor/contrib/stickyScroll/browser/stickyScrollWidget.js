var _a,__decorate=this&&this.__decorate||function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);return s>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,s){function r(e){try{l(o.next(e))}catch(e){s(e)}}function a(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((o=o.apply(e,t||[])).next())}))};import{Disposable,DisposableStore,toDisposable}from"../../../../base/common/lifecycle.js";import*as dom from"../../../../base/browser/dom.js";import{StringBuilder}from"../../../common/core/stringBuilder.js";import{RenderLineInput,renderViewLine}from"../../../common/viewLayout/viewLineRenderer.js";import{LineDecoration}from"../../../common/viewLayout/lineDecorations.js";import{Position}from"../../../common/core/position.js";import{ClickLinkGesture}from"../../gotoSymbol/browser/link/clickLinkGesture.js";import{getDefinitionsAtPosition}from"../../gotoSymbol/browser/goToSymbol.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{goToDefinitionWithLocation}from"../../inlayHints/browser/inlayHintsLocations.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{Range}from"../../../common/core/range.js";import{StandardMouseEvent}from"../../../../base/browser/mouseEvent.js";import"./stickyScroll.css";export class StickyScrollWidgetState{constructor(e,t){this.lineNumbers=e,this.lastLineRelativePosition=t}}const _ttPolicy=null===(_a=window.trustedTypes)||void 0===_a?void 0:_a.createPolicy("stickyScrollViewLayer",{createHTML:e=>e});let StickyScrollWidget=class extends Disposable{constructor(e,t,i){super(),this._editor=e,this._languageFeatureService=t,this._instaService=i,this._rootDomNode=document.createElement("div"),this._disposableStore=this._register(new DisposableStore),this._layoutInfo=this._editor.getLayoutInfo(),this._rootDomNode=document.createElement("div"),this._rootDomNode.className="sticky-widget",this._rootDomNode.style.width=this._layoutInfo.width-this._layoutInfo.minimap.minimapCanvasOuterWidth-this._layoutInfo.verticalScrollbarWidth+"px",this._lineNumbers=[],this._lastLineRelativePosition=0,this._hoverOnLine=-1,this._hoverOnColumn=-1,this._stickyRangeProjectedOnEditor=null,this._candidateDefinitionsLength=-1,this._lineHeight=this._editor.getOption(60),this._register(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(60)&&(this._lineHeight=this._editor.getOption(60))}))),this._register(this.updateLinkGesture())}updateLinkGesture(){const e=new DisposableStore,t=new DisposableStore;e.add(t);const i=new ClickLinkGesture(this._editor,!0);return e.add(i),e.add(i.onMouseMoveOrRelevantKeyDown((([e,i])=>{if(!this._editor.hasModel()||!e.hasTriggerModifier)return void t.clear();const o=e.target;if(o.detail===this.getId()&&o.element.innerText===o.element.innerHTML){const e=o.element.innerText;if(-1===this._hoverOnColumn)return;const i=this._hoverOnLine,n=this._hoverOnColumn,s=new Range(i,n,i,n+e.length);if(s.equalsRange(this._stickyRangeProjectedOnEditor)){if("underline"===o.element.style.textDecoration)return}else this._stickyRangeProjectedOnEditor=s,t.clear();const r=new CancellationTokenSource;let a;t.add(toDisposable((()=>r.dispose(!0)))),getDefinitionsAtPosition(this._languageFeatureService.definitionProvider,this._editor.getModel(),new Position(i,n+1),r.token).then((e=>{if(!r.token.isCancellationRequested)if(0!==e.length){this._candidateDefinitionsLength=e.length;const i=o.element;a!==i?(t.clear(),a=i,a.style.textDecoration="underline",t.add(toDisposable((()=>{a.style.textDecoration="none"})))):a||(a=i,a.style.textDecoration="underline",t.add(toDisposable((()=>{a.style.textDecoration="none"}))))}else t.clear()}))}else t.clear()}))),e.add(i.onCancel((()=>{t.clear()}))),e.add(i.onExecute((e=>__awaiter(this,void 0,void 0,(function*(){e.target.detail===this.getId()&&(e.hasTriggerModifier?(this._candidateDefinitionsLength>1&&this._editor.revealPosition({lineNumber:this._hoverOnLine,column:1}),this._instaService.invokeFunction(goToDefinitionWithLocation,e,this._editor,{uri:this._editor.getModel().uri,range:this._stickyRangeProjectedOnEditor})):e.isRightClick||this._editor.revealPosition({lineNumber:this._hoverOnLine,column:1}))}))))),e}getCurrentLines(){return this._lineNumbers}setState(e){this._disposableStore.clear(),this._lineNumbers.length=0,dom.clearNode(this._rootDomNode),this._lastLineRelativePosition=e.lastLineRelativePosition,this._lineNumbers=e.lineNumbers,this.renderRootNode()}getChildNode(e,t){const i=document.createElement("div"),o=this._editor._getViewModel(),n=o.coordinatesConverter.convertModelPositionToViewPosition(new Position(t,1)).lineNumber,s=o.getViewLineRenderingData(n),r=this._editor.getLayoutInfo(),a=r.width-r.minimap.minimapCanvasOuterWidth-r.verticalScrollbarWidth,l=this._editor.getOption(66).side,d=this._editor.getOption(60),c=this._editor.getOption(61);let h;try{h=LineDecoration.filter(s.inlineDecorations,n,s.minColumn,s.maxColumn)}catch(e){h=[]}const m=new RenderLineInput(!0,!0,s.content,s.continuesWithWrappedLine,s.isBasicASCII,s.containsRTL,0,s.tokens,h,s.tabSize,s.startVisibleColumn,1,1,1,500,"none",!0,!0,null),u=new StringBuilder(2e3);let p;renderViewLine(m,u),p=_ttPolicy?_ttPolicy.createHTML(u.build()):u.build();const _=document.createElement("span");_.className="sticky-line",_.classList.add(`stickyLine${t}`),_.style.lineHeight=`${d}px`,_.innerHTML=p;const g=document.createElement("span");g.className="sticky-line",g.style.lineHeight=`${d}px`,"left"===l?g.style.width=r.contentLeft-r.minimap.minimapCanvasOuterWidth+"px":"right"===l&&(g.style.width=`${r.contentLeft}px`);const f=document.createElement("span");return 1===c.renderType||3===c.renderType&&t%10==0?f.innerText=t.toString():2===c.renderType&&(f.innerText=Math.abs(t-this._editor.getPosition().lineNumber).toString()),f.className="sticky-line-number",f.style.lineHeight=`${d}px`,f.style.width=`${r.lineNumbersWidth}px`,"left"===l?f.style.paddingLeft=r.lineNumbersLeft-r.minimap.minimapCanvasOuterWidth+"px":"right"===l&&(f.style.paddingLeft=`${r.lineNumbersLeft}px`),g.appendChild(f),this._editor.applyFontInfo(_),this._editor.applyFontInfo(f),i.appendChild(g),i.appendChild(_),i.className="sticky-line-root",i.style.lineHeight=`${d}px`,i.style.width=`${a}px`,i.style.height=`${d}px`,i.style.zIndex="0",e===this._lineNumbers.length-1&&(i.style.position="relative",i.style.zIndex="-1",i.style.top=this._lastLineRelativePosition+"px"),this._disposableStore.add(dom.addDisposableListener(i,"mouseover",(e=>{if(this._editor.hasModel()){const i=new StandardMouseEvent(e).target.innerText;this._hoverOnLine=t,this._hoverOnColumn=this._editor.getModel().getLineContent(t).indexOf(i)+1||-1}}))),i}renderRootNode(){if(!this._editor._getViewModel())return;for(const[e,t]of this._lineNumbers.entries())this._rootDomNode.appendChild(this.getChildNode(e,t));const e=this._lineNumbers.length*this._lineHeight+this._lastLineRelativePosition;this._rootDomNode.style.height=e.toString()+"px";const t=this._editor.getOption(66).side;"left"===t?this._rootDomNode.style.marginLeft=this._editor.getLayoutInfo().minimap.minimapCanvasOuterWidth+"px":"right"===t&&(this._rootDomNode.style.marginLeft="1px"),this._rootDomNode.style.zIndex="11"}getId(){return"editor.contrib.stickyScrollWidget"}getDomNode(){return this._rootDomNode}getPosition(){return{preference:null}}dispose(){super.dispose()}};StickyScrollWidget=__decorate([__param(1,ILanguageFeaturesService),__param(2,IInstantiationService)],StickyScrollWidget);export{StickyScrollWidget};