var __decorate=this&&this.__decorate||function(t,e,i,o){var r,n=arguments.length,s=n<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,o);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(n<3?r(s):n>3?r(e,i,s):r(e,i))||s);return n>3&&s&&Object.defineProperty(e,i,s),s},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}},__awaiter=this&&this.__awaiter||function(t,e,i,o){return new(i||(i=Promise))((function(r,n){function s(t){try{d(o.next(t))}catch(t){n(t)}}function c(t){try{d(o.throw(t))}catch(t){n(t)}}function d(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,c)}d((o=o.apply(t,e||[])).next())}))};import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{StickyScrollWidget,StickyScrollWidgetState}from"./stickyScrollWidget.js";import{StickyLineCandidateProvider,StickyRange}from"./stickyScrollProvider.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import*as dom from"../../../../base/browser/dom.js";import{IContextMenuService}from"../../../../platform/contextview/browser/contextView.js";import{MenuId}from"../../../../platform/actions/common/actions.js";let StickyScrollController=class extends Disposable{constructor(t,e,i,o){super(),this._contextMenuService=o,this._sessionStore=new DisposableStore,this._editor=t,this._stickyScrollWidget=new StickyScrollWidget(this._editor,e,i),this._stickyLineCandidateProvider=new StickyLineCandidateProvider(this._editor,e),this._widgetState=new StickyScrollWidgetState([],0),this._register(this._stickyScrollWidget),this._register(this._stickyLineCandidateProvider),this._register(this._editor.onDidChangeConfiguration((t=>{t.hasChanged(105)&&this.readConfiguration()}))),this.readConfiguration(),this._register(dom.addDisposableListener(this._stickyScrollWidget.getDomNode(),dom.EventType.CONTEXT_MENU,(t=>__awaiter(this,void 0,void 0,(function*(){this.onContextMenu(t)})))))}onContextMenu(t){this._contextMenuService.showContextMenu({menuId:MenuId.StickyScrollContext,getAnchor:()=>t})}readConfiguration(){if(!1===this._editor.getOption(105).enabled)return this._editor.removeOverlayWidget(this._stickyScrollWidget),void this._sessionStore.clear();this._editor.addOverlayWidget(this._stickyScrollWidget),this._sessionStore.add(this._editor.onDidScrollChange((()=>this.renderStickyScroll()))),this._sessionStore.add(this._editor.onDidLayoutChange((()=>this.onDidResize()))),this._sessionStore.add(this._editor.onDidChangeModelTokens((t=>this.onTokensChange(t)))),this._sessionStore.add(this._stickyLineCandidateProvider.onStickyScrollChange((()=>this.renderStickyScroll()))),2===this._editor.getOption(61).renderType&&this._sessionStore.add(this._editor.onDidChangeCursorPosition((()=>this.renderStickyScroll())))}needsUpdate(t){const e=this._stickyScrollWidget.getCurrentLines();for(const i of e)for(const e of t.ranges)if(i>=e.fromLineNumber&&i<=e.toLineNumber)return!0;return!1}onTokensChange(t){this.needsUpdate(t)&&this.renderStickyScroll()}onDidResize(){const t=this._editor.getLayoutInfo().width-this._editor.getLayoutInfo().minimap.minimapCanvasOuterWidth-this._editor.getLayoutInfo().verticalScrollbarWidth;this._stickyScrollWidget.getDomNode().style.width=`${t}px`}renderStickyScroll(){if(!this._editor.hasModel())return;const t=this._editor.getModel();this._stickyLineCandidateProvider.getVersionId()===t.getVersionId()&&(this._widgetState=this.getScrollWidgetState(),this._stickyScrollWidget.setState(this._widgetState))}getScrollWidgetState(){const t=this._editor.getOption(60),e=this._editor.getOption(105).maxLineCount,i=this._editor.getScrollTop();let o=0;const r=[],n=this._editor.getVisibleRanges();if(0!==n.length){const s=new StickyRange(n[0].startLineNumber,n[n.length-1].endLineNumber),c=this._stickyLineCandidateProvider.getCandidateStickyLinesIntersecting(s);for(const n of c){const s=n.startLineNumber,c=n.endLineNumber,d=n.nestingDepth;if(c-s>0){const n=(d-1)*t,a=d*t,l=this._editor.getBottomForLineNumber(s)-i,h=this._editor.getTopForLineNumber(c)-i,S=this._editor.getBottomForLineNumber(c)-i;if(n>h&&n<=S){r.push(s),o=S-a;break}if(a>l&&a<=S&&r.push(s),r.length===e)break}}}return new StickyScrollWidgetState(r,o)}dispose(){super.dispose(),this._sessionStore.dispose()}};StickyScrollController.ID="store.contrib.stickyScrollController",StickyScrollController=__decorate([__param(1,ILanguageFeaturesService),__param(2,IInstantiationService),__param(3,IContextMenuService)],StickyScrollController);export{StickyScrollController};