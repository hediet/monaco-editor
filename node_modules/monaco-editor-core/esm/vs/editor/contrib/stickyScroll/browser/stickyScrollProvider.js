var __decorate=this&&this.__decorate||function(e,t,n,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(t,n,s):r(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}},__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{l(i.next(e))}catch(e){o(e)}}function a(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))};import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{OutlineModel,OutlineElement,OutlineGroup}from"../../documentSymbols/browser/outlineModel.js";import{CancellationTokenSource}from"../../../../base/common/cancellation.js";import{RunOnceScheduler}from"../../../../base/common/async.js";import{Emitter}from"../../../../base/common/event.js";import{binarySearch}from"../../../../base/common/arrays.js";import{Iterable}from"../../../../base/common/iterator.js";import{FoldingController}from"../../folding/browser/folding.js";export class StickyRange{constructor(e,t){this.startLineNumber=e,this.endLineNumber=t}}export class StickyLineCandidate{constructor(e,t,n){this.startLineNumber=e,this.endLineNumber=t,this.nestingDepth=n}}let StickyLineCandidateProvider=class extends Disposable{constructor(e,t){super(),this.onStickyScrollChangeEmitter=this._register(new Emitter),this.onStickyScrollChange=this.onStickyScrollChangeEmitter.event,this._sessionStore=new DisposableStore,this._modelVersionId=0,this._providerID=void 0,this._editor=e,this._languageFeaturesService=t,this._updateSoon=this._register(new RunOnceScheduler((()=>this.update()),50)),this._register(this._editor.onDidChangeConfiguration((e=>{e.hasChanged(105)&&this.readConfiguration()}))),this.readConfiguration()}readConfiguration(){!1!==this._editor.getOption(105).enabled?(this._sessionStore.add(this._editor.onDidChangeModel((()=>{this._providerID=void 0,this.update()}))),this._sessionStore.add(this._editor.onDidChangeHiddenAreas((()=>this.update()))),this._sessionStore.add(this._editor.onDidChangeModelContent((()=>this._updateSoon.schedule()))),this._sessionStore.add(this._languageFeaturesService.documentSymbolProvider.onDidChange((()=>{this._providerID=void 0,this.update()}))),this.update()):this._sessionStore.clear()}getVersionId(){return this._modelVersionId}update(){var e;return __awaiter(this,void 0,void 0,(function*(){null===(e=this._cts)||void 0===e||e.dispose(!0),this._cts=new CancellationTokenSource,yield this.updateOutlineModel(this._cts.token),this.onStickyScrollChangeEmitter.fire()}))}updateOutlineModel(e){return __awaiter(this,void 0,void 0,(function*(){if(this._editor.hasModel()){const t=this._editor.getModel(),n=t.getVersionId(),i=yield OutlineModel.create(this._languageFeaturesService.documentSymbolProvider,t,e);if(e.isCancellationRequested)return;if(0!==i.children.size){const{stickyOutlineElement:e,providerID:t}=StickyOutlineElement.fromOutlineModel(i,this._providerID);this._outlineModel=e,this._providerID=t}else{const t=FoldingController.get(this._editor),n=yield null==t?void 0:t.getFoldingModel();if(e.isCancellationRequested)return;n&&0!==n.regions.length?this._outlineModel=StickyOutlineElement.fromFoldingModel(n):this._outlineModel=new StickyOutlineElement(new StickyRange(-1,-1),[],void 0)}this._modelVersionId=n}}))}updateIndex(e){return-1===e?e=0:e<0&&(e=-e-2),e}getCandidateStickyLinesIntersectingFromOutline(e,t,n,i,r){if(0===t.children.length)return;let o=r;const s=[];for(let e=0;e<t.children.length;e++){const n=t.children[e];n.range&&s.push(n.range.startLineNumber)}const a=this.updateIndex(binarySearch(s,e.startLineNumber,((e,t)=>e-t))),l=this.updateIndex(binarySearch(s,e.startLineNumber+i,((e,t)=>e-t)));for(let s=a;s<=l;s++){const a=t.children[s];if(!a)return;if(a.range){const t=a.range.startLineNumber,r=a.range.endLineNumber;e.startLineNumber<=r+1&&t-1<=e.endLineNumber&&t!==o&&(o=t,n.push(new StickyLineCandidate(t,r-1,i+1)),this.getCandidateStickyLinesIntersectingFromOutline(e,a,n,i+1,t))}else this.getCandidateStickyLinesIntersectingFromOutline(e,a,n,i,r)}}getCandidateStickyLinesIntersecting(e){var t;let n=[];this.getCandidateStickyLinesIntersectingFromOutline(e,this._outlineModel,n,0,-1);const i=null===(t=this._editor._getViewModel())||void 0===t?void 0:t.getHiddenAreas();if(i)for(const e of i)n=n.filter((t=>!(t.startLineNumber>=e.startLineNumber&&t.endLineNumber<=e.endLineNumber+1)));return n}dispose(){super.dispose(),this._sessionStore.dispose()}};StickyLineCandidateProvider=__decorate([__param(1,ILanguageFeaturesService)],StickyLineCandidateProvider);export{StickyLineCandidateProvider};class StickyOutlineElement{static comparator(e,t){return e.startLineNumber!==t.startLineNumber?e.startLineNumber-t.startLineNumber:t.endLineNumber-e.endLineNumber}static fromOutlineElement(e,t){const n=[];for(const i of e.children.values())if(i.symbol.selectionRange.startLineNumber!==i.symbol.range.endLineNumber)if(i.symbol.selectionRange.startLineNumber!==t)n.push(StickyOutlineElement.fromOutlineElement(i,i.symbol.selectionRange.startLineNumber));else for(const e of i.children.values())n.push(StickyOutlineElement.fromOutlineElement(e,i.symbol.selectionRange.startLineNumber));n.sort(((e,t)=>this.comparator(e.range,t.range)));const i=new StickyRange(e.symbol.selectionRange.startLineNumber,e.symbol.range.endLineNumber);return new StickyOutlineElement(i,n,void 0)}static fromOutlineModel(e,t){let n,i=t;if(Iterable.first(e.children.values())instanceof OutlineGroup){const r=Iterable.find(e.children.values(),(e=>e.id===t));if(r)n=r.children;else{let t,r="",o=-1;for(const[n,i]of e.children.entries()){const e=StickyOutlineElement.findSumOfRangesOfGroup(i);e>o&&(t=i,o=e,r=i.id)}i=r,n=t.children}}else n=e.children;const r=[],o=Array.from(n.values()).sort(((e,t)=>{const n=new StickyRange(e.symbol.range.startLineNumber,e.symbol.range.endLineNumber),i=new StickyRange(t.symbol.range.startLineNumber,t.symbol.range.endLineNumber);return this.comparator(n,i)}));for(const e of o)r.push(StickyOutlineElement.fromOutlineElement(e,e.symbol.selectionRange.startLineNumber));return{stickyOutlineElement:new StickyOutlineElement(void 0,r,void 0),providerID:i}}static findSumOfRangesOfGroup(e){let t=0;for(const n of e.children.values())t+=this.findSumOfRangesOfGroup(n);return e instanceof OutlineElement?t+e.symbol.range.endLineNumber-e.symbol.selectionRange.startLineNumber:t}static fromFoldingModel(e){const t=e.regions,n=t.length;let i;const r=[],o=new StickyOutlineElement(void 0,[],void 0);let s=o;for(let e=0;e<n;e++){for(i=new StickyRange(t.getStartLineNumber(e),t.getEndLineNumber(e)+1);0!==r.length&&(i.startLineNumber<r[r.length-1].startLineNumber||i.endLineNumber>r[r.length-1].endLineNumber);)r.pop(),void 0!==s.parent&&(s=s.parent);const n=new StickyOutlineElement(i,[],s);s.children.push(n),s=n,r.push(i)}return o}constructor(e,t,n){this.range=e,this.children=t,this.parent=n}}