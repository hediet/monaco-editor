var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};import{createCancelablePromise}from"../../../../../base/common/async.js";import{onUnexpectedError}from"../../../../../base/common/errors.js";import{MarkdownString}from"../../../../../base/common/htmlContent.js";import{DisposableStore}from"../../../../../base/common/lifecycle.js";import{withNullAsUndefined}from"../../../../../base/common/types.js";import"./goToDefinitionAtPosition.css";import{EditorState}from"../../../editorState/browser/editorState.js";import{registerEditorContribution}from"../../../../browser/editorExtensions.js";import{Range}from"../../../../common/core/range.js";import{ILanguageService}from"../../../../common/languages/language.js";import{ITextModelService}from"../../../../common/services/resolverService.js";import{ClickLinkGesture}from"./clickLinkGesture.js";import{PeekContext}from"../../../peekView/browser/peekView.js";import*as nls from"../../../../../nls.js";import{IContextKeyService}from"../../../../../platform/contextkey/common/contextkey.js";import{editorActiveLinkForeground}from"../../../../../platform/theme/common/colorRegistry.js";import{registerThemingParticipant}from"../../../../../platform/theme/common/themeService.js";import{DefinitionAction}from"../goToCommands.js";import{getDefinitionsAtPosition}from"../goToSymbol.js";import{ILanguageFeaturesService}from"../../../../common/services/languageFeatures.js";let GotoDefinitionAtPositionEditorContribution=class e{constructor(e,t,o,i){this.textModelResolverService=t,this.languageService=o,this.languageFeaturesService=i,this.toUnhook=new DisposableStore,this.toUnhookForKeyboard=new DisposableStore,this.currentWordAtPosition=null,this.previousPromise=null,this.editor=e,this.linkDecorations=this.editor.createDecorationsCollection();const n=new ClickLinkGesture(e);this.toUnhook.add(n),this.toUnhook.add(n.onMouseMoveOrRelevantKeyDown((([e,t])=>{this.startFindDefinitionFromMouse(e,withNullAsUndefined(t))}))),this.toUnhook.add(n.onExecute((e=>{this.isEnabled(e)&&this.gotoDefinition(e.target.position,e.hasSideBySideModifier).then((()=>{this.removeLinkDecorations()}),(e=>{this.removeLinkDecorations(),onUnexpectedError(e)}))}))),this.toUnhook.add(n.onCancel((()=>{this.removeLinkDecorations(),this.currentWordAtPosition=null})))}static get(t){return t.getContribution(e.ID)}startFindDefinitionFromCursor(e){return this.startFindDefinition(e).then((()=>{this.toUnhookForKeyboard.add(this.editor.onDidChangeCursorPosition((()=>{this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear()}))),this.toUnhookForKeyboard.add(this.editor.onKeyDown((e=>{e&&(this.currentWordAtPosition=null,this.removeLinkDecorations(),this.toUnhookForKeyboard.clear())})))}))}startFindDefinitionFromMouse(e,t){if(9===e.target.type&&this.linkDecorations.length>0)return;if(!this.editor.hasModel()||!this.isEnabled(e,t))return this.currentWordAtPosition=null,void this.removeLinkDecorations();const o=e.target.position;this.startFindDefinition(o)}startFindDefinition(e){var t;this.toUnhookForKeyboard.clear();const o=e?null===(t=this.editor.getModel())||void 0===t?void 0:t.getWordAtPosition(e):null;if(!o)return this.currentWordAtPosition=null,this.removeLinkDecorations(),Promise.resolve(0);if(this.currentWordAtPosition&&this.currentWordAtPosition.startColumn===o.startColumn&&this.currentWordAtPosition.endColumn===o.endColumn&&this.currentWordAtPosition.word===o.word)return Promise.resolve(0);this.currentWordAtPosition=o;const i=new EditorState(this.editor,15);return this.previousPromise&&(this.previousPromise.cancel(),this.previousPromise=null),this.previousPromise=createCancelablePromise((t=>this.findDefinition(e,t))),this.previousPromise.then((t=>{if(t&&t.length&&i.validate(this.editor))if(t.length>1)this.addDecoration(new Range(e.lineNumber,o.startColumn,e.lineNumber,o.endColumn),(new MarkdownString).appendText(nls.localize("multipleResults","Click to show {0} definitions.",t.length)));else{const i=t[0];if(!i.uri)return;this.textModelResolverService.createModelReference(i.uri).then((t=>{if(!t.object||!t.object.textEditorModel)return void t.dispose();const{object:{textEditorModel:n}}=t,{startLineNumber:r}=i.range;if(r<1||r>n.getLineCount())return void t.dispose();const s=this.getPreviewValue(n,r,i);let a;a=i.originSelectionRange?Range.lift(i.originSelectionRange):new Range(e.lineNumber,o.startColumn,e.lineNumber,o.endColumn);const d=this.languageService.guessLanguageIdByFilepathOrFirstLine(n.uri);this.addDecoration(a,(new MarkdownString).appendCodeblock(d||"",s)),t.dispose()}))}else this.removeLinkDecorations()})).then(void 0,onUnexpectedError)}getPreviewValue(t,o,i){let n=i.range;return n.endLineNumber-n.startLineNumber>=e.MAX_SOURCE_PREVIEW_LINES&&(n=this.getPreviewRangeBasedOnIndentation(t,o)),this.stripIndentationFromPreviewRange(t,o,n)}stripIndentationFromPreviewRange(e,t,o){let i=e.getLineFirstNonWhitespaceColumn(t);for(let n=t+1;n<o.endLineNumber;n++){const t=e.getLineFirstNonWhitespaceColumn(n);i=Math.min(i,t)}return e.getValueInRange(o).replace(new RegExp(`^\\s{${i-1}}`,"gm"),"").trim()}getPreviewRangeBasedOnIndentation(t,o){const i=t.getLineFirstNonWhitespaceColumn(o),n=Math.min(t.getLineCount(),o+e.MAX_SOURCE_PREVIEW_LINES);let r=o+1;for(;r<n&&i!==t.getLineFirstNonWhitespaceColumn(r);r++);return new Range(o,1,r+1,1)}addDecoration(e,t){const o={range:e,options:{description:"goto-definition-link",inlineClassName:"goto-definition-link",hoverMessage:t}};this.linkDecorations.set([o])}removeLinkDecorations(){this.linkDecorations.clear()}isEnabled(e,t){return this.editor.hasModel()&&e.isLeftClick&&e.isNoneOrSingleMouseDown&&6===e.target.type&&(e.hasTriggerModifier||!!t&&t.keyCodeIsTriggerKey)&&this.languageFeaturesService.definitionProvider.has(this.editor.getModel())}findDefinition(e,t){const o=this.editor.getModel();return o?getDefinitionsAtPosition(this.languageFeaturesService.definitionProvider,o,e,t):Promise.resolve(null)}gotoDefinition(e,t){return this.editor.setPosition(e),this.editor.invokeWithinContext((e=>{const o=!t&&this.editor.getOption(79)&&!this.isInPeekEditor(e);return new DefinitionAction({openToSide:t,openInPeek:o,muteMessage:!0},{title:{value:"",original:""},id:"",precondition:void 0}).run(e,this.editor)}))}isInPeekEditor(e){const t=e.get(IContextKeyService);return PeekContext.inPeekEditor.getValue(t)}dispose(){this.toUnhook.dispose()}};GotoDefinitionAtPositionEditorContribution.ID="editor.contrib.gotodefinitionatposition",GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES=8,GotoDefinitionAtPositionEditorContribution=__decorate([__param(1,ITextModelService),__param(2,ILanguageService),__param(3,ILanguageFeaturesService)],GotoDefinitionAtPositionEditorContribution);export{GotoDefinitionAtPositionEditorContribution};registerEditorContribution(GotoDefinitionAtPositionEditorContribution.ID,GotoDefinitionAtPositionEditorContribution),registerThemingParticipant(((e,t)=>{const o=e.getColor(editorActiveLinkForeground);o&&t.addRule(`.monaco-editor .goto-definition-link { color: ${o} !important; }`)}));