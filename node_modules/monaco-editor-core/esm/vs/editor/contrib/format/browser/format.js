var __awaiter=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))((function(r,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};import{alert}from"../../../../base/browser/ui/aria/aria.js";import{asArray,isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Iterable}from"../../../../base/common/iterator.js";import{LinkedList}from"../../../../base/common/linkedList.js";import{assertType}from"../../../../base/common/types.js";import{URI}from"../../../../base/common/uri.js";import{EditorStateCancellationTokenSource,TextModelCancellationTokenSource}from"../../editorState/browser/editorState.js";import{isCodeEditor}from"../../../browser/editorBrowser.js";import{Position}from"../../../common/core/position.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{IEditorWorkerService}from"../../../common/services/editorWorker.js";import{ITextModelService}from"../../../common/services/resolverService.js";import{FormattingEdit}from"./formattingEdit.js";import*as nls from"../../../../nls.js";import{CommandsRegistry}from"../../../../platform/commands/common/commands.js";import{ExtensionIdentifier}from"../../../../platform/extensions/common/extensions.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";export function alertFormattingEdits(e){if(!(e=e.filter((e=>e.range))).length)return;let{range:t}=e[0];for(let o=1;o<e.length;o++)t=Range.plusRange(t,e[o].range);const{startLineNumber:o,endLineNumber:n}=t;o===n?1===e.length?alert(nls.localize("hint11","Made 1 formatting edit on line {0}",o)):alert(nls.localize("hintn1","Made {0} formatting edits on line {1}",e.length,o)):1===e.length?alert(nls.localize("hint1n","Made 1 formatting edit between lines {0} and {1}",o,n)):alert(nls.localize("hintnn","Made {0} formatting edits between lines {1} and {2}",e.length,o,n))}export function getRealAndSyntheticDocumentFormattersOrdered(e,t,o){const n=[],r=new Set,i=e.ordered(o);for(const e of i)n.push(e),e.extensionId&&r.add(ExtensionIdentifier.toKey(e.extensionId));const s=t.ordered(o);for(const e of s){if(e.extensionId){if(r.has(ExtensionIdentifier.toKey(e.extensionId)))continue;r.add(ExtensionIdentifier.toKey(e.extensionId))}n.push({displayName:e.displayName,extensionId:e.extensionId,provideDocumentFormattingEdits:(t,o,n)=>e.provideDocumentRangeFormattingEdits(t,t.getFullModelRange(),o,n)})}return n}export class FormattingConflicts{static setFormatterSelector(e){return{dispose:FormattingConflicts._selectors.unshift(e)}}static select(e,t,o){return __awaiter(this,void 0,void 0,(function*(){if(0===e.length)return;const n=Iterable.first(FormattingConflicts._selectors);return n?yield n(e,t,o):void 0}))}}FormattingConflicts._selectors=new LinkedList;export function formatDocumentRangesWithSelectedProvider(e,t,o,n,r,i){return __awaiter(this,void 0,void 0,(function*(){const s=e.get(IInstantiationService),{documentRangeFormattingEditProvider:a}=e.get(ILanguageFeaturesService),c=isCodeEditor(t)?t.getModel():t,d=a.ordered(c),m=yield FormattingConflicts.select(d,c,n);m&&(r.report(m),yield s.invokeFunction(formatDocumentRangesWithProvider,m,t,o,i))}))}export function formatDocumentRangesWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService);let s,a;isCodeEditor(o)?(s=o.getModel(),a=new EditorStateCancellationTokenSource(o,5,void 0,r)):(s=o,a=new TextModelCancellationTokenSource(o,r));const c=[];let d=0;for(const e of asArray(n).sort(Range.compareRangesUsingStarts))d>0&&Range.areIntersectingOrTouching(c[d-1],e)?c[d-1]=Range.fromPositions(c[d-1].getStartPosition(),e.getEndPosition()):d=c.push(e);const m=e=>__awaiter(this,void 0,void 0,(function*(){return(yield t.provideDocumentRangeFormattingEdits(s,e,s.getFormattingOptions(),a.token))||[]})),l=(e,t)=>{if(!e.length||!t.length)return!1;const o=e.reduce(((e,t)=>Range.plusRange(e,t.range)),e[0].range);if(!t.some((e=>Range.intersectRanges(o,e.range))))return!1;for(const o of e)for(const e of t)if(Range.intersectRanges(o.range,e.range))return!0;return!1},u=[],g=[];try{for(const e of c){if(a.token.isCancellationRequested)return!0;g.push(yield m(e))}for(let e=0;e<c.length;++e)for(let t=e+1;t<c.length;++t){if(a.token.isCancellationRequested)return!0;if(l(g[e],g[t])){const o=Range.plusRange(c[e],c[t]),n=yield m(o);c.splice(t,1),c.splice(e,1),c.push(o),g.splice(t,1),g.splice(e,1),g.push(n),e=0,t=0}}for(const e of g){if(a.token.isCancellationRequested)return!0;const t=yield i.computeMoreMinimalEdits(s.uri,e);t&&u.push(...t)}}finally{a.dispose()}if(0===u.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,u,!0),alertFormattingEdits(u),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1);else{const[{range:e}]=u,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);s.pushEditOperations([t],u.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function formatDocumentWithSelectedProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IInstantiationService),s=e.get(ILanguageFeaturesService),a=isCodeEditor(t)?t.getModel():t,c=getRealAndSyntheticDocumentFormattersOrdered(s.documentFormattingEditProvider,s.documentRangeFormattingEditProvider,a),d=yield FormattingConflicts.select(c,a,o);d&&(n.report(d),yield i.invokeFunction(formatDocumentWithProvider,d,t,o,r))}))}export function formatDocumentWithProvider(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=e.get(IEditorWorkerService);let s,a,c;isCodeEditor(o)?(s=o.getModel(),a=new EditorStateCancellationTokenSource(o,5,void 0,r)):(s=o,a=new TextModelCancellationTokenSource(o,r));try{const e=yield t.provideDocumentFormattingEdits(s,s.getFormattingOptions(),a.token);if(c=yield i.computeMoreMinimalEdits(s.uri,e),a.token.isCancellationRequested)return!0}finally{a.dispose()}if(!c||0===c.length)return!1;if(isCodeEditor(o))FormattingEdit.execute(o,c,2!==n),2!==n&&(alertFormattingEdits(c),o.revealPositionInCenterIfOutsideViewport(o.getPosition(),1));else{const[{range:e}]=c,t=new Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);s.pushEditOperations([t],c.map((e=>({text:e.text,range:Range.lift(e.range),forceMoveMarkers:!0}))),(e=>{for(const{range:o}of e)if(Range.areIntersectingOrTouching(o,t))return[new Selection(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn)];return null}))}return!0}))}export function getDocumentRangeFormattingEditsUntilResult(e,t,o,n,r,i){return __awaiter(this,void 0,void 0,(function*(){const s=t.documentRangeFormattingEditProvider.ordered(o);for(const t of s){const s=yield Promise.resolve(t.provideDocumentRangeFormattingEdits(o,n,r,i)).catch(onUnexpectedExternalError);if(isNonEmptyArray(s))return yield e.computeMoreMinimalEdits(o.uri,s)}}))}export function getDocumentFormattingEditsUntilResult(e,t,o,n,r){return __awaiter(this,void 0,void 0,(function*(){const i=getRealAndSyntheticDocumentFormattersOrdered(t.documentFormattingEditProvider,t.documentRangeFormattingEditProvider,o);for(const t of i){const i=yield Promise.resolve(t.provideDocumentFormattingEdits(o,n,r)).catch(onUnexpectedExternalError);if(isNonEmptyArray(i))return yield e.computeMoreMinimalEdits(o.uri,i)}}))}export function getOnTypeFormattingEdits(e,t,o,n,r,i,s){const a=t.onTypeFormattingEditProvider.ordered(o);return 0===a.length||a[0].autoFormatTriggerCharacters.indexOf(r)<0?Promise.resolve(void 0):Promise.resolve(a[0].provideOnTypeFormattingEdits(o,n,r,i,s)).catch(onUnexpectedExternalError).then((t=>e.computeMoreMinimalEdits(o.uri,t)))}CommandsRegistry.registerCommand("_executeFormatRangeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r]=t;assertType(URI.isUri(o)),assertType(Range.isIRange(n));const i=e.get(ITextModelService),s=e.get(IEditorWorkerService),a=e.get(ILanguageFeaturesService),c=yield i.createModelReference(o);try{return getDocumentRangeFormattingEditsUntilResult(s,a,c.object.textEditorModel,Range.lift(n),r,CancellationToken.None)}finally{c.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatDocumentProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n]=t;assertType(URI.isUri(o));const r=e.get(ITextModelService),i=e.get(IEditorWorkerService),s=e.get(ILanguageFeaturesService),a=yield r.createModelReference(o);try{return getDocumentFormattingEditsUntilResult(i,s,a.object.textEditorModel,n,CancellationToken.None)}finally{a.dispose()}}))})),CommandsRegistry.registerCommand("_executeFormatOnTypeProvider",(function(e,...t){return __awaiter(this,void 0,void 0,(function*(){const[o,n,r,i]=t;assertType(URI.isUri(o)),assertType(Position.isIPosition(n)),assertType("string"==typeof r);const s=e.get(ITextModelService),a=e.get(IEditorWorkerService),c=e.get(ILanguageFeaturesService),d=yield s.createModelReference(o);try{return getOnTypeFormattingEdits(a,c,d.object.textEditorModel,Position.lift(n),r,i,CancellationToken.None)}finally{d.dispose()}}))}));