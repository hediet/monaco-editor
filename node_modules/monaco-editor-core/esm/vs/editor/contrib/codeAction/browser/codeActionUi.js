var _CodeActionUi_disposed,__decorate=this&&this.__decorate||function(e,t,i,o){var r,s=arguments.length,n=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(n=(s<3?r(n):s>3?r(t,i,n):r(t,i))||n);return s>3&&n&&Object.defineProperty(t,i,n),n},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(r,s){function n(e){try{d(o.next(e))}catch(e){s(e)}}function a(e){try{d(o.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}d((o=o.apply(e,t||[])).next())}))},__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(e,t,i,o,r){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?r.call(e,i):r?r.value=i:t.set(e,i),i},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(e,t,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(e):o?o.value:t.get(e)};import{getDomNodePagePosition}from"../../../../base/browser/dom.js";import{onUnexpectedError}from"../../../../base/common/errors.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{MessageController}from"../../message/browser/messageController.js";import{IConfigurationService}from"../../../../platform/configuration/common/configuration.js";import{IContextKeyService}from"../../../../platform/contextkey/common/contextkey.js";import{IInstantiationService}from"../../../../platform/instantiation/common/instantiation.js";import{CodeActionWidget}from"./codeActionWidget.js";import{LightBulbWidget}from"./lightBulbWidget.js";let CodeActionUi=class extends Disposable{constructor(e,t,i,o,r,s,n){super(),this._editor=e,this.delegate=o,this._configurationService=r,this._contextKeyService=s,this._instantiationService=n,this._activeCodeActions=this._register(new MutableDisposable),_CodeActionUi_disposed.set(this,!1),this._lightBulbWidget=new Lazy((()=>{const e=this._register(n.createInstance(LightBulbWidget,this._editor,t,i));return this._register(e.onClick((e=>this.showCodeActionList(e.trigger,e.actions,e,{includeDisabledActions:!1,fromLightbulb:!0,showHeaders:this.shouldShowHeaders()})))),e})),this._register(this._editor.onDidLayoutChange((()=>{var e;return null===(e=CodeActionWidget.INSTANCE)||void 0===e?void 0:e.hide()})))}dispose(){__classPrivateFieldSet(this,_CodeActionUi_disposed,!0,"f"),super.dispose()}update(e){var t,i,o,r,s,n;return __awaiter(this,void 0,void 0,(function*(){if(1!==e.type)return void(null===(t=this._lightBulbWidget.rawValue)||void 0===t||t.hide());let a;try{a=yield e.actions}catch(e){return void onUnexpectedError(e)}if(!__classPrivateFieldGet(this,_CodeActionUi_disposed,"f"))if(this._lightBulbWidget.getValue().update(a,e.trigger,e.position),1===e.trigger.type){if(null===(i=e.trigger.filter)||void 0===i?void 0:i.include){const t=this.tryGetValidActionToApply(e.trigger,a);if(t){try{this._lightBulbWidget.getValue().hide(),yield this.delegate.applyCodeAction(t,!1,!1)}finally{a.dispose()}return}if(e.trigger.context){const t=this.getInvalidActionThatWouldHaveBeenApplied(e.trigger,a);if(t&&t.action.disabled)return null===(o=MessageController.get(this._editor))||void 0===o||o.showMessage(t.action.disabled,e.trigger.context.position),void a.dispose()}}const t=!!(null===(r=e.trigger.filter)||void 0===r?void 0:r.include);if(e.trigger.context&&(!a.allActions.length||!t&&!a.validActions.length))return null===(s=MessageController.get(this._editor))||void 0===s||s.showMessage(e.trigger.context.notAvailableMessage,e.trigger.context.position),this._activeCodeActions.value=a,void a.dispose();this._activeCodeActions.value=a,this.showCodeActionList(e.trigger,a,this.toCoords(e.position),{includeDisabledActions:t,fromLightbulb:!1,showHeaders:this.shouldShowHeaders()})}else(null===(n=CodeActionWidget.INSTANCE)||void 0===n?void 0:n.isVisible)?a.dispose():this._activeCodeActions.value=a}))}getInvalidActionThatWouldHaveBeenApplied(e,t){if(t.allActions.length)return"first"===e.autoApply&&0===t.validActions.length||"ifSingle"===e.autoApply&&1===t.allActions.length?t.allActions.find((({action:e})=>e.disabled)):void 0}tryGetValidActionToApply(e,t){if(t.validActions.length)return"first"===e.autoApply&&t.validActions.length>0||"ifSingle"===e.autoApply&&1===t.validActions.length?t.validActions[0]:void 0}showCodeActionList(e,t,i,o){return __awaiter(this,void 0,void 0,(function*(){const r=this._editor.getDomNode();if(!r)return;const s=Position.isIPosition(i)?this.toCoords(i):i;CodeActionWidget.getOrCreateInstance(this._instantiationService).show(e,t,s,r,Object.assign(Object.assign({},o),{showHeaders:this.shouldShowHeaders()}),{onSelectCodeAction:(e,t,i)=>__awaiter(this,void 0,void 0,(function*(){this.delegate.applyCodeAction(e,!0,Boolean(i.preview||t.preview))})),onHide:()=>{var e;null===(e=this._editor)||void 0===e||e.focus()}},this._contextKeyService)}))}toCoords(e){if(!this._editor.hasModel())return{x:0,y:0};this._editor.revealPosition(e,1),this._editor.render();const t=this._editor.getScrolledVisiblePosition(e),i=getDomNodePagePosition(this._editor.getDomNode());return{x:i.left+t.left,y:i.top+t.top+t.height}}shouldShowHeaders(){var e;const t=null===(e=this._editor)||void 0===e?void 0:e.getModel();return this._configurationService.getValue("editor.codeActionWidget.showHeaders",{resource:null==t?void 0:t.uri})}};_CodeActionUi_disposed=new WeakMap,CodeActionUi=__decorate([__param(4,IConfigurationService),__param(5,IContextKeyService),__param(6,IInstantiationService)],CodeActionUi);export{CodeActionUi};