var __awaiter=this&&this.__awaiter||function(o,e,t,n){return new(t||(t=Promise))((function(i,r){function c(o){try{d(n.next(o))}catch(o){r(o)}}function a(o){try{d(n.throw(o))}catch(o){r(o)}}function d(o){var e;o.done?i(o.value):(e=o.value,e instanceof t?e:new t((function(o){o(e)}))).then(c,a)}d((n=n.apply(o,e||[])).next())}))};import{coalesce,equals,isNonEmptyArray}from"../../../../base/common/arrays.js";import{CancellationToken}from"../../../../base/common/cancellation.js";import{illegalArgument,isCancellationError,onUnexpectedExternalError}from"../../../../base/common/errors.js";import{Disposable,DisposableStore}from"../../../../base/common/lifecycle.js";import{URI}from"../../../../base/common/uri.js";import{IBulkEditService}from"../../../browser/services/bulkEditService.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{IModelService}from"../../../common/services/model.js";import{TextModelCancellationTokenSource}from"../../editorState/browser/editorState.js";import*as nls from"../../../../nls.js";import{CommandsRegistry,ICommandService}from"../../../../platform/commands/common/commands.js";import{INotificationService}from"../../../../platform/notification/common/notification.js";import{Progress}from"../../../../platform/progress/common/progress.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";import{CodeActionItem,CodeActionKind,CodeActionTriggerSource,filtersAction,mayIncludeActionsOfKind}from"../common/types.js";export const codeActionCommandId="editor.action.codeAction";export const refactorCommandId="editor.action.refactor";export const refactorPreviewCommandId="editor.action.refactor.preview";export const sourceActionCommandId="editor.action.sourceAction";export const organizeImportsCommandId="editor.action.organizeImports";export const fixAllCommandId="editor.action.fixAll";export const acceptSelectedCodeActionCommand="acceptSelectedCodeAction";export const previewSelectedCodeActionCommand="previewSelectedCodeAction";class ManagedCodeActionSet extends Disposable{static codeActionsPreferredComparator(o,e){return o.isPreferred&&!e.isPreferred?-1:!o.isPreferred&&e.isPreferred?1:0}static codeActionsComparator({action:o},{action:e}){return isNonEmptyArray(o.diagnostics)?isNonEmptyArray(e.diagnostics)?ManagedCodeActionSet.codeActionsPreferredComparator(o,e):-1:isNonEmptyArray(e.diagnostics)?1:ManagedCodeActionSet.codeActionsPreferredComparator(o,e)}constructor(o,e,t){super(),this.documentation=e,this._register(t),this.allActions=[...o].sort(ManagedCodeActionSet.codeActionsComparator),this.validActions=this.allActions.filter((({action:o})=>!o.disabled))}get hasAutoFix(){return this.validActions.some((({action:o})=>!!o.kind&&CodeActionKind.QuickFix.contains(new CodeActionKind(o.kind))&&!!o.isPreferred))}}const emptyCodeActionsResponse={actions:[],documentation:void 0};export function getCodeActions(o,e,t,n,i,r){var c;return __awaiter(this,void 0,void 0,(function*(){const a=n.filter||{},d={only:null===(c=a.include)||void 0===c?void 0:c.value,trigger:n.type},s=new TextModelCancellationTokenSource(e,r),l=getCodeActionProviders(o,e,a),m=new DisposableStore,p=l.map((o=>__awaiter(this,void 0,void 0,(function*(){try{i.report(o);const n=yield o.provideCodeActions(e,t,d,s.token);if(n&&m.add(n),s.token.isCancellationRequested)return emptyCodeActionsResponse;const r=((null==n?void 0:n.actions)||[]).filter((o=>o&&filtersAction(a,o))),c=getDocumentationFromProvider(o,r,a.include);return{actions:r.map((e=>new CodeActionItem(e,o))),documentation:c}}catch(o){if(isCancellationError(o))throw o;return onUnexpectedExternalError(o),emptyCodeActionsResponse}})))),f=o.onDidChange((()=>{const t=o.all(e);equals(t,l)||s.cancel()}));try{const t=yield Promise.all(p),i=t.map((o=>o.actions)).flat(),r=[...coalesce(t.map((o=>o.documentation))),...getAdditionalDocumentationForShowingActions(o,e,n,i)];return new ManagedCodeActionSet(i,r,m)}finally{f.dispose(),s.dispose()}}))}function getCodeActionProviders(o,e,t){return o.all(e).filter((o=>!o.providedCodeActionKinds||o.providedCodeActionKinds.some((o=>mayIncludeActionsOfKind(t,new CodeActionKind(o))))))}function*getAdditionalDocumentationForShowingActions(o,e,t,n){var i,r,c;if(e&&n.length)for(const a of o.all(e))a._getAdditionalMenuItems&&(yield*null===(i=a._getAdditionalMenuItems)||void 0===i?void 0:i.call(a,{trigger:t.type,only:null===(c=null===(r=t.filter)||void 0===r?void 0:r.include)||void 0===c?void 0:c.value},n.map((o=>o.action))))}function getDocumentationFromProvider(o,e,t){if(!o.documentation)return;const n=o.documentation.map((o=>({kind:new CodeActionKind(o.kind),command:o.command})));if(t){let o;for(const e of n)e.kind.contains(t)&&(o?o.kind.contains(e.kind)&&(o=e):o=e);if(o)return null==o?void 0:o.command}for(const o of e)if(o.kind)for(const e of n)if(e.kind.contains(new CodeActionKind(o.kind)))return e.command}export var ApplyCodeActionReason;!function(o){o.OnSave="onSave",o.FromProblemsView="fromProblemsView",o.FromCodeActions="fromCodeActions"}(ApplyCodeActionReason||(ApplyCodeActionReason={}));export function applyCodeAction(o,e,t,n){return __awaiter(this,void 0,void 0,(function*(){const i=o.get(IBulkEditService),r=o.get(ICommandService),c=o.get(ITelemetryService),a=o.get(INotificationService);if(c.publicLog2("codeAction.applyCodeAction",{codeActionTitle:e.action.title,codeActionKind:e.action.kind,codeActionIsPreferred:!!e.action.isPreferred,reason:t}),yield e.resolve(CancellationToken.None),e.action.edit&&(yield i.apply(e.action.edit,{editor:null==n?void 0:n.editor,label:e.action.title,quotableLabel:e.action.title,code:"undoredo.codeAction",respectAutoSaveConfig:!0,showPreview:null==n?void 0:n.preview})),e.action.command)try{yield r.executeCommand(e.action.command.id,...e.action.command.arguments||[])}catch(o){const e=asMessage(o);a.error("string"==typeof e?e:nls.localize("applyCodeActionFailed","An unknown error occurred while applying the code action"))}}))}function asMessage(o){return"string"==typeof o?o:o instanceof Error&&"string"==typeof o.message?o.message:void 0}CommandsRegistry.registerCommand("_executeCodeActionProvider",(function(o,e,t,n,i){return __awaiter(this,void 0,void 0,(function*(){if(!(e instanceof URI))throw illegalArgument();const{codeActionProvider:r}=o.get(ILanguageFeaturesService),c=o.get(IModelService).getModel(e);if(!c)throw illegalArgument();const a=Selection.isISelection(t)?Selection.liftSelection(t):Range.isIRange(t)?c.validateRange(t):void 0;if(!a)throw illegalArgument();const d="string"==typeof n?new CodeActionKind(n):void 0,s=yield getCodeActions(r,c,a,{type:1,triggerAction:CodeActionTriggerSource.Default,filter:{includeSourceActions:!0,include:d}},Progress.None,CancellationToken.None),l=[],m=Math.min(s.validActions.length,"number"==typeof i?i:0);for(let o=0;o<m;o++)l.push(s.validActions[o].resolve(CancellationToken.None));try{return yield Promise.all(l),s.validActions.map((o=>o.action))}finally{setTimeout((()=>s.dispose()),100)}}))}));