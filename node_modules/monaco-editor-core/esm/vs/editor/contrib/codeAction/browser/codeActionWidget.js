var CodeActionListItemKind,__decorate=this&&this.__decorate||function(e,t,i,o){var n,c=arguments.length,s=c<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var d=e.length-1;d>=0;d--)(n=e[d])&&(s=(c<3?n(s):c>3?n(t,i,s):n(t,i))||s);return c>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,c){function s(e){try{r(o.next(e))}catch(e){c(e)}}function d(e){try{r(o.throw(e))}catch(e){c(e)}}function r(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}r((o=o.apply(e,t||[])).next())}))};import*as dom from"../../../../base/browser/dom.js";import{ActionBar}from"../../../../base/browser/ui/actionbar/actionbar.js";import"../../../../base/browser/ui/codicons/codiconStyles.js";import{KeybindingLabel}from"../../../../base/browser/ui/keybindingLabel/keybindingLabel.js";import{List}from"../../../../base/browser/ui/list/listWidget.js";import{Codicon}from"../../../../base/common/codicons.js";import{Disposable,DisposableStore,MutableDisposable}from"../../../../base/common/lifecycle.js";import{OS}from"../../../../base/common/platform.js";import"./codeActionWidget.css";import{acceptSelectedCodeActionCommand,previewSelectedCodeActionCommand}from"./codeAction.js";import{CodeActionKind,CodeActionTriggerSource}from"../common/types.js";import"../../symbolIcons/browser/symbolIcons.js";import{localize}from"../../../../nls.js";import{ICommandService}from"../../../../platform/commands/common/commands.js";import{RawContextKey}from"../../../../platform/contextkey/common/contextkey.js";import{IContextViewService}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";import{ITelemetryService}from"../../../../platform/telemetry/common/telemetry.js";import{CodeActionKeybindingResolver}from"./codeActionKeybindingResolver.js";export const Context={Visible:new RawContextKey("codeActionMenuVisible",!1,localize("codeActionMenuVisible","Whether the code action list widget is visible"))};function stripNewlines(e){return e.replace(/\r\n|\r|\n/g," ")}!function(e){e.CodeAction="action",e.Header="header"}(CodeActionListItemKind||(CodeActionListItemKind={}));const uncategorizedCodeActionGroup=Object.freeze({kind:CodeActionKind.Empty,title:localize("codeAction.widget.id.more","More Actions...")}),codeActionGroups=Object.freeze([{kind:CodeActionKind.QuickFix,title:localize("codeAction.widget.id.quickfix","Quick Fix...")},{kind:CodeActionKind.RefactorExtract,title:localize("codeAction.widget.id.extract","Extract..."),icon:{codicon:Codicon.wrench}},{kind:CodeActionKind.RefactorInline,title:localize("codeAction.widget.id.inline","Inline..."),icon:{codicon:Codicon.wrench}},{kind:CodeActionKind.RefactorRewrite,title:localize("codeAction.widget.id.convert","Rewrite..."),icon:{codicon:Codicon.wrench}},{kind:CodeActionKind.RefactorMove,title:localize("codeAction.widget.id.move","Move..."),icon:{codicon:Codicon.wrench}},{kind:CodeActionKind.SurroundWith,title:localize("codeAction.widget.id.surround","Surround With..."),icon:{codicon:Codicon.symbolSnippet}},{kind:CodeActionKind.Source,title:localize("codeAction.widget.id.source","Source Action..."),icon:{codicon:Codicon.symbolFile}},uncategorizedCodeActionGroup]);let CodeActionItemRenderer=class{constructor(e,t){this.keybindingResolver=e,this.keybindingService=t}get templateId(){return CodeActionListItemKind.CodeAction}renderTemplate(e){e.classList.add("code-action");const t=document.createElement("div");t.className="icon",e.append(t);const i=document.createElement("span");return i.className="title",e.append(i),{container:e,icon:t,text:i,keybinding:new KeybindingLabel(e,OS)}}renderElement(e,t,i){var o,n,c;e.group.icon?(i.icon.className=e.group.icon.codicon.classNames,i.icon.style.color=null!==(o=e.group.icon.color)&&void 0!==o?o:""):(i.icon.className=Codicon.lightBulb.classNames,i.icon.style.color="var(--vscode-editorLightBulb-foreground)"),i.text.textContent=stripNewlines(e.action.action.title);const s=this.keybindingResolver.getResolver()(e.action.action);i.keybinding.set(s),s?dom.show(i.keybinding.element):dom.hide(i.keybinding.element),e.action.action.disabled?(i.container.title=e.action.action.disabled,i.container.classList.add("option-disabled")):(i.container.title=localize({key:"label",comment:['placeholders are keybindings, e.g "F2 to Apply, Shift+F2 to Preview"']},"{0} to Apply, {1} to Preview",null===(n=this.keybindingService.lookupKeybinding(acceptSelectedCodeActionCommand))||void 0===n?void 0:n.getLabel(),null===(c=this.keybindingService.lookupKeybinding(previewSelectedCodeActionCommand))||void 0===c?void 0:c.getLabel()),i.container.classList.remove("option-disabled"))}disposeTemplate(e){}};CodeActionItemRenderer=__decorate([__param(1,IKeybindingService)],CodeActionItemRenderer);class HeaderRenderer{get templateId(){return CodeActionListItemKind.Header}renderTemplate(e){e.classList.add("group-header");const t=document.createElement("span");return e.append(t),{container:e,text:t}}renderElement(e,t,i){i.text.textContent=e.group.title}disposeTemplate(e){}}const previewSelectedEventType="previewSelectedCodeAction";let CodeActionList=class extends Disposable{constructor(e,t,i,o){super(),this.onDidSelect=i,this.codeActionLineHeight=24,this.headerLineHeight=26,this.domNode=document.createElement("div"),this.domNode.classList.add("codeActionList"),this.list=this._register(new List("codeActionWidget",this.domNode,{getHeight:e=>e.kind===CodeActionListItemKind.Header?this.headerLineHeight:this.codeActionLineHeight,getTemplateId:e=>e.kind},[new CodeActionItemRenderer(new CodeActionKeybindingResolver(o),o),new HeaderRenderer],{keyboardSupport:!1,accessibilityProvider:{getAriaLabel:e=>{if(e.kind===CodeActionListItemKind.CodeAction){let t=stripNewlines(e.action.action.title);return e.action.action.disabled&&(t=localize({key:"customCodeActionWidget.labels",comment:["Code action labels for accessibility."]},"{0}, Disabled Reason: {1}",t,e.action.action.disabled)),t}return null},getWidgetAriaLabel:()=>localize({key:"customCodeActionWidget",comment:["A Code Action Option"]},"Code Action Widget"),getRole:()=>"option",getWidgetRole:()=>"code-action-widget"}})),this._register(this.list.onMouseClick((e=>this.onListClick(e)))),this._register(this.list.onMouseOver((e=>this.onListHover(e)))),this._register(this.list.onDidChangeFocus((()=>this.list.domFocus()))),this._register(this.list.onDidChangeSelection((e=>this.onListSelection(e)))),this.allMenuItems=this.toMenuItems(e,t),this.list.splice(0,this.list.length,this.allMenuItems),this.focusNext()}layout(e){const t=this.allMenuItems.filter((e=>e.kind===CodeActionListItemKind.Header)).length,i=this.allMenuItems.length*this.codeActionLineHeight+t*this.headerLineHeight-t*this.codeActionLineHeight;this.list.layout(i);const o=this.allMenuItems.map(((e,t)=>{const i=document.getElementById(this.list.getElementID(t));if(i){i.style.width="auto";const e=i.getBoundingClientRect().width;return i.style.width="",e}return 0})),n=Math.max(...o,e);return this.list.layout(i,n),this.domNode.style.height=`${i}px`,this.list.domFocus(),n}focusPrevious(){this.list.focusPrevious(1,!0,void 0,(e=>e.kind===CodeActionListItemKind.CodeAction&&!e.action.action.disabled))}focusNext(){this.list.focusNext(1,!0,void 0,(e=>e.kind===CodeActionListItemKind.CodeAction&&!e.action.action.disabled))}acceptSelected(e){const t=this.list.getFocus();if(0===t.length)return;const i=t[0],o=this.list.element(i);if(o.kind!==CodeActionListItemKind.CodeAction||o.action.action.disabled)return;const n=new UIEvent((null==e?void 0:e.preview)?previewSelectedEventType:"acceptSelectedCodeAction");this.list.setSelection([i],n)}onListSelection(e){var t;if(!e.elements.length)return;const i=e.elements[0];i.kind!==CodeActionListItemKind.CodeAction||i.action.action.disabled?this.list.setSelection([]):this.onDidSelect(i.action,{preview:(null===(t=e.browserEvent)||void 0===t?void 0:t.type)===previewSelectedEventType})}onListHover(e){this.list.setFocus("number"==typeof e.index?[e.index]:[])}onListClick(e){e.element&&e.element.kind===CodeActionListItemKind.CodeAction&&e.element.action.action.disabled&&this.list.setFocus([])}toMenuItems(e,t){if(!t)return e.map((e=>({kind:CodeActionListItemKind.CodeAction,action:e,group:uncategorizedCodeActionGroup})));const i=codeActionGroups.map((e=>({group:e,actions:[]})));for(const t of e){const e=t.action.kind?new CodeActionKind(t.action.kind):CodeActionKind.None;for(const o of i)if(o.group.kind.contains(e)){o.actions.push(t);break}}const o=[];for(const e of i)if(e.actions.length){o.push({kind:CodeActionListItemKind.Header,group:e.group});for(const t of e.actions)o.push({kind:CodeActionListItemKind.CodeAction,action:t,group:e.group})}return o}};CodeActionList=__decorate([__param(3,IKeybindingService)],CodeActionList);let showDisabled=!1,CodeActionWidget=class e extends Disposable{static get INSTANCE(){return this._instance}static getOrCreateInstance(t){return this._instance||(this._instance=t.createInstance(e)),this._instance}constructor(e,t,i,o){super(),this._commandService=e,this._contextViewService=t,this._keybindingService=i,this._telemetryService=o,this.codeActionList=this._register(new MutableDisposable)}get isVisible(){return!!this.currentShowingContext}show(e,t,i,o,n,c,s){return __awaiter(this,void 0,void 0,(function*(){this.currentShowingContext=void 0;const d=Context.Visible.bindTo(s),r=n.includeDisabledActions&&(showDisabled||0===t.validActions.length)?t.allActions:t.validActions;r.length?(this.currentShowingContext={trigger:e,codeActions:t,anchor:i,container:o,delegate:c,options:n,contextKeyService:s},this._contextViewService.showContextView({getAnchor:()=>i,render:i=>(d.set(!0),this.renderWidget(i,e,t,n,r,c)),onHide:i=>(d.reset(),this.onWidgetClosed(e,n,t,i,c))},o,!1)):d.reset()}))}focusPrevious(){var e;null===(e=this.codeActionList.value)||void 0===e||e.focusPrevious()}focusNext(){var e;null===(e=this.codeActionList.value)||void 0===e||e.focusNext()}acceptSelected(e){var t;null===(t=this.codeActionList.value)||void 0===t||t.acceptSelected(e)}hide(){this.codeActionList.clear(),this._contextViewService.hideContextView()}renderWidget(e,t,i,o,n,c){var s;const d=new DisposableStore,r=document.createElement("div");r.classList.add("codeActionWidget"),e.appendChild(r),this.codeActionList.value=new CodeActionList(n,null===(s=o.showHeaders)||void 0===s||s,((e,i)=>{this.hide(),c.onSelectCodeAction(e,t,i)}),this._keybindingService),r.appendChild(this.codeActionList.value.domNode);const l=document.createElement("div"),a=e.appendChild(l);a.classList.add("context-view-block"),a.style.position="fixed",a.style.cursor="initial",a.style.left="0",a.style.top="0",a.style.width="100%",a.style.height="100%",a.style.zIndex="-1",d.add(dom.addDisposableListener(a,dom.EventType.MOUSE_DOWN,(e=>e.stopPropagation())));const m=document.createElement("div"),h=e.appendChild(m);h.classList.add("context-view-pointerBlock"),h.style.position="fixed",h.style.cursor="initial",h.style.left="0",h.style.top="0",h.style.width="100%",h.style.height="100%",h.style.zIndex="2",d.add(dom.addDisposableListener(h,dom.EventType.POINTER_MOVE,(()=>h.remove()))),d.add(dom.addDisposableListener(h,dom.EventType.MOUSE_DOWN,(()=>h.remove())));let u=0;if(!o.fromLightbulb){const e=this.createActionBar(i,o);e&&(r.appendChild(e.getContainer().parentElement),d.add(e),u=e.getContainer().offsetWidth)}const p=this.codeActionList.value.layout(u);r.style.width=`${p}px`;const g=d.add(dom.trackFocus(e));return d.add(g.onDidBlur((()=>this.hide()))),d}toggleShowDisabled(e){const t=this.currentShowingContext;this.hide(),showDisabled=e,t&&this.show(t.trigger,t.codeActions,t.anchor,t.container,t.options,t.delegate,t.contextKeyService)}onWidgetClosed(e,t,i,o,n){this._telemetryService.publicLog2("codeAction.applyCodeAction",{codeActionFrom:t.fromLightbulb?CodeActionTriggerSource.Lightbulb:e.triggerAction,validCodeActions:i.validActions.length,cancelled:o}),this.currentShowingContext=void 0,n.onHide(o)}createActionBar(e,t){const i=this.getActionBarActions(e,t);if(!i.length)return;const o=dom.$(".codeActionWidget-action-bar"),n=new ActionBar(o);return n.push(i,{icon:!1,label:!0}),n}getActionBarActions(e,t){const i=e.documentation.map((e=>{var t;return{id:e.id,label:e.title,tooltip:null!==(t=e.tooltip)&&void 0!==t?t:"",class:void 0,enabled:!0,run:()=>{var t;return this._commandService.executeCommand(e.id,...null!==(t=e.arguments)&&void 0!==t?t:[])}}}));return t.includeDisabledActions&&e.validActions.length>0&&e.allActions.length!==e.validActions.length&&i.push(showDisabled?{id:"hideMoreCodeActions",label:localize("hideMoreCodeActions","Hide Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>this.toggleShowDisabled(!1)}:{id:"showMoreCodeActions",label:localize("showMoreCodeActions","Show Disabled"),enabled:!0,tooltip:"",class:void 0,run:()=>this.toggleShowDisabled(!0)}),i}};CodeActionWidget=__decorate([__param(0,ICommandService),__param(1,IContextViewService),__param(2,IKeybindingService),__param(3,ITelemetryService)],CodeActionWidget);export{CodeActionWidget};