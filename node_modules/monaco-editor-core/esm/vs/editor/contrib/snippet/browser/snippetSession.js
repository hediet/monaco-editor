var __decorate=this&&this.__decorate||function(e,t,i,o){var s,n=arguments.length,r=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(n<3?s(r):n>3?s(t,i,r):s(t,i))||r);return n>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};import{groupBy}from"../../../../base/common/arrays.js";import{dispose}from"../../../../base/common/lifecycle.js";import{getLeadingWhitespace}from"../../../../base/common/strings.js";import"./snippetSession.css";import{EditOperation}from"../../../common/core/editOperation.js";import{Range}from"../../../common/core/range.js";import{Selection}from"../../../common/core/selection.js";import{ILanguageConfigurationService}from"../../../common/languages/languageConfigurationRegistry.js";import{ModelDecorationOptions}from"../../../common/model/textModel.js";import{ILabelService}from"../../../../platform/label/common/label.js";import{IWorkspaceContextService}from"../../../../platform/workspace/common/workspace.js";import{Choice,Placeholder,SnippetParser,Text,TextmateSnippet}from"./snippetParser.js";import{ClipboardBasedVariableResolver,CommentBasedVariableResolver,CompositeSnippetVariableResolver,ModelBasedVariableResolver,RandomBasedVariableResolver,SelectionBasedVariableResolver,TimeBasedVariableResolver,WorkspaceBasedVariableResolver}from"./snippetVariables.js";export class OneSnippet{constructor(e,t,i){this._editor=e,this._snippet=t,this._snippetLineLeadingWhitespace=i,this._offset=-1,this._nestingLevel=1,this._placeholderGroups=groupBy(t.placeholders,Placeholder.compareByIndex),this._placeholderGroupsIdx=-1}initialize(e){this._offset=e.newPosition}dispose(){this._placeholderDecorations&&this._editor.removeDecorations([...this._placeholderDecorations.values()]),this._placeholderGroups.length=0}_initDecorations(){if(-1===this._offset)throw new Error("Snippet not initialized!");if(this._placeholderDecorations)return;this._placeholderDecorations=new Map;const e=this._editor.getModel();this._editor.changeDecorations((t=>{for(const i of this._snippet.placeholders){const o=this._snippet.offset(i),s=this._snippet.fullLen(i),n=Range.fromPositions(e.getPositionAt(this._offset+o),e.getPositionAt(this._offset+o+s)),r=i.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive,a=t.addDecoration(n,r);this._placeholderDecorations.set(i,a)}}))}move(e){if(!this._editor.hasModel())return[];if(this._initDecorations(),this._placeholderGroupsIdx>=0){const e=[];for(const t of this._placeholderGroups[this._placeholderGroupsIdx])if(t.transform){const i=this._placeholderDecorations.get(t),o=this._editor.getModel().getDecorationRange(i),s=this._editor.getModel().getValueInRange(o),n=t.transform.resolve(s).split(/\r\n|\r|\n/);for(let e=1;e<n.length;e++)n[e]=this._editor.getModel().normalizeIndentation(this._snippetLineLeadingWhitespace+n[e]);e.push(EditOperation.replace(o,n.join(this._editor.getModel().getEOL())))}e.length>0&&this._editor.executeEdits("snippet.placeholderTransform",e)}let t=!1;!0===e&&this._placeholderGroupsIdx<this._placeholderGroups.length-1?(this._placeholderGroupsIdx+=1,t=!0):!1===e&&this._placeholderGroupsIdx>0&&(this._placeholderGroupsIdx-=1,t=!0);const i=this._editor.getModel().changeDecorations((e=>{const i=new Set,o=[];for(const s of this._placeholderGroups[this._placeholderGroupsIdx]){const n=this._placeholderDecorations.get(s),r=this._editor.getModel().getDecorationRange(n);o.push(new Selection(r.startLineNumber,r.startColumn,r.endLineNumber,r.endColumn)),t=t&&this._hasPlaceholderBeenCollapsed(s),e.changeDecorationOptions(n,s.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),i.add(s);for(const t of this._snippet.enclosingPlaceholders(s)){const o=this._placeholderDecorations.get(t);e.changeDecorationOptions(o,t.isFinalTabstop?OneSnippet._decor.activeFinal:OneSnippet._decor.active),i.add(t)}}for(const[t,o]of this._placeholderDecorations)i.has(t)||e.changeDecorationOptions(o,t.isFinalTabstop?OneSnippet._decor.inactiveFinal:OneSnippet._decor.inactive);return o}));return t?this.move(e):null!=i?i:[]}_hasPlaceholderBeenCollapsed(e){let t=e;for(;t;){if(t instanceof Placeholder){const e=this._placeholderDecorations.get(t);if(this._editor.getModel().getDecorationRange(e).isEmpty()&&t.toString().length>0)return!0}t=t.parent}return!1}get isAtFirstPlaceholder(){return this._placeholderGroupsIdx<=0||0===this._placeholderGroups.length}get isAtLastPlaceholder(){return this._placeholderGroupsIdx===this._placeholderGroups.length-1}get hasPlaceholder(){return this._snippet.placeholders.length>0}get isTrivialSnippet(){return 0===this._snippet.placeholders.length||1===this._snippet.placeholders.length&&this._snippet.placeholders[0].isFinalTabstop}computePossibleSelections(){const e=new Map;for(const t of this._placeholderGroups){let i;for(const o of t){if(o.isFinalTabstop)break;i||(i=[],e.set(o.index,i));const t=this._placeholderDecorations.get(o),s=this._editor.getModel().getDecorationRange(t);if(!s){e.delete(o.index);break}i.push(s)}}return e}get activeChoice(){if(!this._placeholderDecorations)return;const e=this._placeholderGroups[this._placeholderGroupsIdx][0];if(!(null==e?void 0:e.choice))return;const t=this._placeholderDecorations.get(e);if(!t)return;const i=this._editor.getModel().getDecorationRange(t);return i?{range:i,choice:e.choice}:void 0}get hasChoice(){let e=!1;return this._snippet.walk((t=>(e=t instanceof Choice,!e))),e}merge(e){const t=this._editor.getModel();this._nestingLevel*=10,this._editor.changeDecorations((i=>{for(const o of this._placeholderGroups[this._placeholderGroupsIdx]){const s=e.shift();console.assert(-1!==s._offset),console.assert(!s._placeholderDecorations);const n=s._snippet.placeholderInfo.last.index;for(const e of s._snippet.placeholderInfo.all)e.isFinalTabstop?e.index=o.index+(n+1)/this._nestingLevel:e.index=o.index+e.index/this._nestingLevel;this._snippet.replace(o,s._snippet.children);const r=this._placeholderDecorations.get(o);i.removeDecoration(r),this._placeholderDecorations.delete(o);for(const e of s._snippet.placeholders){const o=s._snippet.offset(e),n=s._snippet.fullLen(e),r=Range.fromPositions(t.getPositionAt(s._offset+o),t.getPositionAt(s._offset+o+n)),a=i.addDecoration(r,OneSnippet._decor.inactive);this._placeholderDecorations.set(e,a)}}this._placeholderGroups=groupBy(this._snippet.placeholders,Placeholder.compareByIndex)}))}}OneSnippet._decor={active:ModelDecorationOptions.register({description:"snippet-placeholder-1",stickiness:0,className:"snippet-placeholder"}),inactive:ModelDecorationOptions.register({description:"snippet-placeholder-2",stickiness:1,className:"snippet-placeholder"}),activeFinal:ModelDecorationOptions.register({description:"snippet-placeholder-3",stickiness:1,className:"finish-snippet-placeholder"}),inactiveFinal:ModelDecorationOptions.register({description:"snippet-placeholder-4",stickiness:1,className:"finish-snippet-placeholder"})};const _defaultOptions={overwriteBefore:0,overwriteAfter:0,adjustWhitespace:!0,clipboardText:void 0,overtypingCapturer:void 0};let SnippetSession=class e{static adjustWhitespace(e,t,i,o,s){const n=e.getLineContent(t.lineNumber),r=getLeadingWhitespace(n,0,t.column-1);let a;return i.walk((t=>{if(!(t instanceof Text)||t.parent instanceof Choice)return!0;const s=t.value.split(/\r\n|\r|\n/);if(o){const o=i.offset(t);if(0===o)s[0]=e.normalizeIndentation(s[0]);else{a=null!=a?a:i.toString();const t=a.charCodeAt(o-1);10!==t&&13!==t||(s[0]=e.normalizeIndentation(r+s[0]))}for(let t=1;t<s.length;t++)s[t]=e.normalizeIndentation(r+s[t])}const n=s.join(e.getEOL());return n!==t.value&&(t.parent.replace(t,[new Text(n)]),a=void 0),!0})),r}static adjustSelection(e,t,i,o){if(0!==i||0!==o){const{positionLineNumber:s,positionColumn:n}=t,r=n-i,a=n+o,l=e.validateRange({startLineNumber:s,startColumn:r,endLineNumber:s,endColumn:a});t=Selection.createWithDirection(l.startLineNumber,l.startColumn,l.endLineNumber,l.endColumn,t.getDirection())}return t}static createEditsAndSnippetsFromSelections(t,i,o,s,n,r,a,l,p){const c=[],h=[];if(!t.hasModel())return{edits:c,snippets:h};const d=t.getModel(),g=t.invokeWithinContext((e=>e.get(IWorkspaceContextService))),_=t.invokeWithinContext((e=>new ModelBasedVariableResolver(e.get(ILabelService),d))),f=()=>a,u=d.getValueInRange(e.adjustSelection(d,t.getSelection(),o,0)),m=d.getValueInRange(e.adjustSelection(d,t.getSelection(),0,s)),v=d.getLineFirstNonWhitespaceColumn(t.getSelection().positionLineNumber),S=t.getSelections().map(((e,t)=>({selection:e,idx:t}))).sort(((e,t)=>Range.compareRangesUsingStarts(e.selection,t.selection)));for(const{selection:a,idx:b}of S){let R=e.adjustSelection(d,a,o,0),C=e.adjustSelection(d,a,0,s);u!==d.getValueInRange(R)&&(R=a),m!==d.getValueInRange(C)&&(C=a);const x=a.setStartPosition(R.startLineNumber,R.startColumn).setEndPosition(C.endLineNumber,C.endColumn),P=(new SnippetParser).parse(i,!0,n),w=x.getStartPosition(),D=e.adjustWhitespace(d,w,P,r||b>0&&v!==d.getLineFirstNonWhitespaceColumn(a.positionLineNumber),!0);P.resolveVariables(new CompositeSnippetVariableResolver([_,new ClipboardBasedVariableResolver(f,b,S.length,"spread"===t.getOption(72)),new SelectionBasedVariableResolver(d,a,b,l),new CommentBasedVariableResolver(d,a,p),new TimeBasedVariableResolver,new WorkspaceBasedVariableResolver(g),new RandomBasedVariableResolver])),c[b]=EditOperation.replace(x,P.toString()),c[b].identifier={major:b,minor:0},c[b]._isTracked=!0,h[b]=new OneSnippet(t,P,D)}return{edits:c,snippets:h}}static createEditsAndSnippetsFromEdits(e,t,i,o,s,n,r){if(!e.hasModel()||0===t.length)return{edits:[],snippets:[]};const a=[],l=e.getModel(),p=new SnippetParser,c=new TextmateSnippet,h=new CompositeSnippetVariableResolver([e.invokeWithinContext((e=>new ModelBasedVariableResolver(e.get(ILabelService),l))),new ClipboardBasedVariableResolver((()=>s),0,e.getSelections().length,"spread"===e.getOption(72)),new SelectionBasedVariableResolver(l,e.getSelection(),0,n),new CommentBasedVariableResolver(l,e.getSelection(),r),new TimeBasedVariableResolver,new WorkspaceBasedVariableResolver(e.invokeWithinContext((e=>e.get(IWorkspaceContextService)))),new RandomBasedVariableResolver]);t=t.sort(((e,t)=>Range.compareRangesUsingStarts(e.range,t.range)));let d=0;for(let e=0;e<t.length;e++){const{range:i,template:o}=t[e];if(e>0){const o=t[e-1].range,s=Range.fromPositions(o.getEndPosition(),i.getStartPosition()),n=new Text(l.getValueInRange(s));c.appendChild(n),d+=n.value.length}p.parseFragment(o,c),c.resolveVariables(h);const s=c.toString(),n=s.slice(d);d=s.length;const r=EditOperation.replace(i,n);r.identifier={major:e,minor:0},r._isTracked=!0,a.push(r)}return p.ensureFinalTabstop(c,i,!0),{edits:a,snippets:[new OneSnippet(e,c,"")]}}constructor(e,t,i=_defaultOptions,o){this._editor=e,this._template=t,this._options=i,this._languageConfigurationService=o,this._templateMerges=[],this._snippets=[]}dispose(){dispose(this._snippets)}_logInfo(){return`template="${this._template}", merged_templates="${this._templateMerges.join(" -> ")}"`}insert(){if(!this._editor.hasModel())return;const{edits:t,snippets:i}="string"==typeof this._template?e.createEditsAndSnippetsFromSelections(this._editor,this._template,this._options.overwriteBefore,this._options.overwriteAfter,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService):e.createEditsAndSnippetsFromEdits(this._editor,this._template,!1,this._options.adjustWhitespace,this._options.clipboardText,this._options.overtypingCapturer,this._languageConfigurationService);this._snippets=i,this._editor.executeEdits("snippet",t,(e=>{const t=e.filter((e=>!!e.identifier));for(let e=0;e<i.length;e++)i[e].initialize(t[e].textChange);return this._snippets[0].hasPlaceholder?this._move(!0):t.map((e=>Selection.fromPositions(e.range.getEndPosition())))})),this._editor.revealRange(this._editor.getSelections()[0])}merge(t,i=_defaultOptions){if(!this._editor.hasModel())return;this._templateMerges.push([this._snippets[0]._nestingLevel,this._snippets[0]._placeholderGroupsIdx,t]);const{edits:o,snippets:s}=e.createEditsAndSnippetsFromSelections(this._editor,t,i.overwriteBefore,i.overwriteAfter,!0,i.adjustWhitespace,i.clipboardText,i.overtypingCapturer,this._languageConfigurationService);this._editor.executeEdits("snippet",o,(e=>{const t=e.filter((e=>!!e.identifier));for(let e=0;e<s.length;e++)s[e].initialize(t[e].textChange);const i=s[0].isTrivialSnippet;if(!i){for(const e of this._snippets)e.merge(s);console.assert(0===s.length)}return this._snippets[0].hasPlaceholder&&!i?this._move(void 0):t.map((e=>Selection.fromPositions(e.range.getEndPosition())))}))}next(){const e=this._move(!0);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}prev(){const e=this._move(!1);this._editor.setSelections(e),this._editor.revealPositionInCenterIfOutsideViewport(e[0].getPosition())}_move(e){const t=[];for(const i of this._snippets){const o=i.move(e);t.push(...o)}return t}get isAtFirstPlaceholder(){return this._snippets[0].isAtFirstPlaceholder}get isAtLastPlaceholder(){return this._snippets[0].isAtLastPlaceholder}get hasPlaceholder(){return this._snippets[0].hasPlaceholder}get hasChoice(){return this._snippets[0].hasChoice}get activeChoice(){return this._snippets[0].activeChoice}isSelectionWithinPlaceholders(){if(!this.hasPlaceholder)return!1;const e=this._editor.getSelections();if(e.length<this._snippets.length)return!1;const t=new Map;for(const i of this._snippets){const o=i.computePossibleSelections();if(0===t.size)for(const[i,s]of o){s.sort(Range.compareRangesUsingStarts);for(const o of e)if(s[0].containsRange(o)){t.set(i,[]);break}}if(0===t.size)return!1;t.forEach(((e,t)=>{e.push(...o.get(t))}))}e.sort(Range.compareRangesUsingStarts);for(const[i,o]of t)if(o.length===e.length){o.sort(Range.compareRangesUsingStarts);for(let s=0;s<o.length;s++)o[s].containsRange(e[s])||t.delete(i)}else t.delete(i);return t.size>0}};SnippetSession=__decorate([__param(3,ILanguageConfigurationService)],SnippetSession);export{SnippetSession};